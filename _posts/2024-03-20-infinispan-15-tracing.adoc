---
layout: blog
title: Infinispan 15 Tracing Improvement
permalink: /blog/:year/:month/:day/infinispan-15-tracing
date: '2024-03-20T9:00:00.000-00:00'
author: fax4ever
tags: [ "opentelemetry", "tracing" ]
---

= Infinispan 15 tracing news

In the previous version of Infinispan https://infinispan.org/blog/2022/07/18/infinispan-14-opentelemetry-tracing[we introduced the OpenTelemetry Tracing capability].
With the new version we evolved the integration in order to:

* Allow to configure it both globally and on-cache basis using the standard Infinispan configuration.
* Trace more event types: cluster, cross-site, cache-store and security.
* Allow to select and configure, also at runtime, the span types that we want to produce and send to the collector.

All the source code we're presenting on this article is taken from https://github.com/fax4ever/infinispan-demo/tree/main/infinispan-15-tracing[this demo project].

== Configure tracing

=== Global configuration

To enable tracing globally you need as usual to define the `collector-endpoint`, but instead of using a system property
it is possible to use the infinispan server configuration, in which we introduced a component to configure the tracing globally.

[source,xml]
----
<infinispan xmlns:server="urn:infinispan:server:15.0">
   <cache-container name="default">
      <tracing collector-endpoint="http://jaeger-collector.infinispan-15-tracing.svc.cluster.local:4318" security="true" service-name="infinispan-service-tracing" />
   </cache-container>
</infinispan>
----

By default we support the tracing with the OpenTelemetry Protocol (OTLP),
with the default exporter protocol `http/protobuf`, and not anymore `grpc`.
For instance the default Jaeger port using this combination is the `4318`.

We also activate the tracing of the security audit. This is a new tracing category we introduced with Infinispan 15 and it is defined at cache manager level (globally).
In the demo this is the configuration passed to the Infinispan Helm Chart:

[source,yaml]
----
infinispan:
 cacheContainer:
   tracing:
     collector-endpoint: "http://jaeger-collector.infinispan-15-tracing.svc.cluster.local:4318"
     service-name: infinispan-service-tracing
     security: true
----

=== Cache configuration

The other tracing categories are configurable at cache level, since they are cache scoped.
For instance this is a possible cache configuration enabling the tracing on more categories:

[source,yaml]
----
replicatedCache:
  encoding:
    key:
      mediaType: "application/x-protostream"
    value:
      mediaType: "application/x-protostream"
  indexing:
    enabled: "true"
    storage: "local-heap"
    startupMode: "NONE"
    indexedEntities:
      - "fax.play.image"
  tracing:
    enabled: true
    categories:
      - "container"
      - "persistence"
      - "cluster"
      - "x-site"
----

In this case the enabled tracing categories will be container, persistence, cluster and x-site.
By default only the container category is enabled.

==== Runtime enabling / disabling them

Furthermore, it is possible to enable / disable them or even the entire tracing at runtime.

For instance this is a piece of code using the HotRod client to enable at runtime the category `container` and `persistence`,
disabling the others. A similar command can be invoked also with the REST interface or the command line interface.

[source,java]
----
Set<String> enabledCategories = Set.of("container", "persistence");
cacheManager.administration()
   .updateConfigurationAttribute(cache.getName(), "tracing.categories", String.join(",", enabledCategories));
----

== Tracing in action

Now that we have the setup. Let's see some example of tracing in action.
If we open the Jaeger console we can see immediately some security audit events logged.

[caption="Security audit",link=/assets/images/blog/tracing-15-01-security-audit.png]
image::/assets/images/blog/tracing-15-01-security-audit.png[Tracing output]

When the demo starts we only have enabled the container tracing.
So after the first interaction we can have a log similar to the following:

[caption="Security audit",link=/assets/images/blog/tracing-15-02-container.png]
image::/assets/images/blog/tracing-15-02-container.png[Tracing output]

We have the span from the client and the corresponding span of container level of the server
(that traces the HotRod call).

If we want to know more about the internal Infinispan operations we need to enable more span categories.

In our demo for instance we first enable (at runtime) the persistence category
and after another interaction from the client we client we can see also the internal call that Infinispan does
to interact with the configured cache store.

[caption="Security audit",link=/assets/images/blog/tracing-15-03-persistence.png]
image::/assets/images/blog/tracing-15-03-persistence.png[Tracing output]

After that we enabled (the same at runtime) the cluster category, so that for the first interaction from the client
it is possible to see also the call that the Infinispan server does to align the cluster.

[caption="Security audit",link=/assets/images/blog/tracing-15-04-cluster.png]
image::/assets/images/blog/tracing-15-04-cluster.png[Tracing output]

This concludes our short tour on the news on tracing for Infinispan 15.
For more information you can consult how to
https://infinispan.org/docs/stable/titles/server/server.html#opentelemetry-tracing[Enabling and configuring Infinispan OpenTelemetry tracing].

Keep in touch!
