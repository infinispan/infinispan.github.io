<!DOCTYPE html>
<html>

<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-GPD7V946LB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-GPD7V946LB');
  </script>
  <title>Infinispan 14 OpenTelemetry tracing integration</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Infinispan is a distributed in-memory key/value data store with optional schema, available under the Apache License 2.0.">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.7.2/css/all.css" integrity="sha384-nRgPTkuX86pH8yjPJUAFuASXQSSl2/bBUiNV47vSYpKFxHJhbcrGnmlYpYJMeD7a" crossorigin="anonymous">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.css">
  <link rel="stylesheet" href="/assets/css/cookieconsent.css">
  <link rel="alternate" type="application/rss+xml"
        title="Infinispan's RSS Feed"
        href="/feed.xml" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</head>

<body class="blog">
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/infinispan-logo-white.png" class="project-logo" title="Infinispan Logo"></a>
    </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/learn/">Learn <i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/introduction" class="">Introduction</a></li>
          <li><a href="/features" class="">Features</a></li>
          <li><a href="/documentation" class="">Documentation</a></li>
          <li><a href="/tutorials" class="">Tutorials</a></li>
          <li><a href="/videos" class="">Videos</a></li>
          <li><a href="/references" class="">References</a></li>
          <li><a href="/experiments" class="">Experiments</a></li>
          <li><a href="/roadmap" class="">Roadmap</a></li>
        </ul>
      </li>
      <li>
        <a href="/use-cases/" class="">Use Cases</a>
      </li>
      <li>
        <a href="/community/" class="">Community</a>
      </li>
      <li>
        <a href="/blog/" class="active">Blog</a>
      </li>
      <li>
        <a href="/download/" class="">Download</a>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    
<div class="component-slim full-width-bg dark-bg light-blue">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <a href="/blog">Blogs</a>  <i class="fas fa-chevron-right"></i> Infinispan 14 OpenTelemetry tracing integration
    </div>
  </div>
</div>

<div class="post-page grid-wrapper">
  <div class="grid__item width-10-12 width-12-12-m doc-content">
    <h1>Infinispan 14 OpenTelemetry tracing integration</h1>
    <div class="post-date">July 18, 2022
      Tags: <a href="/blog/tag/opentelemetry">opentelemetry</a> <a href="/blog/tag/tracing">tracing</a> 
    </div>
    <div class="grid-wrapper">
      <div class="grid__item width-8-12 width-12-12-m margin-tb-sm">
        <div class="grid-wrapper">
          <div class="width-2-12 justify-self-center align-self-center">
            <img src="/assets/images/blog/authors/fax4ever.jpg">
          </div>
          <div class="width-10-12 align-self-center">
            <p class="byline">By Fabio Massimo Ercoli</p>
          </div>
        </div>
      </div>
      <div class="grid__item width-12-12">
          <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Dear Infinispan community,</p>
</div>
<div class="paragraph">
<p>With the Infinispan 14 development release 04, we started to support tracing with OpenTelemetry.</p>
</div>
<div class="paragraph">
<p>If configured, Infinispan Server produces cache events tracing spans and sends them to a remote tracing collector server, such as Jaeger or Zipkin.</p>
</div>
<div class="paragraph">
<p>Moreover, if a Java client application with the HotRot or the Rest client produces some tracing spans,
these spans can be correlated as parent spans of the corresponding spans events produced by the Infinispan Server.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="set-up-tracing-on-infinispan-server">Set up tracing on Infinispan Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The new version of Infinispan Server comes with a gRPC OpenTelemetry Protocol (OTLP) Exporter,
which is now supported by the majority of tracing servers.</p>
</div>
<div class="paragraph">
<p>For instance, with the newer Jaeger server versions, you can enable data collection through the OTLP protocol with the following option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">./jaeger-all-in-one --collector.otlp.enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>The server opens a port to import gRPC OTLP tracing data at port 4317.</p>
</div>
<div class="paragraph">
<p>Configure tracing on the Infinispan Server by setting system properties or environment variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">infinispan.tracing.enabled=true
otel.service.name=infinispan-server-service
otel.exporter.otlp.endpoint=http://localhost:4317
otel.metrics.exporter=none</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first property is Infinispan specific and enables the tracing capability of the Infinispan Server.
The further properties belong to the <a href="https://github.com/open-telemetry/opentelemetry-java/blob/main/sdk-extensions/autoconfigure/README.md">OpenTelemetry SDK Autoconfigure project</a>
that Infinispan uses to configure the tracing exporter.
In this case, OTLP gRPC Exporter protocol is used and the server runs on the same machine as the Infinispan Server.</p>
</div>
<div class="paragraph">
<p>Starting the server with these parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">export JAVA_OPTS="-Dinfinispan.tracing.enabled=true -Dotel.service.name=infinispan-server-service -Dotel.exporter.otlp.endpoint=http://localhost:4317 -Dotel.metrics.exporter=none"
./server.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following log is produced when the server starts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">(ForkJoinPool.commonPool-worker-2) [org.infinispan.server.core.telemetry.TelemetryServiceFactory] ISPN000952: OpenTelemetry instance loaded: OpenTelemetrySdk{...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This indicates that the OpenTelemetrySdk is correctly configured.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tracing-from-a-hotrod-client-application">Tracing from a HotRod client application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Any OpenTelemetry tracing context present on HotRot client applications will be automatically propagated by the new Hot Rod v4 client to the server tracing context.</p>
</div>
<div class="paragraph">
<p>For instance, for a client that defines some tracing spans containing cache operations, such as the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class MyRestClient {

    public void putSomeValues(RemoteCache cache) {
        Span span = tracer.spanBuilder("sub-bulk-1").setSpanKind(SpanKind.CLIENT).startSpan();
        // put the span into the current Context
        try (Scope scope = span.makeCurrent()) {
            cache.put(1, "A");
            cache.put(2, "B");
            cache.put(3, "C");
        } catch (Throwable throwable) {
            span.setStatus(StatusCode.ERROR, "Something bad happened!");
            span.recordException(throwable);
            throw throwable;
        } finally {
            span.end(); // Cannot set a span after this call
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client span <code>sub-bulk-1</code> will be correlated to any related server spans, in this case the three put operations.</p>
</div>
<div class="paragraph">
<p>Opening the Jaeger console, we can see that client and server spans are correctly aggregated:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="/assets/images/blog/tracing-hotrod-client.png"><img src="/assets/images/blog/tracing-hotrod-client.png" alt="Tracing output"></a>
</div>
</div>
<div class="paragraph">
<p>You can find a complete application example here: <a href="https://github.com/fax4ever/infinispan-play/tree/main/tracing-hotrod-client" class="bare">https://github.com/fax4ever/infinispan-play/tree/main/tracing-hotrod-client</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tracing-from-a-rest-client-application">Tracing from a REST client application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can achieve the same with a REST client by putting manually in the HTTP headers the requests to provide information about the current tracing context using a standard OpenTelemetry instance of <code>W3CTraceContextPropagator</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class MyRestClient {

    public void putSomeValues(RestCacheClient cache) {
        Span span = tracer.spanBuilder("sub-bulk-1").setSpanKind(SpanKind.CLIENT).startSpan();
        // put the span into the current Context
        try (Scope scope = span.makeCurrent()) {
            putSomeEntries(cache);
        } catch (Throwable throwable) {
            span.setStatus(StatusCode.ERROR, "Something bad happened!");
            span.recordException(throwable);
            throw throwable;
        } finally {
            span.end(); // Cannot set a span after this call
        }
    }

    private void putSomeEntries(RestCacheClient cache) {
        Map&lt;String, String&gt; contextMap = getContextMap();

        CompletableFuture[] futures = new CompletableFuture[3];

        futures[0] = cache.put("1", MediaType.TEXT_PLAIN.toString(),
            RestEntity.create(MediaType.TEXT_PLAIN, "A"), contextMap).toCompletableFuture();
        futures[1] = cache.put("2", MediaType.TEXT_PLAIN.toString(),
            RestEntity.create(MediaType.TEXT_PLAIN, "B"), contextMap).toCompletableFuture();
        futures[2] = cache.put("3", MediaType.TEXT_PLAIN.toString(),
            RestEntity.create(MediaType.TEXT_PLAIN, "C"), contextMap).toCompletableFuture();

        CompletableFuture.allOf(futures).join();
    }

    public static Map&lt;String, String&gt; getContextMap() {
        HashMap&lt;String, String&gt; result = new HashMap&lt;&gt;();

        // Inject the request with the *current* Context, which contains our current Span.
        W3CTraceContextPropagator.getInstance().inject(Context.current(), result,
          (carrier, key, value) -&gt; carrier.put(key, value));
        return result;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Opening the Jaeger console, you can see that client and server spans are correctly aggregated:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="/assets/images/blog/tracing-rest-client.png"><img src="/assets/images/blog/tracing-rest-client.png" alt="Tracing output"></a>
</div>
</div>
<div class="paragraph">
<p>You can find a complete application example here: <a href="https://github.com/fax4ever/infinispan-play/tree/main/tracing-rest-client" class="bare">https://github.com/fax4ever/infinispan-play/tree/main/tracing-rest-client</a></p>
</div>
</div>
</div>
          
      </div>
      <div class="grid__item width-12-12">
        <h2>Get it, Use it, Ask us! </h2>
We’re hard at work on new features, improvements and fixes, so watch this space for more announcements!
<div class="paragraph">
    <p>Please, <a href="/download" target="_blank">download</a> and test the latest release.</p>
</div>
<div class="paragraph">
    <p>The source code is hosted on <a href="" target="_blank">GitHub</a>.
        If you need to report a bug or request a new feature, look for a similar one on our <a href="https://github.com/infinispan/infinispan/issues" target="_blank">GitHub issues tracker</a>.
        If you don’t find any, <a href="https://github.com/infinispan/infinispan/issues" target="_blank">create a new issue</a>.</p>
</div>
<div class="paragraph">
    <p>If you have questions, are experiencing a bug or want advice on using Infinispan,
        you can use <a href="https://github.com/infinispan/infinispan/discussions/"
                       target="_blank">GitHub discussions</a>.
        We will do our best to answer you as soon as we can.</p>
</div>
<div class="paragraph">
    <p>The Infinispan community uses <a href="https://zulipchat.com/"
                                        target="_blank">Zulip</a> for real-time communications.
        Join us using either a web-browser or a <a href="https://infinispan.zulipchat.com/apps/" target="_blank">dedicated
            application</a> on the <a href="https://infinispan.zulipchat.com/" target="_blank">Infinispan chat</a>.</p>
</div>
      </div>
      
      <div class="width-12-12 callout orange margin-tb-xs">
    <div class="grid-wrapper">
        <div class="width-4-12 width-12-12-m block-image">
            <img src="/assets/images/blog/authors/fax4ever.jpg" class="author-img">
        </div>
        <div class="width-8-12 width-12-12-m block-content">
            <h5>Fabio Massimo Ercoli</h5>
            <p>Member of the Infinispan @core team. Accountable for indexing, query, serialization, transcoding, metrics and tracing for the hybrid cloud. Former Hibernate @core team, working on NoSql & searching. Former Red Hat consultant, working on intense data applications and solutions. An open source enthusiast and continuous learner.</p>
            <div class="width-3-12 width-6-12-m bio-block">
                <a href="https://github.com/fax4ever"><img src="/assets/images/community/icon-github.png"></a>
                
                <a href="https://twitter.com/FabioMErcoli"><img src="/assets/images/community/icon-twitter.png"></a>
                
                
            </div>
        </div>
    </div>
</div>
      
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/infinispan-logo.png" class="project-logo" title="Infinispan Logo" alt="Infinispan"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Infinispan is released under the Apache 2.0 open source license. Learn more about the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>.<br/><br/>This website built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/infinispan/infinispan.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <b>Navigation</b>
        <ul class="footer-links width-1-12">
          
            
            <li><a href="/" >Home</a></li>
          
            
            <li><a href="/features" >Features</a></li>
          
            
            <li><a href="/documentation" >Docs</a></li>
          
            
            <li><a href="/tutorials" >Tutorials</a></li>
          
            
            <li><a href="/videos" >Videos</a></li>
          
            
            <li><a href="/use-cases" >Use Cases</a></li>
          
            
            <li><a href="/community" >Community</a></li>
          
            
            <li><a href="/download" >Download</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <b>Contribute</b>
        <ul class="footer-links width-1-12">
          
            
            <li><a href="https://github.com/infinispan/infinispan/issues" target="_blank">Submit a Bug</a></li>
          
            
            <li><a href="https://github.com/infinispan" target="_blank">Write Code</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <b>Follow Us</b>
        <ul class="footer-links width-1-12">
          
            
            <li><a href="/blog" >Blog</a></li>
          
            
            <li><a href="https://twitter.com/infinispan" target="_blank">Twitter</a></li>
          
        </ul>
      </div>
    

    <div class="width-6-12 more-links">
      <div class="grid-wrapper">
        <div class="width-6-12">
          <b>A Member of</b><br/>
          <a href="https://www.commonhaus.org/" target="_blank"><img src="/assets/images/CF_logo_horizontal.svg" title="Commonhaus Foundation"></a><br/>
        </div>
        <div class="width-6-12">
          <b>Thanks to</b><br/>
          <a href="https://zulip.com" target="_blank"><img src="/assets/images/footer/zulip.png" title="Zulip" alt="Zulip"></a>
          <a href="https://weblate.org" target="_blank"><img src="/assets/images/footer/weblate.png" title="Weblate" alt="Weblate"></a>
        </div>
      </div>
    </div>
  </div>
</div>

  <div class="content-slim redhat-footer">
  <div class="grid-wrapper">
    <span class="cookie-preferences">
      <a href="#" data-cc="show-preferencesModal">Manage cookie preferences</a>
    </span>
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a>
    </span>
    <span class="redhat">
      a Red Hat sponsored project   
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/truncate-list.js"></script>

  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/cookieconsent.umd.js" type="text/javascript"></script>
  <script src="/assets/javascript/cookieconsent.config.js" type="module"></script>

<!--   <script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
  </script> -->
</body>

</html>
