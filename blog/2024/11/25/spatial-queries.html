<!DOCTYPE html>
<html>

<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-GPD7V946LB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-GPD7V946LB');
  </script>
  <title>Spatial queries</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Infinispan is a distributed in-memory key/value data store with optional schema, available under the Apache License 2.0.">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.css">
  <link rel="stylesheet" href="/assets/css/cookieconsent.css">
  <link rel="alternate" type="application/rss+xml"
        title="Infinispan's RSS Feed"
        href="/feed.xml" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</head>

<body class="blog">
  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/infinispan-logo-white.png" class="project-logo" title="Infinispan Logo"></a>
    </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/learn/">Learn <i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/introduction" class="">Introduction</a></li>
          <li><a href="/features" class="">Features</a></li>
          <li><a href="/documentation" class="">Documentation</a></li>
          <li><a href="/tutorials" class="">Tutorials</a></li>
          <li><a href="/videos" class="">Videos</a></li>
          <li><a href="/references" class="">References</a></li>
          <li><a href="/experiments" class="">Experiments</a></li>
          <li><a href="/roadmap" class="">Roadmap</a></li>
        </ul>
      </li>
      <li>
        <a href="/use-cases/" class="">Use Cases</a>
      </li>
      <li>
        <a href="/community/" class="">Community</a>
      </li>
      <li>
        <a href="/blog/" class="active">Blog</a>
      </li>
      <li>
        <a href="/download/" class="">Download</a>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    
<div class="component-slim full-width-bg dark-bg light-blue">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <a href="/blog">Blogs</a>  <i class="fas fa-chevron-right"></i> Spatial queries
    </div>
  </div>
</div>

<div class="post-page grid-wrapper">
  <div class="grid__item width-10-12 width-12-12-m doc-content">
    <h1>Spatial queries</h1>
    <div class="post-date">November 25, 2024
      Tags: <a href="/blog/tag/search">search</a> <a href="/blog/tag/indexing">indexing</a> <a href="/blog/tag/spatial">spatial</a> <a href="/blog/tag/queries">queries</a> <a href="/blog/tag/geographical">geographical</a> 
    </div>
    <div class="grid-wrapper">
      <div class="grid__item width-8-12 width-12-12-m margin-tb-sm">
        <div class="grid-wrapper">
          <div class="width-2-12 justify-self-center align-self-center">
            <img src="/assets/images/blog/authors/fax4ever.jpg">
          </div>
          <div class="width-10-12 align-self-center">
            <p class="byline">By Fabio Massimo Ercoli</p>
          </div>
        </div>
      </div>
      <div class="grid__item width-12-12">
          <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The upcoming Infinispan 15.1 will support <strong>geographical queries</strong>.
The feature allows users to perform queries based on geographical criteria.
Spatial predicates can used in combination with other predicates to implement additional filtering.
Moreover, spatial fields can be used to project distances and to order the results according to distances from a given geographical point.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spatial-fields-mapping">Spatial fields mapping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can define on the same entity one or more spatial fields.
Each of them denotes a pair of geographical coordinates: latitude and longitude.</p>
</div>
<div class="paragraph">
<p>Suppose we want to define a train route, having a <code>name</code> field and two spatial fields <code>departure</code> and <code>arrival</code>.
We can use <code>@GeoField</code> annotations together with pairs of <code>@Latitude</code> and <code>Longitude</code> annotations.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Proto
@Indexed
@GeoPoint(fieldName = "departure", projectable = true)
@GeoPoint(fieldName = "arrival", sortable = true)
public record TrainRoute(
   @Keyword(normalizer = "lowercase") String name,
   @Latitude(fieldName = "departure") Double departureLat,
   @Longitude(fieldName = "departure") Double departureLon,
   @Latitude(fieldName = "arrival") Double arrivalLat,
   @Longitude(fieldName = "arrival") Double arrivalLon
) {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, we can use the <code>@GeoField</code> annotation together with <code>LatLng</code> fields,
in this case the same entity could be designed with the following, more compact, code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Proto
@Indexed
public record TrainRoute(
   @Keyword(normalizer = "lowercase") String name,
   @GeoField LatLng departure,
   @GeoField LatLng arrival
) {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result on the index model is the same: in both cases we have defined
two spatial fields: <code>departure</code> and <code>arrival</code>.</p>
</div>
<div class="paragraph">
<p>For more information about spatial mappings see the documentation section:
<a href="https://infinispan.org/docs/dev/titles/query/query.html#spatial_fields_mapping">Spatial fields mapping</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spatial-predicates">Spatial predicates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan&#8217;s query language supports three spatial predicates: <code>within circle</code>, <code>within polygon</code> and <code>within box</code>.</p>
</div>
<div class="paragraph">
<p>In order to find all the trains departing from a place that is at most 300 Km from
Bologna, we can define the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Query&lt;TrainRoute&gt; query = cache.query(
   "from geo.TrainRoute r where r.departure within circle(:lat, :lon, :distance)");
query.setParameter("lat", BOLOGNA.latitude());
query.setParameter("lon", BOLOGNA.longitude());
query.setParameter("distance", 300_000);
List&lt;TrainRoute&gt; trainRoutes = trainQuery.list();
assertThat(trainRoutes).extracting(TrainRoute::name)
      .containsExactlyInAnyOrder("Milan-Como", "Bologna-Venezia", "Bologna-Selva");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above query will return trains starting from Milano, since Milan is within 300 Km from Bologna.
Conversely, the result set will not contain any trains departing from Roma.
Notice that parameters can be used as arguments of the predicates.</p>
</div>
<div class="paragraph">
<p>Another way to filter places is to define a given number of vertices.
Those vertices will denote a polygon used to filter all the places that are contained within.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">query = cache.query(
   "from geo.TrainRoute r where r.arrival within polygon(:a, :b, :c, :d)");
query.setParameter("a", "(47.00, 8.00)");
query.setParameter("b", "(47.00, 12.00)");
query.setParameter("c", "(45.70, 12.00)");
query.setParameter("d", "(45.70, 8.00)");
query = trainQuery.list();
assertThat(trainRoutes).extracting(TrainRoute::name)
      .containsExactlyInAnyOrder("Milano-Como", "Bologna-Selva");</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, only trains arriving in Como and Selva are returned, since Milano, Bologna and Roma
are not far enough north.</p>
</div>
<div class="paragraph">
<p>For more information about spatial predicates see the documentation section:
<a href="https://infinispan.org/docs/dev/titles/query/query.html#spatial_predicates">Spatial predicates</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spatial-sorting-and-projections">Spatial sorting and projections</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If we want to sort our results according to the distance from a given query point,
we can use the <code>order by distance</code> clause. Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">select r.name, distance(r.arrival, 41.91, 12.46)
from geo.TrainRoute r
where r.departure within box(45.74, 8.30, 44.22, 12.59)
order by distance(r.arrival, 41.91, 12.46)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the same example we also project the distances from the same query point.
The result will be ordered in ascending order of distances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;Object[]&gt; list = result.list();
assertThat(list).extracting(item -&gt; item[0])
  .containsExactly("Bologna-Venezia", "Milano-Como", "Bologna-Selva");
assertThat(list).extracting(item -&gt; item[1])
  .containsExactly(392893.53564872313, 510660.6643083735, 519774.5486163137);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to use spatial queries with Infinispan, you can do so today by downloading our latest development release.</p>
</div>
<div class="paragraph">
<p>For more information spatial  sorting and projections see the documentation sections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://infinispan.org/docs/dev/titles/query/query.html#spatial_sorting">Spatial Sorting</a></p>
</li>
<li>
<p><a href="https://infinispan.org/docs/dev/titles/query/query.html#spatial_projections">Spatial Projections</a></p>
</li>
</ul>
</div>
</div>
</div>
          
      </div>
      <div class="grid__item width-12-12">
        <h2>Get it, Use it, Ask us! </h2>
We’re hard at work on new features, improvements and fixes, so watch this space for more announcements!
<div class="paragraph">
    <p>Please, <a href="/download" target="_blank">download</a> and test the latest release.</p>
</div>
<div class="paragraph">
    <p>The source code is hosted on <a href="" target="_blank">GitHub</a>.
        If you need to report a bug or request a new feature, look for a similar one on our <a href="https://github.com/infinispan/infinispan/issues" target="_blank">GitHub issues tracker</a>.
        If you don’t find any, <a href="https://github.com/infinispan/infinispan/issues" target="_blank">create a new issue</a>.</p>
</div>
<div class="paragraph">
    <p>If you have questions, are experiencing a bug or want advice on using Infinispan,
        you can use <a href="https://github.com/infinispan/infinispan/discussions/"
                       target="_blank">GitHub discussions</a>.
        We will do our best to answer you as soon as we can.</p>
</div>
<div class="paragraph">
    <p>The Infinispan community uses <a href="https://zulipchat.com/"
                                        target="_blank">Zulip</a> for real-time communications.
        Join us using either a web-browser or a <a href="https://infinispan.zulipchat.com/apps/" target="_blank">dedicated
            application</a> on the <a href="https://infinispan.zulipchat.com/" target="_blank">Infinispan chat</a>.</p>
</div>
      </div>
      
      <div class="width-12-12 callout orange margin-tb-xs">
    <div class="grid-wrapper">
        <div class="width-4-12 width-12-12-m block-image">
            <img src="/assets/images/blog/authors/fax4ever.jpg" class="author-img">
        </div>
        <div class="width-8-12 width-12-12-m block-content">
            <h5>Fabio Massimo Ercoli</h5>
            <p>Member of the Infinispan @core team at Red Hat. Accountable for indexing, query, serialization, transcoding, metrics and tracing for the hybrid cloud. Former Hibernate @core team, working on NoSql & searching. Former Red Hat consultant, working on intense data applications and solutions. An open source enthusiast and continuous learner.</p>
            <div class="width-3-12 width-6-12-m bio-block">
                <a href="http://github.com/fax4ever"><img src="/assets/images/community/icon-github.png"></a>
                
                <a href="http://twitter.com/FabioMErcoli"><img src="/assets/images/community/icon-twitter.png"></a>
                
                
            </div>
        </div>
    </div>
</div>
      
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/infinispan-logo.png" class="project-logo" title="Infinispan Logo" alt="Infinispan"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Infinispan is released under the Apache 2.0 open source license. Learn more about the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>.<br/><br/>This website built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/infinispan/infinispan.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <b>Navigation</b>
        <ul class="footer-links width-1-12">
          
            
            <li><a href="/" >Home</a></li>
          
            
            <li><a href="/features" >Features</a></li>
          
            
            <li><a href="/documentation" >Docs</a></li>
          
            
            <li><a href="/tutorials" >Tutorials</a></li>
          
            
            <li><a href="/videos" >Videos</a></li>
          
            
            <li><a href="/use-cases" >Use Cases</a></li>
          
            
            <li><a href="/community" >Community</a></li>
          
            
            <li><a href="/download" >Download</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <b>Contribute</b>
        <ul class="footer-links width-1-12">
          
            
            <li><a href="https://issues.jboss.org/browse/ISPN" target="_blank">Submit a Bug</a></li>
          
            
            <li><a href="https://github.com/infinispan" target="_blank">Write Code</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <b>Follow Us</b>
        <ul class="footer-links width-1-12">
          
            
            <li><a href="/blog" >Blog</a></li>
          
            
            <li><a href="https://twitter.com/infinispan" target="_blank">Twitter</a></li>
          
        </ul>
      </div>
    

    <div class="width-6-12 more-links">
      <div class="grid-wrapper">
        <div class="width-6-12">
          <b>A Member of</b><br/>
          <a href="https://www.commonhaus.org/" target="_blank"><img src="/assets/images/CF_logo_horizontal.svg" title="Commonhaus Foundation"></a><br/>
        </div>
        <div class="width-6-12">
          <b>Thanks to</b><br/>
          <a href="https://zulip.com" target="_blank"><img src="/assets/images/footer/zulip.png" title="Zulip" alt="Zulip"></a>
          <a href="https://weblate.org" target="_blank"><img src="/assets/images/footer/weblate.png" title="Weblate" alt="Weblate"></a>
        </div>
      </div>
    </div>
  </div>
</div>

  <div class="content-slim redhat-footer">
  <div class="grid-wrapper">
    <span class="cookie-preferences">
      <a href="#" data-cc="show-preferencesModal">Manage cookie preferences</a>
    </span>
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a>
    </span>
    <span class="redhat">
      a Red Hat sponsored project   
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/truncate-list.js"></script>

  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/cookieconsent.umd.js" type="text/javascript"></script>
  <script src="/assets/javascript/cookieconsent.config.js" type="module"></script>

<!--   <script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
  </script> -->
</body>

</html>
