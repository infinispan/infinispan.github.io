<!DOCTYPE html> <html lang="en"> <head> <title>Blog - Infinispan</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="DENY" http-equiv="X-Frame-Options"> <meta content="1; mode=block" http-equiv="X-XSS-Protection"> <meta content="nosniff" http-equiv="X-Content-Type-Options"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" rel="stylesheet"> <script id="dpal" src="https://www.redhat.com/dtm.js" type="text/javascript"></script> <link href="/images/favicon.png" rel="shortcut icon" type="image/png"> <link href="//static.jboss.org/images/example/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="//static.jboss.org/images/example/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="//static.jboss.org/images/example/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="//static.jboss.org/images/example/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css" rel="stylesheet"> <link href="https://static.jboss.org/css/rhbar.css" media="screen" rel="stylesheet"> <style>
      .jumbotron {
        padding: 0.5em 0.1em 0.5em 0.1em;
        background-image: none;
        background-color: #ffec9f;
      }
      .jumbotron p, 
      .jumbotron h1 {
        color: #656565;
      }
      .dropup {
        z-index: 1032;
      }
      .navbar {
        font-size: x-large;
      }
      .navbar ul {
        padding-top: 0.7em;
      }
      .navbar-brand {
        height: 80px;
      }
      .navbar-default {
        background-color: white;
      }
      .navbar-default .navbar-nav > li > a {
        color: #336699;
      }
      .navbar-default .navbar-nav > li > a:hover {
        color: #204060;
      }
      .navbar-default .navbar-nav > .open > a,
      .navbar-default .navbar-nav > .open > a:hover,
      .navbar-default .navbar-nav > .open > a:focus {
        background-color: #4a5d75;
      }
      h3.well {
        border-color: #ffd630;
        background-color: #ffec9f;
      }
      .panel-sidebar {
        border-color: #f5f5f5;
      }
      .panel-sidebar > .panel-heading {
        border-color: #e3e3e3;
        background-color: #f5f5f5;
        color: #656565;
      }
      .btn-primary {
        border-color: #ffd630;
        background-color: #ffec9f;
        color: #656565;
      }
      footer.container {
        background-color: white;
      }
      footer.container h1, footer.container h2, footer.container h3, footer.container h4, footer.container h5, footer.container h6, footer.container p, footer.container a {
        color: #656565;
      }
      footer.container ul {
        padding: 0;
      }
      i.enormous-icon {
        margin-top: 0.3em;
      }
      .home-examples {
        font-size: 16px;
      }
    </style> <script src="//static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script> <script>
      hljs.initHighlightingOnLoad();
    </script> <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     
    ga('create', 'UA-8601422-1', 'auto');
    ga('send', 'pageview');
    
    </script> </head> <body> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div id="rhbar"> <a class="jbdevlogo" href="http://www.jboss.org/projects/about"></a> <a class="rhlogo" href="http://www.redhat.com/"></a> </div> <div class="container" id="content"> <nav class="navbar navbar-default navbar-fixed-top"> <div class="container"> <div class="navbar-header"> <button aria-expanded="false" class="navbar-toggle collapsed" data-target="#thenavbar" data-toggle="collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img alt="Infinispan" src="/images/infinispan_nav_brand.png"> </a> </div> <div class="navbar-collapse collapse" id="thenavbar"> <ul class="nav navbar-nav"> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/about">About <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/about">Introduction</a></li> <li><a href="/features">Features</a></li> <li><a href="/release-notes">Release notes</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/references">References</a></li> <li><a href="/experiments/">Experiments</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/documentation">Learn <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/documentation">Documentation</a></li> <li><a href="/tutorials">Tutorials</a></li> <li><a href="/videos">Videos</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/download">Download <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/download">Infinispan Releases</a></li> <li><a href="/cache-store-implementations">Cache Store Implementations</a></li> <li><a href="/hotrod-clients">Hot Rod Clients</a></li> <li><a href="/integrations">Integrations</a></li> <li><a href="/download-archive">Archive</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/community">Community <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/community">Ask for Help</a></li> <li><a href="/getinvolved">Get Involved</a></li> </ul> </li> <li class=""><a href="/roadmap">Road Map</a></li> <li class="divider"></li> </ul> </div> </div> </nav> <div class="post"></div> <h3> Monday, 19 February 2018 </h3> <h1> <a href="/blog/2018/02/19/distributed-iteration-improvements/">Distributed iteration improvements</a> </h1> <div class="content"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan hasn&#8217;t always provided a way for iterating upon entries in a distributed cache. In fact the <a href="https://issues.jboss.org/browse/ISPN-4222">first iteration</a> wasn&#8217;t until Infinispan 7. Then in Infinispan 8, with the addition of Java 8, we fully integrated this into <a href="http://blog.infinispan.org/2015/09/distributed-streams.html">distributed streams</a>, which brought some minor iteration improvements in performance.</p> </div> <div class="paragraph"> <p>We are proud to announce that with Infinispan 9.2 there are even more improvements. This contains no API changes, although those will surely come in the future. This one is purely for performance and utilization.</p> </div> </div> </div> <div class="sect1"> <h2 id="_new_implementation_details"><a class="anchor" href="#_new_implementation_details"></a>New implementation details</h2> <div class="sectionbody"> <div class="sect2"> <h3 id=""><a class="anchor" href="#"></a> </h3> <div class="paragraph"> <p>There are a few different aspects that have been changed.  A lot of these revolve around the amount of entries being retrieved at once, which if you are familiar with DistributedStreams can be configured via the <a href="https://docs.jboss.org/infinispan/9.2/apidocs/org/infinispan/BaseCacheStream.html#distributedBatchSize-int-">distributedBatchSize</a> method. Note that if this is not specified it defaults to the <a href="https://docs.jboss.org/infinispan/9.2/apidocs/org/infinispan/configuration/cache/StateTransferConfigurationBuilder.html#chunkSize-int-">chunk size</a> in state transfer.</p> </div> <div class="sect3"> <h4 id="_entry_retrieval_is_now_pull_based_instead_of_push"><a class="anchor" href="#_entry_retrieval_is_now_pull_based_instead_of_push"></a>Entry retrieval is now pull based instead of push</h4> <div class="paragraph"> <p>Infinispan core (embedded) has added <a href="https://github.com/ReactiveX/RxJava/tree/2.x">rxjava2</a> and <a href="https://github.com/reactive-streams/reactive-streams-jvm">reactive streams</a> as dependencies and rewrote all of the old push style iterator code over to pull style to fully utilize the Publisher and Subscriber interfaces.</p> </div> <div class="paragraph"> <p>With this we only pull up to the batchSize in entries at a time from any set of nodes. The old style utilized push with call stack blocking, which could return up two times the amount of entries. Also since we aren&#8217;t performing call stack blocking, we don&#8217;t have to waste threads as these calls to retrieve entries are done async and finish very quickly irrespective of user interaction. The old method required multiple threads to be reserved for this purpose.</p> </div> </div> <div class="sect3"> <h4 id="_streamed_batches"><a class="anchor" href="#_streamed_batches"></a>Streamed batches</h4> <div class="paragraph"> <p>The responses from a remote node are written directly to the output stream so there are no intermediate collections allocated. This means we only have to iterate upon the data once as we retain the iterator between requests. On the originator we still have to store the batches in a collection to be enqueued for the user to pull.</p> </div> </div> <div class="sect3"> <h4 id="_rewritten_parallel_distribution"><a class="anchor" href="#_rewritten_parallel_distribution"></a>Rewritten Parallel Distribution</h4> <div class="paragraph"> <p>Great care was taken to implement parallel distribution in a way to vastly reduce contention and ensure that we properly follow the batchSize configuration.</p> </div> <div class="paragraph"> <p>When parallel distribution is in use the new implementation will start 4 remote node requests sharing the batch size (so each one gets 1/4). This way we can guarantee that we only have the desired size irrespective of the number of nodes in the cluster. The old implementation would request batchSize from all nodes at the same time. So not only did it reserve a thread for node but could easily swamp your JVM memory, causing OutOfMemoryErrors (which no one likes). The latter alone made us force the default to be sequential distribution when using an iterator.</p> </div> <div class="paragraph"> <p>The old implementation would write entries from all nodes (including local) to the same shared queue. The new implementation has a different queue for each request, which allows for faster queues with no locking to be used.</p> </div> <div class="paragraph"> <p>Due to these changes and other isolations between threads, we can now make parallel distribution the default setting for the iterator method. And as you will see this has improved performance nicely.</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="_performance"><a class="anchor" href="#_performance"></a>Performance</h2> <div class="sectionbody"> <div class="paragraph"> <p>We have written a <a href="http://openjdk.java.net/projects/code-tools/jmh/">JMH</a> test harness specifically for this blog post, testing 9.1.5.Final <a href="https://github.com/infinispan/infinispan/releases/tag/9.1.5.Final">build</a> against latest 9.2.0.SNAPSHOT. The test runs by default with 4GB of heap with 6 nodes in a distributed cache with 2 owners. It has varying entry count, entry sizes and distributed batch sizes.</p> </div> <div class="paragraph"> <p>Due to the variance in each test a large number of tests were ran and with different permutations to make sure it covered a large amount of test cases. The JMH test that was ran can be found at <a href="https://github.com/infinispan/infinispan-benchmarks/tree/master/iteration">github</a>. All the default settings were used for the run except -t4 (runs with 4 worker threads) was provided. This was all ran on my measly laptop (i7-4810MQ and 16 GB) - maxing out the CPU was not a hard task.</p> </div> <div class="paragraph"> <p><strong>CAVEAT</strong>: The tests don&#8217;t do anything with the iterator and just try to pull them as fast as they can. Obviously if you have a lot of processing done between iterations you will likely not see as good of a performance increase.</p> </div> <div class="paragraph"> <p>The entire results can be found <a href="https://docs.google.com/spreadsheets/d/18v8e6vG-4aX8Pk-ihB3p1H5cQvsSQlFMhQSKxPhSLf0/edit?usp=sharing">here</a>. It shows each permutation and how many operations per second and finds the difference (green shows 5% or more and red shows -5% or less).</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Operation</th> <th class="tableblock halign-left valign-top">Average Gain</th> <th class="tableblock halign-left valign-top">Code</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Specified Distribution Mode</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">3.5%</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">.entrySet().stream().sequentialDistribution.iterator()</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Default</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">11%</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">.entrySet().iterator()</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">No Rehash</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">14%</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">.entrySet().stream().disableRehashAware().iterator()</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>The above 3 rows show a few different ways you could have been invoking the iterator method. The second row is probably by far the most used case. In this case you should see around a <strong>11</strong>% increase in performance (results will vary). This is due to the new pulling method as well as parallel distribution becoming the new default running mode. It is unlikely a user was using the other 2 methods, but are provided for a more complete view.</p> </div> <div class="paragraph"> <p>If you were specifying a distribution mode manually, either sequential or distribution you will only see a few percent faster run (<strong>3.5</strong>%), but every little bit helps! Also if you can switch to parallel you may want to think about doing so.</p> </div> <div class="paragraph"> <p>Also you can see if you were running with rehash disabled prior, it has even more gains (<strong>14</strong>%). Those don&#8217;t even include the fact that no rehash was <strong>28</strong>% faster than with before (which means it is about <strong>32</strong>% faster in general now). So if you can get away with a <em>at most once</em> guarantee, disabling rehash will provide the best throughput.</p> </div> </div> </div> <div class="sect1"> <h2 id="_whats_next"><a class="anchor" href="#_whats_next"></a>Whats next? </h2> <div class="sectionbody"> <div class="paragraph"> <p>As was mentioned this is not exposed to the user directly. You still interact with the iterator as you would normally. We should remedy this at some point.</p> </div> <div class="sect2"> <h3 id="_expose_new_method"><a class="anchor" href="#_expose_new_method"></a>Expose new method</h3> <div class="paragraph"> <p>We would love to eventually expose a method to return a Publisher directly to the user so that they can get the full benefits of having a pull based implementation underneath.</p> </div> <div class="paragraph"> <p>This way any intermediate operations applied to the stream before would be distributed and anything applied to the Publisher would be done locally. And just like the iterator method this publisher would be fully rehash aware if you have it configured to do so and would make sure you get all entries delivered in an <em>exactly once</em> fashion (rehash disabled guarantees <em>at most once</em>).</p> </div> <div class="paragraph"> <p>Another side benefit is that the Subscriber methods could be called on different threads so there is no overhead required on the ISPN side for coordinating these into queue(s). Thus the Subscriber <em>should</em> be able to retrieve all entries faster than just doing an iterator.</p> </div> </div> <div class="sect2"> <h3 id="_java_9_flow"><a class="anchor" href="#_java_9_flow"></a>Java 9 Flow</h3> <div class="paragraph"> <p>Also many of you may be wondering why we aren&#8217;t using the new Flow API introduced in Java 9. Luckily the Flow API is a 1:1 conversion of reactive streams. So whenever Infinispan will start supporting Java 9 interfaces/classes, we hope to properly expose these as the JDK classes.</p> </div> </div> <div class="sect2"> <h3 id="_segment_based_iteration"><a class="anchor" href="#_segment_based_iteration"></a>Segment Based Iteration </h3> <div class="paragraph"> <p>With Infinispan 9.3, we hope to introduce <a href="https://issues.jboss.org/browse/ISPN-5451">data container</a> and <a href="https://issues.jboss.org/browse/ISPN-6026">cache store</a> segment aware iteration. This means when iterating over either we would only have to process entries that map to a given segment. This should reduce the time and processing for iteration substantially, especially for cache stores. Keep your eyes out for a future blog post detailing these as 9.3 development commences.</p> </div> </div> <div class="sect2"> <h3 id="_give_us_feedback"><a class="anchor" href="#_give_us_feedback"></a>Give us Feedback</h3> <div class="paragraph"> <p>We hope you find a bit more performance when working with your distributed iteration. Also we value any feedback on what you want our APIs to look like or find any bugs. As always let us know at any of the places listed <a href="http://infinispan.org/community/">here</a>.</p> </div> </div> </div> </div> </div> <a class="label" href="/blog/tags/9.2/"> 9.2 </a> <a class="label" href="/blog/tags/performance/"> performance </a> <a class="label" href="/blog/tags/streams/"> streams </a> <a class="label" href="/blog/tags/distribution/"> distribution </a> <a class="label" href="/blog/tags/iteration/"> iteration </a> <hr> <div class="post"></div> <h3> Thursday, 01 February 2018 </h3> <h1> <a href="/blog/2018/02/01/executing-code-in-grid/">Executing Code in the Grid</a> </h1> <div class="content"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan has quite a few spectacular ways of executing code in the grid. But I bet you haven&#8217;t heard or aren&#8217;t really familiar with those, which is disappointing. I hope to fix this, however, as we have added more information to the user guide and wanted to detail that here in this blog.</p> </div> <div class="paragraph"> <p>As I am sure you are aware Infinispan can be used in embedded (in your JVM) and remote (in a standalone server). Unfortunately, this means there are different ways of executing code based on which mode you are in.</p> </div> </div> </div> <div class="sect3"> <h4 id="_embedded"><a class="anchor" href="#_embedded"></a>Embedded</h4> <div class="paragraph"> <p>The embedded mode has the most features available and is the easiest to use. The appropriate section can be found <a href="http://infinispan.org/docs/dev/user_guide/user_guide.html#executing_code_in_the_grid">here</a>.</p> </div> <div class="paragraph"> <p>One question that seems to come up more than others is how a user can perform cache operations on all data, such as remove all elements that match a given filter. If you are curious about this one, you should check out the <a href="http://infinispan.org/docs/dev/user_guide/user_guide.html#examples_2">Examples</a> section with the example named "<strong>Remove specific entries"</strong> as it details how a user would do exactly that.</p> </div> <div class="paragraph"> <p>I should also point out the new <a href="http://infinispan.org/docs/dev/user_guide/user_guide.html#cluster_executor">Cluster Executor</a> section, which is similar to Streams that replaced Map Reduce, is here to replace the old Distributed Executor. With Cluster Executor and Distributed Streams there is a clearer distinction between executing code on nodes (Cluster Executor) and executing code based on data (Distributed Streams). **</p> </div> </div> <div class="sect3"> <h4 id="_server"><a class="anchor" href="#_server"></a>Server</h4> <div class="paragraph"> <p>The server is a bit more interesting and usually requires configuration ahead of time, unlike Embedded. It can be found in this <a href="http://infinispan.org/docs/dev/user_guide/user_guide.html#executing_code_in_the_remote_grid">section</a>. The benefit of the server is most of these can invoke embedded operations internally.</p> </div> <div class="paragraph"> <p>Scripting is by far the easiest to use - just insert your script and execute - but has some <a href="https://issues.jboss.org/browse/ISPN-6173">limitations</a> that we haven&#8217;t been able to fix yet.</p> </div> <div class="paragraph"> <p>Server tasks can run pretty much any Java but require registering classes beforehand. Unfortunately, this section still needs to be filled in and should be added sometime in the near future. I would say, until then, if you are interested, you can look at some tests in <a href="https://github.com/infinispan/infinispan/tree/master/server/integration/testsuite/src/test/java/org/infinispan/server/test/task/servertask">github</a>.</p> </div> </div> <div class="sect3"> <h4 id="_takeaway"><a class="anchor" href="#_takeaway"></a>Takeaway</h4> <div class="paragraph"> <p>I hope this has helped users be able to find out some more information about the various ways of executing arbitrary code for your data. If you have any questions or need more clarification about the features highlighted here, please don&#8217;t hesitate to let us know at any of these <a href="http://infinispan.org/community/">places</a>.</p> </div> </div> </div> <a class="label" href="/blog/tags/distributed executors/"> distributed executors </a> <a class="label" href="/blog/tags/streams/"> streams </a> <hr> <div class="post"></div> <h3> Monday, 08 January 2018 </h3> <h1> <a href="/blog/2018/01/08/improving-collect-for-distributed-java/">Improving collect() for distributed Java Streams in Infinispan 9.2</a> </h1> <div class="content"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>As we progress with the release of Infinispan 9.2 pre-releases, it&#8217;s important to highlight some of the more interesting improvements from an end-user perspective.</p> </div> <div class="paragraph"> <p>As mentioned <a href="http://blog.infinispan.org/2017/05/reactive-big-data-on-openshift-in.html">before</a>, <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#streams">Infinispan Distributed Java Streams</a> can be used to calculate analytics over existing data. Through overloading of methods, Infinispan is able to offer a simple way of passing lambdas that are made to be Serializable without the need of explicit casting. Being able to produce binary formats for the lambdas is an important step for java streams executions to be distributed. In this example, the cached values are being filtered to find those that have a delay bigger than 0. This lambda can be safely distributed without the need to cast to Serializable because values().stream() returns org.infinispan.CacheStream that overloads filter to take a SerializablePredicate:</p> </div> <div class="paragraph"> <p>Cache&lt;String, Stop&gt; cache = &#8230;&#8203; cache.values().stream()   .filter(e &#8594; e.delayMin &gt; 0);</p> </div> <div class="paragraph"> <p>However, there was one area which was still a bit clunky to use: Java Collectors. When Java Streams came out, the JDK provided a class called java.util.stream.Collectors which includes a lot of helper methods for collecting results after stream processing. The problem with the Collector instances returned by the helper methods is that they&#8217;re not Serializable.</p> </div> <div class="paragraph"> <p>Before Infinispan 9.2, we worked around this problem with the help of org.infinispan.stream.CacheCollectors which defined a serializableCollector method that took a SerializableSupplier&lt;Collector&lt;T, ?, R&gt;&gt;. The aim here was this: even if the Collector instance is not Serializable, the function that creates the Collector can be made to be Serializable. It could be used this way:</p> </div> <div class="paragraph"> <p>Cache&lt;String, Stop&gt; cache = &#8230;&#8203; cache.values().stream().collect(   CacheCollectors.serializableCollector) &#8594; Collectors.groupingBy(       e &#8594; getHourOfDay(e.departureTs),       Collectors.counting());</p> </div> <div class="paragraph"> <p>Although this worked, it was a clunky, so in Infinispan 9.2 we overloaded collect() in org.infinispan.CacheStream to take SerializableSupplier&lt;Collector&lt;T, ?, R&gt;&gt;. This means that in Infinispan 9.2, the code above can be written like this instead:</p> </div> <div class="paragraph"> <p>Cache&lt;String, Stop&gt; cache = &#8230;&#8203; cache.values().stream().collect(   () &#8594; Collectors.groupingBy(       e &#8594; getHourOfDay(e.departureTs),       Collectors.counting() ));</p> </div> <div class="paragraph"> <p>This is a cleaner way of making sure Collector instances returned by java.util.stream.Collectors can be distributed.</p> </div> <div class="paragraph"> <p>Cheers, Galder</p> </div> </div> </div> </div> <a class="label" href="/blog/tags/9.2/"> 9.2 </a> <a class="label" href="/blog/tags/streams/"> streams </a> <hr> <div class="post"></div> <h3> Monday, 03 July 2017 </h3> <h1> <a href="/blog/2017/07/03/dont-touch-my-data-stream/">Don't touch my data stream!</a> </h1> <div class="content"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>In Infinispan 8.0 we were very excited to announce <a href="http://blog.infinispan.org/2015/09/distributed-streams.html">Distributed Streams</a> as we moved to Java 8. This feature allows applying any of the various java.util.stream.Stream operations on the datagrid, which are performed in a distributed nature, providing the highest possible performance as data is processed on the node where it lives, only requiring the terminal operation intermediate results to be returned to the invoker.</p> </div> <div class="paragraph"> <p>One problem with distributed streams though is that data is processed without acquiring locks: great for performance, but there is no guarantee that some other process isn&#8217;t concurrently modifying the cache entry you&#8217;re working on. Consider the following example which iterates through the entire contents of a cache, modifying each entry based on its existing value:</p> </div> <div class="paragraph"> <p>This works great until you have another cache <em>put()</em> running concurrently that changes a value. In this case the only way to be sure that an update is applied properly is to perform an optional update in the <em>forEach.</em> In a transactional cache you could also lock the entry manually (pessimistic) or retry on a <em>WriteSkewException</em> (optimistic). For example this is how the optional update could be performed.</p> </div> <div class="paragraph"> <p>As you can see the code isn&#8217;t as pretty as it was before, but is still pretty concise.</p> </div> <div class="paragraph"> <p>Infinispan 9.1 introduces <em>locked streams</em>, which allow you to run your operation knowing that another update cannot be performed while running the <em>Consumer</em>. Note this only works in non transactional and pessimistic transactional caches (optimistic transactional caches are not supported).</p> </div> <div class="paragraph"> <p>If you notice the code looks very similar to the first example. You just have to invoke the <em>lockedStream</em> method on the <em>AdvancedCache</em> and then you can use the stream knowing that data for the given key won&#8217;t change while performing your update.</p> </div> <div class="paragraph"> <p>This locked stream has a slightly limited API compared to the normal java.util.stream API. Only the <em>filter</em> method is allowed in addition to <em>forEach.</em> The <em>CacheStream</em> API is also supported, with a few exceptions. For more details on the API and what methods are supported you should check out the <a href="https://docs.jboss.org/infinispan/9.1/apidocs/org/infinispan/LockedStream.html">Javadoc</a>.</p> </div> <div class="paragraph"> <p>The lock is only acquired for the given key while invoking the <em>Consumer</em>, allowing other updates on other keys to be performed concurrently, just like a normal <em>put</em> operation would behave. It is not suggested to perform operations on other keys in the <em>Consumer,</em> as this could cause possible deadlocks.</p> </div> <div class="paragraph"> <p>Now go forth and perform operations using the data stream knowing that the data underneath has not changed!</p> </div> </div> </div> </div> <a class="label" href="/blog/tags/streams/"> streams </a> <hr> <div class="post"></div> <h3> Friday, 07 April 2017 </h3> <h1> <a href="/blog/2017/04/07/in-memory-data-grid-patterns-demos-from/">In Memory Data Grid Patterns Demos from Devoxx France!</a> </h1> <div class="content"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p><a href="http://devoxx.fr/">Devoxx France 2017</a> was a blast!! Emmanuel and I would like to thank all attendees to our <a href="http://cfp.devoxx.fr/2017/talk/UKK-0693/Architecture_par_la_pratique:_patterns_d%E2%80%99utilisation_de_systemes_in-memory_-_WD-40_entre_vos_donnees_et_vos_applis">in-memory data grids patterns</a> talk. The room was full and we thoroughly enjoyed the experience!</p> </div> <div class="paragraph"> <p>During the talk we presented a couple of small demos that showcased some in-memory data grid use cases. The demos are located <a href="https://github.com/galderz/datagrid-patterns">here</a>, but I thought it&#8217;d be useful to provide some <a href="https://github.com/galderz/datagrid-patterns">step-by-step</a> here so that you can get them running as quickly as possible.</p> </div> <div class="paragraph"> <p>Before we start with any of the demos, it&#8217;s necessary to run some set up steps:</p> </div> <div class="paragraph"> <p>  1. Check out git repository:</p> </div> <div class="paragraph"> <p>    git clone <a href="https://github.com/galderz/datagrid-patterns" class="bare">https://github.com/galderz/datagrid-patterns</a></p> </div> <div class="paragraph"> <p>  2. Download <a href="http://downloads.jboss.org/infinispan/9.0.0.Final/infinispan-server-9.0.0.Final-bin.zip">Infinispan Server 9.0.0.Final</a> and at the same level as the git repository.</p> </div> <div class="paragraph"> <p>  3. Go into the datagrid-patterns directory, start the servers and wait until they&#8217;ve started:</p> </div> <div class="paragraph"> <p>    cd datagrid-patterns     ./run-servers.sh</p> </div> <div class="paragraph"> <p>  4. Install <a href="https://www.continuum.io/downloads">Anaconda for Python 3</a>, this is required to run Jupyter notebook for plotting.</p> </div> <div class="paragraph"> <p>  5. Install <a href="https://maven.apache.org/download.cgi">Maven 3</a>.</p> </div> <div class="paragraph"> <p>Once the set up is complete, it&#8217;s time to start with the individual demos.</p> </div> <div class="paragraph"> <p>Both demos shown below work with the same application domain: rail transport systems. In this domain, we differentiate between physical stations, trains, station boards which are located in stations, and finally stops, which are individual entries in station boards.</p> </div> </div> </div> <div class="sect2"> <h3 id="_analytics_demo"><a class="anchor" href="#_analytics_demo"></a>Analytics Demo</h3> <div class="paragraph"> <p>The first demo is focused on how you can use Infinispan for doing offline analytics. In particular, this demo tries to answer the following question:</p> </div> <div class="paragraph"> <p><em>Q. What is the time of the day when there is the biggest ratio of delayed trains?</em></p> </div> <div class="paragraph"> <p>To answer this question, Infinispan data grid will be loaded with 3 weeks worth of data from station boards. Once the data is loaded, we will execute a remote server task which will use <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#streams">Infinispan Distributed Java Streams</a> to calculate the two pieces of information required to answer the question: per hour, how many trains are going through the system, and out of those, how many are delayed.</p> </div> <div class="paragraph"> <p>An important aspect to bear in mind about this server tasks is that it will only be executed in one of the nodes in the cluster. It does not matter which one. In turn, this node will will ship the lambdas required to do the computation to each of the nodes so that they can executed against their local data. The other nodes will reply with the results and the node where the server task was invoked will aggregate the results.</p> </div> <div class="paragraph"> <p>Then, these results are sent back to the client, which in turn, stores the results as JSON in an intermediate cache. Once the results are in place, we will use a Jupyter notebook to read those results and plot the result.</p> </div> <div class="paragraph"> <p>Let&#8217;s see these steps in action:</p> </div> <div class="paragraph"> <p>  1. First, we need to install the server tasks in the running servers above:</p> </div> <div class="paragraph"> <p>    cd datagrid-patterns/analytics</p> </div> <div class="paragraph"> <p>    mvn clean install package -am -pl analytics-server</p> </div> <div class="paragraph"> <p>    mvn wildfly:deploy -pl analytics-server</p> </div> <div class="paragraph"> <p>    </p> </div> <div class="paragraph"> <p>  2. Open the datagrid-pattern repo with your favourite IDE and run <strong>delays.java.stream.InjectApp</strong> class located in analytics/analytics-server project. This command will inject the data into the cache. On my environment, it takes between 1 and 2 minutes.</p> </div> <div class="paragraph"> <p>  3. With the data loaded, we need to run the remote task that will calculate the total number of trains per hour and how many of those are delayed. To do that, execute <strong>delays.java.stream.AnalyticsApp</strong> class located in analytics/analytics-server project from your IDE.</p> </div> <div class="paragraph"> <p>  4. You can verify that the results have been calculating by going to the following address:</p> </div> <div class="paragraph"> <p>    <a href="http://localhost:8180/rest/analytics-results/results" class="bare">http://localhost:8180/rest/analytics-results/results</a></p> </div> <div class="paragraph"> <p>  5. With the results in place, it&#8217;s time to start the Jupyter notebook:</p> </div> <div class="paragraph"> <p>    cd datagrid-patterns/analytics/analytics-jupyter</p> </div> <div class="paragraph"> <p>    ~/anaconda/bin/jupyter notebook</p> </div> <div class="paragraph"> <p>  6. Once the notebook opens, click open <strong>live-demo.ipynb</strong> notebook and execute each of the cells in order. You should end up seeing a plot like this:</p> </div> <div class="paragraph"> <p><a href="https://1.bp.blogspot.com/-0WwGpCjfU1g/WOdG4rNJ8QI/AAAAAAAAE10/L0bV9eq8RZgIDw-C51UyukbZRuZJUyPCQCLcB/s1600/Screen%2BShot%2B2017-04-07%2Bat%2B09.58.56.png"><span class="image"><img src="https://1.bp.blogspot.com/-0WwGpCjfU1g/WOdG4rNJ8QI/AAAAAAAAE10/L0bV9eq8RZgIDw-C51UyukbZRuZJUyPCQCLcB/s320/Screen%2BShot%2B2017-04-07%2Bat%2B09.58.56.png" alt="image" width="320" height="240"></span></a></p> </div> <div class="paragraph"> <p>So, the answer to the question:</p> </div> <div class="paragraph"> <p><em>Q. What is the time of the day when there is the biggest ratio of delayed trains?</em></p> </div> <div class="paragraph"> <p>is <strong>2am</strong>! That&#8217;s because last connecting trains of the day wait for each other to avoid leaving passengers stranded.</p> </div> </div> <div class="sect2"> <h3 id="_real_time_demo"><a class="anchor" href="#_real_time_demo"></a>Real Time Demo</h3> <div class="paragraph"> <p>The second demo that we presented uses the same application domain as above, but this time we&#8217;re trying to use our data grid as a way of storing the station board state of each station at a given point in time. So, the idea is to use Infinispan as an in memory data grids for working with real time data.</p> </div> <div class="paragraph"> <p>So, what can we do with this type of data? In our demo, we will create a centralised dashboard of delayed trains around the country. To do that, we will take advantage of <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#query.continuous">Infinispan&#8217;s Continuous Query</a> functionality which allows us to find those station boards which contain stops that are delayed, and as new delayed trains appeared these will be pushed to our dashboard.</p> </div> <div class="paragraph"> <p>To run this demo, keep the same servers running as above and do the following:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Run <strong>delays.query.continuous.FxApp</strong> application located in real-time project inside the datagrid-patterns demo. This app will inject some live station board data and will launch a JavaFX dashboard that shows delayed trains as they appear. It should look something like this:</p> </li> </ol> </div> <div class="paragraph"> <p><a href="https://2.bp.blogspot.com/-vyFHhzmswQg/WOdJ1PnoOJI/AAAAAAAAE2A/Ui1YS1T93JIxPKpwbS6u0p1whsok3nxfwCLcB/s1600/Screen%2BShot%2B2017-04-07%2Bat%2B10.11.40.png"><span class="image"><img src="https://2.bp.blogspot.com/-vyFHhzmswQg/WOdJ1PnoOJI/AAAAAAAAE2A/Ui1YS1T93JIxPKpwbS6u0p1whsok3nxfwCLcB/s320/Screen%2BShot%2B2017-04-07%2Bat%2B10.11.40.png" alt="image" width="320" height="248"></span></a></p> </div> </div> <div class="sect2"> <h3 id="_conclusion"><a class="anchor" href="#_conclusion"></a>Conclusion</h3> <div class="paragraph"> <p>This has been a summary of the demos that we run in our talk at Devoxx France with the intention of getting you running these demos as quickly as possible. The repository contains more detailed information of these demos. If there&#8217;s anything unclear or any of the instructions above are not working, please let us know!</p> </div> <div class="paragraph"> <p>Thanks to Emmanuel Bernard for partnering with me for this Devoxx France talk and for the continuous feedback while developing the demos. Thanks as well to Tristan Tarrant for the input in the demos and many thanks to all Devoxx France attendees who attended our talk :)</p> </div> <div class="paragraph"> <p>A very special thanks to <strong>Alexandre Masselot</strong> whose <a href="https://www.slideshare.net/alexmass/swiss-transport-in-real-time-tribulations-in-the-big-data-stack">"Swiss Transport in Real Time: Tribulations in the Big</a> Data Stack" talk at Soft-Shake 2016 was the inspiration for these demos. @Alex, thanks a lot for sharing the demos and data with me and the rest of the community!!</p> </div> <div class="paragraph"> <p>In a just a few weeks I&#8217;ll be at <a href="http://www.developermarch.com/developersummit/">Great Indian Developer Summit</a> presenting these demos and much more! Stay tuned :)</p> </div> <div class="paragraph"> <p>Cheers,</p> </div> <div class="paragraph"> <p>Galder</p> </div> </div> </div> <a class="label" href="/blog/tags/conference/"> conference </a> <a class="label" href="/blog/tags/devoxx/"> devoxx </a> <a class="label" href="/blog/tags/demo/"> demo </a> <a class="label" href="/blog/tags/streams/"> streams </a> <a class="label" href="/blog/tags/query/"> query </a> <hr> <div class="post"></div> <h3> Tuesday, 06 December 2016 </h3> <h1> <a href="/blog/2016/12/06/distributed-stream-quality-of-life/">Distributed Stream Quality of Life Improvements</a> </h1> <div class="content"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>As I hope most people reading this already know, since Infinispan 8 you can utilize the entire Java 8 Stream API and have it be distributed across your cluster.  This performs the various intermediate and terminal operations on the data local to the node it lives on, providing for extreme performance.  There are some limitations and things to know as was explained at <a href="http://blog.infinispan.org/2015/09/distributed-streams.html">distributed-streams</a>.</p> </div> <div class="paragraph"> <p>The problem with the API up to now was that, if you wanted to use lambdas, it was quite an ugly scene.  Take for example the following code snippet:</p> </div> </div> </div> <div class="sect1"> <h2 id="_8_0_distributed_streams_example"><a class="anchor" href="#_8_0_distributed_streams_example"></a>8.0 Distributed Streams Example</h2> <div class="sectionbody"> <div class="paragraph"> <p>However, for Infinispan 9 we utilize a little syntax feature added with Java 8</p> </div> <div id="jls-15" class="paragraph oracle com/javase/specs/jls/se8/html/jls-15 html 12 2 5[1]"> <p>to add some much needed quality of life improvements.  This allows the most specific interface to be chosen when a method is overloaded.  This allows for a neat interaction when we add some new interfaces that implement Serializable and the various function interfaces (SerializableFunction, SerializablePredicate, SerializableSupplier, etc).  All of the Stream methods have been overridden on the <a href="https://docs.jboss.org/infinispan/9.0/apidocs/org/infinispan/CacheStream.html">CacheStream</a> interface to take these arguments.</p> </div> <div class="paragraph"> <p>This allows for the code to be much cleaner as we can see here:</p> </div> </div> </div> <div class="sect1"> <h2 id="_9_0_distributed_streams_example"><a class="anchor" href="#_9_0_distributed_streams_example"></a>9.0 Distributed Streams Example</h2> <div class="sectionbody"> <div class="paragraph"> <p>Extra Methods</p> </div> <div class="paragraph"> <p>This is not the only benefit of providing the <strong>CacheStream</strong> interface: we can also provide new methods that aren&#8217;t available on the standard <a href="https://docs.oracle.com/javase/8/docs/api/?java/util/stream/Stream.html">Stream</a> interface.  One example is the <a href="https://docs.jboss.org/infinispan/9.0/apidocs/org/infinispan/CacheStream.html#forEach-org.infinispan.util.function.SerializableBiConsumer-">forEach</a> method which allows the user to more easily provide a Cache that is injected on each node as required.  This way you don&#8217;t have to use the clumsy <a href="https://docs.jboss.org/infinispan/9.0/apidocs/org/infinispan/stream/CacheAware.html">CacheAware</a> interface and can directly use lambdas as desired.</p> </div> <div class="paragraph"> <p>Here is an example of the new <strong>forEach</strong> method in action:</p> </div> <div class="paragraph"> <p>In this example we take a cache and, based on the keys in it, write those values into another cache. Since <strong>forEach</strong> doesn&#8217;t have to be side effect free, you can do whatever you want inside here.</p> </div> <div class="paragraph"> <p>All in all these improvements should make using Distributed Streams with Infinispan much easier.  The extra methods could be extended further if users have use cases they would love to suggest.  Just let us know, and I hope you enjoy using Infinispan!</p> </div> </div> </div> </div> <a class="label" href="/blog/tags/9.0/"> 9.0 </a> <a class="label" href="/blog/tags/infinispan/"> infinispan </a> <a class="label" href="/blog/tags/streams/"> streams </a> <hr> <div class="post"></div> <h3> Monday, 01 February 2016 </h3> <h1> <a href="/blog/2016/02/01/infinispan-8-tour-video-available/">'Infinispan 8 Tour' video available</a> </h1> <div class="content"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p><a href="http://4.bp.blogspot.com/-Yk6ff5YQ220/VqF5PYfeW5I/AAAAAAAAAWo/J_F1SynbDyc/s1600/jbug.jpg"><span class="image"><img src="http://4.bp.blogspot.com/-Yk6ff5YQ220/VqF5PYfeW5I/AAAAAAAAAWo/J_F1SynbDyc/s320/jbug.jpg" alt="image" width="320" height="170"></span></a></p> </div> <div class="paragraph"> <p>The recording of the talk presented last Wednesday in London is available! Thanks to everyone who joined and to the London JBUG organizers for the awesome new venue!</p> </div> <div class="paragraph"> <p><a href="https://skillsmatter.com/skillscasts/7190-infinispan-8-tour" class="bare">https://skillsmatter.com/skillscasts/7190-infinispan-8-tour</a></p> </div> <div class="paragraph"> <p>Cheers, Gustavo</p> </div> </div> </div> </div> <a class="label" href="/blog/tags/functional/"> functional </a> <a class="label" href="/blog/tags/presentations/"> presentations </a> <a class="label" href="/blog/tags/spark/"> spark </a> <a class="label" href="/blog/tags/hadoop/"> hadoop </a> <a class="label" href="/blog/tags/infinispan 8/"> infinispan 8 </a> <a class="label" href="/blog/tags/streams/"> streams </a> <a class="label" href="/blog/tags/video/"> video </a> <hr> <div class="post"></div> <h3> Monday, 07 September 2015 </h3> <h1> <a href="/blog/2015/09/07/distributed-streams/">Distributed Streams</a> </h1> <div class="content"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>Now that Infinispan supports Java 8, we can take full advantage of some of the new features.  One of the big features of Java 8 is the new <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream</a> classes.  This flips the head on processing data so that instead of having to iterate upon the data yourself the underlying Stream handles that and you just provide the operations to perform on it.  This lends itself great to distributed processing as the iteration is handled entirely by the implementation (in this case Infinispan).</p> </div> <div class="paragraph"> <p>I therefore am glad to introduce for Infinispan 8, the feature Distributed Streams!  This allows for any operation you can perform on a regular Stream to also be performed on a Distributed cache (assuming the operation and data is <a href="http://infinispan.org/docs/8.0.x/user_guide/user_guide.html#_marshalling">marshallable</a>).</p> </div> </div> </div> <div class="sect1"> <h2 id="_marshallability"><a class="anchor" href="#_marshallability"></a>Marshallability</h2> <div class="sectionbody"> <div class="paragraph"> <p>When using a distributed or replicated cache, the keys and values of the cache must be marshallable.  This is the same case for intermediate and terminal operations when using the distributed streams.  Normally you would have to provide an instance of some new class that is either Serializable or has an Externalizer registered for it as described in the marshallable section of the user guide.</p> </div> <div class="paragraph"> <p>However, Java 8 also introduced lambdas, which can be defined as serializable very easily (although it is a bit awkward).  An example of this serialization can be found <a href="http://infinispan.org/tutorials/simple/streams/">here</a>.</p> </div> <div class="paragraph"> <p>Some of you may also be aware of the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collectors.html">Collectors</a> class which is used with the collect method on a stream.  Unfortunately, all of the Collectors produced are not able to be marshalled.  As such, Infinispan has added a <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/stream/CacheCollectors.html">utility class</a> that can work in conjunction with the Collectors class.  This allows you to still use any combination of the Collectors classes and still work properly when everything is required to be marshalled.</p> </div> </div> </div> <div class="sect1"> <h2 id="_parallelism"><a class="anchor" href="#_parallelism"></a>Parallelism</h2> <div class="sectionbody"> <div class="paragraph"> <p>Java 8 streams naturally have a sense of parallelism.  That is that the stream can be marked as being parallel.  This in turn allows for the operations to be performed in parallel using multiple threads.  The best part is how simple it is to do.  The stream can be made parallel when first retrieving it by invoking <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#parallelStream--">parallelStream</a> or you can optionally enable it after the Stream is retrieved by just invoking <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/BaseStream.html#parallel--">parallel</a>.</p> </div> <div class="paragraph"> <p>The new Distributed streams from Infinispan take this one step further, which I am calling parallel distribution.  That is that since data is already partitioned across nodes we can also allow operations to be ran simultaneously on different nodes at the same time.  This option is enabled by default.  However this can be controlled by using the new CacheStream interface discussed just below.  Also, to be clear, the Java 8 parallel can be used in conjunction with parallel distribution.  This just means you will have concurrent operations running on multiple nodes across multiple threads on each node.</p> </div> </div> </div> <div class="sect1"> <h2 id="_cachestream_interface"><a class="anchor" href="#_cachestream_interface"></a>CacheStream interface</h2> <div class="sectionbody"> <div class="paragraph"> <p>There is a new interface <a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/CacheStream.html">Cachestream</a> provided that allows for controlling additional options when using a Distributed Stream.  I am highlighting the added methods (note comments have been removed from gist)</p> </div> <div class="sect2"> <h3 id="_distributedbatchsize"><a class="anchor" href="#_distributedbatchsize"></a>distributedBatchSize</h3> <div class="paragraph"> <p>This method controls how many elements are brought back at one time for operations that are key aware.  These operations are (spl)iterator and forEach.  This is useful to tweak how many keys are held in memory from a remote node.  Thus it is a tradeoff of performance (more keys) versus memory.  This defaults to the chunk size as configured by state transfer.</p> </div> </div> <div class="sect2"> <h3 id="_paralleldistribution_sequentialdistribution"><a class="anchor" href="#_paralleldistribution_sequentialdistribution"></a>parallelDistribution / sequentialDistribution</h3> <div class="paragraph"> <p>This was discussed in the parallelism section above.  Note that all commands have this enabled by default except for spl(iterator) methods.</p> </div> </div> <div class="sect2"> <h3 id="_filterkeys"><a class="anchor" href="#_filterkeys"></a>filterKeys</h3> <div class="paragraph"> <p>This method can be used to have the distributed stream only operate on a given set of keys.  This is done in a very efficient way as it will only perform the operation on node(s) that own the given keys.  Using a given set of keys also allows for constant access time from the data container/store as the cache doesn&#8217;t have to look at every single entry in the cache.</p> </div> </div> <div class="sect2"> <h3 id="_filterkeysegments_advanced_users_only"><a class="anchor" href="#_filterkeysegments_advanced_users_only"></a>filterKeySegments (advanced users only)</h3> <div class="paragraph"> <p>This is useful to do filtering of instances in a more performant way.  Normally, you could use the filter intermediate operation, but this method is performed before any of the operations are performed to most efficiently limit the entries that are presented for stream processing.  For example, if only a subset of segments are required, it may not have to send a remote request.</p> </div> </div> <div class="sect2"> <h3 id="_segmentcompletionlistener_advanced_users_only"><a class="anchor" href="#_segmentcompletionlistener_advanced_users_only"></a>segmentCompletionListener (advanced users only)</h3> <div class="paragraph"> <p>Similar to the previous method, this is related to key segments.  This listener allows for the end user to be notified when a segment has been completed for processing.  This can be useful if you want to keep track of completion and if this node goes down, you can rerun the processing with only the unprocessed segments.  Currently, this listener is only supported for spl(iterator) methods.</p> </div> </div> <div class="sect2"> <h3 id="_disablerehashaware_advanced_users_only"><a class="anchor" href="#_disablerehashaware_advanced_users_only"></a>disableRehashAware (advanced users only)</h3> <div class="paragraph"> <p>By default, all stream operations are what is called rehash aware.  That is if a node joins or leaves the cluster while the operation is in progress the cluster will be aware of this and ensure that all data is processed properly with no loss (assuming no data was actually lost).</p> </div> <div class="paragraph"> <p>This can be disabled by calling disableRehashAware; however, if a rehash is to occur in the middle of the operation, it is possible that all data may not be processed.  It should be noted that data is not processed multiple times with this disabled, only a loss of data can occur.</p> </div> <div class="paragraph"> <p>This option is not normally recommended unless you have a situation where you can afford to only operate on a subset of data.  The tradeoff is that the operation can perform faster, especially (spl)iterator and forEach methods.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="_mapreduce"><a class="anchor" href="#_mapreduce"></a>Map/Reduce</h2> <div class="sectionbody"> <div class="paragraph"> <p>The age old example of map/reduce is always word count.  Streams allow you to do that as well!  Here is an equivalent word count example assuming you have a Cache containing String keys and values and you want the count of all words in the values.  Some of you may be wondering how this  relates to our existing map/reduce framework.  The plan is to deprecate the existing Map/Reduce and replace it completely with the new distributed streams at a later point.</p> </div> <div class="paragraph"> <p>Remember though that distributed streams can do so much more than just map/reduce. And there are a lot of examples already out there for streams. To use the distributed streams, you just need to make sure your operations are marshallable, and you are good to go.</p> </div> <div class="paragraph"> <p>Here are a few pages with examples of how to use streams straight from Oracle:</p> </div> <div class="paragraph"> <p><a href="http://www.oracle.com/technetwork/articles/java/ma14-java-se-8-streams-2177646.html" class="bare">http://www.oracle.com/technetwork/articles/java/ma14-java-se-8-streams-2177646.html</a> <a href="http://www.oracle.com/technetwork/articles/java/architect-streams-pt2-2227132.html" class="bare">http://www.oracle.com/technetwork/articles/java/architect-streams-pt2-2227132.html</a></p> </div> <div class="paragraph"> <p>I hope you enjoy Distributed Streams.  We hope they change how you interact with your data in the cluster!</p> </div> <div class="paragraph"> <p>Let us know what you think, any issues or usages you would love to share!</p> </div> <div class="paragraph"> <p>Cheers,</p> </div> <div class="paragraph"> <p>Will</p> </div> </div> </div> </div> <a class="label" href="/blog/tags/java 8/"> java 8 </a> <a class="label" href="/blog/tags/streams/"> streams </a> <a class="label" href="/blog/tags/API/"> API </a> <hr> <div class="pagination-links"><span class="current-page">1</span> </div> </div> <footer class="container"> <hr> <div class="row"> <div class="col-md-2 col-md-offset-1"> <h4>Navigate</h4> <ul> <li> <a href="/about" title="About">About</a> </li> <li> <a href="/documentation" title="Learn">Learn</a> </li> <li> <a href="/community" title="Community">Community</a> </li> <li> <a href="/getinvolved" title="Get Involved">Get Involved</a> </li> <li> <a href="/download" title="Download">Download</a> </li> </ul> </div> <div class="col-md-2"> <h4>Contribute</h4> <ul> <li> <a href="https://issues.jboss.org/browse/ISPN" title="Submit a bug">Submit a bug</a> </li> <li> <a href="https://github.com/infinispan" title="Write code">Write Code</a> </li> </ul> <h4>Follow Us</h4> <ul> <li> <a href="https://blog.infinispan.org" title="Blog">Blog</a> </li> <li> <a href="https://twitter.com/infinispan" title="Twitter">Twitter</a> </li> </ul> </div> <div class="col-md-2"> <h4>Open Source</h4> <p> Infinispan is released under the <b>Apache 2.0 open source license.</b> Learn more about the Apache 2.0 license <a href="https://www.apache.org/licenses/LICENSE-2.0">here.</a> </p> </div> <div class="col-md-2"> <h4>A member of</h4> <a alt="CloudTM" href="http://www.cloudtm.eu/" target="_NEW"> <img src="/images/cloudtm.png"> </a> <a alt="LEADS" href="http://leads-project.eu/" target="_NEW"> <img src="/images/leads.png"> </a> <a alt="CloudButton" href="http://cloudbutton.eu/" target="_NEW"> <img src="/images/cloudbutton.png"> </a> </div> <div class="col-md-2"> <h4>Thanks to</h4> <p>JetBrains Intellij IDEA</p> <a alt="JetBrains Intellij IDEA" href="https://www.jetbrains.com/idea/" target="_NEW"> <img src="/images/icon_IntelliJIDEA.png"> </a> </div> </div> <div class="col-md-10"> <p style="margin-top: 5px; font-size: 80%;"> © Copyright 2009-2019 Red Hat, Inc. <br> <i class="icon-fire"></i> Made with <a href="https://github.com/jbossorg/bootstrap-community" style="text-decoration: underline;" target="_NEW">JBoss Community Bootstrap</a> and <a href="http://awestruct.org/" style="text-decoration: underline;" target="_NEW">Awestruct</a> <br> <i class="icon-globe"></i> This website is open source! If you want to improve it, <a href="https://github.com/infinispan/infinispan.github.io" style="text-decoration: underline;" target="_NEW">fork the project,</a> and hack on it, then send a pull request. You can also view the <a href="https://www.seethestats.com/site/infinispan.org" style="text-decoration: underline;" target="_NEW">visitor stats.</a> <br> <i class="icon-share"></i> Website and documentation released under <a href="https://creativecommons.org/licenses/by/3.0/" style="text-decoration: underline;" target="_NEW">CC BY 3.0.</a> </p> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="http://www.redhat.com/"><img src="//static.jboss.org/theme/images/common/redhat_logo.png"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="//static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script>
        if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
          _satellite.pageBottom();
        }
      </script> </div> </body> </html>