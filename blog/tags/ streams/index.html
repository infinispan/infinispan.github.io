<!DOCTYPE html> <html lang="en"> <head> <title> Blog - Infinispan</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="DENY" http-equiv="X-Frame-Options"> <meta content="1; mode=block" http-equiv="X-XSS-Protection"> <meta content="nosniff" http-equiv="X-Content-Type-Options"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" rel="stylesheet"> <script crossorigin="anonymous" src="https://kit.fontawesome.com/4167a38cfa.js"></script> <script id="dpal" src="https://www.redhat.com/dtm.js" type="text/javascript"></script> <link href="/images/favicon.png" rel="shortcut icon" type="image/png"> <link href="//static.jboss.org/images/example/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="//static.jboss.org/images/example/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="//static.jboss.org/images/example/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="//static.jboss.org/images/example/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css" rel="stylesheet"> <link href="https://static.jboss.org/css/rhbar.css" media="screen" rel="stylesheet"> <link href="/feed.atom" rel="alternate" type="application/atom+xml"> <style>
      .jumbotron {
        padding: 0.5em 0.1em 0.5em 0.1em;
        background-image: none;
        background-color: #ffec9f;
      }
      .jumbotron p, 
      .jumbotron h1 {
        color: #656565;
      }
      .dropup {
        z-index: 1032;
      }
      .navbar {
        font-size: x-large;
      }
      .navbar ul {
        padding-top: 0.7em;
      }
      .navbar-brand {
        height: 80px;
      }
      .navbar-default {
        background-color: white;
      }
      .navbar-default .navbar-nav > li > a {
        color: #336699;
      }
      .navbar-default .navbar-nav > li > a:hover {
        color: #204060;
      }
      .navbar-default .navbar-nav > .open > a,
      .navbar-default .navbar-nav > .open > a:hover,
      .navbar-default .navbar-nav > .open > a:focus {
        background-color: #4a5d75;
      }
      h3.well {
        border-color: #ffd630;
        background-color: #ffec9f;
      }
      .panel-sidebar {
        border-color: #f5f5f5;
      }
      .panel-sidebar > .panel-heading {
        border-color: #e3e3e3;
        background-color: #f5f5f5;
        color: #656565;
      }
      .btn-primary {
        border-color: #ffd630;
        background-color: #ffec9f;
        color: #656565;
      }
      footer.container {
        background-color: white;
      }
      footer.container h1, footer.container h2, footer.container h3, footer.container h4, footer.container h5, footer.container h6, footer.container p, footer.container a {
        color: #656565;
      }
      footer.container ul {
        padding: 0;
      }
      i.enormous-icon {
        margin-top: 0.3em;
      }
      .home-examples {
        font-size: 16px;
      }
    </style> <script src="//static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script> <script>
      hljs.initHighlightingOnLoad();
    </script> <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     
    ga('create', 'UA-8601422-1', 'auto');
    ga('send', 'pageview');
    
    </script> </head> <body> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div id="rhbar"> <a class="jbdevlogo" href="http://www.jboss.org/projects/about"></a> <a class="rhlogo" href="http://www.redhat.com/"></a> </div> <div class="container" id="content"> <nav class="navbar navbar-default navbar-fixed-top"> <div class="container"> <div class="navbar-header"> <button aria-expanded="false" class="navbar-toggle collapsed" data-target="#thenavbar" data-toggle="collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img alt="Infinispan" src="/images/infinispan_nav_brand.png"> </a> </div> <div class="navbar-collapse collapse" id="thenavbar"> <ul class="nav navbar-nav"> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/about">About <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/about">Introduction</a></li> <li><a href="/features">Features</a></li> <li><a href="/release-notes">Release notes</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/references">References</a></li> <li><a href="/experiments/">Experiments</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/documentation">Learn <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/documentation">Documentation</a></li> <li><a href="/tutorials">Tutorials</a></li> <li><a href="/videos">Videos</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/download">Download <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/download">Infinispan Releases</a></li> <li><a href="/cache-store-implementations">Cache Store Implementations</a></li> <li><a href="/hotrod-clients">Hot Rod Clients</a></li> <li><a href="/integrations">Integrations</a></li> <li><a href="/download-archive">Archive</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/community">Community <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/community">Ask for Help</a></li> <li><a href="/getinvolved">Get Involved</a></li> </ul> </li> <li class=""><a href="/roadmap">Road Map</a></li> <li class="divider"></li> </ul> </div> </div> </nav> <div class="post"></div> <h3> Tuesday, 02 October 2018 </h3> <h1> <a href="/blog/2018/10/02/segmented-data-containers-distributed/">Segmented Data Containers: Distributed Stream Performance Boost</a> </h1> <div class="content"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>Welcome to the first of several blog posts that describe the segmentation of containers that Infinispan uses to store data. Some of you may have noticed in the previous <a href="https://blog.infinispan.org/2018/06/infinispan-930final-is-out.html">9.3.0.Final notes</a> that we announced a new feature named “Segmented On-Heap Data Container”. We also mentioned that “It improves performance of stream operations”, but what does that really mean?</p> </div> </div> </div> <div class="sect1"> <h2 id="_what_is_a_segmented_data_container_and_why_does_it_matter"><a class="anchor" href="#_what_is_a_segmented_data_container_and_why_does_it_matter"></a>What is a segmented data container and why does it matter? </h2> <div class="sectionbody"> <div class="paragraph"> <p>Imagine a cluster of 4 nodes in distributed mode (numOwners = 2) with entries for k0 - k13. It might look like this:</p> </div> <div class="paragraph"> <p><a href="https://2.bp.blogspot.com/-5FopP39_Z6k/W7O94C_HrAI/AAAAAAAAeDM/xWnwzer_RP8gQBlZvDI5MOY-Qroof7S_gCLcBGAs/s1600/NonSegmentedData.jpg"><span class="image"><img src="https://2.bp.blogspot.com/-5FopP39_Z6k/W7O94C_HrAI/AAAAAAAAeDM/xWnwzer_RP8gQBlZvDI5MOY-Qroof7S_gCLcBGAs/s640/NonSegmentedData.jpg" alt="image" width="640" height="568"></span></a></p> </div> <div class="paragraph"> <p>The data is distributed between the nodes with only two copies of each entry available. However, the data itself is stored internally in the same Map instance. As a result, when performing operations on all entries in the cache, Infinispan must iterate over the same data multiple times. This degrades performance.</p> </div> <div class="paragraph"> <p>As of Infinispan 9.3, a segmented data container is available to separate data by segments. Although only on-heap bounded and unbounded implementations are currently available.</p> </div> <div class="paragraph"> <p>With a segmented data container, that same data set might look like this:</p> </div> <div class="paragraph"> <p><a href="https://2.bp.blogspot.com/-7S1k7hNmrHI/W7O99geUbkI/AAAAAAAAeDQ/k5tbJq0w22ovQxpNG2uXcMIV63HIvz4MQCLcBGAs/s1600/SegmentedData.jpg"><span class="image"><img src="https://2.bp.blogspot.com/-7S1k7hNmrHI/W7O99geUbkI/AAAAAAAAeDQ/k5tbJq0w22ovQxpNG2uXcMIV63HIvz4MQCLcBGAs/s640/SegmentedData.jpg" alt="image" width="640" height="562"></span></a></p> </div> <div class="paragraph"> <p>Because Infinispan internally reasons on data in terms of segments, a segmented data container lets Infinispan process data only in specific segments. This allows for operations performed upon all entries to require iteration over the data only once.</p> </div> </div> </div> <div class="sect1"> <h2 id="_actual_performance_difference"><a class="anchor" href="#_actual_performance_difference"></a>Actual Performance Difference</h2> <div class="sectionbody"> <div class="paragraph"> <p>So with the above example you might be thinking that the performance increase maximum is two times throughput, since numOwners is two. This is close, but not quite correct. While iterating on the data we also have to determine what segment an entry belongs to. With a segmented container we know this already, so there is no need to calculate that. This provides additional performance, as you will see.</p> </div> <div class="paragraph"> <p>The following graphs were generated using the benchmark at <a href="https://github.com/infinispan/infinispan-benchmarks/tree/master/iteration" class="bare">https://github.com/infinispan/infinispan-benchmarks/tree/master/iteration</a>. The following command was run: <strong>java -jar target/benchmarks.jar -pvalueObjectSize=1000 -pentryAmount=50000 -pbatchSize=4096</strong></p> </div> <div class="paragraph"> <p><strong><span id="docs-internal-guid-9b20945e-7fff-7241-2261-95b975ba8902"><span class="image"><img src="https://lh6.googleusercontent.com/XMXQWsWISdPTt-93vLV5RgnJld-ASxkiWaXDZ-O1guXkoe87fYj1Ra2mlQHfcnTmVlXKNTZhk5T095pL99PjqlHgCbqlpFLyvQoTSBarR65wO275T7syowLSBxZl8syWKSYF9H43" alt="image" width="624" height="385" title="Chart"></span></span></strong></p> </div> <div class="paragraph"> <p>The preceding graph is the result of the iteration methods. As you can notice the performance increase isn’t that much… why not?!?</p> </div> <div class="paragraph"> <p>Unfortunately, remote iteration requires a lot of network overhead, so we don’t get to see the full benefits of segmentation. But at least it is about 5-12% faster, not too shabby.</p> </div> <div class="paragraph"> <p>Now to show the real improvement, here is the chart showing the performance increase for the Cache#size operation:</p> </div> <div class="paragraph"> <p><span id="docs-internal-guid-413b551a-7fff-9931-559d-9fda906ad6b1"><span class="image"><img src="https://lh6.googleusercontent.com/HHbRs5_4t4jE_7j8l3ArlsuPCgFXjh7zZXLGJXo3e9LLOP-matr7qTGzLiH8RpW9at1IimMrtC-LNKSsQmAujhMjVXxj31ruTGfEHeP9J-rTpUIFo0WjoyY_NCezBD6WtUj2NVgy" alt="image" width="624" height="385" title="Chart"></span></span></p> </div> <div class="paragraph"> <p>If you notice there is <strong>huge</strong> increase in performance: almost a three fold increase over the non-segmented container, even though numOwners is only two. The old segment calculation adds a bit of overhead compared to just incrementing a number.</p> </div> <div class="paragraph"> <p>So keep in mind this change will show a larger gain in performance if the result returned is smaller, especially if it is a fixed size, such as a single int for Cache#size.</p> </div> </div> </div> <div class="sect1"> <h2 id="_what_about_gets_and_puts"><a class="anchor" href="#_what_about_gets_and_puts"></a>What about gets and puts?</h2> <div class="sectionbody"> <div class="paragraph"> <p>Having the container segmented should also affect get and put performance as well, right? In testing the difference for get and puts are less than one percent, in favor of segmentation due to some optimizations we were able to add.</p> </div> </div> </div> <div class="sect1"> <h2 id="_how_do_i_enable_this"><a class="anchor" href="#_how_do_i_enable_this"></a>How do I enable this?</h2> <div class="sectionbody"> <div class="paragraph"> <p>So the performance gains are noticeable, especially when the remote operation returns a small data set. But how can a user configure this? This is the nice part, due to no performance loss with other operations the container will always be segmented as long as the cache mode supports segmentation. That is if it is a Distributed, Replicated or Scattered cache.</p> </div> </div> </div> <div class="sect1"> <h2 id="_a_real_life_example_and_closing"><a class="anchor" href="#_a_real_life_example_and_closing"></a>A real-life example and closing</h2> <div class="sectionbody"> <div class="paragraph"> <p>Since this feature has been around a while already, we actually have users gaining benefits from this feature. An example can be found at <a href="https://developer.jboss.org/message/983837#983837" class="bare">https://developer.jboss.org/message/983837#983837</a>. In this case the user only upgraded to Infinispan 9.3 and received over a three-fold increase in performance when using distributed streams. It actually starts to bring distributed streams performance within range of indexed query for some use cases.</p> </div> <div class="paragraph"> <p>So, by upgrading your application to Infinispan 9.3 or newer, you will benefit from these improvements. There will be future posts regarding segmentation, including support for stores. Either way please feel free to <a href="http://infinispan.org/download/">download Infinispan</a>, <a href="https://issues.jboss.org/projects/ISPN">report bugs</a>, <a href="https://infinispan.zulipchat.com/">chat with us</a>, ask questions on the <a href="https://developer.jboss.org/en/infinispan/content">forum</a> or on <a href="https://stackoverflow.com/questions/tagged/?tagnames=infinispan&amp;sort=newest">StackOverflow</a>.</p> </div> </div> </div> </div> <em>Posted by Unknown on 2018-10-02</em> <br> <em>Tags:</em> <a href="/blog/tags/ streams/"> streams </a> <a href="/blog/tags/segmented/"> segmented </a> <a href="/blog/tags/data container/"> data container </a> <a href="/blog/tags/performance/"> performance </a> <hr> <div class="post"></div> <h3> Monday, 08 January 2018 </h3> <h1> <a href="/blog/2018/01/08/improving-collect-for-distributed-java/">Improving collect() for distributed Java Streams in Infinispan 9.2</a> </h1> <div class="content"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>As we progress with the release of Infinispan 9.2 pre-releases, it&#8217;s important to highlight some of the more interesting improvements from an end-user perspective.</p> </div> <div class="paragraph"> <p>As mentioned <a href="http://blog.infinispan.org/2017/05/reactive-big-data-on-openshift-in.html">before</a>, <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#streams">Infinispan Distributed Java Streams</a> can be used to calculate analytics over existing data. Through overloading of methods, Infinispan is able to offer a simple way of passing lambdas that are made to be Serializable without the need of explicit casting. Being able to produce binary formats for the lambdas is an important step for java streams executions to be distributed. In this example, the cached values are being filtered to find those that have a delay bigger than 0. This lambda can be safely distributed without the need to cast to Serializable because values().stream() returns org.infinispan.CacheStream that overloads filter to take a SerializablePredicate:</p> </div> <div class="paragraph"> <p>Cache&lt;String, Stop&gt; cache = &#8230;&#8203; cache.values().stream()   .filter(e &#8594; e.delayMin &gt; 0);</p> </div> <div class="paragraph"> <p>However, there was one area which was still a bit clunky to use: Java Collectors. When Java Streams came out, the JDK provided a class called java.util.stream.Collectors which includes a lot of helper methods for collecting results after stream processing. The problem with the Collector instances returned by the helper methods is that they&#8217;re not Serializable.</p> </div> <div class="paragraph"> <p>Before Infinispan 9.2, we worked around this problem with the help of org.infinispan.stream.CacheCollectors which defined a serializableCollector method that took a SerializableSupplier&lt;Collector&lt;T, ?, R&gt;&gt;. The aim here was this: even if the Collector instance is not Serializable, the function that creates the Collector can be made to be Serializable. It could be used this way:</p> </div> <div class="paragraph"> <p>Cache&lt;String, Stop&gt; cache = &#8230;&#8203; cache.values().stream().collect(   CacheCollectors.serializableCollector) &#8594; Collectors.groupingBy(       e &#8594; getHourOfDay(e.departureTs),       Collectors.counting());</p> </div> <div class="paragraph"> <p>Although this worked, it was a clunky, so in Infinispan 9.2 we overloaded collect() in org.infinispan.CacheStream to take SerializableSupplier&lt;Collector&lt;T, ?, R&gt;&gt;. This means that in Infinispan 9.2, the code above can be written like this instead:</p> </div> <div class="paragraph"> <p>Cache&lt;String, Stop&gt; cache = &#8230;&#8203; cache.values().stream().collect(   () &#8594; Collectors.groupingBy(       e &#8594; getHourOfDay(e.departureTs),       Collectors.counting() ));</p> </div> <div class="paragraph"> <p>This is a cleaner way of making sure Collector instances returned by java.util.stream.Collectors can be distributed.</p> </div> <div class="paragraph"> <p>Cheers, Galder</p> </div> </div> </div> </div> <em>Posted by Galder Zamarreño on 2018-01-08</em> <br> <em>Tags:</em> <a href="/blog/tags/ streams/"> streams </a> <hr> <div class="pagination-links"><span class="current-page">1</span> </div> </div> <footer class="container"> <hr> <div class="row"> <div class="col-md-2 col-md-offset-1"> <h4>Navigate</h4> <ul> <li> <a href="/about" title="About">About</a> </li> <li> <a href="/documentation" title="Learn">Learn</a> </li> <li> <a href="/community" title="Community">Community</a> </li> <li> <a href="/getinvolved" title="Get Involved">Get Involved</a> </li> <li> <a href="/download" title="Download">Download</a> </li> </ul> </div> <div class="col-md-2"> <h4>Contribute</h4> <ul> <li> <a href="https://issues.jboss.org/browse/ISPN" title="Submit a bug">Submit a bug</a> </li> <li> <a href="https://github.com/infinispan" title="Write code">Write Code</a> </li> </ul> <h4>Follow Us</h4> <ul> <li> <a href="https://infinispan.org/blog/" title="Blog">Blog</a> </li> <li> <a href="https://twitter.com/infinispan" title="Twitter">Twitter</a> </li> </ul> </div> <div class="col-md-2"> <h4>Open Source</h4> <p> Infinispan is released under the <b>Apache 2.0 open source license.</b> Learn more about the Apache 2.0 license <a href="https://www.apache.org/licenses/LICENSE-2.0">here.</a> </p> </div> <div class="col-md-2"> <h4>A member of</h4> <a alt="CloudTM" href="http://www.cloudtm.eu/" target="_NEW"> <img src="/images/cloudtm.png"> </a> <a alt="LEADS" href="http://leads-project.eu/" target="_NEW"> <img src="/images/leads.png"> </a> <a alt="CloudButton" href="http://cloudbutton.eu/" target="_NEW"> <img src="/images/cloudbutton.png"> </a> </div> <div class="col-md-2"> <h4>Thanks to</h4> <p>JetBrains Intellij IDEA</p> <a alt="JetBrains Intellij IDEA" href="https://www.jetbrains.com/idea/" target="_NEW"> <img src="/images/icon_IntelliJIDEA.png"> </a> </div> </div> <div class="col-md-10"> <p style="margin-top: 5px; font-size: 80%;"> © Copyright 2009-2019 Red Hat, Inc. <br> <i class="icon-fire"></i> Made with <a href="https://github.com/jbossorg/bootstrap-community" style="text-decoration: underline;" target="_NEW">JBoss Community Bootstrap</a> and <a href="http://awestruct.org/" style="text-decoration: underline;" target="_NEW">Awestruct</a> <br> <i class="icon-globe"></i> This website is open source! If you want to improve it, <a href="https://github.com/infinispan/infinispan.github.io" style="text-decoration: underline;" target="_NEW">fork the project,</a> and hack on it, then send a pull request. You can also view the <a href="https://www.seethestats.com/site/infinispan.org" style="text-decoration: underline;" target="_NEW">visitor stats.</a> <br> <i class="icon-share"></i> Website and documentation released under <a href="https://creativecommons.org/licenses/by/3.0/" style="text-decoration: underline;" target="_NEW">CC BY 3.0.</a> </p> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="http://www.redhat.com/"><img src="//static.jboss.org/theme/images/common/redhat_logo.png"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="//static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script>
        if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
          _satellite.pageBottom();
        }
      </script> </div> </body> </html>