<!DOCTYPE html> <html lang="en"> <head> <title>Blog: OpenShift and Node Affinity - Infinispan</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="DENY" http-equiv="X-Frame-Options"> <meta content="1; mode=block" http-equiv="X-XSS-Protection"> <meta content="nosniff" http-equiv="X-Content-Type-Options"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" rel="stylesheet"> <script crossorigin="anonymous" src="https://kit.fontawesome.com/4167a38cfa.js"></script> <script id="dpal" src="https://www.redhat.com/dtm.js" type="text/javascript"></script> <link href="/images/favicon.png" rel="shortcut icon" type="image/png"> <link href="//static.jboss.org/images/example/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="//static.jboss.org/images/example/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="//static.jboss.org/images/example/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="//static.jboss.org/images/example/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css" rel="stylesheet"> <link href="https://static.jboss.org/css/rhbar.css" media="screen" rel="stylesheet"> <link href="/feed.atom" rel="alternate" type="application/atom+xml"> <style>
      .jumbotron {
        padding: 0.5em 0.1em 0.5em 0.1em;
        background-image: none;
        background-color: #ffec9f;
      }
      .jumbotron p, 
      .jumbotron h1 {
        color: #656565;
      }
      .dropup {
        z-index: 1032;
      }
      .navbar {
        font-size: x-large;
      }
      .navbar ul {
        padding-top: 0.7em;
      }
      .navbar-brand {
        height: 80px;
      }
      .navbar-default {
        background-color: white;
      }
      .navbar-default .navbar-nav > li > a {
        color: #336699;
      }
      .navbar-default .navbar-nav > li > a:hover {
        color: #204060;
      }
      .navbar-default .navbar-nav > .open > a,
      .navbar-default .navbar-nav > .open > a:hover,
      .navbar-default .navbar-nav > .open > a:focus {
        background-color: #4a5d75;
      }
      h3.well {
        border-color: #ffd630;
        background-color: #ffec9f;
      }
      .panel-sidebar {
        border-color: #f5f5f5;
      }
      .panel-sidebar > .panel-heading {
        border-color: #e3e3e3;
        background-color: #f5f5f5;
        color: #656565;
      }
      .btn-primary {
        border-color: #ffd630;
        background-color: #ffec9f;
        color: #656565;
      }
      footer.container {
        background-color: white;
      }
      footer.container h1, footer.container h2, footer.container h3, footer.container h4, footer.container h5, footer.container h6, footer.container p, footer.container a {
        color: #656565;
      }
      footer.container ul {
        padding: 0;
      }
      i.enormous-icon {
        margin-top: 0.3em;
      }
      .home-examples {
        font-size: 16px;
      }
    </style> <script src="//static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script> <script>
      hljs.initHighlightingOnLoad();
    </script> <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     
    ga('create', 'UA-8601422-1', 'auto');
    ga('send', 'pageview');
    
    </script> </head> <body> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div id="rhbar"> <a class="jbdevlogo" href="http://www.jboss.org/projects/about"></a> <a class="rhlogo" href="http://www.redhat.com/"></a> </div> <div class="container" id="content"> <nav class="navbar navbar-default navbar-fixed-top"> <div class="container"> <div class="navbar-header"> <button aria-expanded="false" class="navbar-toggle collapsed" data-target="#thenavbar" data-toggle="collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img alt="Infinispan" src="/images/infinispan_nav_brand.png"> </a> </div> <div class="navbar-collapse collapse" id="thenavbar"> <ul class="nav navbar-nav"> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/about">About <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/about">Introduction</a></li> <li><a href="/features">Features</a></li> <li><a href="/release-notes">Release notes</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/references">References</a></li> <li><a href="/experiments/">Experiments</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/documentation">Learn <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/documentation">Documentation</a></li> <li><a href="/tutorials">Tutorials</a></li> <li><a href="/videos">Videos</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/download">Download <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/download">Infinispan Releases</a></li> <li><a href="/cache-store-implementations">Cache Store Implementations</a></li> <li><a href="/hotrod-clients">Hot Rod Clients</a></li> <li><a href="/integrations">Integrations</a></li> <li><a href="/download-archive">Archive</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/community">Community <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/community">Ask for Help</a></li> <li><a href="/getinvolved">Get Involved</a></li> </ul> </li> <li class=""><a href="/roadmap">Road Map</a></li> <li class="divider"></li> </ul> </div> </div> </nav> <ul class="breadcrumb"> <li> <a href="/blog">Blog</a> <span class="divider"></span> </li> <li class="active"> OpenShift and Node Affinity</li> </ul> <h3></h3> <h1>OpenShift and Node Affinity</h1> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>OpenShift (and Kubernetes) has a great feature called <a href="https://docs.openshift.org/latest/admin_guide/scheduler.html#affinity">Affinity</a>. In some scenarios, it might be beneficial to configure it along with <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#ServerHinting">Infinispan node affinity</a>.</p> </div> <div class="paragraph"> <p>Before we start&#8230;&#8203; this tutorial is heavily based on our <a href="http://blog.infinispan.org/2016/08/running-infinispan-cluster-on-openshift.html">previous blog post about deploying Infinispan on Openshift</a> and OpenShift <a href="https://docs.openshift.org/latest/admin_guide/scheduler.html">Scheduler functionality</a>. It is highly recommended to read those articles before continuing this tutorial.</p> </div> </div> </div> <div class="sect1"> <h2 id="_how_does_the_affinity_feature_work_in_short"><a class="anchor" href="#_how_does_the_affinity_feature_work_in_short"></a>How does the Affinity feature work&#8230;&#8203; in short?</h2> <div class="sectionbody"> <div class="paragraph"> <p>In order to decide on which node given Pod should be running, OpenShift looks at so called <a href="https://docs.openshift.org/latest/admin_guide/scheduler.html#configurable-predicates">Predicates</a> and <a href="https://docs.openshift.org/latest/admin_guide/scheduler.html#available-priority-functions">Priority Functions</a>. A predicate must match the one configured in <em>DeploymentConfiguration</em> and Priority Function is responsible for choosing the best node for running Pods.</p> </div> <div class="paragraph"> <p>Let&#8217;s assume that we have a sample policy (similar to <a href="https://docs.openshift.org/latest/admin_guide/scheduler.html#scheduler-sample-policies">one provided in OpenShift manual</a>), that uses <em>site</em> as a Predicate along with <em>rack and machine</em> as Priority Functions. Now let&#8217;s assume we have two nodes:</p> </div> <div class="ulist"> <ul> <li> <p>Node 1 - site=EU, rack=R1, machine=VM1</p> </li> <li> <p>Node 2 - site=US, rack=R2, machine=VM2</p> </li> </ul> </div> <div class="paragraph"> <p>And two DeploymentConfiguration with Node Selectors (this tells OpenShift on which nodes given <em>DeploymentConfiguration</em> wishes to run) defined as follows:</p> </div> <div class="ulist"> <ul> <li> <p>DeploymentConfiguration 1 - site=EU, rack=R5, machine=VM5</p> </li> <li> <p>DeploymentConfiguration 2 - site=JAP, rack=R5, machine=VM5</p> </li> </ul> </div> <div class="paragraph"> <p>With the above example only DeploymentConfiguration 1 will be scheduled (on Node 1), since <em>site</em> matches the predicate. In this case <em>rack</em> and <em>machine</em> parameters are not used (because we have only one node).</p> </div> <div class="paragraph"> <p>Note that the default OpenShift&#8217;s configuration uses <em>region</em> (as a Predicate) and <em>zone</em> (as a Priority Function). However it can be reconfigured <a href="https://docs.openshift.org/latest/admin_guide/scheduler.html">very easily</a>. </p> </div> <div class="paragraph"> <p>==</p> </div> </div> </div> <div class="sect1"> <h2 id="_and_i_need_it_because"><a class="anchor" href="#_and_i_need_it_because"></a>And I need it because&#8230;&#8203;.</h2> <div class="sectionbody"> <div class="paragraph"> <p>Some OpenShift deployments might span multiple racks in a data center or even multiple sites. It is important to tell Infinispan where physical machines are located, which will allow to choose better nodes for backing up your data (in distribution mode). </p> </div> <div class="paragraph"> <p>As the matter of fact, Infinispan uses <em>site</em>, <em>rack</em> and <em>machine</em>. The main goal is to avoid backing up data on the same host<em>.</em></p> </div> <div class="paragraph"> <p>===</p> </div> <div class="sect2"> <h3 id="_the_implementation"><a class="anchor" href="#_the_implementation"></a>The implementation</h3> <div class="paragraph"> <p>The implementation is pretty straightforward but there are several gotchas. </p> </div> <div class="paragraph"> <p>The first one is that OpenShift uses <em>regions</em> and <em>zones</em> by default and Infinispan uses <em>sites</em>, <em>racks</em> and <em>machines</em>. The good news is that all those three are optional, so you have two options - reuse existing <em>region</em> and <em>zone</em> (map them to rack and site for example)<em>,</em> or adjust OpenShift scheduler settings. In my example I used the former approach.</p> </div> <div class="paragraph"> <p>The second one is the need of hardcoding those parameters into <em>DeploymentConfiguration</em>. Unfortunately Node Selectors are not exposed through <a href="http://kubernetes.io/docs/user-guide/downward-api/">Downward API</a>, so there&#8217;s no other way.</p> </div> <div class="paragraph"> <p>So let&#8217;s have a look at our DeploymentConfiguration:</p> </div> <div class="ulist"> <ul> <li> <p>Line 26 - Zone <em>default</em> used as a rack</p> </li> <li> <p>Line 27 - Region <em>primary</em> used as a site</p> </li> <li> <p>Lines 57 - 59 - Node Selector for scheduling Pods</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="_conclusion"><a class="anchor" href="#_conclusion"></a>Conclusion</h3> <div class="paragraph"> <p>Combining OpenShift Affinity Service and Infinispan Server Hinting allows to optimize data distribution across the cluster. Keep in mind that your configuration might be totally different (OpenShift Scheduler is a highly configurable thing). But once you understand how it works, you can adjust the hinting strategy for your needs. </p> </div> <div class="paragraph"> <p>Happy Scaling!</p> </div> </div> </div> </div> <em>Posted by Sebastian Łaskawiec on 2016-10-13</em> <br> <em>Tags:</em> <a href="/blog/tags/openshift/"> openshift </a> <a href="/blog/tags/affinity/"> affinity </a> </div> <footer class="container"> <hr> <div class="row"> <div class="col-md-2 col-md-offset-1"> <h4>Navigate</h4> <ul> <li> <a href="/about" title="About">About</a> </li> <li> <a href="/documentation" title="Learn">Learn</a> </li> <li> <a href="/community" title="Community">Community</a> </li> <li> <a href="/getinvolved" title="Get Involved">Get Involved</a> </li> <li> <a href="/download" title="Download">Download</a> </li> </ul> </div> <div class="col-md-2"> <h4>Contribute</h4> <ul> <li> <a href="https://issues.jboss.org/browse/ISPN" title="Submit a bug">Submit a bug</a> </li> <li> <a href="https://github.com/infinispan" title="Write code">Write Code</a> </li> </ul> <h4>Follow Us</h4> <ul> <li> <a href="https://blog.infinispan.org" title="Blog">Blog</a> </li> <li> <a href="https://twitter.com/infinispan" title="Twitter">Twitter</a> </li> </ul> </div> <div class="col-md-2"> <h4>Open Source</h4> <p> Infinispan is released under the <b>Apache 2.0 open source license.</b> Learn more about the Apache 2.0 license <a href="https://www.apache.org/licenses/LICENSE-2.0">here.</a> </p> </div> <div class="col-md-2"> <h4>A member of</h4> <a alt="CloudTM" href="http://www.cloudtm.eu/" target="_NEW"> <img src="/images/cloudtm.png"> </a> <a alt="LEADS" href="http://leads-project.eu/" target="_NEW"> <img src="/images/leads.png"> </a> <a alt="CloudButton" href="http://cloudbutton.eu/" target="_NEW"> <img src="/images/cloudbutton.png"> </a> </div> <div class="col-md-2"> <h4>Thanks to</h4> <p>JetBrains Intellij IDEA</p> <a alt="JetBrains Intellij IDEA" href="https://www.jetbrains.com/idea/" target="_NEW"> <img src="/images/icon_IntelliJIDEA.png"> </a> </div> </div> <div class="col-md-10"> <p style="margin-top: 5px; font-size: 80%;"> © Copyright 2009-2019 Red Hat, Inc. <br> <i class="icon-fire"></i> Made with <a href="https://github.com/jbossorg/bootstrap-community" style="text-decoration: underline;" target="_NEW">JBoss Community Bootstrap</a> and <a href="http://awestruct.org/" style="text-decoration: underline;" target="_NEW">Awestruct</a> <br> <i class="icon-globe"></i> This website is open source! If you want to improve it, <a href="https://github.com/infinispan/infinispan.github.io" style="text-decoration: underline;" target="_NEW">fork the project,</a> and hack on it, then send a pull request. You can also view the <a href="https://www.seethestats.com/site/infinispan.org" style="text-decoration: underline;" target="_NEW">visitor stats.</a> <br> <i class="icon-share"></i> Website and documentation released under <a href="https://creativecommons.org/licenses/by/3.0/" style="text-decoration: underline;" target="_NEW">CC BY 3.0.</a> </p> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="http://www.redhat.com/"><img src="//static.jboss.org/theme/images/common/redhat_logo.png"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="//static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script>
        if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
          _satellite.pageBottom();
        }
      </script> </div> </body> </html>