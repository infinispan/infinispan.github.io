<!DOCTYPE html> <html lang="en"> <head> <title>Functional Map API&#58; Working with single entries - Infinispan</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="DENY" http-equiv="X-Frame-Options"> <meta content="1; mode=block" http-equiv="X-XSS-Protection"> <meta content="nosniff" http-equiv="X-Content-Type-Options"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" rel="stylesheet"> <script id="dpal" src="https://www.redhat.com/dtm.js" type="text/javascript"></script> <link href="/images/favicon.png" rel="shortcut icon" type="image/png"> <link href="//static.jboss.org/images/example/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="//static.jboss.org/images/example/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="//static.jboss.org/images/example/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="//static.jboss.org/images/example/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css" rel="stylesheet"> <link href="https://static.jboss.org/css/rhbar.css" media="screen" rel="stylesheet"> <style>
      .jumbotron {
        padding: 0.5em 0.1em 0.5em 0.1em;
        background-image: none;
        background-color: #ffec9f;
      }
      .jumbotron p, 
      .jumbotron h1 {
        color: #656565;
      }
      .dropup {
        z-index: 1032;
      }
      .navbar {
        font-size: x-large;
      }
      .navbar ul {
        padding-top: 0.7em;
      }
      .navbar-brand {
        height: 80px;
      }
      .navbar-default {
        background-color: white;
      }
      .navbar-default .navbar-nav > li > a {
        color: #336699;
      }
      .navbar-default .navbar-nav > li > a:hover {
        color: #204060;
      }
      .navbar-default .navbar-nav > .open > a,
      .navbar-default .navbar-nav > .open > a:hover,
      .navbar-default .navbar-nav > .open > a:focus {
        background-color: #4a5d75;
      }
      h3.well {
        border-color: #ffd630;
        background-color: #ffec9f;
      }
      .panel-sidebar {
        border-color: #f5f5f5;
      }
      .panel-sidebar > .panel-heading {
        border-color: #e3e3e3;
        background-color: #f5f5f5;
        color: #656565;
      }
      .btn-primary {
        border-color: #ffd630;
        background-color: #ffec9f;
        color: #656565;
      }
      footer.container {
        background-color: white;
      }
      footer.container h1, footer.container h2, footer.container h3, footer.container h4, footer.container h5, footer.container h6, footer.container p, footer.container a {
        color: #656565;
      }
      footer.container ul {
        padding: 0;
      }
      i.enormous-icon {
        margin-top: 0.3em;
      }
      .home-examples {
        font-size: 16px;
      }
    </style> <script src="//static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script> <script>
      hljs.initHighlightingOnLoad();
    </script> <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     
    ga('create', 'UA-8601422-1', 'auto');
    ga('send', 'pageview');
    
    </script> </head> <body> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div id="rhbar"> <a class="jbdevlogo" href="http://www.jboss.org/projects/about"></a> <a class="rhlogo" href="http://www.redhat.com/"></a> </div> <div class="container" id="content"> <nav class="navbar navbar-default navbar-fixed-top"> <div class="container"> <div class="navbar-header"> <button aria-expanded="false" class="navbar-toggle collapsed" data-target="#thenavbar" data-toggle="collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img alt="Infinispan" src="/images/infinispan_nav_brand.png"> </a> </div> <div class="navbar-collapse collapse" id="thenavbar"> <ul class="nav navbar-nav"> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/about">About <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/about">Introduction</a></li> <li><a href="/features">Features</a></li> <li><a href="/release-notes">Release notes</a></li> <li><a href="http://blog.infinispan.org">Blog</a></li> <li><a href="/references">References</a></li> <li><a href="/experiments/">Experiments</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/documentation">Learn <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/documentation">Documentation</a></li> <li><a href="/tutorials">Tutorials</a></li> <li><a href="/videos">Videos</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/download">Download <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/download">Infinispan Releases</a></li> <li><a href="/cache-store-implementations">Cache Store Implementations</a></li> <li><a href="/hotrod-clients">Hot Rod Clients</a></li> <li><a href="/integrations">Integrations</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/community">Community <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/community">Ask for Help</a></li> <li><a href="/getinvolved">Get Involved</a></li> </ul> </li> <li class=""><a href="/roadmap">Road Map</a></li> <li class="divider"></li> </ul> </div> </div> </nav> <h3>Wednesday 02 September 2015</h3> <h1>Functional Map API&#58; Working with single entries</h1> <p>&lt;p&gt;&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;In this blog post we'll continue with the introduction of the experimental Functional Map API, which was released as part of &lt;a href="http://blog.infinispan.org/2015/08/infinispan-800final.html"&gt;Infinispan 8.0.0.Final&lt;/a&gt;, focusing on how to manipulate data using single-key operations.&lt;br/&gt;&lt;br/&gt;As mentioned in the &lt;a href="http://blog.infinispan.org/2015/08/new-functional-map-api-in-infinispan-8.html"&gt;Functional Map API introduction&lt;/a&gt;, there are three types of operations that can be executed against a functional map: read-only operations (executed via &lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadOnlyMap.html"&gt;&lt;span style="font-family: Courier New, Courier, monospace;"&gt;ReadOnlyMap&lt;/span&gt;&lt;/a&gt;), write-only operations (executed via &lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html"&gt;&lt;span style="font-family: Courier New, Courier, monospace;"&gt;WriteOnlyMap&lt;/span&gt;&lt;/a&gt;), and read-write operations (executed via &lt;span style="font-family: Courier New, Courier, monospace;"&gt;&lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html"&gt;ReadWriteMap&lt;/a&gt;&lt;/span&gt;) and .&lt;br/&gt;&lt;br/&gt;Firstly, we need construct instances of &lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadOnlyMap.html"&gt;&lt;span style="font-family: Courier New, Courier, monospace;"&gt;ReadOnlyMap&lt;/span&gt;&lt;/a&gt;, &lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html"&gt;&lt;span style="font-family: Courier New, Courier, monospace;"&gt;WriteOnlyMap&lt;/span&gt;&lt;/a&gt; and &lt;span style="font-family: Courier New, Courier, monospace;"&gt;&lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html"&gt;ReadWriteMap&lt;/a&gt;&lt;/span&gt; to be able to work with them:&lt;br/&gt;&lt;br/&gt;&lt;script src="https://gist.github.com/galderz/0866f07c589e5c66bdaf.js"/&gt; Next, let's see all three types of operations in action, chaining them to store a single key/value pair along with some metadata, then read it and finally delete a returning the previously stored data:&lt;br/&gt;&lt;br/&gt;&lt;script src="https://gist.github.com/galderz/613eae9b6994b1a7415b.js"/&gt; This example demonstrates some of the key aspects of working with single entries using the Functional Map API:&lt;br/&gt;&lt;ul style="text-align: left;"&gt;&lt;li&gt;Single entry methods are asynchronous returning&lt;span style="font-family: Courier New, Courier, monospace;"&gt;&lt;a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"&gt;CompletableFuture&lt;/a&gt;&lt;/span&gt;instances which provide methods to compose and chain operations so that it can feel is they're being executed sequentially. Unfortunately Java does not have &lt;a href="https://en.wikibooks.org/wiki/Haskell/do_notation"&gt;Haskell's do notation&lt;/a&gt; or &lt;a href="http://docs.scala-lang.org/tutorials/FAQ/yield.html"&gt;Scala's for comprehensions&lt;/a&gt; to make it more palatable, but it's great news that Java finally offers mechanisms to work with CompletableFutures in a non-blocking way, even if they're a bit more verbose than what's proposed in other languages.&lt;/li&gt;&lt;li&gt;All data-handling methods for &lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html"&gt;&lt;span style="font-family: Courier New, Courier, monospace;"&gt;WriteOnlyMap&lt;/span&gt;&lt;/a&gt; return &lt;span style="font-family: Courier New, Courier, monospace;"&gt;&lt;a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"&gt;CompletableFutureVoid&lt;/a&gt;&lt;/span&gt;, meaning that the user can find out when the operation has completed but nothing else, because there's nothing the function can provide that could not be computed in advance or outside the function.&lt;/li&gt;&lt;li&gt;The return type for most of the data handling methods in &lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadOnlyMap.html"&gt;&lt;span style="font-family: Courier New, Courier, monospace;"&gt;ReadOnlyMap&lt;/span&gt;&lt;/a&gt; (and &lt;span style="font-family: Courier New, Courier, monospace;"&gt;&lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html"&gt;ReadWriteMap&lt;/a&gt;&lt;/span&gt;) are quite flexible. So, a function can decide to return value information, or metadata, or for convenience, it can also return the ReadEntryView it receives as parameter. This can be useful for users wanting to return both value and metadata parameter information.&lt;/li&gt;&lt;li&gt;The read-write operation demonstrated above showed how to remove an entry and return the previously associated value. In this particular case, we know there's a value associated with the entry and hence we called &lt;span style="font-family: Courier New, Courier, monospace;"&gt;&lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html"&gt;ReadEntryView.get()&lt;/a&gt;&lt;/span&gt; directly, but if we were not sure if the value is present or not,&lt;span style="font-family: Courier New, Courier, monospace;"&gt;&lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#find–"&gt;ReadEntryView.find()&lt;/a&gt;&lt;/span&gt; should be called and return the &lt;a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html"&gt;&lt;span style="font-family: Courier New, Courier, monospace;"&gt;Optional&lt;/span&gt;&lt;/a&gt; instance instead.&lt;/li&gt;&lt;li&gt;In the example, &lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/MetaParam.MetaLifespan.html"&gt;Lifespan metadata parameter&lt;/a&gt; is constructed using the new Java Time API available in Java 8, but it could have been done equally with&lt;span style="font-family: Courier New, Courier, monospace;"&gt;&lt;a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/TimeUnit.html"&gt;java.util.concurrent.TimeUnit&lt;/a&gt;&lt;/span&gt; as long as the conversion was done to number of milliseconds during which the entry should be accessible.&lt;/li&gt;&lt;li&gt;Lifespan-based expiration works just as it does with other Infinispan APIs, so you can easily modify the example to lower the lifespan, wait for duration to pass and then verify that the value is not present any more.&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;If storing a constant value, &lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#eval-K-java.util.function.Consumer-"&gt;&lt;span style="font-family: Courier New, Courier, monospace;"&gt;WriteOnlyMap.eval(K, Consumer)&lt;/span&gt;&lt;/a&gt; could be used instead of&lt;span style="font-family: Courier New, Courier, monospace;"&gt;&lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#eval-K-V-java.util.function.BiConsumer-"&gt;WriteOnlyMap.eval(K, V, Consumer)&lt;/a&gt;,&lt;/span&gt; making the code clearer, but if the value is variable,&lt;span style="font-family: Courier New, Courier, monospace;"&gt;&lt;a href="https://docs.jboss.org/infinispan/8.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#eval-K-V-java.util.function.BiConsumer-"&gt;WriteOnlyMap.eval(K, V, Consumer)&lt;/a&gt;&lt;/span&gt; should be used to avoid, as much as possible, functions capturing external variables. Clearly, operations exposed by functional map can't cover all scenarios and there might be situations where external variables are captured by functions, but these should in general, should be a minority. Here is as example showing how to implement &lt;span style="font-family: Courier New, Courier, monospace;"&gt;&lt;a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentSkipListMap.html#replace-K-V-V-"&gt;ConcurrentMap.replace(K, V, V)&lt;/a&gt;&lt;/span&gt; where external variable capturing is required:&lt;/div&gt;&lt;br/&gt;&lt;script src="https://gist.github.com/galderz/aebc9ac4fa80ae8021d9.js"/&gt; &lt;br/&gt;&lt;div&gt;The reason we didn't add a &lt;span style="font-family: Courier New, Courier, monospace;"&gt;WriteOnly.eval(K, V, V, Consumer)&lt;/span&gt; to the API is because value-equality-based replace comparisons are just one type of replace operations that could be executed. In other cases, metadata parameter based comparison might be more suitable, e.g. Hot Rod replace operation where version (a type of metadata parameter) equality is the deciding factor to determine whether the replace should happen or not.&lt;br/&gt;&lt;br/&gt;In the next blog post, we'll be looking at how to work with multiple entries using the Functional Map API.&lt;/div&gt;&lt;div&gt;&lt;br/&gt;&lt;/div&gt;&lt;div&gt;Cheers,&lt;/div&gt;&lt;div&gt;Galder&lt;/div&gt;&lt;/div&gt;&lt;/p&gt;</p> <em>Posted by Galder Zamarreño</em> </div> <footer class="container"> <hr> <div class="row"> <div class="col-md-2 col-md-offset-1"> <h4>Navigate</h4> <ul> <li> <a href="/about" title="About">About</a> </li> <li> <a href="/documentation" title="Learn">Learn</a> </li> <li> <a href="/community" title="Community">Community</a> </li> <li> <a href="/getinvolved" title="Get Involved">Get Involved</a> </li> <li> <a href="/download" title="Download">Download</a> </li> </ul> </div> <div class="col-md-2"> <h4>Contribute</h4> <ul> <li> <a href="https://issues.jboss.org/browse/ISPN" title="Submit a bug">Submit a bug</a> </li> <li> <a href="https://github.com/infinispan" title="Write code">Write Code</a> </li> </ul> <h4>Follow Us</h4> <ul> <li> <a href="https://blog.infinispan.org" title="Blog">Blog</a> </li> <li> <a href="https://twitter.com/infinispan" title="Twitter">Twitter</a> </li> </ul> </div> <div class="col-md-2"> <h4>Open Source</h4> <p> Infinispan is released under the <b>Apache 2.0 open source license.</b> Learn more about the Apache 2.0 license <a href="https://www.apache.org/licenses/LICENSE-2.0">here.</a> </p> </div> <div class="col-md-2"> <h4>A member of</h4> <a alt="CloudTM" href="http://www.cloudtm.eu/" target="_NEW"> <img src="/images/cloudtm.png"> </a> <a alt="LEADS" href="http://leads-project.eu/" target="_NEW"> <img src="/images/leads.png"> </a> <a alt="CloudButton" href="http://cloudbutton.eu/" target="_NEW"> <img src="/images/cloudbutton.png"> </a> </div> <div class="col-md-2"> <h4>Thanks to</h4> <p>JetBrains Intellij IDEA</p> <a alt="JetBrains Intellij IDEA" href="https://www.jetbrains.com/idea/" target="_NEW"> <img src="/images/icon_IntelliJIDEA.png"> </a> </div> </div> <div class="col-md-10"> <p style="margin-top: 5px; font-size: 80%;"> © Copyright 2009-2019 Red Hat, Inc. <br> <i class="icon-fire"></i> Made with <a href="https://github.com/jbossorg/bootstrap-community" style="text-decoration: underline;" target="_NEW">JBoss Community Bootstrap</a> and <a href="http://awestruct.org/" style="text-decoration: underline;" target="_NEW">Awestruct</a> <br> <i class="icon-globe"></i> This website is open source! If you want to improve it, <a href="https://github.com/infinispan/infinispan.github.io" style="text-decoration: underline;" target="_NEW">fork the project,</a> and hack on it, then send a pull request. You can also view the <a href="https://www.seethestats.com/site/infinispan.org" style="text-decoration: underline;" target="_NEW">visitor stats.</a> <br> <i class="icon-share"></i> Website and documentation released under <a href="https://creativecommons.org/licenses/by/3.0/" style="text-decoration: underline;" target="_NEW">CC BY 3.0.</a> </p> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="http://www.redhat.com/"><img src="//static.jboss.org/theme/images/common/redhat_logo.png"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="//static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script>
        if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
          _satellite.pageBottom();
        }
      </script> </div> </body> </html>