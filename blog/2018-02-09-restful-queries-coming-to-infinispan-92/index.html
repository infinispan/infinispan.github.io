<!DOCTYPE html> <html lang="en"> <head> <title>RESTful queries coming to Infinispan 9.2 - Infinispan</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="DENY" http-equiv="X-Frame-Options"> <meta content="1; mode=block" http-equiv="X-XSS-Protection"> <meta content="nosniff" http-equiv="X-Content-Type-Options"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" rel="stylesheet"> <script id="dpal" src="https://www.redhat.com/dtm.js" type="text/javascript"></script> <link href="/images/favicon.png" rel="shortcut icon" type="image/png"> <link href="//static.jboss.org/images/example/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="//static.jboss.org/images/example/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="//static.jboss.org/images/example/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="//static.jboss.org/images/example/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css" rel="stylesheet"> <link href="https://static.jboss.org/css/rhbar.css" media="screen" rel="stylesheet"> <style>
      .jumbotron {
        padding: 0.5em 0.1em 0.5em 0.1em;
        background-image: none;
        background-color: #ffec9f;
      }
      .jumbotron p, 
      .jumbotron h1 {
        color: #656565;
      }
      .dropup {
        z-index: 1032;
      }
      .navbar {
        font-size: x-large;
      }
      .navbar ul {
        padding-top: 0.7em;
      }
      .navbar-brand {
        height: 80px;
      }
      .navbar-default {
        background-color: white;
      }
      .navbar-default .navbar-nav > li > a {
        color: #336699;
      }
      .navbar-default .navbar-nav > li > a:hover {
        color: #204060;
      }
      .navbar-default .navbar-nav > .open > a,
      .navbar-default .navbar-nav > .open > a:hover,
      .navbar-default .navbar-nav > .open > a:focus {
        background-color: #4a5d75;
      }
      h3.well {
        border-color: #ffd630;
        background-color: #ffec9f;
      }
      .panel-sidebar {
        border-color: #f5f5f5;
      }
      .panel-sidebar > .panel-heading {
        border-color: #e3e3e3;
        background-color: #f5f5f5;
        color: #656565;
      }
      .btn-primary {
        border-color: #ffd630;
        background-color: #ffec9f;
        color: #656565;
      }
      footer.container {
        background-color: white;
      }
      footer.container h1, footer.container h2, footer.container h3, footer.container h4, footer.container h5, footer.container h6, footer.container p, footer.container a {
        color: #656565;
      }
      footer.container ul {
        padding: 0;
      }
      i.enormous-icon {
        margin-top: 0.3em;
      }
      .home-examples {
        font-size: 16px;
      }
    </style> <script src="//static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script> <script>
      hljs.initHighlightingOnLoad();
    </script> <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     
    ga('create', 'UA-8601422-1', 'auto');
    ga('send', 'pageview');
    
    </script> </head> <body> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div id="rhbar"> <a class="jbdevlogo" href="http://www.jboss.org/projects/about"></a> <a class="rhlogo" href="http://www.redhat.com/"></a> </div> <div class="container" id="content"> <nav class="navbar navbar-default navbar-fixed-top"> <div class="container"> <div class="navbar-header"> <button aria-expanded="false" class="navbar-toggle collapsed" data-target="#thenavbar" data-toggle="collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img alt="Infinispan" src="/images/infinispan_nav_brand.png"> </a> </div> <div class="navbar-collapse collapse" id="thenavbar"> <ul class="nav navbar-nav"> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/about">About <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/about">Introduction</a></li> <li><a href="/features">Features</a></li> <li><a href="/release-notes">Release notes</a></li> <li><a href="http://blog.infinispan.org">Blog</a></li> <li><a href="/references">References</a></li> <li><a href="/experiments/">Experiments</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/documentation">Learn <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/documentation">Documentation</a></li> <li><a href="/tutorials">Tutorials</a></li> <li><a href="/videos">Videos</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/download">Download <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/download">Infinispan Releases</a></li> <li><a href="/cache-store-implementations">Cache Store Implementations</a></li> <li><a href="/hotrod-clients">Hot Rod Clients</a></li> <li><a href="/integrations">Integrations</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="/community">Community <b class="caret"></b></a> <ul class="dropdown-menu"> <li><a href="/community">Ask for Help</a></li> <li><a href="/getinvolved">Get Involved</a></li> </ul> </li> <li class=""><a href="/roadmap">Road Map</a></li> <li class="divider"></li> </ul> </div> </div> </nav> <h3>Friday 09 February 2018</h3> <h1>RESTful queries coming to Infinispan 9.2</h1> <p>&lt;p&gt;&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;&lt;br/&gt;One of the interesting features in the upcoming Infinispan 9.2 release is the possibility to execute queries over the REST endpoint, enabling users to take advantage of the easy-to-use and expressiveness of the Ickle query language, that combines a subset of JP-QL with full-text features. You can learn more info about Ickle in a &lt;a href="http://blog.infinispan.org/2016/12/meet-ickle.html"&gt;previous post&lt;/a&gt;.&lt;br/&gt;&lt;br/&gt;Besides exposing query over REST, Infinispan 9.2 also adds support for mapping between JSON and Protobuf formats, allowing an efficient storage in binary format while exposing queries, reading and writing content as JSON documents.&lt;br/&gt;&lt;br/&gt;To illustrate those new capabilities, this post will walk you through a sample app from scratch!&lt;br/&gt;&lt;br/&gt;&lt;h2 style="text-align: left;"&gt;&lt;br/&gt;Sample app&lt;/h2&gt;&lt;h4 style="text-align: left;"&gt;&lt;br/&gt;Running the server&lt;/h4&gt;We start by &lt;a href="https://github.com/jboss-dockerfiles/infinispan/tree/master/server"&gt;running&lt;/a&gt; the Infinispan Server 9.2.0.CR2 (the latest release candidate):&lt;br/&gt;&lt;br/&gt;&lt;script src="https://gist.github.com/gustavonalle/8e61f4ba72a7f1f35b3aae1031a18a05.js"/&gt;&lt;/div&gt;&lt;br/&gt;This will get you a fresh instance of Infinispan running, with login and password 'user' and the REST port 8080 mapped to localhost. TIP: if you run more than one container, they'll form a cluster automatically.&lt;br/&gt;&lt;br/&gt;&lt;h4 style="text-align: left;"&gt;Creating an indexed cache&lt;/h4&gt;Next step is to create an indexed cache called 'pokemon'. We make use of the CLI (Command Line Interface) to create this cache. In the future, with &lt;a href="https://issues.jboss.org/browse/ISPN-8529"&gt;ISPN-8529&lt;/a&gt;, we'll also be able to create cache with arbitrary configuration using REST, but for now we execute a CLI recipe: &lt;br/&gt;&lt;br/&gt;&lt;script src="https://gist.github.com/gustavonalle/746a09602379c686482f7572388e5c92.js"/&gt; &lt;br/&gt;&lt;h4 style="text-align: left;"&gt;Creating the schema&lt;/h4&gt;In order to be able to query, we need to define a protobuf schema for our data. The schema follows the Protobuf 2 format (Protobuf 3 support is coming) and allows for extensions to define indexing properties (analyzers, storage, etc). &lt;br/&gt;&lt;br/&gt;Here's how it looks like:&lt;br/&gt;&lt;br/&gt;&lt;script src="http://gist-it.appspot.com/https://github.com/infinispan-demos/infinispan-pokemon/blob/master/pokemon.proto?footer=0"/&gt; &lt;br/&gt;The protobuf schema can contain some comments on top of fields and messages with "annotations" to control indexing. Hibernate Search users will recognize some of those pseudo annotations we are using here: they resemble closely their counterpart. &lt;br/&gt;&lt;br/&gt;&lt;br/&gt;&lt;h4 style="text-align: left;"&gt;Registering the schema &lt;/h4&gt;Once we have our schema, we can easily register it via REST:&lt;br/&gt;&lt;br/&gt;&lt;script src="https://gist.github.com/gustavonalle/b22036640c31d6edf825156b2356b878.js"/&gt; &lt;br/&gt;&lt;h4 style="text-align: left;"&gt;&lt;br/&gt;Populating the cache&lt;/h4&gt;We're now ready to put some data in the cache. As mentioned earlier, ingesting can be done by sending JSON documents directly. Once Infinispan receives those documents, it will convert them to protobuf, index and store them.&lt;br/&gt;&lt;br/&gt;In order to match a particular inbound document to an entity in the schema, Infinispan uses a special meta field called &lt;b&gt;&lt;i&gt;_type&lt;/i&gt;&lt;/b&gt; that must be provided in the document. Here's an example of a JSON document that conforms to our schema:&lt;br/&gt;&lt;br/&gt;&lt;script src="https://gist.github.com/gustavonalle/91a265423d64e9427e04ae0950b2eb74.js"/&gt; Writing the document is easy:&lt;br/&gt;&lt;br/&gt;&lt;script src="https://gist.github.com/gustavonalle/482fde9e1be0aefc0ce20cef61bc35da.js"/&gt; &lt;br/&gt;we can retrieve content by key as JSON:&lt;br/&gt;&lt;br/&gt;&lt;script src="https://gist.github.com/gustavonalle/b3b0cc171dfa8ecd56f748f484e0b88c.js"/&gt; &lt;br/&gt;&lt;h4 style="text-align: left;"&gt;Querying&lt;/h4&gt;&lt;br/&gt;The new query endpoint can be called with an "action" parameter named "search", after the cache name. The simplest query, which returns all data can be done with: &lt;br/&gt;&lt;br/&gt;&lt;a href="http://localhost:8080/rest/pokemon?action=search&amp;amp;query=from%20Pokemon"&gt;http://localhost:8080/rest/pokemon?action=searchquery=from Pokemon&lt;/a&gt;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;If you do not want to return all the fields, use a &lt;i&gt;Select&lt;/i&gt; clause:&lt;br/&gt;&lt;br/&gt;&lt;a href="http://localhost:8080/rest/pokemon?action=search&amp;amp;query=Select%20name,%20speed%20from%20Pokemon"&gt;http://localhost:8080/rest/pokemon?action=searchquery=Select name, speed from Pokemon&lt;/a&gt;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;Pagination can be controlled with the &lt;i&gt;offset&lt;/i&gt;, &lt;i&gt;max_results&lt;/i&gt; URL parameters:&lt;br/&gt;&lt;br/&gt;&lt;a href="http://localhost:8080/rest/pokemon?action=search&amp;amp;query=from%20Pokemon&amp;amp;offset=2&amp;amp;max_results=20"&gt;http://localhost:8080/rest/pokemon?action=searchquery=from Pokemonoffset=2max_results=20&lt;/a&gt;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;Grouping is also possible:&lt;br/&gt;&lt;br/&gt;&lt;a href="http://localhost:8080/rest/pokemon?action=search&amp;amp;query=select%20count(p.name)%20from%20Pokemon%20p%20group%20by%20generation"&gt;http://localhost:8080/rest/pokemon?action=searchquery=select count(p.name) from Pokemon p group by generation&lt;/a&gt;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;Example of a query result:&lt;br/&gt;&lt;br/&gt;&lt;a href="http://localhost:8080/rest/pokemon?action=search&amp;amp;query=select%20name,pokedex_number,against_fire%20from%20Pokemon%20order%20by%20against_fire%20asc&amp;amp;max_results=5"&gt;http://localhost:8080/rest/pokemon?action=searchquery=select name,pokedex_number,against_fire from Pokemon order by against_fire ascmax_results=5&lt;/a&gt;&lt;br/&gt;&lt;br/&gt;Results:&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;&lt;script src="https://gist.github.com/gustavonalle/606dc182f39eda16dc56922f25c28f1d.js"/&gt; &lt;br/&gt;&lt;br/&gt;&lt;h2 style="text-align: left;"&gt;Conclusion&lt;/h2&gt;&lt;h2 style="text-align: left;"/&gt;Infinispan 9.2 makes it easier to quickly ingest and query datasets using the &lt;span data-dobid="hdw"&gt;ubiquitous&lt;/span&gt; JSON format, without sacrificing type safety and storage size.&lt;br/&gt;&lt;br/&gt;By storing Protobuf, this will also enable other clients like the Hot Rod C#/C++ clients to query, read and write data simultaneously with REST clients.&lt;br/&gt;&lt;br/&gt;The full source code for the demo, along with instructions on how to populate the whole dataset can be found at &lt;a href="https://github.com/infinispan-demos/infinispan-pokemon"&gt;Github&lt;/a&gt;.&lt;br/&gt;&lt;br/&gt;Finally, please try out this new feature in your own dataset and let us know how it goes!&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;&lt;/div&gt;&lt;/p&gt;</p> <em>Posted by Gustavo Fernandes</em> </div> <footer class="container"> <hr> <div class="row"> <div class="col-md-2 col-md-offset-1"> <h4>Navigate</h4> <ul> <li> <a href="/about" title="About">About</a> </li> <li> <a href="/documentation" title="Learn">Learn</a> </li> <li> <a href="/community" title="Community">Community</a> </li> <li> <a href="/getinvolved" title="Get Involved">Get Involved</a> </li> <li> <a href="/download" title="Download">Download</a> </li> </ul> </div> <div class="col-md-2"> <h4>Contribute</h4> <ul> <li> <a href="https://issues.jboss.org/browse/ISPN" title="Submit a bug">Submit a bug</a> </li> <li> <a href="https://github.com/infinispan" title="Write code">Write Code</a> </li> </ul> <h4>Follow Us</h4> <ul> <li> <a href="https://blog.infinispan.org" title="Blog">Blog</a> </li> <li> <a href="https://twitter.com/infinispan" title="Twitter">Twitter</a> </li> </ul> </div> <div class="col-md-2"> <h4>Open Source</h4> <p> Infinispan is released under the <b>Apache 2.0 open source license.</b> Learn more about the Apache 2.0 license <a href="https://www.apache.org/licenses/LICENSE-2.0">here.</a> </p> </div> <div class="col-md-2"> <h4>A member of</h4> <a alt="CloudTM" href="http://www.cloudtm.eu/" target="_NEW"> <img src="/images/cloudtm.png"> </a> <a alt="LEADS" href="http://leads-project.eu/" target="_NEW"> <img src="/images/leads.png"> </a> <a alt="CloudButton" href="http://cloudbutton.eu/" target="_NEW"> <img src="/images/cloudbutton.png"> </a> </div> <div class="col-md-2"> <h4>Thanks to</h4> <p>JetBrains Intellij IDEA</p> <a alt="JetBrains Intellij IDEA" href="https://www.jetbrains.com/idea/" target="_NEW"> <img src="/images/icon_IntelliJIDEA.png"> </a> </div> </div> <div class="col-md-10"> <p style="margin-top: 5px; font-size: 80%;"> Â© Copyright 2009-2019 Red Hat, Inc. <br> <i class="icon-fire"></i> Made with <a href="https://github.com/jbossorg/bootstrap-community" style="text-decoration: underline;" target="_NEW">JBoss Community Bootstrap</a> and <a href="http://awestruct.org/" style="text-decoration: underline;" target="_NEW">Awestruct</a> <br> <i class="icon-globe"></i> This website is open source! If you want to improve it, <a href="https://github.com/infinispan/infinispan.github.io" style="text-decoration: underline;" target="_NEW">fork the project,</a> and hack on it, then send a pull request. You can also view the <a href="https://www.seethestats.com/site/infinispan.org" style="text-decoration: underline;" target="_NEW">visitor stats.</a> <br> <i class="icon-share"></i> Website and documentation released under <a href="https://creativecommons.org/licenses/by/3.0/" style="text-decoration: underline;" target="_NEW">CC BY 3.0.</a> </p> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="http://www.redhat.com/"><img src="//static.jboss.org/theme/images/common/redhat_logo.png"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="//static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script>
        if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
          _satellite.pageBottom();
        }
      </script> </div> </body> </html>