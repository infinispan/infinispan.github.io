<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Infinispan Operator Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body id="infinispan_operator" class="article toc2 toc-left">
<div id="header">
<h1>Infinispan Operator Guide</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#installation">1. Installing Infinispan Operator</a>
<ul class="sectlevel2">
<li><a href="#create_olm_subscription">1.1. Installing Infinispan Operator on Red Hat OpenShift</a></li>
<li><a href="#operatorhub">1.2. Installing Infinispan Operator on Kubernetes</a></li>
<li><a href="#manual">1.3. Building and Installing Infinispan Operator Manually</a></li>
<li><a href="#ref_upgrades-install">1.4. Infinispan Upgrades</a></li>
</ul>
</li>
<li><a href="#start_operator">2. Getting Started with Infinispan Operator</a>
<ul class="sectlevel2">
<li><a href="#minimal_crd-start">2.1. Infinispan Custom Resource (CR)</a></li>
<li><a href="#creating_minimal_clusters-start">2.2. Creating Infinispan Clusters</a></li>
<li><a href="#verifying_clusters-start">2.3. Verifying Infinispan Clusters</a></li>
</ul>
</li>
<li><a href="#creating_services">3. Setting Up Infinispan Services</a>
<ul class="sectlevel2">
<li><a href="#services-nodes">3.1. Service Types</a></li>
<li><a href="#creating_cache_service-nodes">3.2. Creating Cache Service Nodes</a>
<ul class="sectlevel3">
<li><a href="#configuring_autoscale-nodes">3.2.1. Configuring Automatic Scaling</a></li>
<li><a href="#configuring_owners-nodes">3.2.2. Configuring the Number of Owners</a></li>
<li><a href="#ref_cache_service_crd-nodes">3.2.3. Cache Service Resources</a></li>
</ul>
</li>
<li><a href="#creating_dg_service-nodes">3.3. Creating Data Grid Service Nodes</a>
<ul class="sectlevel3">
<li><a href="#ref_datagrid_service_crd-nodes">3.3.1. Data Grid Service Resources</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#container_spec">4. Adjusting Container Specifications</a>
<ul class="sectlevel2">
<li><a href="#memory_resources-resources">4.1. JVM, CPU, and Memory Resources</a></li>
<li><a href="#storage_resources-resources">4.2. Storage Resources</a></li>
</ul>
</li>
<li><a href="#shutdown">5. Stopping and Starting Infinispan Clusters</a>
<ul class="sectlevel2">
<li><a href="#shutting_down-nodes">5.1. Shutting Down Infinispan Clusters</a></li>
<li><a href="#restarting-nodes">5.2. Restarting Infinispan Clusters</a></li>
</ul>
</li>
<li><a href="#network_services">6. Configuring Network Access to Infinispan</a>
<ul class="sectlevel2">
<li><a href="#internal_service-access">6.1. Getting the Service for Internal Connections</a></li>
<li><a href="#exposing_loadbalancer-access">6.2. Exposing Infinispan Through Load Balancers</a></li>
<li><a href="#exposing_nodeport-access">6.3. Exposing Infinispan Through Node Ports</a></li>
<li><a href="#exposing_routes-access">6.4. Exposing Infinispan Through Routes</a></li>
</ul>
</li>
<li><a href="#authentication">7. Configuring Authentication</a>
<ul class="sectlevel2">
<li><a href="#default_credentials-security">7.1. Default Credentials</a></li>
<li><a href="#getting_credentials-security">7.2. Retrieving Credentials</a></li>
<li><a href="#identities-security">7.3. Identities File</a></li>
<li><a href="#adding_credentials-security">7.4. Adding Custom Credentials</a></li>
</ul>
</li>
<li><a href="#securing_endpoints">8. Securing Infinispan Connections</a>
<ul class="sectlevel2">
<li><a href="#encryption_with_service_ca-security">8.1. Encryption with Red Hat OpenShift Service Certificates</a>
<ul class="sectlevel3">
<li><a href="#getting_certs-security">8.1.1. Retrieving TLS Certificates</a></li>
</ul>
</li>
<li><a href="#using_custom_tls-security">8.2. Using Custom TLS Certificates</a>
<ul class="sectlevel3">
<li><a href="#ref_tls_cert_secret-security">8.2.1. Certificate Secrets</a></li>
<li><a href="#ref_tls_keystore_secret-security">8.2.2. Keystore Secrets</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#backup_sites">9. Configuring Cross-Site Replication</a>
<ul class="sectlevel2">
<li><a href="#global_clusters">9.1. Cross-Site Replication with Infinispan Operator</a></li>
<li><a href="#applying_clusterroles-xsite">9.2. Applying Cluster Roles for Cross-Site Replication</a></li>
<li><a href="#creating_minikube_secrets-xsite">9.3. Creating Minikube Site Access Secrets</a></li>
<li><a href="#creating_sa_tokens-xsite">9.4. Creating Service Account Tokens</a></li>
<li><a href="#exchanging_sa_tokens-xsite">9.5. Exchanging Service Account Tokens</a></li>
<li><a href="#configuring_sites-xsite">9.6. Configuring Infinispan Clusters for Cross-Site Replication</a>
<ul class="sectlevel3">
<li><a href="#ref_xsite_crd-xsite">9.6.1. Cross-Site Replication Resources</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#caches">10. Creating Infinispan Caches</a>
<ul class="sectlevel2">
<li><a href="#creating_caches_console-caches">10.1. Creating Caches with Infinispan Console</a></li>
<li><a href="#creating_caches_cli-caches">10.2. Creating Caches with Infinispan CLI</a></li>
<li><a href="#creating_caches_hotrod-caches">10.3. Creating Caches with Hot Rod Java Clients</a></li>
<li><a href="#creating_caches_cacheservice-caches">10.4. Adding Caches to Cache Service Nodes</a>
<ul class="sectlevel3">
<li><a href="#default_config-caches">10.4.1. Default Cache Configuration</a></li>
</ul>
</li>
<li><a href="#creating_caches_operator-caches">10.5. Creating Caches with Infinispan Operator</a>
<ul class="sectlevel3">
<li><a href="#cache_auth-caches">10.5.1. Adding Credentials to Create Caches</a></li>
<li><a href="#cache_templates-caches">10.5.2. Creating Infinispan Caches from Templates</a></li>
<li><a href="#cache_xml-caches">10.5.3. Creating Infinispan Caches from XML</a></li>
</ul>
</li>
<li><a href="#adding_backup_locations-caches">10.6. Adding Backup Locations to Caches</a>
<ul class="sectlevel3">
<li><a href="#backups_automatic_offline-caches">10.6.1. Performance Considerations with Taking Backup Locations Offline</a></li>
</ul>
</li>
<li><a href="#adding_cache_stores-caches">10.7. Adding Persistent Cache Stores</a></li>
</ul>
</li>
<li><a href="#prometheus">11. Monitoring Infinispan with Prometheus</a>
<ul class="sectlevel2">
<li><a href="#_setting_up_prometheus">11.1. Setting Up Prometheus</a></li>
</ul>
</li>
<li><a href="#logging">12. Monitoring Infinispan Logs</a>
<ul class="sectlevel2">
<li><a href="#configure_logging-monitor">12.1. Configuring Infinispan Logging</a></li>
<li><a href="#_log_levels">12.2. Log Levels</a></li>
</ul>
</li>
<li><a href="#operator_reference">13. Reference</a>
<ul class="sectlevel2">
<li><a href="#ref_image_crd-ref">13.1. Image Resource</a></li>
<li><a href="#ref_services-ref">13.2. Network Services</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Infinispan Operator provides operational intelligence and reduces management
complexity for deploying Infinispan on Kubernetes and Red Hat OpenShift.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="installation">1. Installing Infinispan Operator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Install Infinispan Operator into a Kubernetes namespace to create and manage Infinispan
clusters.</p>
</div>
<div class="sect2">
<h3 id="create_olm_subscription">1.1. Installing Infinispan Operator on Red Hat OpenShift</h3>
<div class="paragraph">
<p>Create subscriptions to Infinispan Operator on OpenShift so you can install
different Infinispan versions and receive automatic updates.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to <strong>OperatorHub</strong> running on OpenShift. Some OpenShift environments, such as OpenShift Container Platform, can require administrator credentials.</p>
</li>
<li>
<p>An OpenShift project for Infinispan Operator.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the OpenShift Web Console.</p>
</li>
<li>
<p>Navigate to <strong>OperatorHub</strong>.</p>
</li>
<li>
<p>Find and select Infinispan Operator.</p>
</li>
<li>
<p>Select <strong>Install</strong> and continue to <strong>Create Operator Subscription</strong>.</p>
</li>
<li>
<p>Specify options for your subscription.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Installation Mode</dt>
<dd>
<p>Install Infinispan Operator into a specific OpenShift namespace. You cannot install Infinispan Operator into multiple namespaces.</p>
</dd>
<dt class="hdlist1">Update Channel</dt>
<dd>
<p>Subscribe to updates for Infinispan Operator versions.</p>
</dd>
<dt class="hdlist1">Approval Strategies</dt>
<dd>
<p>When new Infinispan versions become available, you can install updates manually or let Infinispan Operator install them automatically.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Automatic updates apply to Infinispan Operator first and then for each Infinispan
node. Infinispan Operator updates clusters one node at a time, gracefully shutting
down each node and then bringing it back online with the updated version before
going on to the next node.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>Select <strong>Subscribe</strong> to install Infinispan Operator.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="operatorhub">1.2. Installing Infinispan Operator on Kubernetes</h3>
<div class="paragraph">
<p>Install Infinispan Operator on Kubernetes from <a href="https://operatorhub.io/operator/infinispan">OperatorHub.io</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>OKD 3.11 or later.</p>
</li>
<li>
<p>Kubernetes 1.11 or later.</p>
</li>
<li>
<p>Administrator access to the Kubernetes cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Navigate to the Infinispan Operator entry on <a href="https://operatorhub.io/operator/infinispan">OperatorHub.io</a>.</p>
</li>
<li>
<p>Follow the instructions to install Infinispan Operator into your Kubernetes cluster.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="manual">1.3. Building and Installing Infinispan Operator Manually</h3>
<div class="paragraph">
<p>Manually build and install Infinispan Operator from the GitHub repository.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Follow the appropriate instructions in the <a href="https://github.com/infinispan/infinispan-operator/blob/2.0.x/README.md">Infinispan Operator README</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="ref_upgrades-install">1.4. Infinispan Upgrades</h3>
<div class="paragraph">
<p>Infinispan Operator automatically upgrades Infinispan clusters when new versions
become available.</p>
</div>
<div class="paragraph">
<p>To upgrade Infinispan clusters, Infinispan Operator checks the version of the
image for Infinispan nodes. If Infinispan Operator determines that a new
version of the image is available, it gracefully shuts down all nodes, applies
the new image, and then restarts the nodes.</p>
</div>
<div class="paragraph">
<p>Infinispan Operator requires the Operator Lifecycle Manager to perform cluster
upgrades.</p>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://github.com/operator-framework/operator-lifecycle-manager">Operator Lifecycle Manager</a></p>
</li>
<li>
<p><a href="https://github.com/operator-framework/operator-lifecycle-manager/blob/master/doc/design/architecture.md">OLM Architecture</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="start_operator">2. Getting Started with Infinispan Operator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan Operator lets you create, configure, and manage Infinispan clusters.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Install Infinispan Operator.</p>
</li>
<li>
<p>Have an <code>oc</code> or a <code>kubectl</code> client.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="minimal_crd-start">2.1. Infinispan Custom Resource (CR)</h3>
<div class="paragraph">
<p>Infinispan Operator adds a new Custom Resource (CR) of type <strong>Infinispan</strong> that lets
you handle Infinispan clusters as complex units on Kubernetes.</p>
</div>
<div class="paragraph">
<p>Infinispan Operator watches for <strong>Infinispan</strong> Custom Resources (CR) that you use to
instantiate and configure Infinispan clusters and manage Kubernetes resources, such
as StatefulSets and Services. In this way, the <strong>Infinispan</strong> CR is your
primary interface to Infinispan on Kubernetes.</p>
</div>
<div class="paragraph">
<p>The minimal <strong>Infinispan</strong> CR is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: infinispan.org/v1 <i class="conum" data-value="1"></i><b>(1)</b>
kind: Infinispan <i class="conum" data-value="2"></i><b>(2)</b>
metadata:
  name: example-infinispan <i class="conum" data-value="3"></i><b>(3)</b>
spec:
  replicas: <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declares the Infinispan API version.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declares the Infinispan CR.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Names the Infinispan cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specifies the number of nodes in the Infinispan cluster.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="creating_minimal_clusters-start">2.2. Creating Infinispan Clusters</h3>
<div class="paragraph">
<p>Use Infinispan Operator to create clusters of two or more Infinispan nodes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify the number of Infinispan nodes in the cluster with <code>spec.replicas</code>
in your <strong>Infinispan</strong> CR.</p>
<div class="paragraph">
<p>For example, create a <code>cr_minimal.yaml</code> file as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ cat &gt; cr_minimal.yaml&lt;&lt;EOF
apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 2
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Apply your <strong>Infinispan</strong> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f cr_minimal.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Watch Infinispan Operator create the Infinispan nodes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get pods -w

NAME                        READY  STATUS              RESTARTS   AGE
example-infinispan-1        0/1    ContainerCreating   0          4s
example-infinispan-2        0/1    ContainerCreating   0          4s
example-infinispan-3        0/1    ContainerCreating   0          5s
infinispan-operator-0       1/1    Running             0          3m
example-infinispan-3        1/1    Running             0          8s
example-infinispan-2        1/1    Running             0          8s
example-infinispan-1        1/1    Running             0          8s</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Next Steps</div>
<p>Try changing the value of <code>replicas:</code> and watching Infinispan Operator scale the
cluster up or down.</p>
</div>
</div>
<div class="sect2">
<h3 id="verifying_clusters-start">2.3. Verifying Infinispan Clusters</h3>
<div class="paragraph">
<p>Review log messages to ensure that Infinispan nodes receive clustered views.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Do either of the following:</p>
<div class="ulist">
<ul>
<li>
<p>Retrieve the cluster view from logs.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl logs example-infinispan-0 | grep ISPN000094

INFO  [org.infinispan.CLUSTER] (MSC service thread 1-2) \
ISPN000094: Received new cluster view for channel infinispan: \
[example-infinispan-0|0] (1) [example-infinispan-0]

INFO  [org.infinispan.CLUSTER] (jgroups-3,example-infinispan-0) \
ISPN000094: Received new cluster view for channel infinispan: \
[example-infinispan-0|1] (2) [example-infinispan-0, example-infinispan-1]</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieve the <strong>Infinispan</strong> CR for Infinispan Operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get infinispan -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response indicates that Infinispan pods have received clustered views:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>conditions:
    - message: 'View: [example-infinispan-0, example-infinispan-1]'
      status: "True"
      type: wellFormed</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use <code>kubectl wait</code> with the <code>wellFormed</code> condition for automated scripts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl wait --for condition=wellFormed --timeout=240s infinispan/example-infinispan</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating_services">3. Setting Up Infinispan Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use Infinispan Operator to create clusters of either Cache Service or
Data Grid Service nodes.</p>
</div>
<div class="sect2">
<h3 id="services-nodes">3.1. Service Types</h3>
<div class="paragraph">
<p>Services are stateful applications, based on the Infinispan server image, that
provide flexible and robust in-memory data storage.</p>
</div>
<div class="paragraph">
<div class="title">Cache Service</div>
<p>Use Cache Service if you want a volatile, low-latency data store with minimal configuration. Cache Service nodes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Automatically scale to meet capacity when data storage demands go up or down.</p>
</li>
<li>
<p>Synchronously distribute data to ensure consistency.</p>
</li>
<li>
<p>Replicates each entry in the cache across the cluster.</p>
</li>
<li>
<p>Store cache entries off-heap and use eviction for JVM efficiency.</p>
</li>
<li>
<p>Ensure data consistency with a default partition handling configuration.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Because Cache Service nodes are volatile you lose all data when you apply
changes to the cluster with the <strong>Infinispan</strong> CR or update the Infinispan
version.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Data Grid Service</div>
<p>Use Data Grid Service if you want to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Back up data across global clusters with cross-site replication.</p>
</li>
<li>
<p>Create caches with any valid configuration.</p>
</li>
<li>
<p>Add file-based cache stores to save data in the persistent volume.</p>
</li>
<li>
<p>Use Infinispan search and other advanced capabilities.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="creating_cache_service-nodes">3.2. Creating Cache Service Nodes</h3>
<div class="paragraph">
<p>By default, Infinispan Operator creates Infinispan clusters with Cache Service
nodes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an <strong>Infinispan</strong> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 2
  service:
    type: Cache <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates nodes Cache Service nodes. This is the default for the <strong>Infinispan</strong> CR.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Apply your <strong>Infinispan</strong> CR to create the cluster.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="configuring_autoscale-nodes">3.2.1. Configuring Automatic Scaling</h4>
<div class="paragraph">
<p>If you create clusters with Cache Service nodes, Infinispan Operator
can automatically scale nodes up or down based on memory usage for the default
cache.</p>
</div>
<div class="paragraph">
<p>Infinispan Operator monitors default caches on Cache Service nodes. As you add
data to the cache, memory usage increases. When it detects that the cluster
needs additional capacity, Infinispan Operator creates new nodes rather than
eviciting entries. Likewise, if it detects that memory usage is below a certain
threshold, Infinispan Operator shuts down nodes.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Automatic scaling works with the default cache only. If you plan to add other
caches to your cluster, you should not include the <code>autoscale</code> field in your
<strong>Infinispan</strong> CR. In this case you should use eviction to control the size of
the data container on each node.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the <code>spec.autoscale</code> resource to your <strong>Infinispan</strong> CR to enable automatic scaling.</p>
</li>
<li>
<p>Configure memory usage thresholds and number of nodes for your cluster with the <code>autoscale</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  ...
  service:
    type: Cache
  autoscale:
    maxMemUsagePercent: 70 <i class="conum" data-value="1"></i><b>(1)</b>
    maxReplicas: 5 <i class="conum" data-value="2"></i><b>(2)</b>
    minMemUsagePercent: 30 <i class="conum" data-value="3"></i><b>(3)</b>
    minReplicas: 2 <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configures the maximum threshold, as a percentage, for memory usage on each node. When Infinispan Operator detects that any node in the cluster reaches the threshold, it creates a new node if possible. If Infinispan Operator cannot create a new node then it performs eviction when memory usage reaches 100 percent.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Defines the maximum number of number of nodes for the cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configures the minimum threshold, as a percentage, for memory usage across the cluster. When Infinispan Operator detects that memory usage falls below the minimum, it shuts down nodes.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Defines the minimum number of number of nodes for the cluster.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configuring_owners-nodes">3.2.2. Configuring the Number of Owners</h4>
<div class="paragraph">
<p>The number of owners controls how many copies of each cache entry are
replicated across your Infinispan cluster. The default for Cache Service
nodes is two, which duplicates each entry to prevent data loss.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify the number of owners with the <code>spec.service.replicationFactor</code> resource in your <strong>Infinispan</strong> CR as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  ...
  service:
    type: Cache
    replicationFactor: 3 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configures three replicas for each cache entry.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="ref_cache_service_crd-nodes">3.2.3. Cache Service Resources</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan <i class="conum" data-value="1"></i><b>(1)</b>
spec:
  replicas: 4 <i class="conum" data-value="2"></i><b>(2)</b>
  service:
    type: Cache <i class="conum" data-value="3"></i><b>(3)</b>
    replicationFactor: 2 <i class="conum" data-value="4"></i><b>(4)</b>
  autoscale: <i class="conum" data-value="5"></i><b>(5)</b>
    maxMemUsagePercent: 70
    maxReplicas: 5
    minMemUsagePercent: 30
    minReplicas: 2
  security:
    endpointSecretName: endpoint-identities <i class="conum" data-value="6"></i><b>(6)</b>
    endpointEncryption: <i class="conum" data-value="7"></i><b>(7)</b>
        type: Secret
        certSecretName: tls-secret
  container: <i class="conum" data-value="8"></i><b>(8)</b>
    extraJvmOpts: "-XX:NativeMemoryTracking=summary"
    cpu: "2000m"
    memory: 1Gi
  logging: <i class="conum" data-value="9"></i><b>(9)</b>
    categories:
      org.infinispan: trace
      org.jgroups: trace
  expose: <i class="conum" data-value="10"></i><b>(10)</b>
    type: LoadBalancer</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Names the Infinispan cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies the number of nodes in the cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creates Cache Service clusters. This is the default for Infinispan CR.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configures the number of replicas for each cache entry across the cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Enables and configures automatic cluster scaling.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Adds an authentication secret with user credentials.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Adds a custom encryption secret for secure connections.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Allocates resources to nodes.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Configures logging.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Configures services for external traffic.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating_dg_service-nodes">3.3. Creating Data Grid Service Nodes</h3>
<div class="paragraph">
<p>To use custom cache definitions along with Infinispan capabilities such as
cross-site replication, create clusters of Data Grid Service nodes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify <code>DataGrid</code> as the value for <code>spec.service.type</code> in your
<strong>Infinispan</strong> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 2
  service:
    type: DataGrid</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot change the <code>spec.service.type</code> field after you create nodes. To
change the service type, you must delete the existing nodes and create new ones.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Configure nodes with any other Data Grid Service resources.</p>
</li>
<li>
<p>Apply your <strong>Infinispan</strong> CR to create the cluster.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="ref_datagrid_service_crd-nodes">3.3.1. Data Grid Service Resources</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan <i class="conum" data-value="1"></i><b>(1)</b>
spec:
  replicas: 6 <i class="conum" data-value="2"></i><b>(2)</b>
  service:
    type: DataGrid <i class="conum" data-value="3"></i><b>(3)</b>
    container:
      storage: 2Gi <i class="conum" data-value="4"></i><b>(4)</b>
    sites: <i class="conum" data-value="5"></i><b>(5)</b>
      local:
      name: NYC
      expose:
        type: LoadBalancer
      locations:
      - name: azure
        url: openshift://api.azure.host:6443
        secretName: azure-token
      - name: aws
        url: openshift://api.aws.host:6443
        secretName: aws-token
  security:
    endpointSecretName: endpoint-identities <i class="conum" data-value="6"></i><b>(6)</b>
    endpointEncryption: <i class="conum" data-value="7"></i><b>(7)</b>
        type: Secret
        certSecretName: tls-secret
  container: <i class="conum" data-value="8"></i><b>(8)</b>
    extraJvmOpts: "-XX:NativeMemoryTracking=summary"
    cpu: "1000m"
    memory: 1Gi
  logging: <i class="conum" data-value="9"></i><b>(9)</b>
    categories:
      org.infinispan: debug
      org.jgroups: debug
      org.jgroups.protocols.TCP: error
      org.jgroups.protocols.relay.RELAY2: fatal
  expose: <i class="conum" data-value="10"></i><b>(10)</b>
    type: LoadBalancer</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Names the Infinispan cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies the number of nodes in the cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creates Data Grid Service clusters.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configures size of the persistent volume.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Provides connection information for backup locations.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Adds an authentication secret with user credentials.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Adds a custom encryption secret for secure connections.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Allocates resources to nodes.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Configures logging.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Configures services for external traffic.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="container_spec">4. Adjusting Container Specifications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can allocate CPU and memory resources, specify JVM options, and configure
storage for Infinispan nodes.</p>
</div>
<div class="sect2">
<h3 id="memory_resources-resources">4.1. JVM, CPU, and Memory Resources</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  ...
  container:
    extraJvmOpts: "-XX:NativeMemoryTracking=summary" <i class="conum" data-value="1"></i><b>(1)</b>
    cpu: "1000m" <i class="conum" data-value="2"></i><b>(2)</b>
    memory: 1Gi <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifies JVM options.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Allocates host CPU resources to node, measured in CPU units.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Allocates host memory resources to nodes, measured in bytes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When Infinispan Operator creates Infinispan clusters, it uses <code>spec.container.cpu</code>
and <code>spec.container.memory</code> to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure that Kubernetes has sufficient capacity to run the Infinispan node. By
default Infinispan Operator requests <strong>512Mi</strong> of <code>memory</code> and <strong>0.5</strong> <code>cpu</code> from
the Kubernetes scheduler.</p>
</li>
<li>
<p>Constrain node resource usage. Infinispan Operator sets the values of <code>cpu</code> and
<code>memory</code> as resource limits.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Garbage collection logging</div>
<p>By default, Infinispan Operator does not log garbage collection (GC) messages.
You can optionally add the following JVM options to direct GC messages to
stdout:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>extraJvmOpts: "-Xlog:gc*:stdout:time,level,tags"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="storage_resources-resources">4.2. Storage Resources</h3>
<div class="paragraph">
<p>By default, Infinispan Operator allocates <code>1Gi</code> for storage for both
Cache Service and Data Grid Service nodes. You can configure storage size for
Data Grid Service nodes but not Cache Service nodes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  ...
  service:
    type: DataGrid
    container:
      storage: 2Gi <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configures the storage size for Data Grid Service nodes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Persistent Volume Claims</div>
<p>Infinispan Operator mounts persistent volumes at:<br>
<code>/opt/infinispan/server/data</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Persistent volume claims use the <code>ReadWriteOnce (RWO)</code> access mode.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="shutdown">5. Stopping and Starting Infinispan Clusters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Stop and start Infinispan clusters with Infinispan Operator.</p>
</div>
<div class="paragraph">
<div class="title">Cache definitions</div>
<p>Both Cache Service and Data Grid Service store permanent cache definitions in
persistent volumes so they are still available after cluster restarts.</p>
</div>
<div class="paragraph">
<div class="title">Data</div>
<p>Data Grid Service nodes can write all cache entries to persistent storage during
cluster shutdown if you add a file-based cache store.</p>
</div>
<div class="sect2">
<h3 id="shutting_down-nodes">5.1. Shutting Down Infinispan Clusters</h3>
<div class="paragraph">
<p>Shutting down Cache Service nodes removes all data in the cache. For
Data Grid Service nodes, you should configure the storage size for
Data Grid Service nodes to ensure that the persistent volume can hold all your
data.</p>
</div>
<div class="paragraph">
<p>If the available container storage is less than the amount of memory available
to Data Grid Service nodes, Infinispan writes the following exception to logs
and data loss occurs during shutdown:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>WARNING: persistent volume size is less than memory size. Graceful shutdown may not work.</pre>
</div>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Set the value of <code>replicas</code> to <code>0</code> and apply the changes.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spec:
  replicas: 0</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="restarting-nodes">5.2. Restarting Infinispan Clusters</h3>
<div class="paragraph">
<p>Complete the following procedure to restart Infinispan clusters after shutdown.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>For Data Grid Service nodes, you must restart clusters with the same number of
nodes before shutdown. For example, you shut down a cluster of 6 nodes. When
you restart that cluster, you must specify 6 as the value for <code>spec.replicas</code>.</p>
</div>
<div class="paragraph">
<p>This allows Infinispan to restore the distribution of data across the cluster.
When all nodes in the cluster are running, you can then add or remove nodes.</p>
</div>
<div class="paragraph">
<p>You can find the correct number of nodes for Infinispan clusters as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get infinispan example-infinispan -o=jsonpath='{.status.replicasWantedAtRestart}'</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Set the value of <code>spec.replicas</code> to the appropriate number of nodes for your cluster, for example:</p>
<div class="listingblock">
<div class="content">
<pre>spec:
  replicas: 6</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="network_services">6. Configuring Network Access to Infinispan</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Expose Infinispan clusters so you can access Infinispan Console, the
Infinispan command line interface (CLI), REST API, and Hot Rod endpoint.</p>
</div>
<div class="sect2">
<h3 id="internal_service-access">6.1. Getting the Service for Internal Connections</h3>
<div class="paragraph">
<p>By default, Infinispan Operator creates a service that provides access to
Infinispan clusters from clients running in Kubernetes.</p>
</div>
<div class="paragraph">
<p>This internal service has the same name as your Infinispan cluster, for
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">metadata:
  name: example-infinispan</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Check that the internal service is available as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get services

NAME               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)
example-infinispan ClusterIP   192.0.2.0        &lt;none&gt;        11222/TCP</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="#ref_services-ref">Network Services</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="exposing_loadbalancer-access">6.2. Exposing Infinispan Through Load Balancers</h3>
<div class="paragraph">
<p>Use a load balancer service to make Infinispan clusters available to clients running outside Kubernetes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To access Infinispan with unencrypted Hot Rod client connections you must use
a load balancer service.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Include <code>spec.expose</code> in your <strong>Infinispan</strong> CR.</p>
</li>
<li>
<p>Specify <code>LoadBalancer</code> as the service type with <code>spec.expose.type</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  ...
  expose:
    type: LoadBalancer <i class="conum" data-value="1"></i><b>(1)</b>
    nodePort: 30000 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Exposes Infinispan on the network through a load balancer service on port <code>11222</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Optionally defines a node port to which the load balancer service forwards traffic.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
<li>
<p>Verify that the <code>-external</code> service is available.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get services | grep external

NAME                         TYPE            CLUSTER-IP    EXTERNAL-IP   PORT(S)
example-infinispan-external  LoadBalancer    192.0.2.24    hostname.com  11222/TCP</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="exposing_nodeport-access">6.3. Exposing Infinispan Through Node Ports</h3>
<div class="paragraph">
<p>Use a node port service to expose Infinispan clusters on the network.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Include <code>spec.expose</code> in your <strong>Infinispan</strong> CR.</p>
</li>
<li>
<p>Specify <code>NodePort</code> as the service type with <code>spec.expose.type</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  ...
  expose:
    type: NodePort <i class="conum" data-value="1"></i><b>(1)</b>
    nodePort: 30000 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Exposes Infinispan on the network through a node port service.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Defines the port where Infinispan is exposed. If you do not define a port,
the platform selects one.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
<li>
<p>Verify that the <code>-external</code> service is available.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get services | grep external

NAME                         TYPE            CLUSTER-IP       EXTERNAL-IP   PORT(S)
example-infinispan-external  NodePort        192.0.2.24       &lt;none&gt;        11222:30000/TCP</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="exposing_routes-access">6.4. Exposing Infinispan Through Routes</h3>
<div class="paragraph">
<p>Use a Kubernetes Ingress or an OpenShift Route with passthrough encryption to
make Infinispan clusters available on the network.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Include <code>spec.expose</code> in your <strong>Infinispan</strong> CR.</p>
</li>
<li>
<p>Specify <code>Route</code> as the service type with <code>spec.expose.type</code>.</p>
</li>
<li>
<p>Optionally add a hostname with <code>spec.expose.host</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  ...
  expose:
    type: Route <i class="conum" data-value="1"></i><b>(1)</b>
    host: www.example.org <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Exposes Infinispan on the network through a Kubernetes Ingress or OpenShift Route.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Optionally specifies the hostname where Infinispan is exposed.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
<li>
<p>Verify that the  is available.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get ingress

NAME                 CLASS    HOSTS   ADDRESS   PORTS   AGE
example-infinispan   &lt;none&gt;   *                 80      73s</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authentication">7. Configuring Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Application users must authenticate with Infinispan clusters. Infinispan Operator
generates default credentials or you can add your own.</p>
</div>
<div class="sect2">
<h3 id="default_credentials-security">7.1. Default Credentials</h3>
<div class="paragraph">
<p>Infinispan Operator generates base64-encoded default credentials stored in an authentication secret named <code>example-infinispan-generated-secret</code></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Username</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>developer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default application user.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>operator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Internal user that interacts with Infinispan clusters.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="getting_credentials-security">7.2. Retrieving Credentials</h3>
<div class="paragraph">
<p>Get credentials from authentication secrets to access Infinispan clusters.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Retrieve credentials from authentication secrets, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get secret example-infinispan-generated-secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>Base64-decode credentials.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get secret example-infinispan-generated-secret \
-o jsonpath="{.data.identities\.yaml}" | base64 --decode

credentials:
- username: developer
  password: dIRs5cAAsHIeeRIL
- username: operator
  password: uMBo9CmEdEduYk24</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="identities-security">7.3. Identities File</h3>
<div class="paragraph">
<p>You can define credentials for Infinispan application users and the <strong>operator</strong> user in an <code>identities.yaml</code> file. All users that you add to <code>identities.yaml</code> can access Infinispan clusters and data</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>identities.yaml</code> must include the <strong>operator</strong> user.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Identities File Example</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">credentials:
- username: testuser
  password: testpassword
- username: operator
  password: supersecretoperatorpassword</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding_credentials-security">7.4. Adding Custom Credentials</h3>
<div class="paragraph">
<p>Configure access to Infinispan cluster endpoints with custom credentials.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Define custom credentials in an <code>identities.yaml</code> file.</p>
</li>
<li>
<p>Create an authentication secret from <code>identities.yaml</code> as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl create secret generic --from-file=identities.yaml connect-secret</code></pre>
</div>
</div>
</li>
<li>
<p>Specify the authentication secret with <code>spec.security.endpointSecretName</code> in
your <strong>Infinispan</strong> CR and then apply the changes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  ...
  security:
    endpointSecretName: connect-secret <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifies the name of the authentication secret that contains your
credentials.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Verification</div>
<p>Modifying <code>spec.security.endpointSecretName</code> triggers a cluster restart. You
can watch the Infinispan cluster as Infinispan Operator applies changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get pods -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the Infinispan cluster is running, verify your custom credentials as
follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a remote shell to a Infinispan node, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl exec -it example-infinispan-0 -- /bin/bash</code></pre>
</div>
</div>
</li>
<li>
<p>Check that credentials exist in the <code>users.properties</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ cat /opt/infinispan/server/conf/users.properties</code></pre>
</div>
</div>
</li>
<li>
<p>Exit the remote shell.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ exit</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="securing_endpoints">8. Securing Infinispan Connections</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Encrypt connections between clients and Infinispan nodes with Red Hat OpenShift
service certificates or custom TLS certificates.</p>
</div>
<div class="sect2">
<h3 id="encryption_with_service_ca-security">8.1. Encryption with Red Hat OpenShift Service Certificates</h3>
<div class="paragraph">
<p>Infinispan Operator automatically generates TLS certificates that are signed by the
Red Hat OpenShift service CA. Infinispan Operator then stores the certificates and keys
in a secret so you can retrieve them and use with remote clients.</p>
</div>
<div class="paragraph">
<p>If the Red Hat OpenShift service CA is available, Infinispan Operator adds the following
<code>spec.security.endpointEncryption</code> configuration to the <strong>Infinispan</strong> CR:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  ...
  security:
    endpointEncryption:
      type: Service
      certServiceName: service.beta.openshift.io <i class="conum" data-value="1"></i><b>(1)</b>
      certSecretName: example-infinispan-cert-secret <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifies the Red Hat OpenShift Service.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Names the secret that contains a service certificate, <code>tls.crt</code>, and key, <code>tls.key</code>, in PEM format. If you do not specify a name, Infinispan Operator uses <code>&lt;cluster_name&gt;-cert-secret</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Service certificates use the internal DNS name of the Infinispan cluster as the common name (CN), for example:</p>
</div>
<div class="paragraph">
<p><code>Subject: CN = example-infinispan.mynamespace.svc</code></p>
</div>
<div class="paragraph">
<p>For this reason, service certificates can be fully trusted only inside
OpenShift. If you want to encrypt connections with clients running
outside OpenShift, you should use custom TLS certificates.</p>
</div>
<div class="paragraph">
<p>Service certificates are valid for one year and are automatically replaced
before they expire.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="getting_certs-security">8.1.1. Retrieving TLS Certificates</h4>
<div class="paragraph">
<p>Get TLS certificates from encryption secrets to create client trust stores.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Retrieve <code>tls.crt</code> from encryption secrets as follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get secret example-infinispan-cert-secret \
-o jsonpath='{.data.tls\.crt}' | base64 --decode &gt; tls.crt</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using_custom_tls-security">8.2. Using Custom TLS Certificates</h3>
<div class="paragraph">
<p>Use custom PKCS12 keystore or TLS certificate/key pairs to encrypt connections
between clients and Infinispan clusters.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>Create either a keystore or certificate secret. See:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#ref_tls_cert_secret-security">Certificate Secrets</a></p>
</li>
<li>
<p><a href="#ref_tls_keystore_secret-security">Keystore Secrets</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the encryption secret to your OpenShift namespace, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f tls_secret.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Specify the encryption secret with <code>spec.security.endpointEncryption</code> in your
<strong>Infinispan</strong> CR and then apply the changes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  ...
  security:
    endpointEncryption: <i class="conum" data-value="1"></i><b>(1)</b>
            type: Secret <i class="conum" data-value="2"></i><b>(2)</b>
            certSecretName: tls-secret <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Encrypts traffic to and from Infinispan endpoints.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configures Infinispan to use secrets that contain encryption certificates.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Names the encryption secret.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="ref_tls_cert_secret-security">8.2.1. Certificate Secrets</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: v1
kind: Secret
metadata:
  name: tls-secret
type: Opaque
data:
    tls.key:  "LS0tLS1CRUdJTiBQUk ..." <i class="conum" data-value="1"></i><b>(1)</b>
    tls.crt: "LS0tLS1CRUdJTiBDRVl ..." <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Adds a base64 encoded TLS key.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Adds a base64 encoded TLS certificate.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ref_tls_keystore_secret-security">8.2.2. Keystore Secrets</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: v1
kind: Secret
metadata:
  name: tls-secret
type: Opaque
stringData:
    alias: server <i class="conum" data-value="1"></i><b>(1)</b>
    password: password <i class="conum" data-value="2"></i><b>(2)</b>
data:
    keystore.p12:  "MIIKDgIBAzCCCdQGCSqGSIb3DQEHA..." <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifies an alias for the keystore.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies a password for the keystore.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Adds a base64 encoded keystore.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="backup_sites">9. Configuring Cross-Site Replication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Set up global Infinispan clusters to back up data across sites.</p>
</div>
<div class="sect2">
<h3 id="global_clusters">9.1. Cross-Site Replication with Infinispan Operator</h3>
<div class="paragraph">
<p>If you have Infinispan clusters running in separate locations, use
Infinispan Operator to connect them so you can back up data across sites.</p>
</div>
<div class="paragraph">
<p>For example, in the following illustration, Infinispan Operator manages a
Infinispan cluster at a data center in New York City, <strong>NYC</strong>. At another data
center in London, <strong>LON</strong>, Infinispan Operator also manages a Infinispan cluster.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../topics/images/xsite-ispn.svg" alt="xsite ispn">
</div>
</div>
<div class="paragraph">
<p>Infinispan Operator uses a Kubernetes API to establish a secure connection between
the OpenShift Container Platform clusters in <strong>NYC</strong> and <strong>LON</strong>. Infinispan Operator then creates a
cross-site replication service so Infinispan clusters can back up data across
locations.</p>
</div>
<div class="paragraph">
<p>Each Infinispan cluster has one site master node that coordinates all backup
requests. Infinispan Operator identifies the site master node so that all traffic
through the cross-site replication service goes to the site master.</p>
</div>
<div class="paragraph">
<p>If the current site master node goes offline then a new node becomes site
master. Infinispan Operator automatically finds the new site master node and
updates the cross-site replication service to forward backup requests to it.</p>
</div>
</div>
<div class="sect2">
<h3 id="applying_clusterroles-xsite">9.2. Applying Cluster Roles for Cross-Site Replication</h3>
<div class="paragraph">
<p>During OLM installation, Infinispan Operator sets up cluster roles required for
cross-site replication. If you install Infinispan Operator manually, you must
complete this procedure to set up those cluster roles.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Install <code>clusterrole.yaml</code> and <code>clusterrole_binding.yaml</code> as follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f deploy/clusterrole.yaml
$ kubectl apply -f deploy/clusterrole_binding.yaml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating_minikube_secrets-xsite">9.3. Creating Minikube Site Access Secrets</h3>
<div class="paragraph">
<p>If you run Infinispan Operator in Minikube, you should create secrets that
contain the files that allow different instances of Minikube to authenticate
with each other.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create secrets on each site that contain <code>ca.crt</code>, <code>client.crt</code>, and <code>client.key</code> from your Minikube installation.</p>
<div class="paragraph">
<p>For example, do the following on <strong>LON</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>kubectl create secret generic site-a-secret \
    --from-file=certificate-authority=/opt/minikube/.minikube/ca.crt \
    --from-file=client-certificate=/opt/minikube/.minikube/client.crt \
    --from-file=client-key=/opt/minikube/.minikube/client.key</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating_sa_tokens-xsite">9.4. Creating Service Account Tokens</h3>
<div class="paragraph">
<p>Generate service account tokens on each OpenShift cluster that acts as a
backup location. Clusters use these tokens to authenticate with each other so
Infinispan Operator can create a cross-site replication service.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to an OpenShift cluster.</p>
</li>
<li>
<p>Create a service account.</p>
<div class="paragraph">
<p>For example, create a service account at <strong>LON</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc create sa lon
serviceaccount/lon created</code></pre>
</div>
</div>
</li>
<li>
<p>Add the view role to the service account with the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc policy add-role-to-user view system:serviceaccount:&lt;namespace&gt;:lon</code></pre>
</div>
</div>
</li>
<li>
<p>Repeat the preceding steps on your other OpenShift clusters.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="https://docs.openshift.com/container-platform/4.4/authentication/using-service-accounts-in-applications.html">Using service accounts in applications</a></p>
</div>
</div>
<div class="sect2">
<h3 id="exchanging_sa_tokens-xsite">9.5. Exchanging Service Account Tokens</h3>
<div class="paragraph">
<p>After you create service account tokens on your OpenShift clusters, you
add them to secrets on each backup location. For example, at <strong>LON</strong> you add
the service account token for <strong>NYC</strong>. At <strong>NYC</strong> you add the service account
token for <strong>LON</strong>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Get tokens from each service account.</p>
<div class="paragraph">
<p>Use the following command or get the token from the OpenShift Web Console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc sa get-token lon

eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9...</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to an OpenShift cluster.</p>
</li>
<li>
<p>Add the service account token for a backup location with the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc create secret generic &lt;token-name&gt; --from-literal=token=&lt;token&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, log in to the OpenShift cluster at <strong>NYC</strong> and create a <code>lon-token</code> secret as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc create secret generic lon-token --from-literal=token=eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9...</code></pre>
</div>
</div>
</li>
<li>
<p>Repeat the preceding steps on your other OpenShift clusters.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring_sites-xsite">9.6. Configuring Infinispan Clusters for Cross-Site Replication</h3>
<div class="paragraph">
<p>Configure Infinispan clusters as backup locations so that they can communicate
over a dedicated JGroups transport channel for replicating data.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create secrets that contain service account tokens for each backup location.</p>
</li>
<li>
<p>Ensure that Kubernetes project names match.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To perform cross-site replication, Infinispan Operator requires Infinispan
clusters to have the same name and run in matching namespaces.</p>
</div>
<div class="paragraph">
<p>For example, you create a cluster at <strong>LON</strong> in a project named
<code>xsite-cluster</code>. The cluster at <strong>NYC</strong> must also run in a project
named <code>xsite-cluster</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an <strong>Infinispan</strong> CR for each Infinispan cluster.</p>
</li>
<li>
<p>Specify a matching name for each Infinispan cluster with metadata.name`.</p>
</li>
<li>
<p>Specify the name of the local site with <code>spec.service.sites.local.name</code>.</p>
</li>
<li>
<p>Provide the name, URL, and secret for each Infinispan cluster that acts as a backup location with <code>spec.service.sites.locations</code>.</p>
<div class="paragraph">
<p>The following are example <strong>Infinispan</strong> CR definitions for <strong>LON</strong> and <strong>NYC</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>LON</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 3
  service:
    type: DataGrid
    sites:
      local:
        name: LON
        expose:
          type: LoadBalancer
      locations:
        - name: LON
          url: openshift://api.rhdg-lon.openshift-aws.myhost.com:6443
          secretName: lon-token
        - name: NYC
          url: openshift://api.rhdg-nyc.openshift-aws.myhost.com:6443
          secretName: nyc-token</code></pre>
</div>
</div>
</li>
<li>
<p><strong>NYC</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 2
  service:
    type: DataGrid
    sites:
      local:
        name: NYC
        expose:
          type: LoadBalancer
      locations:
        - name: NYC
          url: openshift://api.rhdg-nyc.openshift-aws.myhost.com:6443
          secretName: nyc-token
        - name: LON
          url: openshift://api.rhdg-lon.openshift-aws.myhost.com:6443
          secretName: lon-token</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Adjust logging levels for cross-site replication as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">...
  logging:
    categories:
      org.jgroups.protocols.TCP: error
      org.jgroups.protocols.relay.RELAY2: fatal</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding configuration decreases logging for JGroups TCP and RELAY2
protocols to reduce excessive messages about cluster backup operations, which
can result in a large number of log files that use container storage.</p>
</div>
</li>
<li>
<p>Configure nodes with any other Data Grid Service resources.</p>
</li>
<li>
<p>Apply the <strong>Infinispan</strong> CRs.</p>
</li>
<li>
<p>Check node logs to verify that Infinispan clusters form a cross-site view, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl logs example-infinispan-0 | grep x-site

INFO  [org.infinispan.XSITE] (jgroups-5,example-infinispan-0-&lt;id&gt;) ISPN000439: Received new x-site view: [NYC]
INFO  [org.infinispan.XSITE] (jgroups-7,example-infinispan-0-&lt;id&gt;) ISPN000439: Received new x-site view: [NYC, LON]</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Next steps</div>
<p>If your clusters have formed a cross-site view, you can start adding backup
locations to caches.</p>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="#ref_xsite_crd-xsite">Cross-Site Replication Resources</a></p>
</li>
<li>
<p><a href="#adding_backup_locations-caches">Adding Backup Locations to Caches</a></p>
</li>
<li>
<p><a href="https://infinispan.org/docs/stable/titles/xsite/xsite.html">Infinispan Guide to Cross-Site Replication</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="ref_xsite_crd-xsite">9.6.1. Cross-Site Replication Resources</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  ...
  service:
    type: DataGrid <i class="conum" data-value="1"></i><b>(1)</b>
    sites:
      local:
        name: LON <i class="conum" data-value="2"></i><b>(2)</b>
        expose:
          type: LoadBalancer <i class="conum" data-value="3"></i><b>(3)</b>
      locations: <i class="conum" data-value="4"></i><b>(4)</b>
      - name: LON <i class="conum" data-value="5"></i><b>(5)</b>
        url: openshift://api.site-a.devcluster.openshift.com:6443 <i class="conum" data-value="6"></i><b>(6)</b>
        secretName: lon-token <i class="conum" data-value="7"></i><b>(7)</b>
      - name: NYC
        url: openshift://api.site-b.devcluster.openshift.com:6443
        secretName: nyc-token
  logging:
    categories:
      org.jgroups.protocols.TCP: error <i class="conum" data-value="8"></i><b>(8)</b>
      org.jgroups.protocols.relay.RELAY2: fatal <i class="conum" data-value="9"></i><b>(9)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifies Data Grid Service. Infinispan supports cross-site replication with Data Grid Service clusters only.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Names the local site for a Infinispan cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Defines the externally exposed service.
<div class="ulist">
<ul>
<li>
<p>Use <code>NodePort</code> for local clusters on the same network.</p>
</li>
<li>
<p>Use <code>LoadBalancer</code> for independent OpenShift clusters.</p>
</li>
</ul>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Provides connection information for all backup locations.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Specifies a backup location that matches <code>.spec.service.sites.local.name</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Specifies a backup location.
<div class="ulist">
<ul>
<li>
<p>Use <code>minikube://</code> if the backup location is a Minikube instance.</p>
</li>
<li>
<p>Use <code>openshift://</code> if the backup location is an OpenShift cluster. You should specify the URL of the Kubernetes API.</p>
</li>
</ul>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Specifies the access secret for a site.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This secret contains different authentication objects, depending on your
Kubernetes environment.</p>
</div>
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Logs error messages for the JGroups TCP protocol.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Logs fatal messages for the JGroups RELAY2 protocol.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="caches">10. Creating Infinispan Caches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add cache definitions that configure how Infinispan stores your data. You can
create caches from configuration templates and valid cache definitions in XML
format through Infinispan Console, Infinispan CLI, Hot Rod clients, or
Infinispan Operator.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>Before you start creating Infinispan caches, ensure that you have:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Infinispan credentials. By default Infinispan requires authentication.</p>
</li>
<li>
<p>Network access to your Infinispan cluster.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Examples in this section use <code>$SERVICE_HOSTNAME</code> to denote the service or route
that provides access to your Infinispan cluster.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="creating_caches_console-caches">10.1. Creating Caches with Infinispan Console</h3>
<div class="paragraph">
<p>Access the console to create caches from templates or valid configuration in
XML or JSON format.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Access the console from any browser at <code>$SERVICE_HOSTNAME:11222</code></p>
</li>
<li>
<p>Log in with your Infinispan credentials.</p>
</li>
<li>
<p>Select <strong>Go to the console</strong>.</p>
</li>
<li>
<p>Open the <strong>Data Container</strong> view.</p>
</li>
<li>
<p>Select <strong>Create Cache</strong> and then add a cache.</p>
</li>
<li>
<p>Return to the <strong>Data Container</strong> view and verify your Infinispan cache.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating_caches_cli-caches">10.2. Creating Caches with Infinispan CLI</h3>
<div class="paragraph">
<p>Use the command line interface (CLI) to create caches on your Infinispan
cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Download Infinispan Server.</p>
<div class="paragraph">
<p>The CLI is available as part of the server distribution, which you can run on your local host to establish remote connections to Infinispan clusters on OpenShift.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can also open a remote shell to a Infinispan node and access the CLI from there. However, doing this means you must create configuration files on each node when adding caches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl exec -it example-infinispan-0 -- /bin/bash</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a CLI connection to your Infinispan cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ bin/cli.sh -c https://$SERVICE_HOSTNAME:11222/ --trustall</code></pre>
</div>
</div>
</li>
<li>
<p>Enter your Infinispan credentials when prompted.</p>
</li>
<li>
<p>Add cache definitions with the <code class="command">create cache</code> command.</p>
<div class="ulist">
<ul>
<li>
<p>Add a cache definition from an XML or JSON file with the <code class="command">--file</code> option.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>[//containers/default]&gt; create cache --file=configuration.xml mycache</code></pre>
</div>
</div>
</li>
<li>
<p>Add a cache definition from a template with the <code class="command">--template</code> option.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>[//containers/default]&gt; create cache --template=org.infinispan.DIST_SYNC mycache</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Press the tab key after the <code>--template=</code> argument to list available cache templates.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Verify the cache exists with the <code class="command">ls</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>[//containers/default]&gt; ls caches
mycache</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieve the cache configuration with the <code class="command">describe</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>[//containers/default]&gt; describe caches/mycache</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://infinispan.org/docs/stable/titles/server/server.html#downloading_server_distributions">Downloading Server Distributions</a></p>
</li>
<li>
<p><a href="{cli_docs}">Using the Infinispan Command Line Interface</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="creating_caches_hotrod-caches">10.3. Creating Caches with Hot Rod Java Clients</h3>
<div class="paragraph">
<p>Configure Hot Rod Java clients to connect to Infinispan clusters running on OpenShift.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Configure Hot Rod Java clients with a <code>hotrod-client.properties</code> file in the application classpath or with the <code>ConfigurationBuilder</code> class.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hot Rod clients running outside of OpenShift must use BASIC client intelligence.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Hot Rod client properties</div>
<div class="content">
<pre class="highlight nowrap"><code># Connection
infinispan.client.hotrod.server_list=$SERVICE_HOSTNAME:11222

# Client intelligence
infinispan.client.hotrod.client_intelligence=BASIC

# Authentication
infinispan.client.hotrod.use_auth=true
infinispan.client.hotrod.auth_username=developer
infinispan.client.hotrod.auth_password=$PASSWORD
infinispan.client.hotrod.auth_server_name=$CLUSTER_NAME
infinispan.client.hotrod.sasl_properties.javax.security.sasl.qop=auth
infinispan.client.hotrod.sasl_mechanism=DIGEST-MD5

# Encryption
infinispan.client.hotrod.sni_host_name=$SERVICE_HOSTNAME
# Path to the TLS certificate.
# Clients automatically generate trust stores from certificates.
infinispan.client.hotrod.trust_store_path=tls.crt

# Add configuration for specific caches
infinispan.client.hotrod.cache.my-cache.template_name=org.infinispan.DIST_SYNC
infinispan.client.hotrod.cache.another-cache.configuration=&lt;infinispan&gt;&lt;cache-container&gt;&lt;distributed-cache name=\"another-cache\"/&gt;&lt;/cache-container&gt;&lt;/infinispan&gt;
infinispan.client.hotrod.cache.my-other-cache.configuration_uri=file:/path/to/configuration.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">import org.infinispan.client.hotrod.DefaultTemplate;
import org.infinispan.client.hotrod.RemoteCache;
import org.infinispan.client.hotrod.RemoteCacheManager;
import org.infinispan.client.hotrod.configuration.ClientIntelligence;
import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;
import org.infinispan.client.hotrod.configuration.SaslQop;
import org.infinispan.client.hotrod.impl.ConfigurationProperties;
...

ConfigurationBuilder builder = new ConfigurationBuilder();
      builder.addServer()
               .host("$SERVICE_HOSTNAME")
               .port(ConfigurationProperties.DEFAULT_HOTROD_PORT)
             .security().authentication()
               .username("username")
               .password("password")
               .realm("default")
               .saslQop(SaslQop.AUTH)
               .saslMechanism("DIGEST-MD5")
             .ssl()
               .sniHostName("$SERVICE_HOSTNAME")
               .trustStorePath("/path/to/tls.crt");
      builder.clientIntelligence(ClientIntelligence.BASIC);
      builder.remoteCache("my-cache")
               .templateName(DefaultTemplate.DIST_SYNC);
      builder.remoteCache("another-cache")
               .configuration("&lt;infinispan&gt;&lt;cache-container&gt;&lt;distributed-cache name=\"another-cache\"&gt;&lt;encoding media-type=\"application/x-protostream\"/&gt;&lt;/distributed-cache&gt;&lt;/cache-container&gt;&lt;/infinispan&gt;");
      try (RemoteCacheManager cacheManager = new RemoteCacheManager(builder.build())) {
         // Get a remote cache that does not exist.
         // Rather than return null, create the cache from a template.
         RemoteCache&lt;String, String&gt; cache = cacheManager.getCache("my-cache");
         /// Store a value.
         cache.put("hello", "world");
         // Retrieve the value and print it.
         System.out.printf("key = %s\n", cache.get("hello"));</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://infinispan.org/docs/stable/titles/hotrod_java/hotrod_java.html#configuring_hotrod">Configuring Hot Rod Java Clients</a></p>
</li>
<li>
<p><a href="https://infinispan.org/docs/stable/titles/hotrod_java/hotrod_java.html#create_cache_hotrod">Creating Caches with Hot Rod Java Clients</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="creating_caches_cacheservice-caches">10.4. Adding Caches to Cache Service Nodes</h3>
<div class="paragraph">
<p>Cache Service nodes include a default cache configuration with recommended
settings. This default cache lets you start using Infinispan without the need
to create caches.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Because the default cache provides recommended settings, you should create
caches only as copies of the default. If you want multiple custom caches you
should create Data Grid Service nodes instead of Cache Service nodes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Access the Infinispan Console and provide a copy of the default configuration in XML or JSON format.</p>
</li>
<li>
<p>Use the Infinispan CLI to create a copy from the default cache as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>[//containers/default]&gt; create cache --template=default mycache</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="default_config-caches">10.4.1. Default Cache Configuration</h4>
<div class="paragraph">
<p>The default cache for Cache Service nodes is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container&gt;
    &lt;distributed-cache name="default" <i class="conum" data-value="1"></i><b>(1)</b>
                       mode="SYNC" <i class="conum" data-value="2"></i><b>(2)</b>
                       owners="2"&gt; <i class="conum" data-value="3"></i><b>(3)</b>
      &lt;memory storage="OFF_HEAP" <i class="conum" data-value="4"></i><b>(4)</b>
              max-size="&lt;maximum_size_in_bytes&gt;" <i class="conum" data-value="5"></i><b>(5)</b>
              when-full="REMOVE" /&gt; <i class="conum" data-value="6"></i><b>(6)</b>
      &lt;partition-handling when-split="ALLOW_READ_WRITES" <i class="conum" data-value="7"></i><b>(7)</b>
                          merge-policy="REMOVE_ALL"/&gt; <i class="conum" data-value="8"></i><b>(8)</b>
    &lt;/distributed-cache&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Names the cache instance as "default".</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Uses synchronous distribution for storing data across the cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configures two replicas of each cache entry on the cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Stores cache entries as bytes in native memory (off-heap).</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Defines the maximum size for the data container in bytes. Infinispan Operator calculates the maximum size when it creates nodes.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Evicts cache entries to control the size of the data container. You can enable automatic scaling so that Infinispan Operator adds nodes when memory usage increases instead of removing entries.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Names a conflict resolution strategy that allows read and write operations for cache entries, even if segment owners are in different partitions.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Specifies a merge policy that removes entries from the cache when Infinispan detects conflicts.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating_caches_operator-caches">10.5. Creating Caches with Infinispan Operator</h3>
<div class="paragraph">
<p>To create caches with Infinispan Operator, you use <strong>Cache</strong> CRs to add caches
from templates or XML configuration.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Creating caches with Infinispan Operator is available as a technology preview.</p>
</div>
<div class="paragraph">
<p>Technology Preview features or capabilities are not supported with Red Hat
production service-level agreements (SLAs) and might not be functionally
complete. Red Hat does not recommend using them for production. These features
provide early access to upcoming product features, enabling customers to test
functionality and provide feedback during the development process.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When using <strong>Cache</strong> CRs, the following rules apply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Cache</strong> CRs apply to Data Grid Service nodes only.</p>
</li>
<li>
<p>You can create a single cache for each <strong>Cache</strong> CR.</p>
</li>
<li>
<p>If your <strong>Cache</strong> CR contains both a template and an XML configuration, Infinispan Operator uses the template.</p>
</li>
<li>
<p>If you edit caches in the OpenShift Web Console, the changes are reflected through the user interface but do not take effect on the Infinispan cluster. You cannot edit caches. To change cache configuration, you must first delete the cache through the console or CLI and then re-create the cache.</p>
</li>
<li>
<p>Deleting <strong>Cache</strong> CRs in the OpenShift Web Console, does not remove caches from Infinispan clusters. You must delete caches through the console or CLI.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="https://access.redhat.com/support/offerings/techpreview/">Red Hat Technology Preview Features Support Scope</a></p>
</div>
<div class="sect3">
<h4 id="cache_auth-caches">10.5.1. Adding Credentials to Create Caches</h4>
<div class="paragraph">
<p>Infinispan Operator must authenticate with Data Grid Service clusters to create
caches. You add credentials to a secret so that Infinispan Operator can access your
cluster when creating caches.</p>
</div>
<div class="paragraph">
<p>The following procedure explains how to add credentials to a new secret. If you
have a custom secret that contains credentials, you can use that instead of
creating a new one.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Define a <strong>Secret</strong> object type that provides valid user credentials for
accessing Data Grid Service clusters in a <code>StringData</code> map.</p>
<div class="paragraph">
<p>For example, create an <code>basic-auth.yaml</code> file that provides credentials for
the <code>developer</code> user as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: v1
stringData:
  username: developer <i class="conum" data-value="1"></i><b>(1)</b>
  password: G8ZdJvSaY3lOOwfM <i class="conum" data-value="2"></i><b>(2)</b>
kind: Secret
metadata:
  name: basic-auth <i class="conum" data-value="3"></i><b>(3)</b>
type: Opaque</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Names a user that can create caches.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies the password that corresponds to the user.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifies a name for the secret.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create a secret from the file, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f basic-auth.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="custom_cache_auth-caches">Using Custom Credentials Secrets</h5>
<div class="paragraph">
<p>Infinispan Operator requires that credentials exist as values for the <code>username</code>
and <code>password</code> keys in a secret. If you have a custom secret that contains
Infinispan credentials, but uses different key names, you can override those
names in your <strong>Cache</strong> CR.</p>
</div>
<div class="paragraph">
<p>For example, you have a secret named "my-credentials" that holds a list of
Infinispan users and their passwords as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>stringData:
  app_user1: spock
  app_user1_pw: G8ZdJvSaY3lOOwfM
  app_user2: jim
  app_user2_pw: zTzz2gVyyF4JsYsH</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>In your <strong>Cache</strong> CR, override custom key names with <code>username</code> and <code>password</code> as follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  adminAuth:
    username:
      key: app_user1 <i class="conum" data-value="1"></i><b>(1)</b>
      name: my-credentials <i class="conum" data-value="2"></i><b>(2)</b>
    password:
      key: app_user1_pw <i class="conum" data-value="3"></i><b>(3)</b>
      name: my-credentials</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Overrides the <code>app_user1</code> key name with <code>username</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies the name of your custom credentials secret.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Overrides the <code>app_user1_pw</code> key name with <code>password</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cache_templates-caches">10.5.2. Creating Infinispan Caches from Templates</h4>
<div class="paragraph">
<p>Complete the following steps to create caches on Data Grid Service clusters
using cache configuration templates.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a secret that contains valid user credentials for accessing
Infinispan clusters.</p>
</li>
<li>
<p>Identify the cache configuration template you want to use for your cache. You
can find a list of available configuration templates in Infinispan Console.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <strong>Cache</strong> CR that specifies the name of the template you want to use.</p>
<div class="paragraph">
<p>For example, the following CR creates a cache named "mycache" that uses the <code>org.infinispan.DIST_SYNC</code> cache configuration template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: infinispan.org/v2alpha1
kind: Cache
metadata:
  name: mycachedefinition <i class="conum" data-value="1"></i><b>(1)</b>
spec:
  adminAuth: <i class="conum" data-value="2"></i><b>(2)</b>
    secretName: basic-auth
  clusterName: example-infinispan <i class="conum" data-value="3"></i><b>(3)</b>
  name: mycache <i class="conum" data-value="4"></i><b>(4)</b>
  templateName: org.infinispan.DIST_SYNC <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Names the <strong>Cache</strong> CR.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies a secret that provides credentials with <code>username</code> and <code>password</code> keys or an override for custom credentials secrets.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifies the name of the target Infinispan cluster where you want Infinispan Operator to create the cache.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Names the Infinispan cache instance.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Specifies the <code>infinispan.org</code> cache configuration template to create the cache.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Apply the <strong>Cache</strong> CR, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f mycache.yaml
cache.infinispan.org/mycachedefinition created</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="cache_xml-caches">10.5.3. Creating Infinispan Caches from XML</h4>
<div class="paragraph">
<p>Complete the following steps to create caches on Data Grid Service clusters
using valid <code>infinispan.xml</code> cache definitions.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a secret that contains valid user credentials for accessing
Infinispan clusters.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <strong>Cache</strong> CR that contains the XML cache definition you want to
create.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: infinispan.org/v2alpha1
kind: Cache
metadata:
  name: mycachedefinition <i class="conum" data-value="1"></i><b>(1)</b>
spec:
  adminAuth: <i class="conum" data-value="2"></i><b>(2)</b>
    secretName: basic-auth
  clusterName: example-infinispan <i class="conum" data-value="3"></i><b>(3)</b>
  name: mycache <i class="conum" data-value="4"></i><b>(4)</b>
  template: &lt;infinispan&gt;&lt;cache-container&gt;&lt;distributed-cache name="mycache" mode="SYNC"&gt;&lt;persistence&gt;&lt;file-store/&gt;&lt;/persistence&gt;&lt;/distributed-cache&gt;&lt;/cache-container&gt;&lt;/infinispan&gt; <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Names the <strong>Cache</strong> CR.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies a secret that provides credentials with <code>username</code> and <code>password</code> keys or an override for custom credentials secrets.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifies the name of the target Infinispan cluster where you want Infinispan Operator to create the cache.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Names the cache on the Infinispan cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Specifies the XML cache definition to create the cache. Note that the <code>name</code> attribute is ignored. Only <code>spec.name</code> applies to the resulting cache.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Apply the <strong>Cache</strong> CR, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f mycache.yaml
cache.infinispan.org/mycachedefinition created</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding_backup_locations-caches">10.6. Adding Backup Locations to Caches</h3>
<div class="paragraph">
<p>When you configure Infinispan clusters to perform cross-site replication, you
can add backup locations to your cache configurations.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create cache configurations with identical names for each site.</p>
<div class="paragraph">
<p>Cache configurations at each site can use different cache modes and backup
strategies. Infinispan replicates data based on cache names.</p>
</div>
</li>
<li>
<p>Configure backup locations to go offline automatically with the <code>take-offline</code> element.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Set the amount of time, in milliseconds, before backup locations go offline with the <code>min-wait</code> attribute.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Define any other valid cache configuration.</p>
</li>
<li>
<p>Add backup locations to the named cache on all sites in the global cluster.</p>
<div class="paragraph">
<p>For example, if you add <strong>LON</strong> as a backup for <strong>NYC</strong> you should add <strong>NYC</strong>
as a backup for <strong>LON</strong>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following configuration examples show backup locations for caches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>NYC</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container&gt;
    &lt;distributed-cache name="customers"&gt;
      &lt;encoding media-type="application/x-protostream"/&gt;
      &lt;backups&gt;
        &lt;backup site="LON" strategy="SYNC"&gt;
          &lt;take-offline min-wait="120000"/&gt;
        &lt;/backup&gt;
      &lt;/backups&gt;
    &lt;/distributed-cache&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><strong>LON</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container&gt;
    &lt;replicated-cache name="customers"&gt;
      &lt;encoding media-type="application/x-protostream"/&gt;
      &lt;backups&gt;
        &lt;backup site="NYC" strategy="ASYNC" &gt;
            &lt;take-offline min-wait="120000"/&gt;
          &lt;/backup&gt;
      &lt;/backups&gt;
    &lt;/replicated-cache&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="#configuring_sites-xsite">Configuring Clusters for Cross-Site Replication</a></p>
</li>
<li>
<p><a href="https://infinispan.org/docs/stable/titles/xsite/xsite.html">Infinispan Guide to Cross-Site Replication</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="backups_automatic_offline-caches">10.6.1. Performance Considerations with Taking Backup Locations Offline</h4>
<div class="paragraph">
<p>Backup locations can automatically go offline when remote sites become
unavailable. This prevents nodes from attempting to replicate data to offline
backup locations, which can have a performance impact on your cluster because it
results in error.</p>
</div>
<div class="paragraph">
<p>You can configure how long to wait before backup locations go offline. A good
rule of thumb is one or two minutes. However, you should test different wait
periods and evaluate their performance impacts to determine the correct value
for your deployment.</p>
</div>
<div class="paragraph">
<p>For instance when OpenShift terminates the site master pod, that backup
location becomes unavailable for a short period of time until Infinispan Operator
elects a new site master. In this case, if the minimum wait time is not long
enough then the backup locations go offline. You then need to bring those
backup locations online and perform state transfer operations to ensure the
data is in sync.</p>
</div>
<div class="paragraph">
<p>Likewise, if the minimum wait time is too long, node CPU usage increases from
failed backup attempts which can lead to performance degradation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding_cache_stores-caches">10.7. Adding Persistent Cache Stores</h3>
<div class="paragraph">
<p>You can add Single File cache stores to Data Grid Service nodes to save data to
the persistent volume.</p>
</div>
<div class="paragraph">
<p>You configure cache stores as part of your Infinispan cache definition with
the <code>persistence</code> element as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;persistence&gt;
   &lt;file-store/&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan then creates a Single File cache store, <code>.dat</code> file, in the
<code>/opt/infinispan/server/data</code> directory.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Add a cache store to your cache configurations as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container&gt;
    &lt;distributed-cache name="customers" mode="SYNC"&gt;
      &lt;encoding media-type="application/x-protostream"/&gt;
      &lt;persistence&gt;
        &lt;file-store/&gt;
      &lt;/persistence&gt;
    &lt;/distributed-cache&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="#storage_resources-resources">Storage Resources</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prometheus">11. Monitoring Infinispan with Prometheus</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan exposes a metrics endpoint that provides statistics and events to
Prometheus.</p>
</div>
<div class="sect2">
<h3 id="_setting_up_prometheus">11.1. Setting Up Prometheus</h3>
<div class="paragraph">
<p>Set up Prometheus so it can authenticate with and monitor Infinispan clusters.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Install the Prometheus Operator.</p>
</li>
<li>
<p>Create a running Prometheus instance.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add an authentication secret to your Prometheus namespace.</p>
<div class="paragraph">
<p>This secret allows Prometheus to authenticate with your Infinispan cluster. You can find Infinispan credentials in the authentication secret in your Infinispan Operator namespace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: v1
stringData:
  username: developer <i class="conum" data-value="1"></i><b>(1)</b>
  password: dIRs5cAAsHIeeRIL <i class="conum" data-value="2"></i><b>(2)</b>
kind: Secret
metadata:
  name: basic-auth
type: Opaque</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifies an application user. <code>developer</code> is the default application user.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies a corresponding password.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create a service monitor instance that configures Prometheus to monitor your Infinispan cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    k8s-app: prometheus
  name: datagrid-monitoring <i class="conum" data-value="1"></i><b>(1)</b>
  namespace: infinispan-monitoring <i class="conum" data-value="2"></i><b>(2)</b>
spec:
  endpoints:
    - basicAuth:
        username:
          key: username
          name: basic-auth <i class="conum" data-value="3"></i><b>(3)</b>
        password:
          key: password
          name: basic-auth <i class="conum" data-value="4"></i><b>(4)</b>
      interval: 30s
      scheme: https <i class="conum" data-value="5"></i><b>(5)</b>
      tlsConfig:
        insecureSkipVerify: true
        serverName: certificate-CN <i class="conum" data-value="6"></i><b>(6)</b>
  namespaceSelector:
    matchNames:
      - infinispan <i class="conum" data-value="7"></i><b>(7)</b>
  selector:
    matchLabels:
      app: infinispan-service
      clusterName: cluster-name <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Names the service monitor.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies your Prometheus namespace.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifies the name of the authentication secret that has Infinispan credentials.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specifies the name of the authentication secret that has Infinispan credentials.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Specifies that Infinispan endpoints use encryption. If you do not use TLS, remove <code>spec.endpoints.scheme</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Specifies the Common Name (CN) of the TLS certificate for Infinispan encryption. If you use an OpenShift service certificate, the CN matches the <code>metadata.name</code> resource for your Infinispan cluster. If you do not use TLS, remove <code>spec.endpoints.tlsConfig</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>specifies the Infinispan Operator namespace.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>specifies the name of the Infinispan cluster.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="logging">12. Monitoring Infinispan Logs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Set logging categories to different message levels to monitor, debug, and
troubleshoot Infinispan clusters.</p>
</div>
<div class="sect2">
<h3 id="configure_logging-monitor">12.1. Configuring Infinispan Logging</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify logging configuration with <code>spec.logging</code> in your <strong>Infinispan</strong> CR
and then apply the changes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  ...
  logging: <i class="conum" data-value="1"></i><b>(1)</b>
    categories: <i class="conum" data-value="2"></i><b>(2)</b>
      org.infinispan: debug <i class="conum" data-value="3"></i><b>(3)</b>
      org.jgroups: debug</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configures Infinispan logging.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Adds logging categories.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Names logging categories and levels.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The root logging category is <code>org.infinispan</code> and is <code>INFO</code> by default.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Retrieve logs from Infinispan nodes as required.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl logs -f $POD_NAME</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_log_levels">12.2. Log Levels</h3>
<div class="paragraph">
<p>Log levels indicate the nature and severity of messages.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Log level</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">trace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides detailed information about running state of applications. This is the most verbose log level.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">debug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates the progress of individual requests or activities.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">info</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates overall progress of applications, including lifecycle events.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">warn</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates circumstances that can lead to error or degrade performance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates error conditions that might prevent operations or activities from being successful but do not prevent applications from running.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="operator_reference">13. Reference</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Find information about Infinispan services and clusters that you create with
Infinispan Operator.</p>
</div>
<div class="sect2">
<h3 id="ref_image_crd-ref">13.1. Image Resource</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  image: infinispan/server:latest <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Lets you specify a Infinispan image to use.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ref_services-ref">13.2. Network Services</h3>
<div class="ulist">
<div class="title">Internal service</div>
<ul>
<li>
<p>Allow Infinispan nodes to discover each other and form clusters.</p>
</li>
<li>
<p>Provide access to Infinispan endpoints from clients in the same Kubernetes namespace.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Port</th>
<th class="tableblock halign-left valign-top">Protocol</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>11222</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Internal access to Infinispan endpoints</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-ping</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>8888</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster discovery</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">External service</div>
<p>Provides access to Infinispan endpoints from clients outside Kubernetes or in different namespaces.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You must create the external service with Infinispan Operator. It is not available
by default.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Port</th>
<th class="tableblock halign-left valign-top">Protocol</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-external</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>11222</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">External access to Infinispan endpoints.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Cross-site service</div>
<p>Allows Infinispan to back up data between clusters in different locations.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Port</th>
<th class="tableblock halign-left valign-top">Protocol</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-site</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7900</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JGroups RELAY2 channel for cross-site communication.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="#network_services">Creating Network Services</a></p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-09-08 10:14:34 -0400
</div>
</div>
</body>
</html>