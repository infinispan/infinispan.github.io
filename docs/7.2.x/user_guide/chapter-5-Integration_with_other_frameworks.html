<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="generator" content="Asciidoctor 0.1.4"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Integration with other frameworks</title> <style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }
audio, canvas, video { display: inline-block; }
audio:not([controls]) { display: none; height: 0; }
[hidden] { display: none; }
html { background: #fff; color: #000; font-family: sans-serif; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; }
body { margin: 0; }
a:focus { outline: thin dotted; }
a:active, a:hover { outline: 0; }
h1 { font-size: 2em; margin: 0.67em 0; }
abbr[title] { border-bottom: 1px dotted; }
b, strong { font-weight: bold; }
dfn { font-style: italic; }
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }
mark { background: #ff0; color: #000; }
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }
pre { white-space: pre-wrap; }
q { quotes: "\201C" "\201D" "\2018" "\2019"; }
small { font-size: 80%; }
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }
img { border: 0; }
svg:not(:root) { overflow: hidden; }
figure { margin: 0; }
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }
legend { border: 0; padding: 0; }
button, input, select, textarea { font-family: inherit; font-size: 100%; margin: 0; }
button, input { line-height: normal; }
button, select { text-transform: none; }
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; cursor: pointer; }
button[disabled], html input[disabled] { cursor: default; }
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; padding: 0; }
input[type="search"] { -webkit-appearance: textfield; -moz-box-sizing: content-box; -webkit-box-sizing: content-box; box-sizing: content-box; }
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }
textarea { overflow: auto; vertical-align: top; }
table { border-collapse: collapse; border-spacing: 0; }
*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
html, body { font-size: 100%; }
body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }
a:hover { cursor: pointer; }
a:focus { outline: none; }
img, object, embed { max-width: 100%; height: auto; }
object, embed { height: 100%; }
img { -ms-interpolation-mode: bicubic; }
#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }
.left { float: left !important; }
.right { float: right !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-center { text-align: center !important; }
.text-justify { text-align: justify !important; }
.hide { display: none; }
.antialiased, body { -webkit-font-smoothing: antialiased; }
img { display: inline-block; vertical-align: middle; }
textarea { height: auto; min-height: 50px; }
select { width: 100%; }
p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }
.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #7a2518; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }
a { color: #005498; text-decoration: underline; line-height: inherit; }
a:hover, a:focus { color: #00467f; }
a img { border: none; }
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Georgia, "URW Bookman L", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; color: #ba3925; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #e99b8f; line-height: 0; }
h1 { font-size: 2.125em; }
h2 { font-size: 1.6875em; }
h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }
h4 { font-size: 1.125em; }
h5 { font-size: 1.125em; }
h6 { font-size: 1em; }
hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }
em, i { font-style: italic; line-height: inherit; }
strong, b { font-weight: bold; line-height: inherit; }
small { font-size: 60%; line-height: inherit; }
code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; color: #6d180b; }
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }
ul, ol { margin-left: 1.5em; }
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }
abbr { text-transform: none; }
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: inherit; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }
blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }
.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }
@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
.print-only { display: none !important; }
@media print { * { background: transparent !important; color: #000 !important; box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.6; }
.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }
*:not(pre) > code { font-size: 0.9375em; padding: 1px 3px 0; white-space: nowrap; background-color: #f2f2f2; border: 1px solid #cccccc; -webkit-border-radius: 4px; border-radius: 4px; text-shadow: none; }
pre, pre > code { line-height: 1.4; color: inherit; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }
kbd.keyseq { color: #555555; }
kbd:not(.keyseq) { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }
kbd kbd:first-child { margin-left: 0; }
kbd kbd:last-child { margin-right: 0; }
.menuseq, .menu { color: #090909; }
p a > code:hover { color: #561309; }
#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }
#header { margin-bottom: 2.5em; }
#header > h1 { color: black; font-weight: normal; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #6f6f6f; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }
#toc { border-bottom: 3px double #ebebeb; padding-bottom: 1.25em; }
#toc > ul { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }
#toctitle { color: #7a2518; }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #ebebeb; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul { font-size: .95em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1.25em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #ebebeb; left: auto; right: 0; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; border-width: 0; -webkit-border-radius: 4px; border-radius: 4px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }
#content #toctitle { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-size: 1em; padding-left: 0.125em; }
#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }
#footer-text { color: #dddddd; line-height: 1.44; }
.sect1 { padding-bottom: 1.25em; }
.sect1 + .sect1 { border-top: 3px double #ebebeb; }
#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #ba3925; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #a53221; }
.imageblock, .literalblock, .listingblock, .verseblock, .videoblock { margin-bottom: 1.25em; }
.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }
.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }
table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }
.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #6f6f6f; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }
.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 4px; border-radius: 4px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }
.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #d9d9d9; box-shadow: 0 1px 8px #d9d9d9; }
.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 4px; border-radius: 4px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #7a2518; margin-top: 0; line-height: 1.6; }
.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }
.literalblock > .content pre, .listingblock > .content pre { background: none; border-width: 1px 0; border-style: dotted; border-color: #bfbfbf; -webkit-border-radius: 4px; border-radius: 4px; padding: 0.75em 0.75em 0.5em 0.75em; word-wrap: break-word; }
.literalblock > .content pre.nowrap, .listingblock > .content pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content pre > code, .listingblock > .content pre > code { display: block; }
@media only screen { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.8em; } }
@media only screen and (min-width: 768px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.9em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 1em; } }
.listingblock > .content { position: relative; }
.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.375em; right: 0.375em; }
.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }
.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }
.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }
table.pyhltable { border: 0; margin-bottom: 0; }
table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }
table.pyhltable td.code { padding-left: .75em; padding-right: 0; }
.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }
.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }
table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }
.quoteblock { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 1.25em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: inherit; color: #555555; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }
table thead th, table tfoot th { font-weight: bold; }
table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 4px; border-radius: 4px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }
table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }
table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }
table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }
th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }
th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }
th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }
th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }
th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }
th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }
p.tableblock.header { color: #222222; font-weight: bold; }
td > div.verse { white-space: pre; }
ol { margin-left: 1.75em; }
ul li ol { margin-left: 1.5em; }
dl dd { margin-left: 1.125em; }
dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }
ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }
ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }
ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }
ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }
ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }
ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }
.unstyled dl dt { font-weight: normal; font-style: normal; }
ol.arabic { list-style-type: decimal; }
ol.decimal { list-style-type: decimal-leading-zero; }
ol.loweralpha { list-style-type: lower-alpha; }
ol.upperalpha { list-style-type: upper-alpha; }
ol.lowerroman { list-style-type: lower-roman; }
ol.upperroman { list-style-type: upper-roman; }
ol.lowergreek { list-style-type: lower-greek; }
.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }
td.hdlist1 { padding-right: .8em; font-weight: bold; }
td.hdlist1, td.hdlist2 { vertical-align: top; }
.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }
.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }
.qanda > ol > li > p > em:only-child { color: #00467f; }
.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }
.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }
.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }
a.image { text-decoration: none; }
span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }
.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }
div.unbreakable { page-break-inside: avoid; }
.big { font-size: larger; }
.small { font-size: smaller; }
.underline { text-decoration: underline; }
.overline { text-decoration: overline; }
.line-through { text-decoration: line-through; }
.aqua { color: #00bfbf; }
.aqua-background { background-color: #00fafa; }
.black { color: black; }
.black-background { background-color: black; }
.blue { color: #0000bf; }
.blue-background { background-color: #0000fa; }
.fuchsia { color: #bf00bf; }
.fuchsia-background { background-color: #fa00fa; }
.gray { color: #606060; }
.gray-background { background-color: #7d7d7d; }
.green { color: #006000; }
.green-background { background-color: #007d00; }
.lime { color: #00bf00; }
.lime-background { background-color: #00fa00; }
.maroon { color: #600000; }
.maroon-background { background-color: #7d0000; }
.navy { color: #000060; }
.navy-background { background-color: #00007d; }
.olive { color: #606000; }
.olive-background { background-color: #7d7d00; }
.purple { color: #600060; }
.purple-background { background-color: #7d007d; }
.red { color: #bf0000; }
.red-background { background-color: #fa0000; }
.silver { color: #909090; }
.silver-background { background-color: #bcbcbc; }
.teal { color: #006060; }
.teal-background { background-color: #007d7d; }
.white { color: #bfbfbf; }
.white-background { background-color: #fafafa; }
.yellow { color: #bfbf00; }
.yellow-background { background-color: #fafa00; }
span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }
.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #005498; color: #003f72; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }
.conum { display: inline-block; color: white !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }
.literalblock > .content > pre, .listingblock > .content > pre { -webkit-border-radius: 0; border-radius: 0; }

</style> <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.min.css"> <style>
/* Foundation stylesheet for CodeRay (to match GitHub theme) | MIT License | http://foundation.zurb.com */
table.CodeRay { border-collapse: collapse; padding: 2px; margin-bottom: 0; border: 0; background: transparent; }
table.CodeRay td { padding: 0 .5em; vertical-align: top; }
table.CodeRay td.line-numbers { text-align: right; color: #999; border-right: 1px solid #e5e5e5; padding-left: 0; }
span.line-numbers { border-right: 1px solid #E5E5E5; color: #999; display: inline-block; margin-right: 0.5em; padding-right: 0.5em; }
.CodeRay td.line-numbers strong, .CodeRay span.line-numbers strong { font-weight: normal; }
.CodeRay .debug { color: white !important; background: blue !important; }
.CodeRay .annotation { color: #007; }
.CodeRay .attribute-name { color: #f08; }
.CodeRay .attribute-value { color: #700; }
.CodeRay .binary { color: #509; }
.CodeRay .comment  { color: #999; font-style: italic; }
.CodeRay .char { color: #04D; }
.CodeRay .char .content { color: #04D; }
.CodeRay .char .delimiter { color: #039; }
.CodeRay .class { color: #458; }
.CodeRay .complex { color: #A08; }
.CodeRay .constant { color: teal; }
.CodeRay .color { color: #0A0; }
.CodeRay .class-variable { color: #369; }
.CodeRay .decorator { color: #B0B; }
.CodeRay .definition { color: #099; }
.CodeRay .directive { color: #088; }
.CodeRay .delimiter { color: black; }
.CodeRay .doc { color: #970; }
.CodeRay .doctype { color: #34b; }
.CodeRay .doc-string { color: #D42; }
.CodeRay .escape  { color: #666; }
.CodeRay .entity { color: #800; }
.CodeRay .error { color: #808; }
.CodeRay .exception { color: #C00; }
.CodeRay .filename { color: #099; }
.CodeRay .function { color: #900; }
.CodeRay .global-variable { color: teal; }
.CodeRay .hex { color: #058; }
.CodeRay .integer  { color: #099; }
.CodeRay .include { color: #B44; }
.CodeRay .inline { color: black; }
.CodeRay .inline .inline { background: #ccc; }
.CodeRay .inline .inline .inline { background: #bbb; }
.CodeRay .inline .inline-delimiter { color: #D14; }
.CodeRay .inline-delimiter { color: #D14; }
.CodeRay .important { color: #f00; }
.CodeRay .interpreted { color: #B2B; }
.CodeRay .instance-variable { color: teal; }
.CodeRay .label { color: #970; }
.CodeRay .local-variable { color: #963; }
.CodeRay .octal { color: #40E; }
.CodeRay .predefined { color: #369; }
.CodeRay .preprocessor { color: #579; }
.CodeRay .pseudo-class { color: #00C; }
.CodeRay .predefined-type { color: #074; }
.CodeRay .reserved, .keyword  { color: #000; }
.CodeRay .key { color: #808; }
.CodeRay .key .delimiter { color: #606; }
.CodeRay .key .char { color: #80f; }
.CodeRay .value { color: #088; }
.CodeRay .regexp { background-color: #fff0ff; }
.CodeRay .regexp .content { color: #808; }
.CodeRay .regexp .delimiter { color: #404; }
.CodeRay .regexp .modifier { color: #C2C; }
.CodeRay .regexp .function  { color: #404; font-weight: bold; }
.CodeRay .string { color: #D20; }
.CodeRay .string .string { }
.CodeRay .string .string .string { background-color: #ffd0d0; }
.CodeRay .string .content { color: #D14; }
.CodeRay .string .char { color: #D14; }
.CodeRay .string .delimiter { color: #D14; }
.CodeRay .shell { color: #D14; }
.CodeRay .shell .content { }
.CodeRay .shell .delimiter { color: #D14; }
.CodeRay .symbol { color: #990073; }
.CodeRay .symbol .content { color: #A60; }
.CodeRay .symbol .delimiter { color: #630; }
.CodeRay .tag, .CodeRay .attribute-name { color: #070; }
.CodeRay .tag-special { color: #D70; }
.CodeRay .type { color: #339; }
.CodeRay .variable  { color: #036; }
.CodeRay .insert { background: #afa; }
.CodeRay .delete { background: #faa; }
.CodeRay .change { color: #aaf; background: #007; }
.CodeRay .head { color: #f8f; background: #505; }
.CodeRay .insert .insert { color: #080; }
.CodeRay .delete .delete { color: #800; }
.CodeRay .change .change { color: #66f; }
.CodeRay .head .head { color: #f4f; }

</style> </head> <body class="book"> <div id="header"> </div> <div id="content"> <div class="sect1"> <h2 id="_integration_with_other_frameworks"><a class="anchor" href="#_integration_with_other_frameworks"></a>1. Integration with other frameworks</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan can be integrated with a number of other frameworks, as detailed below.</p> </div> <div class="sect2"> <h3 id="_using_infinispan_as_jpa_hibernate_second_level_cache_provider"><a class="anchor" href="#_using_infinispan_as_jpa_hibernate_second_level_cache_provider"></a>1.1. Using Infinispan as JPA-Hibernate Second Level Cache Provider</h3> <div class="paragraph"> <p>Following some of the principles set out by Brian Stansberry in <a href="http://community.jboss.org/docs/14247">Using JBoss Cache 3 as a Hibernate 3.5 Second Level Cache</a> and taking in account improvements introduced by Infinispan, an Infinispan JPA/Hibernate second level cache provider has been developed. This wiki explains how to configure JPA/Hibernate to use the Infinispan and for those keen on lower level details, the key design decisions made and differences with previous JBoss Cache based cache providers.</p> </div> <div class="paragraph"> <p>If you&#8217;re unfamiliar with JPA/Hibernate Second Level Caching, I&#8217;d suggest you to read Chapter 2.1 in <a href="http://www.jboss.org/jbossclustering/docs/hibernate-jbosscache-guide-3.pdf">this guide</a> which explains the different types of data that can be cached.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">On Caching</div> Query result caching, or entity caching, <em>may or may not improve</em> application performance. Be sure to benchmark your application with and without caching. </td> </tr> </table> </div> <div class="sect3"> <h4 id="_configuration"><a class="anchor" href="#_configuration"></a>1.1.1. Configuration</h4> <div class="paragraph"> <p>1. First of all, to enable JPA/Hibernate second level cache with query result caching enabled, add either of the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_second_level_cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_query_cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_second_level_cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_query_cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span>
</code></pre> </div> </div> <div class="paragraph"> <p>2. Now, configure the Infinispan cache region factory using one of the two options below:</p> </div> <div class="ulist"> <ul> <li> <p>If the Infinispan CacheManager instance happens to be bound to JNDI select JndiInfinispanRegionFactory as the cacheregion factory and add the cache manager&#8217;s JNDI name:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.cache.infinispan.JndiInfinispanRegionFactory</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.cachemanager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:CacheManager</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.hibernate.cache.infinispan.JndiInfinispanRegionFactory<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.cachemanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>java:CacheManager/entity<span class="tag">&lt;/property&gt;</span>
</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">JBoss Application Server</div> JBoss Application Server 6 and 7 deploy a shared Infinispan cache manager that can be used by all services, so when trying to configure applications with Infinispan second level cache, you should use the JNDI name for the cache manager responsible for the second level cache. By default, this is "java:CacheManager/entity". In any other application server, you can deploy your own cache manager and bind the CacheManager to JNDI, but in this cases it&#8217;s generally preferred that the following method is used. </td> </tr> </table> </div> <div class="ulist"> <ul> <li> <p>If running JPA/Hibernate and Infinispan standalone or within third party Application Server, select the <em>InfinispanRegionFactory</em> as the cache region factory:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.cache.infinispan.InfinispanRegionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.hibernate.cache.infinispan.InfinispanRegionFactory<span class="tag">&lt;/property&gt;</span>
</code></pre> </div> </div> <div class="paragraph"> <p>This is all the configuration you need to have JPA/Hibernate use Infinispan as cache provider with the default settings. You will still need to define which entities and queries need to be cached as defined in the Hibernate reference documentation, but that configuration aspect is not peculiar to Infinispan. This default configuration should suit the majority of use cases but sometimes, further configuration is required and to help with such situations, please check the following section where more advanced settings are discussed.</p> </div> </div> <div class="sect3"> <h4 id="_default_configuration_explained"><a class="anchor" href="#_default_configuration_explained"></a>1.1.2. Default Configuration Explained</h4> <div class="paragraph"> <p>The aim of this section is to explain the default settings for each of the different global data type (entity, collection, query and timestamps) caches, why these were chosen and what are the available alternatives.</p> </div> <div class="sect4"> <h5 id="_defaults_for_entity_collection_caching"><a class="anchor" href="#_defaults_for_entity_collection_caching"></a>Defaults for Entity/Collection Caching</h5> <div class="ulist"> <ul> <li> <p>For all entities and collections, whenever a new <em>entity or collection is read from database</em> and needs to be cached, <em>it&#8217;s only cached locally</em> in order to reduce intra-cluster traffic. This option cannot be changed.</p> </li> <li> <p>All <em>entities and collections are configured to use a synchronous invalidation</em> as clustering mode. This means that when an entity is updated, the updated cache will send a message to the other members of the cluster telling them that the entity has been modified. Upon receipt of this message, the other nodes will remove this data from their local cache, if it was stored there. This option can be changed to use replication by configuring entities or collections to use "replicated-entity" cache but it&#8217;s generally not a recommended choice.</p> </li> <li> <p>All <em>entities and collections have initial state transfer disabled</em> since there&#8217;s no need for it. It&#8217;s not recommended that this is enabled.</p> </li> <li> <p><em>entities and collections are configured to use READ_COMMITTED</em> as cache isolation level. It would only make sure to configure REPEATABLE_READ if the application evicts/clears entities from the Hibernate Session and then expects to repeatably re-read them in the same transaction. Otherwise, the Session&#8217;s internal cache provides repeatable-read semantics. If you really need to use REPEATABLE_READ, you can simply configure entities or collections to use "entity-repeatable" cache.</p> </li> <li> <p>Entities and collections are configured with the following eviction settings. You can change these settings on a per entity or collection basis or per individual entity or collection type. More information in the "Advanced Configuration" section below.</p> <div class="ulist"> <ul> <li> <p>Eviction wake up interval is 5 seconds.</p> </li> <li> <p>Max number of entries are 10,000</p> </li> <li> <p>Max idle time before expiration is 100 seconds</p> </li> </ul> </div> </li> <li> <p><em>entites and collections are configured with lazy deserialization</em> which helps deserialization when entities or collections are stored in isolated deployments. If you&#8217;re sure you&#8217;ll never deploy your entities or collections in classloader isolated deployment archives, you can disable this setting.</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="_defaults_for_query_caching"><a class="anchor" href="#_defaults_for_query_caching"></a>Defaults for Query Caching</h5> <div class="ulist"> <ul> <li> <p>The query cache is configured so that <em>queries are only cached locally</em> . Alternatively, you can configure query caching to use replication by selecting the "replicated-query" as query cache name. However, replication for query cache only makes sense if, and only if, all of this conditions are true:</p> <div class="ulist"> <ul> <li> <p>Performing the query is quite expensive.</p> </li> <li> <p>The same query is very likely to be repeatedly executed on different cluster nodes.</p> </li> <li> <p>The query is unlikely to be invalidated out of the cache (Note: Hibernate must aggressively invalidate query results from the cache any time any instance of one of the entity types targeted by the query. All such query results are invalidated, even if the change made to the specific entity instance would not have affected the query result)</p> </li> </ul> </div> </li> <li> <p><em>query cache</em> uses the <em>same cache isolation levels and eviction/expiration settings as for entities/collections</em> .</p> </li> <li> <p><em>query cache has initial state transfer disabled</em> . It is not recommended that this is enabled.</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="_defaults_for_timestamps_cache"><a class="anchor" href="#_defaults_for_timestamps_cache"></a>Defaults for Timestamps Cache</h5> <div class="ulist"> <ul> <li> <p>The <em>timestamps cache is configured with asynchronous replication</em> as clustering mode. Local or invalidated cluster modes are not allowed, since all cluster nodes must store all timestamps. As a result, <em>no eviction/expiration is allowed for timestamp caches either</em> .</p> </li> <li> <p>The <em>timestamps cache is configured with a cluster cache loader (in Hibernate 3.6.0 or earlier it had state transfer enabled)</em> so that joining nodes can retrieve all timestamps. You shouldn&#8217;t attempt to disable the cluster cache loader for the timestamps cache.</p> </li> </ul> </div> </div> </div> <div class="sect3"> <h4 id="_jta_transactions_configuration"><a class="anchor" href="#_jta_transactions_configuration"></a>1.1.3. JTA Transactions Configuration</h4> <div class="paragraph"> <p>It is highly recommended that Hibernate is configured with JTA transactions so that both Hibernate and Infinispan cooperate within the same transaction and the interaction works as expected.</p> </div> <div class="paragraph"> <p>Otherwise, if Hibernate is configured for example with JDBC transactions, Hibernate will create a Transaction instance via java.sql.Connection and Infinispan will create a transaction via whatever TransactionManager returned by hibernate.transaction.manager_lookup_class. If hibernate.transaction.manager_lookup_class has not been populated, it will default on the dummy transaction manager. So, any work on the 2nd level cache will be done under a different transaction to the one used to commit the stuff to the database via Hibernate. In other words, your operations on the database and the 2LC are not treated as a single unit. Risks here include failures to update the 2LC leaving it with stale data while the database committed data correctly. It has also been observed that under some circumstances where JTA was not used, commit/rollbacks are not propagated to Infinispan.</p> </div> <div class="paragraph"> <p>To sum up, if you configure Hibernate with Infinispan, apply the following changes to your configuration file:</p> </div> <div class="paragraph"> <p>1. Unless your application uses JPA, you need to select the correct Hibernate transaction factory via the property <em>hibernate.transaction.factory_class</em> :</p> </div> <div class="ulist"> <ul> <li> <p>If you&#8217;re running within an application server, it&#8217;s recommended that you use:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.CMTTransactionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.factory_class</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.hibernate.transaction.CMTTransactionFactory<span class="tag">&lt;/property&gt;</span>
</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>If you&#8217;re running in a standalone environment and you wanna enable JTA transaction factory, use:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.JTATransactionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.factory_class</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.hibernate.transaction.JTATransactionFactory<span class="tag">&lt;/property&gt;</span>
</code></pre> </div> </div> <div class="paragraph"> <p>The reason why JPA does not require a transaction factory class to be set up is because the entity manager already sets it to a variant of CMTTransactionFactory.</p> </div> <div class="paragraph"> <p>2. Select the correct Hibernate transaction manager lookup:</p> </div> <div class="ulist"> <ul> <li> <p>If you&#8217;re running within an application server, select the appropriate lookup class according to <a href="http://docs.jboss.org/hibernate/core/3.3/reference/en/html/session-configuration.html#configuration-optional-transactionstrategy">"JTA Transaction Managers" table</a> .</p> </li> </ul> </div> <div class="paragraph"> <p>For example if you were running with the JBoss Application Server you would set:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"> <span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.JBossTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 org.hibernate.transaction.JBossTransactionManagerLookup
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>If you are running standalone and you want to add a JTA transaction manager lookup, things get a bit more complicated. Due to a current limitation, Hibernate does not support injecting a JTA TransactionManager or JTA UserTransaction that are not bound to JNDI. In other words, if you want to use JTA, Hibernate expects your TransactionManager to be bound to JNDI and it also expects that UserTransaction instances are retrieved from JNDI. This means that in a standalone environment, you need to add some code that binds your TransactionManager and UserTransaction to JNDI. With this in mind and with the help of one of our community contributors, we&#8217;ve created an example that does just that: <a href="http://anonsvn.jboss.org/repos/hibernate/core/trunk/cache-infinispan/src/test/java/org/hibernate/test/cache/infinispan/tm/JBossStandaloneJtaExampleTest.java">JBoss Standalone JTA Example</a> . Once you have the code in place, it&#8217;s just a matter of selecting the correct Hibernate transaction manager lookup class, based on the JNDI names given. If you take <em>JBossStandaloneJtaExample</em> as an example, you simply have to add:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"> <span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.JBossTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 org.hibernate.transaction.JBossTransactionManagerLookup
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>As you probably have noted through this section, there wasn&#8217;t a single mention of the need to configure <a href="http://docs.jboss.org/infinispan/5.0/apidocs/config.html#ce_default_transaction">Infinispan&#8217;s transaction manager lookup</a> and there&#8217;s a good reason for that. Basically, the code within Infinispan cache provider takes the transaction manager that has been configured at the Hibernate level and uses that. Otherwise, if no Hibernate transaction manager lookup class has been defined, Infinispan uses a default dummy transaction manager.</p> </div> <div class="paragraph"> <p>Since Hibernate 4.0, the way Infinispan hooks into the transaction manager can be configured. By default, since 4.0, Infinispan interacts with the transaction manager as a JTA synchronization, resulting <a href="#_transactions">in a faster interaction with the 2LC thanks to some key optimisations that the transaction manager can apply</a>. However if desired, users can configure Infinispan to act as an XA resource (just like it did in 3.6 and earlier) by disabling the use of the synchronization. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml: --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.use_synchronization</span><span class="delimiter">&quot;</span></span><span class="error"></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml: --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.use_synchronization</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 false
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="_advanced_configuration"><a class="anchor" href="#_advanced_configuration"></a>1.1.4. Advanced Configuration</h4> <div class="paragraph"> <p>Infinispan has the capability of exposing statistics via JMX and since Hibernate 3.5.0.Beta4, you can enable such statistics from the Hibernate/JPA configuration file. By default, Infinispan statistics are turned off but when these are disabled via the following method, statistics for the Infinispan Cache Manager and all the managed caches (entity, collection, etc) are enabled:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.statistics</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml: --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.statistics</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The Infinispan cache provider jar file contains an Infinispan configuration file, which is the one used by default when configuring the Infinispan standalone cache region factory. This file contains default cache configurations for all Hibernate data types that should suit the majority of use cases. However, if you want to use a different configuration file, you can configure it via the following property:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/home/infinispan/cacheprovider-configs.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml: --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 /home/infinispan/cacheprovider-configs.xml
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>For each Hibernate cache data types, Infinispan cache region factory has defined a default cache name to look up in either the default, or the user defined, Infinispan cache configuration file. These default values can be found in the <a href="http://docs.jboss.org/hibernate/core/4.0/javadocs/constant-values.html#org.hibernate.cache.infinispan.InfinispanRegionFactory.INFINISPAN_CONFIG_RESOURCE_PROP">Infinispan cache provider javadoc</a> . You can change these cache names using the following properties:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml: --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-entity</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.collection.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-collection</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.query.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-collection</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.timestamp.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-timestamp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 custom-entity
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.collection.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 custom-collection
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.query.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 custom-collection
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.timestamp.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 custom-timestamp
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>One of the key improvements brought in by Infinispan is the fact that cache instances are more lightweight than they used to be in JBoss Cache. This has enabled a radical change in the way entity/collection type cache management works. With the Infinispan cache provider, each entity/collection type gets each own cache instance, whereas in old JBoss Cache based cache providers, all entity/collection types would be sharing the same cache instance. As a result of this, locking issues related to updating different entity/collection types concurrently are avoided completely.</p> </div> <div class="paragraph"> <p>This also has an important bearing on the meaning of hibernate.cache.infinispan.entity.cfg and hibernate.cache.infinispan.collection.cfg properties. These properties define the template cache name that should be used for all entity/collection data types. So, with the above hibernate.cache.infinispan.entity.cfg configuration, when a region needs to be created for entity com.acme.Person, the cache instance to be assigned to this entity will be based on a "custom-entity" named cache.</p> </div> <div class="paragraph"> <p>On top of that, this finer grained cache definition enables users to define cache settings on a per entity/collection basis. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person-entity</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.addresses.cfg</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">addresses-collection</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 person-entity
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.addresses.cfg</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 addresses-collection
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="icon-important" title="Important"></i> </td> <td class="content"> For any entity or collection specific properties, if you are running within JBoss Application Server, JBoss EAP, or Widlfly, providing just the entity name is not enough. You need to add unit name and deployment name as well to each property in the following format: <code>hibernate.cache.infinispan.&lt;warname&gt;.&lt;unitname&gt;.&lt;FQN of entity&gt;.....</code> </td> </tr> </table> </div> <div class="paragraph"> <p>Here, we&#8217;re configuring the Infinispan cache provider so that for com.acme.Person entity type, the cache instance assigned will be based on a "person-entity" named cache, and for com.acme.Person.addresses collection type, the cache instance assigned will be based on a "addresses-collection" named cache. If either of these two named caches did not exist in the Infinispan cache configuration file, the cache provider would create a cache instance for com.acme.Person entity and com.acme.Person.addresses collection based on the default cache in the configuration file.</p> </div> <div class="paragraph"> <p>Furthermore, thanks to the excellent feedback from the Infinispan community and in particular, Brian Stansberry, we&#8217;ve decided to allow users to define the most commonly tweaked Infinispan cache parameters via hibernate.cfg.xml or persistence.xml, for example eviction/expiration settings. So, with the Infinispan cache provider, you can configure eviction/expiration this way:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.strategy</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">LRU</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.max_entries</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.expiration.lifespan</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.expiration.max_idle</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.strategy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 LRU
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 2000
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.max_entries</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 5000
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.expiration.lifespan</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 60000
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.expiration.max_idle</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 30000
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>With the above configuration, you&#8217;re overriding whatever eviction/expiration settings were defined for the default entity cache name in the Infinispan cache configuration used, regardless of whether it&#8217;s the default one or user defined. More specifically, we&#8217;re defining the following:</p> </div> <div class="ulist"> <ul> <li> <p>All entities to use LRU eviction strategy</p> </li> <li> <p>The eviction thread to wake up every 2000 milliseconds</p> </li> <li> <p>The maximum number of entities for each entity type to be 5000 entries</p> </li> <li> <p>The lifespan of each entity instance to be 600000 milliseconds</p> </li> <li> <p>The maximum idle time for each entity instance to be 30000</p> </li> </ul> </div> <div class="paragraph"> <p>You can also override eviction/expiration settings on a per entity/collection type basis in such way that the overriden settings only afftect that particular entity (i.e. com.acme.Person) or collection type (i.e. com.acme.Person.addresses). For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.strategy</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">FIFO</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">2500</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.max_entries</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">5500</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.expiration.lifespan</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">65000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.expiration.max_idle</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">35000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.strategy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 FIFO
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 2500
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.max_entries</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 5500
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.expiration.lifespan</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 65000
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.expiration.max_idle</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 35000
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The aim of these configuration capabilities is to reduce the number of files needed to modify in order to define the most commonly tweaked parameters. So, by enabling eviction/expiration configuration on a per generic Hibernate data type or particular entity/collection type via hibernate.cfg.xml or persistence.xml, users don&#8217;t have to touch to Infinispan&#8217;s cache configuration file any more. We believe users will like this approach and so, if you there are any other Infinispan parameters that you often tweak and these cannot be configured via hibernate.cfg.xml or persistence.xml, please let the Infinispan team know by sending an email to <a href="mailto:infinispan-dev@lists.jboss.org">infinispan-dev@lists.jboss.org</a> .</p> </div> <div class="paragraph"> <p>Please note that query/timestamp caches work the same way they did with JBoss Cache based cache providers. In other words, there&#8217;s a query cache instance and timestamp cache instance shared by all. It&#8217;s worth noting that eviction/expiration settings are allowed for query cache but not for timestamp cache. So configuring an eviction strategy other than NONE for timestamp cache would result in a failure to start up.</p> </div> <div class="paragraph"> <p>Finally, from Hibernate 3.5.4 and 3.6 onwards, queries with specific cache region names are stored under matching cache instances. This means that you can now set query cache region specific settings. For example, assuming you had a query like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="predefined-type">Query</span> query = session.createQuery(
<span class="error"></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">select account.branch from Account as account where account.holder = ?</span><span class="delimiter">&quot;</span></span>);
query.setCacheable(<span class="predefined-constant">true</span>);
query.setCacheRegion(<span class="string"><span class="delimiter">&quot;</span><span class="content">AccountRegion</span><span class="delimiter">&quot;</span></span>);
</code></pre> </div> </div> <div class="paragraph"> <p>The query would be stored under "AccountRegion" cache instance and users could control settings in similar fashion to what was done with entities and collections. So, for example, you could define specific eviction settings for this particular query region doing something like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using JPA, add to your persistence.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.AccountRegion.eviction.strategy</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">FIFO</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.AccountRegion.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="comment">&lt;!-- If using Hibernate, add to your hibernate.cfg.xml --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.AccountRegion.eviction.strategy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 FIFO
<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.AccountRegion.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 10000
<span class="tag">&lt;/property&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="_handling_custom_identifiers_types"><a class="anchor" href="#_handling_custom_identifiers_types"></a>1.1.5. Handling custom identifiers types</h4> <div class="paragraph"> <p>When custom identifier types are used in Hibernate/JPA entities, specially in the case of composite identifiers, the resulting cache keys can end up holding references to <code>SessionFactory</code> instances. Serializing those properly in a clustered environment depends on being able to resolve the proper <code>SessionFactory</code> reference on deserialization, which can happen based on UUID (same JVM) or name (across JVMs).</p> </div> <div class="paragraph"> <p>When the resolution does not succeed, it&#8217;s common to see errors similar to this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">java.io.InvalidObjectException: Could not find a SessionFactory [uuid=<span class="float">0d</span><span class="integer">0</span>cdf26-dfe6-<span class="integer">4285</span>-<span class="integer">9725</span>-dfaa4821ecba,name=<span class="predefined-constant">null</span>]
    at org.hibernate.internal.SessionFactoryImpl.locateSessionFactoryOnDeserialization(SessionFactoryImpl.java:<span class="integer">1781</span>)
    at org.hibernate.internal.SessionFactoryImpl.readResolve(SessionFactoryImpl.java:<span class="integer">1761</span>)</code></pre> </div> </div> <div class="paragraph"> <p>The way to get around these error is by locking down the name of the <code>SessionFactory</code> across JVMs. This can be done by adding the following properties in the clustered application&#8217;s configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">hibernate.session_factory_name = MySessionFactory
hibernate.session_factory_name_is_jndi = <span class="predefined-constant">false</span></code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="icon-tip" title="Tip"></i> </td> <td class="content"> These properties are not necessary if deploying in JBoss Application Server, Wildfly or EAP containers, since the integration code already populates session factory name based on deployment unit information. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="_integration_with_jboss_application_server"><a class="anchor" href="#_integration_with_jboss_application_server"></a>1.1.6. Integration with JBoss Application Server</h4> <div class="paragraph"> <p>In JBoss Application Server 7, Infinispan is the default second level cache provider and you can find details about its configuration <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=8094254">the AS7 JPA reference guide</a> .</p> </div> <div class="paragraph"> <p>Infinispan based Hibernate 2LC was developed as part of Hibernate 3.5 release and so it currently only works within AS 6 or higher. Hibernate 3.5 is not designed to work with AS/EAP 5.x or lower. To be able to run Infinispan based Hibernate 2LC in a lower AS version such as 5.1, the Infinispan 2LC module would require porting to Hibernate 3.3.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="icon-tip" title="Tip"></i> </td> <td class="content"> Looking to integrate Infinispan with Hibernate in JBoss AS/EAP 5.x? <a href="#_infinispan_as_hibernate_2nd_level_cache_in_jboss_as_5_x">Read this section</a>! </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="_using_infinispan_as_remote_second_level_cache"><a class="anchor" href="#_using_infinispan_as_remote_second_level_cache"></a>1.1.7. Using Infinispan as remote Second Level Cache?</h4> <div class="paragraph"> <p>Lately, several questions ( <a href="http://community.jboss.org/message/575814#575814">here</a> and <a href="http://community.jboss.org/message/585841#585841">here</a> ) have appeared in the Infinispan user forums asking whether it&#8217;d be possible to have an Infinispan second level cache that instead of living in the same JVM as the Hibernate code, it resides in a remote server, i.e. an Infinispan Hot Rod server. It&#8217;s important to understand that trying to set up second level cache in this way is generally not a good idea for the following reasons:</p> </div> <div class="ulist"> <ul> <li> <p>The purpose of a JPA/Hibernate second level cache is to store entities/collections recently retrieved from database or to maintain results of recent queries. So, part of the aim of the second level cache is to have data accessible locally rather than having to go to the database to retrieve it everytime this is needed. Hence, if you decide to set the second level cache to be remote as well, you&#8217;re losing one of the key advantages of the second level cache: the fact that the cache is local to the code that requires it.</p> </li> <li> <p>Setting a remote second level cache can have a negative impact in the overall performance of your application because it means that cache misses require accessing a remote location to verify whether a particular entity/collection/query is cached. With a local second level cache however, these misses are resolved locally and so they are much faster to execute than with a remote second level cache.</p> </li> </ul> </div> <div class="paragraph"> <p>There are however some edge cases where it might make sense to have a remote second level cache, for example:</p> </div> <div class="ulist"> <ul> <li> <p>You are having memory issues in the JVM where JPA/Hibernate code and the second level cache is running. Off loading the second level cache to remote Hot Rod servers could be an interesting way to separate systems and allow you find the culprit of the memory issues more easily.</p> </li> <li> <p>Your application layer cannot be clustered but you still want to run multiple application layer nodes. In this case, you can&#8217;t have multiple local second level cache instances running because they won&#8217;t be able to invalidate each other for example when data in the second level cache is updated. In this case, having a remote second level cache could be a way out to make sure your second level cache is always in a consistent state, will all nodes in the application layer pointing to it.</p> </li> <li> <p>Rather than having the second level cache in a remote server, you want to simply keep the cache in a separate VM still within the same machine. In this case you would still have the additional overhead of talking across to another JVM, but it wouldn&#8217;t have the latency of across a network. The benefit of doing this is that:</p> </li> <li> <p>Size the cache separate from the application, since the cache and the application server have very different memory profiles. One has lots of short lived objects, and the other could have lots of long lived objects.</p> </li> <li> <p>To pin the cache and the application server onto different CPU cores (using <em>numactl</em> ), and even pin them to different physically memory based on the NUMA nodes.</p> </li> </ul> </div> </div> </div> <div class="sect2"> <h3 id="_implementing_standalone_jpa_jta_hibernate_application_outside_j2ee_server_using_infinispan_2nd_level_cache"><a class="anchor" href="#_implementing_standalone_jpa_jta_hibernate_application_outside_j2ee_server_using_infinispan_2nd_level_cache"></a>1.2. Implementing standalone JPA JTA Hibernate application outside J2EE server using Infinispan 2nd level cache</h3> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="icon-important" title="Important"></i> </td> <td class="content"> From Hibernate 4.0.1 onwards, Infinispan now interacts as a synchronization rather than as an XA resource with the transaction manager when used as second-level cache, so there&#8217;s no longer need to apply any of the changes suggested below! </td> </tr> </table> </div> <div class="paragraph"> <p>Infinispans predecessor <a href="http://www.jboss.org/file-access/default/members/jbossclustering/freezone/docs/hibernate-caching/3.3/en-US/html/introduction-requirements.html">JBoss Cache</a> requires integration with JTA when used as 2L-cache for a Hibernate application. At the moment of writing this article (Hibernate 3.5.0.Beta3) also Infinispan requires integration with JTA. Hibernate integrated with JTA is already largely used in EJB applications servers, but most users using Hibernate with Java SE outside any EJB container, still use the plain JDBC approach instead to use JTA.</p> </div> <div class="paragraph"> <p>According Hibernate documentation it should also possible to integrate JTA in a standalone application outside any EJB container, but I did hardly find any documentation how to do that in detail. (probably the reason is, that probably 95% of people is using hibernate within a EJB app. server or using SPRING). This article should give you some example how to realize a standalone Hibernate app. outside of a EJB container with JTA integration (and using Infinispan 2nd level cache).</p> </div> <div class="paragraph"> <p>As first thing you have to choose which implementation of TransactionManager to take. This article comes with examples for following OpenSource TransactionManagers:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>JBoss</p> </li> <li> <p>JOTM</p> </li> <li> <p>Bitronix</p> </li> <li> <p>Atomikos</p> </li> </ol> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Datasource/Transaction interaction</div> A very important aspect is not forgetting to couple the datasource with your transaction manager. In other words, the corresponding XAResource must be onto the transaction manager, otherwise only DML-statements but no commits/rollbacks are propagated to your database. </td> </tr> </table> </div> <div class="sect3"> <h4 id="_jboss_transactions"><a class="anchor" href="#_jboss_transactions"></a>1.2.1. JBoss Transactions</h4> <div class="paragraph"> <p>The example with JBoss Transactions Transaction Manager was the most complex to implement, as JBoss&#8217;s TransactionManager and UserTransaction objects are not declared serializable whilst its JNDI-server isn&#8217;t able to bind non serializable objects out of the box. Special use of NonSerializableFactory is needed, requiring some additional custom code:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="keyword">import</span> <span class="include">hello.A</span>;<span class="error"></span> <span class="comment">// a persistent class</span>
<span class="keyword">import</span> <span class="include">java.io.Serializable</span>;
<span class="keyword">import</span> <span class="include">java.sql.Connection</span>;
<span class="keyword">import</span> <span class="include">java.sql.SQLException</span>;
<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

<span class="keyword">import</span> <span class="include">javax.naming.Context</span>;
<span class="keyword">import</span> <span class="include">javax.naming.InitialContext</span>;
<span class="keyword">import</span> <span class="include">javax.naming.Name</span>;
<span class="keyword">import</span> <span class="include">javax.naming.NameNotFoundException</span>;
<span class="keyword">import</span> <span class="include">javax.naming.Reference</span>;
<span class="keyword">import</span> <span class="include">javax.naming.StringRefAddr</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.EntityManager</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.Persistence</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.TransactionManager</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.UserTransaction</span>;

<span class="keyword">import</span> <span class="include">org.enhydra.jdbc.standard.StandardXADataSource</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.Session</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.SessionFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.ejb.HibernateEntityManagerFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.transaction.JBossTransactionManagerLookup</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.transaction.lookup.JBossStandaloneJTAManagerLookup</span>;
<span class="keyword">import</span> <span class="include">org.jboss.util.naming.NonSerializableFactory</span>;
<span class="keyword">import</span> <span class="include">org.jnp.interfaces.NamingContext</span>;
<span class="keyword">import</span> <span class="include">org.jnp.server.Main</span>;
<span class="keyword">import</span> <span class="include">org.jnp.server.NamingServer</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">JTAStandaloneExampleJBossTM</span><span class="error"></span> {
<span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">static</span> JBossStandaloneJTAManagerLookup _ml =<span class="error"></span> <span class="keyword">new</span> JBossStandaloneJTAManagerLookup();
<span class="error"></span><span class="error"></span><span class="error"></span>

<span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">try</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// Create an in-memory jndi</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> NamingServer namingServer = <span class="keyword">new</span> NamingServer();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> NamingContext.setLocal(namingServer);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> Main namingMain = <span class="keyword">new</span> Main();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> namingMain.setInstallGlobalService(<span class="predefined-constant">true</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> namingMain.setPort(-<span class="integer">1</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> namingMain.start();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> props.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.jnp.interfaces.NamingContextFactory</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">java.naming.factory.url.pkgs</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.jboss.naming:org.jnp.interfaces</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">InitialContext</span> ictx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>( props );
<span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// as JBossTransactionManagerLookup extends JNDITransactionManagerLookup we must also register the TransactionManager</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/TransactionManager</span><span class="delimiter">&quot;</span></span>, _ml.getTransactionManager(), _ml.getTransactionManager().getClass(), ictx);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// also the UserTransaction must be registered on jndi: org.hibernate.transaction.JTATransactionFactory#getUserTransaction() requires this</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> bind(<span class="keyword">new</span> JBossTransactionManagerLookup().getUserTransactionName(),_ml.getUserTransaction(),_ml.getUserTransaction().getClass(), ictx);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ExtendedXADataSource xads = <span class="keyword">new</span> ExtendedXADataSource();<span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> xads.setDriverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hsqldb.jdbcDriver</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> xads.setDriverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.p6spy.engine.spy.P6SpyDriver</span><span class="delimiter">&quot;</span></span>); <span class="comment">// comment this line if you don't want p6spy-logging</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> xads.setUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:hsql://localhost</span><span class="delimiter">&quot;</span></span>);<span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">//xads.setTransactionManager(_ml.getTransactionManager()); useless here as this information is not serialized</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ictx.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/MyDatasource</span><span class="delimiter">&quot;</span></span>, xads);<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">final</span> HibernateEntityManagerFactory emf =<span class="error"></span> (HibernateEntityManagerFactory) Persistence.createEntityManagerFactory(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloworld</span><span class="delimiter">&quot;</span></span>);<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> UserTransaction userTransaction = _ml.getUserTransaction();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> userTransaction.setTransactionTimeout(<span class="integer">300000</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">//SessionFactory sf = (SessionFactory) ictx.lookup(&quot;java:/hibernate/MySessionFactory&quot;); // if hibernate.session_factory_name set</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">final</span> SessionFactory sf = emf.getSessionFactory();

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> userTransaction.begin();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> EntityManager em = emf.createEntityManager();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// do here your persistent work</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> A a = <span class="keyword">new</span> A();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> a.name= <span class="string"><span class="delimiter">&quot;</span><span class="content">firstvalue</span><span class="delimiter">&quot;</span></span>;
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> em.persist(a);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> em.flush();<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// do manually flush here as apparently FLUSH_BEFORE_COMPLETION seems not work, bug ?</span>

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="content">Created and flushed instance a with id : </span><span class="delimiter">&quot;</span></span> + a.oid + <span class="string"><span class="delimiter">&quot;</span><span class="content"> a.name set to:</span><span class="delimiter">&quot;</span></span> + a.name);

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Calling userTransaction.commit() (Please check if the commit is effectively executed!)</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> userTransaction.commit();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ictx.close();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> namingMain.stop();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> emf.close();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> e.printStackTrace();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
<span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">ExtendedXADataSource</span> <span class="directive">extends</span> StandardXADataSource { <span class="comment">// XAPOOL</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="annotation">@Override</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="predefined-type">Connection</span> getConnection() <span class="directive">throws</span> <span class="exception">SQLException</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">if</span> (getTransactionManager() == <span class="predefined-constant">null</span>) { <span class="comment">// although already set before, it results null again after retrieving the datasource by jndi</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> TransactionManager tm;<span class="error"></span> <span class="comment">// this is because the TransactionManager information is not serialized.</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">try</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> tm = _ml.getTransactionManager();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">SQLException</span>(e);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> setTransactionManager(tm);<span class="error"></span> <span class="comment">// resets the TransactionManager on the datasource retrieved by jndi,</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// this makes the datasource JTA-aware</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// According to Enhydra documentation, here we must return the connection of our XAConnection</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// see http://cvs.forge.objectweb.org/cgi-bin/viewcvs.cgi/xapool/xapool/examples/xapooldatasource/DatabaseHelper.java?sortby=rev</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">return</span> <span class="local-variable">super</span>.getXAConnection().getConnection();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">/**
 * Helper method that binds the a non serializable object to the JNDI tree.
 *
 * @param jndiName Name under which the object must be bound
 * @param who Object to bind in JNDI
 * @param classType Class type under which should appear the bound object
 * @param ctx Naming context under which we bind the object
 * @throws Exception Thrown if a naming exception occurs during binding
 */</span>
<span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">private</span> <span class="directive">static</span> <span class="type">void</span> bind(<span class="predefined-type">String</span> jndiName, <span class="predefined-type">Object</span> who, <span class="predefined-type">Class</span> classType, <span class="predefined-type">Context</span> ctx) <span class="directive">throws</span> <span class="exception">Exception</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// Ah ! This service isn't serializable, so we use a helper class</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> NonSerializableFactory.bind(jndiName, who);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">Name</span> n = ctx.getNameParser(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>).parse(jndiName);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">while</span> (n.size() &gt; <span class="integer">1</span>) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">String</span> ctxName = n.get(<span class="integer">0</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">try</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ctx = (<span class="predefined-type">Context</span>) ctx.lookup(ctxName);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> } <span class="keyword">catch</span> (<span class="exception">NameNotFoundException</span> e) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Creating subcontext:</span><span class="delimiter">&quot;</span></span> + ctxName);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ctx = ctx.createSubcontext(ctxName);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> n = n.getSuffix(<span class="integer">1</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// The helper class NonSerializableFactory uses address type nns, we go on to</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// use the helper class to bind the service object in JNDI</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">StringRefAddr</span> addr = <span class="keyword">new</span> <span class="predefined-type">StringRefAddr</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">nns</span><span class="delimiter">&quot;</span></span>, jndiName);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">Reference</span> ref = <span class="keyword">new</span> <span class="predefined-type">Reference</span>(classType.getName(), addr, NonSerializableFactory.class.getName(), <span class="predefined-constant">null</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ctx.rebind(n.get(<span class="integer">0</span>), ref);
<span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">private</span> <span class="directive">static</span> <span class="type">void</span> unbind(<span class="predefined-type">String</span> jndiName, <span class="predefined-type">Context</span> ctx) <span class="directive">throws</span> <span class="exception">Exception</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> NonSerializableFactory.unbind(jndiName);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ctx.unbind(jndiName);
<span class="error"></span><span class="error"></span><span class="error"></span> }

}
</code></pre> </div> </div> <div class="paragraph"> <p>The content of the corresponding complete persistence.xml:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/persistence</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span><span class="error"></span><span class="error"></span> <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd</span><span class="delimiter">&quot;</span></span><span class="error"></span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">helloworld</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">JTA</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="tag">&lt;jta-data-source&gt;</span>java:/MyDatasource<span class="tag">&lt;/jta-data-source&gt;</span>
 <span class="tag">&lt;properties&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.hbm2ddl.auto</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.archive.autodetection</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">class, hbm</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.dialect</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.dialect.HSQLDialect</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.jndi.class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jnp.interfaces.NamingContextFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.JBossTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">current_session_context_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jta</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="comment">&lt;!-- &lt;property name=&quot;hibernate.session_factory_name&quot; value=&quot;java:/hibernate/MySessionFactory&quot;/&gt; optional --&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.JTATransactionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.connection.release_mode</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auto</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="comment">&lt;!-- setting above is important using XA-DataSource on SQLServer,
 otherwise SQLServerException: The function START: has failed. No transaction cookie was returned.--&gt;</span>

 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_second_level_cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_query_cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span><span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.cache.infinispan.InfinispanRegionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

 <span class="tag">&lt;/properties&gt;</span>
 <span class="tag">&lt;/persistence-unit&gt;</span>
<span class="tag">&lt;/persistence&gt;</span>
</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="_jotm"><a class="anchor" href="#_jotm"></a>1.2.2. JOTM</h4> <div class="paragraph"> <p>The example with JOTM is more simple, but apparently its JNDI implementation is not useable without wasting any rmi port. So it is not completely <em>standalone</em> as the JNDI service is exposed outside your virtual machine.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
<span class="keyword">import</span> <span class="include">hello.A</span>; <span class="comment">// a persistent class</span>

<span class="keyword">import</span> <span class="include">java.sql.Connection</span>;
<span class="keyword">import</span> <span class="include">java.sql.SQLException</span>;
<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

<span class="keyword">import</span> <span class="include">javax.naming.Context</span>;
<span class="keyword">import</span> <span class="include">javax.naming.InitialContext</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.EntityManager</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.EntityManagerFactory</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.Persistence</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.TransactionManager</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.UserTransaction</span>;

<span class="keyword">import</span> <span class="include">org.enhydra.jdbc.standard.StandardXADataSource</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.transaction.JOTMTransactionManagerLookup</span>;
<span class="keyword">import</span> <span class="include">org.objectweb.jotm.Jotm</span>;
<span class="keyword">import</span> <span class="include">org.objectweb.transaction.jta.TMService</span>;


<span class="directive">public</span> <span class="type">class</span> <span class="class">JTAExampleJOTM</span> {
<span class="error"></span><span class="error"></span><span class="error"></span>
 <span class="directive">static</span> JOTMTransactionManagerLookup _ml =<span class="error"></span> <span class="keyword">new</span> JOTMTransactionManagerLookup();

 <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">ExtendedXADataSource</span> <span class="directive">extends</span> StandardXADataSource { <span class="comment">// XAPOOL</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="annotation">@Override</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="predefined-type">Connection</span> getConnection() <span class="directive">throws</span> <span class="exception">SQLException</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">if</span> (getTransactionManager() == <span class="predefined-constant">null</span>) { <span class="comment">// although already set before, it results null again after retrieving the datasource by jndi</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> TransactionManager tm;<span class="error"></span> <span class="comment">// this is because the TransactionManager information is not serialized.</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">try</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> tm = _ml.getTransactionManager(<span class="predefined-constant">null</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">SQLException</span>(e);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> setTransactionManager(tm);<span class="error"></span> <span class="comment">// resets the TransactionManager on the datasource retrieved by jndi,</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// this makes the datasource JTA-aware</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// According to Enhydra documantation, here we must return the connection of our XAConnection</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// see http://cvs.forge.objectweb.org/cgi-bin/viewcvs.cgi/xapool/xapool/examples/xapooldatasource/DatabaseHelper.java?sortby=rev</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">return</span> <span class="local-variable">super</span>.getXAConnection().getConnection();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span> }

<span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main( <span class="predefined-type">String</span><span class="type">[]</span> args )
<span class="error"></span><span class="error"></span><span class="error"></span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">try</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> java.rmi.registry.LocateRegistry.createRegistry(<span class="integer">1099</span>); <span class="comment">// also possible to lauch by command line rmiregistry</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">RMI registry ready.</span><span class="delimiter">&quot;</span></span>);

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// following properties can be left out if specifying thes values in a file jndi.properties located into classpath</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> props.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.ow2.carol.jndi.spi.MultiOrbInitialContextFactory</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">InitialContext</span> jndiCtx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>(props);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// XAPOOL</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ExtendedXADataSource xads = <span class="keyword">new</span> ExtendedXADataSource();<span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> xads.setDriverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hsqldb.jdbcDriver</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> xads.setDriverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.p6spy.engine.spy.P6SpyDriver</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> xads.setUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:hsql://localhost</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> jndiCtx.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/MyDatasource</span><span class="delimiter">&quot;</span></span>, xads);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">/* startup JOTM */</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> TMService jotm = <span class="keyword">new</span> Jotm(<span class="predefined-constant">true</span>, <span class="predefined-constant">false</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> jotm.getUserTransaction().setTransactionTimeout(<span class="integer">36000</span>); <span class="comment">// secs, important JOTM default is only 60 secs !</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">/* and get a UserTransaction */</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> UserTransaction userTransaction = jotm.getUserTransaction();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> jndiCtx.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/UserTransaction</span><span class="delimiter">&quot;</span></span>, jotm.getUserTransaction()); <span class="comment">// this is needed by hibernates JTATransactionFactory</span>

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">/* get the Hibernate SessionFactory */</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> EntityManagerFactory emf =<span class="error"></span><span class="error"></span><span class="error"></span> Persistence.createEntityManagerFactory(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloworld</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">//SessionFactory sf = (SessionFactory) jndiCtx.lookup(&quot;java:/hibernate/MySessionFactory&quot;);</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// begin a new Transaction</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> userTransaction.begin();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> EntityManager em = emf.createEntityManager();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> A a = <span class="keyword">new</span> A();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> a.name= <span class="string"><span class="delimiter">&quot;</span><span class="content">firstvalue</span><span class="delimiter">&quot;</span></span>;
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> em.persist(a);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> em.flush();<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// do manually flush here as apparently FLUSH_BEFORE_COMPLETION seems not work, bug ?</span>

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Calling userTransaction.commit() (Please check if the commit is effectively executed!)</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> userTransaction.commit();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// stop the transaction manager</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> jotm.stop();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> jndiCtx.close();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> emf.close();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">catch</span>( <span class="exception">Exception</span> e )
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> e.printStackTrace();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }

}
</code></pre> </div> </div> <div class="paragraph"> <p>Adjust following 2 properties in your persistence.xml:</p> </div> <div class="listingblock"> <div class="title">persistence.xml</div> <div class="content"> <pre class="CodeRay"><code class="xml language-xml">
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.jndi.class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.ow2.carol.jndi.spi.MultiOrbInitialContextFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.JOTMTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
</code></pre> </div> </div> <div class="paragraph"> <p>For using the JTA Hibernate application as servlet in tomcat please read <a href="http://jotm.objectweb.org/current/jotm/doc/howto-tomcat-jotm.html">http://jotm.objectweb.org/current/jotm/doc/howto-tomcat-jotm.html</a> and also <a href="https://forum.hibernate.org/viewtopic.php?f=1&amp;amp;t=1003866">https://forum.hibernate.org/viewtopic.php?f=1&amp;amp;t=1003866</a></p> </div> </div> <div class="sect3"> <h4 id="_bitronix"><a class="anchor" href="#_bitronix"></a>1.2.3. Bitronix</h4> <div class="paragraph"> <p>The Transaction Manager comes bundled with a fake in memory jndi-implementation which is ideal for standalone purpose. To integrate with Infinispan I did need a ad-hoc pre-alpha improvement (see attached <a href="https://docs.jboss.org/author/download/attachments/68355081/btm-ispn.jar?version=1&amp;amp;modificationDate=1308852871000">btm-ispn.jar</a> by courtesy of Mr. Ludivic Orban). BitronixTM offers the so-called Last Resource Commit optimization (aka Last Resource Gambit or Last Agent optimization) and it allows a single non-XA database to participate in a XA transaction by cleverly ordering the resources. "Last Resource Commit" is not part of the XA spec as it doesn&#8217;t cover the transaction-recovery aspect, so if your database does not support XA (or if you don&#8217;t wish to have the Xa-driver performance overhead against the plain jdbc) then the "Last Resource Commit" feature should be ideal for the combination 1 single database plus infinispan.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
<span class="keyword">import</span> <span class="include">hello.A</span>; <span class="comment">// a persistent class</span>

<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

<span class="keyword">import</span> <span class="include">javax.naming.Context</span>;
<span class="keyword">import</span> <span class="include">javax.naming.InitialContext</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.EntityManager</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.Persistence</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.UserTransaction</span>;

<span class="keyword">import</span> <span class="include">org.hibernate.cache.infinispan.InfinispanRegionFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.ejb.HibernateEntityManagerFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.impl.SessionFactoryImpl</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.manager.CacheManager</span>;

<span class="keyword">import</span> <span class="include">bitronix.tm.resource.ResourceRegistrar</span>;
<span class="keyword">import</span> <span class="include">bitronix.tm.resource.infinispan.InfinispanCacheManager</span>;
<span class="keyword">import</span> <span class="include">bitronix.tm.resource.jdbc.PoolingDataSource</span>;



<span class="directive">public</span> <span class="type">class</span> <span class="class">JTAExampleBTM</span><span class="error"></span> {
<span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">try</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> props.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY, <span class="string"><span class="delimiter">&quot;</span><span class="content">bitronix.tm.jndi.BitronixInitialContextFactory</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// Attention: BitronixInitialContextFactory is'nt a real jndi implementation: you can't do explicit bindings</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// It is ideal for hiberante standalone usage, as it automatically 'binds' the needed things: datasource + usertransaction</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">create initial context</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">InitialContext</span> ictx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>(props);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> PoolingDataSource myDataSource = <span class="keyword">new</span> PoolingDataSource();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> myDataSource.setClassName(<span class="string"><span class="delimiter">&quot;</span><span class="content">bitronix.tm.resource.jdbc.lrc.LrcXADataSource</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> myDataSource.setMaxPoolSize(<span class="integer">5</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> myDataSource.setAllowLocalTransactions(<span class="predefined-constant">true</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> myDataSource.getDriverProperties().setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">driverClassName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">com.p6spy.engine.spy.P6SpyDriver</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> myDataSource.getDriverProperties().setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:hsql://localhost</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> myDataSource.getDriverProperties().setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> myDataSource.getDriverProperties().setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> myDataSource.setUniqueName(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/MyDatasource</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> myDataSource.setAutomaticEnlistingEnabled(<span class="predefined-constant">true</span>); <span class="comment">// important to keep it to true (default), otherwise commits/rollbacks are not propagated</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> myDataSource.init(); <span class="comment">// does also register the datasource on the Fake-JNDI with Unique Name</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> org.hibernate.transaction.BTMTransactionManagerLookup lokhiberante = <span class="keyword">new</span> org.hibernate.transaction.BTMTransactionManagerLookup();

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> HibernateEntityManagerFactory emf =<span class="error"></span> (HibernateEntityManagerFactory)<span class="error"></span> Persistence.createEntityManagerFactory(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloworld</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> SessionFactoryImpl sfi = (SessionFactoryImpl) emf.getSessionFactory();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> InfinispanRegionFactory infinispanregionfactory = (InfinispanRegionFactory) sfi.getSettings().getRegionFactory();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> CacheManager manager = infinispanregionfactory.getCacheManager();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// register Inifinispan as a BTM resource</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> InfinispanCacheManager icm = <span class="keyword">new</span> InfinispanCacheManager();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> icm.setUniqueName(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ResourceRegistrar.register(icm);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> icm.setManager(manager);

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">final</span> UserTransaction userTransaction = (UserTransaction) ictx.lookup(lokhiberante.getUserTransactionName());

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// begin a new Transaction</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> userTransaction.begin();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> EntityManager em = emf.createEntityManager();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> A a = <span class="keyword">new</span> A();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> a.name= <span class="string"><span class="delimiter">&quot;</span><span class="content">firstvalue</span><span class="delimiter">&quot;</span></span>;
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> em.persist(a);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> em.flush();<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// do manually flush here as apparently FLUSH_BEFORE_COMPLETION seems not work, bug ?</span>

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Calling userTransaction.commit() (Please check if the commit is effectively executed!)</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> userTransaction.commit();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> emf.close();

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> e.printStackTrace();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.exit(<span class="integer">1</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
<span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span> }
}
</code></pre> </div> </div> <div class="paragraph"> <p>Adjust following 2 properties in your corresponding persistence.xml:</p> </div> <div class="listingblock"> <div class="title">persistence.xml</div> <div class="content"> <pre class="CodeRay"><code class="xml language-xml">
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.jndi.class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bitronix.tm.jndi.BitronixInitialContextFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.transaction.BTMTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="_atomikos"><a class="anchor" href="#_atomikos"></a>1.2.4. Atomikos</h4> <div class="paragraph"> <p>Last but not least, the Atomikos Transaction manager. It is currently the unique Transaction manager I&#8217;ve found with a online-documentation on <a href="http://www.atomikos.com/Documentation/HibernateIntegration#Without_Spring">how to integrate with Hiberante</a> <a href="http://www.atomikos.com/Documentation/HibernateIntegration#Without_Spring">without Spring, outside any J2EE container.</a> . It seems to be the unique supporting XaDataSource together with Pooling, so it doesn&#8217;t matter that It does not come with its own JNDI implementation (we will use the one of JBoss in following example).</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
<span class="keyword">import</span> <span class="include">hello.A</span>; <span class="comment">// a persistent class</span>

<span class="keyword">import</span> <span class="include">java.io.Serializable</span>;
<span class="keyword">import</span> <span class="include">java.sql.Connection</span>;
<span class="keyword">import</span> <span class="include">java.sql.SQLException</span>;
<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

<span class="keyword">import</span> <span class="include">javax.naming.Context</span>;
<span class="keyword">import</span> <span class="include">javax.naming.InitialContext</span>;
<span class="keyword">import</span> <span class="include">javax.naming.Name</span>;
<span class="keyword">import</span> <span class="include">javax.naming.NameNotFoundException</span>;
<span class="keyword">import</span> <span class="include">javax.naming.Reference</span>;
<span class="keyword">import</span> <span class="include">javax.naming.StringRefAddr</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.EntityManager</span>;
<span class="keyword">import</span> <span class="include">javax.persistence.Persistence</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.TransactionManager</span>;
<span class="keyword">import</span> <span class="include">javax.transaction.UserTransaction</span>;

<span class="keyword">import</span> <span class="include">org.hibernate.Session</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.SessionFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.ejb.HibernateEntityManagerFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.impl.SessionFactoryImpl</span>;

<span class="keyword">import</span> <span class="include">org.jboss.util.naming.NonSerializableFactory</span>;
<span class="keyword">import</span> <span class="include">org.jnp.interfaces.NamingContext</span>;
<span class="keyword">import</span> <span class="include">org.jnp.server.Main</span>;
<span class="keyword">import</span> <span class="include">org.jnp.server.NamingServer</span>;

<span class="keyword">import</span> <span class="include">com.atomikos.icatch.jta.hibernate3.TransactionManagerLookup</span>;
<span class="keyword">import</span> <span class="include">com.atomikos.jdbc.AtomikosDataSourceBean</span>;
<span class="keyword">import</span> <span class="include">com.atomikos.jdbc.SimpleDataSourceBean</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">JTAStandaloneExampleAtomikos</span><span class="error"></span> {
<span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">try</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// Create an in-memory jndi</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> NamingServer namingServer = <span class="keyword">new</span> NamingServer();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> NamingContext.setLocal(namingServer);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> Main namingMain = <span class="keyword">new</span> Main();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> namingMain.setInstallGlobalService(<span class="predefined-constant">true</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> namingMain.setPort(-<span class="integer">1</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> namingMain.start();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> props.put(<span class="predefined-type">Context</span>.INITIAL_CONTEXT_FACTORY, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.jnp.interfaces.NamingContextFactory</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">java.naming.factory.url.pkgs</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.jboss.naming:org.jnp.interfaces</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">InitialContext</span> ictx = <span class="keyword">new</span> <span class="predefined-type">InitialContext</span>( props );
<span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> AtomikosDataSourceBean ds = <span class="keyword">new</span> AtomikosDataSourceBean();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ds.setUniqueResourceName(<span class="string"><span class="delimiter">&quot;</span><span class="content">sqlserver_ds</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ds.setXaDataSourceClassName(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.microsoft.sqlserver.jdbc.SQLServerXADataSource</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">Properties</span> p = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> p.setProperty ( <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span> , <span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span> );
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> p.setProperty ( <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> , <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> );
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> p.setProperty ( <span class="string"><span class="delimiter">&quot;</span><span class="content">serverName</span><span class="delimiter">&quot;</span></span> , <span class="string"><span class="delimiter">&quot;</span><span class="content">myserver</span><span class="delimiter">&quot;</span></span> );
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ds.setXaProperties ( p );
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ds.setPoolSize(<span class="integer">5</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/MyDatasource</span><span class="delimiter">&quot;</span></span>, ds, ds.getClass(), ictx);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> TransactionManagerLookup _ml = <span class="keyword">new</span> TransactionManagerLookup();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> UserTransaction userTransaction = <span class="keyword">new</span> com.atomikos.icatch.jta.UserTransactionImp();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/TransactionManager</span><span class="delimiter">&quot;</span></span>, _ml.getTransactionManager(<span class="predefined-constant">null</span>), _ml.getTransactionManager(<span class="predefined-constant">null</span>).getClass(), ictx);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/UserTransaction</span><span class="delimiter">&quot;</span></span>, userTransaction, userTransaction.getClass(), ictx);

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> HibernateEntityManagerFactory emf =<span class="error"></span> (HibernateEntityManagerFactory) Persistence.createEntityManagerFactory(<span class="string"><span class="delimiter">&quot;</span><span class="content">helloworld</span><span class="delimiter">&quot;</span></span>);<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// begin a new Transaction</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> userTransaction.begin();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> EntityManager em = emf.createEntityManager();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> A a = <span class="keyword">new</span> A();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> a.name= <span class="string"><span class="delimiter">&quot;</span><span class="content">firstvalue</span><span class="delimiter">&quot;</span></span>;
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> em.persist(a);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> em.flush();<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// do manually flush here as apparently FLUSH_BEFORE_COMPLETION seems not work, bug ?</span>

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Calling userTransaction.commit() (Please check if the commit is effectively executed!)</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> userTransaction.commit();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> emf.close();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> e.printStackTrace();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.exit(<span class="integer">1</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.exit(<span class="integer">0</span>);
<span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">/**
 * Helper method that binds the a non serializable object to the JNDI tree.
 *
 * @param jndiName Name under which the object must be bound
 * @param who Object to bind in JNDI
 * @param classType Class type under which should appear the bound object
 * @param ctx Naming context under which we bind the object
 * @throws Exception Thrown if a naming exception occurs during binding
 */</span>
<span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">private</span> <span class="directive">static</span> <span class="type">void</span> bind(<span class="predefined-type">String</span> jndiName, <span class="predefined-type">Object</span> who, <span class="predefined-type">Class</span>&lt;?&gt; classType, <span class="predefined-type">Context</span> ctx) <span class="directive">throws</span> <span class="exception">Exception</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// Ah ! This service isn't serializable, so we use a helper class</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> NonSerializableFactory.bind(jndiName, who);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">Name</span> n = ctx.getNameParser(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>).parse(jndiName);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">while</span> (n.size() &gt; <span class="integer">1</span>) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">String</span> ctxName = n.get(<span class="integer">0</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">try</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ctx = (<span class="predefined-type">Context</span>) ctx.lookup(ctxName);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> } <span class="keyword">catch</span> (<span class="exception">NameNotFoundException</span> e) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Creating subcontext:</span><span class="delimiter">&quot;</span></span> + ctxName);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ctx = ctx.createSubcontext(ctxName);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> n = n.getSuffix(<span class="integer">1</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// The helper class NonSerializableFactory uses address type nns, we go on to</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="comment">// use the helper class to bind the service object in JNDI</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">StringRefAddr</span> addr = <span class="keyword">new</span> <span class="predefined-type">StringRefAddr</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">nns</span><span class="delimiter">&quot;</span></span>, jndiName);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">Reference</span> ref = <span class="keyword">new</span> <span class="predefined-type">Reference</span>(classType.getName(), addr, NonSerializableFactory.class.getName(), <span class="predefined-constant">null</span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ctx.rebind(n.get(<span class="integer">0</span>), ref);
<span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span><span class="error"></span>
<span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">private</span> <span class="directive">static</span> <span class="type">void</span> unbind(<span class="predefined-type">String</span> jndiName, <span class="predefined-type">Context</span> ctx) <span class="directive">throws</span> <span class="exception">Exception</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> NonSerializableFactory.unbind(jndiName);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ctx.unbind(jndiName);
<span class="error"></span><span class="error"></span><span class="error"></span> }

}

</code></pre> </div> </div> <div class="paragraph"> <p>Adjust follwing 2 properties in your corresponding persistence.xml:</p> </div> <div class="listingblock"> <div class="title">persistence.xml</div> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.jndi.class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jnp.interfaces.NamingContextFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.transaction.manager_lookup_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.atomikos.icatch.jta.hibernate3.TransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
</code></pre> </div> </div> <div class="paragraph"> <p>And create a file named jta.properties in your classpath with following content:</p> </div> <div class="listingblock"> <div class="title">jta.properties</div> <div class="content"> <pre>
com.atomikos.icatch.service=com.atomikos.icatch.standalone.UserTransactionServiceFactory
com.atomikos.icatch.automatic_resource_registration=false
com.atomikos.icatch.console_log_level=WARN
com.atomikos.icatch.force_shutdown_on_vm_exit=true
com.atomikos.icatch.enable_logging=false</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="_infinispan_as_hibernate_2nd_level_cache_in_jboss_as_5_x"><a class="anchor" href="#_infinispan_as_hibernate_2nd_level_cache_in_jboss_as_5_x"></a>1.3. Infinispan as Hibernate 2nd-Level Cache in JBoss AS 5.x</h3> <div class="paragraph"> <p>A JBoss AS 5.x application can be configured to use Infinispan 4.x as the Hibernate 2nd-level cache, replacing JBoss Cache.</p> </div> <div class="paragraph"> <p>1. Add the attached jar files to the ear lib directory. These include the core 4.1.0.GA Infinispan jar (infinispan-core.jar), the Hibernate/Infinispan integration jar back-ported from Hibernate 3.5 (hibernate-infinispan-3.3.2.GA_CP03.jar), the JGroups jar required by Infinispan 4.1.0 (jgroups-2.10.0.GA.jar), and other required 3rd party jars (river-1.2.3.GA.jar, marshalling-api-1.2.3.GA.jar)</p> </div> <div class="paragraph"> <p>2. Isolate the classloading to be ear-scoped by adding <code>META-INF/jboss-classloading.xml</code></p> </div> <div class="listingblock"> <div class="title">META-INF/jboss-classloading.xml</div> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;classloading</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:classloading:1.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">domain</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">simple-scoped</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent-first</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>3. Configure persistence.xml to use Infinispan instead of JBoss Cache:</p> </div> <div class="listingblock"> <div class="title">persistence.xml</div> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;persistence</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/persistence</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jpa-test</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="tag">&lt;jta-data-source&gt;</span>java:/PostgresDS<span class="tag">&lt;/jta-data-source&gt;</span>
 <span class="tag">&lt;properties&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.dialect</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.dialect.HSQLDialect</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.session_factory_name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SessionFactories/infinispan</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_query_cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_second_level_cache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.generate_statistics</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.use_structured_entries</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region_prefix</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.show_sql</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.hbm2ddl.auto</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">validate</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

            <span class="comment">&lt;!-- Infinispan second level cache configuration --&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate.cache.infinispan.InfinispanRegionFactory</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;/properties&gt;</span>
 <span class="tag">&lt;/persistence-unit&gt;</span>
<span class="tag">&lt;/persistence&gt;</span>
</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="_using_infinispan_as_a_spring_cache_provider"><a class="anchor" href="#_using_infinispan_as_a_spring_cache_provider"></a>1.4. Using Infinispan as a Spring Cache provider</h3> <div class="paragraph"> <p>Starting with version 3.1, the <a href="http://spring.io/">Spring Framework</a> offers a <a href="http://docs.spring.io/spring-framework/docs/4.1.1.RELEASE/spring-framework-reference/html/cache.html">cache abstraction</a>, enabling users to declaratively add caching support to applications via two simple annotations, <code>@Cacheable</code> and <code>@CacheEvict</code>. While out of the box Spring 3.1&#8217;s caching support is backed by <a href="http://ehcache.org">EHCache</a> it has been designed to easily support different cache providers. To that end Spring 3.1 defines a simple and straightforward SPI other caching solutions may implement. Infinispan&#8217;s very own spring modules do - amongst other things - exactly this and therefore users invested in Spring&#8217;s programming model may easily have all their caching needs fulfilled through Infinispan.</p> </div> <div class="paragraph"> <p>Here&#8217;s how.</p> </div> <div class="sect3"> <h4 id="_activating_spring_cache_support"><a class="anchor" href="#_activating_spring_cache_support"></a>1.4.1. Activating Spring Cache support</h4> <div class="paragraph"> <p>You activate Spring&#8217;s cache support using xml:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/cache</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/cache http://www.springframework.org/schema/cache/spring-cache.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

        <span class="tag">&lt;cache:annotation-driven</span> <span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span>
</code></pre> </div> </div> <div class="paragraph"> <p>somewhere in your application context. This enable the cache annotations in Spring. Alternatively, it can be done programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="annotation">@EnableCaching</span> <span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {
}
</code></pre> </div> </div> <div class="paragraph"> <p>Now, assuming you&#8217;ve already got Infinispan and its dependencies on your classpath, all that&#8217;s left to do is installing <code>infinispan-spring</code> and <code>spring</code>. For Maven users this translates into</p> </div> <div class="listingblock"> <div class="title">pom.xml for Spring 4</div> <div class="content"> <pre class="CodeRay"><code class="xml language-xml">
 <span class="tag">&lt;dependency&gt;</span>
 <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
 <span class="tag">&lt;artifactId&gt;</span>spring-context<span class="tag">&lt;/artifactId&gt;</span>
 <span class="tag">&lt;version&gt;</span>4.1.1.RELEASE<span class="tag">&lt;/version&gt;</span>
 <span class="tag">&lt;/dependency&gt;</span>
 <span class="tag">&lt;dependency&gt;</span>
 <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
 <span class="tag">&lt;artifactId&gt;</span>infinispan-spring4<span class="tag">&lt;/artifactId&gt;</span>
 <span class="tag">&lt;version&gt;</span>${infinispan.version}<span class="tag">&lt;/version&gt;</span>
 <span class="tag">&lt;/dependency&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="title">pom.xml for Spring 3</div> <div class="content"> <pre class="CodeRay"><code class="xml language-xml">
 <span class="tag">&lt;dependency&gt;</span>
 <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
 <span class="tag">&lt;artifactId&gt;</span>spring-context<span class="tag">&lt;/artifactId&gt;</span>
 <span class="tag">&lt;version&gt;</span>3.2.9.RELEASE<span class="tag">&lt;/version&gt;</span>
 <span class="tag">&lt;/dependency&gt;</span>
 <span class="tag">&lt;dependency&gt;</span>
 <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
 <span class="tag">&lt;artifactId&gt;</span>infinispan-spring<span class="tag">&lt;/artifactId&gt;</span>
 <span class="tag">&lt;version&gt;</span>${infinispan.version}<span class="tag">&lt;/version&gt;</span>
 <span class="tag">&lt;/dependency&gt;</span>
</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="_telling_spring_to_use_infinispan_as_its_caching_provider"><a class="anchor" href="#_telling_spring_to_use_infinispan_as_its_caching_provider"></a>1.4.2. Telling Spring to use Infinispan as its caching provider</h4> <div class="paragraph"> <p>Spring cache provider SPI comprises two interfaces, <code>org.springframework.cache.CacheManager</code> and <code>org.springframework.cache.Cache</code> where a <code>CacheManager</code> serves as a factory for named <code>Cache</code> instances. By default Spring will look at runtime for a <code>CacheManager</code> implementation having the bean name "cacheManager" in an application&#8217;s application context. So by putting</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml">
<span class="comment">&lt;!-- Infinispan cache manager --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheManager</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.spring.provider.SpringEmbeddedCacheManagerFactoryBean</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">p:configurationFileLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:/org/infinispan/spring/provider/sample/books-infinispan-config.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
</code></pre> </div> </div> <div class="paragraph"> <p>or using java config:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="annotation">@EnableCaching</span>
<span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

   <span class="annotation">@Bean</span>
   <span class="directive">public</span> CacheManager cacheManager() {
      <span class="keyword">return</span> <span class="keyword">new</span> SpringEmbeddedCacheManager(infinispanCacheManager());
   }

   <span class="directive">private</span> EmbeddedCacheManager infinispanCacheManager() {
      <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager();
   }

}</code></pre> </div> </div> <div class="paragraph"> <p>somewhere in your application context you tell Spring to henceforth use Infinispan as its caching provider.</p> </div> </div> <div class="sect3"> <h4 id="_adding_caching_to_your_application_code"><a class="anchor" href="#_adding_caching_to_your_application_code"></a>1.4.3. Adding caching to your application code</h4> <div class="paragraph"> <p>As outlined above enabling caching in your application code is as simple as adding <code>@Cacheable</code> and <code>@CacheEvict</code> to select methods. Suppose you&#8217;ve got a DAO for, say, books and you want book instances to be cached once they&#8217;ve been loaded from the underlying database using <code>BookDao#findBook(Integer bookId)</code>. To that end you annotate <code>findBook(Integer bookId)</code> with <code>@Cacheable</code>, as in</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
<span class="annotation">@Transactional</span>
<span class="annotation">@Cacheable</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>, key = <span class="string"><span class="delimiter">&quot;</span><span class="content">#bookId</span><span class="delimiter">&quot;</span></span>)
<span class="predefined-type">Book</span> findBook(<span class="predefined-type">Integer</span> bookId) {...}
</code></pre> </div> </div> <div class="paragraph"> <p>This will tell Spring to cache Book instances returned from calls to <code>findBook(Integer bookId)</code> in a named cache "books", using the parameter&#8217;s "bookId" value as a cache key. Here, "#bookId" is an expression in the <a href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/expressions.html">Spring Expression Language</a> that evaluates to the <code>bookId</code> argument. If you don&#8217;t specify the <code>key</code> attribute Spring will generate a hash from the supplied method arguments - in this case only <code>bookId</code> - and use that as a cache key. Essentially, you relinquish control over what cache key to use to Spring. Which may or may not be fine depending on your application&#8217;s needs.Though the notion of actually deleting a book will undoubtedly seem alien and outright abhorrent to any sane reader there might come the time when your application needs to do just that. For whatever reason. In this case you will want for such a book to be removed not only from the underlying database but from the cache, too. So you annotate <code>deleteBook(Integer bookId)</code> with <code>@CacheEvict</code> as in</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
<span class="annotation">@Transactional</span>
<span class="annotation">@CacheEvict</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>, key = <span class="string"><span class="delimiter">&quot;</span><span class="content">#bookId</span><span class="delimiter">&quot;</span></span>)
<span class="type">void</span> deleteBook(<span class="predefined-type">Integer</span> bookId) {...}
</code></pre> </div> </div> <div class="paragraph"> <p>and you may rest assured that no stray books be left in your application once you decide to remove them.</p> </div> </div> <div class="sect3"> <h4 id="_conclusion"><a class="anchor" href="#_conclusion"></a>1.4.4. Conclusion</h4> <div class="paragraph"> <p>Hopefully you enjoyed our quick tour of Infinispan&#8217;s support for Spring&#8217;s cache abstraction and saw how easy it is for all your caching woes to be taken care of by Infinispan. More information may be found in Spring&#8217;s <a href="http://docs.spring.io/spring-framework/docs/4.1.1.RELEASE/spring-framework-reference/html/cache.html">reference documentation</a>. Also see <a href="http://spring.io/blog/2011/02/23/spring-3-1-m1-cache-abstraction">this link</a> - a very nice posting on the official Spring blog for a somewhat more comprehensive introduction to Spring&#8217;s cache abstraction.</p> </div> </div> </div> <div class="sect2"> <h3 id="_infinispan_modules_for_jboss_as_7_x"><a class="anchor" href="#_infinispan_modules_for_jboss_as_7_x"></a>1.5. Infinispan modules for JBoss AS 7.x</h3> <div class="paragraph"> <p>Since Infinispan 5.2, the distribution includes a set of modules for JBoss AS 7.x. By installing these modules, it is possible to deploy user applications without packaging the Infinispan JARs within the deployments (WARs, EARs, etc), thus minimizing their size. In order not to conflict with the Infinispan modules which are already present within an AS installation, the modules provided by the Infinispan distribution are located within their own slot identified by the <em>major.minor</em> versions (e.g. slot="5.2").</p> </div> <div class="paragraph"> <p>In order to tell the AS deployer that we want to use the Infinispan APIs within our application, we need to add explicit dependencies to the deployment&#8217;s MANIFEST:</p> </div> <div class="listingblock"> <div class="title">MANIFEST.MF</div> <div class="content"> <pre class="CodeRay"><code class="JSON language-JSON">
<span class="error">M</span><span class="error">a</span><span class="error">n</span><span class="error">i</span><span class="error">f</span><span class="error">e</span><span class="error">s</span><span class="error">t</span><span class="error">-</span><span class="error">V</span><span class="error">e</span><span class="error">r</span><span class="error">s</span><span class="error">i</span><span class="error">o</span><span class="error">n</span>: <span class="float">1.0</span>
<span class="error">D</span><span class="error">e</span><span class="error">p</span><span class="error">e</span><span class="error">n</span><span class="error">d</span><span class="error">e</span><span class="error">n</span><span class="error">c</span><span class="error">i</span><span class="error">e</span><span class="error">s</span>: <span class="error">o</span><span class="error">r</span><span class="error">g</span><span class="error">.</span><span class="error">i</span><span class="error">n</span><span class="error">f</span><span class="error">i</span><span class="error">n</span><span class="error">i</span><span class="error">s</span><span class="error">p</span><span class="error">a</span><span class="error">n</span>:<span class="float">5.2</span> <span class="error">s</span><span class="error">e</span><span class="error">r</span><span class="error">v</span><span class="error">i</span><span class="error">c</span><span class="error">e</span><span class="error">s</span>
</code></pre> </div> </div> <div class="paragraph"> <p>If you are using Maven to generate your artifacts, mark the Infinispan dependencies as <em>provided</em> and configure your artifact archiver to generate the appropriate MANIFEST.MF file:</p> </div> <div class="listingblock"> <div class="title">pom.xml</div> <div class="content"> <pre class="CodeRay"><code class="xml language-xml">
<span class="tag">&lt;dependencies&gt;</span>
  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>infinispan-core<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>5.2.0.Final<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;scope&gt;</span>provided<span class="tag">&lt;/scope&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>
  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>infinispan-cachestore-jdbc<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>5.2.0.Final<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;scope&gt;</span>provided<span class="tag">&lt;/scope&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;build&gt;</span>
  <span class="tag">&lt;plugins&gt;</span>
     <span class="tag">&lt;plugin&gt;</span>
       <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
       <span class="tag">&lt;artifactId&gt;</span>maven-war-plugin<span class="tag">&lt;/artifactId&gt;</span>
       <span class="tag">&lt;configuration&gt;</span>
         <span class="tag">&lt;archive&gt;</span>
           <span class="tag">&lt;manifestEntries&gt;</span>
             <span class="tag">&lt;Dependencies&gt;</span>org.infinispan:5.2 services, org.infinispan.cachestore.jdbc:5.2 services<span class="tag">&lt;/Dependencies&gt;</span>
           <span class="tag">&lt;/manifestEntries&gt;</span>
         <span class="tag">&lt;/archive&gt;</span>
      <span class="tag">&lt;/configuration&gt;</span>
    <span class="tag">&lt;/plugin&gt;</span>
  <span class="tag">&lt;/plugins&gt;</span>
<span class="tag">&lt;/build&gt;</span>
</code></pre> </div> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2015-11-10 09:41:33 EST </div> </div> </body> </html>