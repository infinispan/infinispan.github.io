<!DOCTYPE html>
<html lang="en">
<head><meta name="robots" content="noindex">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Embedding Infinispan caches in Java applications</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GPD7V946LB"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-GPD7V946LB');
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css">
<link rel="stylesheet" href="../../css/css.css">
<link rel="stylesheet" href="/assets/css/clipboard.css">
<link rel="stylesheet" href="/assets/css/cookieconsent.css">
<link rel="shortcut icon" type="image/png" href="/favicon.ico" >
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script>
<script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
<script src="/assets/javascript/copy.js" type="text/javascript"></script>
<script src="/assets/javascript/cookieconsent.umd.js" type="text/javascript"></script>
<script src="/assets/javascript/cookieconsent.config.js" type="module"></script>
<script src="../../js/js.js"></script>
<link rel="canonical" href="https://infinispan.org/docs/stable/titles/embedding/embedding.html">
<style>
.hidden {
    display: none;
}

.switch {
    border-width: 1px 1px 0 1px;
    border-style: solid;
    border-color: #7a2518;
    display: inline-block;
}

.switch--item {
    padding: 10px;
    background-color: #ffffff;
    color: #7a2518;
    display: inline-block;
    cursor: pointer;
}

.switch--item.selected {
    background-color: #7a2519;
    color: #ffffff;
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script type="text/javascript">
function addBlockSwitches() {
    $('.primary').each(function() {
        primary = $(this);
        createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
        primary.children('.title').remove();
    });
    $('.secondary').each(function(idx, node) {
        secondary = $(node);
        primary = findPrimary(secondary);
        switchItem = createSwitchItem(secondary, primary.children('.switch'));
        switchItem.content.addClass('hidden');
        findPrimary(secondary).append(switchItem.content);
        secondary.remove();
    });
}

function createBlockSwitch(primary) {
    blockSwitch = $('<div class="switch"></div>');
    primary.prepend(blockSwitch);
    return blockSwitch;
}

function findPrimary(secondary) {
    candidate = secondary.prev();
    while (!candidate.is('.primary')) {
        candidate = candidate.prev();
    }
    return candidate;
}

function createSwitchItem(block, blockSwitch) {
    blockName = block.children('.title').text();
    content = block.children('.content').first().append(block.next('.colist'));
    item = $('<div class="switch--item">' + blockName + '</div>');
    item.on('click', '', content, function(e) {
        $(this).addClass('selected');
        $(this).siblings().removeClass('selected');
        e.data.siblings('.content').addClass('hidden');
        e.data.removeClass('hidden');
    });
    blockSwitch.append(item);
    return {'item': item, 'content': content};
}

$(addBlockSwitches);

</script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Embedding Infinispan caches in Java applications</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#configuring-maven-repository">1. Adding Infinispan to your Maven repository</a>
<ul class="sectlevel2">
<li><a href="#configuring-pom-xml_configuring-maven-repository">1.1. Configuring your project POM</a></li>
</ul>
</li>
<li><a href="#creating-embedded-caches">2. Creating embedded caches</a>
<ul class="sectlevel2">
<li><a href="#installing-embedded_creating-embedded-caches">2.1. Adding Infinispan to your project</a></li>
<li><a href="#configuring-embedded-caches_creating-embedded-caches">2.2. Creating and using embedded caches</a></li>
<li><a href="#cache-modes_creating-embedded-caches">2.3. Cache API</a>
<ul class="sectlevel3">
<li><a href="#advancedcache_api">2.3.1. AdvancedCache API</a>
<ul class="sectlevel4">
<li><a href="#flags">Flags</a></li>
</ul>
</li>
<li><a href="#cache_asynchronous_api">2.3.2. Asynchronous API</a>
<ul class="sectlevel4">
<li><a href="#why_use_such_an_api">Why use such an API?</a></li>
<li><a href="#which_processes_actually_happen_asynchronously">Which processes actually happen asynchronously?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#rbac-embedded">3. Programmatically configuring user roles and permissions</a>
<ul class="sectlevel2">
<li><a href="#default-user-roles_rbac-embedded">3.1. Infinispan user roles and permissions</a>
<ul class="sectlevel3">
<li><a href="#user-permissions_rbac-embedded">3.1.1. Permissions</a></li>
<li><a href="#role-mappers_rbac-embedded">3.1.2. Role and permission mappers</a>
<ul class="sectlevel4">
<li><a href="#mapping_users_to_roles_and_permissions_in_infinispan">Mapping users to roles and permissions in Infinispan</a></li>
</ul>
</li>
<li><a href="#configuring-role-mappers_rbac-embedded">3.1.3. Configuring role mappers</a></li>
</ul>
</li>
<li><a href="#configuring-authorization-embedded_rbac-embedded">3.2. Enabling and configuring authorization for embedded caches</a></li>
<li><a href="#adding-authorization-roles-at-runtime_rbac-embedded">3.3. Adding authorization roles at runtime</a></li>
<li><a href="#executing-secure-caches_rbac-embedded">3.4. Executing code with secure caches</a></li>
<li><a href="#configuring-acl-cache_rbac-embedded">3.5. Configuring the access control list (ACL) cache</a>
<ul class="sectlevel3">
<li><a href="#flushing_acl_caches">3.5.1. Flushing ACL caches</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#statistics-jmx">4. Enabling and configuring Infinispan statistics and JMX monitoring</a>
<ul class="sectlevel2">
<li><a href="#enabling-statistics-embedded_statistics-jmx">4.1. Enabling statistics in embedded caches</a></li>
<li><a href="#configuring-metrics_statistics-jmx">4.2. Configuring Infinispan metrics</a></li>
<li><a href="#enabling-jmx_statistics-jmx">4.3. Registering JMX MBeans</a>
<ul class="sectlevel3">
<li><a href="#enabling-jmx-port_statistics-jmx">4.3.1. Enabling JMX remote ports</a></li>
<li><a href="#jmx-mbeans_statistics-jmx">4.3.2. Infinispan MBeans</a></li>
<li><a href="#registering-jmx-mbean-servers-statistics-jmx">4.3.3. Registering MBeans in custom MBean servers</a></li>
</ul>
</li>
<li><a href="#displaying-metrics-state-transfer_statistics-jmx">4.4. Exporting metrics during a state transfer operation</a></li>
<li><a href="#monitor-xsite-replication">4.5. Monitoring the status of cross-site replication</a></li>
</ul>
</li>
<li><a href="#cluster-transport">5. Setting up Infinispan cluster transport</a>
<ul class="sectlevel2">
<li><a href="#default-jgroups-stacks_cluster-transport">5.1. Default JGroups stacks</a></li>
<li><a href="#cluster-discovery-protocols_cluster-transport">5.2. Cluster discovery protocols</a>
<ul class="sectlevel3">
<li><a href="#discovery-ping_cluster-transport">5.2.1. PING</a></li>
<li><a href="#discovery-tcpping_cluster-transport">5.2.2. TCPPING</a></li>
<li><a href="#discovery-mping_cluster-transport">5.2.3. MPING</a></li>
<li><a href="#discovery-tcp-gossip_cluster-transport">5.2.4. TCPGOSSIP</a></li>
<li><a href="#discovery-jdbcping_cluster-transport">5.2.5. JDBC_PING2</a>
<ul class="sectlevel4">
<li><a href="#discovery-jdbcping-datasource_cluster-transport">Using a server datasource for JDBC_PING2 discovery</a></li>
</ul>
</li>
<li><a href="#discovery-dns-ping_cluster-transport">5.2.6. DNS_PING</a></li>
<li><a href="#jgroups-cloud-discovery-protocols_cluster-transport">5.2.7. Cloud discovery protocols</a></li>
</ul>
</li>
<li><a href="#using-jgroups-default-stacks_cluster-transport">5.3. Using the default JGroups stacks</a></li>
<li><a href="#customizing-jgroups-stacks_cluster-transport">5.4. Customizing JGroups stacks</a>
<ul class="sectlevel3">
<li><a href="#jgroups-inheritance-attributes_cluster-transport">5.4.1. Inheritance attributes</a></li>
</ul>
</li>
<li><a href="#using-jgroups-system-properties_cluster-transport">5.5. Using JGroups system properties</a>
<ul class="sectlevel3">
<li><a href="#jgroups-system-properties_cluster-transport">5.5.1. Cluster transport properties</a></li>
<li><a href="#jgroups-extras-properties_cluster-transport">5.5.2. System properties for cloud discovery protocols</a>
<ul class="sectlevel4">
<li><a href="#amazon_ec2">Amazon EC2</a></li>
<li><a href="#google_cloud_platform">Google Cloud Platform</a></li>
<li><a href="#azure">Azure</a></li>
<li><a href="#kubernetes">Kubernetes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#using-inline-jgroups-stacks_cluster-transport">5.6. Using inline JGroups stacks</a></li>
<li><a href="#using-external-jgroups-stacks_cluster-transport">5.7. Using external JGroups stacks</a></li>
<li><a href="#using-custom-jchannels_cluster-transport">5.8. Using custom JChannels</a></li>
<li><a href="#secure-cluster-transport">5.9. Encrypting cluster transport</a>
<ul class="sectlevel3">
<li><a href="#jgroups-encryption-protocols_secure-cluster-transport">5.9.1. JGroups encryption protocols</a></li>
<li><a href="#configuring-jgroups-asym-encrypt_secure-cluster-transport">5.9.2. Securing cluster transport with asymmetric encryption</a></li>
<li><a href="#configuring-jgroups-sym-encrypt_secure-cluster-transport">5.9.3. Securing cluster transport with symmetric encryption</a></li>
</ul>
</li>
<li><a href="#jgroups-ports_cluster-transport">5.10. TCP and UDP ports for cluster traffic</a></li>
</ul>
</li>
<li><a href="#clustered_locks">6. Clustered Locks</a>
<ul class="sectlevel2">
<li><a href="#lock_api-locking">6.1. Lock API</a></li>
<li><a href="#using_clustered_locks-locking">6.2. Using Clustered Locks</a></li>
<li><a href="#configuring_clustered_locks-locking">6.3. Configuring Internal Caches for Locks</a></li>
</ul>
</li>
<li><a href="#cluster-executor">7. Executing code in the grid</a>
<ul class="sectlevel2">
<li><a href="#executing-code-grid_cluster-executor">7.1. Cluster Executor</a>
<ul class="sectlevel3">
<li><a href="#filtering_execution_nodes">7.1.1. Filtering execution nodes</a></li>
<li><a href="#timeout">7.1.2. Timeout</a></li>
<li><a href="#single_node_submission">7.1.3. Single Node Submission</a>
<ul class="sectlevel4">
<li><a href="#failover">Failover</a></li>
</ul>
</li>
<li><a href="#example_pi_approximation">7.1.4. Example: PI Approximation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#streams">8. Using the Streams API for code execution</a></li>
<li><a href="#streams_streams">9. Streams</a>
<ul class="sectlevel2">
<li><a href="#common_stream_operations">9.1. Common stream operations</a></li>
<li><a href="#key_filtering">9.2. Key filtering</a></li>
<li><a href="#segment_based_filtering">9.3. Segment based filtering</a></li>
<li><a href="#localinvalidation">9.4. Local/Invalidation</a></li>
<li><a href="#example">9.5. Example</a></li>
<li><a href="#distributionreplicationscattered">9.6. Distribution/Replication/Scattered</a>
<ul class="sectlevel3">
<li><a href="#rehash_aware">9.6.1. Rehash Aware</a></li>
<li><a href="#serialization">9.6.2. Serialization</a></li>
</ul>
</li>
<li><a href="#parallel_computation">9.7. Parallel Computation</a></li>
<li><a href="#task_timeout">9.8. Task timeout</a></li>
<li><a href="#injection">9.9. Injection</a></li>
<li><a href="#distributed_stream_execution">9.10. Distributed Stream execution</a></li>
<li><a href="#key_based_rehash_aware_operators">9.11. Key based rehash aware operators</a></li>
<li><a href="#intermediate_operation_exceptions">9.12. Intermediate operation exceptions</a></li>
<li><a href="#examples">9.13. Examples</a></li>
</ul>
</li>
<li><a href="#ispn_modules">10. Using Infinispan in WildFly applications</a>
<ul class="sectlevel2">
<li><a href="#configure_ispn_modules">10.1. Configuring applications to Use Infinispan modules</a></li>
<li><a href="#configuring-caches-in-jboss_server">10.2. Configuring Infinispan caches in WildFly</a></li>
<li><a href="#using-cahches-in-jboss-applications_server">10.3. Using Infinispan caches in WildFly applications</a></li>
</ul>
</li>
<li><a href="#quarkus_embedded">11. Using the Quarkus extension</a>
<ul class="sectlevel2">
<li><a href="#quarkus_embedded_dependencies">11.1. Quarkus dependencies</a></li>
<li><a href="#quarkus_inject_embedded">11.2. Injecting Embedded Caches</a></li>
<li><a href="#quarkus_native_compilation">11.3. Compiling Quarkus Infinispan application</a></li>
</ul>
</li>
<li><a href="#cdi_support">12. Using the CDI Extension</a>
<ul class="sectlevel2">
<li><a href="#cdi_dependencies">12.1. CDI Dependencies</a></li>
<li><a href="#cdi_inject_embed">12.2. Injecting Embedded Caches</a></li>
<li><a href="#cdi_inject_remote">12.3. Injecting Remote Caches</a></li>
<li><a href="#cache_events">12.4. Receiving Cache and Cache Manager Events</a></li>
</ul>
</li>
<li><a href="#multimap-cache">13. Multimap cache</a>
<ul class="sectlevel2">
<li><a href="#using-multimap-cache_multimap-cache">13.1. Multimap Cache</a>
<ul class="sectlevel3">
<li><a href="#installation_and_configuration">13.1.1. Installation and configuration</a></li>
<li><a href="#multimapcache_api">13.1.2. MultimapCache API</a></li>
<li><a href="#creating_a_multimap_cache">13.1.3. Creating a Multimap Cache</a>
<ul class="sectlevel4">
<li><a href="#embedded_mode">Embedded mode</a></li>
</ul>
</li>
<li><a href="#multimap_limitations">13.1.4. Limitations</a>
<ul class="sectlevel4">
<li><a href="#support_for_duplicates">Support for duplicates</a></li>
<li><a href="#eviction">Eviction</a></li>
<li><a href="#transactions">Transactions</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#custom_interceptors_chapter">14. Custom Interceptors</a>
<ul class="sectlevel2">
<li><a href="#adding_custom_interceptors_declaratively">14.1. Adding custom interceptors declaratively</a></li>
<li><a href="#adding_custom_interceptors_programmatically">14.2. Adding custom interceptors programmatically</a></li>
<li><a href="#custom_interceptor_design">14.3. Custom interceptor design</a></li>
</ul>
</li>
<li><a href="#functional-map-api">15. Functional Map API</a>
<ul class="sectlevel2">
<li><a href="#using-functional-map-api">15.1. Using the Functional Map API</a>
<ul class="sectlevel3">
<li><a href="#asynchronous_and_lazy">15.1.1. Asynchronous and Lazy</a></li>
<li><a href="#function_transparency">15.1.2. Function transparency</a></li>
<li><a href="#constructing_functional_maps">15.1.3. Constructing Functional Maps</a></li>
<li><a href="#read_only_map_api">15.1.4. Read-Only Map API</a>
<ul class="sectlevel4">
<li><a href="#read_only_entry_view">Read-Only Entry View</a></li>
</ul>
</li>
<li><a href="#write_only_map_api">15.1.5. Write-Only Map API</a>
<ul class="sectlevel4">
<li><a href="#write_only_entry_view">Write-Only Entry View</a></li>
</ul>
</li>
<li><a href="#read_write_map_api">15.1.6. Read-Write Map API</a>
<ul class="sectlevel4">
<li><a href="#read_write_entry_view">Read-Write Entry View</a></li>
</ul>
</li>
<li><a href="#meta_parameter">15.1.7. Metadata Parameter Handling</a></li>
<li><a href="#_invocation_parameter">15.1.8. Invocation Parameter</a></li>
<li><a href="#functional_listeners">15.1.9. Functional Listeners</a>
<ul class="sectlevel4">
<li><a href="#write_listeners">Write Listeners</a></li>
<li><a href="#read_write_listeners">Read-Write Listeners</a></li>
</ul>
</li>
<li><a href="#marshalling_of_functions">15.1.10. Marshalling of Functions</a></li>
<li><a href="#use_cases_for_functional_api">15.1.11. Use Cases for Functional API</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#anchored-keys">16. Anchored keys</a>
<ul class="sectlevel2">
<li><a href="#anchored_keys_module">16.1. Anchored Keys module</a>
<ul class="sectlevel3">
<li><a href="#background">16.1.1. Background</a></li>
<li><a href="#architecture">16.1.2. Architecture</a></li>
<li><a href="#limitations">16.1.3. Limitations</a></li>
<li><a href="#configuration">16.1.4. Configuration</a></li>
<li><a href="#implementation_status">16.1.5. Implementation status</a>
<ul class="sectlevel4">
<li><a href="#functional_commands">Functional commands</a></li>
<li><a href="#partition_handling">Partition handling</a></li>
<li><a href="#listeners">Listeners</a></li>
</ul>
</li>
<li><a href="#performance_considerations">16.1.6. Performance considerations</a>
<ul class="sectlevel4">
<li><a href="#clientserver_latency">Client/Server Latency</a></li>
<li><a href="#memory_overhead">Memory overhead</a></li>
<li><a href="#state_transfer">State transfer</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#extending">17. Extending Infinispan</a>
<ul class="sectlevel2">
<li><a href="#custom_commands">17.1. Custom Commands</a>
<ul class="sectlevel3">
<li><a href="#an_example">17.1.1. An Example</a></li>
<li><a href="#preassigned_custom_command_id_ranges">17.1.2. Preassigned Custom Command Id Ranges</a></li>
</ul>
</li>
<li><a href="#extending_the_configuration_builders_and_parsers">17.2. Extending the configuration builders and parsers</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Add Infinispan libraries to your Java project and create embedded caches that store data in the same memory space where you execute application code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-maven-repository"><a class="anchor" href="#configuring-maven-repository"></a>1. Adding Infinispan to your Maven repository</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan Java distributions are available from Maven.</p>
</div>
<div class="paragraph">
<p>Infinispan artifacts are available from Maven central. See the <a href="https://search.maven.org/search?q=g:org.infinispan">org.infinispan</a> group for available Infinispan artifacts.</p>
</div>
<div class="sect2">
<h3 id="configuring-pom-xml_configuring-maven-repository"><a class="anchor" href="#configuring-pom-xml_configuring-maven-repository"></a>1.1. Configuring your project POM</h3>
<div class="paragraph">
<p>Configure Project Object Model (POM) files in your project to use Infinispan dependencies for embedded caches, Hot Rod clients, and other capabilities.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your project <code>pom.xml</code> for editing.</p>
</li>
<li>
<p>Define the <code>version.infinispan</code> property with the correct Infinispan version.</p>
</li>
<li>
<p>Include the <code>infinispan-bom</code> in a <code>dependencyManagement</code> section.</p>
<div class="paragraph">
<p>The Bill Of Materials (BOM) controls dependency versions, which avoids version
conflicts and means you do not need to set the version for each Infinispan
artifact you add as a dependency to your project.</p>
</div>
</li>
<li>
<p>Save and close <code>pom.xml</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following example shows the Infinispan version and BOM:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;properties&gt;
  &lt;version.infinispan&gt;15.0.16.Final&lt;/version.infinispan&gt;
&lt;/properties&gt;

&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
      &lt;artifactId&gt;infinispan-bom&lt;/artifactId&gt;
      &lt;version&gt;${version.infinispan}&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Next Steps</div>
<p>Add Infinispan artifacts as dependencies to your <code>pom.xml</code> as required.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-embedded-caches"><a class="anchor" href="#creating-embedded-caches"></a>2. Creating embedded caches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan provides an <code>EmbeddedCacheManager</code> API that lets you control both the Cache Manager and embedded cache lifecycles programmatically.</p>
</div>
<div class="sect2">
<h3 id="installing-embedded_creating-embedded-caches"><a class="anchor" href="#installing-embedded_creating-embedded-caches"></a>2.1. Adding Infinispan to your project</h3>
<div class="paragraph">
<p>Add Infinispan to your project to create embedded caches in your applications.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Configure your project to get Infinispan artifacts from the Maven repository.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Add the <code>infinispan-core</code> artifact as a dependency in your <code>pom.xml</code> as
follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
    &lt;artifactId&gt;infinispan-core&lt;/artifactId&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-embedded-caches_creating-embedded-caches"><a class="anchor" href="#configuring-embedded-caches_creating-embedded-caches"></a>2.2. Creating and using embedded caches</h3>
<div class="paragraph">
<p>Infinispan provides a <code>GlobalConfigurationBuilder</code> API that controls the Cache Manager and a <code>ConfigurationBuilder</code> API that configures caches.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Add the <code>infinispan-core</code> artifact as a dependency in your <code>pom.xml</code>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Initialize a <code>CacheManager</code>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You must always call the <code>cacheManager.start()</code> method to initialize a <code>CacheManager</code> before you can create caches.
Default constructors do this for you but there are overloaded versions of the constructors that do not.</p>
</div>
<div class="paragraph">
<p>Cache Managers are also heavyweight objects and Infinispan recommends instantiating only one instance per JVM.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Use the <code>ConfigurationBuilder</code> API to define cache configuration.</p>
</li>
<li>
<p>Obtain caches with <code>getCache()</code>, <code>createCache()</code>, or <code>getOrCreateCache()</code> methods.</p>
<div class="paragraph">
<p>Infinispan recommends using the <code>getOrCreateCache()</code> method because it either creates a cache on all nodes or returns an existing cache.</p>
</div>
</li>
<li>
<p>If necessary use the <code>PERMANENT</code> flag for caches to survive restarts.</p>
</li>
<li>
<p>Stop the <code>CacheManager</code> by calling the <code>cacheManager.stop()</code> method to release JVM resources and gracefully shutdown any caches.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">// Set up a clustered Cache Manager.
GlobalConfigurationBuilder global = GlobalConfigurationBuilder.defaultClusteredBuilder();
// Initialize the default Cache Manager.
DefaultCacheManager cacheManager = new DefaultCacheManager(global.build());
// Create a distributed cache with synchronous replication.
ConfigurationBuilder builder = new ConfigurationBuilder();
                     builder.clustering().cacheMode(CacheMode.DIST_SYNC);
// Obtain a volatile cache.
Cache&lt;String, String&gt; cache = cacheManager.administration().withFlags(CacheContainerAdmin.AdminFlag.VOLATILE).getOrCreateCache("myCache", builder.build());
// Stop the Cache Manager.
cacheManager.stop();</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title"><code>getCache()</code> method</div>
<p>Invoke the <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getCache(java.lang.String)"><code>getCache(String)</code></a> method to obtain caches, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">Cache&lt;String, String&gt; myCache = manager.getCache("myCache");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding operation creates a cache named <code>myCache</code>, if it does not already exist, and returns it.</p>
</div>
<div class="paragraph">
<p>Using the <code>getCache()</code> method creates the cache only on the node where you invoke the method. In other words, it performs a local operation that must be invoked on each node across the cluster. Typically, applications deployed across multiple nodes obtain caches during initialization to ensure that caches are <em>symmetric</em> and exist on each node.</p>
</div>
<div class="paragraph">
<div class="title"><code>createCache()</code> method</div>
<p>Invoke the <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/manager/EmbeddedCacheManagerAdmin.html#createCache(java.lang.String,java.lang.String)"><code>createCache()</code></a> method to create caches dynamically across the entire cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Cache&lt;String, String&gt; myCache = manager.administration().createCache("myCache", "myTemplate");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding operation also automatically creates caches on any nodes that subsequently join the cluster.</p>
</div>
<div class="paragraph">
<p>Caches that you create with the <code>createCache()</code> method are ephemeral by default. If the entire cluster shuts down, the cache is not automatically created again when it restarts.</p>
</div>
<div class="paragraph">
<div class="title"><code>PERMANENT</code> flag</div>
<p>Use the PERMANENT flag to ensure that caches can survive restarts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">Cache&lt;String, String&gt; myCache = manager.administration().withFlags(AdminFlag.PERMANENT).createCache("myCache", "myTemplate");</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the PERMANENT flag to take effect, you must enable global state and set a configuration storage provider.</p>
</div>
<div class="paragraph">
<p>For more information about configuration storage providers, see <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/configuration/global/GlobalStateConfigurationBuilder.html#configurationStorage(org.infinispan.globalstate.ConfigurationStorage)">GlobalStateConfigurationBuilder#configurationStorage()</a>.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html">EmbeddedCacheManager</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/configuration/global/package-summary.html">EmbeddedCacheManager Configuration</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/configuration/global/GlobalConfiguration.html">org.infinispan.configuration.global.GlobalConfiguration</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/configuration/cache/ConfigurationBuilder.html">org.infinispan.configuration.cache.ConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="cache-modes_creating-embedded-caches"><a class="anchor" href="#cache-modes_creating-embedded-caches"></a>2.3. Cache API</h3>
<div class="paragraph">
<p>Infinispan provides a <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html">Cache</a> interface that exposes simple methods for adding, retrieving and removing entries, including atomic mechanisms exposed by the JDK&#8217;s ConcurrentMap interface.  Based on the cache mode used, invoking these methods will trigger a number of things to happen, potentially even including replicating an entry to a remote node or looking up an entry from a remote node, or potentially a cache store.</p>
</div>
<div class="paragraph">
<p>For simple usage, using the Cache API should be no different from using the JDK Map API, and hence migrating from simple in-memory caches based on a Map to Infinispan&#8217;s Cache should be trivial.</p>
</div>
<div class="paragraph">
<div class="title">Performance Concerns of Certain Map Methods</div>
<p>Certain methods exposed in Map have certain performance consequences when used with Infinispan, such as
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html#size()">size()</a> ,
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html#values()">values()</a> ,
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html#keySet()">keySet()</a> and
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html#entrySet()">entrySet()</a> .
Specific methods on the <code>keySet</code>, <code>values</code> and <code>entrySet</code> are fine for use please see their Javadoc for further details.</p>
</div>
<div class="paragraph">
<p>Attempting to perform these operations globally would have large performance impact as well as become a scalability bottleneck.  As such, these methods should only be used for informational or debugging purposes only.</p>
</div>
<div class="paragraph">
<p>It should be noted that using certain flags with the <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/AdvancedCache.html#withFlags(java.util.Collection)">withFlags()</a> method can mitigate some of these concerns, please check each method&#8217;s documentation for more details.</p>
</div>
<div class="paragraph">
<div class="title">Mortal and Immortal Data</div>
<p>Further to simply storing entries, Infinispan&#8217;s cache API allows you to attach mortality information to data.  For example, simply using <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/Map.html#put-K-V-">put(key, value)</a> would create an <em>immortal</em> entry, i.e., an entry that lives in the cache forever, until it is removed (or evicted from memory to prevent running out of memory).  If, however, you put data in the cache using <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/commons/api/BasicCache.html#put(K,V,long,java.util.concurrent.TimeUnit)">put(key, value, lifespan, timeunit)</a> , this creates a <em>mortal</em> entry, i.e., an entry that has a fixed lifespan and expires after that lifespan.</p>
</div>
<div class="paragraph">
<p>In addition to <em>lifespan</em> , Infinispan also supports <em>maxIdle</em> as an additional metric with which to determine expiration.  Any combination of lifespans or maxIdles can be used.</p>
</div>
<div class="paragraph">
<div class="title"><code>putForExternalRead</code> operation</div>
<p>Infinispan&#8217;s <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html">Cache</a> class contains a different 'put' operation called <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K,V)">putForExternalRead</a> . This operation is particularly useful when Infinispan is used as a temporary cache for data that is persisted elsewhere.  Under heavy read scenarios, contention in the cache should not delay the real transactions at hand, since caching should just be an optimization and not something that gets in the way.</p>
</div>
<div class="paragraph">
<p>To achieve this, <code>putForExternalRead()</code> acts as a put call that only operates if the key is not present in the cache, and fails fast and silently if another thread is trying to store the same key at the same time. In this particular scenario, caching data is a way to optimise the system and it&#8217;s not desirable that a failure in caching affects the on-going transaction, hence why failure is handled differently. <code>putForExternalRead()</code> is considered to be a fast operation because regardless of whether it&#8217;s successful or not, it doesn&#8217;t wait for any locks, and so returns to the caller promptly.</p>
</div>
<div class="paragraph">
<p>To understand how to use this operation, let&#8217;s look at basic example. Imagine a cache of Person instances, each keyed by a PersonId , whose data originates in a separate data store. The following code shows the most common pattern of using <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K,V)">putForExternalRead</a> within the context of this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// Id of the person to look up, provided by the application
PersonId id = ...;

// Get a reference to the cache where person instances will be stored
Cache&lt;PersonId, Person&gt; cache = ...;

// First, check whether the cache contains the person instance
// associated with with the given id
Person cachedPerson = cache.get(id);

if (cachedPerson == null) {
   // The person is not cached yet, so query the data store with the id
   Person person = dataStore.lookup(id);

   // Cache the person along with the id so that future requests can
   // retrieve it from memory rather than going to the data store
   cache.putForExternalRead(id, person);
} else {
   // The person was found in the cache, so return it to the application
   return cachedPerson;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K,V)">putForExternalRead</a> should never be used as a mechanism to update the cache with a new Person instance originating from application execution (i.e. from a transaction that modifies a Person&#8217;s address). When updating cached values, please use the standard <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/Map.html#put-K-V-">put</a> operation, otherwise the possibility of caching corrupt data is likely.</p>
</div>
<div class="sect3">
<h4 id="advancedcache_api"><a class="anchor" href="#advancedcache_api"></a>2.3.1. AdvancedCache API</h4>
<div class="paragraph">
<p>In addition to the simple Cache interface, Infinispan offers an <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> interface, geared towards extension authors.  The AdvancedCache offers the ability to access certain internal components and to apply flags to alter the default behavior of certain cache methods.  The following code snippet depicts how an AdvancedCache can be obtained:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">AdvancedCache advancedCache = cache.getAdvancedCache();</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="flags"><a class="anchor" href="#flags"></a>Flags</h5>
<div class="paragraph">
<p>Flags are applied to regular cache methods to alter the behavior of certain methods.  For a list of all available flags, and their effects, see the <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/context/Flag.html">Flag</a> enumeration.  Flags are applied using <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/AdvancedCache.html#withFlags(java.util.Collection)">AdvancedCache.withFlags()</a> .  This builder method can be used to apply any number of flags to a cache invocation, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">advancedCache.withFlags(Flag.CACHE_MODE_LOCAL, Flag.SKIP_LOCKING)
   .withFlags(Flag.FORCE_SYNCHRONOUS)
   .put("hello", "world");</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cache_asynchronous_api"><a class="anchor" href="#cache_asynchronous_api"></a>2.3.2. Asynchronous API</h4>
<div class="paragraph">
<p>In addition to synchronous API methods like <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/Map.html#put-K-V-">Cache.put()</a> , <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/Map.html#remove-java.lang.Object-">Cache.remove()</a> , etc., Infinispan also has an asynchronous, non-blocking API where you can achieve the same results in a non-blocking fashion.</p>
</div>
<div class="paragraph">
<p>These methods are named in a similar fashion to their blocking counterparts, with "Async" appended.  E.g., <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/commons/api/AsyncCache.html#putAsync(K,V)">Cache.putAsync()</a> , <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/commons/api/AsyncCache.html#removeAsync(java.lang.Object)">Cache.removeAsync()</a> , etc.  These asynchronous counterparts return a <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a> that contains the actual result of the operation.</p>
</div>
<div class="paragraph">
<p>For example, in a cache parameterized as <code>Cache&lt;String, String&gt;</code>, <code>Cache.put(String key, String value)</code> returns <code>String</code> while <code>Cache.putAsync(String key, String value)</code> returns <code>CompletableFuture&lt;String&gt;</code>.</p>
</div>
<div class="sect4">
<h5 id="why_use_such_an_api"><a class="anchor" href="#why_use_such_an_api"></a>Why use such an API?</h5>
<div class="paragraph">
<p>Non-blocking APIs are powerful in that they provide all of the guarantees of synchronous communications - with the ability to handle communication failures and exceptions - with the ease of not having to block until a call completes.  This allows you to better harness parallelism in your system.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Set&lt;CompletableFuture&lt;?&gt;&gt; futures = new HashSet&lt;&gt;();
futures.add(cache.putAsync(key1, value1)); // does not block
futures.add(cache.putAsync(key2, value2)); // does not block
futures.add(cache.putAsync(key3, value3)); // does not block

// the remote calls for the 3 puts will effectively be executed
// in parallel, particularly useful if running in distributed mode
// and the 3 keys would typically be pushed to 3 different nodes
// in the cluster

// check that the puts completed successfully
for (CompletableFuture&lt;?&gt; f: futures) f.get();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="which_processes_actually_happen_asynchronously"><a class="anchor" href="#which_processes_actually_happen_asynchronously"></a>Which processes actually happen asynchronously?</h5>
<div class="paragraph">
<p>There are 4 things in Infinispan that can be considered to be on the critical path of a typical write operation.
These are, in order of cost:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>network calls</p>
</li>
<li>
<p>marshalling</p>
</li>
<li>
<p>writing to a cache store (optional)</p>
</li>
<li>
<p>locking</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using the async methods will take the network calls and marshalling off the critical path.  For various technical reasons, writing to a cache store and acquiring locks, however, still happens in the caller&#8217;s thread.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rbac-embedded"><a class="anchor" href="#rbac-embedded"></a>3. Programmatically configuring user roles and permissions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Configure security authorization programmatically when using embedded caches in Java applications.</p>
</div>
<div class="sect2">
<h3 id="default-user-roles_rbac-embedded"><a class="anchor" href="#default-user-roles_rbac-embedded"></a>3.1. Infinispan user roles and permissions</h3>
<div class="paragraph">
<p>Infinispan includes several roles that provide users with permissions to access caches and Infinispan resources.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Role</th>
<th class="tableblock halign-left valign-top">Permissions</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>admin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Superuser with all permissions including control of the Cache Manager lifecycle.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deployer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_READ, ALL_WRITE, LISTEN, EXEC, MONITOR, CREATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Can create and delete Infinispan resources in addition to <code>application</code> permissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>application</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_READ, ALL_WRITE, LISTEN, EXEC, MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Has read and write access to Infinispan resources in addition to <code>observer</code> permissions. Can also listen to events and execute server tasks and scripts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>observer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_READ, MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Has read access to Infinispan resources in addition to <code>monitor</code> permissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>monitor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Can view statistics via JMX and the <code>metrics</code> endpoint.</p></td>
</tr>
</tbody>
</table>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/security/AuthorizationPermission.html">org.infinispan.security.AuthorizationPermission Enum</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/configdocs/">Infinispan configuration schema reference</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="user-permissions_rbac-embedded"><a class="anchor" href="#user-permissions_rbac-embedded"></a>3.1.1. Permissions</h4>
<div class="paragraph">
<p>User roles are sets of permissions with different access levels.</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<caption class="title">Table 1. Cache Manager permissions</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONFIGURATION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>defineConfiguration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines new cache configurations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LISTEN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>addListener</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registers listeners against a Cache Manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LIFECYCLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stop</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stops the Cache Manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CREATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createCache</code>, <code>removeCache</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create and remove container resources  such as caches, counters, schemas, and scripts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getStats</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows access to JMX statistics and the <code>metrics</code> endpoint.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Includes all Cache Manager permissions.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<caption class="title">Table 2. Cache permissions</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">READ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>get</code>, <code>contains</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieves entries from a cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WRITE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>put</code>, <code>putIfAbsent</code>, <code>replace</code>, <code>remove</code>, <code>evict</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Writes, replaces, removes, evicts data in a cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXEC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>distexec</code>, <code>streams</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows code execution against a cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LISTEN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>addListener</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registers listeners against a cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BULK_READ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keySet</code>, <code>values</code>, <code>entrySet</code>, <code>query</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executes bulk retrieve operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BULK_WRITE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clear</code>, <code>putAll</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executes bulk write operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LIFECYCLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>start</code>, <code>stop</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starts and stops a cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ADMIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getVersion</code>, <code>addInterceptor*</code>, <code>removeInterceptor</code>, <code>getInterceptorChain</code>, <code>getEvictionManager</code>, <code>getComponentRegistry</code>, <code>getDistributionManager</code>, <code>getAuthorizationManager</code>, <code>evict</code>, <code>getRpcManager</code>, <code>getCacheConfiguration</code>, <code>getCacheManager</code>, <code>getInvocationContextContainer</code>, <code>setAvailability</code>, <code>getDataContainer</code>, <code>getStats</code>, <code>getXAResource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows access to underlying components and internal structures.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getStats</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows access to JMX statistics and the <code>metrics</code> endpoint.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Includes all cache permissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_READ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Combines the READ and BULK_READ permissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_WRITE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Combines the WRITE and BULK_WRITE permissions.</p></td>
</tr>
</tbody>
</table>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/security/package-summary.html">Infinispan Security API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="role-mappers_rbac-embedded"><a class="anchor" href="#role-mappers_rbac-embedded"></a>3.1.2. Role and permission mappers</h4>
<div class="paragraph">
<p>Infinispan implements users as a collection of principals.
Principals represent either an individual user identity, such as a username, or a group to which the users belong. Internally, these are implemented with the <code>javax.security.auth.Subject</code> class.</p>
</div>
<div class="paragraph">
<p>To enable authorization, the principals must be mapped to role names, which are then expanded into a set of permissions.</p>
</div>
<div class="paragraph">
<p>Infinispan includes the <code>PrincipalRoleMapper</code> API for associating security principals to roles, and the <code>RolePermissionMapper</code> API for associating roles with specific permissions.</p>
</div>
<div class="paragraph">
<p>Infinispan provides the following role and permission mapper implementations:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Cluster role mapper</dt>
<dd>
<p>Stores principal to role mappings in the cluster registry.</p>
</dd>
<dt class="hdlist1">Cluster permission mapper</dt>
<dd>
<p>Stores role to permission mappings in the cluster registry. Allows you to dynamically modify user roles and permissions.</p>
</dd>
<dt class="hdlist1">Identity role mapper</dt>
<dd>
<p>Uses the principal name as the role name. The type or format of the principal name depends on the source. For example, in an LDAP directory the principal name could be a Distinguished Name (DN).</p>
</dd>
<dt class="hdlist1">Common name role mapper</dt>
<dd>
<p>Uses the Common Name (CN) as the role name. You can use this role mapper with an LDAP directory or with client certificates that contain Distinguished Names (DN); for example <code>cn=managers,ou=people,dc=example,dc=com</code> maps to the <code>managers</code> role.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, principal-to-role mapping is only applied to principals which represent groups.
It is possible to configure Infinispan to also perform the mapping for user principals by setting the
<code>authorization.group-only-mapping</code> configuration attribute to <code>false</code>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="mapping_users_to_roles_and_permissions_in_infinispan"><a class="anchor" href="#mapping_users_to_roles_and_permissions_in_infinispan"></a>Mapping users to roles and permissions in Infinispan</h5>
<div class="paragraph">
<p>Consider the following user retrieved from an LDAP server, as a collection of DNs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CN=myapplication,OU=applications,DC=mycompany
CN=dataprocessors,OU=groups,DC=mycompany
CN=finance,OU=groups,DC=mycompany</pre>
</div>
</div>
<div class="paragraph">
<p>Using the <strong>Common name role mapper</strong>, the user would be mapped to the following roles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dataprocessors
finance</pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan has the following role definitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dataprocessors: ALL_WRITE ALL_READ
finance: LISTEN</pre>
</div>
</div>
<div class="paragraph">
<p>The user would have the following permissions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ALL_WRITE ALL_READ LISTEN</pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/security/package-summary.html">Infinispan Security API</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/security/PrincipalRoleMapper.html">org.infinispan.security.PrincipalRoleMapper</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/security/RolePermissionMapper.html">org.infinispan.security.RolePermissionMapper</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/security/mappers/IdentityRoleMapper.html">org.infinispan.security.mappers.IdentityRoleMapper</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/security/mappers/CommonNameRoleMapper.html">org.infinispan.security.mappers.CommonNameRoleMapper</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-role-mappers_rbac-embedded"><a class="anchor" href="#configuring-role-mappers_rbac-embedded"></a>3.1.3. Configuring role mappers</h4>
<div class="paragraph">
<p>Infinispan enables the cluster role mapper and cluster permission mapper by default.
To use a different implementation for role mapping, you must configure the role mappers.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Declare the role mapper as part of the security authorization in the Cache Manager configuration.</p>
</li>
<li>
<p>Save the changes to your configuration.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>With embedded caches you can programmatically configure role and permission mappers with the <code>principalRoleMapper()</code> and <code>rolePermissionMapper()</code> methods.</p>
</div>
<h5 id="role_mapper_configuration" class="discrete">Role mapper configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;cache-container&gt;
  &lt;security&gt;
    &lt;authorization&gt;
      &lt;common-name-role-mapper /&gt;
    &lt;/authorization&gt;
  &lt;/security&gt;
&lt;/cache-container&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "security" : {
        "authorization" : {
          "common-name-role-mapper": {}
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    security:
      authorization:
        commonNameRoleMapper: ~</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/configdocs/">Infinispan configuration schema reference</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-authorization-embedded_rbac-embedded"><a class="anchor" href="#configuring-authorization-embedded_rbac-embedded"></a>3.2. Enabling and configuring authorization for embedded caches</h3>
<div class="paragraph">
<p>When using embedded caches, you can configure authorization with the <code>GlobalSecurityConfigurationBuilder</code> and <code>ConfigurationBuilder</code> classes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Construct a <code>GlobalConfigurationBuilder</code> and enable security authorization with the <code>security().authorization().enable()</code> method.</p>
</li>
<li>
<p>Specify a role mapper with the <code>principalRoleMapper()</code> method.</p>
</li>
<li>
<p>If required, define custom role and permission mappings with the <code>role()</code> and <code>permission()</code> methods.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">GlobalConfigurationBuilder global = new GlobalConfigurationBuilder();
  global.security().authorization().enable()
          .principalRoleMapper(new ClusterRoleMapper())
          .role("myroleone").permission(AuthorizationPermission.ALL_WRITE)
          .role("myroletwo").permission(AuthorizationPermission.ALL_READ);</code></pre>
</div>
</div>
</li>
<li>
<p>Enable authorization for caches in the <code>ConfigurationBuilder</code>.</p>
<div class="ulist">
<ul>
<li>
<p>Add all roles from the global configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder config = new ConfigurationBuilder();
config.security().authorization().enable();</code></pre>
</div>
</div>
</li>
<li>
<p>Explicitly define roles for a cache so that Infinispan denies access for users who do not have the role.</p>
<div class="listingblock">
<div class="content">
<pre>ConfigurationBuilder config = new ConfigurationBuilder();
config.security().authorization().enable().role("myroleone");</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/configuration/global/GlobalSecurityConfigurationBuilder.html">org.infinispan.configuration.global.GlobalSecurityConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/configuration/cache/ConfigurationBuilder.html">org.infinispan.configuration.cache.ConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="adding-authorization-roles-at-runtime_rbac-embedded"><a class="anchor" href="#adding-authorization-roles-at-runtime_rbac-embedded"></a>3.3. Adding authorization roles at runtime</h3>
<div class="paragraph">
<p>Dynamically map roles to permissions when using security authorization with Infinispan caches.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Configure authorization for embedded caches.</p>
</li>
<li>
<p>Have <code>ADMIN</code> permissions for Infinispan.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Obtain the <code>RolePermissionMapper</code> instance.</p>
</li>
<li>
<p>Define new roles with the <code>addRole()</code> method.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">MutableRolePermissionMapper mapper = (MutableRolePermissionMapper) cacheManager.getCacheManagerConfiguration().security().authorization().rolePermissionMapper();
mapper.addRole(Role.newRole("myroleone", true, AuthorizationPermission.ALL_WRITE, AuthorizationPermission.LISTEN));
mapper.addRole(Role.newRole("myroletwo", true, AuthorizationPermission.READ, AuthorizationPermission.WRITE));</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/security/RolePermissionMapper.html">org.infinispan.security.RolePermissionMapper</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="executing-secure-caches_rbac-embedded"><a class="anchor" href="#executing-secure-caches_rbac-embedded"></a>3.4. Executing code with secure caches</h3>
<div class="paragraph">
<p>When you construct a <code>DefaultCacheManager</code> for an embedded cache that uses security authorization, the Cache Manager returns a <code>SecureCache</code> that checks the security context before invoking any operations.
A <code>SecureCache</code> also ensures that applications cannot retrieve lower-level insecure objects such as <code>DataContainer</code>.
For this reason, you must execute code with a Infinispan user that has a role with the appropriate level of permission.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Configure authorization for embedded caches.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>If necessary, retrieve the current Subject from the Infinispan context:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Security.getSubject();</code></pre>
</div>
</div>
</li>
<li>
<p>Wrap method calls in a <code>PrivilegedAction</code> to execute them with the Subject.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Security.doAs(mySubject, (PrivilegedAction&lt;String&gt;)() -&gt; cache.put("key", "value"));</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/security/Security.html">org.infinispan.security.Security</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/security/SecureCache.html">org.infinispan.security.SecureCache</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="configuring-acl-cache_rbac-embedded"><a class="anchor" href="#configuring-acl-cache_rbac-embedded"></a>3.5. Configuring the access control list (ACL) cache</h3>
<div class="paragraph">
<p>When you grant or deny roles to users, Infinispan stores details about which users can access your caches internally.
This ACL cache improves performance for security authorization by avoiding the need for Infinispan to calculate if users have the appropriate permissions to perform read and write operations for every request.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Whenever you grant or deny roles to users, Infinispan flushes the ACL cache to ensure it applies user permissions correctly.
This means that Infinispan must recalculate cache permissions for all users each time you grant or deny roles.
For best performance you should not frequently or repeatedly grant and deny roles in production environments.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Specify the maximum number of entries for the ACL cache with the <code>cache-size</code> attribute.</p>
<div class="paragraph">
<p>Entries in the ACL cache have a cardinality of <code>caches * users</code>. You should set the maximum number of entries to a value that can hold information for all your caches and users. For example, the default size of <code>1000</code> is appropriate for deployments with up to 100 caches and 10 users.</p>
</div>
</li>
<li>
<p>Set the timeout value, in milliseconds, with the <code>cache-timeout</code> attribute.</p>
<div class="paragraph">
<p>If Infinispan does not access an entry in the ACL cache within the timeout period that entry is evicted. When the user subsequently attempts cache operations then Infinispan recalculates their cache permissions and adds an entry to the ACL cache.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Specifying a value of <code>0</code> for either the <code>cache-size</code> or <code>cache-timeout</code> attribute disables the ACL cache.
You should disable the ACL cache only if you disable authorization.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Save the changes to your configuration.</p>
</li>
</ol>
</div>
<h4 id="acl_cache_configuration" class="discrete">ACL cache configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container name="acl-cache-configuration"&gt;
    &lt;security cache-size="1000"
              cache-timeout="300000"&gt;
      &lt;authorization/&gt;
    &lt;/security&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "name" : "acl-cache-configuration",
      "security" : {
        "cache-size" : "1000",
        "cache-timeout" : "300000",
        "authorization" : {}
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    name: "acl-cache-configuration"
    security:
      cache-size: "1000"
      cache-timeout: "300000"
      authorization: ~</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="flushing_acl_caches"><a class="anchor" href="#flushing_acl_caches"></a>3.5.1. Flushing ACL caches</h4>
<div class="paragraph">
<p>It is possible to flush the ACL cache using the <code>GlobalSecurityManager</code> MBean, accessible over JMX.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/configdocs/">Infinispan configuration schema reference</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="statistics-jmx"><a class="anchor" href="#statistics-jmx"></a>4. Enabling and configuring Infinispan statistics and JMX monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan can provide Cache Manager and cache statistics as well as export JMX MBeans.</p>
</div>
<div class="sect2">
<h3 id="enabling-statistics-embedded_statistics-jmx"><a class="anchor" href="#enabling-statistics-embedded_statistics-jmx"></a>4.1. Enabling statistics in embedded caches</h3>
<div class="paragraph">
<p>Configure Infinispan to export statistics for the Cache Manager and embedded caches.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add the <code>statistics="true"</code> attribute or the <code>.statistics(true)</code> method.</p>
</li>
<li>
<p>Save and close your Infinispan configuration.</p>
</li>
</ol>
</div>
<h4 id="embedded_cache_statistics" class="discrete">Embedded cache statistics</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container statistics="true"&gt;
    &lt;distributed-cache statistics="true"/&gt;
    &lt;replicated-cache statistics="true"/&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">GlobalConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">GlobalConfigurationBuilder global = GlobalConfigurationBuilder.defaultClusteredBuilder().cacheContainer().statistics(true);
DefaultCacheManager cacheManager = new DefaultCacheManager(global.build());

Configuration builder = new ConfigurationBuilder();
builder.statistics().enable();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-metrics_statistics-jmx"><a class="anchor" href="#configuring-metrics_statistics-jmx"></a>4.2. Configuring Infinispan metrics</h3>
<div class="paragraph">
<p>Infinispan generates metrics that are compatible with any monitoring system.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gauges provide values such as the average number of nanoseconds for write operations or JVM uptime.</p>
</li>
<li>
<p>Histograms provide details about operation execution times such as read,
write, and remove times.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, Infinispan generates gauges when you enable statistics but you can also configure it to generate histograms.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan metrics are provided at the <code>vendor</code> scope.
Metrics related to the JVM are provided in the <code>base</code> scope.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must add Micrometer Core and Micrometer Registry Prometheus JARs to your classpath to export Infinispan metrics for embedded caches.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add the <code>metrics</code> element or object to the cache container.</p>
</li>
<li>
<p>Enable or disable gauges with the <code>gauges</code> attribute or field.</p>
</li>
<li>
<p>Enable or disable histograms with the <code>histograms</code> attribute or field.</p>
</li>
<li>
<p>Enable or disable the inclusion of element names as tags using the <code>names-as-tags</code> attribute or field.</p>
</li>
<li>
<p>Save and close your client configuration.</p>
</li>
</ol>
</div>
<h4 id="metrics_configuration" class="discrete">Metrics configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container statistics="true"&gt;
    &lt;metrics gauges="true"
             histograms="true" /&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "statistics" : "true",
      "metrics" : {
        "gauges" : "true",
        "histograms" : "true"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    statistics: "true"
    metrics:
      gauges: "true"
      histograms: "true"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">GlobalConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">GlobalConfiguration globalConfig = new GlobalConfigurationBuilder()
  //Computes and collects statistics for the Cache Manager.
  .statistics().enable()
  //Exports collected statistics as gauge and histogram metrics.
  .metrics().gauges(true).histograms(true)
  .build();</code></pre>
</div>
</div>
<h5 id="names_as_tags" class="discrete">Names as tags</h5>
<div class="paragraph">
<p>By default, element identifiers, such as the name of the cache manager and the cache, are embedded into the name of the
metric. Enabling <code>names-as-tags</code> places these identifiers into tags, making the metric name independent.</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container statistics="true"&gt;
    &lt;metrics names_as_tags="true" /&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "statistics" : "true",
      "metrics" : {
        "names-as-tags" : "true"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    statistics: "true"
    metrics:
      namesAsTags: "true"</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../metrics/metrics.html">Infinispan Metrics</a></p>
</li>
<li>
<p><a href="https://micrometer.io/docs/registry/prometheus">Micrometer Prometheus</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="enabling-jmx_statistics-jmx"><a class="anchor" href="#enabling-jmx_statistics-jmx"></a>4.3. Registering JMX MBeans</h3>
<div class="paragraph">
<p>Infinispan can register JMX MBeans that you can use to collect statistics and
perform administrative operations.
You must also enable statistics otherwise Infinispan provides <code>0</code> values for all statistic attributes in JMX MBeans.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use JMX Mbeans for collecting statistics only when Infinispan is embedded in applications and not with a remote Infinispan server.</p>
</div>
<div class="paragraph">
<p>When you use JMX Mbeans for collecting statistics from a remote Infinispan server, the data received from JMX Mbeans might differ from the data received from other APIs such as REST. In such cases the data received from the other APIs is more accurate.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add the <code>jmx</code> element or object to the cache container and specify <code>true</code> as the value for the <code>enabled</code> attribute or field.</p>
</li>
<li>
<p>Add the <code>domain</code> attribute or field and specify the domain where JMX MBeans are exposed, if required.</p>
</li>
<li>
<p>Save and close your client configuration.</p>
</li>
</ol>
</div>
<h4 id="jmx_configuration" class="discrete">JMX configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container statistics="true"&gt;
    &lt;jmx enabled="true"
         domain="example.com"/&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "statistics" : "true",
      "jmx" : {
        "enabled" : "true",
        "domain" : "example.com"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    statistics: "true"
    jmx:
      enabled: "true"
      domain: "example.com"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">GlobalConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">GlobalConfiguration global = GlobalConfigurationBuilder.defaultClusteredBuilder()
   .jmx().enable()
   .domain("org.mydomain");</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="enabling-jmx-port_statistics-jmx"><a class="anchor" href="#enabling-jmx-port_statistics-jmx"></a>4.3.1. Enabling JMX remote ports</h4>
<div class="paragraph">
<p>Provide unique remote JMX ports to expose Infinispan MBeans through connections in JMXServiceURL format.</p>
</div>
<div class="paragraph">
<p>You can enable remote JMX ports using one of the following approaches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable remote JMX ports that require authentication to one of the Infinispan Server security realms.</p>
</li>
<li>
<p>Enable remote JMX ports manually using the standard Java management configuration options.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>For remote JMX with authentication, define JMX specific user roles using the default security realm.
Users must have <code>controlRole</code> with read/write access or the <code>monitorRole</code> with read-only access to access any JMX resources.
Infinispan automatically maps global <code>ADMIN</code> and <code>MONITOR</code> permissions to the JMX <code>controlRole</code> and <code>monitorRole</code> roles.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Start Infinispan Server with a remote JMX port enabled using one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable remote JMX through port <code>9999</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>bin/server.sh --jmx 9999</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Using remote JMX with SSL disabled is not intended for production environments.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Pass the following system properties to Infinispan Server at startup.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>bin/server.sh -Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Enabling remote JMX with no authentication or SSL is not secure and not recommended in any environment.
Disabling authentication and SSL allows unauthorized users to connect to your server and access the data hosted there.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../server/server.html#creating-security-realms_security-realms">Creating security realms</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="jmx-mbeans_statistics-jmx"><a class="anchor" href="#jmx-mbeans_statistics-jmx"></a>4.3.2. Infinispan MBeans</h4>
<div class="paragraph">
<p>Infinispan exposes JMX MBeans that represent manageable resources.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>org.infinispan:type=Cache</code></dt>
<dd>
<p>Attributes and operations available for cache instances.</p>
</dd>
<dt class="hdlist1"><code>org.infinispan:type=CacheManager</code></dt>
<dd>
<p>Attributes and operations available for Cache Managers, including Infinispan cache and cluster health statistics.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For a complete list of available JMX MBeans along with descriptions and
available operations and attributes, see the <em>Infinispan JMX Components</em>
documentation.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/jmxComponents.html">Infinispan JMX Components</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="registering-jmx-mbean-servers-statistics-jmx"><a class="anchor" href="#registering-jmx-mbean-servers-statistics-jmx"></a>4.3.3. Registering MBeans in custom MBean servers</h4>
<div class="paragraph">
<p>Infinispan includes an <code>MBeanServerLookup</code> interface that you can use to
register MBeans in custom MBeanServer instances.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an implementation of <code>MBeanServerLookup</code> so that the <code>getMBeanServer()</code> method returns the custom MBeanServer instance.</p>
</li>
<li>
<p>Configure Infinispan to register JMX MBeans.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add the <code>mbean-server-lookup</code> attribute or field to the JMX configuration for the Cache Manager.</p>
</li>
<li>
<p>Specify fully qualified name (FQN) of your <code>MBeanServerLookup</code> implementation.</p>
</li>
<li>
<p>Save and close your client configuration.</p>
</li>
</ol>
</div>
<h5 id="jmx_mbean_server_lookup_configuration" class="discrete">JMX MBean server lookup configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container statistics="true"&gt;
    &lt;jmx enabled="true"
         domain="example.com"
         mbean-server-lookup="com.example.MyMBeanServerLookup"/&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "statistics" : "true",
      "jmx" : {
        "enabled" : "true",
        "domain" : "example.com",
        "mbean-server-lookup" : "com.example.MyMBeanServerLookup"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    statistics: "true"
    jmx:
      enabled: "true"
      domain: "example.com"
      mbeanServerLookup: "com.example.MyMBeanServerLookup"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">GlobalConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">GlobalConfiguration global = GlobalConfigurationBuilder.defaultClusteredBuilder()
   .jmx().enable()
   .domain("org.mydomain")
   .mBeanServerLookup(new com.acme.MyMBeanServerLookup());</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="displaying-metrics-state-transfer_statistics-jmx"><a class="anchor" href="#displaying-metrics-state-transfer_statistics-jmx"></a>4.4. Exporting metrics during a state transfer operation</h3>
<div class="paragraph">
<p>You can export time metrics for clustered caches that Infinispan redistributes across nodes.</p>
</div>
<div class="paragraph">
<p>A state transfer operation occurs when a clustered cache topology changes, such as a node joining or leaving a cluster.
During a state transfer operation, Infinispan exports metrics from each cache, so that you can determine a cache&#8217;s status.
A state transfer exposes attributes as properties, so that Infinispan can export metrics from each cache.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot perform a state transfer operation in invalidation mode.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Infinispan generates time metrics that are compatible with the REST API and the JMX API.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Configure Infinispan metrics.</p>
</li>
<li>
<p>Enable metrics for your cache type, such as embedded cache or remote cache.</p>
</li>
<li>
<p>Initiate a state transfer operation by changing your clustered cache topology.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Choose one of the following methods:</p>
<div class="ulist">
<ul>
<li>
<p>Configure Infinispan to use the REST API to collect metrics.</p>
</li>
<li>
<p>Configure Infinispan to use the JMX API to collect metrics.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../configuring/configuring.html#statistics-jmx">Enabling and configuring Infinispan statistics and JMX monitoring (Infinispan caches)</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocsjmxComponents.html#StateTransferManager"><code>StateTransferManager</code> (Infinispan 15.0 API)</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="monitor-xsite-replication"><a class="anchor" href="#monitor-xsite-replication"></a>4.5. Monitoring the status of cross-site replication</h3>
<div class="paragraph">
<p>Monitor the site status of your backup locations to detect interruptions in the communication between the sites.
When a remote site status changes to <code>offline</code>, Infinispan stops replicating your data to the backup location.
Your data become out of sync and you must fix the inconsistencies before bringing the clusters back online.</p>
</div>
<div class="paragraph">
<p>Monitoring cross-site events is necessary for early problem detection.
Use one of the following monitoring strategies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#monitoring-cross-site-rest">Monitoring cross-site replication with the REST API</a></p>
</li>
<li>
<p><a href="#monitoring-cross-site-prometheus">Monitoring cross-site replication with the Prometheus metrics</a> or any other monitoring system</p>
</li>
</ul>
</div>
<h4 id="monitoring-cross-site-rest" class="discrete">Monitoring cross-site replication with the REST API</h4>
<div class="paragraph">
<p>Monitor the status of cross-site replication for all caches using the REST endpoint.
You can implement a custom script to poll the REST endpoint or use the following example.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Enable cross-site replication.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Implement a script to poll the REST endpoint.</p>
<div class="paragraph">
<p>The following example demonstrates how you can use a Python script to poll the site status every five seconds.</p>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-python" data-lang="python">#!/usr/bin/python3
import time
import requests
from requests.auth import HTTPDigestAuth


class InfinispanConnection:

    def __init__(self, server: str = 'http://localhost:11222', cache_manager: str = 'default',
                 auth: tuple = ('admin', 'change_me')) -&gt; None:
        super().__init__()
        self.__url = f'{server}/rest/v2/container/x-site/backups/'
        self.__auth = auth
        self.__headers = {
            'accept': 'application/json'
        }

    def get_sites_status(self):
        try:
            rsp = requests.get(self.__url, headers=self.__headers, auth=HTTPDigestAuth(self.__auth[0], self.__auth[1]))
            if rsp.status_code != 200:
                return None
            return rsp.json()
        except:
            return None


# Specify credentials for Infinispan user with permission to access the REST endpoint
USERNAME = 'admin'
PASSWORD = 'change_me'
# Set an interval between cross-site status checks
POLL_INTERVAL_SEC = 5
# Provide a list of servers
SERVERS = [
    InfinispanConnection('http://127.0.0.1:11222', auth=(USERNAME, PASSWORD)),
    InfinispanConnection('http://127.0.0.1:12222', auth=(USERNAME, PASSWORD))
]
#Specify the names of remote sites
REMOTE_SITES = [
    'nyc'
]
#Provide a list of caches to monitor
CACHES = [
    'work',
    'sessions'
]


def on_event(site: str, cache: str, old_status: str, new_status: str):
    # TODO implement your handling code here
    print(f'site={site} cache={cache} Status changed {old_status} -&gt; {new_status}')


def __handle_mixed_state(state: dict, site: str, site_status: dict):
    if site not in state:
        state[site] = {c: 'online' if c in site_status['online'] else 'offline' for c in CACHES}
        return

    for cache in CACHES:
        __update_cache_state(state, site, cache, 'online' if cache in site_status['online'] else 'offline')


def __handle_online_or_offline_state(state: dict, site: str, new_status: str):
    if site not in state:
        state[site] = {c: new_status for c in CACHES}
        return

    for cache in CACHES:
        __update_cache_state(state, site, cache, new_status)


def __update_cache_state(state: dict, site: str, cache: str, new_status: str):
    old_status = state[site].get(cache)
    if old_status != new_status:
        on_event(site, cache, old_status, new_status)
        state[site][cache] = new_status


def update_state(state: dict):
    rsp = None
    for conn in SERVERS:
        rsp = conn.get_sites_status()
        if rsp:
            break
    if rsp is None:
        print('Unable to fetch site status from any server')
        return

    for site in REMOTE_SITES:
        site_status = rsp.get(site, {})
        new_status = site_status.get('status')
        if new_status == 'mixed':
            __handle_mixed_state(state, site, site_status)
        else:
            __handle_online_or_offline_state(state, site, new_status)


if __name__ == '__main__':
    _state = {}
    while True:
        update_state(_state)
        time.sleep(POLL_INTERVAL_SEC)</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a site status changes from <code>online</code> to <code>offline</code> or vice-versa, the function <code>on_event</code> is invoked.</p>
</div>
<div class="paragraph">
<p>If you want to use this script, you must specify the following variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>USERNAME</code> and <code>PASSWORD</code>: The username and password of Infinispan user with permission to access the REST endpoint.</p>
</li>
<li>
<p><code>POLL_INTERVAL_SEC</code>: The number of seconds between polls.</p>
</li>
<li>
<p><code>SERVERS</code>: The list of Infinispan Servers at this site.
The script only requires a single valid response but the list is provided to allow fail over.</p>
</li>
<li>
<p><code>REMOTE_SITES</code>: The list of remote sites to monitor on these servers.</p>
</li>
<li>
<p><code>CACHES</code>: The list of cache names to monitor.</p>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../rest/rest.html#rest_v2_cache_manager_site_status_rest">REST API: Getting status of backup locations</a></p>
</li>
</ul>
</div>
<h4 id="monitoring-cross-site-prometheus" class="discrete">Monitoring cross-site replication with the Prometheus metrics</h4>
<div class="paragraph">
<p>Prometheus, and other monitoring systems, let you configure alerts to detect when a site status changes to <code>offline</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Monitoring cross-site latency metrics can help you to discover potential issues.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Enable cross-site replication.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure Infinispan metrics.</p>
</li>
<li>
<p>Configure alerting rules using the Prometheus metrics format.</p>
<div class="ulist">
<ul>
<li>
<p>For the site status, use <code>1</code> for <code>online</code> and <code>0</code> for <code>offline</code>.</p>
</li>
<li>
<p>For the <code>expr</code> filed, use the following format:<br>
<code>vendor_cache_manager_default_cache_&lt;cache name&gt;_x_site_admin_&lt;site name&gt;_status</code>.</p>
<div class="paragraph">
<p>In the following example, Prometheus alerts you when the <strong>NYC</strong> site gets <code>offline</code> for cache named <code>work</code> or <code>sessions</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">groups:
- name: Cross Site Rules
  rules:
  - alert: Cache Work and Site NYC
    expr: vendor_cache_manager_default_cache_work_x_site_admin_nyc_status == 0
  - alert: Cache Sessions and Site NYC
    expr: vendor_cache_manager_default_cache_sessions_x_site_admin_nyc_status == 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following image shows an alert that the <strong>NYC</strong> site is <code>offline</code> for cache <code>work</code>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/prometheus_xsite_alert.png" alt="prometheus xsite alert">
</div>
<div class="title">Figure 1. Prometheus Alert</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../server/server.html#configuring-metrics_statistics-jmx">Configuring Infinispan metrics</a></p>
</li>
<li>
<p><a href="https://prometheus.io/docs/alerting/latest/overview/">Prometheus Alerting Overview</a></p>
</li>
<li>
<p><a href="https://grafana.com/docs/grafana/latest/alerting/">Grafana Alerting Documentation</a></p>
</li>
<li>
<p><a href="https://docs.openshift.com/container-platform/latest/monitoring/managing-alerts.html#creating-alerting-rules-for-user-defined-projects_managing-alerts">Openshift Managing Alerts</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cluster-transport"><a class="anchor" href="#cluster-transport"></a>5. Setting up Infinispan cluster transport</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan requires a transport layer so nodes can automatically join and leave clusters.
The transport layer also enables Infinispan nodes to replicate or distribute data across the network and perform operations such as re-balancing and state transfer.</p>
</div>
<div class="sect2">
<h3 id="default-jgroups-stacks_cluster-transport"><a class="anchor" href="#default-jgroups-stacks_cluster-transport"></a>5.1. Default JGroups stacks</h3>
<div class="paragraph">
<p>Infinispan provides default JGroups stack files, <code>default-jgroups-*.xml</code>, in the <code>default-configs</code> directory inside the <code>infinispan-core-15.0.16.Final.jar</code> file.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File name</th>
<th class="tableblock halign-left valign-top">Stack name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-udp.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>udp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses UDP for transport and UDP multicast for discovery. Suitable for larger clusters (over 100 nodes) or if you are using replicated caches or invalidation mode. Minimizes the number of open sockets.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-tcp.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tcp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses TCP for transport and the <code>MPING</code> protocol for discovery, which uses
<code>UDP</code> multicast. Suitable for smaller clusters (under 100 nodes) <em>only if</em> you are using distributed caches because TCP is more efficient than UDP as a point-to-point protocol.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-kubernetes.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kubernetes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses TCP for transport and <code>DNS_PING</code> for discovery. Suitable for Kubernetes and Red Hat OpenShift nodes where UDP multicast is not always available.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-ec2.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ec2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses TCP for transport and <code>aws.S3_PING</code> for discovery. Suitable for Amazon EC2 nodes where UDP multicast is not available. Requires additional dependencies.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-google.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>google</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses TCP for transport and <code>GOOGLE_PING2</code> for discovery. Suitable for Google Cloud Platform nodes where UDP multicast is not available. Requires additional dependencies.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-azure.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>azure</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses TCP for transport and <code>AZURE_PING</code> for discovery. Suitable for Microsoft Azure nodes where UDP multicast is not available. Requires additional dependencies.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-tunnel.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tunnel</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses <code>TUNNEL</code> for transport.
Suitable for environments where the Infinispan is behind a firewall and direct connection between Infinispan nodes is impossible.
It requires an external and accessible service (<a href="http://jgroups.org/manual5/index.html#TUNNEL_Advanced">Gossip Router</a>) to redirect the traffic.
It requires <code>jgroups.tunnel.hosts</code> property to be set in the format <code>host1[port],host2[port],&#8230;&#8203;</code> with the Gossip Router(s) hosts and ports.</p></td>
</tr>
</tbody>
</table>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html#protlist">JGroups Protocols</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="cluster-discovery-protocols_cluster-transport"><a class="anchor" href="#cluster-discovery-protocols_cluster-transport"></a>5.2. Cluster discovery protocols</h3>
<div class="paragraph">
<p>Infinispan supports different protocols that allow nodes to automatically find each other on the network and form clusters.</p>
</div>
<div class="paragraph">
<p>There are two types of discovery mechanisms that Infinispan can use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generic discovery protocols that work on most networks and do not rely on external services.</p>
</li>
<li>
<p>Discovery protocols that rely on external services to store and retrieve topology information for Infinispan clusters.<br>
For instance the DNS_PING protocol performs discovery through DNS server records.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Running Infinispan on hosted platforms requires using discovery mechanisms that are adapted to network constraints that individual cloud providers impose.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html#DiscoveryProtocols">JGroups Discovery Protocols</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="discovery-ping_cluster-transport"><a class="anchor" href="#discovery-ping_cluster-transport"></a>5.2.1. PING</h4>
<div class="paragraph">
<p>PING, or UDPPING is a generic JGroups discovery mechanism that uses dynamic multicasting with the UDP protocol.</p>
</div>
<div class="paragraph">
<p>When joining, nodes send PING requests to an IP multicast address to discover other nodes already in the Infinispan cluster.
Each node responds to the PING request with a packet that contains the address of the coordinator node and its own address. C=coordinator’s address and A=own address.
If no nodes respond to the PING request, the joining node becomes the coordinator node in a new cluster.</p>
</div>
<div class="listingblock">
<div class="title">PING configuration example</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;PING num_discovery_runs="3"/&gt;</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html#PING">JGroups PING</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="discovery-tcpping_cluster-transport"><a class="anchor" href="#discovery-tcpping_cluster-transport"></a>5.2.2. TCPPING</h4>
<div class="paragraph">
<p>TCPPING is a generic JGroups discovery mechanism that uses a list of static addresses for cluster members.</p>
</div>
<div class="paragraph">
<p>With TCPPING, you manually specify the IP address or hostname of each node in the Infinispan cluster as part of the JGroups stack, rather than letting nodes discover each other dynamically.</p>
</div>
<div class="listingblock">
<div class="title">TCPPING configuration example</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;TCP bind_port="7800" /&gt;
&lt;TCPPING timeout="3000"
         initial_hosts="${jgroups.tcpping.initial_hosts:hostname1[port1],hostname2[port2]}"
         port_range="0"
         num_initial_members="3"/&gt;</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html#TCPPING_Prot">JGroups TCPPING</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="discovery-mping_cluster-transport"><a class="anchor" href="#discovery-mping_cluster-transport"></a>5.2.3. MPING</h4>
<div class="paragraph">
<p>MPING uses IP multicast to discover the initial membership of Infinispan clusters.</p>
</div>
<div class="paragraph">
<p>You can use MPING to replace TCPPING discovery with TCP stacks and use multicasing for discovery instead of static lists of initial hosts.
However, you can also use MPING with UDP stacks.</p>
</div>
<div class="listingblock">
<div class="title">MPING configuration example</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;MPING mcast_addr="${jgroups.mcast_addr:239.6.7.8}"
       mcast_port="${jgroups.mcast_port:46655}"
       num_discovery_runs="3"
       ip_ttl="${jgroups.udp.ip_ttl:2}"/&gt;</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html#MPING">JGroups MPING</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="discovery-tcp-gossip_cluster-transport"><a class="anchor" href="#discovery-tcp-gossip_cluster-transport"></a>5.2.4. TCPGOSSIP</h4>
<div class="paragraph">
<p>Gossip routers provide a centralized location on the network from which your
Infinispan cluster can retrieve addresses of other nodes.</p>
</div>
<div class="paragraph">
<p>You inject the address (<code>IP:PORT</code>) of the Gossip router into Infinispan nodes as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pass the address as a system property to the JVM; for example, <code>-DGossipRouterAddress="10.10.2.4[12001]"</code>.</p>
</li>
<li>
<p>Reference that system property in the JGroups configuration file.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Gossip router configuration example</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;TCP bind_port="7800" /&gt;
&lt;TCPGOSSIP timeout="3000"
           initial_hosts="${GossipRouterAddress}"
           num_initial_members="3" /&gt;</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html#TCPGOSSIP_Prot">JGroups Gossip Router</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="discovery-jdbcping_cluster-transport"><a class="anchor" href="#discovery-jdbcping_cluster-transport"></a>5.2.5. JDBC_PING2</h4>
<div class="paragraph">
<p>JDBC_PING2 uses shared databases to store information about Infinispan clusters.
This protocol supports any database that can use a JDBC connection.</p>
</div>
<div class="paragraph">
<p>Nodes write their IP addresses to the shared database so joining nodes can find the Infinispan cluster on the network.
When nodes leave Infinispan clusters, they delete their IP addresses from the shared database.</p>
</div>
<div class="listingblock">
<div class="title">JDBC_PING2 configuration example</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;JDBC_PING2 connection_url="jdbc:mysql://localhost:3306/database_name"
           connection_username="user"
           connection_password="password"
           connection_driver="com.mysql.jdbc.Driver"/&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Add the appropriate JDBC driver to the classpath so Infinispan can use JDBC_PING2.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="discovery-jdbcping-datasource_cluster-transport"><a class="anchor" href="#discovery-jdbcping-datasource_cluster-transport"></a>Using a server datasource for JDBC_PING2 discovery</h5>
<div class="paragraph">
<p>Add a managed datasource to a Infinispan Server and use it to provide database connections for the cluster transport JDBC_PING2 discovery protocol.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Install a Infinispan Server cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy a JDBC driver JAR to your Infinispan Server <code>server/lib</code> directory</p>
</li>
<li>
<p>Create a datasource for your database.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;server xmlns="urn:infinispan:server:15.0"&gt;
  &lt;data-sources&gt;
     &lt;!-- Defines a unique name for the datasource and JNDI name that you
          reference in JDBC cache store configuration.
          Enables statistics for the datasource, if required. --&gt;
     &lt;data-source name="ds"
                  jndi-name="jdbc/postgres"
                  statistics="true"&gt;
        &lt;!-- Specifies the JDBC driver that creates connections. --&gt;
        &lt;connection-factory driver="org.postgresql.Driver"
                            url="jdbc:postgresql://localhost:5432/postgres"
                            username="postgres"
                            password="changeme"&gt;
           &lt;!-- Sets optional JDBC driver-specific connection properties. --&gt;
           &lt;connection-property name="name"&gt;value&lt;/connection-property&gt;
        &lt;/connection-factory&gt;
        &lt;!-- Defines connection pool tuning properties. --&gt;
        &lt;connection-pool initial-size="1"
                         max-size="10"
                         min-size="3"
                         background-validation="1000"
                         idle-removal="1"
                         blocking-timeout="1000"
                         leak-detection="10000"/&gt;
     &lt;/data-source&gt;
  &lt;/data-sources&gt;
&lt;/server&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Create a JGroups stack which uses the <code>JDBC_PING2</code> protocol for discovery.</p>
</li>
<li>
<p>Configure cluster transport to use the datasource by specifying the name of the datasource with the <code>server:data-source</code> attribute.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
    &lt;jgroups&gt;
        &lt;stack name="jdbc" extends="tcp"&gt;
            &lt;JDBC_PING2 stack.combine="REPLACE" stack.position="MPING" /&gt;
        &lt;/stack&gt;
    &lt;/jgroups&gt;
    &lt;cache-container&gt;
        &lt;transport stack="jdbc" server:data-source="ds" /&gt;
    &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html#JDBC_PING2">JDBC_PING2 documentation</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="discovery-dns-ping_cluster-transport"><a class="anchor" href="#discovery-dns-ping_cluster-transport"></a>5.2.6. DNS_PING</h4>
<div class="paragraph">
<p>JGroups DNS_PING queries DNS servers to discover Infinispan cluster members
in Kubernetes environments such as OKD and Red Hat OpenShift.</p>
</div>
<div class="listingblock">
<div class="title">DNS_PING configuration example</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dns.DNS_PING dns_query="myservice.myproject.svc.cluster.local" /&gt;</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html#_dns_ping">JGroups DNS_PING</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/">DNS for Services and Pods</a> (Kubernetes documentation for adding DNS entries)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="jgroups-cloud-discovery-protocols_cluster-transport"><a class="anchor" href="#jgroups-cloud-discovery-protocols_cluster-transport"></a>5.2.7. Cloud discovery protocols</h4>
<div class="paragraph">
<p>Infinispan includes default JGroups stacks that use discovery protocol implementations that are specific to cloud providers.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Discovery protocol</th>
<th class="tableblock halign-left valign-top">Default stack file</th>
<th class="tableblock halign-left valign-top">Artifact</th>
<th class="tableblock halign-left valign-top">Version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aws.S3_PING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-ec2.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.jgroups.aws:jgroups-aws</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.0.0.Final</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GOOGLE_PING2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-google.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.jgroups.google:jgroups-google</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.0.0.Final</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>azure.AZURE_PING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-azure.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.jgroups.azure:jgroups-azure</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.0.2.Final</code></p></td>
</tr>
</tbody>
</table>
<h5 id="providing_dependencies_for_cloud_discovery_protocols" class="discrete">Providing dependencies for cloud discovery protocols</h5>
<div class="paragraph">
<p>To use <code>aws.S3_PING</code>, <code>GOOGLE_PING2</code>, or <code>azure.AZURE_PING</code> cloud discovery protocols, you need to provide dependent libraries to Infinispan.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Add the artifact dependencies to your project <code>pom.xml</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can then configure the cloud discovery protocol as part of a JGroups stack file or with system properties.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://github.com/jgroups-extras/jgroups-aws">JGroups aws.S3_PING</a></p>
</li>
<li>
<p><a href="https://github.com/jgroups-extras/jgroups-google">JGroups GOOGLE_PING2</a></p>
</li>
<li>
<p><a href="https://github.com/jgroups-extras/jgroups-azure">JGroups azure.AZURE_PING</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-jgroups-default-stacks_cluster-transport"><a class="anchor" href="#using-jgroups-default-stacks_cluster-transport"></a>5.3. Using the default JGroups stacks</h3>
<div class="paragraph">
<p>Infinispan uses JGroups protocol stacks so nodes can send each other messages on dedicated cluster channels.</p>
</div>
<div class="paragraph">
<p>Infinispan provides preconfigured JGroups stacks for <code>UDP</code> and <code>TCP</code> protocols.
You can use these default stacks as a starting point for building custom cluster transport configuration that is optimized for your network requirements.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Do one of the following to use one of the default JGroups stacks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the <code>stack</code> attribute in your <code>infinispan.xml</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container default-cache="replicatedCache"&gt;
    &lt;!-- Use the default UDP stack for cluster transport. --&gt;
    &lt;transport cluster="${infinispan.cluster.name}"
               stack="udp"
               node-name="${infinispan.node.name:}"/&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Use the <code>addProperty()</code> method to set the JGroups stack file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">GlobalConfiguration globalConfig = new GlobalConfigurationBuilder().transport()
        .defaultTransport()
        .clusterName("qa-cluster")
        //Uses the default-jgroups-udp.xml stack for cluster transport.
        .addProperty("configurationFile", "default-jgroups-udp.xml")
        .build();</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Verification</div>
<p>Infinispan logs the following message to indicate which stack it uses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>[org.infinispan.CLUSTER] ISPN000078: Starting JGroups channel cluster with stack udp</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="customizing-jgroups-stacks_cluster-transport"><a class="anchor" href="#customizing-jgroups-stacks_cluster-transport"></a>5.4. Customizing JGroups stacks</h3>
<div class="paragraph">
<p>Adjust and tune properties to create a cluster transport configuration that works for your network requirements.</p>
</div>
<div class="paragraph">
<p>Infinispan provides attributes that let you extend the default JGroups stacks for easier configuration.
You can inherit properties from the default stacks while combining, removing, and replacing other properties.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new JGroups stack declaration in your <code>infinispan.xml</code> file.</p>
</li>
<li>
<p>Add the <code>extends</code> attribute and specify a JGroups stack to inherit properties from.</p>
</li>
<li>
<p>Use the <code>stack.combine</code> attribute to modify properties for protocols configured in the inherited stack.</p>
</li>
<li>
<p>Use the <code>stack.position</code> attribute to define the location for your custom stack.</p>
</li>
<li>
<p>Specify the stack name as the value for the <code>stack</code> attribute in the <code>transport</code> configuration.</p>
<div class="paragraph">
<p>For example, you might evaluate using a Gossip router and symmetric encryption with the default TCP stack as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;jgroups&gt;
    &lt;!-- Creates a custom JGroups stack named "my-stack". --&gt;
    &lt;!-- Inherits properties from the default TCP stack. --&gt;
    &lt;stack name="my-stack" extends="tcp"&gt;
      &lt;!-- Uses TCPGOSSIP as the discovery mechanism instead of MPING --&gt;
      &lt;TCPGOSSIP initial_hosts="${jgroups.tunnel.gossip_router_hosts:localhost[12001]}"
             stack.combine="REPLACE"
             stack.position="MPING" /&gt;
      &lt;!-- Removes the FD_SOCK2 protocol from the stack. --&gt;
      &lt;FD_SOCK2 stack.combine="REMOVE"/&gt;
      &lt;!-- Modifies the timeout value for the VERIFY_SUSPECT2 protocol. --&gt;
      &lt;VERIFY_SUSPECT2 timeout="2000"/&gt;
      &lt;!-- Adds SYM_ENCRYPT to the stack after VERIFY_SUSPECT2. --&gt;
      &lt;SYM_ENCRYPT sym_algorithm="AES"
                   keystore_name="mykeystore.p12"
                   keystore_type="PKCS12"
                   store_password="changeit"
                   key_password="changeit"
                   alias="myKey"
                   stack.combine="INSERT_AFTER"
                   stack.position="VERIFY_SUSPECT2" /&gt;
    &lt;/stack&gt;
  &lt;/jgroups&gt;
  &lt;cache-container name="default" statistics="true"&gt;
    &lt;!-- Uses "my-stack" for cluster transport. --&gt;
    &lt;transport cluster="${infinispan.cluster.name}"
               stack="my-stack"
               node-name="${infinispan.node.name:}"/&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Check Infinispan logs to ensure it uses the stack.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>[org.infinispan.CLUSTER] ISPN000078: Starting JGroups channel cluster with stack my-stack</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="jgroups-inheritance-attributes_cluster-transport"><a class="anchor" href="#jgroups-inheritance-attributes_cluster-transport"></a>5.4.1. Inheritance attributes</h4>
<div class="paragraph">
<p>When you extend a JGroups stack, inheritance attributes let you adjust protocols and properties in the stack you are extending.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>stack.position</code> specifies protocols to modify.</p>
</li>
<li>
<p><code>stack.combine</code> uses the following values to extend JGroups stacks:</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>COMBINE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overrides protocol properties.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REPLACE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Replaces protocols.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INSERT_AFTER</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adds a protocol into the stack after another protocol.
Does not affect the protocol that you specify as the insertion point.</p>
<p class="tableblock">Protocols in JGroups stacks affect each other based on their location in the stack.
For example, you should put a protocol such as <code>NAKACK2</code> after the <code>SYM_ENCRYPT</code> or <code>ASYM_ENCRYPT</code> protocol so that <code>NAKACK2</code> is secured.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INSERT_BEFORE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inserts a protocols into the stack before another protocol.
Affects the protocol that you specify as the insertion point.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REMOVE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removes protocols from the stack.</p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-jgroups-system-properties_cluster-transport"><a class="anchor" href="#using-jgroups-system-properties_cluster-transport"></a>5.5. Using JGroups system properties</h3>
<div class="paragraph">
<p>Pass system properties to Infinispan at startup to tune cluster transport.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Use <code>-D&lt;property-name&gt;=&lt;property-value&gt;</code> arguments to set JGroups system properties as required.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, set a custom bind port and IP address as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>java -cp ... -Djgroups.bind.port=1234 -Djgroups.bind.address=192.0.2.0</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you embed Infinispan clusters in clustered WildFly applications, JGroups system properties can clash or override each other.</p>
</div>
<div class="paragraph">
<p>For example, you do not set a unique bind address for either your Infinispan cluster or your WildFly application.
In this case both Infinispan and your WildFly application use the JGroups default property and attempt to form clusters using the same bind address.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="jgroups-system-properties_cluster-transport"><a class="anchor" href="#jgroups-system-properties_cluster-transport"></a>5.5.1. Cluster transport properties</h4>
<div class="paragraph">
<p>Use the following properties to customize JGroups cluster transport.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 42.8571%;">
<col style="width: 28.5714%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.bind.address</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bind address for cluster transport.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SITE_LOCAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.bind.port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bind port for the socket.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7800</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.mcast_addr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IP address for multicast, both discovery and inter-cluster communication. The IP address must be a valid "class D" address that is suitable for IP multicast.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>239.6.7.8</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.mcast_port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port for the multicast socket.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>46655</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.ip_ttl</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time-to-live (TTL) for IP multicast packets. The value defines the number of network hops a packet can make before it is dropped.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.thread_pool.min_threads</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Minimum number of threads for the thread pool.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.thread_pool.max_threads</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of threads for the thread pool.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.join_timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of milliseconds to wait for join requests to succeed.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.thread_dumps_enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dump threads when the thread pool is full.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.fd.port-offset</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offset from <code>jgroups.bind.port</code> port for the FD (failure detection protocol) socket.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>50000</code> (port <code>57800</code> )</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.frag_size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of bytes in a message. Messages larger than that are fragmented.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.diag.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables JGroups diagnostic probing.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
</tbody>
</table>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html#SystemProperties">JGroups system properties</a></p>
</li>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html#protlist">JGroups protocol list</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="jgroups-extras-properties_cluster-transport"><a class="anchor" href="#jgroups-extras-properties_cluster-transport"></a>5.5.2. System properties for cloud discovery protocols</h4>
<div class="paragraph">
<p>Use the following properties to configure JGroups discovery protocols for hosted platforms.</p>
</div>
<div class="sect4">
<h5 id="amazon_ec2"><a class="anchor" href="#amazon_ec2"></a>Amazon EC2</h5>
<div class="paragraph">
<p>System properties for configuring <code>aws.S3_PING</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 42.8571%;">
<col style="width: 28.5714%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.s3.region_name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Amazon S3 region.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.s3.bucket_name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Amazon S3 bucket. The name must exist and be unique.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="google_cloud_platform"><a class="anchor" href="#google_cloud_platform"></a>Google Cloud Platform</h5>
<div class="paragraph">
<p>System properties for configuring <code>GOOGLE_PING2</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 42.8571%;">
<col style="width: 28.5714%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.google.bucket_name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Google Compute Engine bucket. The name must exist and be unique.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="azure"><a class="anchor" href="#azure"></a>Azure</h5>
<div class="paragraph">
<p>System properties for azure.AZURE_PING`.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 42.8571%;">
<col style="width: 28.5714%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jboss.jgroups.azure_ping.storage_account_name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Azure storage account. The name must exist and be unique.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jboss.jgroups.azure_ping.storage_access_key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Azure storage access key.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jboss.jgroups.azure_ping.container</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Valid DNS name of the container that stores ping information.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="kubernetes"><a class="anchor" href="#kubernetes"></a>Kubernetes</h5>
<div class="paragraph">
<p>System properties for <code>DNS_PING</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 42.8571%;">
<col style="width: 28.5714%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.dns.query</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the DNS record that returns cluster members.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.dns.record</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the DNS record type.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-inline-jgroups-stacks_cluster-transport"><a class="anchor" href="#using-inline-jgroups-stacks_cluster-transport"></a>5.6. Using inline JGroups stacks</h3>
<div class="paragraph">
<p>You can insert complete JGroups stack definitions into <code>infinispan.xml</code> files.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Embed a custom JGroups stack declaration in your <code>infinispan.xml</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;!-- Contains one or more JGroups stack definitions. --&gt;
  &lt;jgroups&gt;
    &lt;!-- Defines a custom JGroups stack named "prod". --&gt;
    &lt;stack name="prod"&gt;
      &lt;TCP bind_port="7800" port_range="30" recv_buf_size="20000000" send_buf_size="640000"/&gt;
      &lt;RED/&gt;
      &lt;MPING break_on_coord_rsp="true"
             mcast_addr="${jgroups.mping.mcast_addr:239.2.4.6}"
             mcast_port="${jgroups.mping.mcast_port:43366}"
             num_discovery_runs="3"
             ip_ttl="${jgroups.udp.ip_ttl:2}"/&gt;
      &lt;MERGE3 /&gt;
      &lt;FD_SOCK2 /&gt;
      &lt;FD_ALL3 timeout="3000" interval="1000" timeout_check_interval="1000" /&gt;
      &lt;VERIFY_SUSPECT2 timeout="1000" /&gt;
      &lt;pbcast.NAKACK2 use_mcast_xmit="false" xmit_interval="200" xmit_table_num_rows="50"
                      xmit_table_msgs_per_row="1024" xmit_table_max_compaction_time="30000" /&gt;
      &lt;UNICAST3 conn_close_timeout="5000" xmit_interval="200" xmit_table_num_rows="50"
                xmit_table_msgs_per_row="1024" xmit_table_max_compaction_time="30000" /&gt;
      &lt;pbcast.STABLE desired_avg_gossip="2000" max_bytes="1M" /&gt;
      &lt;pbcast.GMS print_local_addr="false" join_timeout="${jgroups.join_timeout:2000}" /&gt;
      &lt;UFC max_credits="4m" min_threshold="0.40" /&gt;
      &lt;MFC max_credits="4m" min_threshold="0.40" /&gt;
      &lt;FRAG4 /&gt;
    &lt;/stack&gt;
  &lt;/jgroups&gt;
  &lt;cache-container default-cache="replicatedCache"&gt;
    &lt;!-- Uses "prod" for cluster transport. --&gt;
    &lt;transport cluster="${infinispan.cluster.name}"
           stack="prod"
           node-name="${infinispan.node.name:}"/&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="using-external-jgroups-stacks_cluster-transport"><a class="anchor" href="#using-external-jgroups-stacks_cluster-transport"></a>5.7. Using external JGroups stacks</h3>
<div class="paragraph">
<p>Reference external files that define custom JGroups stacks in <code>infinispan.xml</code> files.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Put custom JGroups stack files on the application classpath.</p>
<div class="paragraph">
<p>Alternatively you can specify an absolute path when you declare the external stack file.</p>
</div>
</li>
<li>
<p>Reference the external stack file with the <code>stack-file</code> element.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;jgroups&gt;
     &lt;!-- Creates a "prod-tcp" stack that references an external file. --&gt;
     &lt;stack-file name="prod-tcp" path="prod-jgroups-tcp.xml"/&gt;
  &lt;/jgroups&gt;
  &lt;cache-container default-cache="replicatedCache"&gt;
    &lt;!-- Use the "prod-tcp" stack for cluster transport. --&gt;
    &lt;transport stack="prod-tcp" /&gt;
    &lt;replicated-cache name="replicatedCache"/&gt;
  &lt;/cache-container&gt;
  &lt;!-- Cache configuration goes here. --&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can also use the <code>addProperty()</code> method in the <code>TransportConfigurationBuilder</code> class to specify a custom JGroups stack file as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">GlobalConfiguration globalConfig = new GlobalConfigurationBuilder().transport()
        .defaultTransport()
        .clusterName("prod-cluster")
        //Uses a custom JGroups stack for cluster transport.
        .addProperty("configurationFile", "my-jgroups-udp.xml")
        .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, <code>my-jgroups-udp.xml</code> references a UDP stack with custom properties such as the following:</p>
</div>
<div class="listingblock">
<div class="title">Custom UDP stack example</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;config xmlns="urn:org:jgroups"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="urn:org:jgroups http://www.jgroups.org/schema/jgroups-5.3.xsd"&gt;
    &lt;UDP bind_addr="${jgroups.bind_addr:127.0.0.1}"
         mcast_addr="${jgroups.udp.mcast_addr:239.0.2.0}"
         mcast_port="${jgroups.udp.mcast_port:46655}"
         tos="8"
         ucast_recv_buf_size="20000000"
         ucast_send_buf_size="640000"
         mcast_recv_buf_size="25000000"
         mcast_send_buf_size="640000"
         bundler.max_size="64000"
         ip_ttl="${jgroups.udp.ip_ttl:2}"
         diag.enabled="false"
         thread_naming_pattern="pl"
         thread_pool.enabled="true"
         thread_pool.min_threads="2"
         thread_pool.max_threads="30"
         thread_pool.keep_alive_time="5000" /&gt;
    &lt;!-- Other JGroups stack configuration goes here. --&gt;
&lt;/config&gt;</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/configuration/global/TransportConfigurationBuilder.html">org.infinispan.configuration.global.TransportConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="using-custom-jchannels_cluster-transport"><a class="anchor" href="#using-custom-jchannels_cluster-transport"></a>5.8. Using custom JChannels</h3>
<div class="paragraph">
<p>Construct custom JGroups JChannels as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">GlobalConfigurationBuilder global = new GlobalConfigurationBuilder();
JChannel jchannel = new JChannel();
// Configure the jchannel as needed.
JGroupsTransport transport = new JGroupsTransport(jchannel);
global.transport().transport(transport);
new DefaultCacheManager(global.build());</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan cannot use custom JChannels that are already connected.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html#JChannel">JGroups JChannel</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="secure-cluster-transport"><a class="anchor" href="#secure-cluster-transport"></a>5.9. Encrypting cluster transport</h3>
<div class="paragraph">
<p>Secure cluster transport so that nodes communicate with encrypted messages.
You can also configure Infinispan clusters to perform certificate authentication so that only nodes with valid identities can join.</p>
</div>
<div class="sect3">
<h4 id="jgroups-encryption-protocols_secure-cluster-transport"><a class="anchor" href="#jgroups-encryption-protocols_secure-cluster-transport"></a>5.9.1. JGroups encryption protocols</h4>
<div class="paragraph">
<p>To secure cluster traffic, you can configure Infinispan nodes to encrypt JGroups message payloads with secret keys.</p>
</div>
<div class="paragraph">
<p>Infinispan nodes can obtain secret keys from either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The coordinator node (asymmetric encryption).</p>
</li>
<li>
<p>A shared keystore (symmetric encryption).</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Retrieving secret keys from coordinator nodes</div>
<p>You configure asymmetric encryption by adding the <code>ASYM_ENCRYPT</code> protocol to a JGroups stack in your Infinispan configuration.
This allows Infinispan clusters to generate and distribute secret keys.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using asymmetric encryption, you should also provide keystores so that nodes can perform certificate authentication and securely exchange secret keys.
This protects your cluster from man-in-the-middle (MitM) attacks.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Asymmetric encryption secures cluster traffic as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The first node in the Infinispan cluster, the coordinator node, generates a secret key.</p>
</li>
<li>
<p>A joining node performs certificate authentication with the coordinator to mutually verify identity.</p>
</li>
<li>
<p>The joining node requests the secret key from the coordinator node. That request includes the public key for the joining node.</p>
</li>
<li>
<p>The coordinator node encrypts the secret key with the public key and returns it to the joining node.</p>
</li>
<li>
<p>The joining node decrypts and installs the secret key.</p>
</li>
<li>
<p>The node joins the cluster, encrypting and decrypting messages with the secret key.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Retrieving secret keys from shared keystores</div>
<p>You configure symmetric encryption by adding the <code>SYM_ENCRYPT</code> protocol to a JGroups stack in your Infinispan configuration.
This allows Infinispan clusters to obtain secret keys from keystores that you provide.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Nodes install the secret key from a keystore on the Infinispan classpath at startup.</p>
</li>
<li>
<p>Node join clusters, encrypting and decrypting messages with the secret key.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Comparison of asymmetric and symmetric encryption</div>
<p><code>ASYM_ENCRYPT</code> with certificate authentication provides an additional layer of encryption in comparison with <code>SYM_ENCRYPT</code>.
You provide keystores that encrypt the requests to coordinator nodes for the secret key.
Infinispan automatically generates that secret key and handles cluster traffic, while letting you specify when to generate secret keys.
For example, you can configure clusters to generate new secret keys when nodes leave.
This ensures that nodes cannot bypass certificate authentication and join with old keys.</p>
</div>
<div class="paragraph">
<p><code>SYM_ENCRYPT</code>, on the other hand, is faster than <code>ASYM_ENCRYPT</code> because nodes do not need to exchange keys with the cluster coordinator.
A potential drawback to <code>SYM_ENCRYPT</code> is that there is no configuration to automatically generate new secret keys when cluster membership changes.
Users are responsible for generating and distributing the secret keys that nodes use to encrypt cluster traffic.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring-jgroups-asym-encrypt_secure-cluster-transport"><a class="anchor" href="#configuring-jgroups-asym-encrypt_secure-cluster-transport"></a>5.9.2. Securing cluster transport with asymmetric encryption</h4>
<div class="paragraph">
<p>Configure Infinispan clusters to generate and distribute secret keys that encrypt JGroups messages.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a keystore with certificate chains that enables Infinispan to verify node identity.</p>
</li>
<li>
<p>Place the keystore on the classpath for each node in the cluster.</p>
<div class="paragraph">
<p>For Infinispan Server, you put the keystore in the $ISPN_HOME directory.</p>
</div>
</li>
<li>
<p>Add the <code>SSL_KEY_EXCHANGE</code> and <code>ASYM_ENCRYPT</code> protocols to a JGroups stack in your Infinispan configuration, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;jgroups&gt;
    &lt;!-- Creates a secure JGroups stack named "encrypt-tcp" that extends the default TCP stack. --&gt;
    &lt;stack name="encrypt-tcp" extends="tcp"&gt;
      &lt;!-- Adds a keystore that nodes use to perform certificate authentication. --&gt;
      &lt;!-- Uses the stack.combine and stack.position attributes to insert SSL_KEY_EXCHANGE into the default TCP stack after VERIFY_SUSPECT2. --&gt;
      &lt;SSL_KEY_EXCHANGE keystore_name="mykeystore.jks"
                        keystore_password="changeit"
                        stack.combine="INSERT_AFTER"
                        stack.position="VERIFY_SUSPECT2"/&gt;
      &lt;!-- Configures ASYM_ENCRYPT --&gt;
      &lt;!-- Uses the stack.combine and stack.position attributes to insert ASYM_ENCRYPT into the default TCP stack before pbcast.NAKACK2. --&gt;
      &lt;!-- The use_external_key_exchange = "true" attribute configures nodes to use the `SSL_KEY_EXCHANGE` protocol for certificate authentication. --&gt;
      &lt;ASYM_ENCRYPT asym_keylength="2048"
                    asym_algorithm="RSA"
                    change_key_on_coord_leave = "false"
                    change_key_on_leave = "false"
                    use_external_key_exchange = "true"
                    stack.combine="INSERT_BEFORE"
                    stack.position="pbcast.NAKACK2"/&gt;
    &lt;/stack&gt;
  &lt;/jgroups&gt;
  &lt;cache-container name="default" statistics="true"&gt;
    &lt;!-- Configures the cluster to use the JGroups stack. --&gt;
    &lt;transport cluster="${infinispan.cluster.name}"
               stack="encrypt-tcp"
               node-name="${infinispan.node.name:}"/&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Verification</div>
<p>When you start your Infinispan cluster, the following log message indicates that the cluster is using the secure JGroups stack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>[org.infinispan.CLUSTER] ISPN000078: Starting JGroups channel cluster with stack &lt;encrypted_stack_name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan nodes can join the cluster only if they use <code>ASYM_ENCRYPT</code> and can obtain the secret key from the coordinator node.
Otherwise the following message is written to Infinispan logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>[org.jgroups.protocols.ASYM_ENCRYPT] &lt;hostname&gt;: received message without encrypt header from &lt;hostname&gt;; dropping it</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html">JGroups 5 Manual</a></p>
</li>
<li>
<p><a href="http://www.jgroups.org/schema/jgroups-5.3.xsd">JGroups 5.3 Schema</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="configuring-jgroups-sym-encrypt_secure-cluster-transport"><a class="anchor" href="#configuring-jgroups-sym-encrypt_secure-cluster-transport"></a>5.9.3. Securing cluster transport with symmetric encryption</h4>
<div class="paragraph">
<p>Configure Infinispan clusters to encrypt JGroups messages with secret keys from keystores that you provide.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a keystore that contains a secret key.</p>
</li>
<li>
<p>Place the keystore on the classpath for each node in the cluster.</p>
<div class="paragraph">
<p>For Infinispan Server, you put the keystore in the $ISPN_HOME directory.</p>
</div>
</li>
<li>
<p>Add the <code>SYM_ENCRYPT</code> protocol to a JGroups stack in your Infinispan configuration.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;jgroups&gt;
    &lt;!-- Creates a secure JGroups stack named "encrypt-tcp" that extends the default TCP stack. --&gt;
    &lt;stack name="encrypt-tcp" extends="tcp"&gt;
      &lt;!-- Adds a keystore from which nodes obtain secret keys. --&gt;
      &lt;!-- Uses the stack.combine and stack.position attributes to insert SYM_ENCRYPT into the default TCP stack after VERIFY_SUSPECT2. --&gt;
      &lt;SYM_ENCRYPT keystore_name="myKeystore.p12"
                   keystore_type="PKCS12"
                   store_password="changeit"
                   key_password="changeit"
                   alias="myKey"
                   stack.combine="INSERT_AFTER"
                   stack.position="VERIFY_SUSPECT2"/&gt;
    &lt;/stack&gt;
  &lt;/jgroups&gt;
  &lt;cache-container name="default" statistics="true"&gt;
    &lt;!-- Configures the cluster to use the JGroups stack. --&gt;
    &lt;transport cluster="${infinispan.cluster.name}"
               stack="encrypt-tcp"
               node-name="${infinispan.node.name:}"/&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Verification</div>
<p>When you start your Infinispan cluster, the following log message indicates that the cluster is using the secure JGroups stack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>[org.infinispan.CLUSTER] ISPN000078: Starting JGroups channel cluster with stack &lt;encrypted_stack_name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan nodes can join the cluster only if they use <code>SYM_ENCRYPT</code> and can obtain the secret key from the shared keystore.
Otherwise the following message is written to Infinispan logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[org.jgroups.protocols.SYM_ENCRYPT] &lt;hostname&gt;: received message without encrypt header from &lt;hostname&gt;; dropping it</pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual5/index.html">JGroups 5 Manual</a></p>
</li>
<li>
<p><a href="http://www.jgroups.org/schema/jgroups-5.3.xsd">JGroups 5.3 Schema</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jgroups-ports_cluster-transport"><a class="anchor" href="#jgroups-ports_cluster-transport"></a>5.10. TCP and UDP ports for cluster traffic</h3>
<div class="paragraph">
<p>Infinispan uses the following ports for cluster transport messages:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Default Port</th>
<th class="tableblock halign-left valign-top">Protocol</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7800</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP/UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JGroups cluster bind port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>46655</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JGroups multicast</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>57800</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Failure detection is provided by <code>FD_SOCK2</code>.</p></td>
</tr>
</tbody>
</table>
<h4 id="cross_site_replication" class="discrete">Cross-site replication</h4>
<div class="paragraph">
<p>Infinispan uses the following ports for the JGroups RELAY2 protocol:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>7900</code></dt>
<dd>
<p>For Infinispan clusters running on Kubernetes.</p>
</dd>
<dt class="hdlist1"><code>7801</code></dt>
<dd>
<p>For other deployments.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clustered_locks"><a class="anchor" href="#clustered_locks"></a>6. Clustered Locks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clustered locks are data structures that are distributed and shared across
nodes in a Infinispan cluster. Clustered locks allow you to run code that is
synchronized between nodes.</p>
</div>
<div class="sect2">
<h3 id="lock_api-locking"><a class="anchor" href="#lock_api-locking"></a>6.1. Lock API</h3>
<div class="paragraph">
<p>Infinispan provides a <code>ClusteredLock</code> API that lets you concurrently execute
code on a cluster when using Infinispan in embedded mode.</p>
</div>
<div class="paragraph">
<p>The API consists of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ClusteredLock</code> exposes methods to implement clustered locks.</p>
</li>
<li>
<p><code>ClusteredLockManager</code> exposes methods to define, configure, retrieve, and remove clustered locks.</p>
</li>
<li>
<p><code>EmbeddedClusteredLockManagerFactory</code> initializes <code>ClusteredLockManager</code> implementations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Ownership</div>
<p>Infinispan supports <code>NODE</code> ownership so that all nodes in a cluster can use a
lock.</p>
</div>
<div class="paragraph">
<div class="title">Reentrancy</div>
<p>Infinispan clustered locks are non-reentrant so any node in the cluster can
acquire a lock but only the node that creates the lock can release it.</p>
</div>
<div class="paragraph">
<p>If two consecutive lock calls are sent for the same owner, the first call
acquires the lock if it is available and the second call is blocked.</p>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/lock/EmbeddedClusteredLockManagerFactory.html">EmbeddedClusteredLockManagerFactory</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/lock/api/ClusteredLockManager.html">ClusteredLockManager</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/lock/api/ClusteredLock.html">ClusteredLock</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="using_clustered_locks-locking"><a class="anchor" href="#using_clustered_locks-locking"></a>6.2. Using Clustered Locks</h3>
<div class="paragraph">
<p>Learn how to use clustered locks with Infinispan embedded in your application.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Add the <code>infinispan-clustered-lock</code> dependency to your <code>pom.xml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
   &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
   &lt;artifactId&gt;infinispan-clustered-lock&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Initialize the <code>ClusteredLockManager</code> interface from a Cache Manager. This interface is the entry point for defining, retrieving, and removing clustered locks.</p>
</li>
<li>
<p>Give a unique name for each clustered lock.</p>
</li>
<li>
<p>Acquire locks with the <code>lock.tryLock(1, TimeUnit.SECONDS)</code> method.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// Set up a clustered Cache Manager.
GlobalConfigurationBuilder global = GlobalConfigurationBuilder.defaultClusteredBuilder();

// Configure the cache mode, in this case it is distributed and synchronous.
ConfigurationBuilder builder = new ConfigurationBuilder();
builder.clustering().cacheMode(CacheMode.DIST_SYNC);

// Initialize a new default Cache Manager.
DefaultCacheManager cm = new DefaultCacheManager(global.build(), builder.build());

// Initialize a Clustered Lock Manager.
ClusteredLockManager clm1 = EmbeddedClusteredLockManagerFactory.from(cm);

// Define a clustered lock named 'lock'.
clm1.defineLock("lock");

// Get a lock from each node in the cluster.
ClusteredLock lock = clm1.get("lock");

AtomicInteger counter = new AtomicInteger(0);

// Acquire the lock as follows.
// Each 'lock.tryLock(1, TimeUnit.SECONDS)' method attempts to acquire the lock.
// If the lock is not available, the method waits for the timeout period to elapse. When the lock is acquired, other calls to acquire the lock are blocked until the lock is released.
CompletableFuture&lt;Boolean&gt; call1 = lock.tryLock(1, TimeUnit.SECONDS).whenComplete((r, ex) -&gt; {
    if (r) {
        System.out.println("lock is acquired by the call 1");
        lock.unlock().whenComplete((nil, ex2) -&gt; {
            System.out.println("lock is released by the call 1");
            counter.incrementAndGet();
        });
    }
});

CompletableFuture&lt;Boolean&gt; call2 = lock.tryLock(1, TimeUnit.SECONDS).whenComplete((r, ex) -&gt; {
    if (r) {
        System.out.println("lock is acquired by the call 2");
        lock.unlock().whenComplete((nil, ex2) -&gt; {
            System.out.println("lock is released by the call 2");
            counter.incrementAndGet();
        });
    }
});

CompletableFuture&lt;Boolean&gt; call3 = lock.tryLock(1, TimeUnit.SECONDS).whenComplete((r, ex) -&gt; {
    if (r) {
        System.out.println("lock is acquired by the call 3");
        lock.unlock().whenComplete((nil, ex2) -&gt; {
            System.out.println("lock is released by the call 3");
            counter.incrementAndGet();
        });
    }
});

CompletableFuture.allOf(call1, call2, call3).whenComplete((r, ex) -&gt; {
    // Print the value of the counter.
    System.out.println("Value of the counter is " + counter.get());

    // Stop the Cache Manager.
    cm.stop();
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring_clustered_locks-locking"><a class="anchor" href="#configuring_clustered_locks-locking"></a>6.3. Configuring Internal Caches for Locks</h3>
<div class="paragraph">
<p>Clustered Lock Managers include an internal cache that stores lock state. You
can configure the internal cache either declaratively or programmatically.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Define the number of nodes in the cluster that store the state of clustered locks. The default value is <code>-1</code>, which replicates the value to all nodes.</p>
</li>
<li>
<p>Specify one of the following values for the cache reliability, which controls how clustered locks behave when clusters split into partitions or multiple nodes leave:</p>
<div class="ulist">
<ul>
<li>
<p><code>AVAILABLE</code>: Nodes in any partition can concurrently operate on locks.</p>
</li>
<li>
<p><code>CONSISTENT</code>: Only nodes that belong to the majority partition can operate on locks. This is the default value.</p>
</li>
<li>
<p>Programmatic configuration</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">import org.infinispan.lock.configuration.ClusteredLockManagerConfiguration;
import org.infinispan.lock.configuration.ClusteredLockManagerConfigurationBuilder;
import org.infinispan.lock.configuration.Reliability;
...

GlobalConfigurationBuilder global = GlobalConfigurationBuilder.defaultClusteredBuilder();

final ClusteredLockManagerConfiguration config = global.addModule(ClusteredLockManagerConfigurationBuilder.class).numOwner(2).reliability(Reliability.AVAILABLE).create();

DefaultCacheManager cm = new DefaultCacheManager(global.build());

ClusteredLockManager clm1 = EmbeddedClusteredLockManagerFactory.from(cm);

clm1.defineLock("lock");</code></pre>
</div>
</div>
</li>
<li>
<p>Declarative configuration</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="urn:infinispan:config:15.0 https://infinispan.org/schemas/infinispan-config-15.0.xsd"
        xmlns="urn:infinispan:config:15.0"&gt;

    &lt;cache-container default-cache="default"&gt;
        &lt;transport/&gt;
        &lt;local-cache name="default"&gt;
            &lt;locking concurrency-level="100" acquire-timeout="1000"/&gt;
        &lt;/local-cache&gt;
        &lt;clustered-locks xmlns="urn:infinispan:config:clustered-locks:15.0"
                         num-owners = "3"
                         reliability="AVAILABLE"&gt;
            &lt;clustered-lock name="lock1" /&gt;
            &lt;clustered-lock name="lock2" /&gt;
        &lt;/clustered-locks&gt;
    &lt;/cache-container&gt;
    &lt;!-- Cache configuration goes here. --&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/lock/configuration/ClusteredLockManagerConfiguration.html">ClusteredLockManagerConfiguration</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/configdocs/infinispan-clustered-locks-config-infinispan-clustered-locks-config-12.0.html.html">Clustered Locks Configuration Schema</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cluster-executor"><a class="anchor" href="#cluster-executor"></a>7. Executing code in the grid</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The main benefit of a cache is the ability to very quickly lookup a value
by its key, even across machines.
In fact this use alone is probably the reason many users use Infinispan.
However Infinispan can provide many more benefits that aren&#8217;t immediately apparent.
Since Infinispan is usually used in a cluster of machines we also have features available that can help utilize the entire cluster for performing the user&#8217;s desired workload.</p>
</div>
<div class="sect2">
<h3 id="executing-code-grid_cluster-executor"><a class="anchor" href="#executing-code-grid_cluster-executor"></a>7.1. Cluster Executor</h3>
<div class="paragraph">
<p>Since you have a group of machines, it makes sense to leverage their combined
computing power for executing code on all of them them.
The Cache Manager comes with a nice utility that allows you to
execute arbitrary code in the cluster. Note this feature requires no Cache to be used.  This
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/manager/ClusterExecutor.html">Cluster Executor</a>
can be retrieved by calling executor() on the <code>EmbeddedCacheManager</code>. This executor is retrievable
in both clustered and non clustered configurations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The ClusterExecutor is specifically designed for executing code where the code is not reliant
upon the data in a cache and is used instead as a way to help users to execute code easily
in the cluster.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This manager was built specifically around Java&#8217;s streaming API, thus all methods take a functional
interface as an argument. Also since these arguments will be sent to other nodes they need to be serializable.  We even
used a nice trick to ensure our lambdas are immediately Serializable.  That is by having the arguments implement both
Serializable and the real argument type (ie. Runnable or Function).  The JRE will pick the most specific class when
determining which method to invoke, so in that case your lambdas will always be serializable.
It is also possible to use an Externalizer to possibly reduce message size further.</p>
</div>
<div class="paragraph">
<p>The manager by default will submit a given command to all nodes in the cluster including the node
where it was submitted from. You can control on which nodes the task is executed on
by using the <code>filterTargets</code> methods as is explained in the section.</p>
</div>
<div class="sect3">
<h4 id="filtering_execution_nodes"><a class="anchor" href="#filtering_execution_nodes"></a>7.1.1. Filtering execution nodes</h4>
<div class="paragraph">
<p>It is possible to limit on which nodes the command will be ran. For example you may
want to only run a computation on machines in the same rack. Or you may want to perform an operation
once in the local site and again on a different site. A cluster executor can limit what nodes it sends
requests to at the scope of same or different machine, rack or site level.</p>
</div>
<div class="listingblock">
<div class="title">SameRack.java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">EmbeddedCacheManager manager = ...;
manager.executor().filterTargets(ClusterExecutionPolicy.SAME_RACK).submit(...)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use this topology base filtering you must enable topology aware consistent hashing through Server Hinting.</p>
</div>
<div class="paragraph">
<p>You can also filter using a predicate based on the <code>Address</code> of the node. This can also
be optionally combined with topology based filtering in the previous code snippet.</p>
</div>
<div class="paragraph">
<p>We also allow the target node to be chosen by any means using a <code>Predicate</code> that
will filter out which nodes can be considered for execution. Note this can also be combined
with Topology filtering at the same time to allow even more fine control of where you code
is executed within the cluster.</p>
</div>
<div class="listingblock">
<div class="title">Predicate.java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">EmbeddedCacheManager manager = ...;
// Just filter
manager.executor().filterTargets(a -&gt; a.equals(..)).submit(...)
// Filter only those in the desired topology
manager.executor().filterTargets(ClusterExecutionPolicy.SAME_SITE, a -&gt; a.equals(..)).submit(...)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="timeout"><a class="anchor" href="#timeout"></a>7.1.2. Timeout</h4>
<div class="paragraph">
<p>Cluster Executor allows for a timeout to be set per invocation. This defaults to the distributed sync timeout
as configured on the Transport Configuration. This timeout works in both a clustered and non clustered
Cache Manager. The executor may or may not interrupt the threads executing a task when the timeout expires. However
when the timeout occurs any <code>Consumer</code> or <code>Future</code> will be completed passing back a <code>TimeoutException</code>.
This value can be overridden by ivoking the
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/manager/ClusterExecutor.html#timeout-long-java.util.concurrent.TimeUnit-">timeout</a>
method and supplying the desired duration.</p>
</div>
</div>
<div class="sect3">
<h4 id="single_node_submission"><a class="anchor" href="#single_node_submission"></a>7.1.3. Single Node Submission</h4>
<div class="paragraph">
<p>Cluster Executor can also run in single node submission mode instead of submitting the command
to all nodes it will instead pick one of the nodes that would have normally received the command
and instead submit it it to only one. Each submission will possibly use a different node to
execute the task on. This can be very useful to use the ClusterExecutor as a
<code>java.util.concurrent.Executor</code> which you may have noticed that ClusterExecutor implements.</p>
</div>
<div class="listingblock">
<div class="title">SingleNode.java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">EmbeddedCacheManager manager = ...;
manager.executor().singleNodeSubmission().submit(...)</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="failover"><a class="anchor" href="#failover"></a>Failover</h5>
<div class="paragraph">
<p>When running in single node submission it may be desirable to also allow the Cluster Executor
handle cases where an exception occurred during the processing of a given command by retrying
the command again.
When this occurs the Cluster Executor will choose a single node again to resubmit the command to
up to the desired number of failover attempts. Note the chosen node could be any node that passes
the topology or predicate check. Failover is enabled by invoking the overridden
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/manager/ClusterExecutor.html#singleNodeSubmission-int-">singleNodeSubmission</a>
method. The given command will be resubmitted again to a single node until either
the command completes without exception or the total submission amount is equal to the provided
failover count.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example_pi_approximation"><a class="anchor" href="#example_pi_approximation"></a>7.1.4. Example: PI Approximation</h4>
<div class="paragraph">
<p>This example shows how you can use the ClusterExecutor to estimate the value of PI.</p>
</div>
<div class="paragraph">
<p>Pi approximation can greatly benefit from parallel distributed execution via
Cluster Executor. Recall that area of the square is Sa = 4r2 and area of the
circle is Ca=pi*r2. Substituting r2 from the second equation into the first
one it turns out that pi = 4 * Ca/Sa. Now, image that we can shoot very large
number of darts into a square; if we take ratio of darts that land inside a
circle over a total number of darts shot we will approximate Ca/Sa value. Since
we know that pi = 4 * Ca/Sa we can easily derive approximate value of pi. The
more darts we shoot the better approximation we get. In the example below we
shoot 1 billion darts but instead of "shooting" them serially we parallelize
work of dart shooting across the entire Infinispan cluster. Note this will
work in a cluster of 1 was well, but will be slower.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class PiAppx {

   public static void main (String [] arg){
      EmbeddedCacheManager cacheManager = ..
      boolean isCluster = ..

      int numPoints = 1_000_000_000;
      int numServers = isCluster ? cacheManager.getMembers().size() : 1;
      int numberPerWorker = numPoints / numServers;

      ClusterExecutor clusterExecutor = cacheManager.executor();
      long start = System.currentTimeMillis();
      // We receive results concurrently - need to handle that
      AtomicLong countCircle = new AtomicLong();
      CompletableFuture&lt;Void&gt; fut = clusterExecutor.submitConsumer(m -&gt; {
         int insideCircleCount = 0;
         for (int i = 0; i &lt; numberPerWorker; i++) {
            double x = Math.random();
            double y = Math.random();
            if (insideCircle(x, y))
               insideCircleCount++;
         }
         return insideCircleCount;
      }, (address, count, throwable) -&gt; {
         if (throwable != null) {
            throwable.printStackTrace();
            System.out.println("Address: " + address + " encountered an error: " + throwable);
         } else {
            countCircle.getAndAdd(count);
         }
      });
      fut.whenComplete((v, t) -&gt; {
         // This is invoked after all nodes have responded with a value or exception
         if (t != null) {
            t.printStackTrace();
            System.out.println("Exception encountered while waiting:" + t);
         } else {
            double appxPi = 4.0 * countCircle.get() / numPoints;

            System.out.println("Distributed PI appx is " + appxPi +
                  " using " + numServers + " node(s), completed in " + (System.currentTimeMillis() - start) + " ms");
         }
      });

      // May have to sleep here to keep alive if no user threads left
   }

   private static boolean insideCircle(double x, double y) {
      return (Math.pow(x - 0.5, 2) + Math.pow(y - 0.5, 2))
            &lt;= Math.pow(0.5, 2);
   }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="streams"><a class="anchor" href="#streams"></a>8. Using the Streams API for code execution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Efficiently process data stored in Infinispan caches using the <code>Streams</code> API.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="streams_streams"><a class="anchor" href="#streams_streams"></a>9. Streams</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You may want to process a subset or all data in the cache to produce a result.
This may bring thoughts of Map Reduce. Infinispan allows the user to do something
very similar but utilizes the standard JRE APIs to do so.
Java 8 introduced the concept of a <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html">Stream</a>
which allows functional-style operations on collections rather than having to procedurally
iterate over the data yourself. Stream operations can be implemented in a fashion very
similar to MapReduce.  Streams, just like MapReduce allow you to perform processing
upon the entirety of your cache, possibly a very large data set, but in an efficient way.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Streams are the preferred method when dealing with data that exists in the cache because streams automatically adjust to cluster topology changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also since we can control how the entries are iterated upon we can more efficiently perform the operations in a cache that is distributed if you want it to perform all of the operations across the cluster concurrently.</p>
</div>
<div class="paragraph">
<p>A stream is retrieved from the <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html#entrySet--">entrySet</a>,
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html#keySet--">keySet</a> or
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html#values--">values</a> collections returned from the
Cache by invoking the <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/Collection.html#stream--">stream</a> or
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/Collection.html#parallelStream--">parallelStream</a> methods.</p>
</div>
<div class="sect2">
<h3 id="common_stream_operations"><a class="anchor" href="#common_stream_operations"></a>9.1. Common stream operations</h3>
<div class="paragraph">
<p>This section highlights various options that are present irrespective of what type of underlying cache
you are using.</p>
</div>
</div>
<div class="sect2">
<h3 id="key_filtering"><a class="anchor" href="#key_filtering"></a>9.2. Key filtering</h3>
<div class="paragraph">
<p>It is possible to filter the stream so that it only operates upon a given subset of keys.  This can be done
by invoking the
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/CacheStream.html#filterKeys-java.util.Set-">filterKeys</a>
method on the <code>CacheStream</code>.  This should always be used over a Predicate
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html?is-external=true#filter-java.util.function.Predicate-">filter</a>
and will be faster if the predicate was holding all keys.</p>
</div>
<div class="paragraph">
<p>If you are familiar with the <code>AdvancedCache</code> interface you may be wondering why you even use
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/AdvancedCache.html#getAll-java.util.Set-">getAll</a>
over this keyFilter.  There are some small benefits (mostly smaller payloads) to using getAll
if you need the entries as is and need them all in memory in the local node.  However if you
need to do processing on these elements a stream is recommended since you will get both
distributed and threaded parallelism for free.</p>
</div>
</div>
<div class="sect2">
<h3 id="segment_based_filtering"><a class="anchor" href="#segment_based_filtering"></a>9.3. Segment based filtering</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is an advanced feature and should only be used with deep knowledge of Infinispan segment and hashing techniques.
These segments based filtering can be useful if you need to segment data into separate invocations.
This can be useful when integrating with other tools such as
<a href="http://spark.apache.org/">Apache Spark</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This option is only supported for replicated and distributed caches.  This allows the user to operate upon
a subset of data at a time as determined by the
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/distribution/ch/KeyPartitioner.html">KeyPartitioner</a>.
The segments can be filtered by invoking
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/CacheStream.html#filterKeySegments-java.util.Set-">filterKeySegments</a>
method on the <code>CacheStream</code>.  This is applied after the key filter but before any intermediate operations are performed.</p>
</div>
</div>
<div class="sect2">
<h3 id="localinvalidation"><a class="anchor" href="#localinvalidation"></a>9.4. Local/Invalidation</h3>
<div class="paragraph">
<p>A stream used with a local or invalidation cache can be used just the same way you would use a stream on a
regular collection. Infinispan handles all of the translations if necessary behind the scenes and works with all
of the more interesting options (ie. storeAsBinary and a cache loader).  Only data local to
the node where the stream operation is performed will be used, for example invalidation only uses local entries.</p>
</div>
</div>
<div class="sect2">
<h3 id="example"><a class="anchor" href="#example"></a>9.5. Example</h3>
<div class="paragraph">
<p>The code below takes a cache and returns a map with all the cache entries whose values contain the string "JBoss"</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Map&lt;Object, String&gt; jbossValues =
cache.entrySet().stream()
     .filter(e -&gt; e.getValue().contains("JBoss"))
     .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="distributionreplicationscattered"><a class="anchor" href="#distributionreplicationscattered"></a>9.6. Distribution/Replication/Scattered</h3>
<div class="paragraph">
<p>This is where streams come into their stride.  When a stream operation is performed it will
send the various intermediate and terminal operations to each node that has pertinent data.
This allows processing the intermediate values on the nodes owning the data, and only sending
the final results back to the originating nodes, improving performance.</p>
</div>
<div class="sect3">
<h4 id="rehash_aware"><a class="anchor" href="#rehash_aware"></a>9.6.1. Rehash Aware</h4>
<div class="paragraph">
<p>Internally the data is segmented and each node only performs the operations upon the data it owns as a primary owner.
This allows for data to be processed evenly, assuming segments are granular enough to provide for equal amounts of
data on each node.</p>
</div>
<div class="paragraph">
<p>When you are utilizing a distributed cache, the data can be reshuffled between nodes when a
new node joins or leaves. Distributed Streams handle this reshuffling of data automatically so you don&#8217;t
have to worry about monitoring when nodes leave or join the cluster.
Reshuffled entries may be processed a second time, and we keep track of the processed entries at the
key level or at the segment level (depending on the terminal operation) to limit the amount of
duplicate processing.</p>
</div>
<div class="paragraph">
<p>It is possible but highly discouraged to disable rehash awareness on the stream.  This should only be considered if
your request can handle only seeing a subset of data if a rehash occurs.  This can be done by invoking
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/CacheStream.html#disableRehashAware--">CacheStream.disableRehashAware()</a>
The performance gain for most operations when a rehash doesn&#8217;t occur is completely negligible.
The only exceptions are for iterator and forEach, which will use less memory, since they do not have
to keep track of processed keys.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Please rethink disabling rehash awareness unless you really know what you are doing.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="serialization"><a class="anchor" href="#serialization"></a>9.6.2. Serialization</h4>
<div class="paragraph">
<p>Since the operations are sent across to other nodes they must be serializable by Infinispan marshalling.  This allows the
operations to be sent to the other nodes.</p>
</div>
<div class="paragraph">
<p>The simplest way is to use a CacheStream instance and use a lambda just as you would normally.
Infinispan overrides all of the various Stream intermediate and terminal methods to take
Serializable versions of the arguments (ie. SerializableFunction, SerializablePredicate&#8230;&#8203;)
You can find these methods at
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/CacheStream.html">CacheStream</a>.
This relies on the spec to pick the most specific method as defined <a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-15.html#jls-15.12.2.5">here</a>.</p>
</div>
<div class="paragraph">
<p>In our previous example we used a <code>Collector</code> to collect all the results into a <code>Map</code>.
Unfortunately the <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Collectors.html">Collectors</a>
class doesn&#8217;t produce Serializable instances.  Thus if you need to use these, there are two ways to do so:</p>
</div>
<div class="paragraph">
<p>One option would be to use the
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/stream/CacheCollectors.html">CacheCollectors</a>
class which allows for a <code>Supplier&lt;Collector&gt;</code> to be provided.  This instance could then use the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Collectors.html">Collectors</a>
to supply a <code>Collector</code> which is not serialized.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Map&lt;Object, String&gt; jbossValues = cache.entrySet().stream()
              .filter(e -&gt; e.getValue().contains("Jboss"))
              .collect(CacheCollectors.serializableCollector(() -&gt; Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can avoid the use of
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/stream/CacheCollectors.html">CacheCollectors</a>
and instead use the overloaded <code>collect</code> methods that take <code>Supplier&lt;Collector&gt;</code>.
These overloaded <code>collect</code> methods are only available via <code>CacheStream</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Map&lt;Object, String&gt; jbossValues = cache.entrySet().stream()
              .filter(e -&gt; e.getValue().contains("Jboss"))
              .collect(() -&gt; Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));</code></pre>
</div>
</div>
<div class="paragraph">
<p>If however you are not able to use the <code>Cache</code> and <code>CacheStream</code> interfaces you cannot utilize <code>Serializable</code>
arguments and you must instead cast the lambdas to be <code>Serializable</code> manually by casting the lambda to multiple
interfaces.  It is not a pretty sight but it gets the job done.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Map&lt;Object, String&gt; jbossValues = map.entrySet().stream()
              .filter((Serializable &amp; Predicate&lt;Map.Entry&lt;Object, String&gt;&gt;) e -&gt; e.getValue().contains("Jboss"))
              .collect(CacheCollectors.serializableCollector(() -&gt; Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The recommended and most performant way is to use an
<code>AdvancedExternalizer</code> as this provides the smallest payload.  Unfortunately
this means you cannot use lamdbas as advanced externalizers require defining
the class before hand.</p>
</div>
<div class="paragraph">
<p>You can use an advanced externalizer as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">   Map&lt;Object, String&gt; jbossValues = cache.entrySet().stream()
              .filter(new ContainsFilter("Jboss"))
              .collect(() -&gt; Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));

   class ContainsFilter implements Predicate&lt;Map.Entry&lt;Object, String&gt;&gt; {
      private final String target;

      ContainsFilter(String target) {
         this.target = target;
      }

      @Override
      public boolean test(Map.Entry&lt;Object, String&gt; e) {
         return e.getValue().contains(target);
      }
   }

   class JbossFilterExternalizer implements AdvancedExternalizer&lt;ContainsFilter&gt; {

      @Override
      public Set&lt;Class&lt;? extends ContainsFilter&gt;&gt; getTypeClasses() {
         return Util.asSet(ContainsFilter.class);
      }

      @Override
      public Integer getId() {
         return CUSTOM_ID;
      }

      @Override
      public void writeObject(ObjectOutput output, ContainsFilter object) throws IOException {
         output.writeUTF(object.target);
      }

      @Override
      public ContainsFilter readObject(ObjectInput input) throws IOException, ClassNotFoundException {
         return new ContainsFilter(input.readUTF());
      }
   }</code></pre>
</div>
</div>
<div class="paragraph">
<p>You could also use an advanced externalizer for the collector supplier to reduce the
payload size even further.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Map&lt;Object, String&gt; map = (Map&lt;Object, String&gt;) cache.entrySet().stream()
              .filter(new ContainsFilter("Jboss"))
              .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));

 class ToMapCollectorSupplier&lt;K, U&gt; implements Supplier&lt;Collector&lt;Map.Entry&lt;K, U&gt;, ?, Map&lt;K, U&gt;&gt;&gt; {
      static final ToMapCollectorSupplier INSTANCE = new ToMapCollectorSupplier();

      private ToMapCollectorSupplier() { }

      @Override
      public Collector&lt;Map.Entry&lt;K, U&gt;, ?, Map&lt;K, U&gt;&gt; get() {
         return Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue);
      }
   }

   class ToMapCollectorSupplierExternalizer implements AdvancedExternalizer&lt;ToMapCollectorSupplier&gt; {

      @Override
      public Set&lt;Class&lt;? extends ToMapCollectorSupplier&gt;&gt; getTypeClasses() {
         return Util.asSet(ToMapCollectorSupplier.class);
      }

      @Override
      public Integer getId() {
         return CUSTOM_ID;
      }

      @Override
      public void writeObject(ObjectOutput output, ToMapCollectorSupplier object) throws IOException {
      }

      @Override
      public ToMapCollectorSupplier readObject(ObjectInput input) throws IOException, ClassNotFoundException {
         return ToMapCollectorSupplier.INSTANCE;
      }
   }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="parallel_computation"><a class="anchor" href="#parallel_computation"></a>9.7. Parallel Computation</h3>
<div class="paragraph">
<p>Distributed streams by default try to parallelize as much as possible.  It is possible for the end user to control this and
actually they always have to control one of the options.  There are 2 ways these streams are parallelized.</p>
</div>
<div class="paragraph">
<p><strong>Local to each node</strong>
When a stream is created from the cache collection the end user can choose between invoking
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/Collection.html#stream--">stream</a> or
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/Collection.html#parallelStream--">parallelStream</a>
method.  Depending on if the parallel stream was picked will enable multiple threading for
each node locally.  Note that some operations like a rehash aware iterator and forEach operations
will always use a sequential stream locally.  This could be enhanced at some point to allow for
parallel streams locally.</p>
</div>
<div class="paragraph">
<p>Users should be careful when using local parallelism as it requires having a large number of entries or operations
that are computationally expensive to be faster. Also it should be noted that if a user uses a parallel
stream with <code>forEach</code> that the action should not block as this would be executed on the common pool, which
is normally reserved for computation operations.</p>
</div>
<div class="paragraph">
<p><strong>Remote requests</strong>
When there are multiple nodes it may be desirable to control whether the remote requests are all processed
at the same time concurrently or one at a time.  By default all terminal operations except the iterator
perform concurrent requests.  The iterator, method to reduce overall memory pressure on the local node,
only performs sequential requests which actually performs slightly better.</p>
</div>
<div class="paragraph">
<p>If a user wishes to change this default however they can do so by invoking the
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/CacheStream.html#sequentialDistribution--">sequentialDistribution</a>
or <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/CacheStream.html#parallelDistribution--">parallelDistribution</a>
methods on the <code>CacheStream</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="task_timeout"><a class="anchor" href="#task_timeout"></a>9.8. Task timeout</h3>
<div class="paragraph">
<p>It is possible to set a timeout value for the operation requests. This timeout is used only for remote requests timing out and
it is on a per request basis. The former means the local execution will not timeout and the latter means if you have a failover
scenario as described above the subsequent requests each have a new timeout.  If no timeout is specified it uses the
replication timeout as a default timeout. You can set the timeout in your task by doing the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">CacheStream&lt;Map.Entry&lt;Object, String&gt;&gt; stream = cache.entrySet().stream();
stream.timeout(1, TimeUnit.MINUTES);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information about this, please check the java doc in
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/CacheStream.html#timeout-long-java.util.concurrent.TimeUnit-">timeout</a>
javadoc.</p>
</div>
</div>
<div class="sect2">
<h3 id="injection"><a class="anchor" href="#injection"></a>9.9. Injection</h3>
<div class="paragraph">
<p>The <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html">Stream</a>
has a terminal operation called
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#forEach-java.util.function.Consumer-">forEach</a>
which allows for running some sort of side effect operation on the data.  In this case it may be desirable to get a reference to
the <code>Cache</code> that is backing this Stream.  If your <code>Consumer</code> implements the
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/stream/CacheAware.html">CacheAware</a>
interface the <code>injectCache</code> method be invoked before the accept method from the <code>Consumer</code> interface.</p>
</div>
</div>
<div class="sect2">
<h3 id="distributed_stream_execution"><a class="anchor" href="#distributed_stream_execution"></a>9.10. Distributed Stream execution</h3>
<div class="paragraph">
<p>Distributed streams execution works in a fashion very similar to map reduce.  Except in this case we are sending zero to many intermediate operations
(map, filter etc.) and a single terminal operation to the various nodes.  The operation basically comes down to the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The desired segments are grouped by which node is the primary owner of the given segment</p>
</li>
<li>
<p>A request is generated to send to each remote node that contains the intermediate and terminal operations including which segments it should process</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The terminal operation will be performed locally if necessary</p>
</li>
<li>
<p>Each remote node will receive this request and run the operations and subsequently send the response back</p>
</li>
</ol>
</div>
</li>
<li>
<p>The local node will then gather the local response and remote responses together performing any kind of reduction required by the operations themselves.</p>
</li>
<li>
<p>Final reduced response is then returned to the user</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In most cases all operations are fully distributed, as in the operations are all fully applied on each remote node and usually only the last operation or something related may be
reapplied to reduce the results from multiple nodes.  One important note is that intermediate values do not actually have to be serializable, it is the last value
sent back that is the part desired (exceptions for various operations will be highlighted below).</p>
</div>
<div class="paragraph">
<p><strong>Terminal operator distributed result reductions</strong>
The following paragraphs describe how the distributed reductions work for the various terminal operators.  Some of these are special in that an intermediate value may
be required to be serializable instead of the final result.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">allMatch noneMatch anyMatch</dt>
<dd>
<p>The <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#allMatch-java.util.function.Predicate-">allMatch</a>
operation is ran on each node and then all the results are logically anded together locally
to get the appropriate value.  The
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#noneMatch-java.util.function.Predicate-">noneMatch</a>
and
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#anyMatch-java.util.function.Predicate-">anyMatch</a>
operations use a logical or instead. These methods also have early termination support,
stopping remote and local operations once the final result is known.</p>
</dd>
<dt class="hdlist1">collect</dt>
<dd>
<p>The <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">collect</a>
method is interesting in that it can do a few extra steps.  The remote node performs
everything as normal except it doesn&#8217;t perform the final
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Collector.html#finisher--">finisher</a>
upon the result and instead sends back the fully combined results.  The local thread
then <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Collector.html#combiner--">combines</a>
the remote and local result into a value which is then finally finished.  The key
here to remember is that the final value doesn&#8217;t have to be serializable but rather
the values produced from the <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Collector.html#supplier--">supplier</a>
and <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Collector.html#combiner--">combiner</a>
methods.</p>
</dd>
<dt class="hdlist1">count</dt>
<dd>
<p>The <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#count--">count</a>
method just adds the numbers together from each node.</p>
</dd>
<dt class="hdlist1">findAny findFirst</dt>
<dd>
<p>The <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#findAny--">findAny</a>
operation returns just the first value they find, whether it was from a remote node
or locally.  Note this supports early termination in that once a value is found it
will not process others.  Note the findFirst method is special since it requires a sorted
intermediate operation, which is detailed in the
<a href="../embedding/embedding.html#intermediate_operation_exceptions">exceptions</a> section.</p>
</dd>
<dt class="hdlist1">max min</dt>
<dd>
<p>The <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#max-java.util.Comparator-">max</a> and
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#min-java.util.Comparator-">min</a> methods find the respective min or max value on each node then a final
reduction is performed locally to ensure only the min or max across all nodes is returned.</p>
</dd>
<dt class="hdlist1">reduce</dt>
<dd>
<p>The various reduce methods <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#reduce-java.util.function.BinaryOperator-">1</a> ,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#reduce-T-java.util.function.BinaryOperator-">2</a> ,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#reduce-U-java.util.function.BiFunction-java.util.function.BinaryOperator-">3</a> will end up serializing
the result as much as the accumulator can do.  Then it will accumulate the local and remote results together locally, before combining if you have provided that.  Note this means
a value coming from the combiner doesn&#8217;t have to be Serializable.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="key_based_rehash_aware_operators"><a class="anchor" href="#key_based_rehash_aware_operators"></a>9.11. Key based rehash aware operators</h3>
<div class="paragraph">
<p>The <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/CacheStream.html#iterator--">iterator</a>,
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/CacheStream.html#spliterator--">spliterator</a>
and <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/CacheStream.html#forEach-java.util.function.Consumer-">forEach</a>
are unlike the other terminal operators in that the rehash awareness has to keep
track of what keys per segment have been processed instead of just segments.  This is
to guarantee an exactly once (iterator &amp; spliterator) or at least once behavior (forEach)
even under cluster membership changes.</p>
</div>
<div class="paragraph">
<p>The <code>iterator</code> and <code>spliterator</code> operators when invoked on a remote node will return back batches
of entries, where the next batch is only sent back after the last has been fully consumed.  This
batching is done to limit how many entries are in memory at a given time.  The user node will hold
onto which keys it has processed and when a given segment is completed it will release those keys from
memory.  This is why sequential processing is preferred for the iterator method, so only a subset of segment
keys are held in memory at once, instead of from all nodes.</p>
</div>
<div class="paragraph">
<p>The <code>forEach()</code> method also returns batches, but it returns a batch of keys after it has finished processing
at least a batch worth of keys.  This way the originating node can know what keys have been processed
already to reduce chances of processing the same entry again.  Unfortunately this means it is possible
to have an at least once behavior when a node goes down unexpectedly.  In this case that node could have
been processing a batch and not yet completed one and those entries that were processed but not
in a completed batch will be ran again when the rehash failure operation occurs.  Note that adding a
node will not cause this issue as the rehash failover doesn&#8217;t occur until all responses are received.</p>
</div>
<div class="paragraph">
<p>These operations batch sizes are both controlled by the same value which can be configured by invoking
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/CacheStream.html#distributedBatchSize-int-">distributedBatchSize</a>
method on the <code>CacheStream</code>.  This value will default to the <code>chunkSize</code> configured in state transfer.
Unfortunately this value is a tradeoff with memory usage vs performance vs at least once and your
mileage may vary.</p>
</div>
<div class="paragraph">
<p><strong>Using <code>iterator</code> with replicated and distributed caches</strong></p>
</div>
<div class="paragraph">
<p>When a node is the primary or backup owner of all requested segments for a distributed stream, Infinispan performs the <code>iterator</code> or <code>spliterator</code> terminal operations locally, which optimizes performance as remote iterations are more resource intensive.</p>
</div>
<div class="paragraph">
<p>This optimization applies to both replicated and distributed caches. However, Infinispan performs iterations remotely when using cache stores that are both <code>shared</code> and have <code>write-behind</code> enabled. In this case performing the iterations remotely ensures consistency.</p>
</div>
</div>
<div class="sect2">
<h3 id="intermediate_operation_exceptions"><a class="anchor" href="#intermediate_operation_exceptions"></a>9.12. Intermediate operation exceptions</h3>
<div class="paragraph">
<p>There are some intermediate operations that have special exceptions, these are
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#skip-long-">skip</a>,
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#peek-java.util.function.Consumer-">peek</a>,
sorted <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#sorted-java.util.Comparator-">1</a>
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#sorted--">2</a>.
&amp; <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/stream/Stream.html#distinct--">distinct</a>.
All of these methods have some sort of artificial iterator implanted in the stream
processing to guarantee correctness, they are documented as below.  Note this means
these operations may cause possibly severe performance degradation.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Skip</dt>
<dd>
<p>An artificial iterator is implanted up to the intermediate skip operation.
Then results are brought locally so it can skip the appropriate amount of elements.</p>
</dd>
<dt class="hdlist1">Sorted</dt>
<dd>
<p>WARNING: This operation requires having all entries in memory on the local node.
An artificial iterator is implanted up to the intermediate sorted operation.
All results are sorted locally.  There are possible plans to have a distributed sort which
returns batches of elements, but this is not yet implemented.</p>
</dd>
<dt class="hdlist1">Distinct</dt>
<dd>
<p>WARNING: This operation requires having all or nearly all entries in memory on the local node.
Distinct is performed on each remote node and then an artificial iterator returns those distinct values.
Then finally all of those results have a distinct operation performed upon them.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The rest of the intermediate operations are fully distributed as one would expect.</p>
</div>
</div>
<div class="sect2">
<h3 id="examples"><a class="anchor" href="#examples"></a>9.13. Examples</h3>
<div class="paragraph">
<p><strong>Word Count</strong></p>
</div>
<div class="paragraph">
<p>Word count is a classic, if overused, example
of map/reduce paradigm. Assume we have a mapping of key &#8594; sentence stored on
Infinispan nodes. Key is a String, each sentence is also a String, and we have
to count occurrence of all words in all sentences available. The implementation
of such a distributed task could be defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class WordCountExample {

   /**
    * In this example replace c1 and c2 with
    * real Cache references
    *
    * @param args
    */
   public static void main(String[] args) {
      Cache&lt;String, String&gt; c1 = ...;
      Cache&lt;String, String&gt; c2 = ...;

      c1.put("1", "Hello world here I am");
      c2.put("2", "Infinispan rules the world");
      c1.put("3", "JUDCon is in Boston");
      c2.put("4", "JBoss World is in Boston as well");
      c1.put("12","JBoss Application Server");
      c2.put("15", "Hello world");
      c1.put("14", "Infinispan community");
      c2.put("15", "Hello world");

      c1.put("111", "Infinispan open source");
      c2.put("112", "Boston is close to Toronto");
      c1.put("113", "Toronto is a capital of Ontario");
      c2.put("114", "JUDCon is cool");
      c1.put("211", "JBoss World is awesome");
      c2.put("212", "JBoss rules");
      c1.put("213", "JBoss division of RedHat ");
      c2.put("214", "RedHat community");

      Map&lt;String, Long&gt; wordCountMap = c1.entrySet().parallelStream()
         .map(e -&gt; e.getValue().split("\\s"))
         .flatMap(Arrays::stream)
         .collect(() -&gt; Collectors.groupingBy(Function.identity(), Collectors.counting()));
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case it is pretty simple to do the word count from the previous example.</p>
</div>
<div class="paragraph">
<p>However what if we want to find the most frequent word in the example?  If you take a second
to think about this case you will realize you need to have all words counted  and available
locally first. Thus we actually have a few options.</p>
</div>
<div class="paragraph">
<p>We could use a finisher on the collector, which is invoked on the user thread
after all the results have been collected.
Some redundant lines have been removed from the previous example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class WordCountExample {
   public static void main(String[] args) {
      // Lines removed

      String mostFrequentWord = c1.entrySet().parallelStream()
         .map(e -&gt; e.getValue().split("\\s"))
         .flatMap(Arrays::stream)
         .collect(() -&gt; Collectors.collectingAndThen(
            Collectors.groupingBy(Function.identity(), Collectors.counting()),
               wordCountMap -&gt; {
                  String mostFrequent = null;
                  long maxCount = 0;
                     for (Map.Entry&lt;String, Long&gt; e : wordCountMap.entrySet()) {
                        int count = e.getValue().intValue();
                        if (count &gt; maxCount) {
                           maxCount = count;
                           mostFrequent = e.getKey();
                        }
                     }
                     return mostFrequent;
               }));

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately the last step is only going to be ran in a single thread, which if we have a lot of
words could be quite slow.  Maybe there is another way to parallelize this with Streams.</p>
</div>
<div class="paragraph">
<p>We mentioned before we are in the local node after processing, so we could actually use
a stream on the map results.  We can therefore use a parallel stream on the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class WordFrequencyExample {
   public static void main(String[] args) {
      // Lines removed

      Map&lt;String, Long&gt; wordCount = c1.entrySet().parallelStream()
              .map(e -&gt; e.getValue().split("\\s"))
              .flatMap(Arrays::stream)
              .collect(() -&gt; Collectors.groupingBy(Function.identity(), Collectors.counting()));
      Optional&lt;Map.Entry&lt;String, Long&gt;&gt; mostFrequent = wordCount.entrySet().parallelStream().reduce(
              (e1, e2) -&gt; e1.getValue() &gt; e2.getValue() ? e1 : e2);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way you can still utilize all of the cores locally when calculating the most frequent element.</p>
</div>
<div class="paragraph">
<p><strong>Remove specific entries</strong></p>
</div>
<div class="paragraph">
<p>Distributed streams can also be used as a way to modify data where it lives.
For example you may want to remove all entries in your cache that contain
a specific word.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class RemoveBadWords {
   public static void main(String[] args) {
      // Lines removed
      String word = ..

      c1.entrySet().parallelStream()
         .filter(e -&gt; e.getValue().contains(word))
         .forEach((c, e) -&gt; c.remove(e.getKey()));</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we carefully note what is serialized and what is not, we notice that only the word along
with the operations are serialized across to other nods as it is captured by the lambda.
However the real saving piece is that the cache operation is performed on the primary
owner thus reducing the amount of network traffic required to remove these values from the
cache. The cache is not captured by the lambda as we provide a special BiConsumer method
override that when invoked on each node passes the cache to the BiConsumer</p>
</div>
<div class="paragraph">
<p>One thing to keep in mind using the <code>forEach</code> command in this manner is that the underlying
stream obtains no locks. The cache remove operation will still obtain locks naturally, but
the value could have changed from what the stream saw. That means that the entry could
have been changed after the stream read it but the remove actually removed it.</p>
</div>
<div class="paragraph">
<p>We have specifically added a new variant which is called <code>LockedStream</code>.</p>
</div>
<div class="paragraph">
<p><strong>Plenty of other examples</strong></p>
</div>
<div class="paragraph">
<p>The <code>Streams</code> API is a JRE tool and there are lots of examples for using it.
Just remember that your operations need to be Serializable in some way.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ispn_modules"><a class="anchor" href="#ispn_modules"></a>10. Using Infinispan in WildFly applications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly includes Infinispan modules that you can use in WildFly applications. You can do this in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Include the Infinispan libraries in a WildFly application.</p>
<div class="paragraph">
<p>When you include the Infinispan libraries within an application, the caches are local to the application and cannot be used by other applications. Additionally, the cache  configuration is within the application.</p>
</div>
</li>
<li>
<p>Use the Infinispan libraries provided by WildFly.</p>
<div class="paragraph">
<p>Using the Infinispan libraries provided by WildFly has the following benefits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The cache is shared between applications.</p>
</li>
<li>
<p>The cache configuration is part of WildFly standalone or domain XML files.</p>
</li>
<li>
<p>Applications do not include Infinispan libraries, they instead reference the required module from the MANIFEST or jboss-structure.xml configuration files.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following procedures describe using the Infinispan libraries provided by WildFly.</p>
</div>
<div class="sect2">
<h3 id="configure_ispn_modules"><a class="anchor" href="#configure_ispn_modules"></a>10.1. Configuring applications to Use Infinispan modules</h3>
<div class="paragraph">
<p>To use Infinispan libraries provided by WildFly in your applications, add Infinispan dependency in the application&#8217;s pom.xml file.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Import the Infinispan dependency management to control the versions of runtime Maven dependencies.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
  &lt;artifactId&gt;infinispan-bom&lt;/artifactId&gt;
  &lt;version&gt;${version.infinispan.bom}&lt;/version&gt;
  &lt;type&gt;pom&lt;/type&gt;
  &lt;scope&gt;import&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You must define the value for <code>${version.infinispan.bom}`in the `&lt;properties&gt;</code> section of the pom.xml file.</p>
</div>
</li>
<li>
<p>Declare the required Infinispan dependencies as <em>provided</em>.</p>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
    &lt;artifactId&gt;infinispan-core&lt;/artifactId&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring-caches-in-jboss_server"><a class="anchor" href="#configuring-caches-in-jboss_server"></a>10.2. Configuring Infinispan caches in WildFly</h3>
<div class="paragraph">
<p>Create Infinispan caches in WildFly.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>WildFly is running</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Connect to the WildFly management CLI.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ jboss-cli.sh --connect</code></pre>
</div>
</div>
</li>
<li>
<p>Create a cache container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>/subsystem=infinispan/cache-container=exampleCacheContainer:add(statistics-enabled=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a cache container called <code>exampleCacheContainer</code> with statistics enabled.</p>
</div>
</li>
<li>
<p>Add a cache to the cache container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>/subsystem=infinispan/cache-container=exampleCacheContainer/local-cache=exampleCache:add(statistics-enabled=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a local cache named <code>exampleCache</code> in the <code>exampleCacheContainer</code> cache container with statistics enabled.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="using-cahches-in-jboss-applications_server"><a class="anchor" href="#using-cahches-in-jboss-applications_server"></a>10.3. Using Infinispan caches in WildFly applications</h3>
<div class="paragraph">
<p>You can access Infinispan caches in your applications through resource lookup.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>WildFly is running.</p>
</li>
<li>
<p>You have created Infinispan cahches in WildFly.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>You can lookup Infinispan caches in your applications like this:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">@Resource(lookup = "java:jboss/infinispan/cache/exampleCacheContainer/exampleCache")
private Cache&lt;String, String&gt; ispnCache;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This defines a <code>Cache</code> called <code>ispnCache</code>.</p>
</div>
</li>
<li>
<p>You can put, get and remove entries from the cache as follows:</p>
<div class="listingblock">
<div class="title">Get value of a key</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">String value = ispnCache.get(key);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This retrieves the value of the key in the cache. If the key is not found, <code>null</code> is returned.</p>
</div>
<div class="listingblock">
<div class="title">Put value in a key</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">String oldValue = ispnCache.put(key,value);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This defines a new key if it does not already exist and associates the value passed. If the key already exists, the original value is replaced.</p>
</div>
<div class="listingblock">
<div class="title">Remove a key</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">String value = ispnCache.remove(key);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This removes the key from the cache.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quarkus_embedded"><a class="anchor" href="#quarkus_embedded"></a>11. Using the Quarkus extension</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan provides an extension that integrates with the Quarkus framework.
The extension lets you create natively compiled Infinispan applications.</p>
</div>
<div class="sect2">
<h3 id="quarkus_embedded_dependencies"><a class="anchor" href="#quarkus_embedded_dependencies"></a>11.1. Quarkus dependencies</h3>
<div class="paragraph">
<p>Include the Infinispan Quarkus extension in your <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="title">Embedded mode</div>
<div class="content">
<pre>&lt;dependency&gt;
  &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
  &lt;artifactId&gt;infinispan-quarkus-embedded&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="quarkus_inject_embedded"><a class="anchor" href="#quarkus_inject_embedded"></a>11.2. Injecting Embedded Caches</h3>
<div class="paragraph">
<p>Inject a <code>EmbeddedCacheManager</code> instance into your Quarkus application to interact with Infinispan caches..</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Optional: Use the <code>quarkus.infinispan-embedded.xml-config</code> property to set the path to an XML file that includes the configuration of the injected instance.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">quarkus.infinispan-embedded.xml-config=/example/path/to/config.xml</code></pre>
</div>
</div>
</li>
<li>
<p>Add the <code>@Inject</code> annotation to an uninitialized <code>EmbeddedCacheManager</code> class variable.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import javax.inject.Inject;
import org.infinispan.manager.EmbeddedCacheManager;
...
@Path("/example")
public class ExampleResource {

    @Inject
    EmbeddedCacheManager emc;
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="quarkus_native_compilation"><a class="anchor" href="#quarkus_native_compilation"></a>11.3. Compiling Quarkus Infinispan application</h3>
<div class="paragraph">
<p>Generate a native executable for Quarkus Infinispan application.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Have a Quarkus based project. For a complete list of prerequisites, see <a href="https://quarkus.io/guides/building-native-image#prerequisites">Quarkus native prerequisites</a>.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Natively compile your Quarkus Infinispan application:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mvn clean package -Pnative</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cdi_support"><a class="anchor" href="#cdi_support"></a>12. Using the CDI Extension</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan provides an extension that integrates with the CDI (Contexts and
Dependency Injection) programming model and allows you to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure and inject caches into CDI Beans and Java EE components.</p>
</li>
<li>
<p>Configure cache managers.</p>
</li>
<li>
<p>Receive cache and cache manager level events.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="cdi_dependencies"><a class="anchor" href="#cdi_dependencies"></a>12.1. CDI Dependencies</h3>
<div class="paragraph">
<p>Update your <code>pom.xml</code> with one of the following dependencies to include the
Infinispan CDI extension in your project:</p>
</div>
<div class="listingblock">
<div class="title">Embedded (Library) Mode</div>
<div class="content">
<pre>&lt;dependency&gt;
  &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
  &lt;artifactId&gt;infinispan-cdi-embedded&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server Mode</div>
<div class="content">
<pre>&lt;dependency&gt;
  &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
  &lt;artifactId&gt;infinispan-cdi-remote&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cdi_inject_embed"><a class="anchor" href="#cdi_inject_embed"></a>12.2. Injecting Embedded Caches</h3>
<div class="paragraph">
<p>Set up CDI beans to inject embedded caches.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a cache qualifier annotation.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
import jakarta.inject.Qualifier;

@Qualifier
@Target({ElementType.FIELD, ElementType.PARAMETER, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface GreetingCache { <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a <code>@GreetingCache</code> qualifier.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add a producer method that defines the cache configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
import org.infinispan.configuration.cache.Configuration;
import org.infinispan.configuration.cache.ConfigurationBuilder;
import org.infinispan.cdi.ConfigureCache;
import jakarta.transaction.inject.Produces;

public class Config {

    @ConfigureCache("mygreetingcache") <i class="conum" data-value="1"></i><b>(1)</b>
    @GreetingCache <i class="conum" data-value="2"></i><b>(2)</b>
    @Produces
    public Configuration greetingCacheConfiguration() {
        return new ConfigurationBuilder()
                    .memory()
                        .size(1000)
                    .build();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Names the cache to inject.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Adds the cache qualifier.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add a producer method that creates a clustered Cache Manager, if required</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
package org.infinispan.configuration.global.GlobalConfigurationBuilder;

public class Config {

    @GreetingCache <i class="conum" data-value="1"></i><b>(1)</b>
    @Produces
    @ApplicationScoped <i class="conum" data-value="2"></i><b>(2)</b>
    public EmbeddedCacheManager defaultClusteredCacheManager() { <i class="conum" data-value="3"></i><b>(3)</b>
      return new DefaultCacheManager(
        new GlobalConfigurationBuilder().transport().defaultTransport().build();
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Adds the cache qualifier.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creates the bean once for the application. Producers that create Cache Managers should always include the <code>@ApplicationScoped</code> annotation to avoid creating multiple Cache Managers.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creates a new <code>DefaultCacheManager</code> instance that is bound to the <code>@GreetingCache</code> qualifier.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Cache managers are heavy weight objects. Having more than one Cache Manager
running in your application can degrade performance. When injecting multiple
caches, either add the qualifier of each cache to the Cache Manager producer
method or do not add any qualifier.</p>
</div>
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
</li>
<li>
<p>Add the <code>@GreetingCache</code> qualifier to your cache injection point.</p>
<div class="listingblock">
<div class="content">
<pre>...
import jakarta.inject.Inject;

public class GreetingService {

    @Inject @GreetingCache
    private Cache&lt;String, String&gt; cache;

    public String greet(String user) {
        String cachedValue = cache.get(user);
        if (cachedValue == null) {
            cachedValue = "Hello " + user;
            cache.put(user, cachedValue);
        }
        return cachedValue;
    }
}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="cdi_inject_remote"><a class="anchor" href="#cdi_inject_remote"></a>12.3. Injecting Remote Caches</h3>
<div class="paragraph">
<p>Set up CDI beans to inject remote caches.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a cache qualifier annotation.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Remote("mygreetingcache") <i class="conum" data-value="1"></i><b>(1)</b>
@Qualifier
@Target({ElementType.FIELD, ElementType.PARAMETER, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RemoteGreetingCache { <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>names the cache to inject.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>creates a <code>@RemoteGreetingCache</code> qualifier.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add the <code>@RemoteGreetingCache</code> qualifier to your cache injection point.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class GreetingService {

    @Inject @RemoteGreetingCache
    private RemoteCache&lt;String, String&gt; cache;

    public String greet(String user) {
        String cachedValue = cache.get(user);
        if (cachedValue == null) {
            cachedValue = "Hello " + user;
            cache.put(user, cachedValue);
        }
        return cachedValue;
    }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Tips for injecting remote caches</div>
<ul>
<li>
<p>You can inject remote caches without using qualifiers.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">   ...
   @Inject
   @Remote("greetingCache")
   private RemoteCache&lt;String, String&gt; cache;</code></pre>
</div>
</div>
</li>
<li>
<p>If you have more than one Infinispan cluster, you can create separate remote Cache Manager producers for each cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
import jakarta.transaction.context.ApplicationScoped;

public class Config {

    @RemoteGreetingCache
    @Produces
    @ApplicationScoped <i class="conum" data-value="1"></i><b>(1)</b>
    public ConfigurationBuilder builder = new ConfigurationBuilder(); <i class="conum" data-value="2"></i><b>(2)</b>
        builder.addServer().host("localhost").port(11222);
        return new RemoteCacheManager(builder.build());
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>creates the bean once for the application. Producers that create Cache Managers should always include the <code>@ApplicationScoped</code> annotation to avoid creating multiple Cache Managers, which are heavy weight objects.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>creates a new <code>RemoteCacheManager</code> instance that is bound to the <code>@RemoteGreetingCache</code> qualifier.</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="cache_events"><a class="anchor" href="#cache_events"></a>12.4. Receiving Cache and Cache Manager Events</h3>
<div class="paragraph">
<p>You can use CDI Events to receive Cache and Cache Manager level events.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the <code>@Observes</code> annotation as in the following example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import jakarta.transaction.event.Observes;
import org.infinispan.notifications.cachemanagerlistener.event.CacheStartedEvent;
import org.infinispan.notifications.cachelistener.event.*;

public class GreetingService {

    // Cache level events
    private void entryRemovedFromCache(@Observes CacheEntryCreatedEvent event) {
        ...
    }

    // Cache manager level events
    private void cacheStarted(@Observes CacheStartedEvent event) {
        ...
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multimap-cache"><a class="anchor" href="#multimap-cache"></a>13. Multimap cache</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MutimapCache is a type of Infinispan Cache that maps keys to values in which each key can contain multiple values.</p>
</div>
<div class="sect2">
<h3 id="using-multimap-cache_multimap-cache"><a class="anchor" href="#using-multimap-cache_multimap-cache"></a>13.1. Multimap Cache</h3>
<div class="paragraph">
<p>MutimapCache is a type of Infinispan Cache that maps keys to values in which each key can contain multiple values.</p>
</div>
<div class="sect3">
<h4 id="installation_and_configuration"><a class="anchor" href="#installation_and_configuration"></a>13.1.1. Installation and configuration</h4>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
  &lt;artifactId&gt;infinispan-multimap&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="multimapcache_api"><a class="anchor" href="#multimapcache_api"></a>13.1.2. MultimapCache API</h4>
<div class="paragraph">
<p>MultimapCache API exposes several methods to interact with the Multimap Cache.
These methods are non-blocking in most cases; see
<a href="#multimap_limitations">limitations</a> for more information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface MultimapCache&lt;K, V&gt; {

   CompletableFuture&lt;Optional&lt;CacheEntry&lt;K, Collection&lt;V&gt;&gt;&gt;&gt; getEntry(K key);

   CompletableFuture&lt;Void&gt; remove(SerializablePredicate&lt;? super V&gt; p);

   CompletableFuture&lt;Void&gt; put(K key, V value);

   CompletableFuture&lt;Collection&lt;V&gt;&gt; get(K key);

   CompletableFuture&lt;Boolean&gt; remove(K key);

   CompletableFuture&lt;Boolean&gt; remove(K key, V value);

   CompletableFuture&lt;Void&gt; remove(Predicate&lt;? super V&gt; p);

   CompletableFuture&lt;Boolean&gt; containsKey(K key);

   CompletableFuture&lt;Boolean&gt; containsValue(V value);

   CompletableFuture&lt;Boolean&gt; containsEntry(K key, V value);

   CompletableFuture&lt;Long&gt; size();

   boolean supportsDuplicates();

}</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Void&gt; put(K key, V value)</div>
<p>Puts a key-value pair in the multimap cache.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">MultimapCache&lt;String, String&gt; multimapCache = ...;

multimapCache.put("girlNames", "marie")
             .thenCompose(r1 -&gt; multimapCache.put("girlNames", "oihana"))
             .thenCompose(r3 -&gt; multimapCache.get("girlNames"))
             .thenAccept(names -&gt; {
                          if(names.contains("marie"))
                              System.out.println("Marie is a girl name");

                           if(names.contains("oihana"))
                              System.out.println("Oihana is a girl name");
                        });</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of this code is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-txt" data-lang="txt">Marie is a girl name
Oihana is a girl name</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Collection&lt;V&gt;&gt; get(K key)</div>
<p>Asynchronous that returns a view collection of the values associated with key in this multimap cache, if any. Any changes to the retrieved collection won&#8217;t change the values in this multimap cache.
When this method returns an empty collection, it means the key was not found.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Boolean&gt; remove(K key)</div>
<p>Asynchronous that removes the entry associated with the key from the multimap cache, if such exists.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Boolean&gt; remove(K key, V value)</div>
<p>Asynchronous that removes a key-value pair from the multimap cache, if such exists.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Void&gt; remove(Predicate&lt;? super V&gt; p)</div>
<p>Asynchronous method. Removes every value that match the given predicate.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Boolean&gt; containsKey(K key)</div>
<p>Asynchronous that returns true if this multimap contains the key.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Boolean&gt; containsValue(V value)</div>
<p>Asynchronous that returns true if this multimap contains the value in at least one key.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Boolean&gt; containsEntry(K key, V value)</div>
<p>Asynchronous that returns true if this multimap contains at least one key-value pair with the value.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Long&gt; size()</div>
<p>Asynchronous that returns the number of key-value pairs in the multimap cache. It doesn&#8217;t return the distinct number of keys.</p>
</div>
<div class="paragraph">
<div class="title">boolean supportsDuplicates()</div>
<p>Asynchronous that returns true if the multimap cache supports duplicates. This means that the content of the multimap can be
'a' &#8594; ['1', '1', '2']. For now this method will always return false, as duplicates are not yet supported.
The existence of a given value is determined by 'equals' and `hashcode' method&#8217;s contract.</p>
</div>
</div>
<div class="sect3">
<h4 id="creating_a_multimap_cache"><a class="anchor" href="#creating_a_multimap_cache"></a>13.1.3. Creating a Multimap Cache</h4>
<div class="paragraph">
<p>Currently the MultimapCache is configured as a regular cache. This can be done either by code or XML configuration.
See how to configure a regular cache in <a href="../configuring/configuring.html#cache-configuration">Configuring Infinispan caches</a>.</p>
</div>
<div class="sect4">
<h5 id="embedded_mode"><a class="anchor" href="#embedded_mode"></a>Embedded mode</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// create or obtain your EmbeddedCacheManager
EmbeddedCacheManager cm = ... ;

// create or obtain a MultimapCacheManager passing the EmbeddedCacheManager
MultimapCacheManager multimapCacheManager = EmbeddedMultimapCacheManagerFactory.from(cm);

// define the configuration for the multimap cache
multimapCacheManager.defineConfiguration(multimapCacheName, c.build());

// get the multimap cache
multimapCache = multimapCacheManager.get(multimapCacheName);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="multimap_limitations"><a class="anchor" href="#multimap_limitations"></a>13.1.4. Limitations</h4>
<div class="paragraph">
<p>In almost every case the Multimap Cache will behave as a regular Cache, but some limitations exist in the current version, as follows:</p>
</div>
<div class="sect4">
<h5 id="support_for_duplicates"><a class="anchor" href="#support_for_duplicates"></a>Support for duplicates</h5>
<div class="paragraph">
<p>A multimap can be configured to store duplicate values for a single key. A duplicate is determined by the value&#8217;s <code>equals</code> method.
Whenever the put method is called, if multimap is configured to support duplicates, the key-value pair will be added to the collection.
Invoking remove on the multimap will remove all duplicates if present.</p>
</div>
</div>
<div class="sect4">
<h5 id="eviction"><a class="anchor" href="#eviction"></a>Eviction</h5>
<div class="paragraph">
<p>For now, the eviction works per key, and not per key-value pair.
This means that whenever a key is evicted, all the values associated with the key will be evicted too.</p>
</div>
</div>
<div class="sect4">
<h5 id="transactions"><a class="anchor" href="#transactions"></a>Transactions</h5>
<div class="paragraph">
<p>Implicit transactions are supported through the auto-commit and all the methods are non blocking.
Explicit transactions work without blocking in most of the cases.
Methods that will block are <code>size</code>, <code>containsEntry</code> and <code>remove(Predicate&lt;? super V&gt; p)</code></p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="custom_interceptors_chapter"><a class="anchor" href="#custom_interceptors_chapter"></a>14. Custom Interceptors</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Custom interceptors are deprecated in Infinispan and will be removed in a
future version.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Custom interceptors are a way of extending Infinispan by being able to influence or respond to any modifications to cache. Example of such modifications are: elements are added/removed/updated or transactions are committed.</p>
</div>
<div class="sect2">
<h3 id="adding_custom_interceptors_declaratively"><a class="anchor" href="#adding_custom_interceptors_declaratively"></a>14.1. Adding custom interceptors declaratively</h3>
<div class="paragraph">
<p>Custom interceptors can be added on a per named cache basis. This is because each named cache have its own interceptor stack. Following xml snippet depicts the ways in which a custom interceptor can be added.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;local-cache name="cacheWithCustomInterceptors"&gt;
  &lt;!-- Define custom interceptors. --&gt;
  &lt;!-- Custom interceptors should extend
       org.infinispan.interceptors.BaseCustomAsyncInterceptor --&gt;
  &lt;custom-interceptors&gt;
    &lt;interceptor position="FIRST" class="com.mycompany.CustomInterceptor1"&gt;
      &lt;property name="attributeOne"&gt;value1&lt;/property&gt;
      &lt;property name="attributeTwo"&gt;value2&lt;/property&gt;
    &lt;/interceptor&gt;
    &lt;interceptor position="LAST" class="com.mycompany.CustomInterceptor2"/&gt;
    &lt;interceptor index="3" class="com.mycompany.CustomInterceptor1"/&gt;
    &lt;interceptor before="org.infinispanpan.interceptors.CallInterceptor"
                 class="com.mycompany.CustomInterceptor2"/&gt;
    &lt;interceptor after="org.infinispanpan.interceptors.CallInterceptor"
                 class="com.mycompany.CustomInterceptor1"/&gt;
  &lt;/custom-interceptors&gt;
&lt;/local-cache&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding_custom_interceptors_programmatically"><a class="anchor" href="#adding_custom_interceptors_programmatically"></a>14.2. Adding custom interceptors programmatically</h3>
<div class="paragraph">
<p>In order to do that one needs to obtain a reference to the <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a>. This can be done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">CacheManager cm = getCacheManager();//magic
Cache aCache = cm.getCache("aName");
AdvancedCache advCache = aCache.getAdvancedCache();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then one of the <em>addInterceptor()</em> methods should be used to add the actual interceptor. For further documentation refer to <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a> javadoc.</p>
</div>
</div>
<div class="sect2">
<h3 id="custom_interceptor_design"><a class="anchor" href="#custom_interceptor_design"></a>14.3. Custom interceptor design</h3>
<div class="paragraph">
<p>When writing a custom interceptor, you need to abide by the following rules.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Custom interceptors must declare a public, empty constructor to enable construction.</p>
</li>
<li>
<p>Custom interceptors will have setters for any property defined through property tags used in the XML configuration.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="functional-map-api"><a class="anchor" href="#functional-map-api"></a>15. Functional Map API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan provides an experimental API for interacting with your data which takes advantage of the functional programming additions and improved asynchronous programming capabilities available since Java 8.</p>
</div>
<div class="sect2">
<h3 id="using-functional-map-api"><a class="anchor" href="#using-functional-map-api"></a>15.1. Using the Functional Map API</h3>
<div class="paragraph">
<p>Infinispan&#8217;s <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.html">Functional Map API</a>
is a distilled map-like asynchronous API which uses functions to interact with data.</p>
</div>
<div class="sect3">
<h4 id="asynchronous_and_lazy"><a class="anchor" href="#asynchronous_and_lazy"></a>15.1.1. Asynchronous and Lazy</h4>
<div class="paragraph">
<p>Being an asynchronous API, all methods that return a single result,
return a CompletableFuture which wraps the result, so you can use the
resources of your system more efficiently by having the possibility to
receive callbacks when the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>
has completed, or you can chain or compose them with other CompletableFuture.</p>
</div>
<div class="paragraph">
<p>For those operations that return multiple results, the API returns instances of a <a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Traversable.html">Traversable</a> interface which offers a lazy pull-style API for working with multiple results.</p>
</div>
<div class="paragraph">
<p><code>Traversable</code>, being a lazy pull-style API, can still be asynchronous underneath since the user can decide to work on the traversable at a later stage, and the <code>Traversable</code> implementation itself can decide when to compute those results.</p>
</div>
</div>
<div class="sect3">
<h4 id="function_transparency"><a class="anchor" href="#function_transparency"></a>15.1.2. Function transparency</h4>
<div class="paragraph">
<p>Since the content of the functions is transparent to Infinispan, the API
has been split into 3 interfaces for read-only (
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.ReadOnlyMap.html"><code>ReadOnlyMap</code></a>
), read-write (
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.ReadWriteMap.html"><code>ReadWriteMap</code></a>
) and write-only (
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html"><code>WriteOnlyMap</code></a>
) operations respectively, in order to provide hints to the Infinispan
internals on the type of work needed to support functions.</p>
</div>
</div>
<div class="sect3">
<h4 id="constructing_functional_maps"><a class="anchor" href="#constructing_functional_maps"></a>15.1.3. Constructing Functional Maps</h4>
<div class="paragraph">
<p>To construct any of the read-only, write-only or read-write map
instances, an Infinispan
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a>
is required, which is retrieved from the Cache Manager, and using the
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a>
, static method
factory methods are used to create
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.ReadOnlyMap.html"><code>ReadOnlyMap</code></a>
,
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.ReadWriteMap.html"><code>ReadWriteMap</code></a>
or
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html"><code>WriteOnlyMap</code></a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.FunctionalMap.*;
import org.infinispan.functional.impl.*;
import org.infinispan.AdvancedCache;

AdvancedCache&lt;String, String&gt; cache = ...

FunctionalMapImpl&lt;String, String&gt; functionalMap = FunctionalMapImpl.create(cache);
ReadOnlyMap&lt;String, String&gt; readOnlyMap = ReadOnlyMapImpl.create(functionalMap);
WriteOnlyMap&lt;String, String&gt; writeOnlyMap = WriteOnlyMapImpl.create(functionalMap);
ReadWriteMap&lt;String, String&gt; readWriteMap = ReadWriteMapImpl.create(functionalMap);</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
At this stage, the Functional Map API is experimental and hence the
way FunctionalMap, ReadOnlyMap, WriteOnlyMap and ReadWriteMap are constructed
is temporary.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="read_only_map_api"><a class="anchor" href="#read_only_map_api"></a>15.1.4. Read-Only Map API</h4>
<div class="paragraph">
<p>Read-only operations have the advantage that no locks are acquired
for the duration of the operation. Here&#8217;s an example on how to the
equivalent operation for
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/Map.html#get-java.lang.Object-">Map.get(K)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.EntryView.ReadEntryView;
import org.infinispan.functional.FunctionalMap.ReadOnlyMap;

ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...
CompletableFuture&lt;Optional&lt;String&gt;&gt; readFuture = readOnlyMap.eval("key1", ReadEntryView::find);
readFuture.thenAccept(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read-only map also exposes operations to retrieve multiple keys in one go:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.EntryView.*;
import org.infinispan.functional.FunctionalMap.*;
import org.infinispan.functional.Traversable;

ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...

Set&lt;String&gt; keys = new HashSet&lt;&gt;(Arrays.asList("key1", "key2"));
Traversable&lt;String&gt; values = readOnlyMap.evalMany(keys, ReadEntryView::get);
values.forEach(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, read-only map also exposes methods to read all existing keys as well
as entries, which include both key and value information.</p>
</div>
<div class="sect4">
<h5 id="read_only_entry_view"><a class="anchor" href="#read_only_entry_view"></a>Read-Only Entry View</h5>
<div class="paragraph">
<p>The function parameters for read-only maps provide the user with a
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/EntryView.ReadEntryView.html">read-only entry view</a>
to interact with the data in the cache, which include these operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/EntryView.ReadEntryView.html#key()"><code>key()</code></a>
method returns the key for which this function is being executed.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/EntryView.ReadEntryView.html#find()"><code>find()</code></a>
returns an <code>Optional</code> wrapping the value if present,
otherwise it returns an empty optional. Unless the value is guaranteed to
be associated with the key, it&#8217;s recommended to use <code>find()</code> to verify
whether there&#8217;s a value associated with the key.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/EntryView.ReadEntryView.html#get()"><code>get()</code></a>
returns the value associated with the key. If the key has no value
associated with it, calling <code>get()</code> throws a <code>NoSuchElementException</code>.
<code>get()</code> can be considered as a shortcut of <code>ReadEntryView.find().get()</code>
which should be used only when the caller has guarantees that there&#8217;s
definitely a value associated with the key.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/MetaParam.Lookup.html#findMetaParam(java.lang.Class)"><code>findMetaParam(Class&lt;T&gt; type)</code></a>
allows metadata parameter information
associated with the cache entry to be looked up, for example: entry
lifespan, last  accessed time&#8230;&#8203;etc.
See <a href="#meta_parameter">Metadata Parameter Handling</a> to find out more.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="write_only_map_api"><a class="anchor" href="#write_only_map_api"></a>15.1.5. Write-Only Map API</h4>
<div class="paragraph">
<p>Write-only operations include operations that insert or update data in the
cache and also removals. Crucially, a write-only operation does not attempt
to read any previous value associated with the key. This is an important
optimization since that means neither the cluster nor any persistence stores
will be looked up to retrieve previous values. In the main Infinispan Cache,
this kind of optimization was achieved using a local-only per-invocation
flag, but the use case is so common that in this new functional API, this
optimization is provided as a first-class citizen.</p>
</div>
<div class="paragraph">
<p>Using
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html">write-only map API</a>
, an operation equivalent to
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>javax.cache.Cache</code> (<code>JCache</code>)</a>
's void returning
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java#L194"><code>put</code></a>
can be achieved this way, followed by an attempt to read the stored
value using the read-only map API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.EntryView.*;
import org.infinispan.functional.FunctionalMap.*;

WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...
ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...

CompletableFuture&lt;Void&gt; writeFuture = writeOnlyMap.eval("key1", "value1",
   (v, view) -&gt; view.set(v));
CompletableFuture&lt;String&gt; readFuture = writeFuture.thenCompose(r -&gt;
   readOnlyMap.eval("key1", ReadEntryView::get));
readFuture.thenAccept(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple key/value pairs can be stored in one go using
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html#evalMany(java.util.Map,java.util.function.BiConsumer)"><code>evalMany</code></a>
API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...

Map&lt;K, String&gt; data = new HashMap&lt;&gt;();
data.put("key1", "value1");
data.put("key2", "value2");
CompletableFuture&lt;Void&gt; writerAllFuture = writeOnlyMap.evalMany(data, (v, view) -&gt; view.set(v));
writerAllFuture.thenAccept(x -&gt; "Write completed");</code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove all contents of the cache, there are two possibilities with
different semantics. If using
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html#evalAll(java.util.function.Consumer)"><code>evalAll</code></a>
each cached entry is iterated over and the function is called
with that entry&#8217;s information. Using this method also results in listeners being invoked.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...

CompletableFuture&lt;Void&gt; removeAllFuture = writeOnlyMap.evalAll(WriteEntryView::remove);
removeAllFuture.thenAccept(x -&gt; "All entries removed");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The alternative way to remove all entries is to call
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html#truncate()"><code>truncate</code></a>
operation which clears the entire cache contents in one go without
invoking any listeners and is best-effort:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...

CompletableFuture&lt;Void&gt; truncateFuture = writeOnlyMap.truncate();
truncateFuture.thenAccept(x -&gt; "Cache contents cleared");</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="write_only_entry_view"><a class="anchor" href="#write_only_entry_view"></a>Write-Only Entry View</h5>
<div class="paragraph">
<p>The function parameters for write-only maps provide the user with a
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/EntryView.WriteEntryView.html">write-only entry view</a>
to modify the data in the cache, which include these
operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/EntryView.WriteEntryView.html#set(V,org.infinispan.functional.MetaParam.Writable&#8230;&#8203;)"><code>set(V, MetaParam.Writable&#8230;&#8203;)</code></a>
method allows for a new value to be
associated with the cache entry for which this function is executed, and it
optionally takes zero or more metadata parameters to be stored along with
the value. See <a href="#meta_parameter">Metadata Parameter Handling</a> for more information.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/EntryView.WriteEntryView.html#remove()"><code>remove()</code></a>
method removes the cache entry, including both value and metadata
parameters associated with this key.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="read_write_map_api"><a class="anchor" href="#read_write_map_api"></a>15.1.6. Read-Write Map API</h4>
<div class="paragraph">
<p>The final type of operations we have are read­write operations, and within
this category CAS-like (Compare­And­Swap) operations can be found.
This type of operations require previous value associated with the key
to be read and for locks to be acquired before executing the function.
The vast majority of operations within
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a>
and
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>
APIs fall within this category, and they can easily be implemented using the
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.ReadWriteMap.html">read-write map API</a>
. Moreover, with
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.ReadWriteMap.html">read-write map API</a>
, you can make CAS­like comparisons not only based on value equality
but based on metadata parameter equality such as version information,
and you can send back previous value or boolean instances to signal
whether the CAS­like comparison succeeded.</p>
</div>
<div class="paragraph">
<p>Implementing a write operation that returns the previous value associated
with the cache entry is easy to achieve with the read-write map API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.EntryView.*;
import org.infinispan.functional.FunctionalMap.*;

ReadWriteMap&lt;String, String&gt; readWriteMap = ...

CompletableFuture&lt;Optional&lt;String&gt;&gt; readWriteFuture = readWriteMap.eval("key1", "value1",
   (v, view) -&gt; {
      Optional&lt;V&gt; prev = rw.find();
      view.set(v);
      return prev;
   });
readWriteFuture.thenAccept(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/concurrent/ConcurrentMap.html#replace-K-V-V-"><code>ConcurrentMap.replace(K, V, V)</code></a>
is a replace function that compares the
value present in the map and if it&#8217;s equals to the value passed in as
first parameter, the second value is stored, returning a boolean
indicating whether the replace was successfully completed. This operation
can easily be implemented using the read-write map API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ReadWriteMap&lt;String, String&gt; readWriteMap = ...

String oldValue = "old-value";
CompletableFuture&lt;Boolean&gt; replaceFuture = readWriteMap.eval("key1", "value1", (v, view) -&gt; {
   return view.find().map(prev -&gt; {
      if (prev.equals(oldValue)) {
         rw.set(v);
         return true; // previous value present and equals to the expected one
      }
      return false; // previous value associated with key does not match
   }).orElse(false); // no value associated with this key
});
replaceFuture.thenAccept(replaced -&gt; System.out.printf("Value was replaced? %s%n", replaced));</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The function in the example above captures <code>oldValue</code> which is an
external value to the function which is valid use case.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Read-write map API contains <code>evalMany</code> and <code>evalAll</code> operations which behave
similar to the write-only map offerings, except that they enable previous
value and metadata parameters to be read.</p>
</div>
<div class="sect4">
<h5 id="read_write_entry_view"><a class="anchor" href="#read_write_entry_view"></a>Read-Write Entry View</h5>
<div class="paragraph">
<p>The function parameters for read-write maps provide the user with the
possibility to query the information associated with the key, including
value and metadata parameters, and the user can also use this
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/EntryView.ReadWriteEntryView.html">read-write entry view</a>
to modify the data in the cache.</p>
</div>
<div class="paragraph">
<p>The operations are exposed by read-write entry views are a union of
the operations exposed by <a href="#read_only_entry_view">read-only entry views</a>
and <a href="#write_only_entry_view">write-only entry views</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="meta_parameter"><a class="anchor" href="#meta_parameter"></a>15.1.7. Metadata Parameter Handling</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/MetaParam.html">Metadata parameters</a>
provide extra information about the cache entry, such
as version information, lifespan, last accessed/used time&#8230;&#8203;etc. Some of
these can be provided by the user, e.g. version, lifespan&#8230;&#8203;etc, but some
others are computed internally and can only be queried, e.g. last
accessed/used time.</p>
</div>
<div class="paragraph">
<p>The functional map API provides a flexible way to store metadata parameters
along with an cache entry. To be able to store a metadata parameter, it must
extend
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/MetaParam.Lookup.html"><code>MetaParam.Writable</code></a>
interface, and implement the methods to allow the
internal logic to extra the data. Storing is done via the
<code>set(V, MetaParam.Writable&#8230;&#8203;)</code> method in the <a href="#write_only_entry_view">write-only entry view</a> or <a href="#read_write_entry_view">read-write entry view</a> function parameters.</p>
</div>
<div class="paragraph">
<p>Querying metadata parameters is available via the
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/MetaParam.Lookup.html#findMetaParam(java.lang.Class)"><code>findMetaParam(Class)</code></a>
method
available via <a href="#read_write_entry_view">read-write entry view</a> or
<a href="#read_only_entry_view">read-only entry views</a> or function parameters.</p>
</div>
<div class="paragraph">
<p>Here is an example showing how to store metadata parameters and how to query
them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import java.time.Duration;
import org.infinispan.functional.EntryView.*;
import org.infinispan.functional.FunctionalMap.*;
import org.infinispan.functional.MetaParam.*;

WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...
ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...

CompletableFuture&lt;Void&gt; writeFuture = writeOnlyMap.eval("key1", "value1",
   (v, view) -&gt; view.set(v, new MetaLifespan(Duration.ofHours(1).toMillis())));
CompletableFuture&lt;MetaLifespan&gt; readFuture = writeFuture.thenCompose(r -&gt;
   readOnlyMap.eval("key1", view -&gt; view.findMetaParam(MetaLifespan.class).get()));
readFuture.thenAccept(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the metadata parameter is generic, for example
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/MetaParam.MetaEntryVersion.html"><code>MetaEntryVersion&lt;T&gt;</code></a>
, retrieving the metadata parameter along with a specific type can be tricky
if using <code>.class</code> static helper in a class because it does not return a
<code>Class&lt;T&gt;</code> but only <code>Class</code>, and hence any generic information in the class is
lost:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...

CompletableFuture&lt;String&gt; readFuture = readOnlyMap.eval("key1", view -&gt; {
   // If caller depends on the typed information, this is not an ideal way to retrieve it
   // If the caller does not depend on the specific type, this works just fine.
   Optional&lt;MetaEntryVersion&gt; version = view.findMetaParam(MetaEntryVersion.class);
   return view.get();
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>When generic information is important the user can define a static helper
method that coerces the static class retrieval to the type requested,
and then use that helper method in the call to <code>findMetaParam</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class MetaEntryVersion&lt;T&gt; implements MetaParam.Writable&lt;EntryVersion&lt;T&gt;&gt; {
   ...
   public static &lt;T&gt; T type() { return (T) MetaEntryVersion.class; }
   ...
}

ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...

CompletableFuture&lt;String&gt; readFuture = readOnlyMap.eval("key1", view -&gt; {
   // The caller wants guarantees that the metadata parameter for version is numeric
   // e.g. to query the actual version information
   Optional&lt;MetaEntryVersion&lt;Long&gt;&gt; version = view.findMetaParam(MetaEntryVersion.type());
   return view.get();
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, users are free to create new instances of metadata parameters to
suit their needs. They are stored and retrieved in the very same way as done
for the metadata parameters already provided by the functional map API.</p>
</div>
</div>
<div class="sect3">
<h4 id="_invocation_parameter"><a class="anchor" href="#_invocation_parameter"></a>15.1.8. Invocation Parameter</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Param.html">Per-invocation parameters</a>
are applied to regular functional map API calls to
alter the behaviour of certain aspects. Adding per invocation parameters is
done using the
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.html#withParams(org.infinispan.functional.Param&#8230;&#8203;)"><code>withParams(Param&lt;?&gt;&#8230;&#8203;)</code></a>
method.</p>
</div>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Param.FutureMode.html"><code>Param.FutureMode</code></a>
tweaks whether a method returning a
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>
will span a thread to invoke the method, or instead will use the caller
thread. By default, whenever a call is made to a method returning a
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>
, a separate thread will be span to execute the method asynchronously.
However, if the caller will immediately block waiting for the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>
to complete, spanning a different thread is wasteful, and hence
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Param.FutureMode.html#COMPLETED"><code>Param.FutureMode.COMPLETED</code></a>
can be passed as per-invocation parameter to avoid creating that extra thread. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.EntryView.*;
import org.infinispan.functional.FunctionalMap.*;
import org.infinispan.functional.Param.*;

ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...
ReadOnlyMap&lt;String, String&gt; readOnlyMapCompleted = readOnlyMap.withParams(FutureMode.COMPLETED);
Optional&lt;String&gt; readFuture = readOnlyMapCompleted.eval("key1", ReadEntryView::find).get();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Param.PersistenceMode controls whether a write operation will be propagated
to a persistence store. The default behaviour is for all write-operations
to be propagated to the persistence store if the cache is configured with
a persistence store. By passing PersistenceMode.SKIP as parameter,
the write operation skips the persistence store and its effects are only
seen in the in-memory contents of the cache. PersistenceMode.SKIP can
be used to implement an
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/Cache.html#evict-K-"><code>Cache.evict()</code></a>
method which removes data from memory but leaves the persistence store
untouched:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.EntryView.*;
import org.infinispan.functional.FunctionalMap.*;
import org.infinispan.functional.Param.*;

WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...
WriteOnlyMap&lt;String, String&gt; skiPersistMap = writeOnlyMap.withParams(PersistenceMode.SKIP);
CompletableFuture&lt;Void&gt; removeFuture = skiPersistMap.eval("key1", WriteEntryView::remove);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that there&#8217;s no need for another PersistenceMode option to skip
reading from the persistence store, because a write operation can skip
reading previous value from the store by calling a write-only operation
via the WriteOnlyMap.</p>
</div>
<div class="paragraph">
<p>Finally, new Param implementations are normally provided by the functional
map API since they tweak how the internal logic works. So, for the most part
of users, they should limit themselves to using the Param instances exposed
by the API. The exception to this rule would be advanced users who decide
to add new interceptors to the internal stack. These users have the ability
to query these parameters within the interceptors.</p>
</div>
</div>
<div class="sect3">
<h4 id="functional_listeners"><a class="anchor" href="#functional_listeners"></a>15.1.9. Functional Listeners</h4>
<div class="paragraph">
<p>The functional map offers a listener API, where clients can register for and
get notified when events take place. These notifications are post-event, so
that means the events are received after the event has happened.</p>
</div>
<div class="paragraph">
<p>The listeners that can be registered are split into two categories:
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Listeners.WriteListeners.html">write listeners</a>
and
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.html">read-write listeners</a>.</p>
</div>
<div class="sect4">
<h5 id="write_listeners"><a class="anchor" href="#write_listeners"></a>Write Listeners</h5>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Listeners.WriteListeners.html">Write listeners</a>
enable user to register listeners for any cache entry write events
that happen in either a read-write or write-only functional map.</p>
</div>
<div class="paragraph">
<p>Listeners for write events cannot distinguish between cache entry
created and cache entry modify/update events because they don&#8217;t have
access to the previous value. All they know is that a new non-null
entry has been written.</p>
</div>
<div class="paragraph">
<p>However, write event listeners can distinguish between entry removals
and cache entry create/modify-update events because they can query
what the new entry&#8217;s value via
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/EntryView.ReadEntryView.html#find()"><code>ReadEntryView.find()</code></a>
method.</p>
</div>
<div class="paragraph">
<p>Adding a write listener is done via the WriteListeners interface
which is accessible via both
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.ReadWriteMap.html#listeners()"><code>ReadWriteMap.listeners()</code></a>
and
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html#listeners()"><code>WriteOnlyMap.listeners()</code></a>
 method.</p>
</div>
<div class="paragraph">
<p>A write listener implementation can be defined either passing a function
to
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Listeners.WriteListeners.html#onWrite(java.util.function.Consumer)"><code>onWrite(Consumer&lt;ReadEntryView&lt;K, V&gt;&gt;)</code></a>
method, or passing a
WriteListener implementation to
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Listeners.WriteListeners.html#add(org.infinispan.functional.Listeners.WriteListeners.WriteListener)"><code>add(WriteListener&lt;K, V&gt;)</code></a>
method.
Either way, all these methods return an
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/lang/AutoCloseable.html">AutoCloseable</a>
instance that can be used to de-register the function listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.EntryView.*;
import org.infinispan.functional.FunctionalMap.*;
import org.infinispan.functional.Listeners.WriteListeners.WriteListener;

WriteOnlyMap&lt;String, String&gt; woMap = ...

AutoCloseable writeFunctionCloseHandler = woMap.listeners().onWrite(written -&gt; {
   // `written` is a ReadEntryView of the written entry
   System.out.printf("Written: %s%n", written.get());
});
AutoCloseable writeCloseHanlder = woMap.listeners().add(new WriteListener&lt;String, String&gt;() {
   @Override
   public void onWrite(ReadEntryView&lt;K, V&gt; written) {
      System.out.printf("Written: %s%n", written.get());
   }
});

// Either wrap handler in a try section to have it auto close...
try(writeFunctionCloseHandler) {
   // Write entries using read-write or write-only functional map API
   ...
}
// Or close manually
writeCloseHanlder.close();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="read_write_listeners"><a class="anchor" href="#read_write_listeners"></a>Read-Write Listeners</h5>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.html">Read-write listeners</a>
enable users to register listeners for cache entry created, modified
and removed events, and also register listeners for any cache entry
write events.</p>
</div>
<div class="paragraph">
<p>Entry created, modified and removed events can only be fired when these
originate on a read-write functional map, since this is the only one
that guarantees that the previous value has been read, and hence the
differentiation between create, modified and removed can be fully
guaranteed.</p>
</div>
<div class="paragraph">
<p>Adding a read-write listener is done via the
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.html"><code>ReadWriteListeners</code></a>
interface which is accessible via
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/FunctionalMap.ReadWriteMap.html#listeners()"><code>ReadWriteMap.listeners()</code></a>
method.</p>
</div>
<div class="paragraph">
<p>If interested in only one of the event types, the simplest way to add a
listener is to pass a function to either
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onCreate(java.util.function.Consumer)"><code>onCreate</code></a>
,
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onModify(java.util.function.BiConsumer)"><code>onModify</code></a>
or
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onRemove(java.util.function.Consumer)"><code>onRemove</code></a>
methods. All these methods return an AutoCloseable instance that can be
used to de-register the function listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.EntryView.*;
import org.infinispan.functional.FunctionalMap.*;

ReadWriteMap&lt;String, String&gt; rwMap = ...
AutoCloseable createClose = rwMap.listeners().onCreate(created -&gt; {
   // `created` is a ReadEntryView of the created entry
   System.out.printf("Created: %s%n", created.get());
});
AutoCloseable modifyClose = rwMap.listeners().onModify((before, after) -&gt; {
   // `before` is a ReadEntryView of the entry before update
   // `after` is a ReadEntryView of the entry after update
   System.out.printf("Before: %s%n", before.get());
   System.out.printf("After: %s%n", after.get());
});
AutoCloseable removeClose = rwMap.listeners().onRemove(removed -&gt; {
   // `removed` is a ReadEntryView of the removed entry
   System.out.printf("Removed: %s%n", removed.get());
});
AutoCloseable writeClose = woMap.listeners().onWrite(written -&gt; {
   // `written` is a ReadEntryView of the written entry
   System.out.printf("Written: %s%n", written.get());
});
...
// Either wrap handler in a try section to have it auto close...
try(createClose) {
   // Create entries using read-write functional map API
   ...
}
// Or close manually
modifyClose.close();</code></pre>
</div>
</div>
<div class="paragraph">
<p>If listening for two or more event types, it&#8217;s better to pass in an
implementation of
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Listeners.WriteListeners.WriteListener.html"><code>ReadWriteListener</code></a>
interface via the
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.html#add(org.infinispan.functional.Listeners.ReadWriteListeners.ReadWriteListener)"><code>ReadWriteListeners.add()</code></a>
method. <code>ReadWriteListener</code> offers the same <code>onCreate</code>/<code>onModify</code>/<code>onRemove</code>
callbacks with default method implementations that are empty:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.EntryView.*;
import org.infinispan.functional.FunctionalMap.*;
import org.infinispan.functional.Listeners.ReadWriteListeners.ReadWriteListener;

ReadWriteMap&lt;String, String&gt; rwMap = ...
AutoCloseable readWriteClose = rwMap.listeners.add(new ReadWriteListener&lt;String, String&gt;() {
   @Override
   public void onCreate(ReadEntryView&lt;String, String&gt; created) {
      System.out.printf("Created: %s%n", created.get());
   }

   @Override
   public void onModify(ReadEntryView&lt;String, String&gt; before, ReadEntryView&lt;String, String&gt; after) {
      System.out.printf("Before: %s%n", before.get());
      System.out.printf("After: %s%n", after.get());
   }

   @Override
   public void onRemove(ReadEntryView&lt;String, String&gt; removed) {
      System.out.printf("Removed: %s%n", removed.get());
   }
);
AutoCloseable writeClose = rwMap.listeners.add(new WriteListener&lt;String, String&gt;() {
   @Override
   public void onWrite(ReadEntryView&lt;K, V&gt; written) {
      System.out.printf("Written: %s%n", written.get());
   }
);

// Either wrap handler in a try section to have it auto close...
try(readWriteClose) {
   // Create/update/remove entries using read-write functional map API
   ...
}
// Or close manually
writeClose.close();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="marshalling_of_functions"><a class="anchor" href="#marshalling_of_functions"></a>15.1.10. Marshalling of Functions</h4>
<div class="paragraph">
<p>Running functional map in a cluster of nodes involves marshalling and
replication of the operation parameters under certain circumstances.</p>
</div>
<div class="paragraph">
<p>To be more precise, when write operations are executed in a cluster,
regardless of read-write or write-only operations, all the parameters
to the method and the functions are replicated to other nodes.</p>
</div>
<div class="paragraph">
<p>There are multiple ways in which a function can be marshalled. The simplest
way, which is also the most costly option in terms of payload size, is
to mark the function as
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/io/Serializable.html"><code>Serializable</code></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.EntryView.*;
import org.infinispan.functional.FunctionalMap.*;

WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...

// Force a function to be Serializable
Consumer&lt;WriteEntryView&lt;String&gt;&gt; function =
   (Consumer&lt;WriteEntryView&lt;String&gt;&gt; &amp; Serializable) wv -&gt; wv.set("one");

CompletableFuture&lt;Void&gt; writeFuture = writeOnlyMap.eval("key1", function);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan provides overloads for all functional methods that make lambdas
passed directly to the API serializable by default; the compiler automatically selects
this overload if that&#8217;s possible. Therefore you can call</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...
CompletableFuture&lt;Void&gt; writeFuture = writeOnlyMap.eval("key1", wv -&gt; wv.set("one"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>without doing the cast described above.</p>
</div>
<div class="paragraph">
<p>A more economical way to marshall a function is to provide an Infinispan
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/commons/marshall/Externalizer.html"><code>Externalizer</code></a> for it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.EntryView.*;
import org.infinispan.functional.FunctionalMap.*;
import org.infinispan.commons.marshall.Externalizer;
import org.infinispan.commons.marshall.SerializeFunctionWith;

WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...

// Force a function to be Serializable
Consumer&lt;WriteEntryView&lt;String&gt;&gt; function = new SetStringConstant&lt;&gt;();
CompletableFuture&lt;Void&gt; writeFuture = writeOnlyMap.eval("key1", function);

@SerializeFunctionWith(value = SetStringConstant.Externalizer0.class)
class SetStringConstant implements Consumer&lt;WriteEntryView&lt;String&gt;&gt; {
   @Override
   public void accept(WriteEntryView&lt;String&gt; view) {
      view.set("value1");
   }

   public static final class Externalizer0 implements Externalizer&lt;Object&gt; {
      public void writeObject(ObjectOutput oo, Object o) {
         // No-op
      }
      public Object readObject(ObjectInput input) {
         return new SetStringConstant&lt;&gt;();
      }
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To help users take advantage of the tiny payloads generated by
<code>Externalizer</code>-based functions, the functional API comes with a helper
class called
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/commons/marshall/MarshallableFunctions.html"><code>org.infinispan.commons.marshall.MarshallableFunctions</code></a>
which provides marshallable functions for some of the most commonly user
functions.</p>
</div>
<div class="paragraph">
<p>In fact, all the functions required to implement
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a>
and
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>
using the functional map API have been defined in
<a href="https://docs.jboss.org/infinispan/15.0/apidocs/org/infinispan/commons/marshall/MarshallableFunctions.html"><code>MarshallableFunctions</code></a>.
For example, here is an implementation of JCache&#8217;s
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java#L283"><code>boolean putIfAbsent(K, V)</code></a>
using functional map API which can be run in a cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.functional.EntryView.*;
import org.infinispan.functional.FunctionalMap.*;
import org.infinispan.commons.marshall.MarshallableFunctions;

ReadWriteMap&lt;String, String&gt; readWriteMap = ...

CompletableFuture&lt;Boolean&gt; future = readWriteMap.eval("key1,
   MarshallableFunctions.setValueIfAbsentReturnBoolean());
future.thenAccept(stored -&gt; System.out.printf("Value was put? %s%n", stored));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="use_cases_for_functional_api"><a class="anchor" href="#use_cases_for_functional_api"></a>15.1.11. Use Cases for Functional API</h4>
<div class="paragraph">
<p>This new API is meant to complement existing Key/Value Infinispan API
offerings, so you&#8217;ll still be able to use
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a>
or
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>
standard APIs if that&#8217;s what suits your use case best.</p>
</div>
<div class="paragraph">
<p>The target audience for this new API is either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Distributed or persistent caching/in­memory­data­grid users that want
to benefit from CompletableFuture and/or Traversable for async/lazy data
grid or caching data manipulation. The clear advantage here is that threads
do not need to be idle waiting for remote operations to complete, but
instead these can be notified when remote operations complete and then
chain them with other subsequent operations.</p>
</li>
<li>
<p>Users who want to go beyond the standard operations exposed by
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a>
and
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>, for example, if you want to do a replace
operation using metadata parameter equality instead of value equality, or
if you want to retrieve metadata information from values and so on.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="anchored-keys"><a class="anchor" href="#anchored-keys"></a>16. Anchored keys</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="anchored_keys_module"><a class="anchor" href="#anchored_keys_module"></a>16.1. Anchored Keys module</h3>
<div class="paragraph">
<p>Infinispan version 11 introduces an experimental module that allows scaling up a cluster
and adding new nodes without expensive <strong>state transfer</strong>.</p>
</div>
<div class="sect3">
<h4 id="background"><a class="anchor" href="#background"></a>16.1.1. Background</h4>
<div class="paragraph">
<p>For background, the preferred way to scale up the storage capacity of a Infinispan cluster
is to use distributed caches.
A distributed cache stores each key/value pair on <code>num-owners</code> nodes,
and each node can compute the location of a key (aka the key owners) directly.</p>
</div>
<div class="paragraph">
<p>Infinispan achieves this by statically mapping cache keys to <code>num-segments</code> <strong>consistent hash segments</strong>,
and then dynamically mapping segments to nodes based on the cache&#8217;s <strong>topology</strong>
(roughly the current plus the historical membership of the cache).
Whenever a new node joins the cluster, the cache is <strong>rebalanced</strong>, and the new node replaces an existing node
as the owner of some segments.
The key/value pairs in those segments are copied to the new node and removed from the no-longer-owner node
via <strong>state transfer</strong>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Because the allocation of segments to nodes is based on random UUIDs generated at start time,
it is common (though less so after
<a href="https://issues.redhat.com/browse/ISPN-11679">ISPN-11679</a>
), for segments to also move from one old node to another old node.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="architecture"><a class="anchor" href="#architecture"></a>16.1.2. Architecture</h4>
<div class="paragraph">
<p>The basic idea is to skip the static mapping of keys to segments and to map keys directly to nodes.</p>
</div>
<div class="paragraph">
<p>When a key/value pair is inserted into the cache,
the newest member becomes the <strong>anchor owner</strong> of that key, and the only node storing the actual value.
In order to make the anchor location available without an extra remote lookup,
all the other nodes store a reference to the anchor owner.</p>
</div>
<div class="paragraph">
<p>That way, when another node joins, it only needs to receive the location information from the existing nodes,
and values can stay on the anchor owner, minimizing the amount of traffic.</p>
</div>
</div>
<div class="sect3">
<h4 id="limitations"><a class="anchor" href="#limitations"></a>16.1.3. Limitations</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Only one node can be added at a time</dt>
<dd>
<p>An external actor (e.g. a Kubernetes/OpenShift operator, or a human administrator)
must monitor the load on the current nodes, and add a new node whenever the newest node
is close to "full".</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Because the anchor owner information is replicated on all the nodes, and values are never moved off a node,
the memory usage of each node will keep growing as new entries and nodes are added.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">There is no redundancy</dt>
<dd>
<p>Every value is only stored on a single node.
When a node crashes or even stops gracefully, the values stored on that node are lost.</p>
</dd>
<dt class="hdlist1">Transactions are not supported</dt>
<dd>
<p>A later version may add transaction support, but the fact that any node stop or crash
loses entries makes transactions a lot less valuable compared to a distributed cache.</p>
</dd>
<dt class="hdlist1">Hot Rod clients do not know the anchor owner</dt>
<dd>
<p>Hot Rod clients cannot use the topology information from the servers to locate the anchor owner.
Instead, the server receiving a Hot Rod get request must make an additional request to the anchor owner
in order to retrieve the value.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="configuration"><a class="anchor" href="#configuration"></a>16.1.4. Configuration</h4>
<div class="paragraph">
<p>The module is still very young and does not yet support many Infinispan features.</p>
</div>
<div class="paragraph">
<p>Eventually, if it proves useful, it may become another cache mode.
For now, configuring a cache with anchored keys requires a replicated cache with a custom element <code>anchored-keys</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;infinispan
      xmlns="urn:infinispan:config:15.0"
      xmlns:anchored="urn:infinispan:config:anchored:15.0"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="urn:infinispan:config:15.0
            https://infinispan.org/schemas/infinispan-config-15.0.xsd
            urn:infinispan:config:anchored:15.0
            https://infinispan.org/schemas/infinispan-anchored-config-15.0.xsd"&gt;

    &lt;cache-container default-cache="default"&gt;
        &lt;transport/&gt;
        &lt;replicated-cache name="default"&gt;
            &lt;anchored:anchored-keys/&gt;
        &lt;/replicated-cache&gt;
    &lt;/cache-container&gt;

&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the <code>&lt;anchored-keys/&gt;</code> element is present, the module automatically enables anchored keys
and makes some required configuration changes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Disables <code>await-initial-transfer</code></p>
</li>
<li>
<p>Enables conflict resolution with the equivalent of</p>
<div class="paragraph">
<p><code>&lt;partition-handling when-split="ALLOW_READ_WRITES" merge-policy="PREFER_NON_NULL"/&gt;</code></p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The cache will fail to start if these attributes are explicitly set to other values,
if state transfer is disabled, or if transactions are enabled.</p>
</div>
</div>
<div class="sect3">
<h4 id="implementation_status"><a class="anchor" href="#implementation_status"></a>16.1.5. Implementation status</h4>
<div class="paragraph">
<p>Basic operations are implemented: <code>put</code>, <code>putIfAbsent</code>, <code>get</code>, <code>replace</code>, <code>remove</code>, <code>putAll</code>, <code>getAll</code>.</p>
</div>
<div class="sect4">
<h5 id="functional_commands"><a class="anchor" href="#functional_commands"></a>Functional commands</h5>
<div class="paragraph">
<p>The <code>FunctionalMap</code> API is not implemented.</p>
</div>
<div class="paragraph">
<p>Other operations that rely on the functional API&#8217;s implementation do not work either: <code>merge</code>, <code>compute</code>,
<code>computeIfPresent</code>, <code>computeIfAbsent</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="partition_handling"><a class="anchor" href="#partition_handling"></a>Partition handling</h5>
<div class="paragraph">
<p>When a node crashes, surviving nodes do not remove anchor references pointing to that node.
In theory, this could allow merges to skip conflict resolution, but currently the <code>PREFERRED_NON_NULL</code>
merge policy is configured automatically and cannot be changed.</p>
</div>
</div>
<div class="sect4">
<h5 id="listeners"><a class="anchor" href="#listeners"></a>Listeners</h5>
<div class="paragraph">
<p>Cluster listeners and client listeners are implemented and receive the correct notifications.</p>
</div>
<div class="paragraph">
<p>Non-clustered embedded listeners currently receive notifications on all the nodes, not just the node
where the value is stored.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="performance_considerations"><a class="anchor" href="#performance_considerations"></a>16.1.6. Performance considerations</h4>
<div class="sect4">
<h5 id="clientserver_latency"><a class="anchor" href="#clientserver_latency"></a>Client/Server Latency</h5>
<div class="paragraph">
<p>The client always contacts the primary owner, so any read has a
<code>(N-1)/N</code> probability of requiring a unicast RPC from the primary to the anchor owner.</p>
</div>
<div class="paragraph">
<p>Writes require the primary to send the value to one node and the anchor address
to all the other nodes, which is currently done with <code>N-1</code> unicast RPCs.</p>
</div>
<div class="paragraph">
<p>In theory we could send in parallel one unicast RPC for the value and one multicast RPC for the address,
but that would need additional logic to ignore the address on the anchor owner
and with TCP multicast RPCs are implemented as parallel unicasts anyway.</p>
</div>
</div>
<div class="sect4">
<h5 id="memory_overhead"><a class="anchor" href="#memory_overhead"></a>Memory overhead</h5>
<div class="paragraph">
<p>Compared to a distributed cache with one owner, an anchored-keys cache
contains copies of all the keys and their locations, plus the overhead of the cache itself.</p>
</div>
<div class="paragraph">
<p>Therefore, a node with anchored-keys caches should stop accepting new entries when it has less than
<code>(&lt;key size&gt; + &lt;per-key overhead&gt;) * &lt;number of entries not yet inserted&gt;</code> bytes available.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The number of entries not yet inserted is obviously very hard to estimate.
In the future we may provide a way to limit the overhead of key location information,
e.g. by using a distributed cache.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The per-key overhead is lowest for off-heap storage, around 63 bytes:
8 bytes for the entry reference in <code>MemoryAddressHash.memory</code>,
29 bytes for the off-heap entry header,
and 26 bytes for the serialized <code>RemoteMetadata</code> with the owner&#8217;s address.</p>
</div>
<div class="paragraph">
<p>The per-key overhead of the ConcurrentHashMap-based on-heap cache,
assuming a 64-bit JVM with compressed OOPS, would be around 92 bytes:
32 bytes for <code>ConcurrentHashMap.Node</code>, 32 bytes for <code>MetadataImmortalCacheEntry</code>,
24 bytes for <code>RemoteMetadata</code>, and 4 bytes in the <code>ConcurrentHashMap.table</code> array.</p>
</div>
</div>
<div class="sect4">
<h5 id="state_transfer"><a class="anchor" href="#state_transfer"></a>State transfer</h5>
<div class="paragraph">
<p>State transfer does not transfer values, only keys and anchor owner information.</p>
</div>
<div class="paragraph">
<p>Assuming that the values are much bigger compared to the keys,
state transfer for an anchored keys cache should also be much faster
compared to the state transfer of a distributed cache of a similar size.
But for small values, there may not be a visible improvement.</p>
</div>
<div class="paragraph">
<p>The initial state transfer does not block a joiner from starting,
because it will just ask another node for the anchor owner.
However, the remote lookups can be expensive, especially in embedded mode,
but also in server mode, if the client is not <code>HASH_DISTRIBUTION_AWARE</code>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="extending"><a class="anchor" href="#extending"></a>17. Extending Infinispan</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan can be extended to provide the ability for an end user to add
additional configurations, operations and components outside of the scope of the ones normally provided by Infinispan.</p>
</div>
<div class="sect2">
<h3 id="custom_commands"><a class="anchor" href="#custom_commands"></a>17.1. Custom Commands</h3>
<div class="paragraph">
<p>Infinispan makes use of a <a href="http://en.wikipedia.org/wiki/Command_pattern">command/visitor pattern</a> to
implement the various top-level methods you see on the public-facing API.</p>
</div>
<div class="paragraph">
<p>While the core commands - and their corresponding visitors - are hard-coded as
a part of Infinispan&#8217;s core module, module authors can extend and enhance Infinispan
by creating new custom commands.</p>
</div>
<div class="paragraph">
<p>As a module author (such as <a href="https://github.com/infinispan/infinispan/tree/main/query">infinispan-query</a>, etc.) you can define your own commands.</p>
</div>
<div class="paragraph">
<p>You do so by:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code> file and ensure this is packaged in your jar.</p>
</li>
<li>
<p>Implementing <a href="https://github.com/infinispan/infinispan/blob/main/core/src/main/java/org/infinispan/commands/module/ModuleCommandFactory.java"><code>ModuleCommandFactory</code></a> and
<a href="https://github.com/infinispan/infinispan/blob/main/core/src/main/java/org/infinispan/commands/module/ModuleCommandExtensions.java"><code>ModuleCommandExtensions</code></a></p>
</li>
<li>
<p>Specifying the fully-qualified class name of the  <a href="https://github.com/infinispan/infinispan/blob/main/core/src/main/java/org/infinispan/commands/module/ModuleCommandExtensions.java"><code>ModuleCommandExtensions</code></a>
implementation in <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code>.</p>
</li>
<li>
<p>Implement your custom commands and visitors for these commands</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="an_example"><a class="anchor" href="#an_example"></a>17.1.1. An Example</h4>
<div class="paragraph">
<p>Here is an example of an <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code> file, configured accordingly:</p>
</div>
<div class="listingblock">
<div class="title">org.infinispan.commands.module.ModuleCommandExtensions</div>
<div class="content">
<pre>org.infinispan.query.QueryModuleCommandExtensions</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="preassigned_custom_command_id_ranges"><a class="anchor" href="#preassigned_custom_command_id_ranges"></a>17.1.2. Preassigned Custom Command Id Ranges</h4>
<div class="paragraph">
<p>This is the list of <code>Command</code> identifiers that are used by Infinispan based modules or frameworks.
Infinispan users should avoid using ids within these ranges. (RANGES to be finalised yet!)
Being this a single byte, ranges can&#8217;t be too large.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Query:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 - 119</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Search:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">120 - 139</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hot Rod Server:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">140 - 141</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="extending_the_configuration_builders_and_parsers"><a class="anchor" href="#extending_the_configuration_builders_and_parsers"></a>17.2. Extending the configuration builders and parsers</h3>
<div class="paragraph">
<p>If your custom module requires configuration, it is possible to enhance Infinispan&#8217;s configuration builders and
parsers. Look at the <a href="https://github.com/infinispan/infinispan/blob/main/core/src/test/java/org/infinispan/configuration/module">custom module tests</a>
for a detail example on how to implement this.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-06-24 11:16:17 UTC
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>