<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="generator" content="Asciidoctor 0.1.4"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Persistence</title> <style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }
audio, canvas, video { display: inline-block; }
audio:not([controls]) { display: none; height: 0; }
[hidden] { display: none; }
html { background: #fff; color: #000; font-family: sans-serif; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; }
body { margin: 0; }
a:focus { outline: thin dotted; }
a:active, a:hover { outline: 0; }
h1 { font-size: 2em; margin: 0.67em 0; }
abbr[title] { border-bottom: 1px dotted; }
b, strong { font-weight: bold; }
dfn { font-style: italic; }
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }
mark { background: #ff0; color: #000; }
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }
pre { white-space: pre-wrap; }
q { quotes: "\201C" "\201D" "\2018" "\2019"; }
small { font-size: 80%; }
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }
img { border: 0; }
svg:not(:root) { overflow: hidden; }
figure { margin: 0; }
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }
legend { border: 0; padding: 0; }
button, input, select, textarea { font-family: inherit; font-size: 100%; margin: 0; }
button, input { line-height: normal; }
button, select { text-transform: none; }
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; cursor: pointer; }
button[disabled], html input[disabled] { cursor: default; }
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; padding: 0; }
input[type="search"] { -webkit-appearance: textfield; -moz-box-sizing: content-box; -webkit-box-sizing: content-box; box-sizing: content-box; }
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }
textarea { overflow: auto; vertical-align: top; }
table { border-collapse: collapse; border-spacing: 0; }
*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
html, body { font-size: 100%; }
body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }
a:hover { cursor: pointer; }
a:focus { outline: none; }
img, object, embed { max-width: 100%; height: auto; }
object, embed { height: 100%; }
img { -ms-interpolation-mode: bicubic; }
#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }
.left { float: left !important; }
.right { float: right !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-center { text-align: center !important; }
.text-justify { text-align: justify !important; }
.hide { display: none; }
.antialiased, body { -webkit-font-smoothing: antialiased; }
img { display: inline-block; vertical-align: middle; }
textarea { height: auto; min-height: 50px; }
select { width: 100%; }
p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }
.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #7a2518; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }
a { color: #005498; text-decoration: underline; line-height: inherit; }
a:hover, a:focus { color: #00467f; }
a img { border: none; }
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Georgia, "URW Bookman L", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; color: #ba3925; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #e99b8f; line-height: 0; }
h1 { font-size: 2.125em; }
h2 { font-size: 1.6875em; }
h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }
h4 { font-size: 1.125em; }
h5 { font-size: 1.125em; }
h6 { font-size: 1em; }
hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }
em, i { font-style: italic; line-height: inherit; }
strong, b { font-weight: bold; line-height: inherit; }
small { font-size: 60%; line-height: inherit; }
code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; color: #6d180b; }
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }
ul, ol { margin-left: 1.5em; }
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }
abbr { text-transform: none; }
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: inherit; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }
blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }
.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }
@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
.print-only { display: none !important; }
@media print { * { background: transparent !important; color: #000 !important; box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.6; }
.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }
*:not(pre) > code { font-size: 0.9375em; padding: 1px 3px 0; white-space: nowrap; background-color: #f2f2f2; border: 1px solid #cccccc; -webkit-border-radius: 4px; border-radius: 4px; text-shadow: none; }
pre, pre > code { line-height: 1.4; color: inherit; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }
kbd.keyseq { color: #555555; }
kbd:not(.keyseq) { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }
kbd kbd:first-child { margin-left: 0; }
kbd kbd:last-child { margin-right: 0; }
.menuseq, .menu { color: #090909; }
p a > code:hover { color: #561309; }
#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }
#header { margin-bottom: 2.5em; }
#header > h1 { color: black; font-weight: normal; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #6f6f6f; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }
#toc { border-bottom: 3px double #ebebeb; padding-bottom: 1.25em; }
#toc > ul { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }
#toctitle { color: #7a2518; }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #ebebeb; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul { font-size: .95em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1.25em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #ebebeb; left: auto; right: 0; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; border-width: 0; -webkit-border-radius: 4px; border-radius: 4px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }
#content #toctitle { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-size: 1em; padding-left: 0.125em; }
#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }
#footer-text { color: #dddddd; line-height: 1.44; }
.sect1 { padding-bottom: 1.25em; }
.sect1 + .sect1 { border-top: 3px double #ebebeb; }
#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #ba3925; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #a53221; }
.imageblock, .literalblock, .listingblock, .verseblock, .videoblock { margin-bottom: 1.25em; }
.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }
.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }
table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }
.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #6f6f6f; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }
.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 4px; border-radius: 4px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }
.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #d9d9d9; box-shadow: 0 1px 8px #d9d9d9; }
.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 4px; border-radius: 4px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #7a2518; margin-top: 0; line-height: 1.6; }
.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }
.literalblock > .content pre, .listingblock > .content pre { background: none; border-width: 1px 0; border-style: dotted; border-color: #bfbfbf; -webkit-border-radius: 4px; border-radius: 4px; padding: 0.75em 0.75em 0.5em 0.75em; word-wrap: break-word; }
.literalblock > .content pre.nowrap, .listingblock > .content pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content pre > code, .listingblock > .content pre > code { display: block; }
@media only screen { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.8em; } }
@media only screen and (min-width: 768px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.9em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 1em; } }
.listingblock > .content { position: relative; }
.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.375em; right: 0.375em; }
.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }
.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }
.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }
table.pyhltable { border: 0; margin-bottom: 0; }
table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }
table.pyhltable td.code { padding-left: .75em; padding-right: 0; }
.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }
.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }
table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }
.quoteblock { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 1.25em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: inherit; color: #555555; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }
table thead th, table tfoot th { font-weight: bold; }
table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 4px; border-radius: 4px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }
table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }
table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }
table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }
th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }
th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }
th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }
th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }
th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }
th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }
p.tableblock.header { color: #222222; font-weight: bold; }
td > div.verse { white-space: pre; }
ol { margin-left: 1.75em; }
ul li ol { margin-left: 1.5em; }
dl dd { margin-left: 1.125em; }
dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }
ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }
ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }
ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }
ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }
ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }
ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }
.unstyled dl dt { font-weight: normal; font-style: normal; }
ol.arabic { list-style-type: decimal; }
ol.decimal { list-style-type: decimal-leading-zero; }
ol.loweralpha { list-style-type: lower-alpha; }
ol.upperalpha { list-style-type: upper-alpha; }
ol.lowerroman { list-style-type: lower-roman; }
ol.upperroman { list-style-type: upper-roman; }
ol.lowergreek { list-style-type: lower-greek; }
.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }
td.hdlist1 { padding-right: .8em; font-weight: bold; }
td.hdlist1, td.hdlist2 { vertical-align: top; }
.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }
.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }
.qanda > ol > li > p > em:only-child { color: #00467f; }
.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }
.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }
.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }
a.image { text-decoration: none; }
span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }
.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }
div.unbreakable { page-break-inside: avoid; }
.big { font-size: larger; }
.small { font-size: smaller; }
.underline { text-decoration: underline; }
.overline { text-decoration: overline; }
.line-through { text-decoration: line-through; }
.aqua { color: #00bfbf; }
.aqua-background { background-color: #00fafa; }
.black { color: black; }
.black-background { background-color: black; }
.blue { color: #0000bf; }
.blue-background { background-color: #0000fa; }
.fuchsia { color: #bf00bf; }
.fuchsia-background { background-color: #fa00fa; }
.gray { color: #606060; }
.gray-background { background-color: #7d7d7d; }
.green { color: #006000; }
.green-background { background-color: #007d00; }
.lime { color: #00bf00; }
.lime-background { background-color: #00fa00; }
.maroon { color: #600000; }
.maroon-background { background-color: #7d0000; }
.navy { color: #000060; }
.navy-background { background-color: #00007d; }
.olive { color: #606000; }
.olive-background { background-color: #7d7d00; }
.purple { color: #600060; }
.purple-background { background-color: #7d007d; }
.red { color: #bf0000; }
.red-background { background-color: #fa0000; }
.silver { color: #909090; }
.silver-background { background-color: #bcbcbc; }
.teal { color: #006060; }
.teal-background { background-color: #007d7d; }
.white { color: #bfbfbf; }
.white-background { background-color: #fafafa; }
.yellow { color: #bfbf00; }
.yellow-background { background-color: #fafa00; }
span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }
.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #005498; color: #003f72; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }
.conum { display: inline-block; color: white !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }
.literalblock > .content > pre, .listingblock > .content > pre { -webkit-border-radius: 0; border-radius: 0; }

</style> <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.min.css"> <style>
/* Foundation stylesheet for CodeRay (to match GitHub theme) | MIT License | http://foundation.zurb.com */
table.CodeRay { border-collapse: collapse; padding: 2px; margin-bottom: 0; border: 0; background: transparent; }
table.CodeRay td { padding: 0 .5em; vertical-align: top; }
table.CodeRay td.line-numbers { text-align: right; color: #999; border-right: 1px solid #e5e5e5; padding-left: 0; }
span.line-numbers { border-right: 1px solid #E5E5E5; color: #999; display: inline-block; margin-right: 0.5em; padding-right: 0.5em; }
.CodeRay td.line-numbers strong, .CodeRay span.line-numbers strong { font-weight: normal; }
.CodeRay .debug { color: white !important; background: blue !important; }
.CodeRay .annotation { color: #007; }
.CodeRay .attribute-name { color: #f08; }
.CodeRay .attribute-value { color: #700; }
.CodeRay .binary { color: #509; }
.CodeRay .comment  { color: #999; font-style: italic; }
.CodeRay .char { color: #04D; }
.CodeRay .char .content { color: #04D; }
.CodeRay .char .delimiter { color: #039; }
.CodeRay .class { color: #458; }
.CodeRay .complex { color: #A08; }
.CodeRay .constant { color: teal; }
.CodeRay .color { color: #0A0; }
.CodeRay .class-variable { color: #369; }
.CodeRay .decorator { color: #B0B; }
.CodeRay .definition { color: #099; }
.CodeRay .directive { color: #088; }
.CodeRay .delimiter { color: black; }
.CodeRay .doc { color: #970; }
.CodeRay .doctype { color: #34b; }
.CodeRay .doc-string { color: #D42; }
.CodeRay .escape  { color: #666; }
.CodeRay .entity { color: #800; }
.CodeRay .error { color: #808; }
.CodeRay .exception { color: #C00; }
.CodeRay .filename { color: #099; }
.CodeRay .function { color: #900; }
.CodeRay .global-variable { color: teal; }
.CodeRay .hex { color: #058; }
.CodeRay .integer  { color: #099; }
.CodeRay .include { color: #B44; }
.CodeRay .inline { color: black; }
.CodeRay .inline .inline { background: #ccc; }
.CodeRay .inline .inline .inline { background: #bbb; }
.CodeRay .inline .inline-delimiter { color: #D14; }
.CodeRay .inline-delimiter { color: #D14; }
.CodeRay .important { color: #f00; }
.CodeRay .interpreted { color: #B2B; }
.CodeRay .instance-variable { color: teal; }
.CodeRay .label { color: #970; }
.CodeRay .local-variable { color: #963; }
.CodeRay .octal { color: #40E; }
.CodeRay .predefined { color: #369; }
.CodeRay .preprocessor { color: #579; }
.CodeRay .pseudo-class { color: #00C; }
.CodeRay .predefined-type { color: #074; }
.CodeRay .reserved, .keyword  { color: #000; }
.CodeRay .key { color: #808; }
.CodeRay .key .delimiter { color: #606; }
.CodeRay .key .char { color: #80f; }
.CodeRay .value { color: #088; }
.CodeRay .regexp { background-color: #fff0ff; }
.CodeRay .regexp .content { color: #808; }
.CodeRay .regexp .delimiter { color: #404; }
.CodeRay .regexp .modifier { color: #C2C; }
.CodeRay .regexp .function  { color: #404; font-weight: bold; }
.CodeRay .string { color: #D20; }
.CodeRay .string .string { }
.CodeRay .string .string .string { background-color: #ffd0d0; }
.CodeRay .string .content { color: #D14; }
.CodeRay .string .char { color: #D14; }
.CodeRay .string .delimiter { color: #D14; }
.CodeRay .shell { color: #D14; }
.CodeRay .shell .content { }
.CodeRay .shell .delimiter { color: #D14; }
.CodeRay .symbol { color: #990073; }
.CodeRay .symbol .content { color: #A60; }
.CodeRay .symbol .delimiter { color: #630; }
.CodeRay .tag, .CodeRay .attribute-name { color: #070; }
.CodeRay .tag-special { color: #D70; }
.CodeRay .type { color: #339; }
.CodeRay .variable  { color: #036; }
.CodeRay .insert { background: #afa; }
.CodeRay .delete { background: #faa; }
.CodeRay .change { color: #aaf; background: #007; }
.CodeRay .head { color: #f8f; background: #505; }
.CodeRay .insert .insert { color: #080; }
.CodeRay .delete .delete { color: #800; }
.CodeRay .change .change { color: #66f; }
.CodeRay .head .head { color: #f4f; }

</style> </head> <body class="book"> <div id="header"> </div> <div id="content"> <div class="sect1"> <h2 id="_persistence"><a class="anchor" href="#_persistence"></a>1. Persistence</h2> <div class="sectionbody"> <div class="paragraph"> <p>Persistence allows configuring external (persistent) storage engines complementary to the default in memory storage offered by Infinispan. An external persistent storage might be useful for several reasons:</p> </div> <div class="ulist"> <ul> <li> <p>Increased Durability. Memory is volatile, so a cache store could increase the life-span of the information store in the cache.</p> </li> <li> <p>Write-through. Interpose Infinispan as a caching layer between an application and a (custom) external storage engine.</p> </li> <li> <p>Overflow Data. By using eviction and passivation, one can store only the "hot" data in memory and overflow the data that is less frequently used to disk.</p> </li> </ul> </div> <div class="paragraph"> <p>The integration with the persistent store is done through the following SPI: CacheLoader, CacheWriter, AdvancedCacheLoader and AdvancedCacheWriter (discussed in the following sections).</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">This SPI was refactored in Infinispan 6. It brings the following improvements over the previous (up to 5.x) persistence integration</dt> <dd> <div class="ulist"> <ul> <li> <p>Alignment with <a href="http://jcp.org/en/jsr/detail?id=107">JSR-107</a>. The <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/spi/CacheWriter.html">CacheWriter</a> and <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/spi/CacheLoader.html">CacheLoader</a> interface are similar to the the loader and writer in JSR 107. This should considerably help writing portable stores across JCache compliant vendors.</p> </li> <li> <p>Simplified Transaction Integration. All necessary locking is handled by Infinispan automatically and implementations don’t have to be concerned with coordinating concurrent access to the store. Even though concurrent writes on the same key are not going to happen (depending locking mode in use), implementors should expect operations on the store to happen from multiple/different threads and code the implementation accordingly.</p> </li> <li> <p>Parallel Iteration. It is now possible to iterate over entries in the store with multiple threads in parallel. Map/Reduce tasks immediately benefit from this, as the map/reduce tasks now run in parallel over both the nodes in the cluster and within the same node (multiple threads).</p> </li> <li> <p>Reduced Serialization. This translates in less CPU usage. The new API exposes the stored entries in serialized format. If an entry is fetched from persistent storage for the sole purpose of being sent remotely, we no longer need to deserialize it (when reading from the store) and serialize it back (when writing to the wire). Now we can write to the wire the serialized format as read from the storage directly.</p> </li> </ul> </div> </dd> </dl> </div> <div class="sect2"> <h3 id="_Data_migration_section"><a class="anchor" href="#_Data_migration_section"></a>1.1. Data Migration</h3> <div class="paragraph"> <p>The format in which data is persisted has changed in Infinispan 6.0, so this means that if you stored data using Infinispan 4.x or Infinispan 5.x, Infinispan 6.0 won&#8217;t be able to read it. The best way to upgrade persisted data from Infinispan 4.x/5.x to Infinispan 6.0 is to use the mechanisms explained in the <a href="#_Rolling_chapter">Rolling Upgrades section</a>. In other words, by starting a rolling upgrade, data stored in Infinispan 4.x/5.x can be migrated to a Infinispan 6.0 installation where persitence is configured with a different location for the data. The location configuration varies according to the specific details of each cache store.</p> </div> <div class="paragraph"> <p>Following sections describe the SPI and also discuss the SPI implementations that Infinispan ships out of the box.</p> </div> </div> <div class="sect2"> <h3 id="_api"><a class="anchor" href="#_api"></a>1.2. API</h3> <div class="paragraph"> <p>The following class diagram presents the main SPI interfaces of the persistence API:</p> </div> <div class="imageblock"> <div class="content"> <img src="images/Figure2_1_persistence_API.png" alt="Figure2 1 persistence API"> </div> </div> <div class="paragraph"> <p>Some notes about the classes:</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/commons/io/ByteBuffer.html">ByteBuffer</a> - abstracts the serialized form of an object</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/spi/MarshalledEntry.html">MarshalledEntry</a> - abstracts the information held within a persistent store corresponding to a key-value added to the cache. Provides method for reading this information both in serialized (<a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/commons/io/ByteBuffer.html">ByteBuffer</a>) and deserialized (Object) format. Normally data read from the store is kept in serialized format and lazily deserialized on demand, within the <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/spi/MarshalledEntry.html">MarshalledEntry</a> implementation</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/spi/CacheWriter.html">CacheWriter</a> and <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/spi/CacheLoader.html">CacheLoader</a> provide basic methods for reading and writing to a store</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/spi/AdvancedCacheLoader.html">AdvancedCacheLoader</a> and <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/spi/AdvancedCacheWriter.html">AdvancedCacheWriter</a> provide operations to manipulate the underlaying storage in bulk: parallel iteration and purging of expired entries, clear and size.</p> </li> </ul> </div> <div class="paragraph"> <p>A provider might choose to only implement a subset of these interfaces:</p> </div> <div class="ulist"> <ul> <li> <p>Not implementing the <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/spi/AdvancedCacheWriter.html">AdvancedCacheWriter</a> makes the given writer not usable for purging expired entries or clear</p> </li> <li> <p>Not implementing the <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/spi/AdvancedCacheWriter.html">AdvancedCacheLoader</a> makes the information stored in the given loader not used for preloading, nor for the map/reduce iteration</p> </li> </ul> </div> <div class="paragraph"> <p>If you&#8217;re looking at migrating your existing store to the new API or to write a new store implementation, the <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/persistence/file/SingleFileStore.java">SingleFileStore</a> might be a good starting point/example.</p> </div> </div> <div class="sect2"> <h3 id="_configuration"><a class="anchor" href="#_configuration"></a>1.3. Configuration</h3> <div class="paragraph"> <p>Stores (readers and/or writers) can be configured in a chain. Cache read operation looks at all of the specified <code>CacheLoader</code> s, in the order they are configured, until it finds a valid and non-null element of data. When performing writes all cache <code>CacheWriter</code> s are written to, except if the <code>ignoreModifications</code> element has been set to true for a specific cache writer.</p> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="icon-important" title="Important"></i> </td> <td class="content"> <div class="title">Implementing both a CacheWriter and CacheLoader</div> it is possible and recommended for a store provider to implement both the <code>CacheWriter</code> and the <code>CacheLoader</code> interface. The stores that do this are considered both for reading and writing(assuming <code>read-only=false</code>) data. </td> </tr> </table> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml">This is the configuration of a custom(not shipped with infinispan) store:
   <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCustomStore</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;store</span>
            <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.acme.CustomStore</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">singleton</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

            <span class="tag">&lt;write-behind</span> <span class="attribute-name">flush-lock-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">12321</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">modification-queue-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shutdown-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">321</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">thread-pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">23</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${system.property}<span class="tag">&lt;/property&gt;</span>
         <span class="tag">&lt;/store&gt;</span>
      <span class="tag">&lt;/persistence&gt;</span>
   <span class="tag">&lt;/local-cache&gt;</span>
</code></pre> </div> </div> <div class="paragraph"> <p>Explanation of the configuration options:</p> </div> <div class="ulist"> <ul> <li> <p><code>passivation</code> (false by default) has a significant impact on how Infinispan interacts with the loaders, and is discussed in the <a href="#cache-passivation">Cache Passivation</a> section.</p> </li> <li> <p><code>class</code> defines the class of the store and must implement CacheLoader, CacheWriter or both</p> </li> <li> <p><code>fetch-state</code> (false by default) determines whether or not to fetch the persistent state of a cache when joining a cluster. The aim here is to take the persistent state of a cache and apply it to the local cache store of the joining node. Fetch persistent state is ignored if a cache store is configured to be shared, since they access the same data. Only one configured cache loader may set this property to true; if more than one cache loader does so, a configuration exception will be thrown when starting your cache service.</p> </li> <li> <p><code>preload</code> (false by default) if true, when the cache starts, data stored in the cache loader will be pre-loaded into memory. This is particularly useful when data in the cache loader is needed immediately after startup and you want to avoid cache operations being delayed as a result of loading this data lazily. Can be used to provide a <em>warm-cache</em> on startup, however there is a performance penalty as startup time is affected by this process. Note that preloading is done in a local fashion, so any data loaded is only stored locally in the node. No replication or distribution of the preloaded data happens. Also, Infinispan only preloads up to the maximum configured number of entries in <a href="#eviction_anchor">eviction</a>.</p> </li> <li> <p><code>shared</code> (false by default) indicates that the cache loader is shared among different cache instances, for example where all instances in a cluster use the same JDBC settings to talk to the same remote, shared database. Setting this to true prevents repeated and unnecessary writes of the same data to the cache loader by different cache instances.</p> </li> <li> <p><code>purge</code> (false by default) empties the specified cache loader (if <code>read-only</code> is false) when the cache loader starts up.</p> </li> <li> <p><code>read-only</code> (false by default) prevents new data to be persisted to the store.</p> </li> <li> <p><code>write-behind</code> (disabled by default) element has to do with a persisting data asynchronously to the actual store. It is discussed in detail <a href="#_write_behind_asynchronous">here</a>.</p> </li> <li> <p><code>singleton</code> (disabled by default) attribute enables modifications to be stored by only one node in the cluster, the coordinator. Essentially, whenever any data comes in to some node it is always replicated(or distributed) so as to keep the caches in-memory states in sync; the coordinator, though, has the sole responsibility of pushing that state to disk. This functionality must be configured by setting the enabled attribute to true in all nodes. Only the coordinator of the cluster will persist data, but all nodes must have this configured to prevent others from persisting as well. You cannot configure a store as shared and singleton.</p> </li> <li> <p>additional attributes can be configures within the <code>properties</code> section. These attributes configure aspects specific to each cache loader, e.g. the <code>myProp</code> attribute in the previous example. Other loaders, with more complex configuration, also introduce additional sub-elements to the basic configuration. See for example the JDBC cache store configuration examples below</p> </li> </ul> </div> <div class="paragraph"> <p>The configuration above is used for a generic store implementation. However the store implementation provided by default with Infinispan have a more rich configuration schema, in which the <code>properties</code> section is replaced with XML attributes:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="comment">&lt;!-- note that class is missing and is induced by the fileStore element name --&gt;</span>
   <span class="tag">&lt;file-store</span>
           <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;write-behind</span> <span class="attribute-name">flush-lock-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">15000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">thread-pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span>
</code></pre> </div> </div> <div class="paragraph"> <p>The same configuration can be achieved programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">   ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
   builder.persistence()
         .passivation(<span class="predefined-constant">false</span>)
         .addSingleFileStore()
            .preload(<span class="predefined-constant">true</span>)
            .shared(<span class="predefined-constant">false</span>)
            .fetchPersistentState(<span class="predefined-constant">true</span>)
            .ignoreModifications(<span class="predefined-constant">false</span>)
            .purgeOnStartup(<span class="predefined-constant">false</span>)
            .location(<span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">java.io.tmpdir</span><span class="delimiter">&quot;</span></span>))
            .async()
               .enabled(<span class="predefined-constant">true</span>)
               .threadPoolSize(<span class="integer">5</span>)
            .singleton()
               .enabled(<span class="predefined-constant">true</span>)
               .pushStateWhenCoordinator(<span class="predefined-constant">true</span>)
               .pushStateTimeout(<span class="integer">20000</span>);
</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="cache-passivation"><a class="anchor" href="#cache-passivation"></a>1.4. Cache Passivation</h3> <div class="paragraph"> <p>A CacheWriter can be used to enforce entry passivation and activation on eviction in a cache. Cache passivation is the process of removing an object from in-memory cache and writing it to a secondary data store (e.g., file system, database) on eviction. Cache activation is the process of restoring an object from the data store into the in-memory cache when it&#8217;s needed to be used. In order to fully support passivation, a store needs to be both a CacheWriter and a CacheLoader. In both cases, the configured cache store is used to read from the loader and write to the data writer.</p> </div> <div class="paragraph"> <p>When an eviction policy in effect evicts an entry from the cache, if passivation is enabled, a notification that the entry is being passivated will be emitted to the cache listeners and the entry will be stored. When a user attempts to retrieve a entry that was evicted earlier, the entry is (lazily) loaded from the cache loader into memory. When the entry and its children have been loaded, they&#8217;re removed from the cache loader and a notification is emitted to the cache listeners that the entry has been activated. In order to enable passivation just set passivation to true (false by default). When passivation is used, only the first cache loader configured is used and all others are ignored.</p> </div> <div class="sect3"> <h4 id="_cache_loader_behavior_with_passivation_disabled_vs_enabled"><a class="anchor" href="#_cache_loader_behavior_with_passivation_disabled_vs_enabled"></a>1.4.1. Cache Loader Behavior with Passivation Disabled vs Enabled</h4> <div class="paragraph"> <p>When passivation is disabled, whenever an element is modified, added or removed, then that modification is persisted in the backend store via the cache loader. There is no direct relationship between eviction and cache loading. If you don&#8217;t use eviction, what&#8217;s in the persistent store is basically a copy of what&#8217;s in memory. If you do use eviction, what&#8217;s in the persistent store is basically a superset of what&#8217;s in memory (i.e. it includes entries that have been evicted from memory). When passivation is enabled, there is a direct relationship between eviction and the cache loader. Writes to the persistent store via the cache loader only occur as part of the eviction process. Data is deleted from the persistent store when the application reads it back into memory. In this case, what&#8217;s in memory and what&#8217;s in the persistent store are two subsets of the total information set, with no intersection between the subsets.</p> </div> <div class="paragraph"> <p>The following is a simple example, showing what state is in RAM and in the persistent store after each step of a 6 step process:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Insert keyOne</p> </li> <li> <p>Insert keyTwo</p> </li> <li> <p>Eviction thread runs, evicts keyOne</p> </li> <li> <p>Read keyOne</p> </li> <li> <p>Eviction thread runs, evicts keyTwo</p> </li> <li> <p>Remove keyTwo</p> </li> </ol> </div> <div class="olist arabic"> <div class="title">When passivation is <em>disabled</em></div> <ol class="arabic"> <li> <p><strong>Memory:</strong> keyOne <strong>Disk:</strong> keyOne</p> </li> <li> <p><strong>Memory:</strong> keyOne, keyTwo <strong>Disk:</strong> keyOne, keyTwo</p> </li> <li> <p><strong>Memory:</strong> keyTwo <strong>Disk:</strong> keyOne, keyTwo</p> </li> <li> <p><strong>Memory:</strong> keyOne, keyTwo <strong>Disk:</strong> keyOne, keyTwo</p> </li> <li> <p><strong>Memory:</strong> keyOne <strong>Disk:</strong> keyOne, keyTwo</p> </li> <li> <p><strong>Memory:</strong> keyOne <strong>Disk:</strong> keyOne</p> </li> </ol> </div> <div class="olist arabic"> <div class="title">When passivation is <em>enabled</em></div> <ol class="arabic"> <li> <p><strong>Memory:</strong> keyOne <strong>Disk:</strong> (none)</p> </li> <li> <p><strong>Memory:</strong> keyOne, keyTwo <strong>Disk:</strong> (none)</p> </li> <li> <p><strong>Memory:</strong> keyTwo <strong>Disk:</strong> keyOne</p> </li> <li> <p><strong>Memory:</strong> keyOne, keyTwo <strong>Disk:</strong> (none)</p> </li> <li> <p><strong>Memory:</strong> keyOne <strong>Disk:</strong> keyTwo</p> </li> <li> <p><strong>Memory:</strong> keyOne <strong>Disk:</strong> (none)</p> </li> </ol> </div> </div> </div> <div class="sect2"> <h3 id="_cache_loaders_and_transactional_caches"><a class="anchor" href="#_cache_loaders_and_transactional_caches"></a>1.5. Cache Loaders and transactional caches</h3> <div class="paragraph"> <p>When a cache is transactional and a cache loader is present, the cache loader won&#8217;t be enlisted in the transaction in which the cache is part. That means that it is possible to have inconsistencies at cache loader level: the transaction to succeed applying the in-memory state but (partially) fail applying the changes to the store. Manual recovery would not work with caches stores.</p> </div> </div> <div class="sect2"> <h3 id="_write_through_and_write_behind_caching"><a class="anchor" href="#_write_through_and_write_behind_caching"></a>1.6. Write-Through And Write-Behind Caching</h3> <div class="paragraph"> <p>Infinispan can optionally be configured with one or several cache stores allowing it to store data in a persistent location such as shared JDBC database, a local filesystem, etc. Infinispan can handle updates to the cache store in two different ways:</p> </div> <div class="ulist"> <ul> <li> <p>Write-Through (Synchronous)</p> </li> <li> <p>Write-Behind (Asynchronous)</p> </li> </ul> </div> <div class="sect3"> <h4 id="_write_through_synchronous"><a class="anchor" href="#_write_through_synchronous"></a>1.6.1. Write-Through (Synchronous)</h4> <div class="paragraph"> <p>In this mode, which is supported in version 4.0, when clients update a cache entry, i.e. via a Cache.put() invocation, the call will not return until Infinispan has gone to the underlying cache store and has updated it. Normally, this means that updates to the cache store are done within the boundaries of the client thread.</p> </div> <div class="paragraph"> <p>The main advantage of this mode is that the cache store is updated at the same time as the cache, hence the cache store is consistent with the cache contents. On the other hand, using this mode reduces performance because the latency of having to access and update the cache store directly impacts the duration of the cache operation.</p> </div> <div class="paragraph"> <p>Configuring a write-through or synchronous cache store does not require any particular configuration option. By default, unless marked explicitly as write-behind or asynchronous, all cache stores are write-through or synchronous. Please find below a sample configuration file of a write-through unshared local file cache store:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;file-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/persistence&gt;</span>
</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="_write_behind_asynchronous"><a class="anchor" href="#_write_behind_asynchronous"></a>1.6.2. Write-Behind (Asynchronous)</h4> <div class="paragraph"> <p>In this mode, updates to the cache are asynchronously written to the cache store. Normally, this means that updates to the cache store are done by a separate thread to the client thread interacting with the cache.</p> </div> <div class="paragraph"> <p>One of the major advantages of this mode is that the performance of a cache operation does not get affected by the update of the underlying store. On the other hand, since the update happens asynchronously, there&#8217;s a time window during the which the cache store can contain stale data compared to the cache. Even within write-behind, there are different strategies that can be used to store data:</p> </div> <div class="sect4"> <h5 id="_unscheduled_write_behind_strategy"><a class="anchor" href="#_unscheduled_write_behind_strategy"></a>Unscheduled Write-Behind Strategy</h5> <div class="paragraph"> <p>In this mode, which is supported in version 4.0, Infinispan tries to store changes as quickly as possible by taking the pending changes and applying them in parallel. Normally, this means that there are several threads waiting for modifications to occur and once they&#8217;re available, they apply them to underlying cache store.</p> </div> <div class="paragraph"> <p>This strategy is suited for cache stores with low latency and cheap operation cost. One such example would a local unshared file based cache store, where the cache store is local to the cache itself. With this strategy, the window of inconsistency between the contents of the cache and the cache store are reduced to the lowest possible time. Please find below a sample configuration file of this strategy:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;file-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="comment">&lt;!-- write behind configuration starts here --&gt;</span>
   <span class="tag">&lt;write-behind</span> <span class="tag">/&gt;</span>
   <span class="comment">&lt;!-- write behind configuration ends here --&gt;</span>
   <span class="tag">&lt;/file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> </div> <div class="sect4"> <h5 id="_scheduled_write_behind_strategy"><a class="anchor" href="#_scheduled_write_behind_strategy"></a>Scheduled Write-Behind Strategy</h5> <div class="paragraph"> <p>First of all, please note that this strategy is not included in version 4.0 but it will be implemented at a later stage. <a href="https://jira.jboss.org/jira/browse/ISPN-328">ISPN-328</a> has been created to track this feature request. If you want it implemented, please <a href="https://jira.jboss.org/jira/secure/ViewIssue.jspa?id=12402022&amp;vote=true">vote for it</a> and don&#8217;t forget to <a href="https://jira.jboss.org/jira/secure/ViewIssue.jspa?id=12402022&amp;watch=true">watch it</a> to be notified of any changes. The following explanation refers to how we envision it to work.</p> </div> <div class="paragraph"> <p>In this mode, Infinispan would periodically store changes to the underlying cache store. The periodicity could be defined in seconds, minutes, days, etc.</p> </div> <div class="paragraph"> <p>Since this strategy is oriented at cache stores with high latency or expensive operation cost, it makes sense to coalesce changes, so that if there are multiple operations queued on the same key, only the latest value is applied to cache store. With this strategy, the window of inconsistency between the contents of the cache and the cache store depends on the delay or periodicity configured. The higher the periodicity, the higher the chance of inconsistency.</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="_filesystem_based_cache_stores"><a class="anchor" href="#_filesystem_based_cache_stores"></a>1.7. Filesystem based cache stores</h3> <div class="paragraph"> <p>A filesystem-based cache store is typically used when you want to have a cache with a cache store available locally which stores data that has overflowed from memory, having exceeded size and/or time restrictions.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="icon-warning" title="Warning"></i> </td> <td class="content"> Usage of filesystem-based cache stores on shared filesystems like NFS, Windows shares, etc. should be avoided as these do not implement proper file locking and can cause data corruption. File systems are inherently not transactional, so when attempting to use your cache in a transactional context, failures when writing to the file (which happens during the commit phase) cannot be recovered. </td> </tr> </table> </div> <div class="sect3"> <h4 id="_single_file_store"><a class="anchor" href="#_single_file_store"></a>1.7.1. Single File Store</h4> <div class="paragraph"> <p>Starting with Infinispan 6.0, a new file cache store has been created called single file cache store. The old pre-6.0 file cache store has been completely removed, and it&#8217;s no longer configurable.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> Check <a href="#_Data_migration_section">Data Migration section</a> for information on how to migrate old file based cache store data to the new single file cache store. </td> </tr> </table> </div> <div class="paragraph"> <p>The new single file cache store keeps all data in a single file. The way it looks up data is by keeping an in-memory index of keys and the positions of their values in this file. This results in greater performance compared to old file cache store. There is one caveat though. Since the single file based cache store keeps keys in memory, it can lead to increased memory consumption, and hence it&#8217;s not recommended for caches with big keys.</p> </div> <div class="paragraph"> <p>In certain use cases, this cache store suffers from fragmentation: if you store larger and larger values, the space is not reused and instead the entry is appended at the end of the file. The space (now empty) is reused only if you write another entry that can fit there. Also, when you remove all entries from the cache, the file won&#8217;t shrink, and neither will be de-fragmented.</p> </div> <div class="paragraph"> <p>These are the available configuration options for the single file cache store:</p> </div> <div class="ulist"> <ul> <li> <p><code>path</code> where data will be stored. (e.g., <code>path="/tmp/myDataStore"</code>). By default, the location is <code>Infinispan-SingleFileStore</code>.</p> </li> <li> <p><code>max-entries</code> specifies the maximum number of entries to keep in this file store. As mentioned before, in order to speed up lookups, the single file cache store keeps an index of keys and their corresponding position in the file. To avoid this index resulting in memory consumption problems, this cache store can bounded by a maximum number of entries that it stores. If this limit is exceeded, entries are removed permanently using the LRU algorithm both from the in-memory index and the underlying file based cache store. So, setting a maximum limit only makes sense when Infinispan is used as a cache, whose contents can be recomputed or they can be retrieved from the authoritative data store. If this maximum limit is set when the Infinispan is used as an authoritative data store, it could lead to data loss, and hence it&#8217;s not recommended for this use case. The default value is <code>-1</code> which means that the file store size is unlimited.</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml">
<span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;file-store</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/myDataStore</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addSingleFileStore()
    .location(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/myDataStore</span><span class="delimiter">&quot;</span></span>)
    .maxEntries(<span class="integer">5000</span>);
</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="_soft_index_file_store"><a class="anchor" href="#_soft_index_file_store"></a>1.7.2. Soft-Index File Store</h4> <div class="paragraph"> <p>In Infinispan 7.0 we have added a new experimental local file-based cache store - Soft-Index File Store. It is a pure Java implementation that tries to get around Single File Store&#8217;s drawbacks by implementing a variant of B+ tree that is cached in-memory using Java&#8217;s soft references - here&#8217;s where the name Soft-Index File Store comes from. This B+ tree (called Index) is offloaded on filesystem to single file that does not need to be persisted - it is purged and rebuilt when the cache store restarts, its purpose is only offloading.</p> </div> <div class="paragraph"> <p>The data that should be persisted are stored in a set of files that are written in append-only way - that means that if you store this on conventional magnetic disk, it does not have to seek when writing a burst of entries. It is not stored in single file but set of files. When the usage of any of these files drops below 50% (the entries from the file are overwritten to another file), the file starts to be collected, moving the live entries into different file and in the end removing that file from disk.</p> </div> <div class="paragraph"> <p>Most of the structures in Soft Index File Store are bounded, therefore you don&#8217;t have to be afraid of OOMEs. For example, you can configure the limits for concurrently open files as well.</p> </div> <div class="sect4"> <h5 id="_configuration_2"><a class="anchor" href="#_configuration_2"></a>Configuration</h5> <div class="paragraph"> <p>Here is an example of Soft-Index File Store configuration via XML:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;persistence&gt;</span>
    <span class="tag">&lt;soft-index-file-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:soft-index:7.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;index</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/index</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;data</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/data</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/soft-index-file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Programmatic configuration would look as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addStore(SoftIndexFileStoreConfigurationBuilder.class)
        .indexLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/index</span><span class="delimiter">&quot;</span></span>);
        .dataLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/data</span><span class="delimiter">&quot;</span></span>)</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="_current_limitations"><a class="anchor" href="#_current_limitations"></a>Current limitations</h5> <div class="paragraph"> <p>Size of a node in the Index is limited, by default it is 4096 bytes, though it can be configured. This size also limits the key length (or rather the length of the serialized form): you can&#8217;t use keys longer than size of the node - 15 bytes. Moreover, the key length is stored as <em>short</em>, limiting it to 32767 bytes. There&#8217;s no way how you can use longer keys - SIFS throws an exception when the key is longer after serialization.</p> </div> <div class="paragraph"> <p>When entries are stored with expiration, SIFS cannot detect that some of those entries are expired. Therefore, such old file will not be compacted (method AdvancedStore.purgeExpired() is not implemented). This can lead to excessive file-system space usage.</p> </div> <hr> <div class="paragraph"> <p>For detailed description of all the parameters supported by the stores, please consult the <a href="http://docs.jboss.org/infinispan/7.1/apidocs/">javadoc</a>.</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="_jdbc_based_cache_loaders"><a class="anchor" href="#_jdbc_based_cache_loaders"></a>1.8. JDBC based cache loaders</h3> <div class="paragraph"> <p>Based on the type of keys to be persisted, there are three JDBC cache loaders:</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/binary/JdbcBinaryStore.html">JdbcBinaryStore</a> - can store any type of keys. It stores all the keys that have the same hash value (hashCode method on key) in the same table row/blob, having as primary key the hash value. While this offers great flexibility (can store any key type), it impacts concurrency/throughput. E.g. If storing k1,k2 and k3 keys, and keys had same hash code, then they&#8217;d persisted in the same table row. Now, if 3 threads try to concurrently update k1, k2 and k3 respectively, they would need to do it sequentially since these threads would be updating the same row.</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a> - stores each key in its own row, increasing throughput under concurrent load. In order to store each key in its own column, it relies on a (pluggable) bijection that maps the each key to a String object. The bijection is defined by the Key2StringMapper interface. Infinispans ships a default implementation (smartly named <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/keymappers/DefaultTwoWayKey2StringMapper.html">DefaultTwoWayKey2StringMapper</a> ) that knows how to handle primitive types.</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/mixed/JdbcMixedStore.html">JdbcMixedStore</a> - it is a hybrid implementation that, based on the key type, delegates to either <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/binary/JdbcBinaryStore.html">JdbcBinaryStore</a> or <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a>.</p> </li> </ul> </div> <div class="sect3"> <h4 id="_which_jdbc_cache_loader_should_i_use"><a class="anchor" href="#_which_jdbc_cache_loader_should_i_use"></a>1.8.1. Which JDBC cache loader should I use?</h4> <div class="paragraph"> <p>It is generally preferable to use <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/loaders/jdbc/stringbased/JdbcStringBasedCacheStore.html">JdbcStringBasedCacheStore</a> when you are in control of the key types, as it offers better throughput under heavy load. One scenario in which it is not possible to use it though, is when you can&#8217;t write a <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/keymappers/Key2StringMapper.html">Key2StringMapper</a> to map the keys to to string objects (e.g. when you don&#8217;t have control over the types of the keys, for whatever reason). Then you should use either <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/binary/JdbcBinaryStore.html">JdbcBinaryStore</a> or <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/mixed/JdbcMixedStore.html">JdbcMixedStore</a> . The later is preferred to the former when the majority of the keys are handled by <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a> , but you still have some keys you cannot convert through <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/keymappers/DefaultTwoWayKey2StringMapper.html">DefaultTwoWayKey2StringMapper</a>.</p> </div> </div> <div class="sect3"> <h4 id="_connection_management_pooling"><a class="anchor" href="#_connection_management_pooling"></a>1.8.2. Connection management (pooling)</h4> <div class="paragraph"> <p>In order to obtain a connection to the database all the JDBC cache loaders rely on a <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/loaders/jdbc/connectionfactory/ConnectionFactory.html">ConnectionFactory</a> implementation. The connection factory is specified programmatically using one of the connectionPool(), dataSource() or simpleConnection() methods on the JdbcBinaryCacheStoreConfigurationBuilder class or declaratively using one of the <code>&lt;connectionPool /&gt;</code>, <code>&lt;dataSource /&gt;</code> or <code>&lt;simpleConnection /&gt;</code> elements. Infinispan ships with three ConnectionFactory implementations:</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/connectionfactory/PooledConnectionFactory.html">PooledConnectionFactory</a> is a factory based on <a href="http://sourceforge.net/projects/c3p0/">C3P0</a> . Refer to <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/connectionfactory/PooledConnectionFactory.html">javadoc</a> for details on configuring it.</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/connectionfactory/ManagedConnectionFactory.html">ManagedConnectionFactory</a> is a connection factory that can be used within managed environments, such as application servers. It knows how to look into the JNDI tree at a certain location (configurable) and delegate connection management to the DataSource. Refer to javadoc <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/connectionfactory/ManagedConnectionFactory.html">javadoc</a> for details on how this can be configured.</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/connectionfactory/SimpleConnectionFactory.html">SimpleConnectionFactory</a> is a factory implementation that will create database connection on a per invocation basis. Not recommended in production.</p> </li> </ul> </div> <div class="paragraph"> <p>The <code>PooledConnectionFactory</code> is generally recommended for stand-alone deployments (i.e. not running within AS or servlet container). <code>ManagedConnectionFactory</code> can be used when running in a managed environment where a <code>DataSource</code> is present, so that connection pooling is performed within the <code>DataSource</code>.</p> </div> </div> <div class="sect3"> <h4 id="_sample_configurations"><a class="anchor" href="#_sample_configurations"></a>1.8.3. Sample configurations</h4> <div class="paragraph"> <p>Below is a sample configuration for the <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/binary/JdbcBinaryStore.html">JdbcBinaryStore</a> . For detailed description of all the parameters used refer to the <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/binary/JdbcBinaryStore.html">JdbcBinaryStore</a> . Please note the use of multiple XML schemas, since each store has its own schema.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;binary-keyed-jdbc-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;simple-connection</span> <span class="attribute-name">connection-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_binary_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">driver</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;binary-keyed-table</span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_BUCKET_TABLE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/binary-keyed-table&gt;</span>
   <span class="tag">&lt;/binary-keyed-jdbc-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence()
      .addStore(JdbcBinaryStoreConfigurationBuilder.class)
         .fetchPersistentState(<span class="predefined-constant">false</span>)
         .ignoreModifications(<span class="predefined-constant">false</span>)
         .purgeOnStartup(<span class="predefined-constant">false</span>)
         .table()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_BUCKET_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
         .connectionPool()
            .connectionUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_binary_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span>)
            .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>)
            .driverClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span>);
</code></pre> </div> </div> <div class="paragraph"> <p>Below is a sample configuration for the <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a> . For detailed description of all the parameters used refer to the <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a> .</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;string-keyed-jdbc-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;connection-pool</span> <span class="attribute-name">connection-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_string_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">driver</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/string-keyed-table&gt;</span>
   <span class="tag">&lt;/string-keyed-jdbc-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence().addStore(JdbcStringBasedStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>)
      .ignoreModifications(<span class="predefined-constant">false</span>)
      .purgeOnStartup(<span class="predefined-constant">false</span>)
      .table()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
      .connectionPool()
         .connectionUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_binary_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span>)
         .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>)
         .driverClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span>);
</code></pre> </div> </div> <div class="paragraph"> <p>Below is a sample configuration for the <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/mixed/JdbcMixedStore.html">JdbcMixedStore</a> . For detailed description of all the parameters used refer to the <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/jdbc/mixed/JdbcMixedStore.html">JdbcMixedStore</a> .</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;mixed-keyed-jdbc-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;simple-connection</span> <span class="attribute-name">connection-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_binary_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">driver</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_MIXED_STR_TABLE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/string-keyed-table&gt;</span>
      <span class="tag">&lt;binary-keyed-table</span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_MIXED_BINARY_TABLE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/binary-keyed-table&gt;</span>
   <span class="tag">&lt;/mixed-keyed-jdbc-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence().addStore(JdbcMixedStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>).ignoreModifications(<span class="predefined-constant">false</span>).purgeOnStartup(<span class="predefined-constant">false</span>)
      .stringTable()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_MIXED_STR_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
      .binaryTable()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_MIXED_BINARY_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
      .connectionPool()
         .connectionUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_binary_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span>)
         .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>)
         .driverClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Finally, below is an example of a JDBC cache store with a managed connection factory, which is chosen implicitly by specifying a datasource JNDI location:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml">
<span class="tag">&lt;string-keyed-jdbc-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:jdbc:7.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;data-source</span> <span class="attribute-name">jndi-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/StringStoreWithManagedConnectionTest/DS</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/string-keyed-table&gt;</span>
<span class="tag">&lt;/string-keyed-jdbc-store&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence().addStore(JdbcStringBasedStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>).ignoreModifications(<span class="predefined-constant">false</span>).purgeOnStartup(<span class="predefined-constant">false</span>)
      .table()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
      .dataSource()
         .jndiUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/StringStoreWithManagedConnectionTest/DS</span><span class="delimiter">&quot;</span></span>);
</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Apache Derby users</div> If you&#8217;re connecting to an Apache Derby database, make sure you set dataColumnType to BLOB: <code>&lt;data-column name="DATA_COLUMN" type="BLOB"/&gt;</code> </td> </tr> </table> </div> </div> </div> <div class="sect2"> <h3 id="_remote_store"><a class="anchor" href="#_remote_store"></a>1.9. Remote store</h3> <div class="paragraph"> <p>The <code>RemoteStore</code> is a cache loader and writer implementation that stores data in a remote infinispan cluster. In order to communicate with the remote cluster, the <code>RemoteStore</code> uses the HotRod client/server architecture. HotRod bering the load balancing and fault tolerance of calls and the possibility to fine-tune the connection between the RemoteCacheStore and the actual cluster. Please refer to Hot Rod for more information on the protocol, client and server configuration. For a list of RemoteStore configuration refer to the <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/persistence/remote/configuration/RemoteStoreConfigurationBuilder.html">javadoc</a> . Example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;remote-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:remote:7.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">raw-values</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;remote-server</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">12111</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;remote-server</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">two</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;connection-pool</span> <span class="attribute-name">max-active</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exhausted-action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE_NEW</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;write-behind</span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence().addStore(RemoteStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>)
      .ignoreModifications(<span class="predefined-constant">false</span>)
      .purgeOnStartup(<span class="predefined-constant">false</span>)
      .remoteCacheName(<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span>)
      .rawValues(<span class="predefined-constant">true</span>)
.addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>).port(<span class="integer">12111</span>)
      .addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">two</span><span class="delimiter">&quot;</span></span>)
      .connectionPool()
      .maxActive(<span class="integer">10</span>)
      .exhaustedAction(ExhaustedAction.CREATE_NEW)
      .async().enable();
</code></pre> </div> </div> <div class="paragraph"> <p>In this sample configuration, the remote cache store is configured to use the remote cache named "mycache" on servers "one" and "two". It also configures connection pooling and provides a custom transport executor. Additionally the cache store is asynchronous.</p> </div> </div> <div class="sect2"> <h3 id="_cluster_cache_loader"><a class="anchor" href="#_cluster_cache_loader"></a>1.10. Cluster cache loader</h3> <div class="paragraph"> <p>The ClusterCacheLoader is a cache loader implementation that retrieves data from other cluster members.</p> </div> <div class="paragraph"> <p>It is a cache loader only as it doesn&#8217;t persist anything (it is not a Store), therefore features like <em>fetchPersistentState</em> (and like) are not applicable.</p> </div> <div class="paragraph"> <p>A cluster cache loader can be used as a non-blocking (partial) alternative to <em>stateTransfer</em> : keys not already available in the local node are fetched on-demand from other nodes in the cluster. This is a kind of lazy-loading of the cache content.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml">
<span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;cluster-loader</span> <span class="attribute-name">remote-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addClusterLoader()
    .remoteCallTimeout(<span class="integer">500</span>);
</code></pre> </div> </div> <div class="paragraph"> <p>For a list of ClusterCacheLoader configuration refer to the <a href="http://docs.jboss.org/infinispan/7.1/apidocs/org/infinispan/configuration/cache/ClusterLoaderConfiguration.html">javadoc</a> .</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> The ClusterCacheLoader does not support preloading(preload=true). It also won&#8217;t provide state if fetchPersistentSate=true. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="_command_line_interface_cache_loader"><a class="anchor" href="#_command_line_interface_cache_loader"></a>1.11. Command-Line Interface cache loader</h3> <div class="paragraph"> <p>The Command-Line Interface (CLI) cache loader is a cache loader implementation that retrieves data from another Infinispan node using the CLI. The node to which the CLI connects to could be a standalone node, or could be a node that it&#8217;s part of a cluster. This cache loader is read-only, so it will only be used to retrieve data, and hence, won&#8217;t be used when persisting data.</p> </div> <div class="paragraph"> <p>The CLI cache loader is configured with a connection URL pointing to the Infinispan node to which connect to. Here is an example:</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> Details on the format of the URL and how to make sure a node can receive invocations via the CLI can be found in the <a href="#_CLI_chapter">Command-Line Interface chapter</a>. </td> </tr> </table> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="xml language-xml">
<span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;cli-loader</span> <span class="attribute-name">connection</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jmx://1.2.3.4:4444/MyCacheManager/myCache</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span>
</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addStore(CLInterfaceLoaderConfigurationBuilder.class)
    .connectionString(<span class="string"><span class="delimiter">&quot;</span><span class="content">jmx://1.2.3.4:4444/MyCacheManager/myCache</span><span class="delimiter">&quot;</span></span>);
</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="_more_implementations"><a class="anchor" href="#_more_implementations"></a>1.12. More implementations</h3> <div class="paragraph"> <p>Many more cache loader and cache store implementations exist. Visit <a href="http://infinispan.org/cache-store-implementations">this website</a> for more details.</p> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2015-01-23 11:43:26 CET </div> </div> </body> </html>