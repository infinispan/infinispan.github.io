<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="generator" content="Asciidoctor 2.0.10"> <title>Administration Guide for Infinispan 10.1</title> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"> <style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> <link rel="canonical" href="http://infinispan.org/docs/stable/user_guide/user_guide.html"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css"> <link rel="stylesheet" href="../../css/css.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script> <script src="../../js/js.js"></script> </head> <body class="book toc2 toc-left"> <div id="header"> <h1>Administration Guide for Infinispan 10.1</h1> <div id="toc" class="toc2"> <div id="toctitle">Table of Contents</div> <ul class="sectlevel1"> <li><a href="#partition_handling">1. Setting Up Partition Handling</a> <ul class="sectlevel2"> <li><a href="#partition_handling-admin">1.1. Partition handling</a> <ul class="sectlevel3"> <li><a href="#split_brain">1.1.1. Split brain</a> <ul class="sectlevel4"> <li><a href="#split_strategies">Split Strategies</a> <ul class="sectlevel5"> <li><a href="#allow_read_writes">ALLOW_READ_WRITES</a></li> <li><a href="#deny_read_writes">DENY_READ_WRITES</a></li> <li><a href="#allow_reads">ALLOW_READS</a></li> </ul> </li> <li><a href="#current_limitations">Current limitations</a></li> </ul> </li> <li><a href="#successive_node_failures">1.1.2. Successive nodes stopped</a></li> <li><a href="#conflict_manager">1.1.3. Conflict Manager</a> <ul class="sectlevel4"> <li><a href="#detecting_conflicts">Detecting Conflicts</a></li> <li><a href="#merge_policies">Merge Policies</a></li> </ul> </li> <li><a href="#conflict_manager_usage">1.1.4. Usage</a></li> <li><a href="#partition_handling_configuration">1.1.5. Configuring partition handling</a> <ul class="sectlevel4"> <li><a href="#partition_handling_custom_merge_policy">Implement a custom merge policy</a></li> <li><a href="#deploy_custom_merge_policies_to_a_infinispan_server_instance">Deploy custom merge policies to a Infinispan server instance</a></li> </ul> </li> <li><a href="#partition_handling_monitoring">1.1.6. Monitoring and administration</a></li> </ul> </li> </ul> </li> <li><a href="#extending">2. Extending Infinispan</a> <ul class="sectlevel2"> <li><a href="#custom_commands">2.1. Custom Commands</a> <ul class="sectlevel3"> <li><a href="#an_example">2.1.1. An Example</a></li> <li><a href="#preassigned_custom_command_id_ranges">2.1.2. Preassigned Custom Command Id Ranges</a></li> </ul> </li> <li><a href="#extending_the_configuration_builders_and_parsers">2.2. Extending the configuration builders and parsers</a></li> </ul> </li> <li><a href="#custom_interceptors_chapter">3. Custom Interceptors</a> <ul class="sectlevel2"> <li><a href="#adding_custom_interceptors_declaratively">3.1. Adding custom interceptors declaratively</a></li> <li><a href="#adding_custom_interceptors_programatically">3.2. Adding custom interceptors programatically</a></li> <li><a href="#custom_interceptor_design">3.3. Custom interceptor design</a></li> </ul> </li> <li><a href="#rolling_up_k8s">4. Rolling Upgrades and Updates with Kubernetes and OpenShift</a> <ul class="sectlevel2"> <li><a href="#performing_rolling_updates_on_kubernetes">4.1. Performing Rolling Updates on Kubernetes</a></li> <li><a href="#performing_rolling_upgrades_on_kubernetes">4.2. Performing Rolling Upgrades on Kubernetes</a></li> </ul> </li> </ul> </div> </div> <div id="content"> <div class="sect1"> <h2 id="partition_handling"><a class="anchor" href="#partition_handling"></a>1. Setting Up Partition Handling</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="partition_handling-admin"><a class="anchor" href="#partition_handling-admin"></a>1.1. Partition handling</h3> <div class="paragraph"> <p>An Infinispan cluster is built out of a number of nodes where data is stored. In order not to lose data in the presence of node failures, Infinispan copies the same data&#8201;&#8212;&#8201;cache entry in Infinispan parlance&#8201;&#8212;&#8201;over multiple nodes. This level of data redundancy is configured through the <code>numOwners</code> configuration attribute and ensures that as long as fewer than <code>numOwners</code> nodes crash simultaneously, Infinispan has a copy of the data available.</p> </div> <div class="paragraph"> <p>However, there might be catastrophic situations in which more than <code>numOwners</code> nodes disappear from the cluster:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">Split brain</dt> <dd> <p>Caused e.g. by a router crash, this splits the cluster in two or more partitions, or sub-clusters that operate independently. In these circumstances, multiple clients reading/writing from different partitions see different versions of the same cache entry, which for many application is problematic. Note there are ways to alleviate the possibility for the split brain to happen, such as redundant networks or <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/s2-networkscripts-interfaces-chan.html">IP bonding</a>. These only reduce the window of time for the problem to occur, though.</p> </dd> <dt class="hdlist1"><code>numOwners</code> nodes crash in sequence</dt> <dd> <p>When at least <code>numOwners</code> nodes crash in rapid succession and Infinispan does not have the time to properly rebalance its state between crashes, the result is partial data loss.</p> </dd> </dl> </div> <div class="paragraph"> <p>The partition handling functionality discussed in this section allows the user to configure what operations can be performed on a cache in the event of a split brain occurring. Infinispan provides multiple partition handling strategies, which in terms of Brewer&#8217;s <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a> determine whether availability or consistency is sacrificed in the presence of partition(s). Below is a list of the provided strategies:</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Strategy</th> <th class="tableblock halign-left valign-top">Description</th> <th class="tableblock halign-left valign-top">CAP</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">DENY_READ_WRITES</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If the partition does not have all owners for a given segment, both reads and writes are denied for all keys in that segment.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Consistency</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">ALLOW_READS</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Allows reads for a given key if it exists in this partition, but only allows writes if this partition contains all owners of a segment. This is still a consistent approach because some entries are readable if available in this partition, but from a client application perspective it is not deterministic.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Consistency</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">ALLOW_READ_WRITES</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Allow entries on each partition to diverge, with conflict resolution attempted upon the partitions merging.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Availability</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>The requirements of your application should determine which strategy is appropriate. For example, DENY_READ_WRITES is more appropriate for applications that have high consistency requirements; i.e. when the data read from the system must be accurate. Whereas if Infinispan is used as a best-effort cache, partitions maybe perfectly tolerable and the ALLOW_READ_WRITES might be more appropriate as it favours availability over consistency.</p> </div> <div class="paragraph"> <p>The following sections describe how Infinispan handles <a href="#split_brain">split brain</a> and <a href="#successive_node_failures">successive failures</a> for each of the partition handling strategies. This is followed by a section describing how Infinispan allows for automatic conflict resolution upon partition merges via <a href="#merge_policies">merge policies</a>. Finally, we provide a section describing <a href="#partition_handling_configuration">how to configure partition handling strategies and merge policies</a>.</p> </div> <div class="sect3"> <h4 id="split_brain"><a class="anchor" href="#split_brain"></a>1.1.1. Split brain</h4> <div class="paragraph"> <p>In a split brain situation, each network partition will install its own JGroups view, removing the nodes from the other partition(s). We don&#8217;t have a direct way of determining whether the has been split into two or more partitions, since the partitions are unaware of each other. Instead, we assume the cluster has split when one or more nodes disappear from the JGroups cluster without sending an explicit leave message.</p> </div> <div class="sect4"> <h5 id="split_strategies"><a class="anchor" href="#split_strategies"></a>Split Strategies</h5> <div class="paragraph"> <p>In this section, we detail how each partition handling strategy behaves in the event of split brain occurring.</p> </div> <div class="sect5"> <h6 id="allow_read_writes"><a class="anchor" href="#allow_read_writes"></a>ALLOW_READ_WRITES</h6> <div class="paragraph"> <p>Each partition continues to function as an independent cluster, with all partitions remaining in AVAILABLE mode. This means that each partition may only see a part of the data, and each partition could write conflicting updates in the cache. During a partition merge these conflicts are automatically resolved by utilising the <a href="#conflict_manager">ConflictManager</a> and the configured <a href="#merge_policies">EntryMergePolicy</a>.</p> </div> </div> <div class="sect5"> <h6 id="deny_read_writes"><a class="anchor" href="#deny_read_writes"></a>DENY_READ_WRITES</h6> <div class="paragraph"> <p>When a split is detected each partition does not start a rebalance immediately, but first it checks whether it should enter <strong>DEGRADED</strong> mode instead:</p> </div> <div class="ulist"> <ul> <li> <p>If at least one segment has lost all its owners (meaning at least <em>numOwners</em> nodes left since the last rebalance ended), the partition enters DEGRADED mode.</p> </li> <li> <p>If the partition does not contain a simple majority of the nodes (floor(numNodes/2) + 1) in the <em>latest stable topology</em>, the partition also enters DEGRADED mode.</p> </li> <li> <p>Otherwise the partition keeps functioning normally, and it starts a rebalance.</p> </li> </ul> </div> <div class="paragraph"> <p>The <em>stable topology</em> is updated every time a rebalance operation ends and the coordinator determines that another rebalance is not necessary.</p> </div> <div class="paragraph"> <p>These rules ensures that at most one partition stays in AVAILABLE mode, and the other partitions enter DEGRADED mode.</p> </div> <div class="paragraph"> <p>When a partition is in DEGRADED mode, it only allows access to the keys that are wholly owned:</p> </div> <div class="ulist"> <ul> <li> <p>Requests (reads and writes) for entries that have all the copies on nodes within this partition are honoured.</p> </li> <li> <p>Requests for entries that are partially or totally owned by nodes that disappeared are rejected with an <code>AvailabilityException</code>.</p> </li> </ul> </div> <div class="paragraph"> <p>This guarantees that partitions cannot write different values for the same key (cache is consistent), and also that one partition can not read keys that have been updated in the other partitions (no stale data).</p> </div> <div class="paragraph"> <p>To exemplify, consider the initial cluster <code>M = {A, B, C, D}</code>, configured in distributed mode with <code>numOwners = 2</code>. Further on, consider three keys <code>k1</code>, <code>k2</code> and <code>k3</code> (that might exist in the cache or not) such that <code>owners(k1) = {A,B}</code>, <code>owners(k2) = {B,C}</code> and <code>owners(k3) = {C,D}</code>. Then the network splits in two partitions, <code>N1 = {A, B}</code> and <code>N2 = {C, D}</code>, they enter DEGRADED mode and behave like this:</p> </div> <div class="ulist"> <ul> <li> <p>on <code>N1</code>, <code>k1</code> is available for read/write, <code>k2</code> (partially owned) and <code>k3</code> (not owned) are not available and accessing them results in an <code>AvailabilityException</code></p> </li> <li> <p>on <code>N2</code>, <code>k1</code> and <code>k2</code> are not available for read/write, <code>k3</code> is available</p> </li> </ul> </div> <div class="paragraph"> <p>A relevant aspect of the partition handling process is the fact that when a split brain happens, the resulting partitions rely on the original segment mapping (the one that existed before the split brain) in order to calculate key ownership. So it doesn&#8217;t matter if <code>k1</code>, <code>k2</code>, or <code>k3</code> already existed cache or not, their availability is the same.</p> </div> <div class="paragraph"> <p>If at a further point in time the network heals and <code>N1</code> and <code>N2</code> partitions merge back together into the initial cluster <code>M</code>, then <code>M</code> exits the degraded mode and becomes fully available again. During this merge operation, because <code>M</code> has once again become fully available, the <a href="#conflict_manager">ConflictManager</a> and the configured <a href="#merge_policies">EntryMergePolicy</a> are used to check for any conflicts that may have occurred in the interim period between the split brain occurring and being detected.</p> </div> <div class="paragraph"> <p>As another example, the cluster could split in two partitions <code>O1 = {A, B, C}</code> and <code>O2 = {D}</code>, partition <code>O1</code> will stay fully available (rebalancing cache entries on the remaining members). Partition <code>O2</code>, however, will detect a split and enter the degraded mode. Since it doesn&#8217;t have any fully owned keys, it will reject any read or write operation with an <code>AvailabilityException</code>.</p> </div> <div class="paragraph"> <p>If afterwards partitions <code>O1</code> and <code>O2</code> merge back into <code>M</code>, then the <a href="#conflict_manager">ConflictManager</a> attempts to resolve any conflicts and <code>D</code> once again becomes fully available.</p> </div> </div> <div class="sect5"> <h6 id="allow_reads"><a class="anchor" href="#allow_reads"></a>ALLOW_READS</h6> <div class="paragraph"> <p>Partitions are handled in the same manner as DENY_READ_WRITES, except that when a partition is in DEGRADED mode read operations on a partially owned key WILL not throw an AvailabilityException.</p> </div> </div> </div> <div class="sect4"> <h5 id="current_limitations"><a class="anchor" href="#current_limitations"></a>Current limitations</h5> <div class="paragraph"> <p>Two partitions could start up isolated, and as long as they don&#8217;t merge they can read and write inconsistent data. In the future, we will allow custom availability strategies (e.g. check that a certain node is part of the cluster, or check that an external machine is accessible) that could handle that situation as well.</p> </div> </div> </div> <div class="sect3"> <h4 id="successive_node_failures"><a class="anchor" href="#successive_node_failures"></a>1.1.2. Successive nodes stopped</h4> <div class="paragraph"> <p>As mentioned in the previous section, Infinispan can&#8217;t detect whether a node left the JGroups view because of a process/machine crash, or because of a network failure: whenever a node leaves the JGroups cluster abruptly, it is assumed to be because of a network problem.</p> </div> <div class="paragraph"> <p>If the configured number of copies (<code>numOwners</code>) is greater than 1, the cluster can remain available and will try to make new replicas of the data on the crashed node. However, other nodes might crash during the rebalance process. If more than <code>numOwners</code> nodes crash in a short interval of time, there is a chance that some cache entries have disappeared from the cluster altogether. In this case, with the DENY_READ_WRITES or ALLOW_READS strategy enabled, Infinispan assumes (incorrectly) that there is a split brain and enters DEGRADED mode as described in the split-brain section.</p> </div> <div class="paragraph"> <p>The administrator can also shut down more than <code>numOwners</code> nodes in rapid succession, causing the loss of the data stored only on those nodes. When the administrator shuts down a node gracefully, Infinispan knows that the node can&#8217;t come back. However, the cluster doesn&#8217;t keep track of how each node left, and the cache still enters DEGRADED mode as if those nodes had crashed.</p> </div> <div class="paragraph"> <p>At this stage there is no way for the cluster to recover its state, except stopping it and repopulating it on restart with the data from an external source. Clusters are expected to be configured with an appropriate <code>numOwners</code> in order to avoid <code>numOwners</code> successive node failures, so this situation should be pretty rare. If the application can handle losing some of the data in the cache, the administrator can force the availability mode back to AVAILABLE via JMX.</p> </div> </div> <div class="sect3"> <h4 id="conflict_manager"><a class="anchor" href="#conflict_manager"></a>1.1.3. Conflict Manager</h4> <div class="paragraph"> <p>The conflict manager is a tool that allows users to retrieve all stored replica values for a given key. In addition to allowing users to process a stream of cache entries whose stored replicas have conflicting values. Furthermore, by utilising implementations of the <a href="#merge_policies">EntryMergePolicy</a> interface it is possible for said conflicts to be resolved automatically.</p> </div> <div class="sect4"> <h5 id="detecting_conflicts"><a class="anchor" href="#detecting_conflicts"></a>Detecting Conflicts</h5> <div class="paragraph"> <p>Conflicts are detected by retrieving each of the stored values for a given key. The conflict manager retrieves the value stored from each of the key&#8217;s write owners defined by the current consistent hash. The .equals method of the stored values is then used to determine whether all values are equal. If all values are equal then no conflicts exist for the key, otherwise a conflict has occurred. Note that null values are returned if no entry exists on a given node, therefore we deem a conflict to have occurred if both a null and non-null value exists for a given key.</p> </div> </div> <div class="sect4"> <h5 id="merge_policies"><a class="anchor" href="#merge_policies"></a>Merge Policies</h5> <div class="paragraph"> <p>In the event of conflicts arising between one or more replicas of a given CacheEntry, it is necessary for a conflict resolution algorithm to be defined, therefore we provide the <a href="https://docs.jboss.org/infinispan/10.1/apidocs/org/infinispan/conflict/EntryMergePolicy.html">EntryMergePolicy</a> interface. This interface consists of a single method, "merge", whose returned CacheEntry is utilised as the "resolved" entry for a given key. When a non-null CacheEntry is returned, this entries value is "put" to all replicas in the cache. However when the merge implementation returns a null value, all replicas associated with the conflicting key are removed from the cache.</p> </div> <div class="paragraph"> <p>The merge method takes two parameters: the "preferredEntry" and "otherEntries". In the context of a partition merge, the preferredEntry is the primary replica of a CacheEntry stored in the partition that contains the most nodes or if partitions are equal the one with the largest topologyId. In the event of overlapping partitions, i.e. a node A is present in the topology of both partitions {A}, {A,B,C}, we pick {A} as the preferred partition as it will have the higher topologId as the other partition&#8217;s topology is behind. When a partition merge is not occurring, the "preferredEntry" is simply the primary replica of the CacheEntry. The second parameter, "otherEntries" is simply a list of all other entries associated with the key for which a conflict was detected.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> EntryMergePolicy::merge is only called when a conflict has been detected, it is not called if all CacheEntrys are the same. </td> </tr> </table> </div> <div class="paragraph"> <p>Currently Infinispan provides the following implementations of EntryMergePolicy:</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Policy</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.NONE (default)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No attempt is made to resolve conflicts. Entries hosted on the minority partition are removed and the nodes in this partition do not hold any data until the rebalance starts. Note, this behaviour is equivalent to prior Infinispan versions which did not support conflict resolution. Note, in this case all changes made to entries hosted on the minority partition are lost, but once the rebalance has finished all entries will be consistent.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.PREFERRED_ALWAYS</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Always utilise the "preferredEntry". MergePolicy.NONE is almost equivalent to PREFERRED_ALWAYS, albeit without the performance impact of performing conflict resolution, therefore MergePolicy.NONE should be chosen unless the following scenario is a concern. When utilising the DENY_READ_WRITES or DENY_READ strategy, it is possible for a write operation to only partially complete when the partitions enter DEGRADED mode, resulting in replicas containing inconsistent values. MergePolicy.PREFERRED_ALWAYS will detect said inconsistency and resolve it, whereas with MergePolicy.NONE the CacheEntry replicas will remain inconsistent after the cluster has rebalanced.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.PREFERRED_NON_NULL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Utilise the "preferredEntry" if it is non-null, otherwise utilise the first entry from "otherEntries".</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.REMOVE_ALL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Always remove a key from the cache when a conflict is detected.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Fully qualified class name</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The custom implementation for merge will be used <a href="#partition_handling_custom_merge_policy">Custom merge policy</a></p></td> </tr> </tbody> </table> </div> </div> <div class="sect3"> <h4 id="conflict_manager_usage"><a class="anchor" href="#conflict_manager_usage"></a>1.1.4. Usage</h4> <div class="paragraph"> <p>During a partition merge the ConflictManager automatically attempts to resolve conflicts utilising the configured EntryMergePolicy, however it is also possible to manually search for/resolve conflicts as required by your application.</p> </div> <div class="paragraph"> <p>The code below shows how to retrieve an EmbeddedCacheManager&#8217;s ConflictManager, how to retrieve all versions of a given key and how to check for conflicts across a given cache.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">example-config.xml</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">testCache</span><span class="delimiter">&quot;</span></span>);
ConflictManager&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; crm = ConflictManagerFactory.get(cache.getAdvancedCache());

<span class="comment">// Get All Versions of Key</span>
<span class="predefined-type">Map</span>&lt;Address, InternalCacheValue&lt;<span class="predefined-type">String</span>&gt;&gt; versions = crm.getAllVersions(<span class="integer">1</span>);

<span class="comment">// Process conflicts stream and perform some operation on the cache</span>
Stream&lt;<span class="predefined-type">Map</span>&lt;Address, InternalCacheEntry&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;&gt;&gt; stream = crm.getConflicts();
stream.forEach(map -&gt; {
   CacheEntry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; entry = map.values().iterator().next();
   <span class="predefined-type">Object</span> conflictKey = entry.getKey();
   cache.remove(conflictKey);
});

<span class="comment">// Detect and then resolve conflicts using the configured EntryMergePolicy</span>
crm.resolveConflicts();

<span class="comment">// Detect and then resolve conflicts using the passed EntryMergePolicy instance</span>
crm.resolveConflicts((preferredEntry, otherEntries) -&gt; preferredEntry);</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Although the <code>ConflictManager::getConflicts</code> stream is processed per entry, the underlying spliterator is in fact lazily-loading cache entries on a per segment basis. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="partition_handling_configuration"><a class="anchor" href="#partition_handling_configuration"></a>1.1.5. Configuring partition handling</h4> <div class="paragraph"> <p>Unless the cache is distributed or replicated, partition handling configuration is ignored. The default partition handling strategy is ALLOW_READ_WRITES and the default EntryMergePolicy is MergePolicies::PREFERRED_ALWAYS.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">the-default-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;partition-handling</span> <span class="attribute-name">when-split</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALLOW_READ_WRITES</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">merge-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PREFERRED_NON_NULL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The same can be achieved programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder dcc = <span class="keyword">new</span> ConfigurationBuilder();
dcc.clustering().partitionHandling()
                    .whenSplit(PartitionHandling.ALLOW_READ_WRITES)
                    .mergePolicy(MergePolicies.PREFERRED_ALWAYS);</code></pre> </div> </div> <div class="sect4"> <h5 id="partition_handling_custom_merge_policy"><a class="anchor" href="#partition_handling_custom_merge_policy"></a>Implement a custom merge policy</h5> <div class="paragraph"> <p>It&#8217;s also possible to provide custom implementations of the EntryMergePolicy</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">the-default-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;partition-handling</span> <span class="attribute-name">when-split</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALLOW_READ_WRITES</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">merge-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.example.CustomMergePolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder dcc = <span class="keyword">new</span> ConfigurationBuilder();
dcc.clustering().partitionHandling()
                    .whenSplit(PartitionHandling.ALLOW_READ_WRITES)
                    .mergePolicy(<span class="keyword">new</span> CustomMergePolicy());</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomMergePolicy</span> <span class="directive">implements</span> EntryMergePolicy&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> CacheEntry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; merge(CacheEntry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; preferredEntry, <span class="predefined-type">List</span>&lt;CacheEntry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt; otherEntries) {
      <span class="comment">// decide which entry should be used</span>

      <span class="keyword">return</span> the_solved_CacheEntry;
   }</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="deploy_custom_merge_policies_to_a_infinispan_server_instance"><a class="anchor" href="#deploy_custom_merge_policies_to_a_infinispan_server_instance"></a>Deploy custom merge policies to a Infinispan server instance</h5> <div class="paragraph"> <p>To utilise a custom EntryMergePolicy implementation on the server, it&#8217;s necessary for the implementation class(es) to be deployed to the server. This is accomplished by utilising the java service-provider convention and packaging the class files in a jar which has a META-INF/services/org.infinispan.conflict.EntryMergePolicy file containing the fully qualified class name of the EntryMergePolicy implementation.</p> </div> <div class="listingblock"> <div class="content"> <pre># list all necessary implementations of EntryMergePolicy with the full qualified name
org.example.CustomMergePolicy</pre> </div> </div> <div class="paragraph"> <p>In order for a Custom merge policy to be utilised on the server, you should enable object storage, if your policies semantics require access to the stored Key/Value objects. This is because cache entries in the server may be stored in a marshalled format and the Key/Value objects returned to your policy would be instances of WrappedByteArray. However, if the custom policy only depends on the metadata associated with a cache entry, then object storage is not required and should be avoided (unless needed for other reasons) due to the additional performance cost of marshalling data per request. Finally, object storage is never required if one of the provided merge policies is used.</p> </div> </div> </div> <div class="sect3"> <h4 id="partition_handling_monitoring"><a class="anchor" href="#partition_handling_monitoring"></a>1.1.6. Monitoring and administration</h4> <div class="paragraph"> <p>The availability mode of a cache is exposed in JMX as an attribute in the <a href="https://docs.jboss.org/infinispan/10.1/apidocs/jmxComponents.html#Cache">Cache MBean</a>. The attribute is writable, allowing an administrator to forcefully migrate a cache from DEGRADED mode back to AVAILABLE (at the cost of consistency).</p> </div> <div class="paragraph"> <p>The availability mode is also accessible via the <a href="https://docs.jboss.org/infinispan/10.1/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> interface:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">AdvancedCache ac = cache.getAdvancedCache();

<span class="comment">// Read the availability</span>
<span class="type">boolean</span> available = ac.getAvailability() == AvailabilityMode.AVAILABLE;

<span class="comment">// Change the availability</span>
<span class="keyword">if</span> (!available) {
   ac.setAvailability(AvailabilityMode.AVAILABLE);
}</code></pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="extending"><a class="anchor" href="#extending"></a>2. Extending Infinispan</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan can be extended to provide the ability for an end user to add additional configurations, operations and components outside of the scope of the ones normally provided by Infinispan.</p> </div> <div class="sect2"> <h3 id="custom_commands"><a class="anchor" href="#custom_commands"></a>2.1. Custom Commands</h3> <div class="paragraph"> <p>Infinispan makes use of a <a href="http://en.wikipedia.org/wiki/Command_pattern">command/visitor pattern</a> to implement the various top-level methods you see on the public-facing API.</p> </div> <div class="paragraph"> <p>While the core commands - and their corresponding visitors - are hard-coded as a part of Infinispan&#8217;s core module, module authors can extend and enhance Infinispan by creating new custom commands.</p> </div> <div class="paragraph"> <p>As a module author (such as <a href="https://github.com/infinispan/infinispan/tree/master/query">infinispan-query</a>, etc.) you can define your own commands.</p> </div> <div class="paragraph"> <p>You do so by:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code> file and ensure this is packaged in your jar.</p> </li> <li> <p>Implementing <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandFactory.java"><code>ModuleCommandFactory</code></a>, <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandInitializer.java"><code>ModuleCommandInitializer</code></a> and <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandExtensions.java"><code>ModuleCommandExtensions</code></a></p> </li> <li> <p>Specifying the fully-qualified class name of the <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandExtensions.java"><code>ModuleCommandExtensions</code></a> implementation in <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code>.</p> </li> <li> <p>Implement your custom commands and visitors for these commands</p> </li> </ol> </div> <div class="sect3"> <h4 id="an_example"><a class="anchor" href="#an_example"></a>2.1.1. An Example</h4> <div class="paragraph"> <p>Here is an example of an <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code> file, configured accordingly:</p> </div> <div class="listingblock"> <div class="title">org.infinispan.commands.module.ModuleCommandExtensions</div> <div class="content"> <pre>org.infinispan.query.QueryModuleCommandExtensions</pre> </div> </div> <div class="paragraph"> <p>For a full, working example of a sample module that makes use of custom commands and visitors, check out <a href="https://github.com/infinispan/infinispan-sample-module">Infinispan Sample Module</a> .</p> </div> </div> <div class="sect3"> <h4 id="preassigned_custom_command_id_ranges"><a class="anchor" href="#preassigned_custom_command_id_ranges"></a>2.1.2. Preassigned Custom Command Id Ranges</h4> <div class="paragraph"> <p>This is the list of <code>Command</code> identifiers that are used by Infinispan based modules or frameworks. Infinispan users should avoid using ids within these ranges. (RANGES to be finalised yet!) Being this a single byte, ranges can&#8217;t be too large.</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Query:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">100 - 119</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Search:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">120 - 139</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hot Rod Server:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">140 - 141</p></td> </tr> </tbody> </table> </div> </div> <div class="sect2"> <h3 id="extending_the_configuration_builders_and_parsers"><a class="anchor" href="#extending_the_configuration_builders_and_parsers"></a>2.2. Extending the configuration builders and parsers</h3> <div class="paragraph"> <p>If your custom module requires configuration, it is possible to enhance Infinispan&#8217;s configuration builders and parsers. Look at the <a href="https://github.com/infinispan/infinispan/blob/master/core/src/test/java/org/infinispan/configuration/module">custom module tests</a> for a detail example on how to implement this.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="custom_interceptors_chapter"><a class="anchor" href="#custom_interceptors_chapter"></a>3. Custom Interceptors</h2> <div class="sectionbody"> <div class="paragraph"> <p>It is possible to add custom interceptors to Infinispan, both declaratively and programatically. Custom interceptors are a way of extending Infinispan by being able to influence or respond to any modifications to cache. Example of such modifications are: elements are added/removed/updated or transactions are committed. For a detailed list refer to <a href="{javadoc.root}/org/infinispan/interceptors/base/CommandInterceptor.html">CommandInterceptor</a> API.</p> </div> <div class="sect2"> <h3 id="adding_custom_interceptors_declaratively"><a class="anchor" href="#adding_custom_interceptors_declaratively"></a>3.1. Adding custom interceptors declaratively</h3> <div class="paragraph"> <p>Custom interceptors can be added on a per named cache basis. This is because each named cache have its own interceptor stack. Following xml snippet depicts the ways in which a custom interceptor can be added.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheWithCustomInterceptors</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="comment">&lt;!--
 Define custom interceptors. All custom interceptors need to extend org.jboss.cache.interceptors.base.CommandInterceptor
 --&gt;</span>
 <span class="tag">&lt;custom-interceptors&gt;</span>
 <span class="tag">&lt;interceptor</span> <span class="attribute-name">position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FIRST</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">attributeOne</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>value1<span class="tag">&lt;/property&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">attributeTwo</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>value2<span class="tag">&lt;/property&gt;</span>
 <span class="tag">&lt;/interceptor&gt;</span>
 <span class="tag">&lt;interceptor</span> <span class="attribute-name">position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LAST</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;interceptor</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;interceptor</span> <span class="attribute-name">before</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispanpan.interceptors.CallInterceptor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;interceptor</span> <span class="attribute-name">after</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispanpan.interceptors.CallInterceptor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;/custom-interceptors&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="adding_custom_interceptors_programatically"><a class="anchor" href="#adding_custom_interceptors_programatically"></a>3.2. Adding custom interceptors programatically</h3> <div class="paragraph"> <p>In order to do that one needs to obtain a reference to the <a href="https://docs.jboss.org/infinispan/10.1/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> . This can be done as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CacheManager cm = getCacheManager();<span class="comment">//magic</span>
Cache aCache = cm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">aName</span><span class="delimiter">&quot;</span></span>);
AdvancedCache advCache = aCache.getAdvancedCache();</code></pre> </div> </div> <div class="paragraph"> <p>Then one of the <em>addInterceptor()</em> methods should be used to add the actual interceptor. For further documentation refer to <a href="https://docs.jboss.org/infinispan/10.1/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> javadoc.</p> </div> </div> <div class="sect2"> <h3 id="custom_interceptor_design"><a class="anchor" href="#custom_interceptor_design"></a>3.3. Custom interceptor design</h3> <div class="paragraph"> <p>When writing a custom interceptor, you need to abide by the following rules.</p> </div> <div class="ulist"> <ul> <li> <p>Custom interceptors must extend <a href="https://docs.jboss.org/infinispan/10.1/apidocs/org/infinispan/interceptors/base/BaseCustomInterceptor.html">BaseCustomInterceptor</a></p> </li> <li> <p>Custom interceptors must declare a public, empty constructor to enable construction.</p> </li> <li> <p>Custom interceptors will have setters for any property defined through property tags used in the XML configuration.</p> </li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="rolling_up_k8s"><a class="anchor" href="#rolling_up_k8s"></a>4. Rolling Upgrades and Updates with Kubernetes and OpenShift</h2> <div class="sectionbody"> <div class="paragraph"> <p>Pods running in Kubernetes and OpenShift are immutable. The only way you can alter the configuration is to roll out a new deployment.</p> </div> <div class="paragraph"> <p>Upgrades and updates sound similar but are distinct processes for rolling out new deployments.</p> </div> <div class="sect2"> <h3 id="performing_rolling_updates_on_kubernetes"><a class="anchor" href="#performing_rolling_updates_on_kubernetes"></a>4.1. Performing Rolling Updates on Kubernetes</h3> <div class="paragraph"> <p>Rolling updates replace existing pods with new ones.</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.openshift.org/latest/dev_guide/deployments/deployment_strategies.html#rolling-strategy">Rolling Updates</a></p> </li> <li> <p><a href="https://docs.openshift.org/latest/dev_guide/deployments/deployment_strategies.html#when-to-use-a-rolling-deployment">When to Use a Rolling Deployment</a></p> </li> </ul> </div> <div class="listingblock"> <div class="title">Example DeploymentConfiguration for Rolling Updates</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">apiVersion: v1</span></span>
  <span class="key">kind</span>: <span class="string"><span class="content">DeploymentConfig</span></span>
  <span class="key">metadata</span>:
    <span class="key">name</span>: <span class="string"><span class="content">infinispan-cluster</span></span>
  <span class="key">spec</span>:
    <span class="key">replicas</span>: <span class="string"><span class="content">3</span></span>
    <span class="key">strategy</span>:
      <span class="key">type</span>: <span class="string"><span class="content">Rolling</span></span>
      <span class="key">rollingParams</span>:
        <span class="key">updatePeriodSeconds</span>: <span class="string"><span class="content">10</span></span>
        <span class="key">intervalSeconds</span>: <span class="string"><span class="content">20</span></span>
        <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">600</span></span>
        <span class="key">maxUnavailable</span>: <span class="string"><span class="content">1</span></span>
        <span class="key">maxSurge</span>: <span class="string"><span class="content">1</span></span>
    <span class="key">template</span>:
      <span class="key">spec</span>:
        <span class="key">containers</span>:
        - <span class="string"><span class="content">args:</span></span>
          - <span class="string"><span class="content">-Djboss.default.jgroups.stack=kubernetes</span></span>
          <span class="key">image</span>: <span class="string"><span class="content">jboss/infinispan-server:latest</span></span>
          <span class="key">name</span>: <span class="string"><span class="content">infinispan-server</span></span>
          <span class="key">ports</span>:
          - <span class="string"><span class="content">containerPort: 8181</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 9990</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 11211</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 11222</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 57600</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 7600</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 8080</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          <span class="key">env</span>:
          - <span class="string"><span class="content">name: KUBERNETES_NAMESPACE</span></span>
            <span class="key">valueFrom</span>: <span class="string"><span class="content">{fieldRef: {apiVersion: v1, fieldPath: metadata.namespace}}</span></span>
          <span class="key">terminationMessagePath</span>: <span class="string"><span class="content">/dev/termination-log</span></span>
          <span class="key">terminationGracePeriodSeconds</span>: <span class="string"><span class="content">90</span></span>
          <span class="key">livenessProbe</span>:
            <span class="key">exec</span>:
              <span class="key">command</span>:
              - <span class="string"><span class="content">/usr/local/bin/is_running.sh</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">10</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">80</span></span>
            <span class="key">periodSeconds</span>: <span class="string"><span class="content">60</span></span>
            <span class="key">successThreshold</span>: <span class="string"><span class="content">1</span></span>
            <span class="key">failureThreshold</span>: <span class="string"><span class="content">5</span></span>
          <span class="key">readinessProbe</span>:
             <span class="key">exec</span>:
                <span class="key">command</span>:
                - <span class="string"><span class="content">/usr/local/bin/is_healthy.sh</span></span>
             <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">10</span></span>
             <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">40</span></span>
             <span class="key">periodSeconds</span>: <span class="string"><span class="content">30</span></span>
             <span class="key">successThreshold</span>: <span class="string"><span class="content">2</span></span>
             <span class="key">failureThreshold</span>: <span class="string"><span class="content">5</span></span></code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>Kubernetes uses very similar concept to Deployment Configurations called <code>Deployment</code>.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>It is also highly recommended to adjust the JGroups stack to discover new nodes (or leaves) more quickly. One should at least adjust the value of <code>FD_ALL</code> timeout and adjust it to the longest GC Pause.</p> </div> <div class="ulist"> <div class="title">Other hints for tuning configuration parameters are:</div> <ul> <li> <p>OpenShift should replace running nodes one by one. This can be achieved by adjusting <code>rollingParams</code> (<code>maxUnavailable: 1</code> and <code>maxSurge: 1</code>).</p> </li> <li> <p>Depending on the cluster size, one needs to adjust <code>updatePeriodSeconds</code> and <code>intervalSeconds</code>. The bigger cluster size is, the bigger those values should be used.</p> </li> <li> <p>When using Initial State Transfer, the <code>initialDelaySeconds</code> value for both probes should be set to higher value.</p> </li> <li> <p>During Initial State Transfer nodes might not respond to probes. The best results are achieved with higher values of <code>failureThreshold</code> and <code>successThreshold</code> values.</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="performing_rolling_upgrades_on_kubernetes"><a class="anchor" href="#performing_rolling_upgrades_on_kubernetes"></a>4.2. Performing Rolling Upgrades on Kubernetes</h3> <div class="paragraph"> <p>Rolling upgrades migrate data from one Infinispan cluster to another.</p> </div> <div class="paragraph"> <p>For both Kubernetes and OpenShift, the rolling upgrade procedure is nearly identical to the procedure for Infinispan server rolling upgrades.</p> </div> <div class="ulist"> <div class="title">Differences in rolling upgrade procedures</div> <ul> <li> <p>Depending on configuration, it is a good practice to use <a href="https://docs.openshift.org/latest/architecture/core_concepts/routes.html">OpenShift Routes</a> or <a href="http://kubernetes.io/docs/user-guide/ingress">Kubernetes Ingress API</a> to expose services to the clients. During the upgrade the Route (or Ingress) used by the clients can be altered to point to the new cluster.</p> </li> <li> <p>Invoking CLI commands can be done by using Kubernetes (<code>kubectl exec</code>) or OpenShift clients (<code>oc exec</code>). Here is an example: <code>oc exec &lt;POD_NAME&gt;&#8201;&#8212;&#8201;'/opt/jboss/infinispan-server/bin/ispn-cli.sh' '-c' '--controller=$(hostname -i):9990' '/subsystem=datagrid-infinispan/cache-container=clustered/distributed-cache=default:disconnect-source(migrator-name=hotrod)'</code></p> </li> </ul> </div> <div class="ulist"> <div class="title">Key differences when upgrading using the library mode:</div> <ul> <li> <p>Client application needs to expose JMX. It usually depends on application and environment type but the easiest way to do it is to add the following switches into the Java boostrap script <code>-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=&lt;PORT&gt;</code>.</p> </li> <li> <p>Connecting to the JMX can be done by forwarding ports. With OpenShift this might be achieved by using <code>oc port-forward</code> command whereas in Kubernetes by <code>kubectl port-forward</code>.</p> </li> </ul> </div> <div class="paragraph"> <p>The last step in the Rolling Upgrade (removing a Remote Cache Store) needs to be performed differently. We need to use <a href="http://kubernetes.io/docs/user-guide/rolling-updates/">Kubernetes/OpenShift Rolling update</a> command and replace Pods configuration with the one which does not contain Remote Cache Store.</p> </div> <div class="paragraph"> <p>A detailed instruction might be found in <a href="https://issues.jboss.org/browse/ISPN-6673">ISPN-6673</a> ticket.</p> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2019-10-27 08:15:43 UTC </div> </div> <style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style> <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains('stemblock')) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script> </body> </html>