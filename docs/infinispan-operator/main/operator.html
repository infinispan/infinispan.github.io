<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.15">
<title>Infinispan Operator 2.2 Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="canonical" href="http://infinispan.org/docs/stable/titles/operator.html">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css">
<link rel="stylesheet" href="css/css.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script>
<script src="js/ojs.js"></script>
</head>
<body id="infinispan_operator" class="article toc2 toc-left">
<div id="header">
<h1>Infinispan Operator 2.2 Guide</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#installation">1. Installing Infinispan Operator</a>
<ul class="sectlevel2">
<li><a href="#install-olm_install">1.1. Installing Infinispan Operator on Red Hat OpenShift</a></li>
<li><a href="#install-operatorhub_install">1.2. Installing Infinispan Operator from OperatorHub.io</a></li>
<li><a href="#install-manually_install">1.3. Building and installing Infinispan Operator manually</a></li>
</ul>
</li>
<li><a href="#creating-clusters">2. Getting started with Infinispan CR</a>
<ul class="sectlevel2">
<li><a href="#infinispan-cr_infinispan-cr">2.1. Infinispan custom resource (CR)</a></li>
<li><a href="#creating-minimal-clusters_infinispan-cr">2.2. Creating Infinispan clusters</a></li>
<li><a href="#verifying-clusters_infinispan-cr">2.3. Verifying Infinispan clusters</a></li>
<li><a href="#graceful-shutdown_infinispan-cr">2.4. Stopping and starting Infinispan clusters</a></li>
</ul>
</li>
<li><a href="#creating-services">3. Setting up Infinispan services</a>
<ul class="sectlevel2">
<li><a href="#services_services">3.1. Service types</a>
<ul class="sectlevel3">
<li><a href="#_data_grid_service">3.1.1. Data Grid Service</a></li>
<li><a href="#_cache_service">3.1.2. Cache Service</a></li>
</ul>
</li>
<li><a href="#creating-datagrid-service_services">3.2. Creating Data Grid Service nodes</a>
<ul class="sectlevel3">
<li><a href="#datagrid-cr_services">3.2.1. Data Grid Service CR</a></li>
</ul>
</li>
<li><a href="#creating-cache-service_services">3.3. Creating Cache Service nodes</a>
<ul class="sectlevel3">
<li><a href="#configuring-autoscaling_services">3.3.1. Configuring automatic scaling</a></li>
<li><a href="#configuring-owners_services">3.3.2. Configuring the number of owners</a></li>
<li><a href="#cache-service-resources_services">3.3.3. Cache Service CR</a></li>
</ul>
</li>
<li><a href="#allocating-storage_services">3.4. Allocating storage resources</a>
<ul class="sectlevel3">
<li><a href="#persistent-volume-claims_services">3.4.1. Persistent volume claims</a></li>
</ul>
</li>
<li><a href="#container-resources_services">3.5. JVM, CPU, and memory</a></li>
<li><a href="#configuring-logging_services">3.6. Adjusting log levels</a>
<ul class="sectlevel3">
<li><a href="#logging-levels_services">3.6.1. Logging reference</a></li>
</ul>
</li>
<li><a href="#specifying-server-image_services">3.7. Specifying Infinispan Server images</a></li>
<li><a href="#adding-custom-labels_services">3.8. Adding labels to Infinispan resources</a>
<ul class="sectlevel3">
<li><a href="#label-environment-variables_services">3.8.1. Global labels for Infinispan Operator</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#configuring-authentication">4. Configuring authentication</a>
<ul class="sectlevel2">
<li><a href="#default-credentials_authn">4.1. Default credentials</a></li>
<li><a href="#retrieving-credentials_authn">4.2. Retrieving credentials</a></li>
<li><a href="#adding-credentials_authn">4.3. Adding custom user credentials</a></li>
<li><a href="#changing-operator-password_authn">4.4. Changing the operator password</a></li>
<li><a href="#disabling-authentication_authn">4.5. Disabling user authentication</a></li>
</ul>
</li>
<li><a href="#client-certificates">5. Configuring client certificate authentication</a>
<ul class="sectlevel2">
<li><a href="#enabling-client-certificate-authentication_client-certificates">5.1. Enabling client certificate authentication</a></li>
<li><a href="#providing-client-truststores_client-certificates">5.2. Providing client truststores</a></li>
<li><a href="#providing-client-certificates_client-certificates">5.3. Providing client certificates</a></li>
<li><a href="#configuring-clients-present-certificates_client-certificates">5.4. Configuring clients to present certificates</a></li>
</ul>
</li>
<li><a href="#configuring-encryption">6. Configuring encryption</a>
<ul class="sectlevel2">
<li><a href="#encryption-service-ca_tls">6.1. Encryption with Red Hat OpenShift service certificates</a></li>
<li><a href="#retrieving-tls-certificates_tls">6.2. Retrieving TLS certificates</a></li>
<li><a href="#disabling-encryption_tls">6.3. Disabling encryption</a></li>
<li><a href="#using-custom-encryption-secrets_tls">6.4. Using custom TLS certificates</a>
<ul class="sectlevel3">
<li><a href="#custom-encryption-secrets_tls">6.4.1. Custom encryption secrets</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#authorization">7. Configuring user roles and permissions</a>
<ul class="sectlevel2">
<li><a href="#allocating-storage_authorization">7.1. Enabling security authorization</a></li>
<li><a href="#user-roles-permissions_authorization">7.2. User roles and permissions</a></li>
<li><a href="#assigning-user-roles_authorization">7.3. Assigning roles and permissions to users</a></li>
<li><a href="#adding-custom-roles-permissions_authorization">7.4. Adding custom roles and permissions</a></li>
</ul>
</li>
<li><a href="#creating-network">8. Configuring network access to Infinispan</a>
<ul class="sectlevel2">
<li><a href="#getting-internal-service_network-services">8.1. Getting the service for internal connections</a></li>
<li><a href="#exposing-loadbalancer_network-services">8.2. Exposing Infinispan through load balancers</a></li>
<li><a href="#exposing-nodeport_network-services">8.3. Exposing Infinispan through node ports</a></li>
<li><a href="#exposing-routes_network-services">8.4. Exposing Infinispan through routes</a></li>
<li><a href="#network-services_network-services">8.5. Network services</a>
<ul class="sectlevel3">
<li><a href="#_internal_service">8.5.1. Internal service</a></li>
<li><a href="#_external_service">8.5.2. External service</a></li>
<li><a href="#_cross_site_service">8.5.3. Cross-site service</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#monitoring-services">9. Monitoring Infinispan services</a>
<ul class="sectlevel2">
<li><a href="#creating-service-monitor_monitor">9.1. Creating a Prometheus service monitor</a>
<ul class="sectlevel3">
<li><a href="#disabling-service-monitor_monitor">9.1.1. Disabling the Prometheus service monitor</a></li>
</ul>
</li>
<li><a href="#creating-grafana-dashboards_monitor">9.2. Creating Grafana data sources</a></li>
<li><a href="#configuring-grafana-dashboards_monitor">9.3. Configuring Infinispan dashboards</a></li>
</ul>
</li>
<li><a href="#setting-up-xsite">10. Setting up cross-site replication</a>
<ul class="sectlevel2">
<li><a href="#cross-site-replication_cross-site">10.1. Using Infinispan Operator to manage cross-site connections</a>
<ul class="sectlevel3">
<li><a href="#_kubernetes_clusters">10.1.1. Kubernetes clusters</a>
<ul class="sectlevel4">
<li><a href="#applying-cluster-roles-xsite_cross-site">Applying cluster roles for cross-site replication</a></li>
<li><a href="#creating-kubernetes-secrets_cross-site">Creating Kubernetes site access secrets</a></li>
</ul>
</li>
<li><a href="#_openshift_clusters">10.1.2. OpenShift clusters</a>
<ul class="sectlevel4">
<li><a href="#creating-sa-tokens_cross-site">Creating service account tokens</a></li>
<li><a href="#exchanging-sa-tokens_cross-site">Exchanging service account tokens</a></li>
</ul>
</li>
<li><a href="#configuring-sites-automatically_cross-site">10.1.3. Configuring Infinispan Operator to handle cross-site connections</a></li>
<li><a href="#cross-site-resources-automatic_cross-site">10.1.4. Resources for managed cross-site connections</a></li>
</ul>
</li>
<li><a href="#manual-xsite-views_cross-site">10.2. Manually connecting Infinispan clusters</a>
<ul class="sectlevel3">
<li><a href="#cross-site-resources-manual_cross-site">10.2.1. Resources for manual cross-site connections</a></li>
</ul>
</li>
<li><a href="#configuring-sites-in-clusters_cross-site">10.3. Configuring sites in the same Kubernetes cluster</a></li>
</ul>
</li>
<li><a href="#anti-affinity">11. Guaranteeing availability with anti-affinity</a>
<ul class="sectlevel2">
<li><a href="#anti-affinity_availability">11.1. Anti-affinity strategies</a></li>
<li><a href="#configuring_anti_affinity-availability">11.2. Configuring anti-affinity</a>
<ul class="sectlevel3">
<li><a href="#anti-affinity-strategies_availability">11.2.1. Anti-affinity strategy configurations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cache-cr">12. Creating caches with Infinispan Operator</a>
<ul class="sectlevel2">
<li><a href="#caches_cache-cr">12.1. Infinispan caches</a></li>
<li><a href="#cache-cr_cache-cr">12.2. Cache CRs</a></li>
<li><a href="#creating-caches-xml_cache-cr">12.3. Creating caches from XML</a></li>
<li><a href="#creating-caches-templates_cache-cr">12.4. Creating caches from templates</a></li>
<li><a href="#adding-backup-locations_cache-cr">12.5. Adding backup locations to caches</a>
<ul class="sectlevel3">
<li><a href="#backups-automatic-offline_cache-cr">12.5.1. Performance considerations with taking backup locations offline</a></li>
</ul>
</li>
<li><a href="#adding-cache-stores_cache-cr">12.6. Adding persistent cache stores</a></li>
</ul>
</li>
<li><a href="#batch-cr">13. Running batch operations</a></li>
<li><a href="#batching-inline_batch">14. Running inline batch operations</a>
<ul class="sectlevel2">
<li><a href="#batching-create-configmap_batch">14.1. Creating ConfigMaps for batch operations</a></li>
<li><a href="#batching-configmap_batch">14.2. Running batch operations with ConfigMaps</a></li>
<li><a href="#batch-status_batch">14.3. Batch status messages</a></li>
<li><a href="#batch-operations_batch">14.4. Example batch operations</a>
<ul class="sectlevel3">
<li><a href="#_caches">14.4.1. Caches</a></li>
<li><a href="#_counters">14.4.2. Counters</a></li>
<li><a href="#_protobuf_schema">14.4.3. Protobuf schema</a></li>
<li><a href="#_tasks">14.4.4. Tasks</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#backing-up-restoring">15. Backing up and restoring Infinispan clusters</a>
<ul class="sectlevel2">
<li><a href="#restoring_clusters-backup-restore">15.1. Restoring Infinispan clusters</a></li>
</ul>
</li>
<li><a href="#deploying-code">16. Deploying custom code to Infinispan</a>
<ul class="sectlevel2">
<li><a href="#copying-code_custom-code">16.1. Copying code artifacts</a></li>
<li><a href="#deploying-code_custom-code">16.2. Deploying custom code</a></li>
</ul>
</li>
<li><a href="#eventing">17. Sending cloud events from Infinispan clusters</a>
<ul class="sectlevel2">
<li><a href="#cloud-events_cloud-events">17.1. Cloud events</a></li>
<li><a href="#enabling-cloud-events_cloud-events">17.2. Enabling cloud events</a></li>
</ul>
</li>
<li><a href="#connecting-clients">18. Establishing remote client connections</a>
<ul class="sectlevel2">
<li><a href="#client-connection-details_clients">18.1. Client connection details</a></li>
<li><a href="#caches_clients">18.2. Infinispan caches</a></li>
<li><a href="#connecting-cli_clients">18.3. Connecting the Infinispan CLI</a></li>
<li><a href="#connecting-console_clients">18.4. Accessing Infinispan Console</a></li>
<li><a href="#hotrod-clients_clients">18.5. Hot Rod clients</a>
<ul class="sectlevel3">
<li><a href="#hotrod-configuration-builder_clients">18.5.1. Hot Rod client configuration API</a></li>
<li><a href="#hotrod-properties_clients">18.5.2. Hot Rod client properties</a></li>
<li><a href="#creating-caches-hotrod_clients">18.5.3. Creating caches from Hot Rod clients</a></li>
</ul>
</li>
<li><a href="#connecting-rest_clients">18.6. Accessing the REST API</a></li>
<li><a href="#creating-caches-cacheservice_clients">18.7. Adding caches to Cache Service nodes</a>
<ul class="sectlevel3">
<li><a href="#default-cache-service-config_clients">18.7.1. Default cache configuration</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Infinispan Operator provides operational intelligence and reduces management
complexity for deploying Infinispan on Kubernetes and Red Hat OpenShift.</p>
</div>
<div class="paragraph">
<p>Infinispan Operator 2.2 corresponds to Infinispan 13.0.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="installation">1. Installing Infinispan Operator</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Install Infinispan Operator into a Kubernetes namespace to create and manage Infinispan
clusters.</p>
</div>
<div class="sect2">
<h3 id="install-olm_install">1.1. Installing Infinispan Operator on Red Hat OpenShift</h3>
<div class="paragraph _abstract">
<p>Create subscriptions to Infinispan Operator on OpenShift so you can install different Infinispan versions and receive automatic updates.</p>
</div>
<div class="paragraph">
<p>Automatic updates apply to Infinispan Operator first and then for each Infinispan node.
Infinispan Operator updates clusters one node at a time, gracefully shutting down each node and then bringing it back online with the updated version before going on to the next node.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to <strong>OperatorHub</strong> running on OpenShift. Some OpenShift environments, such as OpenShift Container Platform, can require administrator credentials.</p>
</li>
<li>
<p>Have an OpenShift project for Infinispan Operator if you plan to install it into a specific namespace.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the OpenShift Web Console.</p>
</li>
<li>
<p>Navigate to <strong>OperatorHub</strong>.</p>
</li>
<li>
<p>Find and select Infinispan Operator.</p>
</li>
<li>
<p>Select <strong>Install</strong> and continue to <strong>Create Operator Subscription</strong>.</p>
</li>
<li>
<p>Specify options for your subscription.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Installation Mode</dt>
<dd>
<p>You can install Infinispan Operator into a <strong>Specific</strong> namespace or <strong>All</strong> namespaces.</p>
</dd>
<dt class="hdlist1">Update Channel</dt>
<dd>
<p>Subscribe to updates for Infinispan Operator versions.</p>
</dd>
<dt class="hdlist1">Approval Strategies</dt>
<dd>
<p>When new Infinispan versions become available, you can install updates manually or let Infinispan Operator install them automatically.</p>
</dd>
</dl>
</div>
</li>
<li>
<p>Select <strong>Subscribe</strong> to install Infinispan Operator.</p>
</li>
<li>
<p>Navigate to <strong>Installed Operators</strong> to verify the Infinispan Operator installation.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="install-operatorhub_install">1.2. Installing Infinispan Operator from OperatorHub.io</h3>
<div class="paragraph _abstract">
<p>Use the command line to install Infinispan Operator from <a href="https://operatorhub.io/operator/infinispan">OperatorHub.io</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>OKD 3.11 or later.</p>
</li>
<li>
<p>Kubernetes 1.11 or later.</p>
</li>
<li>
<p>Have administrator access on the Kubernetes cluster.</p>
</li>
<li>
<p>Have a <code>kubectl</code> or <code>oc</code> client.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Navigate to the Infinispan Operator entry on <a href="https://operatorhub.io/operator/infinispan">OperatorHub.io</a>.</p>
</li>
<li>
<p>Follow the instructions to install Infinispan Operator into your Kubernetes cluster.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="install-manually_install">1.3. Building and installing Infinispan Operator manually</h3>
<div class="paragraph _abstract">
<p>Manually build and install Infinispan Operator from the GitHub repository.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Follow the appropriate instructions in the <a href="https://github.com/infinispan/infinispan-operator/blob/main/README.md">Infinispan Operator README</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-clusters">2. Getting started with Infinispan CR</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>After you install Infinispan Operator, learn how to create Infinispan clusters on Kubernetes.</p>
</div>
<div class="sect2">
<h3 id="infinispan-cr_infinispan-cr">2.1. Infinispan custom resource (CR)</h3>
<div class="paragraph _abstract">
<p>Infinispan Operator adds a new Custom Resource (CR) of type <code>Infinispan</code> that lets
you handle Infinispan clusters as complex units on Kubernetes.</p>
</div>
<div class="paragraph">
<p>Infinispan Operator watches for <code>Infinispan</code> Custom Resources (CR) that you use to
instantiate and configure Infinispan clusters and manage Kubernetes resources, such
as StatefulSets and Services. In this way, the <code>Infinispan</code> CR is your
primary interface to Infinispan on Kubernetes.</p>
</div>
<div class="paragraph">
<p>The minimal <code>Infinispan</code> CR is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 2</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>apiVersion</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declares the version of the <code>Infinispan</code> API.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declares the <code>Infinispan</code> CR.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>metadata.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a name for your Infinispan cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.replicas</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the number of nodes in your Infinispan cluster.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="creating-minimal-clusters_infinispan-cr">2.2. Creating Infinispan clusters</h3>
<div class="paragraph _abstract">
<p>Use Infinispan Operator to create clusters of two or more Infinispan nodes.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Install Infinispan Operator.</p>
</li>
<li>
<p>Have an <code>oc</code> or a <code>kubectl</code> client.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify the number of Infinispan nodes in the cluster with <code>spec.replicas</code>
in your <code>Infinispan</code> CR.</p>
<div class="paragraph">
<p>For example, create a <code>cr_minimal.yaml</code> file as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ cat &gt; cr_minimal.yaml&lt;&lt;EOF
apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 2
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Apply your <code>Infinispan</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f cr_minimal.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Watch Infinispan Operator create the Infinispan nodes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get pods -w

NAME                        READY  STATUS              RESTARTS   AGE
example-infinispan-1        0/1    ContainerCreating   0          4s
example-infinispan-2        0/1    ContainerCreating   0          4s
example-infinispan-3        0/1    ContainerCreating   0          5s
infinispan-operator-0       1/1    Running             0          3m
example-infinispan-3        1/1    Running             0          8s
example-infinispan-2        1/1    Running             0          8s
example-infinispan-1        1/1    Running             0          8s</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Next Steps</div>
<p>Try changing the value of <code>replicas:</code> and watching Infinispan Operator scale the cluster up or down.</p>
</div>
</div>
<div class="sect2">
<h3 id="verifying-clusters_infinispan-cr">2.3. Verifying Infinispan clusters</h3>
<div class="paragraph _abstract">
<p>Check that Infinispan nodes have successfully formed clusters.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Retrieve the <code>Infinispan</code> CR for Infinispan Operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get infinispan -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response indicates that Infinispan nodes have received clustered views, as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>conditions:
  - message: 'View: [example-infinispan-0, example-infinispan-1]'
    status: "True"
    type: wellFormed</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do the following for automated scripts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl wait --for condition=wellFormed --timeout=240s infinispan/example-infinispan</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, you can retrieve cluster view from logs as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl logs example-infinispan-0 | grep ISPN000094

INFO  [org.infinispan.CLUSTER] (MSC service thread 1-2) \
ISPN000094: Received new cluster view for channel infinispan: \
[example-infinispan-0|0] (1) [example-infinispan-0]

INFO  [org.infinispan.CLUSTER] (jgroups-3,example-infinispan-0) \
ISPN000094: Received new cluster view for channel infinispan: \
[example-infinispan-0|1] (2) [example-infinispan-0, example-infinispan-1]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="graceful-shutdown_infinispan-cr">2.4. Stopping and starting Infinispan clusters</h3>
<div class="paragraph _abstract">
<p>Stop and start Infinispan nodes in a graceful, ordered fashion to correctly preserve cluster state.</p>
</div>
<div class="paragraph">
<p>Clusters of Data Grid Service nodes must restart with the same number of nodes that existed before shutdown.
This allows Infinispan to restore the distribution of data across the cluster.
After Infinispan Operator fully restarts the cluster you can safely add and remove nodes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Change the <code>spec.replicas</code> field to <code>0</code> to stop the Infinispan cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  replicas: 0</code></pre>
</div>
</div>
</li>
<li>
<p>Ensure you have the correct number of nodes before you restart the cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get infinispan example-infinispan -o=jsonpath='{.status.replicasWantedAtRestart}'</code></pre>
</div>
</div>
</li>
<li>
<p>Change the <code>spec.replicas</code> field to the same number of nodes to restart the Infinispan cluster.</p>
<div class="listingblock">
<div class="content">
<pre>spec:
  replicas: 6</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-services">3. Setting up Infinispan services</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Use Infinispan Operator to create clusters of either Cache Service or Data Grid Service nodes.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you do not specify a value for the <code>spec.service.type</code> field, Infinispan Operator creates Cache Service nodes by default.</p>
</div>
<div class="paragraph">
<p>You cannot change the <code>spec.service.type</code> field after you create nodes.
To change the service type, you must delete the existing nodes and create new ones.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="services_services">3.1. Service types</h3>
<div class="paragraph _abstract">
<p>Services are stateful applications, based on the Infinispan Server image, that provide flexible and robust in-memory data storage.</p>
</div>
<div class="sect3">
<h4 id="_data_grid_service">3.1.1. Data Grid Service</h4>
<div class="paragraph">
<p>Use Data Grid Service if you want to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Back up data across global clusters with cross-site replication.</p>
</li>
<li>
<p>Create caches with any valid configuration.</p>
</li>
<li>
<p>Add file-based cache stores to save data in a persistent volume.</p>
</li>
<li>
<p>Query values across caches using the Infinispan Query API.</p>
</li>
<li>
<p>Use advanced Infinispan features and capabilities.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_cache_service">3.1.2. Cache Service</h4>
<div class="paragraph">
<p>Use Cache Service if you want a volatile, low-latency data store with minimal configuration.
Cache Service nodes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Automatically scale to meet capacity when data storage demands go up or down.</p>
</li>
<li>
<p>Synchronously distribute data to ensure consistency.</p>
</li>
<li>
<p>Replicates each entry in the cache across the cluster.</p>
</li>
<li>
<p>Store cache entries off-heap and use eviction for JVM efficiency.</p>
</li>
<li>
<p>Ensure data consistency with a default partition handling configuration.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Because Cache Service nodes are volatile you lose all data when you apply changes to the cluster with the <code>Infinispan</code> CR or update the Infinispan version.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-datagrid-service_services">3.2. Creating Data Grid Service nodes</h3>
<div class="paragraph _abstract">
<p>To use custom cache definitions along with Infinispan capabilities such as cross-site replication, create clusters of Data Grid Service nodes.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an <code>Infinispan</code> CR that sets <code>spec.service.type: DataGrid</code> and configures any other Data Grid Service resources.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 2
  service:
    type: DataGrid</code></pre>
</div>
</div>
</li>
<li>
<p>Apply your <code>Infinispan</code> CR to create the cluster.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="datagrid-cr_services">3.2.1. Data Grid Service CR</h4>
<div class="paragraph _abstract">
<p>This topic describes the <code>Infinispan</code> CR for Data Grid Service nodes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
  annotations:
    infinispan.org/monitoring: 'true'
spec:
  replicas: 6
  service:
    type: DataGrid
    container:
      storage: 2Gi
      ephemeralStorage: false
      storageClassName: my-storage-class
    sites:
      local:
      name: azure
      expose:
        type: LoadBalancer
      locations:
      - name: azure
        url: openshift://api.azure.host:6443
        secretName: azure-token
      - name: aws
        clusterName: example-infinispan
        namespace: ispn-namespace
        url: openshift://api.aws.host:6443
        secretName: aws-token
  security:
    endpointSecretName: endpoint-identities
    endpointEncryption:
        type: Secret
        certSecretName: tls-secret
  container:
    extraJvmOpts: "-XX:NativeMemoryTracking=summary"
    cpu: "1000m"
    memory: 1Gi
  logging:
    categories:
      org.infinispan: debug
      org.jgroups: debug
      org.jgroups.protocols.TCP: error
      org.jgroups.protocols.relay.RELAY2: error
  expose:
    type: LoadBalancer
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app: infinispan-pod
              clusterName: example-infinispan
              infinispan_cr: example-infinispan
          topologyKey: "kubernetes.io/hostname"</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>metadata.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Names your Infinispan cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>metadata.annotations.infinispan.org/monitoring</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Automatically creates a <code>ServiceMonitor</code> for your cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.replicas</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the number of nodes in your cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.service.type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the type Infinispan service. A value of <code>DataGrid</code> creates a cluster with Data Grid Service nodes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.service.container</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the storage resources for Data Grid Service nodes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.service.sites</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures cross-site replication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.security.endpointSecretName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies an authentication secret that contains Infinispan user credentials.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.security.endpointEncryption</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies TLS certificates and keystores to encrypt client connections.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.container</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies JVM, CPU, and memory resources for Infinispan nodes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.logging</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures Infinispan logging categories.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.expose</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls how Infinispan endpoints are exposed on the network.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.affinity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures anti-affinity strategies that guarantee Infinispan availability.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="creating-cache-service_services">3.3. Creating Cache Service nodes</h3>
<div class="paragraph _abstract">
<p>Create Infinispan clusters with Cache Service nodes for a volatile, low-latency data store with minimal configuration.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an <code>Infinispan</code> CR that sets <code>spec.service.type: Cache</code> and configures any other Cache Service resources.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 2
  service:
    type: Cache</code></pre>
</div>
</div>
</li>
<li>
<p>Apply your <code>Infinispan</code> CR to create the cluster.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="configuring-autoscaling_services">3.3.1. Configuring automatic scaling</h4>
<div class="paragraph _abstract">
<p>If you create clusters with Cache Service nodes, Infinispan Operator
can automatically scale nodes up or down based on memory usage for the default
cache.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Automatic scaling works with the default cache only. If you plan to add other
caches to your cluster, you should not include the <code>autoscale</code> field in your
<code>Infinispan</code> CR. In this case you should use eviction to control the size of
the data container on each node.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To configure automatic scaling you set:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A maximum threshold for memory usage on each Infinispan node in your cluster.</p>
<div class="paragraph">
<p>When Infinispan Operator detects that any node in the cluster reaches the threshold, it creates a new node if possible. If Infinispan Operator cannot create a new node then it performs eviction when memory usage reaches 100 percent.</p>
</div>
</li>
<li>
<p>A minimum threshold for memory usage across your Infinispan cluster.</p>
<div class="paragraph">
<p>When Infinispan Operator detects that memory usage falls below the minimum, it shuts down nodes</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the <code>spec.autoscale</code> resource to your <code>Infinispan</code> CR to enable automatic scaling.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Set a value of <code>true</code> for the <code>autoscale.disabled</code> field to disable automatic scaling.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Specify a maximum threshold, as a percentage, for memory usage on each node with the <code>spec.autoscale.maxMemUsagePercent</code> field.</p>
</li>
<li>
<p>Set the maximum number of number of nodes for the cluster with the <code>spec.autoscale.maxReplicas</code> field.</p>
</li>
<li>
<p>Specify a minimum threshold, as a percentage, for cluster memory usage with the <code>spec.autoscale.minMemUsagePercent</code> field.</p>
</li>
<li>
<p>Set the minimum number of number of nodes for the cluster with the <code>spec.autoscale.minReplicas</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  service:
    type: Cache
  autoscale:
    disabled: false
    maxMemUsagePercent: 70
    maxReplicas: 5
    minMemUsagePercent: 30
    minReplicas: 2</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configuring-owners_services">3.3.2. Configuring the number of owners</h4>
<div class="paragraph _abstract">
<p>The number of owners controls how many copies of each cache entry are
replicated across your Infinispan cluster. The default for Cache Service
nodes is two, which duplicates each entry to prevent data loss.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify the number of copies for each cache entry with the <code>spec.service.replicationFactor</code> field in your <code>Infinispan</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  service:
    type: Cache
    replicationFactor: 3</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="cache-service-resources_services">3.3.3. Cache Service CR</h4>
<div class="paragraph _abstract">
<p>This topic describes the <code>Infinispan</code> CR for Cache Service nodes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
  annotations:
    infinispan.org/monitoring: 'true'
spec:
  replicas: 4
  service:
    type: Cache
    replicationFactor: 2
  autoscale:
    maxMemUsagePercent: 70
    maxReplicas: 5
    minMemUsagePercent: 30
    minReplicas: 2
  security:
    endpointSecretName: endpoint-identities
    endpointEncryption:
        type: Secret
        certSecretName: tls-secret
  container:
    extraJvmOpts: "-XX:NativeMemoryTracking=summary"
    cpu: "2000m"
    memory: 1Gi
  logging:
    categories:
      org.infinispan: trace
      org.jgroups: trace
  expose:
    type: LoadBalancer
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app: infinispan-pod
              clusterName: example-infinispan
              infinispan_cr: example-infinispan
          topologyKey: "kubernetes.io/hostname"</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>metadata.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Names your Infinispan cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>metadata.annotations.infinispan.org/monitoring</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Automatically creates a <code>ServiceMonitor</code> for your cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.replicas</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the number of nodes in your cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.service.type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the type Infinispan service. A value of <code>Cache</code> creates a cluster with Cache Service nodes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.service.replicationFactor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the number of copies for each entry across the cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.autoscale</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables and configures automatic scaling.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.security.endpointSecretName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies an authentication secret that contains Infinispan user credentials.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.security.endpointEncryption</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies TLS certificates and keystores to encrypt client connections.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.container</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies JVM, CPU, and memory resources for Infinispan nodes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.logging</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures Infinispan logging categories.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.expose</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls how Infinispan endpoints are exposed on the network.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.affinity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures anti-affinity strategies that guarantee Infinispan availability.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="allocating-storage_services">3.4. Allocating storage resources</h3>
<div class="paragraph _abstract">
<p>You can allocate storage for Data Grid Service nodes but not Cache Service nodes.</p>
</div>
<div class="paragraph">
<p>By default, Infinispan Operator allocates <code>1Gi</code> for the persistent volume claim.
However you should adjust the amount of storage available to Data Grid Service nodes so that Infinispan can preserve cluster state during shutdown.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If available container storage is less than the amount of available memory, data loss can occur.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Allocate storage resources with the <code>spec.service.container.storage</code> field.</p>
</li>
<li>
<p>Optionally configure the <code>ephemeralStorage</code> and <code>storageClassName</code> fields as required.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  service:
    type: DataGrid
    container:
      storage: 2Gi
      ephemeralStorage: false
      storageClassName: my-storage-class</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.service.container.storage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the amount of storage for Data Grid Service nodes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.service.container.ephemeralStorage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines whether storage is ephemeral or permanent. Set the value to <code>true</code> to use ephemeral storage, which means all data in storage is deleted when clusters shut down or restart. The default value is <code>false</code>, which means storage is permanent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.service.container.storageClassName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the name of a <code>StorageClass</code> object to use for the persistent volume claim (PVC). If you include this field, you must specify an existing storage class as the value. If you do not include this field, the persistent volume claim uses the storage class that has the <code>storageclass.kubernetes.io/is-default-class</code> annotation set to <code>true</code>.</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="persistent-volume-claims_services">3.4.1. Persistent volume claims</h4>
<div class="paragraph _abstract">
<p>Infinispan Operator creates a persistent volume claim (PVC) and mounts container storage at:<br>
<code>/opt/infinispan/server/data</code></p>
</div>
<div class="paragraph">
<div class="title">Caches</div>
<p>When you create caches, Infinispan permanently stores their configuration so your caches are available after cluster restarts.
This applies to both Cache Service and Data Grid Service nodes.</p>
</div>
<div class="paragraph">
<div class="title">Data</div>
<p>Data is always volatile in clusters of Cache Service nodes.
When you shutdown the cluster, you permanently lose the data.</p>
</div>
<div class="paragraph">
<p>Use a file-based cache store, by adding the <code>&lt;file-store/&gt;</code> element to your Infinispan cache configuration, if you want Data Grid Service nodes to persist data during cluster shutdown.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="container-resources_services">3.5. JVM, CPU, and memory</h3>
<div class="paragraph _abstract">
<p>You can set JVM options in <code>Infinispan</code> CR as well as CPU and memory allocation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  container:
    extraJvmOpts: "-XX:NativeMemoryTracking=summary"
    cpu: "1000m"
    memory: 1Gi</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.container.extraJvmOpts</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies JVM options.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.container.cpu</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocates host CPU resources to Infinispan nodes, measured in CPU units.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.container.memory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocates host memory to Infinispan nodes, measured in bytes.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When Infinispan Operator creates Infinispan clusters, it uses <code>spec.container.cpu</code> and <code>spec.container.memory</code> to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure that Kubernetes has sufficient capacity to run the Infinispan node. By
default Infinispan Operator requests <strong>512Mi</strong> of <code>memory</code> and <strong>0.5</strong> <code>cpu</code> from
the Kubernetes scheduler.</p>
</li>
<li>
<p>Constrain node resource usage. Infinispan Operator sets the values of <code>cpu</code> and
<code>memory</code> as resource limits.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="configuring-logging_services">3.6. Adjusting log levels</h3>
<div class="paragraph _abstract">
<p>Change levels for different Infinispan logging categories when you need to debug issues.
You can also adjust log levels to reduce the number of messages for certain categories to minimize the use of container resources.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure Infinispan logging with the <code>spec.logging.categories</code> field in your <code>Infinispan</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  logging:
    categories:
      org.infinispan: debug
      org.jgroups: debug</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
<li>
<p>Retrieve logs from Infinispan nodes as required.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl logs -f $POD_NAME</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="logging-levels_services">3.6.1. Logging reference</h4>
<div class="paragraph _abstract">
<p>Find information about log categories and levels.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Log categories</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Root category</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default level</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.infinispan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan messages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>info</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.jgroups</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster transport messages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>info</code></p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Log levels</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Log level</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>trace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides detailed information about running state of applications. This is the most verbose log level.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>debug</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates the progress of individual requests or activities.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>info</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates overall progress of applications, including lifecycle events.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>warn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates circumstances that can lead to error or degrade performance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>error</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates error conditions that might prevent operations or activities from being successful but do not prevent applications from running.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Garbage collection (GC) messages</div>
<p>Infinispan Operator does not log GC messages by default.
You can direct GC messages to <code>stdout</code> with the following JVM options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">extraJvmOpts: "-Xlog:gc*:stdout:time,level,tags"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="specifying-server-image_services">3.7. Specifying Infinispan Server images</h3>
<div class="paragraph _abstract">
<p>Specify which Infinispan Server image Infinispan Operator should use to create nodes with the <code>spec.image</code> field.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  image: quay.io/infinispan/server:latest</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-custom-labels_services">3.8. Adding labels to Infinispan resources</h3>
<div class="paragraph _abstract">
<p>Attach key/value labels to pods and services that Infinispan Operator creates and manages.
These labels help you identify relationships between objects to better organize and monitor Infinispan resources.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your <code>Infinispan</code> CR for editing.</p>
</li>
<li>
<p>Add any labels that you want Infinispan Operator to attach to resources with <code>metadata.annotations</code>.</p>
</li>
<li>
<p>Add values for your labels with <code>metadata.labels</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify labels that you want to attach to services with the <code>metadata.annotations.infinispan.org/targetLabels</code> field.</p>
</li>
<li>
<p>Specify labels that you want to attach to pods with the <code>metadata.annotations.infinispan.org/podTargetLabels</code> field.</p>
</li>
<li>
<p>Define values for your labels with the <code>metadata.labels</code> fields.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  annotations:
    infinispan.org/targetLabels: svc-label1, svc-label2
    infinispan.org/podTargetLabels: pod-label1, pod-label2
  labels:
    svc-label1: svc-value1
    svc-label2: svc-value2
    pod-label1: pod-value1
    pod-label2: pod-value2
    # The operator does not attach these labels to resources.
    my-label: my-value
    environment: development</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Apply your <code>Infinispan</code> CR.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/">Labels and Selectors</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/blob/release-1.0/docs/user-guide/labels.md">Labels: Kubernetes User Guide</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="label-environment-variables_services">3.8.1. Global labels for Infinispan Operator</h4>
<div class="paragraph _abstract">
<p>Global labels are automatically propagated to all Infinispan pods and services.</p>
</div>
<div class="paragraph">
<p>You can add and modify global labels for Infinispan Operator with the <code>env</code> field in the operator yaml.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml"># Defines global labels for services.
- name: INFINISPAN_OPERATOR_TARGET_LABELS
  value: |
    {"svc-label1":"svc-value1",
     "svc-label2":"svc-value2"}
# Defines global labels for pods.
- name: INFINISPAN_OPERATOR_POD_TARGET_LABELS
  value: |
    {"pod-label1":"pod-value1",
     "pod-label2":"pod-value2"}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-authentication">4. Configuring authentication</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Application users need credentials to access Infinispan clusters.
You can use default, generated credentials or add your own.</p>
</div>
<div class="sect2">
<h3 id="default-credentials_authn">4.1. Default credentials</h3>
<div class="paragraph _abstract">
<p>Infinispan Operator generates base64-encoded default credentials stored in an authentication secrets named</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Username</th>
<th class="tableblock halign-left valign-top">Secret name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>developer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>example-infinispan-generated-secret</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credentials for the default application user.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>operator</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>example-infinispan-generated-operator-secret</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credentials that Infinispan Operator uses to interact with Infinispan resources.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="retrieving-credentials_authn">4.2. Retrieving credentials</h3>
<div class="paragraph _abstract">
<p>Get credentials from authentication secrets to access Infinispan clusters.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Retrieve credentials from authentication secrets.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get secret example-infinispan-generated-secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>Base64-decode credentials.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get secret example-infinispan-generated-secret \
-o jsonpath="{.data.identities\.yaml}" | base64 --decode

credentials:
- username: developer
  password: dIRs5cAAsHIeeRIL</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="adding-credentials_authn">4.3. Adding custom user credentials</h3>
<div class="paragraph _abstract">
<p>Configure access to Infinispan cluster endpoints with custom credentials.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Modifying <code>spec.security.endpointSecretName</code> triggers a cluster restart.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an <code>identities.yaml</code> file with the credentials that you want to add.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">credentials:
- username: myfirstusername
  password: changeme-one
- username: mysecondusername
  password: changeme-two</code></pre>
</div>
</div>
</li>
<li>
<p>Create an authentication secret from <code>identities.yaml</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl create secret generic --from-file=identities.yaml connect-secret</code></pre>
</div>
</div>
</li>
<li>
<p>Specify the authentication secret with <code>spec.security.endpointSecretName</code> in your <code>Infinispan</code> CR and then apply the changes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  security:
    endpointSecretName: connect-secret</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="changing-operator-password_authn">4.4. Changing the operator password</h3>
<div class="paragraph _abstract">
<p>You can change the password for the <code>operator</code> user if you do not want to use the automatically generated password.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Update the <code>password</code> key in the <code>example-infinispan-generated-operator-secret</code> secret as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">kubectl patch secret example-infinispan-generated-operator-secret -p='{"stringData":{"password": "supersecretoperatorpassword"}}'</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You should update only the <code>password</code> key in the <code>generated-operator-secret</code> secret.
When you update the password, Infinispan Operator automatically refreshes other keys in that secret.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="disabling-authentication_authn">4.5. Disabling user authentication</h3>
<div class="paragraph _abstract">
<p>Allow users to access Infinispan clusters and manipulate data without providing credentials.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not disable authentication if endpoints are accessible from outside the Kubernetes cluster via <code>spec.expose.type</code>.
You should disable authentication for development environments only.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Set <code>false</code> as the value for the <code>spec.security.endpointAuthentication</code> field in your <code>Infinispan</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  security:
    endpointAuthentication: false</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="client-certificates">5. Configuring client certificate authentication</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Configure certificate authentication so that Infinispan allows connections only for clients that present valid certificates.</p>
</div>
<div class="sect2">
<h3 id="enabling-client-certificate-authentication_client-certificates">5.1. Enabling client certificate authentication</h3>
<div class="paragraph _abstract">
<p>Infinispan clusters do not use client certificate authentication by default.
Complete the following procedure to enable it.</p>
</div>
<div class="paragraph">
<p>You can configure Infinispan to verify client identities from certificates in a trust store in two ways:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>Validate</code></dt>
<dd>
<p>Requires a trust store that contains only the signing certificate, which is typically a Certificate Authority (CA). Any client that presents a certificate signed by the CA can connect to Infinispan.</p>
</dd>
<dt class="hdlist1"><code>Authenticate</code></dt>
<dd>
<p>Requires a trust store that contains all client certificates in addition to the signing certificate. Only clients that present a signed certificate that is present in the trust store can connect to Infinispan.</p>
</dd>
</dl>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Set either <code>Validate</code> or <code>Authenticate</code> as the value for the <code>spec.security.endpointEncryption.clientCert</code> field in your <code>Infinispan</code> CR.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The default value is <code>None</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Optionally specify the secret that contains the client trust store with the <code>spec.security.endpointEncryption.clientCertSecretName</code> field.</p>
<div class="paragraph">
<p>By default Infinispan Operator uses a trust store secret named <code>example-infinispan-client-cert-secret</code>.
If you want to use this secret you do not need to specify the <code>clientCertSecretName</code> field.
However, you must create the secret if it does not already exist.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The secret must be unique to each <code>Infinispan</code> CR instance in the Kubernetes cluster.
When you delete the <code>Infinispan</code> CR, Kubernetes also automatically deletes the associated secret.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  security:
    endpointEncryption:
        type: Service
        certSecretName: tls-secret
        clientCert: Validate
        clientCertSecretName: my-truststore-secret</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Next steps</div>
<p>Provide Infinispan Operator with a trust store that contains all client certificates.
Alternatively you can provide certificates in PEM format and let Infinispan generate a client trust store.</p>
</div>
</div>
<div class="sect2">
<h3 id="providing-client-truststores_client-certificates">5.2. Providing client truststores</h3>
<div class="paragraph _abstract">
<p>If you have a trust store that contains the required certificates you can make it available to Infinispan Operator.</p>
</div>
<div class="paragraph">
<p>Infinispan supports trust stores in <code>PKCS12</code> format only.</p>
</div>
<div class="paragraph">
<p>The trust store that you provide must contain the signing certificate, or CA certificate bundle.
If you use the <code>Authenticate</code> method to verify client identities, the trust store must contain the certificate for each client that can connect to Infinispan endpoints.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify the name of the secret that contains the client trust store as the value of the <code>metadata.name</code> field.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The name should match the value of the <code>spec.security.endpointEncryption.clientCertSecretName</code> field.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Provide the password for the trust store with the <code>stringData.truststore-password</code> field.</p>
</li>
<li>
<p>Specify the trust store with the <code>data.truststore.p12</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: my-truststore-secret
type: Opaque
stringData:
    truststore-password: changme
data:
    trust.ca: "&lt;base64_encoded_CA_certificate&gt;"
    trust.cert.client1: "&lt;base64_encoded_client_certificate&gt;"
    trust.cert.client2: "&lt;base64_encoded_client_certificate&gt;"</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="providing-client-certificates_client-certificates">5.3. Providing client certificates</h3>
<div class="paragraph _abstract">
<p>Infinispan Operator can generate a trust store from certificates in PEM format.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify the name of the secret that contains the client trust store as the value of the <code>metadata.name</code> field.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The name should match the value of the <code>spec.security.endpointEncryption.clientCertSecretName</code> field.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Specify the signing certificate, or CA certificate bundle, as the value of the <code>data.trust.ca</code> field.</p>
</li>
<li>
<p>If you use the <code>Authenticate</code> method to verify client identities, add the certificate for each client that can connect to Infinispan endpoints with the <code>data.trust.cert.&lt;name&gt;</code> field.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan Operator uses the <code>&lt;name&gt;</code> value as the alias for the certificate when it generates the trust store.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Optionally provide a password for the trust store with the <code>stringData.truststore-password</code> field.</p>
<div class="paragraph">
<p>If you do not provide one, Infinispan Operator sets "password" as the trust store password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: my-truststore-secret
type: Opaque
stringData:
    truststore-password: changme
data:
    trust.ca: "&lt;base64_encoded_CA_certificate&gt;"
    trust.cert.client1: "&lt;base64_encoded_client_certificate&gt;"
    trust.cert.client2: "&lt;base64_encoded_client_certificate&gt;"</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring-clients-present-certificates_client-certificates">5.4. Configuring clients to present certificates</h3>
<div class="paragraph _abstract">
<p>If you enable client certificate authentication, Hot Rod and REST clients must present valid certificates so they can connect to Infinispan endpoints.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Enabling client certificate authentication means you do not need to specify Infinispan user credentials in client configuration.
You need to provide clients with keystores that contain the appropriate certificates that they can present to Infinispan when negotiating a connection.</p>
</div>
<div class="paragraph">
<p>If you enable security authorization, you should assign the Common Name (<code>CN</code>) from the client certificate a role with the appropriate permissions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hot Rod clients must use the <code>EXTERNAL</code> authentication mechanism and specify the keystore that contains the client certificate as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;
...

ConfigurationBuilder builder = new ConfigurationBuilder();
      builder.security()
             .authentication()
               .saslMechanism("EXTERNAL")
             .ssl()
               .keyStoreFileName("/path/to/keystore")
               .keyStorePassword("keystorepassword".toCharArray())
               .keyStoreType("PCKS12");</code></pre>
</div>
</div>
<div class="paragraph">
<p>REST clients must include the client certificate for each request as appropriate.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-encryption">6. Configuring encryption</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Encrypt connections between clients and Infinispan nodes with Red Hat OpenShift
service certificates or custom TLS certificates.</p>
</div>
<div class="sect2">
<h3 id="encryption-service-ca_tls">6.1. Encryption with Red Hat OpenShift service certificates</h3>
<div class="paragraph _abstract">
<p>Infinispan Operator automatically generates TLS certificates that are signed by the
Red Hat OpenShift service CA. Infinispan Operator then stores the certificates and keys
in a secret so you can retrieve them and use with remote clients.</p>
</div>
<div class="paragraph">
<p>If the Red Hat OpenShift service CA is available, Infinispan Operator adds the following <code>spec.security.endpointEncryption</code> configuration to the <code>Infinispan</code> CR:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  security:
    endpointEncryption:
      type: Service
      certServiceName: service.beta.openshift.io
      certSecretName: example-infinispan-cert-secret</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.security.endpointEncryption.certServiceName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the service that provides TLS certificates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec.security.endpointEncryption.certSecretName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a secret with a service certificate and key in PEM format. Defaults to <code>&lt;cluster_name&gt;-cert-secret</code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Service certificates use the internal DNS name of the Infinispan cluster as the common name (CN), for example:</p>
</div>
<div class="paragraph">
<p><code>Subject: CN = example-infinispan.mynamespace.svc</code></p>
</div>
<div class="paragraph">
<p>For this reason, service certificates can be fully trusted only inside
OpenShift. If you want to encrypt connections with clients running
outside OpenShift, you should use custom TLS certificates.</p>
</div>
<div class="paragraph">
<p>Service certificates are valid for one year and are automatically replaced
before they expire.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="retrieving-tls-certificates_tls">6.2. Retrieving TLS certificates</h3>
<div class="paragraph _abstract">
<p>Get TLS certificates from encryption secrets to create client trust stores.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Retrieve <code>tls.crt</code> from encryption secrets as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get secret example-infinispan-cert-secret \
-o jsonpath='{.data.tls\.crt}' | base64 --decode &gt; tls.crt</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="disabling-encryption_tls">6.3. Disabling encryption</h3>
<div class="paragraph _abstract">
<p>You can disable encryption so clients do not need TLS certificates to establish connections with Infinispan.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not disable encryption if endpoints are accessible from outside the Kubernetes cluster via <code>spec.expose.type</code>.
You should disable encryption for development environments only.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Set <code>None</code> as the value for the <code>spec.security.endpointEncryption.type</code> field in your <code>Infinispan</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  security:
    endpointEncryption:
      type: None</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="using-custom-encryption-secrets_tls">6.4. Using custom TLS certificates</h3>
<div class="paragraph _abstract">
<p>Use custom PKCS12 keystore or TLS certificate/key pairs to encrypt connections between clients and Infinispan clusters.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create either a keystore or certificate secret.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The secret must be unique to each <code>Infinispan</code> CR instance in the Kubernetes cluster.
When you delete the <code>Infinispan</code> CR, Kubernetes also automatically deletes the associated secret.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the encryption secret to your OpenShift namespace, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f tls_secret.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Specify the encryption secret with the <code>spec.security.endpointEncryption.certSecretName</code> field in your
<code>Infinispan</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  security:
    endpointEncryption:
      type: Secret
      certSecretName: tls-secret</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="custom-encryption-secrets_tls">6.4.1. Custom encryption secrets</h4>
<div class="paragraph _abstract">
<p>This topic describes resources for custom encryption secrets.</p>
</div>
<div class="listingblock">
<div class="title">Keystore secrets</div>
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: v1
kind: Secret
metadata:
  name: tls-secret
type: Opaque
stringData:
  alias: server
  password: changeme
data:
  keystore.p12:  "MIIKDgIBAzCCCdQGCSqGSIb3DQEHA..."</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stringData.alias</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies an alias for the keystore.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stringData.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the keystore password.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>data.keystore.p12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adds a base64-encoded keystore.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Certificate secrets</div>
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: v1
kind: Secret
metadata:
  name: tls-secret
type: Opaque
data:
  tls.key:  "LS0tLS1CRUdJTiBQUk ..."
  tls.crt: "LS0tLS1CRUdJTiBDRVl ..."</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>data.tls.key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adds a base64-encoded TLS key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>data.tls.crt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adds a base64-encoded TLS certificate.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authorization">7. Configuring user roles and permissions</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Secure access to Infinispan services by configuring role-based access control (RBAC) for users.
This requires you to assign roles to users so that they have permission to access caches and Infinispan resources.</p>
</div>
<div class="sect2">
<h3 id="allocating-storage_authorization">7.1. Enabling security authorization</h3>
<div class="paragraph _abstract">
<p>By default authorization is disabled to ensure backwards compatibility with <code>Infinispan</code> CR instances.
Complete the following procedure to enable authorization and use role-based access control (RBAC) for Infinispan users.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Set <code>true</code> as the value for the <code>spec.security.authorization.enabled</code> field in your <code>Infinispan</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  security:
    authorization:
      enabled: true</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="user-roles-permissions_authorization">7.2. User roles and permissions</h3>
<div class="paragraph _abstract">
<p>Infinispan Operator provides a set of default roles that are associated with different permissions.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Default roles and permissions</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Role</th>
<th class="tableblock halign-left valign-top">Permissions</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>admin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Superuser with all permissions including control of the Cache Manager lifecycle.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deployer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_READ, ALL_WRITE, LISTEN, EXEC, MONITOR, CREATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Can create and delete Infinispan resources in addition to <code>application</code> permissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>application</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_READ, ALL_WRITE, LISTEN, EXEC, MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Has read and write access to Infinispan resources in addition to <code>observer</code> permissions. Can also listen to events and execute server tasks and scripts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>observer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_READ, MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Has read access to Infinispan resources in addition to <code>monitor</code> permissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>monitor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Can view statistics for Infinispan clusters.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Infinispan Operator credentials</div>
<p>Infinispan Operator generates credentials that it uses to authenticate with Infinispan clusters to perform internal operations.
By default Infinispan Operator credentials are automatically assigned the <code>admin</code> role when you enable security authorization.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://infinispan.org/docs/stable/titles/security/security.html#con_authz-authz">How security authorization works</a> (<em>Infinispan Security Guide</em>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="assigning-user-roles_authorization">7.3. Assigning roles and permissions to users</h3>
<div class="paragraph _abstract">
<p>Assign users with roles that control whether users are authorized to access Infinispan cluster resources.
Roles can have different permission levels, from read-only to unrestricted access.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A user named "admin" is assigned the <code>admin</code> role automatically.
A user named "deployer" is assigned the <code>deployer</code> role automatically, and so on.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an <code>identities.yaml</code> file that assigns roles to users.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">credentials:
  - username: admin
    password: changeme
  - username: my-user-1
    password: changeme
    roles:
      - admin
  - username: my-user-2
    password: changeme
    roles:
      - monitor</code></pre>
</div>
</div>
</li>
<li>
<p>Delete your existing authentication secret, if necessary, and then create one from <code>identities.yaml</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl create delete secret connect-secret --ignore-not-found
$ kubectl create secret generic --from-file=identities.yaml connect-secret</code></pre>
</div>
</div>
</li>
<li>
<p>If you have not already done so, specify the authentication secret with <code>spec.security.endpointSecretName</code> in your <code>Infinispan</code> CR and then apply the changes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  security:
    endpointSecretName: connect-secret</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="adding-custom-roles-permissions_authorization">7.4. Adding custom roles and permissions</h3>
<div class="paragraph _abstract">
<p>You can define custom roles with different combinations of permissions.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your <code>Infinispan</code> CR for editing.</p>
</li>
<li>
<p>Specify custom roles and their associated permissions with the <code>spec.security.authorization.roles</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  security:
    authorization:
      enabled: true
      roles:
        - name: my-role-1
          permissions:
            - ALL
        - name: my-role-2
          permissions:
            - READ
            - WRITE</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-network">8. Configuring network access to Infinispan</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Expose Infinispan clusters so you can access Infinispan Console, the
Infinispan command line interface (CLI), REST API, and Hot Rod endpoint.</p>
</div>
<div class="sect2">
<h3 id="getting-internal-service_network-services">8.1. Getting the service for internal connections</h3>
<div class="paragraph _abstract">
<p>By default, Infinispan Operator creates a service that provides access to Infinispan clusters from clients running on Kubernetes.</p>
</div>
<div class="paragraph">
<p>This internal service has the same name as your Infinispan cluster, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">metadata:
  name: example-infinispan</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Check that the internal service is available as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get services

NAME               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)
example-infinispan ClusterIP   192.0.2.0        &lt;none&gt;        11222/TCP</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="exposing-loadbalancer_network-services">8.2. Exposing Infinispan through load balancers</h3>
<div class="paragraph _abstract">
<p>Use a load balancer service to make Infinispan clusters available to clients running outside Kubernetes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To access Infinispan with unencrypted Hot Rod client connections you must use
a load balancer service.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Include <code>spec.expose</code> in your <code>Infinispan</code> CR.</p>
</li>
<li>
<p>Specify <code>LoadBalancer</code> as the service type with the <code>spec.expose.type</code> field.</p>
</li>
<li>
<p>Optionally specify a node port to which the load balancer forwards traffic with the <code>spec.expose.nodePort</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  expose:
    type: LoadBalancer
    nodePort: 30000</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
<li>
<p>Verify that the <code>-external</code> service is available.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get services | grep external

NAME                         TYPE            CLUSTER-IP    EXTERNAL-IP   PORT(S)
example-infinispan-external  LoadBalancer    192.0.2.24    hostname.com  11222/TCP</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="exposing-nodeport_network-services">8.3. Exposing Infinispan through node ports</h3>
<div class="paragraph _abstract">
<p>Use a node port service to expose Infinispan clusters on the network.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Include <code>spec.expose</code> in your <code>Infinispan</code> CR.</p>
</li>
<li>
<p>Specify <code>NodePort</code> as the service type with the <code>spec.expose.type</code> field.</p>
</li>
<li>
<p>Define the port where Infinispan is exposed with the <code>spec.expose.nodePort</code> field.</p>
<div class="paragraph">
<p>If you do not set a value for the <code>spec.expose.nodePort</code> field, the platform selects an available port.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  expose:
    type: NodePort
    nodePort: 30000</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
<li>
<p>Verify that the <code>-external</code> service is available.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get services | grep external

NAME                         TYPE            CLUSTER-IP       EXTERNAL-IP   PORT(S)
example-infinispan-external  NodePort        192.0.2.24       &lt;none&gt;        11222:30000/TCP</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="exposing-routes_network-services">8.4. Exposing Infinispan through routes</h3>
<div class="paragraph _abstract">
<p>Use a Kubernetes Ingress or an OpenShift Route with passthrough encryption to
make Infinispan clusters available on the network.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Include <code>spec.expose</code> in your <code>Infinispan</code> CR.</p>
</li>
<li>
<p>Specify <code>Route</code> as the service type with the <code>spec.expose.type</code> field.</p>
</li>
<li>
<p>Optionally add a hostname with the <code>spec.expose.host</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  expose:
    type: Route
    host: www.example.org</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
<li>
<p>Verify that the route is available.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get ingress

NAME                 CLASS    HOSTS   ADDRESS   PORTS   AGE
example-infinispan   &lt;none&gt;   *                 443     73s</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Route ports</div>
<p>When you create a route, it exposes a port on the network that accepts client connections and redirects traffic to Infinispan services that listen on port <code>11222</code>.</p>
</div>
<div class="paragraph">
<p>The port where the route is available depends on whether you use encryption or not.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Port</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>80</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encryption is disabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>443</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encryption is enabled.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="network-services_network-services">8.5. Network services</h3>
<div class="paragraph _abstract">
<p>Reference information for network services that Infinispan Operator creates and manages.</p>
</div>
<div class="sect3">
<h4 id="_internal_service">8.5.1. Internal service</h4>
<div class="ulist">
<ul>
<li>
<p>Allow Infinispan nodes to discover each other and form clusters.</p>
</li>
<li>
<p>Provide access to Infinispan endpoints from clients in the same Kubernetes namespace.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Port</th>
<th class="tableblock halign-left valign-top">Protocol</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>11222</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Internal access to Infinispan endpoints</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-ping</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>8888</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster discovery</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_external_service">8.5.2. External service</h4>
<div class="paragraph">
<p>Provides access to Infinispan endpoints from clients outside Kubernetes or in different namespaces.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You must create the external service with Infinispan Operator. It is not available
by default.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Port</th>
<th class="tableblock halign-left valign-top">Protocol</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-external</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>11222</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">External access to Infinispan endpoints.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_cross_site_service">8.5.3. Cross-site service</h4>
<div class="paragraph">
<p>Allows Infinispan to back up data between clusters in different locations.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Port</th>
<th class="tableblock halign-left valign-top">Protocol</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;cluster_name&gt;-site</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7900</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JGroups RELAY2 channel for cross-site communication.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="monitoring-services">9. Monitoring Infinispan services</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Infinispan exposes metrics that can be used by Prometheus and Grafana for monitoring and visualizing the cluster state.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This documentation explains how to set up monitoring on OpenShift Container Platform.
If you&#8217;re working with community Prometheus deployments, you might find these instructions useful as a general guide.
However you should refer to the Prometheus documentation for installation and usage instructions.</p>
</div>
<div class="paragraph">
<p>See the <a href="https://github.com/prometheus-operator/prometheus-operator">Prometheus Operator</a> documentation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="creating-service-monitor_monitor">9.1. Creating a Prometheus service monitor</h3>
<div class="paragraph _abstract">
<p>Infinispan Operator automatically creates a Prometheus <code>ServiceMonitor</code> that scrapes metrics from your Infinispan cluster.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Enable monitoring for user-defined projects on OpenShift Container Platform.</p>
</div>
<div class="paragraph">
<p>When the <code>ServiceMonitor</code> resource is detected, Infinispan Operator does the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creates a <code>ServiceMonitor</code> named <code>&lt;cluster_name&gt;-monitor</code>.</p>
</li>
<li>
<p>Adds the <code>infinispan.org/monitoring: 'true'</code> annotation to your <code>Infinispan</code> CR:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
  annotations:
    infinispan.org/monitoring: 'true'</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To authenticate with Infinispan, Prometheus uses the <code>operator</code> credentials.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Verification</div>
<p>You can check that Prometheus is scraping Infinispan metrics as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the OpenShift Web Console, select the <strong>&lt;/&gt; Developer</strong> perspective and then select <strong>Monitoring</strong>.</p>
</li>
<li>
<p>Open the <strong>Dashboard</strong> tab for the namespace where your Infinispan cluster runs.</p>
</li>
<li>
<p>Open the <strong>Metrics</strong> tab and confirm that you can query Infinispan metrics such as:</p>
<div class="listingblock">
<div class="content">
<pre>vendor_cache_manager_default_cluster_size</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.7/html-single/monitoring/index#enabling-monitoring-for-user-defined-projects">Enabling monitoring for user-defined projects</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="disabling-service-monitor_monitor">9.1.1. Disabling the Prometheus service monitor</h4>
<div class="paragraph _abstract">
<p>You can disable the <code>ServiceMonitor</code> if you do not want Prometheus to scrape metrics for your Infinispan cluster.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Set <code>'false'</code> as the value for the <code>infinispan.org/monitoring</code> annotation in your <code>Infinispan</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
  annotations:
    infinispan.org/monitoring: 'false'</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-grafana-dashboards_monitor">9.2. Creating Grafana data sources</h3>
<div class="paragraph _abstract">
<p>Create a <code>GrafanaDatasource</code> CR so you can visualize Infinispan metrics in Grafana dashboards.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Have an <code>oc</code> client.</p>
</li>
<li>
<p>Have <code>cluster-admin</code> access to OpenShift Container Platform.</p>
</li>
<li>
<p>Enable monitoring for user-defined projects on OpenShift Container Platform.</p>
</li>
<li>
<p>Install the Grafana Operator from the <strong>alpha</strong> channel and create a <code>Grafana</code> CR.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>ServiceAccount</code> that lets Grafana read Infinispan metrics from Prometheus.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: infinispan-monitoring</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Apply the <code>ServiceAccount</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc apply -f service-account.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Grant <code>cluster-monitoring-view</code> permissions to the <code>ServiceAccount</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc adm policy add-cluster-role-to-user cluster-monitoring-view -z infinispan-monitoring</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create a Grafana data source.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Retrieve the token for the <code>ServiceAccount</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc serviceaccounts get-token infinispan-monitoring

eyJhbGciOiJSUzI1NiIsImtpZCI6Imc4O...</code></pre>
</div>
</div>
</li>
<li>
<p>Define a <code>GrafanaDataSource</code> that includes the token in the <code>spec.datasources.secureJsonData.httpHeaderValue1</code> field, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: integreatly.org/v1alpha1
kind: GrafanaDataSource
metadata:
  name: grafanadatasource
spec:
  name: datasource.yaml
  datasources:
    - access: proxy
      editable: true
      isDefault: true
      jsonData:
        httpHeaderName1: Authorization
        timeInterval: 5s
        tlsSkipVerify: true
      name: Prometheus
      secureJsonData:
        httpHeaderValue1: &gt;-
          Bearer
          eyJhbGciOiJSUzI1NiIsImtpZCI6Imc4O...
      type: prometheus
      url: 'https://thanos-querier.openshift-monitoring.svc.cluster.local:9091'</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Apply the <code>GrafanaDataSource</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc apply -f grafana-datasource.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Next steps</div>
<p>Enable Grafana dashboards with the Infinispan Operator configuration properties.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring-grafana-dashboards_monitor">9.3. Configuring Infinispan dashboards</h3>
<div class="paragraph _abstract">
<p>Infinispan Operator provides global configuration properties that let you configure Grafana dashboards for Infinispan clusters.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can modify global configuration properties while Infinispan Operator is running.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Infinispan Operator must watch the namespace where the Grafana Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>ConfigMap</code> named <code>infinispan-operator-config</code> in the Infinispan Operator namespace.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: infinispan-operator-config
data:
  grafana.dashboard.namespace: example-infinispan
  grafana.dashboard.name: infinispan
  grafana.dashboard.monitoring.key: middleware</code></pre>
</div>
</div>
</li>
<li>
<p>Specify the namespace of your Infinispan cluster with the <code>data.grafana.dashboard.namespace</code> property.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Deleting the value for this property removes the dashboard.
Changing the value moves the dashboard to that namespace.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Specify a name for the dashboard with the <code>data.grafana.dashboard.name</code> property.</p>
</li>
<li>
<p>If necessary, specify a monitoring key with the <code>data.grafana.dashboard.monitoring.key</code> property.</p>
</li>
<li>
<p>Create <code>infinispan-operator-config</code> or update the configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc apply -f infinispan-operator-config.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Open the Grafana UI, which is available at:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc get routes grafana-route -o jsonpath=https://"{.spec.host}"</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up-xsite">10. Setting up cross-site replication</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Ensure service availability with Infinispan Operator by configuring cross-site replication to back up data between Infinispan clusters.</p>
</div>
<div class="sect2">
<h3 id="cross-site-replication_cross-site">10.1. Using Infinispan Operator to manage cross-site connections</h3>
<div class="paragraph _abstract">
<p>Infinispan Operator in one data center can discover a Infinispan cluster that Infinispan Operator manages in another data center.
This discovery allows Infinispan to automatically form cross-site views and create global clusters.</p>
</div>
<div class="paragraph">
<p>The following illustration provides an example in which Infinispan Operator manages a Infinispan cluster at a data center in New York City, <strong>NYC</strong>.
At another data center in London, <strong>LON</strong>, Infinispan Operator also manages a Infinispan cluster.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../topics/images/xsite-ispn.svg" alt="xsite ispn">
</div>
</div>
<div class="paragraph">
<p>Infinispan Operator uses the Kubernetes API to establish a secure connection between the OpenShift Container Platform clusters in <strong>NYC</strong> and <strong>LON</strong>.
Infinispan Operator then creates a cross-site replication service so Infinispan clusters can back up data across locations.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan Operator in each OpenShift cluster must have network access to the remote Kubernetes API.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you configure automatic connections, Infinispan clusters do not start running until Infinispan Operator discovers all backup locations in the configuration.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each Infinispan cluster has one site master node that coordinates all backup requests.
Infinispan Operator identifies the site master node so that all traffic through the cross-site replication service goes to the site master.</p>
</div>
<div class="paragraph">
<p>If the current site master node goes offline then a new node becomes site master.
Infinispan Operator automatically finds the new site master node and updates the cross-site replication service to forward backup requests to it.</p>
</div>
<div class="sect3">
<h4 id="_kubernetes_clusters">10.1.1. Kubernetes clusters</h4>
<div class="paragraph">
<p>Apply cluster roles and then create site access secrets if you run Infinispan Operator on vanilla Kubernetes or minikube.</p>
</div>
<div class="sect4">
<h5 id="applying-cluster-roles-xsite_cross-site">Applying cluster roles for cross-site replication</h5>
<div class="paragraph _abstract">
<p>During OLM installation, Infinispan Operator sets up cluster roles required for cross-site replication.
If you install Infinispan Operator manually, you must complete this procedure to set up those cluster roles.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Install <code>clusterrole.yaml</code> and <code>clusterrole_binding.yaml</code> as follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f deploy/clusterrole.yaml
$ kubectl apply -f deploy/clusterrole_binding.yaml</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="creating-kubernetes-secrets_cross-site">Creating Kubernetes site access secrets</h5>
<div class="paragraph _abstract">
<p>If you run Infinispan Operator in any Kubernetes deployment (Minikube, Kind, etc.), you should create secrets that contain the files that allow Kubernetes clusters to authenticate with each other.</p>
</div>
<div class="paragraph">
<p>Do one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Retrieve service account tokens from each site and then add them to secrets on each backup location, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl create serviceaccount site-a -n ns-site-a
$ kubectl create clusterrole xsite-cluster-role --verb=get,list,watch --resource=nodes,services
$ kubectl create clusterrolebinding xsite-cluster-role-binding --clusterrole=xsite-cluster-role --serviceaccount=ns-site-a:site-a
$ TOKENNAME=kubectl get serviceaccount/site-a -o jsonpath='{.secrets[0].name}' -n ns-site-a
$ TOKEN=kubectl get secret $TOKENNAME -o jsonpath='{.data.token}' -n ns-site-a | base64 --decode
$ kubectl create secret generic site-a-secret -n ns-site-a --from-literal=token=$TOKEN</code></pre>
</div>
</div>
</li>
<li>
<p>Create secrets on each site that contain <code>ca.crt</code>, <code>client.crt</code>, and <code>client.key</code> from your Kubernetes installation.</p>
<div class="paragraph">
<p>For example, for Minikube do the following on <strong>LON</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl create secret generic site-a-secret \
    --from-file=certificate-authority=/opt/minikube/.minikube/ca.crt \
    --from-file=client-certificate=/opt/minikube/.minikube/client.crt \
    --from-file=client-key=/opt/minikube/.minikube/client.key</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/access-cluster-api/">Access Clusters Using the Kubernetes API</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_openshift_clusters">10.1.2. OpenShift clusters</h4>
<div class="paragraph">
<p>Create and exchange service account tokens if you run Infinispan Operator on OpenShift.</p>
</div>
<div class="sect4">
<h5 id="creating-sa-tokens_cross-site">Creating service account tokens</h5>
<div class="paragraph _abstract">
<p>Generate service account tokens on each OpenShift cluster that acts as a backup location.
Clusters use these tokens to authenticate with each other so Infinispan Operator can create a cross-site replication service.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to an OpenShift cluster.</p>
</li>
<li>
<p>Create a service account.</p>
<div class="paragraph">
<p>For example, create a service account at <strong>LON</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc create sa lon
serviceaccount/lon created</code></pre>
</div>
</div>
</li>
<li>
<p>Add the view role to the service account with the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc policy add-role-to-user view system:serviceaccount:&lt;namespace&gt;:lon</code></pre>
</div>
</div>
</li>
<li>
<p>If you use a node port service to expose Infinispan clusters on the network, you must also add the <code>cluster-reader</code> role to the service account:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc adm policy add-cluster-role-to-user cluster-reader -z &lt;service-account-name&gt; -n &lt;namespace&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Repeat the preceding steps on your other OpenShift clusters.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.openshift.com/container-platform/4.7/authentication/using-service-accounts-in-applications.html">Using service accounts in applications</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="exchanging-sa-tokens_cross-site">Exchanging service account tokens</h5>
<div class="paragraph _abstract">
<p>After you create service account tokens on your OpenShift clusters, you
add them to secrets on each backup location. For example, at <strong>LON</strong> you add
the service account token for <strong>NYC</strong>. At <strong>NYC</strong> you add the service account
token for <strong>LON</strong>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Get tokens from each service account.</p>
<div class="paragraph">
<p>Use the following command or get the token from the OpenShift Web Console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc sa get-token lon

eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9...</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to an OpenShift cluster.</p>
</li>
<li>
<p>Add the service account token for a backup location with the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc create secret generic &lt;token-name&gt; --from-literal=token=&lt;token&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, log in to the OpenShift cluster at <strong>NYC</strong> and create a <code>lon-token</code> secret as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ oc create secret generic lon-token --from-literal=token=eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9...</code></pre>
</div>
</div>
</li>
<li>
<p>Repeat the preceding steps on your other OpenShift clusters.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-sites-automatically_cross-site">10.1.3. Configuring Infinispan Operator to handle cross-site connections</h4>
<div class="paragraph _abstract">
<p>Configure Infinispan Operator to establish cross-site views with Infinispan clusters.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create secrets that contain service account tokens for each backup location.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an <code>Infinispan</code> CR for each Infinispan cluster.</p>
</li>
<li>
<p>Specify the name of the local site with <code>spec.service.sites.local.name</code>.</p>
</li>
<li>
<p>Provide the name, URL, and secret for each Infinispan cluster that acts as a backup location with <code>spec.service.sites.locations</code>.</p>
</li>
<li>
<p>If Infinispan cluster names or namespaces at the remote site do not match the local site, specify those values with the <code>clusterName</code> and <code>namespace</code> fields.</p>
<div class="paragraph">
<p>The following are example <code>Infinispan</code> CR definitions for <strong>LON</strong> and <strong>NYC</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>LON</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 3
  service:
    type: DataGrid
    sites:
      local:
        name: LON
        expose:
          type: LoadBalancer
      locations:
        - name: NYC
          clusterName: &lt;nyc_cluster_name&gt;
          namespace: &lt;nyc_cluster_namespace&gt;
          url: openshift://api.rhdg-nyc.openshift-aws.myhost.com:6443
          secretName: nyc-token
  logging:
    categories:
      org.jgroups.protocols.TCP: error
      org.jgroups.protocols.relay.RELAY2: error</code></pre>
</div>
</div>
</li>
<li>
<p><strong>NYC</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: nyc-cluster
spec:
  replicas: 2
  service:
    type: DataGrid
    sites:
      local:
        name: NYC
        expose:
          type: LoadBalancer
      locations:
        - name: LON
          clusterName: example-infinispan
          namespace: ispn-namespace
          url: openshift://api.rhdg-lon.openshift-aws.myhost.com:6443
          secretName: lon-token
  logging:
    categories:
      org.jgroups.protocols.TCP: error
      org.jgroups.protocols.relay.RELAY2: error</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Be sure to adjust logging categories in your <code>Infinispan</code> CR to decrease log levels for JGroups TCP and RELAY2 protocols.
This prevents a large number of log files from uses container storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  logging:
    categories:
      org.jgroups.protocols.TCP: error
      org.jgroups.protocols.relay.RELAY2: error</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Configure your <code>Infinispan</code> CRs with any other Data Grid Service resources and then apply the changes.</p>
</li>
<li>
<p>Verify that Infinispan clusters form a cross-site view.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Retrieve the <code>Infinispan</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get infinispan -o yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check for the <code>type: CrossSiteViewFormed</code> condition.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Next steps</div>
<p>If your clusters have formed a cross-site view, you can start adding backup
locations to caches.</p>
</div>
</div>
<div class="sect3">
<h4 id="cross-site-resources-automatic_cross-site">10.1.4. Resources for managed cross-site connections</h4>
<div class="paragraph _abstract">
<p>This topic describes resources for cross-site connections that Infinispan Operator manages.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  service:
    type: DataGrid
    sites:
      local:
        name: LON
        expose:
          type: LoadBalancer
      locations:
      - name: NYC
        clusterName: &lt;nyc_cluster_name&gt;
        namespace: &lt;nyc_cluster_namespace&gt;
        url: openshift://api.site-b.devcluster.openshift.com:6443
        secretName: nyc-token</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.type: DataGrid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan supports cross-site replication with Data Grid Service clusters only.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.local.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Names the local site where a Infinispan cluster runs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.local.expose.type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the externally exposed service type. Use <code>NodePort</code> for local clusters on the same network. Use <code>LoadBalancer</code> for independent OpenShift clusters.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.locations</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides connection information for all backup locations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.locations.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a backup location that matches <code>.spec.service.sites.local.name</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.locations.url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a backup location.</p>
<p class="tableblock">Use <code>kubernetes://</code> if the backup location is a Kubernetes instance.</p>
<p class="tableblock">Use <code>openshift://</code> if the backup location is an OpenShift cluster. You should specify the URL of the Kubernetes API.</p>
<p class="tableblock">Use <code>infinispan+xsite://</code> if the backup location has a static hostname and port.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.locations.secretName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the access secret for a site. This secret contains different authentication objects, depending on your Kubernetes environment.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.locations.clusterName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the cluster name at the backup location if it is different to the cluster name at the local site.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.locations.namespace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the namespace of the Infinispan cluster at the backup location if it does not match the namespace at the local site.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="manual-xsite-views_cross-site">10.2. Manually connecting Infinispan clusters</h3>
<div class="paragraph _abstract">
<p>You can specify static network connection details to perform cross-site replication with Infinispan clusters running outside Kubernetes.
Manual cross-site connections are necessary in any scenario where access to the Kubernetes API is not available outside the Kubernetes cluster where Infinispan runs.</p>
</div>
<div class="paragraph">
<p>You can use both automatic and manual connections for Infinispan clusters in the same <code>Infinispan</code> CR.
However, you must ensure that Infinispan clusters establish connections in the same way at each site.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>Manually connecting Infinispan clusters to form cross-site views requires predictable network locations for Infinispan services.</p>
</div>
<div class="paragraph">
<p>You need to know the network locations before they are created, which requires you to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Have the host names and ports for each Infinispan cluster that you plan to configure as a backup location.</p>
</li>
<li>
<p>Have the host name of the <code>&lt;cluster-name&gt;-site</code> service for any remote Infinispan cluster that is running on Kubernetes.<br>
You must use the <code>&lt;cluster-name&gt;-site</code> service to form a cross-site view between a cluster that Infinispan Operator manages and any other cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an <code>Infinispan</code> CR for each Infinispan cluster.</p>
</li>
<li>
<p>Specify the name of the local site with <code>spec.service.sites.local.name</code>.</p>
</li>
<li>
<p>Provide the name and static URL for each Infinispan cluster that acts as a backup location with <code>spec.service.sites.locations</code>, for example:</p>
<div class="ulist">
<ul>
<li>
<p><strong>LON</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 3
  service:
    type: DataGrid
    sites:
      local:
        name: LON
        expose:
          type: LoadBalancer
      locations:
        - name: NYC
          url: infinispan+xsite://infinispan-nyc.myhost.com:7900
  logging:
    categories:
      org.jgroups.protocols.TCP: error
      org.jgroups.protocols.relay.RELAY2: error</code></pre>
</div>
</div>
</li>
<li>
<p><strong>NYC</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 2
  service:
    type: DataGrid
    sites:
      local:
        name: NYC
        expose:
          type: LoadBalancer
      locations:
        - name: LON
          url: infinispan+xsite://infinispan-lon.myhost.com
  logging:
    categories:
      org.jgroups.protocols.TCP: error
      org.jgroups.protocols.relay.RELAY2: error</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Be sure to adjust logging categories in your <code>Infinispan</code> CR to decrease log levels for JGroups TCP and RELAY2 protocols.
This prevents a large number of log files from uses container storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  logging:
    categories:
      org.jgroups.protocols.TCP: error
      org.jgroups.protocols.relay.RELAY2: error</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Configure your <code>Infinispan</code> CRs with any other Data Grid Service resources and then apply the changes.</p>
</li>
<li>
<p>Verify that Infinispan clusters form a cross-site view.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Retrieve the <code>Infinispan</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get infinispan -o yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check for the <code>type: CrossSiteViewFormed</code> condition.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Next steps</div>
<p>If your clusters have formed a cross-site view, you can start adding backup
locations to caches.</p>
</div>
<div class="sect3">
<h4 id="cross-site-resources-manual_cross-site">10.2.1. Resources for manual cross-site connections</h4>
<div class="paragraph _abstract">
<p>This topic describes resources for cross-site connections that you maintain manually.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  service:
    type: DataGrid
    sites:
      local:
        name: LON
        expose:
          type: LoadBalancer
      locations:
      - name: NYC
        url: infinispan+xsite://infinispan-nyc.myhost.com:7900</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.type: DataGrid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan supports cross-site replication with Data Grid Service clusters only.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.local.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Names the local site where a Infinispan cluster runs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.local.expose.type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the externally exposed service type. Use <code>NodePort</code> for local clusters on the same network. Use <code>LoadBalancer</code> for independent OpenShift clusters.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.locations</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides connection information for all backup locations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.locations.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a backup location that matches <code>.spec.service.sites.local.name</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>service.sites.locations.url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the static URL for the backup location in the format of <code>infinispan+xsite://&lt;hostname&gt;:&lt;port&gt;</code>. The default port is <code>7900</code>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configuring-sites-in-clusters_cross-site">10.3. Configuring sites in the same Kubernetes cluster</h3>
<div class="paragraph _abstract">
<p>For evaluation and demonstration purposes, you can configure Infinispan to back up between nodes in the same Kubernetes cluster.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an <code>Infinispan</code> CR for each Infinispan cluster.</p>
</li>
<li>
<p>Specify the name of the local site with <code>spec.service.sites.local.name</code>.</p>
</li>
<li>
<p>Set <code>ClusterIP</code> as the value of the <code>spec.service.sites.local.expose.type</code> field.</p>
</li>
<li>
<p>Provide the name of the Infinispan cluster that acts as a backup location with <code>spec.service.sites.locations.clusterName</code>.</p>
</li>
<li>
<p>If both Infinispan clusters have the same name, specify the namespace of the backup location with <code>spec.service.sites.locations.namespace</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-clustera
spec:
  replicas: 1
  expose:
    type: LoadBalancer
  service:
    type: DataGrid
    sites:
      local:
        name: SiteA
        expose:
          type: ClusterIP
      locations:
        - name: SiteB
          clusterName: example-clusterb
          namespace: cluster-namespace</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your <code>Infinispan</code> CRs with any other Data Grid Service resources and then apply the changes.</p>
</li>
<li>
<p>Verify that Infinispan clusters form a cross-site view.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Retrieve the <code>Infinispan</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl get infinispan -o yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check for the <code>type: CrossSiteViewFormed</code> condition.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="anti-affinity">11. Guaranteeing availability with anti-affinity</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Kubernetes includes anti-affinity capabilities that protect workloads from single points of failure.</p>
</div>
<div class="sect2">
<h3 id="anti-affinity_availability">11.1. Anti-affinity strategies</h3>
<div class="paragraph _abstract">
<p>Each Infinispan node in a cluster runs in a pod that runs on an Kubernetes node in a cluster.
Each Red Hat OpenShift node runs on a physical host system.
Anti-affinity works by distributing Infinispan nodes across Kubernetes nodes, ensuring that your Infinispan clusters remain available even if hardware failures occur.</p>
</div>
<div class="paragraph">
<p>Infinispan Operator offers two anti-affinity strategies:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>kubernetes.io/hostname</code></dt>
<dd>
<p>Infinispan replica pods are scheduled on different Kubernetes nodes.</p>
</dd>
<dt class="hdlist1"><code>topology.kubernetes.io/zone</code></dt>
<dd>
<p>Infinispan replica pods are scheduled across multiple zones.</p>
</dd>
</dl>
</div>
<h4 id="_fault_tolerance" class="discrete">Fault tolerance</h4>
<div class="paragraph">
<p>Anti-affinity strategies guarantee cluster availability in different ways.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The equations in the following section apply only if the number of Kubernetes nodes or zones is greater than the number of Infinispan nodes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Scheduling pods on different Kubernetes nodes</div>
<p>Provides tolerance of <code>x</code> node failures for the following types of cache:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replicated: <code>x = spec.replicas - 1</code></p>
</li>
<li>
<p>Distributed: <code>x = num_owners - 1</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Scheduling pods across multiple zones</div>
<p>Provides tolerance of <code>x</code> zone failures when <code>x</code> zones exist for the following types of cache:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replicated: <code>x = spec.replicas - 1</code></p>
</li>
<li>
<p>Distributed: <code>x = num_owners - 1</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="dlist">
<dl>
<dt class="hdlist1"><code>spec.replicas</code></dt>
<dd>
<p>Defines the number of pods in each Infinispan cluster.</p>
</dd>
<dt class="hdlist1"><code>num_owners</code></dt>
<dd>
<p>Is the cache configuration attribute that defines the number of replicas for each entry in the cache.</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configuring_anti_affinity-availability">11.2. Configuring anti-affinity</h3>
<div class="paragraph _abstract">
<p>Specify where Kubernetes schedules pods for your Infinispan clusters to ensure availability.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the <code>spec.affinity</code> block to your <code>Infinispan</code> CR.</p>
</li>
<li>
<p>Configure anti-affinity strategies as necessary.</p>
</li>
<li>
<p>Apply your <code>Infinispan</code> CR.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="anti-affinity-strategies_availability">11.2.1. Anti-affinity strategy configurations</h4>
<div class="paragraph _abstract">
<p>Configure anti-affinity strategies in your <code>Infinispan</code> CR to control where Kubernetes schedules Infinispan replica pods.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Topology keys</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topologyKey: "topology.kubernetes.io/zone"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Schedules Infinispan replica pods across multiple zones.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topologyKey: "kubernetes.io/hostname"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Schedules Infinispan replica pods on different Kubernetes nodes.</p></td>
</tr>
</tbody>
</table>
<h5 id="_schedule_pods_on_different_kubernetes_nodes" class="discrete">Schedule pods on different Kubernetes nodes</h5>
<div class="paragraph">
<p>The following is the anti-affinity strategy that Infinispan Operator uses if you do not configure the <code>spec.affinity</code> field in your <code>Infinispan</code> CR:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app: infinispan-pod
              clusterName: &lt;cluster_name&gt;
              infinispan_cr: &lt;cluster_name&gt;
          topologyKey: "kubernetes.io/hostname"</code></pre>
</div>
</div>
<h6 id="_requiring_different_nodes" class="discrete">Requiring different nodes</h6>
<div class="paragraph">
<p>In the following example, Kubernetes does not schedule Infinispan pods if different nodes are not available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchLabels:
            app: infinispan-pod
            clusterName: &lt;cluster_name&gt;
            infinispan_cr: &lt;cluster_name&gt;
        topologyKey: "topology.kubernetes.io/hostname"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To ensure that you can schedule Infinispan replica pods on different Kubernetes nodes, the number of Kubernetes nodes available must be greater than the value of <code>spec.replicas</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="_schedule_pods_across_multiple_kubernetes_zones" class="discrete">Schedule pods across multiple Kubernetes zones</h5>
<div class="paragraph">
<p>The following example prefers multiple zones when scheduling pods but schedules Infinispan replica pods on different Kubernetes nodes if it is not possible to schedule across zones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app: infinispan-pod
              clusterName: &lt;cluster_name&gt;
              infinispan_cr: &lt;cluster_name&gt;
          topologyKey: "topology.kubernetes.io/zone"
      - weight: 90
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app: infinispan-pod
              clusterName: &lt;cluster_name&gt;
              infinispan_cr: &lt;cluster_name&gt;
          topologyKey: "kubernetes.io/hostname"</code></pre>
</div>
</div>
<h6 id="_requiring_multiple_zones" class="discrete">Requiring multiple zones</h6>
<div class="paragraph">
<p>The following example uses the zone strategy only when scheduling Infinispan replica pods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchLabels:
            app: infinispan-pod
            clusterName: &lt;cluster_name&gt;
            infinispan_cr: &lt;cluster_name&gt;
        topologyKey: "topology.kubernetes.io/zone"</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cache-cr">12. Creating caches with Infinispan Operator</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Use <code>Cache</code> CRs to add cache configuration with Infinispan Operator and control how Infinispan stores your data.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>Cache</code> CR is not yet functionally complete.
The capability to create caches with Infinispan Operator is still under development and not recommended for production environments or critical workloads.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="caches_cache-cr">12.1. Infinispan caches</h3>
<div class="paragraph _abstract">
<p>Cache configuration defines the characteristics and features of the data store and must be valid with the Infinispan schema.
Infinispan recommends creating standalone files in XML or JSON format that define your cache configuration.
You should separate Infinispan configuration from application code for easier validation and to avoid the situation where you need to maintain XML snippets in Java or some other client language.</p>
</div>
<div class="paragraph">
<p>To create caches with Infinispan clusters running on Kubernetes, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>Cache</code> CR as the mechanism for creating caches through the Kubernetes front end.</p>
</li>
<li>
<p>Use <code>Batch</code> CR to create multiple caches at a time from standalone configuration files.</p>
</li>
<li>
<p>Access Infinispan Console and create caches in XML or JSON format.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use Hot Rod or HTTP clients but Infinispan recommends <code>Cache</code> CR or <code>Batch</code> CR unless your specific use case requires programmatic remote cache creation.</p>
</div>
</div>
<div class="sect2">
<h3 id="cache-cr_cache-cr">12.2. Cache CRs</h3>
<div class="paragraph _abstract">
<p>Find out details for configuring Infinispan caches with <code>Cache</code> CR.</p>
</div>
<div class="paragraph">
<p>When using <code>Cache</code> CRs, the following rules apply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Cache</code> CRs apply to Data Grid Service nodes only.</p>
</li>
<li>
<p>You can create a single cache for each <code>Cache</code> CR.</p>
</li>
<li>
<p>If your <code>Cache</code> CR contains both a template and an XML configuration, Infinispan Operator uses the template.</p>
</li>
<li>
<p>If you edit caches in the OpenShift Web Console, the changes are reflected through the user interface but do not take effect on the Infinispan cluster. You cannot edit caches. To change cache configuration, you must first delete the cache through the console or CLI and then re-create the cache.</p>
</li>
<li>
<p>Deleting <code>Cache</code> CRs in the OpenShift Web Console does not remove caches from Infinispan clusters. You must delete caches through the console or CLI.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In previous versions, you need to add credentials to a secret so that Infinispan Operator can access your cluster when creating caches.</p>
</div>
<div class="paragraph">
<p>That is no longer necessary.
Infinispan Operator uses the <strong>operator</strong> user and corresponding password to perform cache operations.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="creating-caches-xml_cache-cr">12.3. Creating caches from XML</h3>
<div class="paragraph _abstract">
<p>Complete the following steps to create caches on Data Grid Service clusters using valid <code>infinispan.xml</code> configuration.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>Cache</code> CR that contains an XML cache configuration.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify a name for the <code>Cache</code> CR with the <code>metadata.name</code> field.</p>
</li>
<li>
<p>Specify the target Infinispan cluster with the <code>spec.clusterName</code> field.</p>
</li>
<li>
<p>Name your cache with the <code>spec.name</code> field.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>name</code> attribute in the XML configuration is ignored.
Only the <code>spec.name</code> field applies to the resulting cache.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add an XML cache configuration with the <code>spec.template</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: infinispan.org/v2alpha1
kind: Cache
metadata:
  name: mycachedefinition
spec:
  clusterName: example-infinispan
  name: mycache
  template: &lt;distributed-cache name="mycache" mode="SYNC"&gt;&lt;persistence&gt;&lt;file-store/&gt;&lt;/persistence&gt;&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Apply the <code>Cache</code> CR, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f mycache.yaml
cache.infinispan.org/mycachedefinition created</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-caches-templates_cache-cr">12.4. Creating caches from templates</h3>
<div class="paragraph _abstract">
<p>Complete the following steps to create caches on Data Grid Service clusters using cache templates.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Identify the cache template you want to use for your cache.<br>
You can find a list of available templates in Infinispan Console.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>Cache</code> CR that specifies the name of a template to use.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify a name for the <code>Cache</code> CR with the <code>metadata.name</code> field.</p>
</li>
<li>
<p>Specify the target Infinispan cluster with the <code>spec.clusterName</code> field.</p>
</li>
<li>
<p>Name your cache with the <code>spec.name</code> field.</p>
</li>
<li>
<p>Specify a cache template with the <code>spec.template</code> field.</p>
<div class="paragraph">
<p>The following example creates a cache named "mycache" from the <code>org.infinispan.DIST_SYNC</code> cache template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: infinispan.org/v2alpha1
kind: Cache
metadata:
  name: mycachedefinition
spec:
  clusterName: example-infinispan
  name: mycache
  templateName: org.infinispan.DIST_SYNC</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Apply the <code>Cache</code> CR, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f mycache.yaml
cache.infinispan.org/mycachedefinition created</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="adding-backup-locations_cache-cr">12.5. Adding backup locations to caches</h3>
<div class="paragraph _abstract">
<p>When you configure Infinispan clusters to perform cross-site replication, you
can add backup locations to your cache configurations.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create cache configurations that name remote sites as backup locations.</p>
<div class="paragraph">
<p>Infinispan replicates data based on cache names.
For this reason, site names in your cache configurations must match site names, <code>spec.service.sites.local.name</code>, in your <code>Infinispan</code> CRs.</p>
</div>
</li>
<li>
<p>Configure backup locations to go offline automatically with the <code>take-offline</code> element.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Set the amount of time, in milliseconds, before backup locations go offline with the <code>min-wait</code> attribute.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Define any other valid cache configuration.</p>
</li>
<li>
<p>Add backup locations to the named cache on all sites in the global cluster.</p>
<div class="paragraph">
<p>For example, if you add <strong>LON</strong> as a backup for <strong>NYC</strong> you should add <strong>NYC</strong>
as a backup for <strong>LON</strong>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following configuration examples show backup locations for caches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>NYC</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache name="customers"&gt;
  &lt;encoding media-type="application/x-protostream"/&gt;
  &lt;backups&gt;
    &lt;backup site="LON" strategy="SYNC"&gt;
      &lt;take-offline min-wait="120000"/&gt;
    &lt;/backup&gt;
  &lt;/backups&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
</li>
<li>
<p><strong>LON</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;replicated-cache name="customers"&gt;
  &lt;encoding media-type="application/x-protostream"/&gt;
  &lt;backups&gt;
    &lt;backup site="NYC" strategy="ASYNC" &gt;
      &lt;take-offline min-wait="120000"/&gt;
    &lt;/backup&gt;
  &lt;/backups&gt;
&lt;/replicated-cache&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://infinispan.org/docs/stable/titles/xsite/xsite.html">Infinispan Guide to Cross-Site Replication</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="backups-automatic-offline_cache-cr">12.5.1. Performance considerations with taking backup locations offline</h4>
<div class="paragraph _abstract">
<p>Backup locations can automatically go offline when remote sites become
unavailable. This prevents nodes from attempting to replicate data to offline
backup locations, which can have a performance impact on your cluster because it
results in error.</p>
</div>
<div class="paragraph">
<p>You can configure how long to wait before backup locations go offline. A good
rule of thumb is one or two minutes. However, you should test different wait
periods and evaluate their performance impacts to determine the correct value
for your deployment.</p>
</div>
<div class="paragraph">
<p>For instance when OpenShift terminates the site master pod, that backup
location becomes unavailable for a short period of time until Infinispan Operator
elects a new site master. In this case, if the minimum wait time is not long
enough then the backup locations go offline. You then need to bring those
backup locations online and perform state transfer operations to ensure the
data is in sync.</p>
</div>
<div class="paragraph">
<p>Likewise, if the minimum wait time is too long, node CPU usage increases from
failed backup attempts which can lead to performance degradation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-cache-stores_cache-cr">12.6. Adding persistent cache stores</h3>
<div class="paragraph _abstract">
<p>You can add persistent cache stores to Data Grid Service nodes to save data to the persistent volume.</p>
</div>
<div class="paragraph">
<p>Infinispan creates a Single File cache store, <code>.dat</code> file, in the <code>/opt/infinispan/server/data</code> directory.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Add the <code>&lt;file-store/&gt;</code> element to the <code>persistence</code> configuration in your Infinispan cache, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache name="persistent-cache" mode="SYNC"&gt;
  &lt;encoding media-type="application/x-protostream"/&gt;
  &lt;persistence&gt;
    &lt;file-store/&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="batch-cr">13. Running batch operations</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Infinispan Operator provides a <code>Batch</code> CR that lets you create Infinispan resources in bulk.
<code>Batch</code> CR uses the Infinispan command line interface (CLI) in batch mode to carry out sequences of operations.</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Modifying a <code>Batch</code> CR instance has no effect.
Batch operations are "one-time" events that modify Infinispan resources.
To update <code>.spec</code> fields for the CR, or when a batch operation fails, you must create a new instance of the <code>Batch</code> CR.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>+
:leveloffset: +1</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="batching-inline_batch">14. Running inline batch operations</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Include your batch operations directly in a <code>Batch</code> CR if they do not require separate configuration artifacts.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>Batch</code> CR.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify the name of the Infinispan cluster where you want the batch operations to run as the value of the <code>spec.cluster</code> field.</p>
</li>
<li>
<p>Add each CLI command to run on a line in the <code>spec.config</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v2alpha1
kind: Batch
metadata:
  name: mybatch
spec:
  cluster: example-infinispan
  config: |
    create cache --template=org.infinispan.DIST_SYNC mycache
    put --cache=mycache hello world
    put --cache=mycache hola mundo</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Apply your <code>Batch</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f mybatch.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check the <code>status.Phase</code> field in the <code>Batch</code> CR to verify the operations completed successfully.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="batching-create-configmap_batch">14.1. Creating ConfigMaps for batch operations</h3>
<div class="paragraph _abstract">
<p>Create a <code>ConfigMap</code> so that additional files, such as Infinispan cache configuration, are available for batch operations.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>For demonstration purposes, you should add some configuration artifacts to your host filesystem before you start the procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a <code>/tmp/mybatch</code> directory where you can add some files.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ mkdir -p /tmp/mybatch</code></pre>
</div>
</div>
</li>
<li>
<p>Create a Infinispan cache configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ cat &gt; /tmp/mybatch/mycache.xml&lt;&lt;EOF
&lt;distributed-cache name="mycache" mode="SYNC"&gt;
  &lt;encoding media-type="application/x-protostream"/&gt;
  &lt;memory max-count="1000000" when-full="REMOVE"/&gt;
&lt;/distributed-cache&gt;
EOF</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>batch</code> file that contains all commands you want to run.</p>
<div class="paragraph">
<p>For example, the following <code>batch</code> file creates a cache named "mycache" and adds two entries to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">create cache mycache --file=/etc/batch/mycache.xml
put --cache=mycache hello world
put --cache=mycache hola mundo</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>ConfigMap</code> is mounted in Infinispan pods at <code>/etc/batch</code>.
You must prepend all <code>--file=</code> directives in your batch operations with that path.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Ensure all configuration artifacts that your batch operations require are in the same directory as the <code>batch</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ ls /tmp/mybatch

batch
mycache.xml</code></pre>
</div>
</div>
</li>
<li>
<p>Create a <code>ConfigMap</code> from the directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl create configmap mybatch-config-map --from-file=/tmp/mybatch</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="batching-configmap_batch">14.2. Running batch operations with ConfigMaps</h3>
<div class="paragraph _abstract">
<p>Run batch operations that include configuration artifacts.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a <code>ConfigMap</code> that contains any files your batch operations require.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>Batch</code> CR that specifies the name of a Infinispan cluster as the value of the <code>spec.cluster</code> field.</p>
</li>
<li>
<p>Set the name of the <code>ConfigMap</code> that contains your <code>batch</code> file and configuration artifacts with the <code>spec.configMap</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">$ cat &gt; mybatch.yaml&lt;&lt;EOF
apiVersion: infinispan.org/v2alpha1
kind: Batch
metadata:
  name: mybatch
spec:
  cluster: example-infinispan
  configMap: mybatch-config-map
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Apply your <code>Batch</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f mybatch.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check the <code>status.Phase</code> field in the <code>Batch</code> CR to verify the operations completed successfully.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="batch-status_batch">14.3. Batch status messages</h3>
<div class="paragraph _abstract">
<p>Verify and troubleshoot batch operations with the <code>status.Phase</code> field in the <code>Batch</code> CR.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Phase</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Succeeded</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All batch operations have completed successfully.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Initializing</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch operations are queued and resources are initializing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Initialized</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch operations are ready to start.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Running</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch operations are in progress.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Failed</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more batch operations were not successful.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Failed operations</div>
<p>Batch operations are not atomic.
If a command in a batch script fails, it does not affect the other operations or cause them to rollback.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If your batch operations have any server or syntax errors, you can view log messages in the <code>Batch</code> CR in the <code>status.Reason</code> field.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="batch-operations_batch">14.4. Example batch operations</h3>
<div class="paragraph _abstract">
<p>Use these example batch operations as starting points for creating and modifying Infinispan resources with the <code>Batch</code> CR.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can pass configuration files to Infinispan Operator only via a <code>ConfigMap</code>.</p>
</div>
<div class="paragraph">
<p>The <code>ConfigMap</code> is mounted in Infinispan pods at <code>/etc/batch</code> so you must prepend all <code>--file=</code> directives with that path.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_caches">14.4.1. Caches</h4>
<div class="ulist">
<ul>
<li>
<p>Create multiple caches from configuration files.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-sh" data-lang="sh">echo "creating caches..."
create cache sessions --file=/etc/batch/infinispan-prod-sessions.xml
create cache tokens --file=/etc/batch/infinispan-prod-tokens.xml
create cache people --file=/etc/batch/infinispan-prod-people.xml
create cache books --file=/etc/batch/infinispan-prod-books.xml
create cache authors --file=/etc/batch/infinispan-prod-authors.xml
echo "list caches in the cluster"
ls caches</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a template from a file and then create caches from the template.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-sh" data-lang="sh">echo "creating caches..."
create cache mytemplate --file=/etc/batch/mycache.xml
create cache sessions --template=mytemplate
create cache tokens --template=mytemplate
echo "list caches in the cluster"
ls caches</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_counters">14.4.2. Counters</h4>
<div class="paragraph">
<p>Use the <code>Batch</code> CR to create multiple counters that can increment and decrement to record the count of objects.</p>
</div>
<div class="paragraph">
<p>You can use counters to generate identifiers, act as rate limiters, or track the number of times a resource is accessed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-sh" data-lang="sh">echo "creating counters..."
create counter --concurrency-level=1 --initial-value=5 --storage=PERSISTENT --type=weak mycounter1
create counter --initial-value=3 --storage=PERSISTENT --type=strong mycounter2
create counter --initial-value=13 --storage=PERSISTENT --type=strong --upper-bound=10 mycounter3
echo "list counters in the cluster"
ls counters</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_protobuf_schema">14.4.3. Protobuf schema</h4>
<div class="paragraph">
<p>Register Protobuf schema to query values in caches.
Protobuf schema (<code>.proto</code> files) provide metadata about custom entities and controls field indexing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-sh" data-lang="sh">echo "creating schema..."
schema --upload=person.proto person.proto
schema --upload=book.proto book.proto
schema --upload=author.proto book.proto
echo "list Protobuf schema"
ls schemas</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tasks">14.4.4. Tasks</h4>
<div class="paragraph">
<p>Upload tasks that implement <code>org.infinispan.tasks.ServerTask</code> or scripts that are compatible with the <code>javax.script</code> scripting API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-sh" data-lang="sh">echo "creating tasks..."
task upload --file=/etc/batch/myfirstscript.js myfirstscript
task upload --file=/etc/batch/mysecondscript.js mysecondscript
task upload --file=/etc/batch/mythirdscript.js mythirdscript
echo "list tasks"
ls tasks</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://infinispan.org/docs/stable/titles/cli/cli.html">Infinispan CLI Guide</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="backing-up-restoring">15. Backing up and restoring Infinispan clusters</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Infinispan Operator watches for custom resources (CR) that let you back up and restore Infinispan cluster state for disaster recovery or when migrating between Infinispan versions.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>Backup</code> CR</dt>
<dd>
<p>Archives Infinispan cluster content to a persistent volume.</p>
</dd>
<dt class="hdlist1"><code>Restore</code> CR</dt>
<dd>
<p>Restores archived content to a Infinispan cluster.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Modifying existing <code>Backup</code> or <code>Restore</code> CR instances has no effect.
Backup and restore operations are "one-time" events that modify Infinispan resources.
To update <code>.spec</code> fields for the CR, or when a backup or restore operation fails, you must create a new instance of the <code>Backup</code> or <code>Restore</code> CR.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="backing-up-clusters_backup-restore" class="paragraph">
<p>= Backing up Infinispan clusters</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph _abstract">
<p>Create a backup file that stores Infinispan cluster state to a persistent volume.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an <code>Infinispan</code> CR of <code>spec.service.type: DataGrid</code>.</p>
</li>
<li>
<p>Have some resources on your Infinispan cluster to back up.
Backups archive all resources that the Cache Manager controls, including caches, cache entries, cache templates, Protobuf schema, counters, scripts, and so on.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan backups do not provide snapshot isolation.
If a write operation occurs on a cache entry that the backup operation has already archived, that write might not be backed up.
To ensure that you archive the exact state of the cluster, make sure there are no active client connections to the cluster before you back it up.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>Backup</code> CR.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Name the <code>Backup</code> CR with the <code>metadata.name</code> field.</p>
</li>
<li>
<p>Specify the Infinispan cluster to backup with the <code>spec.cluster</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: infinispan.org/v2alpha1
kind: Backup
metadata:
  name: my-backup
spec:
  cluster: source-cluster</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Add the <code>spec.resources</code> field if you only want to back up certain resources.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  resources:
    templates:
      - distributed-sync-prod
      - distributed-sync-dev
    caches:
      - cache-one
      - cache-two
    counters:
      - counter-name
    protoSchemas:
      - authors.proto
      - books.proto
    tasks:
      - wordStream.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the <code>*</code> wildcard character to back up all resources.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  resources:
    caches:
      - "*"
    protoSchemas:
      - "*"</code></pre>
</div>
</div>
</li>
<li>
<p>Apply your <code>Backup</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f my-backup.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>A new pod joins the Infinispan cluster and creates the backup file.
When the operation is complete, the pod leaves the cluster and logs the following message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>ISPN005044: Backup file created 'my-backup.zip'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting backup file is stored in the <code>/opt/infinispan/backups</code> directory.</p>
</div>
</li>
<li>
<p>Run the following command to verify that the backup is successful:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl describe Backup my-backup -n namespace</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="restoring_clusters-backup-restore">15.1. Restoring Infinispan clusters</h3>
<div class="paragraph _abstract">
<p>Restore Infinispan cluster state from a backup archive.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a <code>Backup</code> CR on a source cluster.</p>
</li>
<li>
<p>Create a Infinispan cluster of Data Grid Service nodes where you want to restore state.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Make sure there are no active client connections to the cluster before you restore the backup.
Cache entries that you restore from a backup could overwrite more recent cache entries.
For example, a client does <code>cache.put(k=2)</code> before you restore a backup that contains <code>k=1</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>Restore</code> CR.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Name the <code>Restore</code> CR with the <code>metadata.name</code> field.</p>
</li>
<li>
<p>Specify a <code>Backup</code> CR to use with the <code>spec.backup</code> field.</p>
</li>
<li>
<p>Specify the Infinispan cluster to restore with the <code>spec.cluster</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>apiVersion: infinispan.org/v2alpha1
kind: Restore
metadata:
  name: my-restore
spec:
  backup: my-backup
  cluster: target-cluster</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Add the <code>spec.resources</code> field to restore specific resources only.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>spec:
  resources:
    templates:
      - distributed-sync-prod
      - distributed-sync-dev
    caches:
      - cache-one
      - cache-two
    counters:
      - counter-name
    protoSchemas:
      - authors.proto
      - books.proto
    tasks:
      - wordStream.js</code></pre>
</div>
</div>
</li>
<li>
<p>Apply your <code>Restore</code> CR.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f my-restore.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>A new pod joins the Infinispan cluster and restores state from the backup file.
When the operation is complete, the pod leaves the cluster and logs the following message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>ISPN005045: Restore 'my-backup' complete</code></pre>
</div>
</div>
</li>
<li>
<p>Open the Infinispan Console or establish a CLI connection to verify the caches and data are restored to the cluster.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-code">16. Deploying custom code to Infinispan</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Add custom code, such as scripts and event listeners, to your Infinispan clusters.</p>
</div>
<div class="sect2">
<h3 id="copying-code_custom-code">16.1. Copying code artifacts</h3>
<div class="paragraph _abstract">
<p>Before you can deploy custom code to Infinispan clusters, you need to add it to a persistent volume (PV).</p>
</div>
<div class="paragraph">
<p>This procedure explains how to use a temporary pod that mounts a persistent volume claim (PVC) that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lets you add code artifacts to the PV (perform a write operation).</p>
</li>
<li>
<p>Allows Infinispan pods to load code artifacts from the PV (perform a read operation).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To perform these read and write operations, you need certain PV access modes.
However, support for different PVC access modes is platform dependent.</p>
</div>
<div class="paragraph">
<p>It is beyond the scope of this document to provide instructions for creating PVCs with different platforms.
For simplicity, the following procedure shows a PVC with the <code>ReadWriteMany</code> access mode.</p>
</div>
<div class="paragraph">
<p>In some cases only the <code>ReadOnlyMany</code> or <code>ReadWriteOnce</code> access modes are available.
You can use a combination of those access modes by reclaiming and reusing PVCs with the same <code>spec.volumeName</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Using <code>ReadWriteOnce</code> access mode results in all Infinispan nodes in a cluster being scheduled on the same Kubernetes node.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Change to the namespace for your Infinispan cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl config set-context --current --namespace=ispn-namespace</code></pre>
</div>
</div>
</li>
<li>
<p>Create a PVC for your custom code artifacts, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: datagrid-libs
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 100Mi</code></pre>
</div>
</div>
</li>
<li>
<p>Apply your PVC.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f datagrid-libs.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Create a pod that mounts the PVC, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: datagrid-libs-pod
spec:
  securityContext:
    fsGroup: 2000
  volumes:
    - name: lib-pv-storage
      persistentVolumeClaim:
        claimName: datagrid-libs
  containers:
    - name: lib-pv-container
      image: quay.io/infinispan/server:13.0
      volumeMounts:
        - mountPath: /tmp/libs
          name: lib-pv-storage</code></pre>
</div>
</div>
</li>
<li>
<p>Add the pod to the Infinispan namespace and wait for it to be ready.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl apply -f datagrid-libs-pod.yaml
$ kubectl wait --for=condition=ready --timeout=2m pod/datagrid-libs-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Copy your code artifacts to the pod so that they are loaded into the PVC.</p>
<div class="paragraph">
<p>For example to copy code artifacts from a local <code>libs</code> directory, do the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl cp --no-preserve=true libs datagrid-libs-pod:/tmp/</code></pre>
</div>
</div>
</li>
<li>
<p>Delete the pod.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl delete pod datagrid-libs-pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.7/html-single/storage/index#configuring-persistent-storage">Configuring persistent storage</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Persistent Volumes</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes">Access Modes</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="deploying-code_custom-code">16.2. Deploying custom code</h3>
<div class="paragraph _abstract">
<p>Make your custom code available to Infinispan clusters.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a persistent volume claim (PVC) and copy your code artifacts to it.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Specify the persistent volume with <code>spec.dependencies.VolumeClaimName</code> in your <code>Infinispan</code> CR and then apply the changes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-infinispan
spec:
  replicas: 2
  dependencies:
    volumeClaimName: datagrid-libs
  service:
    type: DataGrid</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you update your custom code on the persistent volume, you must restart the Infinispan cluster so it can load the changes.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="eventing">17. Sending cloud events from Infinispan clusters</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Configure Infinispan as a Knative source by sending <code>CloudEvents</code> to Apache Kafka topics.</p>
</div>
<div class="sect2">
<h3 id="cloud-events_cloud-events">17.1. Cloud events</h3>
<div class="paragraph _abstract">
<p>You can send <code>CloudEvents</code> from Infinispan clusters when entries in caches are created, updated, removed, or expired.</p>
</div>
<div class="paragraph">
<p>Infinispan sends structured events to Kafka in JSON format, as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
    "specversion": "1.0",
    "source": "/infinispan/&lt;cluster_name&gt;/&lt;cache_name&gt;",
    "type": "org.infinispan.entry.created",
    "time": "&lt;timestamp&gt;",
    "subject": "&lt;key-name&gt;",
    "id": "key-name:CommandInvocation:node-name:0",
    "data": {
       "property": "value"
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prefixes events for Infinispan cache entries with <code>org.infinispan.entry</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>data</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>subject</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry key, converted to string.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generated identifier for the event.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="enabling-cloud-events_cloud-events">17.2. Enabling cloud events</h3>
<div class="paragraph _abstract">
<p>Configure Infinispan to send <code>CloudEvents</code>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Set up an Kafka cluster that listens for Infinispan topics.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add <code>spec.cloudEvents</code> to your <code>Infinispan</code> CR.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Configure the number of acknowledgements with the <code>spec.cloudEvents.acks</code> field. Values are "0", "1", or "all".</p>
</li>
<li>
<p>List Kafka servers to which Infinispan sends events with the <code>spec.cloudEvents.bootstrapServers</code> field.</p>
</li>
<li>
<p>Specify the Kafka topic for Infinispan events with the <code>spec.cloudEvents.cacheEntriesTopic</code> field.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">spec:
  cloudEvents:
    acks: "1"
    bootstrapServers: my-cluster-kafka-bootstrap_1.&lt;namespace_1&gt;.svc:9092,my-cluster-kafka-bootstrap_2.&lt;namespace_2&gt;.svc:9092
    cacheEntriesTopic: target-topic</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Apply your changes.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="connecting-clients">18. Establishing remote client connections</h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Connect to Infinispan clusters from the Infinispan Console, Command Line Interface (CLI), and remote clients.</p>
</div>
<div class="sect2">
<h3 id="client-connection-details_clients">18.1. Client connection details</h3>
<div class="paragraph _abstract">
<p>Before you can connect to Infinispan, you need to retrieve the following pieces of information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Service hostname</p>
</li>
<li>
<p>Port</p>
</li>
<li>
<p>Authentication credentials, if required</p>
</li>
<li>
<p>TLS certificate, if you use encryption</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Service hostnames</div>
<p>The service hostname depends on how you expose Infinispan on the network or if your clients are running on Kubernetes.</p>
</div>
<div class="paragraph">
<p>For clients running on Kubernetes, you can use the name of the internal service that Infinispan Operator creates.</p>
</div>
<div class="paragraph">
<p>For clients running outside Kubernetes, the service hostname is the location URL if you use a load balancer.
For a node port service, the service hostname is the node host name.
For a route, the service hostname is either a custom hostname or a system-defined hostname.</p>
</div>
<div class="paragraph">
<div class="title">Ports</div>
<p>Client connections on Kubernetes and through load balancers use port <code>11222</code>.</p>
</div>
<div class="paragraph">
<p>Node port services use a port in the range of <code>30000</code> to <code>60000</code>.
Routes use either port <code>80</code> (unencrypted) or <code>443</code> (encrypted).</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#creating-network">Configuring Network Access to Infinispan</a></p>
</li>
<li>
<p><a href="#retrieving-credentials_authn">Retrieving Credentials</a></p>
</li>
<li>
<p><a href="#retrieving-tls-certificates_tls">Retrieving TLS Certificates</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="caches_clients">18.2. Infinispan caches</h3>
<div class="paragraph _abstract">
<p>Cache configuration defines the characteristics and features of the data store and must be valid with the Infinispan schema.
Infinispan recommends creating standalone files in XML or JSON format that define your cache configuration.
You should separate Infinispan configuration from application code for easier validation and to avoid the situation where you need to maintain XML snippets in Java or some other client language.</p>
</div>
<div class="paragraph">
<p>To create caches with Infinispan clusters running on Kubernetes, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>Cache</code> CR as the mechanism for creating caches through the Kubernetes front end.</p>
</li>
<li>
<p>Use <code>Batch</code> CR to create multiple caches at a time from standalone configuration files.</p>
</li>
<li>
<p>Access Infinispan Console and create caches in XML or JSON format.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use Hot Rod or HTTP clients but Infinispan recommends <code>Cache</code> CR or <code>Batch</code> CR unless your specific use case requires programmatic remote cache creation.</p>
</div>
</div>
<div class="sect2">
<h3 id="connecting-cli_clients">18.3. Connecting the Infinispan CLI</h3>
<div class="paragraph _abstract">
<p>Use the command line interface (CLI) to connect to your Infinispan cluster and perform administrative operations.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Download a CLI distribution so you can connect to Infinispan clusters on OpenShift.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The CLI is available as part of the server distribution.
Alternatively, you can use the CLI container image available from <a href="https://infinispan.org/download/stable/cli-image.html">infinispan.org/download</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is possible to open a remote shell to a Infinispan node and access the CLI.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>$ kubectl exec -it example-infinispan-0 -- /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>However using the CLI in this way consumes memory allocated to the container, which can lead to out of memory exceptions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a CLI connection to your Infinispan cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">$ bin/cli.sh -c https://$SERVICE_HOSTNAME:$PORT --trustall</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>$SERVICE_HOSTNAME:$PORT</code> with the hostname and port where Infinispan is available on the network.</p>
</div>
</li>
<li>
<p>Enter your Infinispan credentials when prompted.</p>
</li>
<li>
<p>Perform CLI operations as required, for example:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>List caches configured on the cluster with the <code class="command">ls</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">[//containers/default]&gt; ls caches
mycache</code></pre>
</div>
</div>
</li>
<li>
<p>View cache configuration with the <code class="command">describe</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-bash" data-lang="bash">[//containers/default]&gt; describe caches/mycache</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://infinispan.org/docs/stable/titles/server/server.html#start_server">Getting Started with Infinispan Server</a></p>
</li>
<li>
<p><a href="https://infinispan.org/docs/stable/titles/cli/cli.html">Using the Infinispan Command Line Interface</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="connecting-console_clients">18.4. Accessing Infinispan Console</h3>
<div class="paragraph _abstract">
<p>Access the console to create caches, perform adminstrative operations, and monitor your Infinispan clusters.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Expose Infinispan on the network so you can access the console through a browser.<br>
For example, configure a load balancer service or create a route.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Access the console from any browser at <code>$SERVICE_HOSTNAME:$PORT</code>.</p>
<div class="paragraph">
<p>Replace <code>$SERVICE_HOSTNAME:$PORT</code> with the hostname and port where Infinispan is available on the network.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="hotrod-clients_clients">18.5. Hot Rod clients</h3>
<div class="paragraph _abstract">
<p>Hot Rod is a binary TCP protocol that Infinispan provides for high-performance data transfer capabilities with remote clients.</p>
</div>
<div class="paragraph">
<div class="title">Client intelligence</div>
<p>Client intelligence refers to mechanisms the Hot Rod protocol provides so that clients can locate and send requests to Infinispan nodes.</p>
</div>
<div class="paragraph">
<p>Hot Rod clients running on Kubernetes can access internal IP addresses for Infinispan nodes so you can use any client intelligence.
The default intelligence, <code>HASH_DISTRIBUTION_AWARE</code>, is recommended because it allows clients to route requests to primary owners, which improves performance.</p>
</div>
<div class="paragraph">
<p>Hot Rod clients running outside Kubernetes must use <code>BASIC</code> intelligence.</p>
</div>
<div class="sect3">
<h4 id="hotrod-configuration-builder_clients">18.5.1. Hot Rod client configuration API</h4>
<div class="paragraph _abstract">
<p>You can programmatically configure Hot Rod client connections with the <code>ConfigurationBuilder</code> interface.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>$SERVICE_HOSTNAME:$PORT</code> denotes the hostname and port that allows access to your Infinispan cluster.
You should replace these variables with the actual hostname and port for your environment.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="_on_kubernetes" class="discrete">On Kubernetes</h5>
<div class="paragraph">
<p>Hot Rod clients running on Kubernetes can use the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;
import org.infinispan.client.hotrod.configuration.SaslQop;
import org.infinispan.client.hotrod.impl.ConfigurationProperties;
...

ConfigurationBuilder builder = new ConfigurationBuilder();
      builder.addServer()
               .host("$SERVICE_HOSTNAME")
               .port(ConfigurationProperties.DEFAULT_HOTROD_PORT)
             .security().authentication()
               .username("username")
               .password("changeme")
               .realm("default")
               .saslQop(SaslQop.AUTH)
               .saslMechanism("SCRAM-SHA-512")
             .ssl()
               .sniHostName("$SERVICE_HOSTNAME")
               .trustStoreFileName("/var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt")
               .trustStoreType("pem");</code></pre>
</div>
</div>
<h5 id="_outside_kubernetes" class="discrete">Outside Kubernetes</h5>
<div class="paragraph">
<p>Hot Rod clients running outside Kubernetes can use the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">import org.infinispan.client.hotrod.configuration.ClientIntelligence;
import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;
import org.infinispan.client.hotrod.configuration.SaslQop;
...

ConfigurationBuilder builder = new ConfigurationBuilder();
      builder.addServer()
               .host("$SERVICE_HOSTNAME")
               .port("$PORT")
             .security().authentication()
               .username("username")
               .password("changeme")
               .realm("default")
               .saslQop(SaslQop.AUTH)
               .saslMechanism("SCRAM-SHA-512")
             .ssl()
               .sniHostName("$SERVICE_HOSTNAME")
               //Create a client trust store with tls.crt from your project.
               .trustStoreFileName("/path/to/truststore.pkcs12")
               .trustStorePassword("trust_store_password")
               .trustStoreType("PCKS12");
      builder.clientIntelligence(ClientIntelligence.BASIC);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="hotrod-properties_clients">18.5.2. Hot Rod client properties</h4>
<div class="paragraph _abstract">
<p>You can configure Hot Rod client connections with the <code>hotrod-client.properties</code> file on the application classpath.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>$SERVICE_HOSTNAME:$PORT</code> denotes the hostname and port that allows access to your Infinispan cluster.
You should replace these variables with the actual hostname and port for your environment.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="_on_kubernetes_2" class="discrete">On Kubernetes</h5>
<div class="paragraph">
<p>Hot Rod clients running on Kubernetes can use the following properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code># Connection
infinispan.client.hotrod.server_list=$SERVICE_HOSTNAME:$PORT

# Authentication
infinispan.client.hotrod.use_auth=true
infinispan.client.hotrod.auth_username=developer
infinispan.client.hotrod.auth_password=$PASSWORD
infinispan.client.hotrod.auth_server_name=$CLUSTER_NAME
infinispan.client.hotrod.sasl_properties.javax.security.sasl.qop=auth
infinispan.client.hotrod.sasl_mechanism=SCRAM-SHA-512

# Encryption
infinispan.client.hotrod.sni_host_name=$SERVICE_HOSTNAME
infinispan.client.hotrod.trust_store_file_name=/var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt
infinispan.client.hotrod.trust_store_type=pem</code></pre>
</div>
</div>
<h5 id="_outside_kubernetes_2" class="discrete">Outside Kubernetes</h5>
<div class="paragraph">
<p>Hot Rod clients running outside Kubernetes can use the following properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code># Connection
infinispan.client.hotrod.server_list=$SERVICE_HOSTNAME:$PORT

# Client intelligence
infinispan.client.hotrod.client_intelligence=BASIC

# Authentication
infinispan.client.hotrod.use_auth=true
infinispan.client.hotrod.auth_username=developer
infinispan.client.hotrod.auth_password=$PASSWORD
infinispan.client.hotrod.auth_server_name=$CLUSTER_NAME
infinispan.client.hotrod.sasl_properties.javax.security.sasl.qop=auth
infinispan.client.hotrod.sasl_mechanism=SCRAM-SHA-512

# Encryption
infinispan.client.hotrod.sni_host_name=$SERVICE_HOSTNAME
# Create a client trust store with tls.crt from your project.
infinispan.client.hotrod.trust_store_file_name=/path/to/truststore.pkcs12
infinispan.client.hotrod.trust_store_password=trust_store_password
infinispan.client.hotrod.trust_store_type=PCKS12</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="creating-caches-hotrod_clients">18.5.3. Creating caches from Hot Rod clients</h4>
<div class="paragraph _abstract">
<p>You can remotely create caches on Infinispan clusters running on Kubernetes with Hot Rod clients.
However, Infinispan recommends that you create caches using Infinispan Console, the CLI, or with <code>Cache</code> CRs instead of with Hot Rod clients.</p>
</div>
<h5 id="_programmatically_creating_caches" class="discrete">Programmatically creating caches</h5>
<div class="paragraph">
<p>The following example shows how to add cache configurations to the <code>ConfigurationBuilder</code> and then create them with the <code>RemoteCacheManager</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">import org.infinispan.client.hotrod.DefaultTemplate;
import org.infinispan.client.hotrod.RemoteCache;
import org.infinispan.client.hotrod.RemoteCacheManager;
...

      builder.remoteCache("my-cache")
             .templateName(DefaultTemplate.DIST_SYNC);
      builder.remoteCache("another-cache")
             .configuration("&lt;infinispan&gt;&lt;cache-container&gt;&lt;distributed-cache name=\"another-cache\"&gt;&lt;encoding media-type=\"application/x-protostream\"/&gt;&lt;/distributed-cache&gt;&lt;/cache-container&gt;&lt;/infinispan&gt;");
      try (RemoteCacheManager cacheManager = new RemoteCacheManager(builder.build())) {
      // Get a remote cache that does not exist.
      // Rather than return null, create the cache from a template.
      RemoteCache&lt;String, String&gt; cache = cacheManager.getCache("my-cache");
      // Store a value.
      cache.put("hello", "world");
      // Retrieve the value and print it.
      System.out.printf("key = %s\n", cache.get("hello"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows how to create a cache named CacheWithXMLConfiguration using the <code>XMLStringConfiguration()</code> method to pass the cache configuration as XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">import org.infinispan.client.hotrod.RemoteCacheManager;
import org.infinispan.commons.configuration.XMLStringConfiguration;
...

private void createCacheWithXMLConfiguration() {
    String cacheName = "CacheWithXMLConfiguration";
    String xml = String.format("&lt;distributed-cache name=\"%s\"&gt;" +
                                  "&lt;encoding media-type=\"application/x-protostream\"/&gt;" +
                                  "&lt;locking isolation=\"READ_COMMITTED\"/&gt;" +
                                  "&lt;transaction mode=\"NON_XA\"/&gt;" +
                                  "&lt;expiration lifespan=\"60000\" interval=\"20000\"/&gt;" +
                                "&lt;/distributed-cache&gt;"
                                , cacheName);
    manager.administration().getOrCreateCache(cacheName, new XMLStringConfiguration(xml));
    System.out.println("Cache with configuration exists or is created.");
}</code></pre>
</div>
</div>
<h5 id="_using_hot_rod_client_properties" class="discrete">Using Hot Rod client properties</h5>
<div class="paragraph">
<p>When you invoke <code>cacheManager.getCache()</code> calls for named caches that do not exist, Infinispan creates them from the Hot Rod client properties instead of returning null.</p>
</div>
<div class="paragraph">
<p>Add cache configuration to <code>hotrod-client.properties</code> as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code># Add cache configuration
infinispan.client.hotrod.cache.my-cache.template_name=org.infinispan.DIST_SYNC
infinispan.client.hotrod.cache.another-cache.configuration=&lt;infinispan&gt;&lt;cache-container&gt;&lt;distributed-cache name=\"another-cache\"/&gt;&lt;/cache-container&gt;&lt;/infinispan&gt;
infinispan.client.hotrod.cache.my-other-cache.configuration_uri=file:/path/to/configuration.xml</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="connecting-rest_clients">18.6. Accessing the REST API</h3>
<div class="paragraph _abstract">
<p>Infinispan provides a RESTful interface that you can interact with using HTTP clients.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Expose Infinispan on the network so you can access the REST API.<br>
For example, configure a load balancer service or create a route.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Access the REST API with any HTTP client at <code>$SERVICE_HOSTNAME:$PORT/rest/v2</code>.</p>
<div class="paragraph">
<p>Replace <code>$SERVICE_HOSTNAME:$PORT</code> with the hostname and port where Infinispan is available on the network.</p>
</div>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://infinispan.org/docs/stable/titles/rest/rest.html">Infinispan REST API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="creating-caches-cacheservice_clients">18.7. Adding caches to Cache Service nodes</h3>
<div class="paragraph _abstract">
<p>Cache Service nodes include a default cache configuration with recommended
settings. This default cache lets you start using Infinispan without the need
to create caches.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Because the default cache provides recommended settings, you should create
caches only as copies of the default. If you want multiple custom caches you
should create Data Grid Service nodes instead of Cache Service nodes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Access the Infinispan Console and provide a copy of the default configuration in XML or JSON format.</p>
</li>
<li>
<p>Use the Infinispan CLI to create a copy from the default cache as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>[//containers/default]&gt; create cache --template=default mycache</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="default-cache-service-config_clients">18.7.1. Default cache configuration</h4>
<div class="paragraph _abstract">
<p>This topic describes default cache configuration for Cache Service nodes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache name="default"
                   mode="SYNC"
                   owners="2"&gt;
  &lt;memory storage="OFF_HEAP"
          max-size="&lt;maximum_size_in_bytes&gt;"
          when-full="REMOVE" /&gt;
  &lt;partition-handling when-split="ALLOW_READ_WRITES"
                      merge-policy="REMOVE_ALL"/&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Default caches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use synchronous distribution to store data across the cluster.</p>
</li>
<li>
<p>Create two replicas of each entry on the cluster.</p>
</li>
<li>
<p>Store cache entries as bytes in native memory (off-heap).</p>
</li>
<li>
<p>Define the maximum size for the data container in bytes. Infinispan Operator calculates the maximum size when it creates nodes.</p>
</li>
<li>
<p>Evict cache entries to control the size of the data container. You can enable automatic scaling so that Infinispan Operator adds nodes when memory usage increases instead of removing entries.</p>
</li>
<li>
<p>Use a conflict resolution strategy that allows read and write operations for cache entries, even if segment owners are in different partitions.</p>
</li>
<li>
<p>Specify a merge policy that removes entries from the cache when Infinispan detects conflicts.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-06-28 11:39:20 -0400
</div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>