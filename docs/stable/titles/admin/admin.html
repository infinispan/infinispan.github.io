<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="generator" content="Asciidoctor 1.5.8"> <title>Administration Guide for Infinispan 10.0</title> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"> <style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> <style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style> <link rel="canonical" href="http://infinispan.org/docs/stable/user_guide/user_guide.html"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css"> <link rel="stylesheet" href="../../css/css.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script> <script src="../../js/js.js"></script> </head> <body class="book toc2 toc-left"> <div id="header"> <h1>Administration Guide for Infinispan 10.0</h1> <div id="toc" class="toc2"> <div id="toctitle">Table of Contents</div> <ul class="sectlevel1"> <li><a href="#eviction_expiration">1. Configuring Eviction and Expiration</a> <ul class="sectlevel2"> <li><a href="#eviction_anchor">1.1. Eviction and Data Container</a></li> <li><a href="#eviction_enabling">1.2. Enabling Eviction</a> <ul class="sectlevel3"> <li><a href="#eviction_strategy">1.2.1. Eviction strategy</a></li> <li><a href="#eviction_types">1.2.2. Eviction types</a></li> <li><a href="#eviction_storage_type">1.2.3. Storage type</a></li> <li><a href="#eviction_defaults">1.2.4. More defaults</a></li> </ul> </li> <li><a href="#expiration_anchor">1.3. Expiration</a> <ul class="sectlevel3"> <li><a href="#expiration_settings">1.3.1. Difference between Eviction and Expiration</a></li> <li><a href="#expiration_details">1.3.2. Expiration details</a> <ul class="sectlevel4"> <li><a href="#expiration_maxidle">Maximum Idle Expiration</a> <ul class="sectlevel5"> <li><a href="#expiration_maxidle_local">Local Max Idle</a></li> <li><a href="#expiration_maxidle_clustered">Clustered Max Idle</a></li> </ul> </li> <li><a href="#eviction_expiration_config">Configuration</a></li> <li><a href="#eviction_expiration_config_mem">Memory Based Eviction Configuration</a></li> <li><a href="#eviction_expiration_config_default">Default values</a></li> <li><a href="#expiration_using">Using expiration</a></li> </ul> </li> <li><a href="#expiration_designs">1.3.3. Expiration designs</a></li> </ul> </li> </ul> </li> <li><a href="#persistence">2. Persistence</a> <ul class="sectlevel2"> <li><a href="#configuration">2.1. Configuration</a></li> <li><a href="#cache_passivation">2.2. Cache Passivation</a> <ul class="sectlevel3"> <li><a href="#limitations">2.2.1. Limitations</a></li> <li><a href="#cache_loader_behavior_with_passivation_disabled_vs_enabled">2.2.2. Cache Loader Behavior with Passivation Disabled vs Enabled</a></li> </ul> </li> <li><a href="#cache_loaders_and_transactional_caches">2.3. Cache Loaders and transactional caches</a></li> <li><a href="#write_through_and_write_behind_caching">2.4. Write-Through And Write-Behind Caching</a> <ul class="sectlevel3"> <li><a href="#write_through_synchronous">2.4.1. Write-Through (Synchronous)</a></li> <li><a href="#write_behind_asynchronous">2.4.2. Write-Behind (Asynchronous)</a></li> <li><a href="#segmented_stores">2.4.3. Segmented Stores</a></li> </ul> </li> <li><a href="#filesystem_based_cache_stores">2.5. Filesystem based cache stores</a></li> <li><a href="#sfs_cache_store">2.6. Single File Store</a> <ul class="sectlevel3"> <li><a href="#segmentation_support">2.6.1. Segmentation support</a></li> <li><a href="#configuration_2">2.6.2. Configuration</a></li> </ul> </li> <li><a href="#sifs_cache_store">2.7. Soft-Index File Store</a> <ul class="sectlevel3"> <li><a href="#segmentation_support_2">2.7.1. Segmentation support</a></li> <li><a href="#configuration_3">2.7.2. Configuration</a></li> <li><a href="#current_limitations">2.7.3. Current limitations</a></li> </ul> </li> <li><a href="#jdbc_cache_store">2.8. JDBC String based Cache Store</a> <ul class="sectlevel3"> <li><a href="#connection_management_pooling">2.8.1. Connection management (pooling)</a></li> <li><a href="#sample_configurations">2.8.2. Sample configurations</a></li> </ul> </li> <li><a href="#remote_cache_store">2.9. Remote store</a> <ul class="sectlevel3"> <li><a href="#segmentation_support_3">2.9.1. Segmentation support</a></li> <li><a href="#sample_usage">2.9.2. Sample Usage</a></li> </ul> </li> <li><a href="#cluster_cache_loader">2.10. Cluster cache loader</a> <ul class="sectlevel3"> <li><a href="#clustercacheloader">2.10.1. ClusterCacheLoader</a></li> </ul> </li> <li><a href="#cli_cache_loader">2.11. Command-Line Interface cache loader</a> <ul class="sectlevel3"> <li><a href="#cli_cache_loader_2">2.11.1. CLI Cache Loader</a></li> </ul> </li> <li><a href="#rocksdb_cache_store">2.12. RocksDB Cache Store</a> <ul class="sectlevel3"> <li><a href="#introduction">2.12.1. Introduction</a></li> <li><a href="#segmentation_support_4">2.12.2. Segmentation support</a> <ul class="sectlevel4"> <li><a href="#sample_usage_2">Sample Usage</a></li> </ul> </li> <li><a href="#configuration_4">2.12.3. Configuration</a> <ul class="sectlevel4"> <li><a href="#sample_programatic_configuration">Sample Programatic Configuration</a></li> <li><a href="#sample_xml_configuration">Sample XML Configuration</a></li> </ul> </li> <li><a href="#additional_references">2.12.4. Additional References</a></li> </ul> </li> <li><a href="#jpa_cache_store">2.13. JPA Cache Store</a> <ul class="sectlevel3"> <li><a href="#sample_usage_3">2.13.1. Sample Usage</a></li> <li><a href="#configuration_5">2.13.2. Configuration</a> <ul class="sectlevel4"> <li><a href="#sample_programmatic_configuration">Sample Programmatic Configuration</a></li> <li><a href="#sample_xml_configuration_2">Sample XML Configuration</a></li> </ul> </li> <li><a href="#additional_references_2">2.13.3. Additional References</a></li> </ul> </li> <li><a href="#custom_cache_stores">2.14. Custom Cache Stores</a> <ul class="sectlevel3"> <li><a href="#hotrod_deployment">2.14.1. HotRod Deployment</a></li> </ul> </li> <li><a href="#store_migrator">2.15. Store Migrator</a> <ul class="sectlevel3"> <li><a href="#migrating_cache_stores">2.15.1. Migrating Cache Stores</a></li> <li><a href="#store_migrator_properties">2.15.2. Store Migrator Properties</a> <ul class="sectlevel4"> <li><a href="#common_properties">Common Properties</a></li> <li><a href="#jdbc_properties">JDBC Properties</a></li> <li><a href="#leveldbrocksdb_properties">LevelDB/RocksDB Properties</a></li> <li><a href="#singlefilestore_properties">SingleFileStore Properties</a></li> <li><a href="#softindexfilestore_properties">SoftIndexFileStore Properties</a></li> </ul> </li> </ul> </li> <li><a href="#spi">2.16. SPI</a> <ul class="sectlevel3"> <li><a href="#more_implementations">2.16.1. More implementations</a></li> </ul> </li> </ul> </li> <li><a href="#partition_handling">3. Setting Up Partition Handling</a> <ul class="sectlevel2"> <li><a href="#partition_handling-admin">3.1. Partition handling</a> <ul class="sectlevel3"> <li><a href="#split_brain">3.1.1. Split brain</a> <ul class="sectlevel4"> <li><a href="#split_strategies">Split Strategies</a> <ul class="sectlevel5"> <li><a href="#allow_read_writes">ALLOW_READ_WRITES</a></li> <li><a href="#deny_read_writes">DENY_READ_WRITES</a></li> <li><a href="#allow_reads">ALLOW_READS</a></li> </ul> </li> <li><a href="#current_limitations_2">Current limitations</a></li> </ul> </li> <li><a href="#successive_node_failures">3.1.2. Successive nodes stopped</a></li> <li><a href="#conflict_manager">3.1.3. Conflict Manager</a> <ul class="sectlevel4"> <li><a href="#detecting_conflicts">Detecting Conflicts</a></li> <li><a href="#merge_policies">Merge Policies</a></li> </ul> </li> <li><a href="#conflict_manager_usage">3.1.4. Usage</a></li> <li><a href="#partition_handling_configuration">3.1.5. Configuring partition handling</a> <ul class="sectlevel4"> <li><a href="#partition_handling_custom_merge_policy">Implement a custom merge policy</a></li> <li><a href="#deploy_custom_merge_policies_to_a_infinispan_server_instance">Deploy custom merge policies to a Infinispan server instance</a></li> </ul> </li> <li><a href="#partition_handling_monitoring">3.1.6. Monitoring and administration</a></li> </ul> </li> </ul> </li> <li><a href="#extending">4. Extending Infinispan</a> <ul class="sectlevel2"> <li><a href="#custom_commands">4.1. Custom Commands</a> <ul class="sectlevel3"> <li><a href="#an_example">4.1.1. An Example</a></li> <li><a href="#preassigned_custom_command_id_ranges">4.1.2. Preassigned Custom Command Id Ranges</a></li> </ul> </li> <li><a href="#extending_the_configuration_builders_and_parsers">4.2. Extending the configuration builders and parsers</a></li> </ul> </li> <li><a href="#custom_interceptors_chapter">5. Custom Interceptors</a> <ul class="sectlevel2"> <li><a href="#adding_custom_interceptors_declaratively">5.1. Adding custom interceptors declaratively</a></li> <li><a href="#adding_custom_interceptors_programatically">5.2. Adding custom interceptors programatically</a></li> <li><a href="#custom_interceptor_design">5.3. Custom interceptor design</a></li> </ul> </li> <li><a href="#rolling_up_k8s">6. Rolling Upgrades and Updates with Kubernetes and OpenShift</a> <ul class="sectlevel2"> <li><a href="#performing_rolling_updates_on_kubernetes">6.1. Performing Rolling Updates on Kubernetes</a></li> <li><a href="#performing_rolling_upgrades_on_kubernetes">6.2. Performing Rolling Upgrades on Kubernetes</a></li> </ul> </li> </ul> </div> </div> <div id="content"> <div class="sect1"> <h2 id="eviction_expiration"><a class="anchor" href="#eviction_expiration"></a>1. Configuring Eviction and Expiration</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="eviction_anchor"><a class="anchor" href="#eviction_anchor"></a>1.1. Eviction and Data Container</h3> <div class="paragraph"> <p>Infinispan supports eviction of entries, such that you do not run out of memory. Eviction is typically used in conjunction with a cache store, so that entries are not permanently lost when evicted, since eviction only removes entries from memory and not from cache stores or the rest of the cluster.</p> </div> <div class="paragraph"> <p>Infinispan supports storing data in a few different formats. Data can be stored as the object iself, binary as a byte[], and off-heap which stores the byte[] in native memory.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Passivation is also a popular option when using eviction, so that only a single copy of an entry is maintained - either in memory or in a cache store, but not both. The main benefit of using passivation over a regular cache store is that updates to entries which exist in memory are cheaper since the update doesn&#8217;t need to be made to the cache store as well. </td> </tr> </table> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> Eviction occurs on a <em>local</em> basis, and is not cluster-wide. Each node runs an eviction thread to analyse the contents of its in-memory container and decide what to evict. Eviction does not take into account the amount of free memory in the JVM as threshold to starts evicting entries. You have to set <code>size</code> attribute of the eviction element to be greater than zero in order for eviction to be turned on. If size is too large you can run out of memory. The <code>size</code> attribute will probably take some tuning in each use case. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="eviction_enabling"><a class="anchor" href="#eviction_enabling"></a>1.2. Enabling Eviction</h3> <div class="paragraph"> <p>Eviction is configured by adding the <a href="http://docs.jboss.org/infinispan/10.0/configdocs/infinispan-config-10.0.html"><code>&lt;memory /&gt;</code></a> element to your <code>&lt;*-cache /&gt;</code> configuration sections or using <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/configuration/cache/MemoryConfigurationBuilder.html">MemoryConfigurationBuilder</a> API programmatic approach.</p> </div> <div class="paragraph"> <p>All cache entry are evicted by piggybacking on user threads that are hitting the cache.</p> </div> <div class="sect3"> <h4 id="eviction_strategy"><a class="anchor" href="#eviction_strategy"></a>1.2.1. Eviction strategy</h4> <div class="paragraph"> <p>Strategies control how the eviction is handled.</p> </div> <div class="paragraph"> <p>The possible choices are</p> </div> <div class="paragraph"> <div class="title"><code>NONE</code></div> <p>Eviction is not enabled and it is assumed that the user will not invoke evict directly on the cache. If passivation is enabled this will cause aa warning message to be emitted. This is the default strategy.</p> </div> <div class="paragraph"> <div class="title"><code>MANUAL</code></div> <p>This strategy is just like &lt;b&gt;NONE&lt;/b&gt; except that it asssumes the user will be invoking evict directly. This way if passivation is enabled no warning message is logged.</p> </div> <div class="paragraph"> <div class="title"><code>REMOVE</code></div> <p>This strategy will actually evict "old" entries to make room for incoming ones.</p> </div> <div class="paragraph"> <p>Eviction is handled by <a href="https://github.com/ben-manes/caffeine">Caffeine</a> utilizing the TinyLFU algorithm with an additional admission window. This was chosen as provides high hit rate while also requiring low memory overhead. This provides a better hit ratio than LRU while also requiring less memory than LIRS.</p> </div> <div class="paragraph"> <div class="title"><code>EXCEPTION</code></div> <p>This strategy actually prevents new entries from being created by throwing a <code>ContainerFullException</code>. This strategy only works with transactional caches that always run with 2 phase commit, that is no 1 phase commit or synchronization optimizations allowed.</p> </div> </div> <div class="sect3"> <h4 id="eviction_types"><a class="anchor" href="#eviction_types"></a>1.2.2. Eviction types</h4> <div class="paragraph"> <p>Eviction type applies only when the size is set to something greater than 0. The eviction type below determines when the container will decide to remove entries.</p> </div> <div class="paragraph"> <div class="title"><code>COUNT</code></div> <p>This type of eviction will remove entries based on how many there are in the cache. Once the count of entries has grown larger than the <code>size</code> then an entry will be removed to make room.</p> </div> <div class="paragraph"> <div class="title"><code>MEMORY</code></div> <p>This type of eviction will estimate how much each entry will take up in memory and will remove an entry when the total size of all entries is larger than the configured <code>size</code>. This type does not work with <code>OBJECT</code> storage type below.</p> </div> </div> <div class="sect3"> <h4 id="eviction_storage_type"><a class="anchor" href="#eviction_storage_type"></a>1.2.3. Storage type</h4> <div class="paragraph"> <p>Infinispan allows the user to configure in what form their data is stored. Each form supports the same features of Infinispan, however eviction can be limited for some forms. There are currently three storage formats that Infinispan provides, they are:</p> </div> <div class="paragraph"> <div class="title"><code>OBJECT</code></div> <p>Stores the keys and values as objects in the Java heap Only <code>COUNT</code> eviction type is supported.</p> </div> <div class="paragraph"> <div class="title"><code>BINARY</code></div> <p>Stores the keys and values as a byte[] in the Java heap. This will use the configured marshaller for the cache if there is one. Both <code>COUNT</code> and <code>MEMORY</code> eviction types are supported.</p> </div> <div class="paragraph"> <div class="title"><code>OFF-HEAP</code></div> <p>Stores the keys and values in native memory outside of the Java heap as bytes. The configured marshaller will be used if the cache has one. Both <code>COUNT</code> and <code>MEMORY</code> eviction types are supported.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Both <code>BINARY</code> and <code>OFF-HEAP</code> violate equality and hashCode that they are dictated by the resulting byte[] they generate instead of the object instance. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="eviction_defaults"><a class="anchor" href="#eviction_defaults"></a>1.2.4. More defaults</h4> <div class="paragraph"> <p>By default when no <code>&lt;memory /&gt;</code> element is specified, no eviction takes place, <code>OBJECT</code> storage type is used, and a strategy of <code>NONE</code> is assumed.</p> </div> <div class="paragraph"> <p>In case there is an memory element, this table describes the behaviour of eviction based on information provided in the xml configuration ("-" in Supplied size or Supplied strategy column means that the attribute wasn&#8217;t supplied)</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Supplied size</th> <th class="tableblock halign-left valign-top">Example</th> <th class="tableblock halign-left valign-top">Eviction behaviour</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory /&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">no eviction as an object</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;object strategy="MANUAL" /&gt; &lt;/memory&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">no eviction as an object and won&#8217;t log warning if passivation is enabled</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&gt; 0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;object size="100" /&gt; &lt;/memory&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">eviction takes place and stored as objects</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&gt; 0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;binary size="100" eviction="MEMORY"/&gt; &lt;/memory&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">eviction takes place and stored as a binary removing to make sure memory doens&#8217;t go higher than 100</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&gt; 0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;off-heap size="100" /&gt; &lt;/memory&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">eviction takes place and stored in off-heap</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&gt; 0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;off-heap size="100" strategy="EXCEPTION" /&gt; &lt;/memory&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">entries are stored in off-heap and if 100 entries are in container exceptions will be thrown for additional</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;object size="0" /&gt; &lt;/memory&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">no eviction</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">&lt; 0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;object size="-1" /&gt; &lt;/memory&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">no eviction</p></td> </tr> </tbody> </table> </div> </div> <div class="sect2"> <h3 id="expiration_anchor"><a class="anchor" href="#expiration_anchor"></a>1.3. Expiration</h3> <div class="paragraph"> <p>Similar to, but unlike eviction, is expiration. Expiration allows you to attach lifespan and/or maximum idle times to entries. Entries that exceed these times are treated as invalid and are removed. When removed expired entries are not passivated like evicted entries (if passivation is turned on).</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Unlike eviction, expired entries are removed globally - from memory, cache stores, and cluster-wide. </td> </tr> </table> </div> <div class="paragraph"> <p>By default entries created are immortal and do not have a lifespan or maximum idle time. Using the cache API, mortal entries can be created with lifespans and/or maximum idle times. Further, default lifespans and/or maximum idle times can be configured by adding the <a href="http://docs.jboss.org/infinispan/10.0/configdocs/infinispan-config-10.0.html">&lt;expiration /&gt;</a> element to your <code>&lt;*-cache /&gt;</code> configuration sections.</p> </div> <div class="paragraph"> <p>When an entry expires it resides in the data container or cache store until it is accessed again by a user request. An expiration reaper is also available to check for expired entries and remove them at a configurable interval of milliseconds.</p> </div> <div class="paragraph"> <p>You can enable the expiration reaper declaratively with the <code>reaper-interval</code> attribute or programmatically with the <code>enableReaper</code> method in the <code>ExpirationConfigurationBuilder</code> class.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="ulist"> <ul> <li> <p>The expiration reaper cannot be disabled when a cache store is present.</p> </li> <li> <p>When using a maximum idle time in a clustered cache, you should always enable the expiration reaper. For more information, see <a href="#expiration_maxidle_clustered">Clustered Max Idle</a>.</p> </li> </ul> </div> </td> </tr> </table> </div> <div class="sect3"> <h4 id="expiration_settings"><a class="anchor" href="#expiration_settings"></a>1.3.1. Difference between Eviction and Expiration</h4> <div class="paragraph"> <p>Both Eviction and Expiration are means of cleaning the cache of unused entries and thus guarding the heap against <code>OutOfMemory</code> exceptions, so now a brief explanation of the difference.</p> </div> <div class="paragraph"> <p>With <em>eviction</em> you set <em>maximal number of entries</em> you want to keep in the cache and if this limit is exceeded, some candidates are found to be removed according to a choosen <em>eviction strategy</em> (LRU, LIRS, etc&#8230;&#8203;). Eviction can be setup to work with passivation, which is eviction to a cache store.</p> </div> <div class="paragraph"> <p>With <em>expiration</em> you set <em>time criteria</em> for entries to specify <em>how long you want to keep them</em> in the cache.</p> </div> <div class="dlist"> <dl> <dt class="hdlist1"><em>lifespan</em></dt> <dd> <p>Specifies how long entries can remain in the cache before they expire. The default value is <code>-1</code>, which is unlimited time.</p> </dd> <dt class="hdlist1"><em>maximum idle time</em></dt> <dd> <p>Specifies how long entries can remain idle before they expire. An entry in the cache is idle when no operation is performed with the key. The default value is <code>-1</code>, which is unlimited time.</p> </dd> </dl> </div> </div> <div class="sect3"> <h4 id="expiration_details"><a class="anchor" href="#expiration_details"></a>1.3.2. Expiration details</h4> <div class="olist arabic"> <ol class="arabic"> <li> <p><em>Expiration</em> is a top-level construct, represented in the configuration as well as in the cache API.</p> </li> <li> <p>While eviction is <em>local to each cache instance</em> , expiration is <em>cluster-wide</em> . Expiration <code>lifespan</code> and <code>maxIdle</code> values are replicated along with the cache entry.</p> </li> <li> <p>Maximum idle times for cache entries require additional network messages in clustered environments. For this reason, setting <code>maxIdle</code> in clustered caches can result in slower operation times.</p> </li> <li> <p>Expiration lifespan and <code>maxIdle</code> are also persisted in CacheStores, so this information survives eviction/passivation.</p> </li> </ol> </div> <div class="sect4"> <h5 id="expiration_maxidle"><a class="anchor" href="#expiration_maxidle"></a>Maximum Idle Expiration</h5> <div class="paragraph"> <p>Maximum idle expiration has different behavior in local and clustered cache environments.</p> </div> <div class="sect5"> <h6 id="expiration_maxidle_local"><a class="anchor" href="#expiration_maxidle_local"></a>Local Max Idle</h6> <div class="paragraph"> <p>In non-clustered cache environments, the <code>maxIdle</code> configuration expires entries when:</p> </div> <div class="ulist"> <ul> <li> <p>accessed directly (<code>Cache.get</code>).</p> </li> <li> <p>iterated upon (<code>Cache.size</code>).</p> </li> <li> <p>the expiration reaper thread runs.</p> </li> </ul> </div> </div> <div class="sect5"> <h6 id="expiration_maxidle_clustered"><a class="anchor" href="#expiration_maxidle_clustered"></a>Clustered Max Idle</h6> <div class="paragraph"> <p>In clustered environments, nodes in the cluster can have different access times for the same entry. Entries do not expire from the cache until they reach the maxium idle time for all owners across the cluster.</p> </div> <div class="paragraph"> <p>When a node detects that an entry has reached the maximum idle time and is expired, the node gets the last time that the entry was accessed from the other owners in the cluster. If the other owners indicate that the entry is expired, that entry is not returned to the requester and removed from the cache.</p> </div> <div class="paragraph"> <p>The following points apply to using the <code>maxIdle</code> configuration with clustered caches:</p> </div> <div class="ulist"> <ul> <li> <p>If one or more owner in the cluster detects that an entry is not expired, then a <code>Cache.get</code> operation returns the entry. The last access time for that entry is also updated to the current time.</p> </li> <li> <p>When the expiration reaper finds entries that might be expired with the maximum idle time, all nodes update the last access time for those entries to the most recent access time before the <code>maxIdle</code> time. In this way, the reaper prevents invalid expiration of entries.</p> </li> <li> <p>Clustered transactional caches do <strong>not</strong> remove entries that are expired with the maximum idle time on <code>Cache.get</code> operations. These expired entries are removed with the expiration reaper thread only, otherwise deadlocking can occur.</p> </li> <li> <p>Iteration across a clustered cache returns entries that might be expired with the maximum idle time. This behavior ensures performance because no remote invocations are performed during the iteration. However this does not refresh any expired entries, which are removed by the expiration reaper or when accessed directly (<code>Cache.get</code>).</p> </li> </ul> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="ulist"> <ul> <li> <p>Clustered caches should always use the expiration reaper with the <code>maxIdle</code> configuration.</p> </li> <li> <p>When using <code>maxIdle</code> expiration with exception-based eviction, entries that are expired but not removed from the cache count towards the size of the data container.</p> </li> </ul> </div> </td> </tr> </table> </div> </div> </div> <div class="sect4"> <h5 id="eviction_expiration_config"><a class="anchor" href="#eviction_expiration_config"></a>Configuration</h5> <div class="paragraph"> <p>Eviction and Expiration may be configured using the programmatic or declarative XML configuration. This configuration is on a per-cache basis. Valid eviction/expiration-related configuration elements are:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="comment">&lt;!-- Eviction --&gt;</span>
<span class="tag">&lt;memory&gt;</span>
   <span class="tag">&lt;object</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/memory&gt;</span>
<span class="comment">&lt;!-- Expiration --&gt;</span>
<span class="tag">&lt;expiration</span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Programmatically, the same would be defined using:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
               .memory().size(<span class="integer">2000</span>)
               .expiration().wakeUpInterval(<span class="integer">5000l</span>).lifespan(<span class="integer">1000l</span>).maxIdle(<span class="integer">500l</span>)
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> .build();</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="eviction_expiration_config_mem"><a class="anchor" href="#eviction_expiration_config_mem"></a>Memory Based Eviction Configuration</h5> <div class="paragraph"> <p>Memory based eviction may require some additional configuration options if you are using your own custom types (as Infinispan is normally used). In this case Infinispan cannot estimate the memory usage of your classes and as such you are required to use <code>storeAsBinary</code> when memory based eviction is used.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="comment">&lt;!-- Enable memory based eviction with 1 GB/&gt; --&gt;</span>
<span class="tag">&lt;memory&gt;</span>
   <span class="tag">&lt;binary</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000000000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">eviction</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MEMORY</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/memory&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
               .memory()
               .storageType(StorageType.BINARY)
               .evictionType(EvictionType.MEMORY)
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> .size(<span class="integer">1</span>_000_000_000)
               .build();</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="eviction_expiration_config_default"><a class="anchor" href="#eviction_expiration_config_default"></a>Default values</h5> <div class="paragraph"> <p>Eviction is disabled by default. Default values are used:</p> </div> <div class="ulist"> <ul> <li> <p>size: -1 is used if not specified, which means unlimited entries.</p> </li> <li> <p>0 means no entries, and the eviction thread will strive to keep the cache empty.</p> </li> </ul> </div> <div class="paragraph"> <p>Expiration lifespan and maxIdle both default to -1, which means that entries will be created immortal by default. This can be overridden per entry with the API.</p> </div> </div> <div class="sect4"> <h5 id="expiration_using"><a class="anchor" href="#expiration_using"></a>Using expiration</h5> <div class="paragraph"> <p>Expiration allows you to set either a lifespan or a maximum idle time on each key/value pair stored in the cache. This can either be set cache-wide using the configuration, as described above, or it can be defined per-key/value pair using the Cache interface. Any values defined per key/value pair overrides the cache-wide default for the specific entry in question.</p> </div> <div class="paragraph"> <p>For example, assume the following configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;expiration</span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// this entry will expire in 1000 millis</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pinot noir</span><span class="delimiter">&quot;</span></span>, pinotNoirPrice);

<span class="comment">// this entry will expire in 2000 millis</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">chardonnay</span><span class="delimiter">&quot;</span></span>, chardonnayPrice, <span class="integer">2</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);

<span class="comment">// this entry will expire 1000 millis after it is last accessed</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pinot grigio</span><span class="delimiter">&quot;</span></span>, pinotGrigioPrice, -<span class="integer">1</span>,
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="predefined-type">TimeUnit</span>.SECONDS, <span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);

<span class="comment">// this entry will expire 1000 millis after it is last accessed, or</span>
<span class="comment">// in 5000 millis, which ever triggers first</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">riesling</span><span class="delimiter">&quot;</span></span>, rieslingPrice, <span class="integer">5</span>,
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="predefined-type">TimeUnit</span>.SECONDS, <span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);</code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="expiration_designs"><a class="anchor" href="#expiration_designs"></a>1.3.3. Expiration designs</h4> <div class="paragraph"> <p>Central to expiration is an ExpirationManager.</p> </div> <div class="paragraph"> <p>The purpose of the ExpirationManager is to drive the expiration thread which periodically purges items from the DataContainer. If the expiration thread is disabled (wakeupInterval set to -1) expiration can be kicked off manually using ExprationManager.processExpiration(), for example from another maintenance thread that may run periodically in your application.</p> </div> <div class="paragraph"> <p>The expiration manager processes expirations in the following manner:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Causes the data container to purge expired entries</p> </li> <li> <p>Causes cache stores (if any) to purge expired entries</p> </li> </ol> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="persistence"><a class="anchor" href="#persistence"></a>2. Persistence</h2> <div class="sectionbody"> <div class="paragraph"> <p>Persistence allows configuring external (persistent) storage engines complementary to the default in memory storage offered by Infinispan. An external persistent storage might be useful for several reasons:</p> </div> <div class="ulist"> <ul> <li> <p>Increased Durability. Memory is volatile, so a cache store could increase the life-span of the information store in the cache.</p> </li> <li> <p>Write-through. Interpose Infinispan as a caching layer between an application and a (custom) external storage engine.</p> </li> <li> <p>Overflow Data. By using eviction and passivation, one can store only the "hot" data in memory and overflow the data that is less frequently used to disk.</p> </li> </ul> </div> <div class="paragraph"> <p>The integration with the persistent store is done through the following SPI: CacheLoader, CacheWriter, AdvancedCacheLoader and AdvancedCacheWriter (discussed in the following sections).</p> </div> <div class="paragraph"> <p>These SPIs allow for the following features:</p> </div> <div class="ulist"> <ul> <li> <p>Alignment with <a href="http://jcp.org/en/jsr/detail?id=107">JSR-107</a>. The <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/spi/CacheWriter.html">CacheWriter</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/spi/CacheLoader.html">CacheLoader</a> interface are similar to the the loader and writer in JSR 107. This should considerably help writing portable stores across JCache compliant vendors.</p> </li> <li> <p>Simplified Transaction Integration. All necessary locking is handled by Infinispan automatically and implementations don’t have to be concerned with coordinating concurrent access to the store. Even though concurrent writes on the same key are not going to happen (depending locking mode in use), implementors should expect operations on the store to happen from multiple/different threads and code the implementation accordingly.</p> </li> <li> <p>Parallel Iteration. It is now possible to iterate over entries in the store with multiple threads in parallel.</p> </li> <li> <p>Reduced Serialization. This translates in less CPU usage. The new API exposes the stored entries in serialized format. If an entry is fetched from persistent storage for the sole purpose of being sent remotely, we no longer need to deserialize it (when reading from the store) and serialize it back (when writing to the wire). Now we can write to the wire the serialized format as read from the storage directly.</p> </li> </ul> </div> <div class="sect2"> <h3 id="configuration"><a class="anchor" href="#configuration"></a>2.1. Configuration</h3> <div class="paragraph"> <p>Stores (readers and/or writers) can be configured in a chain. Cache read operation looks at all of the specified <code>CacheLoader</code> s, in the order they are configured, until it finds a valid and non-null element of data. When performing writes all cache <code>CacheWriter</code> s are written to, except if the <code>ignoreModifications</code> element has been set to true for a specific cache writer.</p> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="title">Implementing both a CacheWriter and CacheLoader</div> <div class="paragraph"> <p>Store providers should implement both the <code>CacheWriter</code> and the <code>CacheLoader</code> interfaces. Stores that do this are considered both for reading and writing (assuming <code>read-only=false</code>) data.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>This is the configuration of a custom (not shipped with infinispan) store:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCustomStore</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;store</span>
         <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.acme.CustomStore</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">segmented</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

         <span class="tag">&lt;write-behind</span> <span class="attribute-name">modification-queue-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">thread-pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">23</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

         <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${system.property}<span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;/store&gt;</span>
   <span class="tag">&lt;/persistence&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Parameters that you can use to configure persistence are as follows:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1"><code>connection-attempts</code></dt> <dd> <p>Sets the maximum number of attempts to start each configured CacheWriter/CacheLoader. If the attempts to start are not successful, an exception is thrown and the cache does not start.</p> </dd> <dt class="hdlist1"><code>connection-interval</code></dt> <dd> <p>Specifies the time, in milliseconds, to wait between connection attempts on startup. A negative or zero value means no wait between connection attempts.</p> </dd> <dt class="hdlist1"><code>availability-interval</code></dt> <dd> <p>Specifies the time, in milliseconds, between availability checks to determine if the PersistenceManager is available. In other words, this interval sets how often stores/loaders are polled via their <code>org.infinispan.persistence.spi.CacheWriter#isAvailable</code> or <code>org.infinispan.persistence.spi.CacheLoader#isAvailable</code> implementation. If a single store/loader is not available, an exception is thrown during cache operations.</p> </dd> <dt class="hdlist1"><code>passivation</code></dt> <dd> <p>Enables passivation. The default value is <code>false</code> (boolean).</p> <div class="paragraph"> <p>This property has a significant impact on Infinispan interactions with the loaders. See <a href="#cache_passivation">Cache Passivation</a> for more information.</p> </div> </dd> <dt class="hdlist1"><code>class</code></dt> <dd> <p>Defines the class of the store and must implement <code>CacheLoader</code>, <code>CacheWriter</code>, or both.</p> </dd> <dt class="hdlist1"><code>fetch-state</code></dt> <dd> <p>Fetches the persistent state of a cache when joining a cluster. The default value is <code>false</code> (boolean).</p> <div class="paragraph"> <p>The purpose of this property is to retrieve the persistent state of a cache and apply it to the local cache store of a node when it joins a cluster. Fetching the persistent state does not apply if a cache store is shared because it accesses the same data as the other stores.</p> </div> <div class="paragraph"> <p>This property can be <code>true</code> for one configured cache loader only. If more than one cache loader fetches the persistent state, a configuration exception is thrown when the cache service starts.</p> </div> </dd> <dt class="hdlist1"><code>preload</code></dt> <dd> <p>Pre-loads data into memory from the cache loader when the cache starts. The default value is <code>false</code> (boolean).</p> <div class="paragraph"> <p>This property is useful when data in the cache loader is required immediately after startup to prevent delays with cache operations when the data is loaded lazily. This property can provide a "warm cache" on startup but it impacts performance because it affects start time.</p> </div> <div class="paragraph"> <p>Pre-loading data is done locally, so any data loaded is stored locally in the node only. The pre-loaded data is not replicated or distributed. Likewise, Infinispan pre-loads data only up to the maximum configured number of entries in <a href="#eviction_anchor">eviction</a>.</p> </div> </dd> <dt class="hdlist1"><code>shared</code></dt> <dd> <p>Determines if the cache loader is shared between cache instances. The default value is <code>false</code> (boolean).</p> <div class="paragraph"> <p>This property prevents duplicate writes of data to the cache loader by different cache instances. An example is where all cache instances in a cluster use the same JDBC settings for the same remote, shared database.</p> </div> </dd> </dl> </div> <div class="dlist"> <dl> <dt class="hdlist1"><code>segmented</code></dt> <dd> <p>Configures a cache store to segment data. The default value is <code>false</code> (boolean).</p> <div class="paragraph"> <p>If <code>true</code> the cache store stores data in buckets. The <code>hash.numSegments</code> property configures how many buckets there are for storing data.</p> </div> <div class="paragraph"> <p>Depending on the cache store implementation, segmenting data can cause slower write operations. However, performance improves for other cache operations. See <a href="#segmented_stores">Segmented Stores</a> for more information.</p> </div> </dd> <dt class="hdlist1"><code>read-only</code></dt> <dd> <p>Prevents new data from being persisted to the cache store. The default value is <code>false</code> (boolean).</p> </dd> <dt class="hdlist1"><code>purge</code></dt> <dd> <p>Empties the specified cache loader at startup. The default value is <code>false</code> (boolean). This property takes effect only if the <code>read-only</code> property is set to <code>false</code>.</p> </dd> <dt class="hdlist1"><code>max-batch-size</code></dt> <dd> <p>Sets the maximum size of a batch to insert of delete from the cache store. The default value is #{AbstractStore-maxBatchSize}.</p> <div class="paragraph"> <p>If the value is less than <code>1</code>, no upper limit applies to the number of operations in a batch.</p> </div> </dd> <dt class="hdlist1"><code>write-behind</code></dt> <dd> <p>Asynchronously persists data to the cache store. The default value is <code>false</code> (boolean). See <a href="#write_behind_asynchronous">Asynchronous Write-Behind</a> for more information.</p> </dd> </dl> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>You can define additional attributes in the <code>properties</code> section to configure specific aspects of each cache loader, such as the <code>myProp</code> attribute in the previous example.</p> </div> <div class="paragraph"> <p>Other cache loaders with more complex configurations also include additional properties. See the following JDBC cache store configuration for examples.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>The preceding configuration applies a generic cache store implementation. However, the default Infinispan store implementation has a more complex configuration schema, in which the <code>properties</code> section is replaced with XML attributes:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="comment">&lt;!-- note that class is missing and is induced by the fileStore element name --&gt;</span>
   <span class="tag">&lt;file-store</span>
           <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;write-behind</span> <span class="attribute-name">thread-pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The same configuration can be achieved programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence()
      .passivation(<span class="predefined-constant">false</span>)
      .addSingleFileStore()
         .preload(<span class="predefined-constant">true</span>)
         .shared(<span class="predefined-constant">false</span>)
         .fetchPersistentState(<span class="predefined-constant">true</span>)
         .ignoreModifications(<span class="predefined-constant">false</span>)
         .purgeOnStartup(<span class="predefined-constant">false</span>)
         .location(<span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">java.io.tmpdir</span><span class="delimiter">&quot;</span></span>))
         .async()
            .enabled(<span class="predefined-constant">true</span>)
            .threadPoolSize(<span class="integer">5</span>)</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="cache_passivation"><a class="anchor" href="#cache_passivation"></a>2.2. Cache Passivation</h3> <div class="paragraph"> <p>A CacheWriter can be used to enforce entry passivation and activation on eviction in a cache. Cache passivation is the process of removing an object from in-memory cache and writing it to a secondary data store (e.g., file system, database) on eviction. Cache activation is the process of restoring an object from the data store into the in-memory cache when it&#8217;s needed to be used. In order to fully support passivation, a store needs to be both a CacheWriter and a CacheLoader. In both cases, the configured cache store is used to read from the loader and write to the data writer.</p> </div> <div class="paragraph"> <p>When an eviction policy in effect evicts an entry from the cache, if passivation is enabled, a notification that the entry is being passivated will be emitted to the cache listeners and the entry will be stored. When a user attempts to retrieve a entry that was evicted earlier, the entry is (lazily) loaded from the cache loader into memory. When the entry has been loaded a notification is emitted to the cache listeners that the entry has been activated. In order to enable passivation just set passivation to true (false by default). When passivation is used, only the first cache loader configured is used and all others are ignored.</p> </div> <div class="sect3"> <h4 id="limitations"><a class="anchor" href="#limitations"></a>2.2.1. Limitations</h4> <div class="paragraph"> <p>Due to the unique nature of passivation, it is not supported with some other store configurations.</p> </div> <div class="ulist"> <ul> <li> <p>Transactional store - Passivation writes/removes entries from the store outside the scope of the actual Infinispan commit boundaries.</p> </li> <li> <p>Shared store - Shared store requires entries always being in the store for other owners. Thus passivation makes no sense as we can&#8217;t remove the entry from the store.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="cache_loader_behavior_with_passivation_disabled_vs_enabled"><a class="anchor" href="#cache_loader_behavior_with_passivation_disabled_vs_enabled"></a>2.2.2. Cache Loader Behavior with Passivation Disabled vs Enabled</h4> <div class="paragraph"> <p>When passivation is disabled, whenever an element is modified, added or removed, then that modification is persisted in the backend store via the cache loader. There is no direct relationship between eviction and cache loading. If you don&#8217;t use eviction, what&#8217;s in the persistent store is basically a copy of what&#8217;s in memory. If you do use eviction, what&#8217;s in the persistent store is basically a superset of what&#8217;s in memory (i.e. it includes entries that have been evicted from memory). When passivation is enabled, and with an unshared store, there is a direct relationship between eviction and the cache loader. Writes to the persistent store via the cache loader only occur as part of the eviction process. Data is deleted from the persistent store when the application reads it back into memory. In this case, what&#8217;s in memory and what&#8217;s in the persistent store are two subsets of the total information set, with no intersection between the subsets. With a shared store, entries which have been passivated in the past will continue to exist in the store, although they may have a stale value if this has been overwritten in memory.</p> </div> <div class="paragraph"> <p>The following is a simple example, showing what state is in RAM and in the persistent store after each step of a 6 step process:</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Operation</th> <th class="tableblock halign-left valign-top">Passivation Off</th> <th class="tableblock halign-left valign-top">Passivation On, Shared Off</th> <th class="tableblock halign-left valign-top">Passivation On, Shared On</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Insert keyOne</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br> <strong>Disk:</strong> keyOne</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br> <strong>Disk:</strong> (none)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br> <strong>Disk:</strong> (none)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Insert keyTwo</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne, keyTwo<br> <strong>Disk:</strong> keyOne, keyTwo</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne, keyTwo<br> <strong>Disk:</strong> (none)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne, keyTwo<br> <strong>Disk:</strong> (none)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Eviction thread runs, evicts keyOne</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyTwo<br> <strong>Disk:</strong> keyOne, keyTwo</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyTwo<br> <strong>Disk:</strong> keyOne</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyTwo<br> <strong>Disk:</strong> keyOne</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Read keyOne</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne, keyTwo<br> <strong>Disk:</strong> keyOne, keyTwo</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne, keyTwo<br> <strong>Disk:</strong> (none)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne, keyTwo<br> <strong>Disk:</strong> keyOne</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Eviction thread runs, evicts keyTwo</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br> <strong>Disk:</strong> keyOne, keyTwo</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br> <strong>Disk:</strong> keyTwo</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br> <strong>Disk:</strong> keyOne, keyTwo</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Remove keyTwo</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br> <strong>Disk:</strong> keyOne</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br> <strong>Disk:</strong> (none)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br> <strong>Disk:</strong> keyOne</p></td> </tr> </tbody> </table> </div> </div> <div class="sect2"> <h3 id="cache_loaders_and_transactional_caches"><a class="anchor" href="#cache_loaders_and_transactional_caches"></a>2.3. Cache Loaders and transactional caches</h3> <div class="paragraph"> <p>When a cache is transactional and a cache loader is present, the cache loader won&#8217;t be enlisted in the transaction in which the cache is part. That means that it is possible to have inconsistencies at cache loader level: the transaction to succeed applying the in-memory state but (partially) fail applying the changes to the store. Manual recovery would not work with caches stores.</p> </div> </div> <div class="sect2"> <h3 id="write_through_and_write_behind_caching"><a class="anchor" href="#write_through_and_write_behind_caching"></a>2.4. Write-Through And Write-Behind Caching</h3> <div class="paragraph"> <p>Infinispan can optionally be configured with one or several cache stores allowing it to store data in a persistent location such as shared JDBC database, a local filesystem, etc. Infinispan can handle updates to the cache store in two different ways:</p> </div> <div class="ulist"> <ul> <li> <p>Write-Through (Synchronous)</p> </li> <li> <p>Write-Behind (Asynchronous)</p> </li> </ul> </div> <div class="sect3"> <h4 id="write_through_synchronous"><a class="anchor" href="#write_through_synchronous"></a>2.4.1. Write-Through (Synchronous)</h4> <div class="paragraph"> <p>In this mode, which is supported in version 4.0, when clients update a cache entry, i.e. via a Cache.put() invocation, the call will not return until Infinispan has gone to the underlying cache store and has updated it. Normally, this means that updates to the cache store are done within the boundaries of the client thread.</p> </div> <div class="paragraph"> <p>The main advantage of this mode is that the cache store is updated at the same time as the cache, hence the cache store is consistent with the cache contents. On the other hand, using this mode reduces performance because the latency of having to access and update the cache store directly impacts the duration of the cache operation.</p> </div> <div class="paragraph"> <p>Configuring a write-through or synchronous cache store does not require any particular configuration option. By default, unless marked explicitly as write-behind or asynchronous, all cache stores are write-through or synchronous. Please find below a sample configuration file of a write-through unshared local file cache store:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;file-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="write_behind_asynchronous"><a class="anchor" href="#write_behind_asynchronous"></a>2.4.2. Write-Behind (Asynchronous)</h4> <div class="paragraph"> <p>In this mode, updates to the cache are asynchronously written to the cache store. Infinispan puts pending changes into a modification queue so that it can quickly store changes.</p> </div> <div class="paragraph"> <p>The configured number of threads consume the queue and apply the modifications to the underlying cache store. If the configured number of threads cannot consume the modifications fast enough, or if the underlying store becomes unavailable, the modification queue becomes full. In this event, the cache store becomes write-through until the queue can accept new entries.</p> </div> <div class="paragraph"> <p>This mode provides an advantage in that cache operations are not affected by updates to the underlying store. However, because updates happen asynchronously, there is a period of time during which data in the cache store is inconsistent with data in the cache.</p> </div> <div class="paragraph"> <p>The write-behind strategy is suitable for cache stores with low latency and small operational cost; for example, an unshared file-based cache store that is local to the cache itself. In this case, the time during which data is inconsistent between the cache store and the cache is reduced to the lowest possible period.</p> </div> <div class="paragraph"> <p>The following is an example configuration for the write-behind strategy:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;file-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="comment">&lt;!-- start write-behind configuration --&gt;</span>
   <span class="tag">&lt;write-behind</span> <span class="attribute-name">modification-queue-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">thread-pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">23</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="comment">&lt;!-- end write-behind configuration --&gt;</span>
   <span class="tag">&lt;/file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="segmented_stores"><a class="anchor" href="#segmented_stores"></a>2.4.3. Segmented Stores</h4> <div class="paragraph"> <p>You can configure stores so that data resides in segments to which keys map. See <a href="#key_ownership">Key Ownership</a> for more information about segments and ownership.</p> </div> <div class="paragraph"> <p>Segmented stores increase read performance for bulk operations; for example, streaming over data (<code>Cache.size</code>, <code>Cache.entrySet.stream</code>), pre-loading the cache, and doing state transfer operations.</p> </div> <div class="paragraph"> <p>However, segmented stores can also result in loss of performance for write operations. This performance loss applies particularly to batch write operations that can take place with transactions or write-behind stores. For this reason, you should evaluate the overhead for write operations before you enable segmented stores. The performance gain for bulk read operations might not be acceptable if there is a significant performance loss for write operations.</p> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="paragraph"> <p>Loss of data can occur if the number of segments in a cache store are not changed gracefully. For this reason, if you change the <code>numSegments</code> setting in the store configuration, you must migrate the existing store to use the new configuration.</p> </div> <div class="paragraph"> <p>The recommended method to migrate the cache store configuration is to perform a rolling upgrade. The store migrator supports migrating a non-segmented cache store to a segmented cache store only. The store migrator does not currently support migrating from a segmented cache store.</p> </div> </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>Not all cache stores support segmentation. See the appropriate section for each store to determine if it supports segmentation.</p> </div> <div class="paragraph"> <p>If you plan to convert or write a new store to support segmentation, see the following SPI section that provides more details.</p> </div> </td> </tr> </table> </div> </div> </div> <div class="sect2"> <h3 id="filesystem_based_cache_stores"><a class="anchor" href="#filesystem_based_cache_stores"></a>2.5. Filesystem based cache stores</h3> <div class="paragraph"> <p>A filesystem-based cache store is typically used when you want to have a cache with a cache store available locally which stores data that has overflowed from memory, having exceeded size and/or time restrictions.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Usage of filesystem-based cache stores on shared filesystems like NFS, Windows shares, etc. should be avoided as these do not implement proper file locking and can cause data corruption. File systems are inherently not transactional, so when attempting to use your cache in a transactional context, failures when writing to the file (which happens during the commit phase) cannot be recovered. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="sfs_cache_store"><a class="anchor" href="#sfs_cache_store"></a>2.6. Single File Store</h3> <div class="paragraph"> <p>The single file cache store keeps all data in a single file. The way it looks up data is by keeping an in-memory index of keys and the positions of their values in this file. This results in greater performance compared to old file cache store. There is one caveat though. Since the single file based cache store keeps keys in memory, it can lead to increased memory consumption, and hence it&#8217;s not recommended for caches with big keys.</p> </div> <div class="paragraph"> <p>In certain use cases, this cache store suffers from fragmentation: if you store larger and larger values, the space is not reused and instead the entry is appended at the end of the file. The space (now empty) is reused only if you write another entry that can fit there. Also, when you remove all entries from the cache, the file won&#8217;t shrink, and neither will be de-fragmented.</p> </div> <div class="paragraph"> <p>These are the available configuration options for the single file cache store:</p> </div> <div class="ulist"> <ul> <li> <p><code>path</code> where data will be stored. (e.g., <code>path="/tmp/myDataStore"</code>). By default, the location is <code>Infinispan-SingleFileStore</code>.</p> </li> <li> <p><code>max-entries</code> specifies the maximum number of entries to keep in this file store. As mentioned before, in order to speed up lookups, the single file cache store keeps an index of keys and their corresponding position in the file. To avoid this index resulting in memory consumption problems, this cache store can bounded by a maximum number of entries that it stores. If this limit is exceeded, entries are removed permanently using the LRU algorithm both from the in-memory index and the underlying file based cache store. So, setting a maximum limit only makes sense when Infinispan is used as a cache, whose contents can be recomputed or they can be retrieved from the authoritative data store. If this maximum limit is set when the Infinispan is used as an authoritative data store, it could lead to data loss, and hence it&#8217;s not recommended for this use case. The default value is <code>-1</code> which means that the file store size is unlimited.</p> </li> </ul> </div> <div class="sect3"> <h4 id="segmentation_support"><a class="anchor" href="#segmentation_support"></a>2.6.1. Segmentation support</h4> <div class="paragraph"> <p>The single file cache store supports segmentation and creates a separate instance per segment. Segmentation results in multiple directories under the configured directory, where each directory is a number that represents the segment to which the data maps.</p> </div> </div> <div class="sect3"> <h4 id="configuration_2"><a class="anchor" href="#configuration_2"></a>2.6.2. Configuration</h4> <div class="paragraph"> <p>The following examples show single file cache store configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;file-store</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/myDataStore</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addSingleFileStore()
    .location(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/myDataStore</span><span class="delimiter">&quot;</span></span>)
    .maxEntries(<span class="integer">5000</span>);</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sifs_cache_store"><a class="anchor" href="#sifs_cache_store"></a>2.7. Soft-Index File Store</h3> <div class="paragraph"> <p>The Soft-Index File Store is an experimental local file-based. It is a pure Java implementation that tries to get around Single File Store&#8217;s drawbacks by implementing a variant of B+ tree that is cached in-memory using Java&#8217;s soft references - here&#8217;s where the name Soft-Index File Store comes from. This B+ tree (called Index) is offloaded on filesystem to single file that does not need to be persisted - it is purged and rebuilt when the cache store restarts, its purpose is only offloading.</p> </div> <div class="paragraph"> <p>The data that should be persisted are stored in a set of files that are written in append-only way - that means that if you store this on conventional magnetic disk, it does not have to seek when writing a burst of entries. It is not stored in single file but set of files. When the usage of any of these files drops below 50% (the entries from the file are overwritten to another file), the file starts to be collected, moving the live entries into different file and in the end removing that file from disk.</p> </div> <div class="paragraph"> <p>Most of the structures in Soft Index File Store are bounded, therefore you don&#8217;t have to be afraid of OOMEs. For example, you can configure the limits for concurrently open files as well.</p> </div> <div class="sect3"> <h4 id="segmentation_support_2"><a class="anchor" href="#segmentation_support_2"></a>2.7.1. Segmentation support</h4> <div class="paragraph"> <p>The Soft-Index file store supports segmentation and creates a separate instance per segment. Segmentation results in multiple directories under the configured directory, where each directory is a number that represents the segment to which the data maps.</p> </div> </div> <div class="sect3"> <h4 id="configuration_3"><a class="anchor" href="#configuration_3"></a>2.7.2. Configuration</h4> <div class="paragraph"> <p>Here is an example of Soft-Index File Store configuration via XML:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
    <span class="tag">&lt;soft-index-file-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:soft-index:8.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;index</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/index</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;data</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/data</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/soft-index-file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Programmatic configuration would look as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addStore(SoftIndexFileStoreConfigurationBuilder.class)
        .indexLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/index</span><span class="delimiter">&quot;</span></span>);
        .dataLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/data</span><span class="delimiter">&quot;</span></span>)</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="current_limitations"><a class="anchor" href="#current_limitations"></a>2.7.3. Current limitations</h4> <div class="paragraph"> <p>Size of a node in the Index is limited, by default it is 4096 bytes, though it can be configured. This size also limits the key length (or rather the length of the serialized form): you can&#8217;t use keys longer than size of the node - 15 bytes. Moreover, the key length is stored as 'short', limiting it to 32767 bytes. There&#8217;s no way how you can use longer keys - SIFS throws an exception when the key is longer after serialization.</p> </div> <div class="paragraph"> <p>When entries are stored with expiration, SIFS cannot detect that some of those entries are expired. Therefore, such old file will not be compacted (method AdvancedStore.purgeExpired() is not implemented). This can lead to excessive file-system space usage.</p> </div> </div> </div> <div class="sect2"> <h3 id="jdbc_cache_store"><a class="anchor" href="#jdbc_cache_store"></a>2.8. JDBC String based Cache Store</h3> <div class="paragraph"> <p>A cache store which relies on the provided JDBC driver to load/store values in the underlying database.</p> </div> <div class="paragraph"> <p>Each key in the cache is stored in its own row in the database. In order to store each key in its own row, this store relies on a (pluggable) bijection that maps the each key to a String object. The bijection is defined by the Key2StringMapper interface. Infinispans ships a default implementation (smartly named DefaultTwoWayKey2StringMapper) that knows how to handle primitive types.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>By default Infinispan shares are not stored, meaning that all nodes in the cluster will write to the underlying store upon each update. If you wish for an operation to only be written to the underlying database once, you must configure the JDBC store to be shared.</p> </div> </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>The JDBC string-based cache store does not support segmentation. Support will be available in a future release.</p> </div> </td> </tr> </table> </div> <div class="sect3"> <h4 id="connection_management_pooling"><a class="anchor" href="#connection_management_pooling"></a>2.8.1. Connection management (pooling)</h4> <div class="paragraph"> <p>In order to obtain a connection to the database the JDBC cache store relies on a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/jdbc/connectionfactory/ConnectionFactory.html">ConnectionFactory</a> implementation. The connection factory is specified programmatically using one of the connectionPool(), dataSource() or simpleConnection() methods on the JdbcStringBasedStoreConfigurationBuilder class or declaratively using one of the <code>&lt;connectionPool /&gt;</code>, <code>&lt;dataSource /&gt;</code> or <code>&lt;simpleConnection /&gt;</code> elements.</p> </div> <div class="paragraph"> <p>Infinispan ships with three ConnectionFactory implementations:</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/jdbc/configuration/PooledConnectionFactoryConfigurationBuilder.html">PooledConnectionFactoryConfigurationBuilder</a> is a factory based on <a href="https://agroal.github.io/">Agroal</a>, which is configured via the PooledConnectionFactoryConfiguration or by specifying a properties file via <code>PooledConnectionFactoryConfiguration.propertyFile</code>. Properties must be specified with the prefix "org.infinispan.agroal.". An example <code>agroal.properties</code> file is shown below:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="properties">org.infinispan.agroal.metricsEnabled=false

org.infinispan.agroal.minSize=10
org.infinispan.agroal.maxSize=100
org.infinispan.agroal.initialSize=20
org.infinispan.agroal.acquisitionTimeout_s=1
org.infinispan.agroal.validationTimeout_m=1
org.infinispan.agroal.leakTimeout_s=10
org.infinispan.agroal.reapTimeout_m=10

org.infinispan.agroal.metricsEnabled=false
org.infinispan.agroal.autoCommit=true
org.infinispan.agroal.jdbcTransactionIsolation=READ_COMMITTED
org.infinispan.agroal.jdbcUrl=jdbc:h2:mem:PooledConnectionFactoryTest;DB_CLOSE_DELAY=-1
org.infinispan.agroal.driverClassName=org.h2.Driver.class
org.infinispan.agroal.principal=sa
org.infinispan.agroal.credential=sa</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/jdbc/configuration/ManagedConnectionFactoryConfigurationBuilder.html">ManagedConnectionFactoryConfigurationBuilder</a> is a connection factory that can be used within managed environments, such as application servers. It knows how to look into the JNDI tree at a certain location (configurable) and delegate connection management to the DataSource.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/jdbc/configuration/SimpleConnectionFactoryConfigurationBuilder.html">SimpleConnectionFactoryConfigurationBuilder</a> is a factory implementation that will create database connection on a per invocation basis. Not recommended in production.</p> </li> </ul> </div> <div class="paragraph"> <p>The <code>PooledConnectionFactory</code> is generally recommended for stand-alone deployments (i.e. not running within AS or servlet container). <code>ManagedConnectionFactory</code> can be used when running in a managed environment where a <code>DataSource</code> is present, so that connection pooling is performed within the <code>DataSource</code>.</p> </div> </div> <div class="sect3"> <h4 id="sample_configurations"><a class="anchor" href="#sample_configurations"></a>2.8.2. Sample configurations</h4> <div class="paragraph"> <p>Below is a sample configuration for the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a>. For detailed description of all the parameters used refer to the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;string-keyed-jdbc-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:jdbc:9.2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;connection-pool</span> <span class="attribute-name">connection-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_string_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">driver</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/string-keyed-table&gt;</span>
   <span class="tag">&lt;/string-keyed-jdbc-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence().addStore(JdbcStringBasedStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>)
      .ignoreModifications(<span class="predefined-constant">false</span>)
      .purgeOnStartup(<span class="predefined-constant">false</span>)
      .shared(<span class="predefined-constant">true</span>)
      .table()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
      .connectionPool()
         .connectionUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_string_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span>)
         .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>)
         .driverClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Finally, below is an example of a JDBC cache store with a managed connection factory, which is chosen implicitly by specifying a datasource JNDI location:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;string-keyed-jdbc-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:jdbc:9.2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;data-source</span> <span class="attribute-name">jndi-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/StringStoreWithManagedConnectionTest/DS</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/string-keyed-table&gt;</span>
<span class="tag">&lt;/string-keyed-jdbc-store&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence().addStore(JdbcStringBasedStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>)
      .ignoreModifications(<span class="predefined-constant">false</span>)
      .purgeOnStartup(<span class="predefined-constant">false</span>)
      .shared(<span class="predefined-constant">true</span>)
      .table()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
      .dataSource()
         .jndiUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/StringStoreWithManagedConnectionTest/DS</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Apache Derby users</div> If you&#8217;re connecting to an Apache Derby database, make sure you set dataColumnType to BLOB: <code>&lt;data-column name="DATA_COLUMN" type="BLOB"/&gt;</code> </td> </tr> </table> </div> </div> </div> <div class="sect2"> <h3 id="remote_cache_store"><a class="anchor" href="#remote_cache_store"></a>2.9. Remote store</h3> <div class="paragraph"> <p>The <code>RemoteStore</code> is a cache loader and writer implementation that stores data in a remote Infinispan cluster. In order to communicate with the remote cluster, the <code>RemoteStore</code> uses the HotRod client/server architecture. HotRod bering the load balancing and fault tolerance of calls and the possibility to fine-tune the connection between the RemoteCacheStore and the actual cluster. Please refer to Hot Rod for more information on the protocol, client and server configuration. For a list of RemoteStore configuration refer to the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/remote/configuration/RemoteStoreConfigurationBuilder.html">javadoc</a> . Example:</p> </div> <div class="sect3"> <h4 id="segmentation_support_3"><a class="anchor" href="#segmentation_support_3"></a>2.9.1. Segmentation support</h4> <div class="paragraph"> <p>The <code>RemoteStore</code> store supports segmentation because it can publish keys and entries by segment, allowing for more efficient bulk operations.</p> </div> <div class="paragraph"> <p>Segmentation is only supported when the remote server supports at least protocol version 2.3 or newer.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> <div class="paragraph"> <p>Ensure the number of segments and hash are the same between the store configured cache and the remote server otherwise bulk operations will not return correct results.</p> </div> </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="sample_usage"><a class="anchor" href="#sample_usage"></a>2.9.2. Sample Usage</h4> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;remote-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:remote:8.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">raw-values</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;remote-server</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">12111</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;remote-server</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">two</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;connection-pool</span> <span class="attribute-name">max-active</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exhausted-action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE_NEW</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;write-behind</span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence().addStore(RemoteStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>)
      .ignoreModifications(<span class="predefined-constant">false</span>)
      .purgeOnStartup(<span class="predefined-constant">false</span>)
      .remoteCacheName(<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span>)
      .rawValues(<span class="predefined-constant">true</span>)
.addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>).port(<span class="integer">12111</span>)
      .addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">two</span><span class="delimiter">&quot;</span></span>)
      .connectionPool()
      .maxActive(<span class="integer">10</span>)
      .exhaustedAction(ExhaustedAction.CREATE_NEW)
      .async().enable();</code></pre> </div> </div> <div class="paragraph"> <p>In this sample configuration, the remote cache store is configured to use the remote cache named "mycache" on servers "one" and "two". It also configures connection pooling and provides a custom transport executor. Additionally the cache store is asynchronous.</p> </div> </div> </div> <div class="sect2"> <h3 id="cluster_cache_loader"><a class="anchor" href="#cluster_cache_loader"></a>2.10. Cluster cache loader</h3> <div class="paragraph"> <p>The ClusterCacheLoader is a cache loader implementation that retrieves data from other cluster members.</p> </div> <div class="sect3"> <h4 id="clustercacheloader"><a class="anchor" href="#clustercacheloader"></a>2.10.1. ClusterCacheLoader</h4> <div class="paragraph"> <p>It is a cache loader only as it doesn&#8217;t persist anything (it is not a Store), therefore features like <em>fetchPersistentState</em> (and like) are not applicable.</p> </div> <div class="paragraph"> <p>A cluster cache loader can be used as a non-blocking (partial) alternative to <em>stateTransfer</em> : keys not already available in the local node are fetched on-demand from other nodes in the cluster. This is a kind of lazy-loading of the cache content.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>The cluster cache loader does not support segmentation.</p> </div> </td> </tr> </table> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;cluster-loader</span> <span class="attribute-name">remote-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addClusterLoader()
    .remoteCallTimeout(<span class="integer">500</span>);</code></pre> </div> </div> <div class="paragraph"> <p>For a list of ClusterCacheLoader configuration refer to the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/configuration/cache/ClusterLoaderConfiguration.html">javadoc</a> .</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The ClusterCacheLoader does not support preloading (<code>preload=true</code>). It also won&#8217;t provide state if <code>fetchPersistentSate=true</code>. </td> </tr> </table> </div> </div> </div> <div class="sect2"> <h3 id="cli_cache_loader"><a class="anchor" href="#cli_cache_loader"></a>2.11. Command-Line Interface cache loader</h3> <div class="paragraph"> <p>The Command-Line Interface (CLI) cache loader is a cache loader implementation that retrieves data from another Infinispan node using the CLI. The node to which the CLI connects to could be a standalone node, or could be a node that it&#8217;s part of a cluster. This cache loader is read-only, so it will only be used to retrieve data, and hence, won&#8217;t be used when persisting data.</p> </div> <div class="sect3"> <h4 id="cli_cache_loader_2"><a class="anchor" href="#cli_cache_loader_2"></a>2.11.1. CLI Cache Loader</h4> <div class="paragraph"> <p>The CLI cache loader is configured with a connection URL pointing to the Infinispan node to which connect to. Here is an example:</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>The Command-Line Interface (CLI) cache loader does not support segmentation.</p> </div> </td> </tr> </table> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;cli-loader</span> <span class="attribute-name">connection</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jmx://1.2.3.4:4444/MyCacheManager/myCache</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addStore(CLInterfaceLoaderConfigurationBuilder.class)
    .connectionString(<span class="string"><span class="delimiter">&quot;</span><span class="content">jmx://192.0.2.0:4444/MyCacheManager/myCache</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="rocksdb_cache_store"><a class="anchor" href="#rocksdb_cache_store"></a>2.12. RocksDB Cache Store</h3> <div class="paragraph"> <p>Infinispan supports using RocksDB as a cache store.</p> </div> <div class="sect3"> <h4 id="introduction"><a class="anchor" href="#introduction"></a>2.12.1. Introduction</h4> <div class="paragraph"> <p><a href="http://rocksdb.org/">RocksDB</a> is a fast key-value filesystem-based storage from Facebook. It started as a fork of Google&#8217;s LevelDB, but provides superior performance and reliability, especially in highly concurrent scenarios.</p> </div> </div> <div class="sect3"> <h4 id="segmentation_support_4"><a class="anchor" href="#segmentation_support_4"></a>2.12.2. Segmentation support</h4> <div class="paragraph"> <p>The RocksDB cache store supports segmentation and creates a separate column family per segment, which substantially improves lookup performance and iteration. However, write operations are a little slower when the cache store is segmented.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>You should not configure more than a few hundred segments. RocksDB is not designed to have an unlimited number of column families. Too many segments also significantly increases startup time for the cache store.</p> </div> </td> </tr> </table> </div> <div class="sect4"> <h5 id="sample_usage_2"><a class="anchor" href="#sample_usage_2"></a>Sample Usage</h5> <div class="paragraph"> <p>The RocksDB cache store requires 2 filesystem directories to be configured - each directory contains a RocksDB database: one location is used to store non-expired data, while the second location is used to store expired keys pending purge.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
                                .addStore(RocksDBStoreConfigurationBuilder.class)
                                .build();
EmbeddedCacheManager cacheManager = <span class="keyword">new</span> DefaultCacheManager(cacheConfig);

Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">usersCache</span><span class="delimiter">&quot;</span></span>);
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User(...));</code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="configuration_4"><a class="anchor" href="#configuration_4"></a>2.12.3. Configuration</h4> <div class="paragraph"> <p>It is also possible to configure the underlying rocks db instance. This can be done via properties in the store configuration. Any property that is prefixed with the name <code>database</code> will configure the rocks db database. Data is now stored in column families, these can be configured independently of the database by setting a property prefixed with the name <code>data</code>.</p> </div> <div class="paragraph"> <p>Note that you do not have to supply properties and this is entirely optional.</p> </div> <div class="sect4"> <h5 id="sample_programatic_configuration"><a class="anchor" href="#sample_programatic_configuration"></a>Sample Programatic Configuration</h5> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">database.max_background_compactions</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>);
props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">data.write_buffer_size</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">512MB</span><span class="delimiter">&quot;</span></span>);

<span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
                                .addStore(RocksDBStoreConfigurationBuilder.class)
                                .location(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/rocksdb/data</span><span class="delimiter">&quot;</span></span>)
                                .expiredLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/rocksdb/expired</span><span class="delimiter">&quot;</span></span>)
        .properties(props)
                                .build();</code></pre> </div> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Parameter</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">location</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Directory to use for RocksDB to store primary cache store data. The directory will be auto-created if it does not exit.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">expiredLocation</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Directory to use for RocksDB to store expiring data pending to be purged permanently. The directory will be auto-created if it does not exit.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">expiryQueueSize</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Size of the in-memory queue to hold expiring entries before it gets flushed into expired RocksDB store</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">clearThreshold</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">There are two methods to clear all entries in RocksDB. One method is to iterate through all entries and remove each entry individually. The other method is to delete the database and re-init. For smaller databases, deleting individual entries is faster than the latter method. This configuration sets the max number of entries allowed before using the latter method</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">compressionType</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Configuration for RocksDB for data compression, see CompressionType enum for options</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">blockSize</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Configuration for RocksDB - see <a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide">documentation</a> for performance tuning</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">cacheSize</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Configuration for RocksDB - see <a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide">documentation</a> for performance tuning</p></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="sample_xml_configuration"><a class="anchor" href="#sample_xml_configuration"></a>Sample XML Configuration</h5> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vehicleCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;persistence&gt;</span>
      <span class="tag">&lt;rocksdb-store</span><span class="error"> </span><span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/rocksdb/data</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;expiration</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/rocksdb/expired</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">database.max_background_compactions</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>2<span class="tag">&lt;/property&gt;</span>
         <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">data.write_buffer_size</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>512MB<span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;/rocksdb-store&gt;</span>
   <span class="tag">&lt;/persistence&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="additional_references"><a class="anchor" href="#additional_references"></a>2.12.4. Additional References</h4> <div class="paragraph"> <p>Refer to the <a href="https://github.com/infinispan/infinispan/blob/master/persistence/rocksdb/src/test/java/org/infinispan/persistence/rocksdb/config/ConfigurationTest.java">test case</a> for code samples in action.</p> </div> <div class="paragraph"> <p>Refer to <a href="https://github.com/infinispan/infinispan/tree/master/persistence/rocksdb/src/test/resources/config/">test configurations</a> for configuration samples.</p> </div> </div> </div> <div class="sect2"> <h3 id="jpa_cache_store"><a class="anchor" href="#jpa_cache_store"></a>2.13. JPA Cache Store</h3> <div class="paragraph"> <p>The implementation depends on JPA 2.0 specification to access entity meta model.</p> </div> <div class="paragraph"> <p>In normal use cases, it&#8217;s recommended to leverage Infinispan for JPA second level cache and/or query cache. However, if you&#8217;d like to use only Infinispan API and you want Infinispan to persist into a cache store using a common format (e.g., a database with well defined schema), then JPA Cache Store could be right for you.</p> </div> <div class="ulist"> <div class="title">Things to note</div> <ul> <li> <p>When using JPA Cache Store, the key should be the ID of the entity, while the value should be the entity object.</p> </li> <li> <p>Only a single <code>@Id</code> or <code>@EmbeddedId</code> annotated property is allowed.</p> </li> <li> <p>Auto-generated ID is not supported.</p> </li> <li> <p>Lastly, all entries will be stored as immortal entries.</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>The JPA cache store does not support segmentation.</p> </div> </td> </tr> </table> </div> <div class="sect3"> <h4 id="sample_usage_3"><a class="anchor" href="#sample_usage_3"></a>2.13.1. Sample Usage</h4> <div class="paragraph"> <p>For example, given a persistence unit "myPersistenceUnit", and a JPA entity User:</p> </div> <div class="listingblock"> <div class="title">persistence.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myPersistenceUnit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
<span class="tag">&lt;/persistence-unit&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>User entity class</p> </div> <div class="listingblock"> <div class="title">User.java</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
        <span class="annotation">@Id</span>
        <span class="directive">private</span> <span class="predefined-type">String</span> username;
        <span class="directive">private</span> <span class="predefined-type">String</span> firstName;
        <span class="directive">private</span> <span class="predefined-type">String</span> lastName;

        ...
}</code></pre> </div> </div> <div class="paragraph"> <p>Then you can configure a cache "usersCache" to use JPA Cache Store, so that when you put data into the cache, the data would be persisted into the database based on JPA configuration.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager cacheManager = ...;

<span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
            .addStore(JpaStoreConfigurationBuilder.class)
            .persistenceUnitName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.loaders.jpa.configurationTest</span><span class="delimiter">&quot;</span></span>)
            .entityClass(User.class)
            .build();
cacheManager.defineCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">usersCache</span><span class="delimiter">&quot;</span></span>, cacheConfig);

Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">usersCache</span><span class="delimiter">&quot;</span></span>);
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User(...));</code></pre> </div> </div> <div class="paragraph"> <p>Normally a single Infinispan cache can store multiple types of key/value pairs, for example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>);
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User());
Cache&lt;<span class="predefined-type">Integer</span>, Teacher&gt; teachersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>);
teachersCache.put(<span class="integer">1</span>, <span class="keyword">new</span> Teacher());</code></pre> </div> </div> <div class="paragraph"> <p>It&#8217;s important to note that, when a cache is configured to use a JPA Cache Store, that cache would only be able to store ONE type of data.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myJPACache</span><span class="delimiter">&quot;</span></span>); <span class="comment">// configured for User entity class</span>
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User());
Cache&lt;<span class="predefined-type">Integer</span>, Teacher&gt; teachersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myJPACache</span><span class="delimiter">&quot;</span></span>); <span class="comment">// cannot do this when this cache is configured to use a JPA cache store</span>
teachersCache.put(<span class="integer">1</span>, <span class="keyword">new</span> Teacher());</code></pre> </div> </div> <div class="paragraph"> <p>Use of <code>@EmbeddedId</code> is supported so that you can also use composite keys.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Vehicle</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
        <span class="annotation">@EmbeddedId</span>
        <span class="directive">private</span> VehicleId id;
        <span class="directive">private</span> <span class="predefined-type">String</span> color;        ...
}

<span class="annotation">@Embeddable</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">VehicleId</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span>
{
        <span class="directive">private</span> <span class="predefined-type">String</span> state;
        <span class="directive">private</span> <span class="predefined-type">String</span> licensePlate;
        ...
}</code></pre> </div> </div> <div class="paragraph"> <p>Lastly, auto-generated IDs ﻿(e.g., <code>@GeneratedValue</code>) is not supported. When putting things into the cache with a JPA cache store, the key should be the ID value!</p> </div> </div> <div class="sect3"> <h4 id="configuration_5"><a class="anchor" href="#configuration_5"></a>2.13.2. Configuration</h4> <div class="sect4"> <h5 id="sample_programmatic_configuration"><a class="anchor" href="#sample_programmatic_configuration"></a>Sample Programmatic Configuration</h5> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
             .addStore(JpaStoreConfigurationBuilder.class)
             .persistenceUnitName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.loaders.jpa.configurationTest</span><span class="delimiter">&quot;</span></span>)
             .entityClass(User.class)
             .build();</code></pre> </div> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Parameter</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">persistenceUnitName</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">JPA persistence unit name in JPA configuration ﻿(persistence.xml) that contains the JPA entity class</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">entityClass</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">JPA entity class that is expected to be stored in this cache. Only one class is allowed.</p></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="sample_xml_configuration_2"><a class="anchor" href="#sample_xml_configuration_2"></a>Sample XML Configuration</h5> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vehicleCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;jpa-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:jpa:7.0</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">persistence-unit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.persistence.jpa.configurationTest</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">entity-class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.persistence.jpa.entity.Vehicle</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                /<span class="error">&gt;</span>
   <span class="tag">&lt;/persistence&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Parameter</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">persistence-unit</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">JPA persistence unit name in JPA configuration ﻿(persistence.xml) that contains the JPA entity class</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">entity-class</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Fully qualified JPA entity class name that is expected to be stored in this cache. Only one class is allowed.</p></td> </tr> </tbody> </table> </div> </div> <div class="sect3"> <h4 id="additional_references_2"><a class="anchor" href="#additional_references_2"></a>2.13.3. Additional References</h4> <div class="paragraph"> <p>Refer to the <a href="https://github.com/infinispan/infinispan/blob/master/persistence/jpa/src/test/java/org/infinispan/persistence/jpa/JpaConfigurationTest.java">test case</a> for code samples in action.</p> </div> <div class="paragraph"> <p>Refer to <a href="https://github.com/infinispan/infinispan/blob/master/persistence/jpa/src/test/resources/config/jpa-config.xml">test configurations</a> for configuration samples.</p> </div> </div> </div> <div class="sect2"> <h3 id="custom_cache_stores"><a class="anchor" href="#custom_cache_stores"></a>2.14. Custom Cache Stores</h3> <div class="paragraph"> <p>If the provided cache stores do not fulfill all of your requirements, it is possible for you to implement your own store. The steps required to create your own store are as follows:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Write your custom store by implementing one of the following interfaces:</p> <div class="ulist"> <ul> <li> <p><code>org.infinispan.persistence.spi.AdvancedCacheWriter</code></p> </li> <li> <p><code>org.infinispan.persistence.spi.AdvancedCacheLoader</code></p> </li> <li> <p><code>org.infinispan.persistence.spi.CacheLoader</code></p> </li> <li> <p><code>org.infinispan.persistence.spi.CacheWriter</code></p> </li> <li> <p><code>org.infinispan.persistence.spi.ExternalStore</code></p> </li> <li> <p><code>org.infinispan.persistence.spi.AdvancedLoadWriteStore</code></p> </li> <li> <p><code>org.infinispan.persistence.spi.TransactionalCacheWriter</code></p> </li> <li> <p><code>org.infinispan.persistence.spi.SegmentedAdvancedLoadWriteStore</code></p> </li> </ul> </div> </li> <li> <p>Annotate your store class with the <code>@Store</code> annotation and specify the properties relevant to your store, e.g. is it possible for the store to be shared in Replicated or Distributed mode: <code>@Store(shared = true)</code>.</p> </li> <li> <p>Create a custom cache store configuration and builder. This requires extending <code>AbstractStoreConfiguration</code> and <code>AbstractStoreConfigurationBuilder</code>. As an optional step, you should add the following annotations to your configuration - <code>@ConfigurationFor</code>, <code>@BuiltBy</code> as well as adding <code>@ConfiguredBy</code> to your store implementation class. These additional annotations will ensure that your custom configuration builder is used to parse your store configuration from xml. If these annotations are not added, then the <code>CustomStoreConfigurationBuilder</code> will be used to parse the common store attributes defined in <code>AbstractStoreConfiguration</code> and any additional elements will be ignored. If a store and its configuration do not declare the <code>@Store</code> and <code>@ConfigurationFor</code> annotations respectively, a warning message will be logged upon cache initialisation.</p> <div class="paragraph"> <p>If you wish for your store to be segmented, where it will craete a different store instance per segment, instead of extending <code>AbstractStoreConfiguration</code> you should extend <code>AbstractSegmentedStoreConfiguration</code>.</p> </div> </li> <li> <p>Add your custom store to your cache&#8217;s configuration:</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>Add your custom store to the ConfigurationBuilder, for example:</p> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> config = <span class="keyword">new</span> ConfigurationBuilder()
            .persistence()
            .addStore(CustomStoreConfigurationBuilder.class)
            .build();</code></pre> </div> </div> </li> <li> <p>Define your custom store via xml:</p> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customStoreExample</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;persistence&gt;</span>
    <span class="tag">&lt;store</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.persistence.dummy.DummyInMemoryStore</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
  <span class="tag">&lt;/persistence&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> </li> </ol> </div> </li> </ol> </div> <div class="sect3"> <h4 id="hotrod_deployment"><a class="anchor" href="#hotrod_deployment"></a>2.14.1. HotRod Deployment</h4> <div class="paragraph"> <p>A Custom Cache Store can be packaged into a separate JAR file and deployed in a HotRod server using the following steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Follow <a href="#custom_cache_stores">Custom Cache Stores</a>, steps 1-3&gt;&gt; in the previous section and package your implementations in a JAR file (or use a Custom Cache Store Archetype).</p> </li> <li> <p>In your Jar create a proper file under <code>META-INF/services/</code>, which contains the fully qualified class name of your store implementation. The name of this service file should reflect the interface that your store implements. For example, if your store implements the <code>AdvancedCacheWriter</code> interface than you need to create the following file:</p> <div class="ulist"> <ul> <li> <p><code>/META-INF/services/org.infinispan.persistence.spi.AdvancedCacheWriter</code></p> </li> </ul> </div> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> </div> </div> <div class="sect2"> <h3 id="store_migrator"><a class="anchor" href="#store_migrator"></a>2.15. Store Migrator</h3> <div class="paragraph"> <p>Infinispan 9.0 introduced changes to internal marshalling functionality that are not backwardly compatible with previous versions of Infinispan. As a result, Infinispan 9.x and later cannot read cache stores created in earlier versions of Infinispan. Additionally, Infinispan no longer provides some store implementations such as JDBC Mixed and Binary stores.</p> </div> <div class="paragraph"> <p>You can use <code>StoreMigrator.java</code> to migrate cache stores. This migration tool reads data from cache stores in previous versions and rewrites the content for compatibility with the current marshalling implementation.</p> </div> <div class="sect3"> <h4 id="migrating_cache_stores"><a class="anchor" href="#migrating_cache_stores"></a>2.15.1. Migrating Cache Stores</h4> <div class="paragraph"> <p>To perform a migration with <code>StoreMigrator</code>,</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Put <code>infinispan-tools-10.0.jar</code> and dependencies for your source and target databases, such as JDBC drivers, on your classpath.</p> </li> <li> <p>Create a <code>.properties</code> file that contains configuration properties for the source and target cache stores.</p> <div class="paragraph"> <p>You can find an example properties file that contains all applicable configuration options in <a href="https://github.com/infinispan/infinispan/blob/master/tools/src/main/resources/migrator.properties">migrator.properties</a>.</p> </div> </li> <li> <p>Specify <code>.properties</code> file as an argument for <code>StoreMigrator</code>.</p> </li> <li> <p>Run <code>mvn exec:java</code> to execute the migrator.</p> </li> </ol> </div> <div class="paragraph"> <p>See the following example Maven <code>pom.xml</code> for <code>StoreMigrator</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;project</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/POM/4.0.0</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;modelVersion&gt;</span>4.0.0<span class="tag">&lt;/modelVersion&gt;</span>

    <span class="tag">&lt;groupId&gt;</span>org.infinispan.example<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jdbc-migrator-example<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span>

    <span class="tag">&lt;dependencies&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>infinispan-tools<span class="tag">&lt;/artifactId&gt;</span>
            <span class="comment">&lt;!-- Replace ${version.infinispan} with the
            version of Infinispan that you're using. --&gt;</span>
            <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>

        <span class="comment">&lt;!-- ADD YOUR REQUIRED DEPENDENCIES HERE --&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>

    <span class="tag">&lt;build&gt;</span>
        <span class="tag">&lt;plugins&gt;</span>
            <span class="tag">&lt;plugin&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.codehaus.mojo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>exec-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>1.2.1<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;executions&gt;</span>
                    <span class="tag">&lt;execution&gt;</span>
                        <span class="tag">&lt;goals&gt;</span>
                            <span class="tag">&lt;goal&gt;</span>java<span class="tag">&lt;/goal&gt;</span>
                        <span class="tag">&lt;/goals&gt;</span>
                    <span class="tag">&lt;/execution&gt;</span>
                <span class="tag">&lt;/executions&gt;</span>
                <span class="tag">&lt;configuration&gt;</span>
                    <span class="tag">&lt;mainClass&gt;</span>StoreMigrator<span class="tag">&lt;/mainClass&gt;</span>
                    <span class="tag">&lt;arguments&gt;</span>
                        <span class="tag">&lt;argument&gt;</span><span class="comment">&lt;!-- PATH TO YOUR MIGRATOR.PROPERTIES FILE --&gt;</span><span class="tag">&lt;/argument&gt;</span>
                    <span class="tag">&lt;/arguments&gt;</span>
                <span class="tag">&lt;/configuration&gt;</span>
            <span class="tag">&lt;/plugin&gt;</span>
        <span class="tag">&lt;/plugins&gt;</span>
    <span class="tag">&lt;/build&gt;</span>
<span class="tag">&lt;/project&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="store_migrator_properties"><a class="anchor" href="#store_migrator_properties"></a>2.15.2. Store Migrator Properties</h4> <div class="paragraph"> <p>All migrator properties are configured within the context of a source or target store. Each property must start with either <code>source.</code> or <code>target.</code>.</p> </div> <div class="paragraph"> <p>All properties in the following sections apply to both source and target stores, except for <code>table.binary.*</code> properties because it is not possible to migrate to a binary table.</p> </div> <div class="sect4"> <h5 id="common_properties"><a class="anchor" href="#common_properties"></a>Common Properties</h5> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Property</th> <th class="tableblock halign-left valign-top">Description</th> <th class="tableblock halign-left valign-top">Example value</th> <th class="tableblock halign-left valign-top">Required</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">JDBC_STRING | JDBC_BINARY | JDBC_MIXED | LEVELDB | ROCKSDB | SINGLE_FILE_STORE | SOFT_INDEX_FILE_STORE</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">JDBC_MIXED</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">cache_name</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The name of the cache associated with the store</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">persistentMixedCache</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">segment_count</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">How many segments this store will be created with. If not provided store will not be segmented. (supported as target only - JDBC not yet supported)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>It should be noted that the <strong>segment_count</strong> property should match how many segments your cache will be using. That is that it should match the <code>clustering.hash.numSegments</code> config value. If these do not match, data will not be properly read when running the cache.</p> </div> </div> <div class="sect4"> <h5 id="jdbc_properties"><a class="anchor" href="#jdbc_properties"></a>JDBC Properties</h5> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Property</th> <th class="tableblock halign-left valign-top">Description</th> <th class="tableblock halign-left valign-top">Example value</th> <th class="tableblock halign-left valign-top">Required</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">dialect</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The dialect of the underlying database</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">POSTGRES</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">marshaller.type</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The marshaller to use for the store. Possible values are:</p> <p class="tableblock">- <code>LEGACY</code> Infinispan 8.2.x marshaller. Valid for source stores only.</p> <p class="tableblock">- <code>CURRENT</code> Infinispan 9.x marshaller.</p> <p class="tableblock">- <code>CUSTOM</code> Custom marshaller.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">CURRENT</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">marshaller.class</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The class of the marshaller if type=CUSTOM</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">org.example.CustomMarshaller</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">marshaller.externalizers</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">A comma-separated list of custom AdvancedExternalizer implementations to load <code>[id]:&lt;Externalizer class&gt;</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>25:Externalizer1,org.example.Externalizer2</code></p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">connection_pool.connection_url</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The JDBC connection url</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>jdbc:postgresql:postgres</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">connection_pool.driver_class</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The class of the JDBC driver</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">org.postrgesql.Driver</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">connection_pool.username</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Database username</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">connection_pool.password</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Database password</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">db.major_version</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Database major version</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">db.minor_version</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Database minor version</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">db.disable_upsert</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Disable db upsert</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">db.disable_indexing</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Prevent table index being created</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">table.<code>&lt;binary|string&gt;</code>.table_name_prefix</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Additional prefix for table name</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">tablePrefix</p></td> <td class="tableblock halign-left valign-top"></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">table.<code>&lt;binary|string&gt;</code>.<code>&lt;id|data|timestamp&gt;</code>.name</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Name of the column</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">id_column</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">table.<code>&lt;binary|string&gt;</code>.<code>&lt;id|data|timestamp&gt;</code>.type</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Type of the column</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">VARCHAR</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">key_to_string_mapper</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TwoWayKey2StringMapper Class</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.infinispan.persistence.keymappers. DefaultTwoWayKey2StringMapper</code></p></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="leveldbrocksdb_properties"><a class="anchor" href="#leveldbrocksdb_properties"></a>LevelDB/RocksDB Properties</h5> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Property</th> <th class="tableblock halign-left valign-top">Description</th> <th class="tableblock halign-left valign-top">Example value</th> <th class="tableblock halign-left valign-top">Required</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">location</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The location of the db directory</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">/some/example/dir</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">compression</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The compression type to be used</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">SNAPPY</p></td> <td class="tableblock halign-left valign-top"></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="singlefilestore_properties"><a class="anchor" href="#singlefilestore_properties"></a>SingleFileStore Properties</h5> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Property</th> <th class="tableblock halign-left valign-top">Description</th> <th class="tableblock halign-left valign-top">Example value</th> <th class="tableblock halign-left valign-top">Required</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">location</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The directory containing the store&#8217;s .dat file</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">/some/example/dir</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="softindexfilestore_properties"><a class="anchor" href="#softindexfilestore_properties"></a>SoftIndexFileStore Properties</h5> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Property</th> <th class="tableblock halign-left valign-top">Description</th> <th class="tableblock halign-left valign-top">Example value</th> <th class="tableblock halign-left valign-top">Required</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">location</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The location of the db directory</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">/some/example/dir</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">index_location</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The location of the db&#8217;s index</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">/some/example/dir-index</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Target Only</p></td> </tr> </tbody> </table> </div> </div> </div> <div class="sect2"> <h3 id="spi"><a class="anchor" href="#spi"></a>2.16. SPI</h3> <div class="paragraph"> <p>The following class diagram presents the main SPI interfaces of the persistence API:</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./../../topics/images/Figure2_1_persistence_API.png" alt="Figure2 1 persistence API"> </div> <div class="title">Figure 1. Persistence SPI</div> </div> <div class="paragraph"> <p>Some notes about the classes:</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/io/ByteBuffer.html">ByteBuffer</a> - abstracts the serialized form of an object</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/spi/MarshalledEntry.html">MarshalledEntry</a> - abstracts the information held within a persistent store corresponding to a key-value added to the cache. Provides method for reading this information both in serialized (<a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/io/ByteBuffer.html">ByteBuffer</a>) and deserialized (Object) format. Normally data read from the store is kept in serialized format and lazily deserialized on demand, within the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/spi/MarshalledEntry.html">MarshalledEntry</a> implementation</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/spi/CacheWriter.html">CacheWriter</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/spi/CacheLoader.html">CacheLoader</a> provide basic methods for reading and writing to a store</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/spi/AdvancedCacheLoader.html">AdvancedCacheLoader</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/spi/AdvancedCacheWriter.html">AdvancedCacheWriter</a> provide operations to manipulate the underlaying storage in bulk: parallel iteration and purging of expired entries, clear and size.</p> </li> </ul> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/spi/SegmentedAdvancedLoadWriteStore.html">SegmentedAdvancedLoadWriteStore</a> provide all the various operations that deal with segments.</p> </li> </ul> </div> <div class="paragraph"> <p>A cache store can be segmented if it does one of the following:</p> </div> <div class="ulist"> <ul> <li> <p>Implements the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/spi/SegmentedAdvancedLoadWriteStore.html">SegmentedAdvancedLoadWriteStore</a> interface. In this case only a single store instance is used per cache.</p> </li> <li> <p>Has a configuration that extends the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/configuration/cache/AbstractSegmentedConfiguration.html">AbstractSegmentedConfiguration</a> abstract class. Doing this requires you to implement the <code>newConfigurationFrom</code> method where it is expected that a new <code>StoreConfiguration</code> instance is created per invocation. This creates a store instance per segment to which a node can write. Stores might start and stop as data is moved between nodes.</p> </li> </ul> </div> <div class="paragraph"> <p>A provider might choose to only implement a subset of these interfaces:</p> </div> <div class="ulist"> <ul> <li> <p>Not implementing the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/spi/AdvancedCacheWriter.html">AdvancedCacheWriter</a> makes the given writer not usable for purging expired entries or clear</p> </li> <li> <p>If a loader does not implement the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/persistence/spi/AdvancedCacheLoader.html">AdvancedCacheLoader</a> inteface, then it will not participate in preloading nor in cache iteration (required also for stream operations).</p> </li> </ul> </div> <div class="paragraph"> <p>If you&#8217;re looking at migrating your existing store to the new API or to write a new store implementation, the <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/persistence/file/SingleFileStore.java">SingleFileStore</a> might be a good starting point/example.</p> </div> <div class="sect3"> <h4 id="more_implementations"><a class="anchor" href="#more_implementations"></a>2.16.1. More implementations</h4> <div class="paragraph"> <p>Many more cache loader and cache store implementations exist. Visit <a href="http://infinispan.org/cache-store-implementations">this website</a> for more details.</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="partition_handling"><a class="anchor" href="#partition_handling"></a>3. Setting Up Partition Handling</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="partition_handling-admin"><a class="anchor" href="#partition_handling-admin"></a>3.1. Partition handling</h3> <div class="paragraph"> <p>An Infinispan cluster is built out of a number of nodes where data is stored. In order not to lose data in the presence of node failures, Infinispan copies the same data&#8201;&#8212;&#8201;cache entry in Infinispan parlance&#8201;&#8212;&#8201;over multiple nodes. This level of data redundancy is configured through the <code>numOwners</code> configuration attribute and ensures that as long as fewer than <code>numOwners</code> nodes crash simultaneously, Infinispan has a copy of the data available.</p> </div> <div class="paragraph"> <p>However, there might be catastrophic situations in which more than <code>numOwners</code> nodes disappear from the cluster:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">Split brain</dt> <dd> <p>Caused e.g. by a router crash, this splits the cluster in two or more partitions, or sub-clusters that operate independently. In these circumstances, multiple clients reading/writing from different partitions see different versions of the same cache entry, which for many application is problematic. Note there are ways to alleviate the possibility for the split brain to happen, such as redundant networks or <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/s2-networkscripts-interfaces-chan.html">IP bonding</a>. These only reduce the window of time for the problem to occur, though.</p> </dd> <dt class="hdlist1"><code>numOwners</code> nodes crash in sequence</dt> <dd> <p>When at least <code>numOwners</code> nodes crash in rapid succession and Infinispan does not have the time to properly rebalance its state between crashes, the result is partial data loss.</p> </dd> </dl> </div> <div class="paragraph"> <p>The partition handling functionality discussed in this section allows the user to configure what operations can be performed on a cache in the event of a split brain occurring. Infinispan provides multiple partition handling strategies, which in terms of Brewer&#8217;s <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a> determine whether availability or consistency is sacrificed in the presence of partition(s). Below is a list of the provided strategies:</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Strategy</th> <th class="tableblock halign-left valign-top">Description</th> <th class="tableblock halign-left valign-top">CAP</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">DENY_READ_WRITES</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If the partition does not have all owners for a given segment, both reads and writes are denied for all keys in that segment.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Consistency</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">ALLOW_READS</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Allows reads for a given key if it exists in this partition, but only allows writes if this partition contains all owners of a segment. This is still a consistent approach because some entries are readable if available in this partition, but from a client application perspective it is not deterministic.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Consistency</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">ALLOW_READ_WRITES</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Allow entries on each partition to diverge, with conflict resolution attempted upon the partitions merging.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Availability</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>The requirements of your application should determine which strategy is appropriate. For example, DENY_READ_WRITES is more appropriate for applications that have high consistency requirements; i.e. when the data read from the system must be accurate. Whereas if Infinispan is used as a best-effort cache, partitions maybe perfectly tolerable and the ALLOW_READ_WRITES might be more appropriate as it favours availability over consistency.</p> </div> <div class="paragraph"> <p>The following sections describe how Infinispan handles <a href="#split_brain">split brain</a> and <a href="#successive_node_failures">successive failures</a> for each of the partition handling strategies. This is followed by a section describing how Infinispan allows for automatic conflict resolution upon partition merges via <a href="#merge_policies">merge policies</a>. Finally, we provide a section describing <a href="#partition_handling_configuration">how to configure partition handling strategies and merge policies</a>.</p> </div> <div class="sect3"> <h4 id="split_brain"><a class="anchor" href="#split_brain"></a>3.1.1. Split brain</h4> <div class="paragraph"> <p>In a split brain situation, each network partition will install its own JGroups view, removing the nodes from the other partition(s). We don&#8217;t have a direct way of determining whether the has been split into two or more partitions, since the partitions are unaware of each other. Instead, we assume the cluster has split when one or more nodes disappear from the JGroups cluster without sending an explicit leave message.</p> </div> <div class="sect4"> <h5 id="split_strategies"><a class="anchor" href="#split_strategies"></a>Split Strategies</h5> <div class="paragraph"> <p>In this section, we detail how each partition handling strategy behaves in the event of split brain occurring.</p> </div> <div class="sect5"> <h6 id="allow_read_writes"><a class="anchor" href="#allow_read_writes"></a>ALLOW_READ_WRITES</h6> <div class="paragraph"> <p>Each partition continues to function as an independent cluster, with all partitions remaining in AVAILABLE mode. This means that each partition may only see a part of the data, and each partition could write conflicting updates in the cache. During a partition merge these conflicts are automatically resolved by utilising the <a href="#conflict_manager">ConflictManager</a> and the configured <a href="#merge_policies">EntryMergePolicy</a>.</p> </div> </div> <div class="sect5"> <h6 id="deny_read_writes"><a class="anchor" href="#deny_read_writes"></a>DENY_READ_WRITES</h6> <div class="paragraph"> <p>When a split is detected each partition does not start a rebalance immediately, but first it checks whether it should enter <strong>DEGRADED</strong> mode instead:</p> </div> <div class="ulist"> <ul> <li> <p>If at least one segment has lost all its owners (meaning at least <em>numOwners</em> nodes left since the last rebalance ended), the partition enters DEGRADED mode.</p> </li> <li> <p>If the partition does not contain a simple majority of the nodes (floor(numNodes/2) + 1) in the <em>latest stable topology</em>, the partition also enters DEGRADED mode.</p> </li> <li> <p>Otherwise the partition keeps functioning normally, and it starts a rebalance.</p> </li> </ul> </div> <div class="paragraph"> <p>The <em>stable topology</em> is updated every time a rebalance operation ends and the coordinator determines that another rebalance is not necessary.</p> </div> <div class="paragraph"> <p>These rules ensures that at most one partition stays in AVAILABLE mode, and the other partitions enter DEGRADED mode.</p> </div> <div class="paragraph"> <p>When a partition is in DEGRADED mode, it only allows access to the keys that are wholly owned:</p> </div> <div class="ulist"> <ul> <li> <p>Requests (reads and writes) for entries that have all the copies on nodes within this partition are honoured.</p> </li> <li> <p>Requests for entries that are partially or totally owned by nodes that disappeared are rejected with an <code>AvailabilityException</code>.</p> </li> </ul> </div> <div class="paragraph"> <p>This guarantees that partitions cannot write different values for the same key (cache is consistent), and also that one partition can not read keys that have been updated in the other partitions (no stale data).</p> </div> <div class="paragraph"> <p>To exemplify, consider the initial cluster <code>M = {A, B, C, D}</code>, configured in distributed mode with <code>numOwners = 2</code>. Further on, consider three keys <code>k1</code>, <code>k2</code> and <code>k3</code> (that might exist in the cache or not) such that <code>owners(k1) = {A,B}</code>, <code>owners(k2) = {B,C}</code> and <code>owners(k3) = {C,D}</code>. Then the network splits in two partitions, <code>N1 = {A, B}</code> and <code>N2 = {C, D}</code>, they enter DEGRADED mode and behave like this:</p> </div> <div class="ulist"> <ul> <li> <p>on <code>N1</code>, <code>k1</code> is available for read/write, <code>k2</code> (partially owned) and <code>k3</code> (not owned) are not available and accessing them results in an <code>AvailabilityException</code></p> </li> <li> <p>on <code>N2</code>, <code>k1</code> and <code>k2</code> are not available for read/write, <code>k3</code> is available</p> </li> </ul> </div> <div class="paragraph"> <p>A relevant aspect of the partition handling process is the fact that when a split brain happens, the resulting partitions rely on the original segment mapping (the one that existed before the split brain) in order to calculate key ownership. So it doesn&#8217;t matter if <code>k1</code>, <code>k2</code>, or <code>k3</code> already existed cache or not, their availability is the same.</p> </div> <div class="paragraph"> <p>If at a further point in time the network heals and <code>N1</code> and <code>N2</code> partitions merge back together into the initial cluster <code>M</code>, then <code>M</code> exits the degraded mode and becomes fully available again. During this merge operation, because <code>M</code> has once again become fully available, the <a href="#conflict_manager">ConflictManager</a> and the configured <a href="#merge_policies">EntryMergePolicy</a> are used to check for any conflicts that may have occurred in the interim period between the split brain occurring and being detected.</p> </div> <div class="paragraph"> <p>As another example, the cluster could split in two partitions <code>O1 = {A, B, C}</code> and <code>O2 = {D}</code>, partition <code>O1</code> will stay fully available (rebalancing cache entries on the remaining members). Partition <code>O2</code>, however, will detect a split and enter the degraded mode. Since it doesn&#8217;t have any fully owned keys, it will reject any read or write operation with an <code>AvailabilityException</code>.</p> </div> <div class="paragraph"> <p>If afterwards partitions <code>O1</code> and <code>O2</code> merge back into <code>M</code>, then the <a href="#conflict_manager">ConflictManager</a> attempts to resolve any conflicts and <code>D</code> once again becomes fully available.</p> </div> </div> <div class="sect5"> <h6 id="allow_reads"><a class="anchor" href="#allow_reads"></a>ALLOW_READS</h6> <div class="paragraph"> <p>Partitions are handled in the same manner as DENY_READ_WRITES, except that when a partition is in DEGRADED mode read operations on a partially owned key WILL not throw an AvailabilityException.</p> </div> </div> </div> <div class="sect4"> <h5 id="current_limitations_2"><a class="anchor" href="#current_limitations_2"></a>Current limitations</h5> <div class="paragraph"> <p>Two partitions could start up isolated, and as long as they don&#8217;t merge they can read and write inconsistent data. In the future, we will allow custom availability strategies (e.g. check that a certain node is part of the cluster, or check that an external machine is accessible) that could handle that situation as well.</p> </div> </div> </div> <div class="sect3"> <h4 id="successive_node_failures"><a class="anchor" href="#successive_node_failures"></a>3.1.2. Successive nodes stopped</h4> <div class="paragraph"> <p>As mentioned in the previous section, Infinispan can&#8217;t detect whether a node left the JGroups view because of a process/machine crash, or because of a network failure: whenever a node leaves the JGroups cluster abruptly, it is assumed to be because of a network problem.</p> </div> <div class="paragraph"> <p>If the configured number of copies (<code>numOwners</code>) is greater than 1, the cluster can remain available and will try to make new replicas of the data on the crashed node. However, other nodes might crash during the rebalance process. If more than <code>numOwners</code> nodes crash in a short interval of time, there is a chance that some cache entries have disappeared from the cluster altogether. In this case, with the DENY_READ_WRITES or ALLOW_READS strategy enabled, Infinispan assumes (incorrectly) that there is a split brain and enters DEGRADED mode as described in the split-brain section.</p> </div> <div class="paragraph"> <p>The administrator can also shut down more than <code>numOwners</code> nodes in rapid succession, causing the loss of the data stored only on those nodes. When the administrator shuts down a node gracefully, Infinispan knows that the node can&#8217;t come back. However, the cluster doesn&#8217;t keep track of how each node left, and the cache still enters DEGRADED mode as if those nodes had crashed.</p> </div> <div class="paragraph"> <p>At this stage there is no way for the cluster to recover its state, except stopping it and repopulating it on restart with the data from an external source. Clusters are expected to be configured with an appropriate <code>numOwners</code> in order to avoid <code>numOwners</code> successive node failures, so this situation should be pretty rare. If the application can handle losing some of the data in the cache, the administrator can force the availability mode back to AVAILABLE via JMX.</p> </div> </div> <div class="sect3"> <h4 id="conflict_manager"><a class="anchor" href="#conflict_manager"></a>3.1.3. Conflict Manager</h4> <div class="paragraph"> <p>The conflict manager is a tool that allows users to retrieve all stored replica values for a given key. In addition to allowing users to process a stream of cache entries whose stored replicas have conflicting values. Furthermore, by utilising implementations of the <a href="#merge_policies">EntryMergePolicy</a> interface it is possible for said conflicts to be resolved automatically.</p> </div> <div class="sect4"> <h5 id="detecting_conflicts"><a class="anchor" href="#detecting_conflicts"></a>Detecting Conflicts</h5> <div class="paragraph"> <p>Conflicts are detected by retrieving each of the stored values for a given key. The conflict manager retrieves the value stored from each of the key&#8217;s write owners defined by the current consistent hash. The .equals method of the stored values is then used to determine whether all values are equal. If all values are equal then no conflicts exist for the key, otherwise a conflict has occurred. Note that null values are returned if no entry exists on a given node, therefore we deem a conflict to have occurred if both a null and non-null value exists for a given key.</p> </div> </div> <div class="sect4"> <h5 id="merge_policies"><a class="anchor" href="#merge_policies"></a>Merge Policies</h5> <div class="paragraph"> <p>In the event of conflicts arising between one or more replicas of a given CacheEntry, it is necessary for a conflict resolution algorithm to be defined, therefore we provide the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/conflict/EntryMergePolicy.html">EntryMergePolicy</a> interface. This interface consists of a single method, "merge", whose returned CacheEntry is utilised as the "resolved" entry for a given key. When a non-null CacheEntry is returned, this entries value is "put" to all replicas in the cache. However when the merge implementation returns a null value, all replicas associated with the conflicting key are removed from the cache.</p> </div> <div class="paragraph"> <p>The merge method takes two parameters: the "preferredEntry" and "otherEntries". In the context of a partition merge, the preferredEntry is the primary replica of a CacheEntry stored in the partition that contains the most nodes or if partitions are equal the one with the largest topologyId. In the event of overlapping partitions, i.e. a node A is present in the topology of both partitions {A}, {A,B,C}, we pick {A} as the preferred partition as it will have the higher topologId as the other partition&#8217;s topology is behind. When a partition merge is not occurring, the "preferredEntry" is simply the primary replica of the CacheEntry. The second parameter, "otherEntries" is simply a list of all other entries associated with the key for which a conflict was detected.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> EntryMergePolicy::merge is only called when a conflict has been detected, it is not called if all CacheEntrys are the same. </td> </tr> </table> </div> <div class="paragraph"> <p>Currently Infinispan provides the following implementations of EntryMergePolicy:</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Policy</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.NONE (default)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No attempt is made to resolve conflicts. Entries hosted on the minority partition are removed and the nodes in this partition do not hold any data until the rebalance starts. Note, this behaviour is equivalent to prior Infinispan versions which did not support conflict resolution. Note, in this case all changes made to entries hosted on the minority partition are lost, but once the rebalance has finished all entries will be consistent.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.PREFERRED_ALWAYS</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Always utilise the "preferredEntry". MergePolicy.NONE is almost equivalent to PREFERRED_ALWAYS, albeit without the performance impact of performing conflict resolution, therefore MergePolicy.NONE should be chosen unless the following scenario is a concern. When utilising the DENY_READ_WRITES or DENY_READ strategy, it is possible for a write operation to only partially complete when the partitions enter DEGRADED mode, resulting in replicas containing inconsistent values. MergePolicy.PREFERRED_ALWAYS will detect said inconsistency and resolve it, whereas with MergePolicy.NONE the CacheEntry replicas will remain inconsistent after the cluster has rebalanced.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.PREFERRED_NON_NULL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Utilise the "preferredEntry" if it is non-null, otherwise utilise the first entry from "otherEntries".</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.REMOVE_ALL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Always remove a key from the cache when a conflict is detected.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Fully qualified class name</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The custom implementation for merge will be used <a href="#partition_handling_custom_merge_policy">Custom merge policy</a></p></td> </tr> </tbody> </table> </div> </div> <div class="sect3"> <h4 id="conflict_manager_usage"><a class="anchor" href="#conflict_manager_usage"></a>3.1.4. Usage</h4> <div class="paragraph"> <p>During a partition merge the ConflictManager automatically attempts to resolve conflicts utilising the configured EntryMergePolicy, however it is also possible to manually search for/resolve conflicts as required by your application.</p> </div> <div class="paragraph"> <p>The code below shows how to retrieve an EmbeddedCacheManager&#8217;s ConflictManager, how to retrieve all versions of a given key and how to check for conflicts across a given cache.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">example-config.xml</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">testCache</span><span class="delimiter">&quot;</span></span>);
ConflictManager&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; crm = ConflictManagerFactory.get(cache.getAdvancedCache());

<span class="comment">// Get All Versions of Key</span>
<span class="predefined-type">Map</span>&lt;Address, InternalCacheValue&lt;<span class="predefined-type">String</span>&gt;&gt; versions = crm.getAllVersions(<span class="integer">1</span>);

<span class="comment">// Process conflicts stream and perform some operation on the cache</span>
Stream&lt;<span class="predefined-type">Map</span>&lt;Address, InternalCacheEntry&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;&gt;&gt; stream = crm.getConflicts();
stream.forEach(map -&gt; {
   CacheEntry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; entry = map.values().iterator().next();
   <span class="predefined-type">Object</span> conflictKey = entry.getKey();
   cache.remove(conflictKey);
});

<span class="comment">// Detect and then resolve conflicts using the configured EntryMergePolicy</span>
crm.resolveConflicts();

<span class="comment">// Detect and then resolve conflicts using the passed EntryMergePolicy instance</span>
crm.resolveConflicts((preferredEntry, otherEntries) -&gt; preferredEntry);</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Although the <code>ConflictManager::getConflicts</code> stream is processed per entry, the underlying spliterator is in fact lazily-loading cache entries on a per segment basis. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="partition_handling_configuration"><a class="anchor" href="#partition_handling_configuration"></a>3.1.5. Configuring partition handling</h4> <div class="paragraph"> <p>Unless the cache is distributed or replicated, partition handling configuration is ignored. The default partition handling strategy is ALLOW_READ_WRITES and the default EntryMergePolicy is MergePolicies::PREFERRED_ALWAYS.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">the-default-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;partition-handling</span> <span class="attribute-name">when-split</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALLOW_READ_WRITES</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">merge-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PREFERRED_NON_NULL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The same can be achieved programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder dcc = <span class="keyword">new</span> ConfigurationBuilder();
dcc.clustering().partitionHandling()
                    .whenSplit(PartitionHandling.ALLOW_READ_WRITES)
                    .mergePolicy(MergePolicies.PREFERRED_ALWAYS);</code></pre> </div> </div> <div class="sect4"> <h5 id="partition_handling_custom_merge_policy"><a class="anchor" href="#partition_handling_custom_merge_policy"></a>Implement a custom merge policy</h5> <div class="paragraph"> <p>It&#8217;s also possible to provide custom implementations of the EntryMergePolicy</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">the-default-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;partition-handling</span> <span class="attribute-name">when-split</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALLOW_READ_WRITES</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">merge-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.example.CustomMergePolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder dcc = <span class="keyword">new</span> ConfigurationBuilder();
dcc.clustering().partitionHandling()
                    .whenSplit(PartitionHandling.ALLOW_READ_WRITES)
                    .mergePolicy(<span class="keyword">new</span> CustomMergePolicy());</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomMergePolicy</span> <span class="directive">implements</span> EntryMergePolicy&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> CacheEntry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; merge(CacheEntry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; preferredEntry, <span class="predefined-type">List</span>&lt;CacheEntry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt; otherEntries) {
      <span class="comment">// decide which entry should be used</span>

      <span class="keyword">return</span> the_solved_CacheEntry;
   }</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="deploy_custom_merge_policies_to_a_infinispan_server_instance"><a class="anchor" href="#deploy_custom_merge_policies_to_a_infinispan_server_instance"></a>Deploy custom merge policies to a Infinispan server instance</h5> <div class="paragraph"> <p>To utilise a custom EntryMergePolicy implementation on the server, it&#8217;s necessary for the implementation class(es) to be deployed to the server. This is accomplished by utilising the java service-provider convention and packaging the class files in a jar which has a META-INF/services/org.infinispan.conflict.EntryMergePolicy file containing the fully qualified class name of the EntryMergePolicy implementation.</p> </div> <div class="listingblock"> <div class="content"> <pre># list all necessary implementations of EntryMergePolicy with the full qualified name
org.example.CustomMergePolicy</pre> </div> </div> <div class="paragraph"> <p>In order for a Custom merge policy to be utilised on the server, you should enable object storage, if your policies semantics require access to the stored Key/Value objects. This is because cache entries in the server may be stored in a marshalled format and the Key/Value objects returned to your policy would be instances of WrappedByteArray. However, if the custom policy only depends on the metadata associated with a cache entry, then object storage is not required and should be avoided (unless needed for other reasons) due to the additional performance cost of marshalling data per request. Finally, object storage is never required if one of the provided merge policies is used.</p> </div> </div> </div> <div class="sect3"> <h4 id="partition_handling_monitoring"><a class="anchor" href="#partition_handling_monitoring"></a>3.1.6. Monitoring and administration</h4> <div class="paragraph"> <p>The availability mode of a cache is exposed in JMX as an attribute in the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/jmxComponents.html#Cache">Cache MBean</a>. The attribute is writable, allowing an administrator to forcefully migrate a cache from DEGRADED mode back to AVAILABLE (at the cost of consistency).</p> </div> <div class="paragraph"> <p>The availability mode is also accessible via the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> interface:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">AdvancedCache ac = cache.getAdvancedCache();

<span class="comment">// Read the availability</span>
<span class="type">boolean</span> available = ac.getAvailability() == AvailabilityMode.AVAILABLE;

<span class="comment">// Change the availability</span>
<span class="keyword">if</span> (!available) {
   ac.setAvailability(AvailabilityMode.AVAILABLE);
}</code></pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="extending"><a class="anchor" href="#extending"></a>4. Extending Infinispan</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan can be extended to provide the ability for an end user to add additional configurations, operations and components outside of the scope of the ones normally provided by Infinispan.</p> </div> <div class="sect2"> <h3 id="custom_commands"><a class="anchor" href="#custom_commands"></a>4.1. Custom Commands</h3> <div class="paragraph"> <p>Infinispan makes use of a <a href="http://en.wikipedia.org/wiki/Command_pattern">command/visitor pattern</a> to implement the various top-level methods you see on the public-facing API.</p> </div> <div class="paragraph"> <p>While the core commands - and their corresponding visitors - are hard-coded as a part of Infinispan&#8217;s core module, module authors can extend and enhance Infinispan by creating new custom commands.</p> </div> <div class="paragraph"> <p>As a module author (such as <a href="https://github.com/infinispan/infinispan/tree/master/query">infinispan-query</a>, etc.) you can define your own commands.</p> </div> <div class="paragraph"> <p>You do so by:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code> file and ensure this is packaged in your jar.</p> </li> <li> <p>Implementing <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandFactory.java"><code>ModuleCommandFactory</code></a>, <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandInitializer.java"><code>ModuleCommandInitializer</code></a> and <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandExtensions.java"><code>ModuleCommandExtensions</code></a></p> </li> <li> <p>Specifying the fully-qualified class name of the <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandExtensions.java"><code>ModuleCommandExtensions</code></a> implementation in <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code>.</p> </li> <li> <p>Implement your custom commands and visitors for these commands</p> </li> </ol> </div> <div class="sect3"> <h4 id="an_example"><a class="anchor" href="#an_example"></a>4.1.1. An Example</h4> <div class="paragraph"> <p>Here is an example of an <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code> file, configured accordingly:</p> </div> <div class="listingblock"> <div class="title">org.infinispan.commands.module.ModuleCommandExtensions</div> <div class="content"> <pre>org.infinispan.query.QueryModuleCommandExtensions</pre> </div> </div> <div class="paragraph"> <p>For a full, working example of a sample module that makes use of custom commands and visitors, check out <a href="https://github.com/infinispan/infinispan-sample-module">Infinispan Sample Module</a> .</p> </div> </div> <div class="sect3"> <h4 id="preassigned_custom_command_id_ranges"><a class="anchor" href="#preassigned_custom_command_id_ranges"></a>4.1.2. Preassigned Custom Command Id Ranges</h4> <div class="paragraph"> <p>This is the list of <code>Command</code> identifiers that are used by Infinispan based modules or frameworks. Infinispan users should avoid using ids within these ranges. (RANGES to be finalised yet!) Being this a single byte, ranges can&#8217;t be too large.</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Query:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">100 - 119</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Search:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">120 - 139</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hot Rod Server:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">140 - 141</p></td> </tr> </tbody> </table> </div> </div> <div class="sect2"> <h3 id="extending_the_configuration_builders_and_parsers"><a class="anchor" href="#extending_the_configuration_builders_and_parsers"></a>4.2. Extending the configuration builders and parsers</h3> <div class="paragraph"> <p>If your custom module requires configuration, it is possible to enhance Infinispan&#8217;s configuration builders and parsers. Look at the <a href="https://github.com/infinispan/infinispan/blob/master/core/src/test/java/org/infinispan/configuration/module">custom module tests</a> for a detail example on how to implement this.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="custom_interceptors_chapter"><a class="anchor" href="#custom_interceptors_chapter"></a>5. Custom Interceptors</h2> <div class="sectionbody"> <div class="paragraph"> <p>It is possible to add custom interceptors to Infinispan, both declaratively and programatically. Custom interceptors are a way of extending Infinispan by being able to influence or respond to any modifications to cache. Example of such modifications are: elements are added/removed/updated or transactions are committed. For a detailed list refer to <a href="{javadoc.root}/org/infinispan/interceptors/base/CommandInterceptor.html">CommandInterceptor</a> API.</p> </div> <div class="sect2"> <h3 id="adding_custom_interceptors_declaratively"><a class="anchor" href="#adding_custom_interceptors_declaratively"></a>5.1. Adding custom interceptors declaratively</h3> <div class="paragraph"> <p>Custom interceptors can be added on a per named cache basis. This is because each named cache have its own interceptor stack. Following xml snippet depicts the ways in which a custom interceptor can be added.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheWithCustomInterceptors</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="comment">&lt;!--
      Define custom interceptors.  All custom interceptors need to extend org.jboss.cache.interceptors.base.CommandInterceptor
      --&gt;</span>
      <span class="tag">&lt;custom-interceptors&gt;</span>
         <span class="tag">&lt;interceptor</span> <span class="attribute-name">position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FIRST</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
               <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">attributeOne</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>value1<span class="tag">&lt;/property&gt;</span>
               <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">attributeTwo</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>value2<span class="tag">&lt;/property&gt;</span>
         <span class="tag">&lt;/interceptor&gt;</span>
         <span class="tag">&lt;interceptor</span> <span class="attribute-name">position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LAST</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;interceptor</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;interceptor</span> <span class="attribute-name">before</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispanpan.interceptors.CallInterceptor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;interceptor</span> <span class="attribute-name">after</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispanpan.interceptors.CallInterceptor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/custom-interceptors&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="adding_custom_interceptors_programatically"><a class="anchor" href="#adding_custom_interceptors_programatically"></a>5.2. Adding custom interceptors programatically</h3> <div class="paragraph"> <p>In order to do that one needs to obtain a reference to the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> . This can be done as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CacheManager cm = getCacheManager();<span class="comment">//magic</span>
Cache aCache = cm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">aName</span><span class="delimiter">&quot;</span></span>);
AdvancedCache advCache = aCache.getAdvancedCache();</code></pre> </div> </div> <div class="paragraph"> <p>Then one of the <em>addInterceptor()</em> methods should be used to add the actual interceptor. For further documentation refer to <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> javadoc.</p> </div> </div> <div class="sect2"> <h3 id="custom_interceptor_design"><a class="anchor" href="#custom_interceptor_design"></a>5.3. Custom interceptor design</h3> <div class="paragraph"> <p>When writing a custom interceptor, you need to abide by the following rules.</p> </div> <div class="ulist"> <ul> <li> <p>Custom interceptors must extend <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/interceptors/base/BaseCustomInterceptor.html">BaseCustomInterceptor</a></p> </li> <li> <p>Custom interceptors must declare a public, empty constructor to enable construction.</p> </li> <li> <p>Custom interceptors will have setters for any property defined through property tags used in the XML configuration.</p> </li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="rolling_up_k8s"><a class="anchor" href="#rolling_up_k8s"></a>6. Rolling Upgrades and Updates with Kubernetes and OpenShift</h2> <div class="sectionbody"> <div class="paragraph"> <p>Pods running in Kubernetes and OpenShift are immutable. The only way you can alter the configuration is to roll out a new deployment.</p> </div> <div class="paragraph"> <p>Upgrades and updates sound similar but are distinct processes for rolling out new deployments.</p> </div> <div class="sect2"> <h3 id="performing_rolling_updates_on_kubernetes"><a class="anchor" href="#performing_rolling_updates_on_kubernetes"></a>6.1. Performing Rolling Updates on Kubernetes</h3> <div class="paragraph"> <p>Rolling updates replace existing pods with new ones.</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.openshift.org/latest/dev_guide/deployments/deployment_strategies.html#rolling-strategy">Rolling Updates</a></p> </li> <li> <p><a href="https://docs.openshift.org/latest/dev_guide/deployments/deployment_strategies.html#when-to-use-a-rolling-deployment">When to Use a Rolling Deployment</a></p> </li> </ul> </div> <div class="listingblock"> <div class="title">Example DeploymentConfiguration for Rolling Updates</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">apiVersion: v1</span></span>
  <span class="key">kind</span>: <span class="string"><span class="content">DeploymentConfig</span></span>
  <span class="key">metadata</span>:
    <span class="key">name</span>: <span class="string"><span class="content">infinispan-cluster</span></span>
  <span class="key">spec</span>:
    <span class="key">replicas</span>: <span class="string"><span class="content">3</span></span>
    <span class="key">strategy</span>:
      <span class="key">type</span>: <span class="string"><span class="content">Rolling</span></span>
      <span class="key">rollingParams</span>:
        <span class="key">updatePeriodSeconds</span>: <span class="string"><span class="content">10</span></span>
        <span class="key">intervalSeconds</span>: <span class="string"><span class="content">20</span></span>
        <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">600</span></span>
        <span class="key">maxUnavailable</span>: <span class="string"><span class="content">1</span></span>
        <span class="key">maxSurge</span>: <span class="string"><span class="content">1</span></span>
    <span class="key">template</span>:
      <span class="key">spec</span>:
        <span class="key">containers</span>:
        - <span class="string"><span class="content">args:</span></span>
          - <span class="string"><span class="content">-Djboss.default.jgroups.stack=kubernetes</span></span>
          <span class="key">image</span>: <span class="string"><span class="content">jboss/infinispan-server:latest</span></span>
          <span class="key">name</span>: <span class="string"><span class="content">infinispan-server</span></span>
          <span class="key">ports</span>:
          - <span class="string"><span class="content">containerPort: 8181</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 9990</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 11211</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 11222</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 57600</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 7600</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 8080</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          <span class="key">env</span>:
          - <span class="string"><span class="content">name: KUBERNETES_NAMESPACE</span></span>
            <span class="key">valueFrom</span>: <span class="string"><span class="content">{fieldRef: {apiVersion: v1, fieldPath: metadata.namespace}}</span></span>
          <span class="key">terminationMessagePath</span>: <span class="string"><span class="content">/dev/termination-log</span></span>
          <span class="key">terminationGracePeriodSeconds</span>: <span class="string"><span class="content">90</span></span>
          <span class="key">livenessProbe</span>:
            <span class="key">exec</span>:
              <span class="key">command</span>:
              - <span class="string"><span class="content">/usr/local/bin/is_running.sh</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">10</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">80</span></span>
            <span class="key">periodSeconds</span>: <span class="string"><span class="content">60</span></span>
            <span class="key">successThreshold</span>: <span class="string"><span class="content">1</span></span>
            <span class="key">failureThreshold</span>: <span class="string"><span class="content">5</span></span>
          <span class="key">readinessProbe</span>:
             <span class="key">exec</span>:
                <span class="key">command</span>:
                - <span class="string"><span class="content">/usr/local/bin/is_healthy.sh</span></span>
             <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">10</span></span>
             <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">40</span></span>
             <span class="key">periodSeconds</span>: <span class="string"><span class="content">30</span></span>
             <span class="key">successThreshold</span>: <span class="string"><span class="content">2</span></span>
             <span class="key">failureThreshold</span>: <span class="string"><span class="content">5</span></span></code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>Kubernetes uses very similar concept to Deployment Configurations called <code>Deployment</code>.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>It is also highly recommended to adjust the JGroups stack to discover new nodes (or leaves) more quickly. One should at least adjust the value of <code>FD_ALL</code> timeout and adjust it to the longest GC Pause.</p> </div> <div class="ulist"> <div class="title">Other hints for tuning configuration parameters are:</div> <ul> <li> <p>OpenShift should replace running nodes one by one. This can be achieved by adjusting <code>rollingParams</code> (<code>maxUnavailable: 1</code> and <code>maxSurge: 1</code>).</p> </li> <li> <p>Depending on the cluster size, one needs to adjust <code>updatePeriodSeconds</code> and <code>intervalSeconds</code>. The bigger cluster size is, the bigger those values should be used.</p> </li> <li> <p>When using Initial State Transfer, the <code>initialDelaySeconds</code> value for both probes should be set to higher value.</p> </li> <li> <p>During Initial State Transfer nodes might not respond to probes. The best results are achieved with higher values of <code>failureThreshold</code> and <code>successThreshold</code> values.</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="performing_rolling_upgrades_on_kubernetes"><a class="anchor" href="#performing_rolling_upgrades_on_kubernetes"></a>6.2. Performing Rolling Upgrades on Kubernetes</h3> <div class="paragraph"> <p>Rolling upgrades migrate data from one Infinispan cluster to another.</p> </div> <div class="paragraph"> <p>For both Kubernetes and OpenShift, the rolling upgrade procedure is nearly identical to the procedure for Infinispan server rolling upgrades.</p> </div> <div class="ulist"> <div class="title">Differences in rolling upgrade procedures</div> <ul> <li> <p>Depending on configuration, it is a good practice to use <a href="https://docs.openshift.org/latest/architecture/core_concepts/routes.html">OpenShift Routes</a> or <a href="http://kubernetes.io/docs/user-guide/ingress">Kubernetes Ingress API</a> to expose services to the clients. During the upgrade the Route (or Ingress) used by the clients can be altered to point to the new cluster.</p> </li> <li> <p>Invoking CLI commands can be done by using Kubernetes (<code>kubectl exec</code>) or OpenShift clients (<code>oc exec</code>). Here is an example: <code>oc exec &lt;POD_NAME&gt;&#8201;&#8212;&#8201;'/opt/jboss/infinispan-server/bin/ispn-cli.sh' '-c' '--controller=$(hostname -i):9990' '/subsystem=datagrid-infinispan/cache-container=clustered/distributed-cache=default:disconnect-source(migrator-name=hotrod)'</code></p> </li> </ul> </div> <div class="ulist"> <div class="title">Key differences when upgrading using the library mode:</div> <ul> <li> <p>Client application needs to expose JMX. It usually depends on application and environment type but the easiest way to do it is to add the following switches into the Java boostrap script <code>-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=&lt;PORT&gt;</code>.</p> </li> <li> <p>Connecting to the JMX can be done by forwarding ports. With OpenShift this might be achieved by using <code>oc port-forward</code> command whereas in Kubernetes by <code>kubectl port-forward</code>.</p> </li> </ul> </div> <div class="paragraph"> <p>The last step in the Rolling Upgrade (removing a Remote Cache Store) needs to be performed differently. We need to use <a href="http://kubernetes.io/docs/user-guide/rolling-updates/">Kubernetes/OpenShift Rolling update</a> command and replace Pods configuration with the one which does not contain Remote Cache Store.</p> </div> <div class="paragraph"> <p>A detailed instruction might be found in <a href="https://issues.jboss.org/browse/ISPN-6673">ISPN-6673</a> ticket.</p> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2019-10-27 08:15:43 UTC </div> </div> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script> <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script> </body> </html>