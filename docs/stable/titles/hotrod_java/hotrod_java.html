<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="generator" content="Asciidoctor 1.5.8"> <title>Using the Infinispan Hot Rod Server</title> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"> <style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> <style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style> <link rel="canonical" href="http://infinispan.org/docs/stable/user_guide/user_guide.html"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css"> <link rel="stylesheet" href="../../css/css.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script> <script src="../../js/js.js"></script> </head> <body class="book toc2 toc-left"> <div id="header"> <h1>Using the Infinispan Hot Rod Server</h1> <div id="toc" class="toc2"> <div id="toctitle">Table of Contents</div> <ul class="sectlevel1"> <li><a href="#hot_rod_server_usage">1. Using Hot Rod Server</a> <ul class="sectlevel2"> <li><a href="#hotrod_java_client">1.1. Hot Rod Java clients</a> <ul class="sectlevel3"> <li><a href="#programmatically_configuring_hot_rod_java_clients">1.1.1. Programmatically Configuring Hot Rod Java Clients</a></li> <li><a href="#configuring_hot_rod_java_client_property_files">1.1.2. Configuring Hot Rod Java Client Property Files</a></li> <li><a href="#authentication">1.1.3. Authentication</a> <ul class="sectlevel4"> <li><a href="#digest_md5">DIGEST-MD5</a></li> <li><a href="#plain">PLAIN</a></li> <li><a href="#external">EXTERNAL</a></li> <li><a href="#gssapi_kerberos">GSSAPI (Kerberos)</a></li> <li><a href="#custom_callbackhandlers">Custom CallbackHandlers</a></li> </ul> </li> <li><a href="#hr_encryption">1.1.4. Encryption</a> <ul class="sectlevel4"> <li><a href="#sni">SNI</a></li> <li><a href="#client_certificates">Client certificates</a></li> </ul> </li> <li><a href="#hr_basic_api">1.1.5. Basic API</a></li> <li><a href="#remotecache_keyset_entryset_values">1.1.6. RemoteCache(.keySet|.entrySet|.values)</a></li> <li><a href="#remote_iterator">1.1.7. Remote Iterator</a></li> <li><a href="#hr_versioned_api">1.1.8. Versioned API</a></li> <li><a href="#streaming_api">1.1.9. Streaming API</a></li> <li><a href="#creating_event_listeners">1.1.10. Creating Event Listeners</a></li> <li><a href="#removing_event_listeners">1.1.11. Removing Event Listeners</a></li> <li><a href="#filtering_events">1.1.12. Filtering Events</a> <ul class="sectlevel4"> <li><a href="#skipping_notifications">Skipping Notifications</a></li> </ul> </li> <li><a href="#customizing_events">1.1.13. Customizing Events</a></li> <li><a href="#filter_and_custom_events">1.1.14. Filter and Custom Events</a></li> <li><a href="#event_marshalling">1.1.15. Event Marshalling</a> <ul class="sectlevel4"> <li><a href="#protostream_deployment">Deploying Protostream Marshallers</a></li> </ul> </li> <li><a href="#listener_state_handling">1.1.16. Listener State Handling</a></li> <li><a href="#listener_failure_handling">1.1.17. Listener Failure Handling</a></li> <li><a href="#near_caching">1.1.18. Near Caching</a></li> <li><a href="#unsupported_methods">1.1.19. Unsupported methods</a></li> <li><a href="#return_values">1.1.20. Return values</a></li> </ul> </li> </ul> </li> <li><a href="#hr_transactions">2. Hot Rod Transactions</a> <ul class="sectlevel2"> <li><a href="#hr_transactions_config_server">2.1. Configuring the Server</a></li> <li><a href="#hr_transactions_config_client">2.2. Configuring Hot Rod Clients</a> <ul class="sectlevel3"> <li><a href="#hr_transactions_tmlookup">2.2.1. TransactionManagerLookup Interface</a></li> <li><a href="#hr_transactions_modes">2.2.2. Transaction Modes</a></li> </ul> </li> <li><a href="#hr_transactions_override_rcm">2.3. Overriding Configuration for Cache Instances</a></li> <li><a href="#hr_transactions_force_return_value">2.4. Detecting Conflicts with Transactions</a></li> <li><a href="#hr_transactions_ex_use_config">2.5. Using the Configured Transaction Manager and Transaction Mode</a></li> <li><a href="#hr_transactions_ex_override_tm">2.6. Overriding the Transaction Manager</a></li> <li><a href="#hr_transactions_ex_override_mode">2.7. Overriding the Transaction Mode</a> <ul class="sectlevel3"> <li><a href="#client_intelligence">2.7.1. Client Intelligence</a></li> <li><a href="#request_balancing">2.7.2. Request Balancing</a></li> <li><a href="#persistent_connections">2.7.3. Persistent connections</a></li> <li><a href="#hot_rod_marshalling_data">2.7.4. Marshalling data</a> <ul class="sectlevel4"> <li><a href="#protostream">ProtoStream</a></li> </ul> </li> <li><a href="#reading_data_in_different_data_formats">2.7.5. Reading data in different data formats</a> <ul class="sectlevel4"> <li><a href="#using_different_marshallers_for_key_and_values">Using different marshallers for Key and Values</a></li> <li><a href="#reading_data_in_different_formats">Reading data in different formats</a></li> </ul> </li> <li><a href="#statistics">2.7.6. Statistics</a></li> <li><a href="#multi_get_operations">2.7.7. Multi-Get Operations</a></li> <li><a href="#server_hotrod_failover">2.7.8. Failover capabilities</a></li> <li><a href="#site_cluster_failover">2.7.9. Site Cluster Failover</a></li> <li><a href="#manual_site_cluster_switch">2.7.10. Manual Site Cluster Switch</a></li> <li><a href="#hotrod_java_client_monitoring">2.7.11. Monitoring the Hot Rod client</a></li> <li><a href="#concurrent_updates">2.7.12. Concurrent Updates</a> <ul class="sectlevel4"> <li><a href="#data_consistency_problem">Data Consistency Problem</a></li> <li><a href="#embedded_mode_solution">Embedded-mode Solution</a></li> <li><a href="#client_server_solution">Client-Server Solution</a></li> </ul> </li> </ul> </li> </ul> </li> </ul> </div> </div> <div id="content"> <div class="sect1"> <h2 id="hot_rod_server_usage"><a class="anchor" href="#hot_rod_server_usage"></a>1. Using Hot Rod Server</h2> <div class="sectionbody"> <div class="paragraph"> <p>The Infinispan Server distribution contains a server module that implements Infinispan&#8217;s custom binary protocol called Hot Rod. The protocol was designed to enable faster client/server interactions compared to other existing text based protocols and to allow clients to make more intelligent decisions with regards to load balancing, failover and even data location operations.</p> </div> <div class="paragraph"> <p>To connect to Infinispan over this highly efficient Hot Rod protocol you can either use one of the clients described in this chapter, or use higher level tools such as Hibernate OGM.</p> </div> <div class="sect2"> <h3 id="hotrod_java_client"><a class="anchor" href="#hotrod_java_client"></a>1.1. Hot Rod Java clients</h3> <div class="paragraph"> <p>Use Java clients to access data through a Infinispan Hot Rod server.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>Infinispan provides a reference Hot Rod Java client implementation.</p> </div> <div class="paragraph"> <p>Visit the <a href="http://infinispan.org/hotrod-clients">Hot Rod clients</a> page on <em>infinispan.org</em> to download the Java client and find client implementations in other languages.</p> </div> </td> </tr> </table> </div> <div class="sect3"> <h4 id="programmatically_configuring_hot_rod_java_clients"><a class="anchor" href="#programmatically_configuring_hot_rod_java_clients"></a>1.1.1. Programmatically Configuring Hot Rod Java Clients</h4> <div class="paragraph"> <p>Use the <code>ConfigurationBuilder</code> class to generate immutable configuration objects that you can pass to <code>RemoteCacheManager</code>.</p> </div> <div class="paragraph"> <p>For example, create a client instance with the Java fluent API as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb
      = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.marshaller(<span class="keyword">new</span> org.infinispan.commons.marshall.ProtoStreamMarshaller())
  .statistics()
      .enable()
      .jmxDomain(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan</span><span class="delimiter">&quot;</span></span>)
  .addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
      .port(<span class="integer">11222</span>);
RemoteCacheManager rmc = <span class="keyword">new</span> RemoteCacheManager(cb.build());</code></pre> </div> </div> <div class="paragraph"> <div class="title">Reference</div> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/ConfigurationBuilder.html">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</a></p> </div> </div> <div class="sect3"> <h4 id="configuring_hot_rod_java_client_property_files"><a class="anchor" href="#configuring_hot_rod_java_client_property_files"></a>1.1.2. Configuring Hot Rod Java Client Property Files</h4> <div class="paragraph"> <p>Add <code>hotrod-client.properties</code> to your classpath so that the client passes configuration to <code>RemoteCacheManager</code>.</p> </div> <div class="paragraph"> <p>To use <code>hotrod-client.properties</code> somewhere other than your classpath, do:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
<span class="predefined-type">Properties</span> p = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
<span class="keyword">try</span>(<span class="predefined-type">Reader</span> r = <span class="keyword">new</span> <span class="predefined-type">FileReader</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/hotrod-client.properties</span><span class="delimiter">&quot;</span></span>)) {
   p.load(r);
   b.withProperties(p);
}
RemoteCacheManager rcm = <span class="keyword">new</span> RemoteCacheManager(b.build());</code></pre> </div> </div> <div class="listingblock"> <div class="title">Example hotrod-client.properties</div> <div class="content"> <pre class="CodeRay highlight"><code># Hot Rod client configuration
infinispan.client.hotrod.server_list = 127.0.0.1:11222
infinispan.client.hotrod.marshaller = org.infinispan.commons.marshall.ProtoStreamMarshaller
infinispan.client.hotrod.async_executor_factory = org.infinispan.client.hotrod.impl.async.DefaultAsyncExecutorFactory
infinispan.client.hotrod.default_executor_factory.pool_size = 1
infinispan.client.hotrod.hash_function_impl.2 = org.infinispan.client.hotrod.impl.consistenthash.ConsistentHashV2
infinispan.client.hotrod.tcp_no_delay = true
infinispan.client.hotrod.tcp_keep_alive = false
infinispan.client.hotrod.request_balancing_strategy = org.infinispan.client.hotrod.impl.transport.tcp.RoundRobinBalancingStrategy
infinispan.client.hotrod.key_size_estimate = 64
infinispan.client.hotrod.value_size_estimate = 512
infinispan.client.hotrod.force_return_values = false

## Connection pooling configuration
maxActive = -1
maxIdle = -1
whenExhaustedAction = 1
minEvictableIdleTimeMillis=300000
minIdle = 1</code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>Substitute Java system properties to replace values at runtime, for example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>infinispan.client.hotrod.server_list = ${server_list}</code></pre> </div> </div> <div class="paragraph"> <p>The preceding example expands the value of the <code>infinispan.client.hotrod.server_list</code> property to the value of the <code>server_list</code> Java system property, which comes from system property named <code>jboss.bind.address.management</code> or defaults to <code>127.0.0.1</code>.</p> </div> </td> </tr> </table> </div> <div class="ulist"> <div class="title">Reference</div> <ul> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/package-summary.html#package.description">org.infinispan.client.hotrod.configuration</a> lists and describes Hot Rod client properties.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html#RemoteCacheManager-java.net.URL-">org.infinispan.client.hotrod.RemoteCacheManager</a></p> </li> <li> <p><a href="https://docs.oracle.com/javase/tutorial/essential/environment/sysprop.html">Java system properties</a></p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="authentication"><a class="anchor" href="#authentication"></a>1.1.3. Authentication</h4> <div class="paragraph"> <p>If the server has set up authentication, you need to configure your client accordingly. Depending on the mechs enabled on the server, the client must provide the required information.</p> </div> <div class="sect4"> <h5 id="digest_md5"><a class="anchor" href="#digest_md5"></a>DIGEST-MD5</h5> <div class="paragraph"> <p>DIGEST-MD5 is the recommended approach for simple username/password authentication scenarios. If you are using the default realm on the server (<em>"ApplicationRealm"</em>), all you need to do is provide your credentials as follows:</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with DIGEST-MD5 authentication</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">myuser</span><span class="delimiter">&quot;</span></span>)
            .password(<span class="string"><span class="delimiter">&quot;</span><span class="content">qwer1234!</span><span class="delimiter">&quot;</span></span>);
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="plain"><a class="anchor" href="#plain"></a>PLAIN</h5> <div class="paragraph"> <p>The PLAIN mechanism is not really recommended unless the connection is also encrypted, as anyone can sniff the clear-text password being sent along the wire.</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with DIGEST-MD5 authentication</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .authentication()
            .saslMechanism(<span class="string"><span class="delimiter">&quot;</span><span class="content">PLAIN</span><span class="delimiter">&quot;</span></span>)
            .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">myuser</span><span class="delimiter">&quot;</span></span>)
            .password(<span class="string"><span class="delimiter">&quot;</span><span class="content">qwer1234!</span><span class="delimiter">&quot;</span></span>);
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="external"><a class="anchor" href="#external"></a>EXTERNAL</h5> <div class="paragraph"> <p>The EXTERNAL mechanism is special in that it doesn&#8217;t explicitly provide credentials but uses the client certificate as identity. In order for this to work, in addition to the <em>TrustStore</em> (to validate the server certificate) you need to provide a <em>KeyStore</em> (to supply the client certificate).</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with EXTERNAL authentication (client cert)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            <span class="comment">// TrustStore is a KeyStore which contains part of the server certificate chain (e.g. the CA Root public cert)</span>
            .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/truststore</span><span class="delimiter">&quot;</span></span>)
            .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray())
            <span class="comment">// KeyStore containing this client's own certificate</span>
            .keyStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/keystore</span><span class="delimiter">&quot;</span></span>)
            .keyStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">keystorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray())
        .authentication()
            .saslMechanism(<span class="string"><span class="delimiter">&quot;</span><span class="content">EXTERNAL</span><span class="delimiter">&quot;</span></span>);
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>For more details, read the <a href="#hr_encryption">Encryption</a> section below.</p> </div> </div> <div class="sect4"> <h5 id="gssapi_kerberos"><a class="anchor" href="#gssapi_kerberos"></a>GSSAPI (Kerberos)</h5> <div class="paragraph"> <p>GSSAPI/Kerberos requires a much more complex setup, but it is used heavily in enterprises with centralized authentication servers. To successfully authenticate with Kerberos, you need to create a <em>LoginContext</em>. This will obtain a Ticket Granting Ticket (TGT) which will be used as a token to authenticate with the service.</p> </div> <div class="paragraph"> <p>You will need to define a login module in a login configuration file:</p> </div> <div class="listingblock"> <div class="title">gss.conf</div> <div class="content"> <pre class="CodeRay highlight"><code>GssExample {
    com.sun.security.auth.module.Krb5LoginModule required client=TRUE;
};</code></pre> </div> </div> <div class="paragraph"> <p>If you are using the IBM JDK, the above becomes:</p> </div> <div class="listingblock"> <div class="title">gss-ibm.conf</div> <div class="content"> <pre class="CodeRay highlight"><code>GssExample {
    com.ibm.security.auth.module.Krb5LoginModule required client=TRUE;
};</code></pre> </div> </div> <div class="paragraph"> <p>You will also need to set the following system properties:</p> </div> <div class="paragraph"> <p>java.security.auth.login.config=gss.conf</p> </div> <div class="paragraph"> <p>java.security.krb5.conf=/etc/krb5.conf</p> </div> <div class="paragraph"> <p>The krb5.conf file is dependent on your environment and needs to point to your KDC. Ensure that you can authenticate via Kerberos using <em>kinit</em>.</p> </div> <div class="paragraph"> <p>Next up, configure your client as follows:</p> </div> <div class="listingblock"> <div class="title">Hot Rod client GSSAPI configuration</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">LoginContext</span> lc = <span class="keyword">new</span> <span class="predefined-type">LoginContext</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">GssExample</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> BasicCallbackHandler(<span class="string"><span class="delimiter">&quot;</span><span class="content">krb_user</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">krb_password</span><span class="delimiter">&quot;</span></span>.toCharArray()));
lc.login();
<span class="predefined-type">Subject</span> clientSubject = lc.getSubject();

ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .authentication()
            .enable()
            .serverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-server</span><span class="delimiter">&quot;</span></span>)
            .saslMechanism(<span class="string"><span class="delimiter">&quot;</span><span class="content">GSSAPI</span><span class="delimiter">&quot;</span></span>)
            .clientSubject(clientSubject)
            .callbackHandler(<span class="keyword">new</span> BasicCallbackHandler());
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>For brevity we used the same callback handler both for obtaining the client subject and for handling authentication in the SASL GSSAPI mech, however different callbacks will actually be invoked: NameCallback and PasswordCallback are needed to construct the client subject, while the AuthorizeCallback will be called during the SASL authentication.</p> </div> </div> <div class="sect4"> <h5 id="custom_callbackhandlers"><a class="anchor" href="#custom_callbackhandlers"></a>Custom CallbackHandlers</h5> <div class="paragraph"> <p>In all of the above examples, the Hot Rod client is setting up a default <em>CallbackHandler</em> for you that supplies the provided credentials to the SASL mechanism. For advanced scenarios it may be necessary to provide your own custom <em>CallbackHandler</em>:</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with authentication via callback</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyCallbackHandler</span> <span class="directive">implements</span> <span class="predefined-type">CallbackHandler</span> {
   <span class="directive">final</span> <span class="directive">private</span> <span class="predefined-type">String</span> username;
   <span class="directive">final</span> <span class="directive">private</span> <span class="type">char</span><span class="type">[]</span> password;
   <span class="directive">final</span> <span class="directive">private</span> <span class="predefined-type">String</span> realm;

   <span class="directive">public</span> MyCallbackHandler(<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> realm, <span class="type">char</span><span class="type">[]</span> password) {
      <span class="local-variable">this</span>.username = username;
      <span class="local-variable">this</span>.password = password;
      <span class="local-variable">this</span>.realm = realm;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> handle(<span class="predefined-type">Callback</span><span class="type">[]</span> callbacks) <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">UnsupportedCallbackException</span> {
      <span class="keyword">for</span> (<span class="predefined-type">Callback</span> callback : callbacks) {
         <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> <span class="predefined-type">NameCallback</span>) {
            <span class="predefined-type">NameCallback</span> nameCallback = (<span class="predefined-type">NameCallback</span>) callback;
            nameCallback.setName(username);
         } <span class="keyword">else</span> <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> <span class="predefined-type">PasswordCallback</span>) {
            <span class="predefined-type">PasswordCallback</span> passwordCallback = (<span class="predefined-type">PasswordCallback</span>) callback;
            passwordCallback.setPassword(password);
         } <span class="keyword">else</span> <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> <span class="predefined-type">AuthorizeCallback</span>) {
            <span class="predefined-type">AuthorizeCallback</span> authorizeCallback = (<span class="predefined-type">AuthorizeCallback</span>) callback;
            authorizeCallback.setAuthorized(authorizeCallback.getAuthenticationID().equals(
                  authorizeCallback.getAuthorizationID()));
         } <span class="keyword">else</span> <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> <span class="predefined-type">RealmCallback</span>) {
            <span class="predefined-type">RealmCallback</span> realmCallback = (<span class="predefined-type">RealmCallback</span>) callback;
            realmCallback.setText(realm);
         } <span class="keyword">else</span> {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedCallbackException</span>(callback);
         }
      }
   }
}

ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .authentication()
            .enable()
            .serverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">myhotrodserver</span><span class="delimiter">&quot;</span></span>)
            .saslMechanism(<span class="string"><span class="delimiter">&quot;</span><span class="content">DIGEST-MD5</span><span class="delimiter">&quot;</span></span>)
            .callbackHandler(<span class="keyword">new</span> MyCallbackHandler(<span class="string"><span class="delimiter">&quot;</span><span class="content">myuser</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ApplicationRealm</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">qwer1234!</span><span class="delimiter">&quot;</span></span>.toCharArray()));
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>The actual type of callbacks that your CallbackHandler will need to be able to handle are mech-specific, so the above is just a simple example.</p> </div> </div> </div> <div class="sect3"> <h4 id="hr_encryption"><a class="anchor" href="#hr_encryption"></a>1.1.4. Encryption</h4> <div class="paragraph"> <p>Encryption uses TLS/SSL, so it requires setting up an appropriate server certificate chain. Generally, a certificate chain looks like the following:</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./../../topics/images/cert_chain.png" alt="cert chain"> </div> <div class="title">Figure 1. Certificate chain</div> </div> <div class="paragraph"> <p>In the above example there is one certificate authority <em>"CA"</em> which has issued a certificate for <em>"HotRodServer"</em>. In order for a client to trust the server, it needs at least a portion of the above chain (usually, just the public certificate for <em>"CA"</em>). This certificate needs to placed in a keystore and used as a <em>TrustStore</em> on the client and used as shown below:</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with TLS (server cert)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            <span class="comment">// TrustStore is a KeyStore which contains part of the server certificate chain (e.g. the CA Root public cert)</span>
            .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/truststore</span><span class="delimiter">&quot;</span></span>)
            .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="sect4"> <h5 id="sni"><a class="anchor" href="#sni"></a>SNI</h5> <div class="paragraph"> <p>The server may have been configured with TLS/SNI support (<a href="https://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication</a>). This means that the server is presenting multiple identities (probably bound to separate cache containers). The client can specify which identity to connect to by specifying its name:</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with SNI (server cert)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            .sniHostName(<span class="string"><span class="delimiter">&quot;</span><span class="content">myservername</span><span class="delimiter">&quot;</span></span>)
            <span class="comment">// TrustStore is a KeyStore which contains part of the server certificate chain (e.g. the CA Root public cert)</span>
            .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/truststore</span><span class="delimiter">&quot;</span></span>)
            .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="client_certificates"><a class="anchor" href="#client_certificates"></a>Client certificates</h5> <div class="paragraph"> <p>With the above configurations the client trusts the server. For increased security, a server administrator may have set up the server to require the client to offer a valid certificate for mutual trust. This kind of configuration requires the client to present its own certificate, usually issued by the same certificate authority as the server. This certificate must be stored in a keystore and used as follows:</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with TLS (server and client cert)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            <span class="comment">// TrustStore is a KeyStore which contains part of the server certificate chain (e.g. the CA Root public cert)</span>
            .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/truststore</span><span class="delimiter">&quot;</span></span>)
            .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray())
            <span class="comment">// KeyStore containing this client's own certificate</span>
            .keyStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/keystore</span><span class="delimiter">&quot;</span></span>)
            .keyStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">keystorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray())
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Please read the <a href="{jdkroot}/technotes/tools/unix/keytool.html">KeyTool</a> documentation for more details on KeyStores. Additionally, the <a href="http://keystore-explorer.org/">KeyStore Explorer</a> is a great GUI tool for easily managing KeyStores.</p> </div> </div> </div> <div class="sect3"> <h4 id="hr_basic_api"><a class="anchor" href="#hr_basic_api"></a>1.1.5. Basic API</h4> <div class="paragraph"> <p>Below is a sample code snippet on how the client API can be used to store or retrieve information from a Hot Rod server using the Java Hot Rod client. It assumes that a Hot Rod server has been started bound to the default location (localhost:11222)</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//API entry point, by default it connects to localhost:11222</span>
CacheContainer cacheContainer = <span class="keyword">new</span> RemoteCacheManager();

<span class="comment">//obtain a handle to the remote default cache</span>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheContainer.getCache();

<span class="comment">//now add something to the cache and make sure it is there</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>).equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);

<span class="comment">//remove the data</span>
cache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> !cache.containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>) : <span class="string"><span class="delimiter">&quot;</span><span class="content">Value must have been removed!</span><span class="delimiter">&quot;</span></span>;</code></pre> </div> </div> <div class="paragraph"> <p>The client API maps the local API: <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> corresponds to <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/DefaultCacheManager.html">DefaultCacheManager</a> (both implement <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/CacheContainer.html">CacheContainer</a> ). This common API facilitates an easy migration from local calls to remote calls through Hot Rod: all one needs to do is switch between <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/DefaultCacheManager.html">DefaultCacheManager</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> - which is further simplified by the common <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/CacheContainer.html">CacheContainer</a> interface that both inherit.</p> </div> </div> <div class="sect3"> <h4 id="remotecache_keyset_entryset_values"><a class="anchor" href="#remotecache_keyset_entryset_values"></a>1.1.6. RemoteCache(.keySet|.entrySet|.values)</h4> <div class="paragraph"> <p>The collection methods <code>keySet</code>, <code>entrySet</code> and <code>values</code> are backed by the remote cache. That is that every method is called back into the <code>RemoteCache</code>. This is useful as it allows for the various keys, entries or values to be retrieved lazily, and not requiring them all be stored in the client memory at once if the user does not want. These collections adhere to the <code>Map</code> specification being that <code>add</code> and <code>addAll</code> are not supported but all other methods are supported.</p> </div> <div class="paragraph"> <p>One thing to note is the <code>Iterator.remove</code> and <code>Set.remove</code> or <code>Collection.remove</code> methods require more than 1 round trip to the server to operate. You can check out the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> Javadoc to see more details about these and the other methods.</p> </div> <div class="paragraph"> <p><strong>Iterator Usage</strong></p> </div> <div class="paragraph"> <p>The iterator method of these collections uses <code>retrieveEntries</code> internally, which is described below. If you notice <code>retrieveEntries</code> takes an argument for the batch size. There is no way to provide this to the iterator. As such the batch size can be configured via system property <code>infinispan.client.hotrod.batch_size</code> or through the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuraion/ConfigurationBuilder.html#batchSize-int-">ConfigurationBuilder</a> when configuring the <code>RemoteCacheManager</code>.</p> </div> <div class="paragraph"> <p>Also the <code>retrieveEntries</code> iterator returned is <code>Closeable</code> as such the iterators from <code>keySet</code>, <code>entrySet</code> and <code>values</code> return an <code>AutoCloseable</code> variant. Therefore you should always close these `Iterator`s when you are done with them.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (CloseableIterator&lt;Entry&lt;K, V&gt;&gt; iterator = remoteCache.entrySet().iterator) {
 ...
}</code></pre> </div> </div> <div class="paragraph"> <p><strong>What if I want a deep copy and not a backing collection?</strong></p> </div> <div class="paragraph"> <p>Previous version of <code>RemoteCache</code> allowed for the retrieval of a deep copy of the <code>keySet</code>. This is still possible with the new backing map, you just have to copy the contents yourself. Also you can do this with <code>entrySet</code> and <code>values</code>, which we didn&#8217;t support before.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;K&gt; keysCopy = remoteCache.keySet().stream().collect(Collectors.toSet());</code></pre> </div> </div> <div class="paragraph"> <p>Please use extreme cautiong with this as a large number of keys can and will cause OutOfMemoryError in the client.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span> keys = remoteCache.keySet();</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="remote_iterator"><a class="anchor" href="#remote_iterator"></a>1.1.7. Remote Iterator</h4> <div class="paragraph"> <p>Alternatively, if memory is a concern (different batch size) or you wish to do server side filtering or conversion), use the remote iterator api to retrieve entries from the server. With this method you can limit the entries that are retrieved or even returned a converted value if you dont' need all properties of your entry.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Retrieve all entries in batches of 1000</span>
<span class="type">int</span> batchSize = <span class="integer">1000</span>;
<span class="keyword">try</span> (CloseableIterator&lt;Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt;&gt; iterator = remoteCache.retrieveEntries(<span class="predefined-constant">null</span>, batchSize)) {
     <span class="keyword">while</span>(iterator.hasNext()) {
        <span class="comment">// Do something</span>
     }
}

<span class="comment">// Filter by segment</span>
<span class="predefined-type">Set</span>&lt;<span class="predefined-type">Integer</span>&gt; segments = ...
try (CloseableIterator&lt;Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt;&gt; iterator = remoteCache.retrieveEntries(<span class="predefined-constant">null</span>, segments, batchSize)) {
     <span class="keyword">while</span>(iterator.hasNext()) {
        <span class="comment">// Do something</span>
     }
}

<span class="comment">// Filter by custom filter</span>
<span class="keyword">try</span> (CloseableIterator&lt;Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt;&gt; iterator = remoteCache.retrieveEntries(<span class="string"><span class="delimiter">&quot;</span><span class="content">myFilterConverterFactory</span><span class="delimiter">&quot;</span></span>, segments, batchSize)) {
     <span class="keyword">while</span>(iterator.hasNext()) {
        <span class="comment">// Do something</span>
     }
}</code></pre> </div> </div> <div class="paragraph"> <p>In order to use custom filters, it&#8217;s necessary to deploy them first in the server. Follow the steps:</p> </div> <div class="ulist"> <ul> <li> <p>Create a factory for the filter extending <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/filter/KeyValueFilterConverterFactory.html">KeyValueFilterConverterFactory</a>, annotated with @NamedFactory containing the name of the factory, example:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.io.Serializable</span>;

<span class="keyword">import</span> <span class="include">org.infinispan.filter.AbstractKeyValueFilterConverter</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.KeyValueFilterConverter</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.KeyValueFilterConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.NamedFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.metadata.Metadata</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">myFilterConverterFactory</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyKeyValueFilterConverterFactory</span> <span class="directive">implements</span> KeyValueFilterConverterFactory {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> KeyValueFilterConverter&lt;<span class="predefined-type">String</span>, SampleEntity1, SampleEntity2&gt; getFilterConverter() {
      <span class="keyword">return</span> <span class="keyword">new</span> MyKeyValueFilterConverter();
   }
   <span class="comment">// Filter implementation. Should be serializable or externalizable for DIST caches</span>
   <span class="directive">static</span> <span class="type">class</span> <span class="class">MyKeyValueFilterConverter</span> <span class="directive">extends</span> AbstractKeyValueFilterConverter&lt;<span class="predefined-type">String</span>, SampleEntity1, SampleEntity2&gt; <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
      <span class="annotation">@Override</span>
      <span class="directive">public</span> SampleEntity2 filterAndConvert(<span class="predefined-type">String</span> key, SampleEntity1 entity, Metadata metadata) {
         <span class="comment">// returning null will case the entry to be filtered out</span>
         <span class="comment">// return SampleEntity2 will convert from the cache type SampleEntity1</span>
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> MediaType format() {
         <span class="comment">// returns the MediaType that data should be presented to this converter.</span>
         <span class="comment">// When ommitted, the server will use &quot;application/x-java-object&quot;.</span>
         <span class="comment">// Returning null will cause the filter/converter to be done in the storage format.</span>
      }
   }
}</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Create a jar with a <code>META-INF/services/org.infinispan.filter.KeyValueFilterConverterFactory</code> file and within it, write the fully qualified class name of the filter factory class implementation.</p> </li> <li> <p>Optional: If the filter uses custom key/value classes, these must be included in the JAR so that the filter can correctly unmarshall key and/or value instances.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="hr_versioned_api"><a class="anchor" href="#hr_versioned_api"></a>1.1.8. Versioned API</h4> <div class="paragraph"> <p>A RemoteCacheManager provides instances of <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interface that represents a handle to the named or default cache on the remote cluster. API wise, it extends the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html">Cache</a> interface to which it also adds some new methods, including the so called versioned API. Please find below some examples of this API link:#server_hotrod_failover[but to understand the motivation behind it, make sure you read this section.</p> </div> <div class="paragraph"> <p>The code snippet bellow depicts the usage of these versioned methods:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// To use the versioned API, remote classes are specifically needed</span>
RemoteCacheManager remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager();
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache();

remoteCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);
RemoteCache.VersionedValue valueBinary = remoteCache.getVersioned(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// removal only takes place only if the version has not been changed</span>
<span class="comment">// in between. (a new version is associated with 'car' key on each change)</span>
<span class="keyword">assert</span> remoteCache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, valueBinary.getVersion());
<span class="keyword">assert</span> !cache.containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>In a similar way, for replace:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">remoteCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);
RemoteCache.VersionedValue valueBinary = remoteCache.getVersioned(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> remoteCache.replace(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">lamborghini</span><span class="delimiter">&quot;</span></span>, valueBinary.getVersion());</code></pre> </div> </div> <div class="paragraph"> <p>For more details on versioned operations refer to <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> 's javadoc.</p> </div> </div> <div class="sect3"> <h4 id="streaming_api"><a class="anchor" href="#streaming_api"></a>1.1.9. Streaming API</h4> <div class="paragraph"> <p>When sending / receiving large objects, it might make sense to stream them between the client and the server. The Streaming API implements methods similar to the <a href="#hr_basic_api">Hot Rod Basic API</a> and <a href="#hr_versioned_api">Hot Rod Versioned API</a> described above but, instead of taking the value as a parameter, they return instances of InputStream and OutputStream. The following example shows how one would write a potentially large object:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteStreamingCache&lt;<span class="predefined-type">String</span>&gt; streamingCache = remoteCache.streaming();
<span class="predefined-type">OutputStream</span> os = streamingCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">a_large_object</span><span class="delimiter">&quot;</span></span>);
os.write(...);
os.close();</code></pre> </div> </div> <div class="paragraph"> <p>Reading such an object through streaming:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteStreamingCache&lt;<span class="predefined-type">String</span>&gt; streamingCache = remoteCache.streaming();
<span class="predefined-type">InputStream</span> is = streamingCache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">a_large_object</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">for</span>(<span class="type">int</span> b = is.read(); b &gt;= <span class="integer">0</span>; b = is.read()) {
   ...
}
is.close();</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The streaming API does <strong>not</strong> apply marshalling/unmarshalling to the values. For this reason you cannot access the same entries using both the streaming and non-streaming API at the same time, unless you provide your own marshaller to detect this situation. </td> </tr> </table> </div> <div class="paragraph"> <p>The InputStream returned by the <code>RemoteStreamingCache.get(K key)</code> method implements the <code>VersionedMetadata</code> interface, so you can retrieve version and expiration information:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteStreamingCache&lt;<span class="predefined-type">String</span>&gt; streamingCache = remoteCache.streaming();
<span class="predefined-type">InputStream</span> is = streamingCache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">a_large_object</span><span class="delimiter">&quot;</span></span>);
<span class="type">int</span> version = ((VersionedMetadata) is).getVersion();
<span class="keyword">for</span>(<span class="type">int</span> b = is.read(); b &gt;= <span class="integer">0</span>; b = is.read()) {
   ...
}
is.close();</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Conditional write methods (<code>putIfAbsent</code>, <code>replace</code>) only perform the actual condition check once the value has been completely sent to the server (i.e. when the <code>close()</code> method has been invoked on the <code>OutputStream</code>. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="creating_event_listeners"><a class="anchor" href="#creating_event_listeners"></a>1.1.10. Creating Event Listeners</h4> <div class="paragraph"> <p>Java Hot Rod clients can register listeners to receive cache-entry level events. Cache entry created, modified and removed events are supported.</p> </div> <div class="paragraph"> <p>Creating a client listener is very similar to embedded listeners, except that different annotations and event classes are used. Here&#8217;s an example of a client listener that prints out each event received:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.annotation</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.event</span>.*;

<span class="annotation">@ClientListener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">EventPrintListener</span> {

   <span class="annotation">@ClientCacheEntryCreated</span>
   <span class="directive">public</span> <span class="type">void</span> handleCreatedEvent(ClientCacheEntryCreatedEvent e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

   <span class="annotation">@ClientCacheEntryModified</span>
   <span class="directive">public</span> <span class="type">void</span> handleModifiedEvent(ClientCacheEntryModifiedEvent e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

   <span class="annotation">@ClientCacheEntryRemoved</span>
   <span class="directive">public</span> <span class="type">void</span> handleRemovedEvent(ClientCacheEntryRemovedEvent e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

}</code></pre> </div> </div> <div class="paragraph"> <p><code>ClientCacheEntryCreatedEvent</code> and <code>ClientCacheEntryModifiedEvent</code> instances provide information on the affected key, and the version of the entry. This version can be used to invoke conditional operations on the server, such as <code>replaceWithVersion</code> or <code>removeWithVersion</code>.</p> </div> <div class="paragraph"> <p><code>ClientCacheEntryRemovedEvent</code> events are only sent when the remove operation succeeds. In other words, if a remove operation is invoked but no entry is found or no entry should be removed, no event is generated. Users interested in removed events, even when no entry was removed, can develop event customization logic to generate such events. More information can be found in the <a href="#customizing_events">customizing client events section</a>.</p> </div> <div class="paragraph"> <p>All <code>ClientCacheEntryCreatedEvent</code>, <code>ClientCacheEntryModifiedEvent</code> and <code>ClientCacheEntryRemovedEvent</code> event instances also provide a <code>boolean isCommandRetried()</code> method that will return true if the write command that caused this had to be retried again due to a topology change. This could be a sign that this event has been duplicated or another event was dropped and replaced (eg: ClientCacheEntryModifiedEvent replaced ClientCacheEntryCreatedEvent).</p> </div> <div class="paragraph"> <p>Once the client listener implementation has been created, it needs to be registered with the server. To do so, execute:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener());</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="removing_event_listeners"><a class="anchor" href="#removing_event_listeners"></a>1.1.11. Removing Event Listeners</h4> <div class="paragraph"> <p>When an client event listener is not needed any more, it can be removed:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EventPrintListener listener = ...
cache.removeClientListener(listener);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="filtering_events"><a class="anchor" href="#filtering_events"></a>1.1.12. Filtering Events</h4> <div class="paragraph"> <p>In order to avoid inundating clients with events, users can provide filtering functionality to limit the number of events fired by the server for a particular client listener. To enable filtering, a cache event filter factory needs to be created that produces filter instances:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.NamedFactory</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-filter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">StaticCacheEventFilterFactory</span> <span class="directive">implements</span> CacheEventFilterFactory {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> CacheEventFilterFactory&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; getFilter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> StaticCacheEventFilter();
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// needed when running in a cluster</span>
<span class="type">class</span> <span class="class">StaticCacheEventFilter</span> <span class="directive">implements</span> CacheEventFilter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;, <span class="predefined-type">Serializable</span> {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> accept(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="keyword">if</span> (key.equals(<span class="integer">1</span>)) <span class="comment">// static key</span>
         <span class="keyword">return</span> <span class="predefined-constant">true</span>;

      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>The cache event filter factory instance defined above creates filter instances which statically filter out all entries except the one whose key is <code>1</code>.</p> </div> <div class="paragraph"> <p>To be able to register a listener with this cache event filter factory, the factory has to be given a unique name, and the Hot Rod server needs to be plugged with the name and the cache event filter factory instance. Plugging the Infinispan Server with a custom filter involves the following steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file with the filter implementation within it.</p> </li> <li> <p>Optional: If the cache uses custom key/value classes, these must be included in the JAR so that the callbacks can be executed with the correctly unmarshalled key and/or value instances. If the client listener has <code>useRawData</code> enabled, this is not necessary since the callback key/value instances will be provided in binary format.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.notifications.cachelistener.filter.CacheEventFilterFactory</code> file within the JAR file and within it, write the fully qualified class name of the filter class implementation.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> <div class="paragraph"> <p>On top of that, the client listener needs to be linked with this cache event filter factory by adding the factory&#8217;s name to the @ClientListener annotation:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientListener</span>(filterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-filter</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">EventPrintListener</span> { ... }</code></pre> </div> </div> <div class="paragraph"> <p>And, register the listener with the server:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener());</code></pre> </div> </div> <div class="paragraph"> <p>Dynamic filter instances that filter based on parameters provided when the listener is registered are also possible. Filters use the parameters received by the filter factories to enable this option. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventFilter</span>;

<span class="type">class</span> <span class="class">DynamicCacheEventFilterFactory</span> <span class="directive">implements</span> CacheEventFilterFactory {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> CacheEventFilter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; getFilter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> DynamicCacheEventFilter(params);
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// needed when running in a cluster</span>
<span class="type">class</span> <span class="class">DynamicCacheEventFilter</span> <span class="directive">implements</span> CacheEventFilter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params;

   DynamicCacheEventFilter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="local-variable">this</span>.params = params;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> accept(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="keyword">if</span> (key.equals(params[<span class="integer">0</span>])) <span class="comment">// dynamic key</span>
         <span class="keyword">return</span> <span class="predefined-constant">true</span>;

      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>The dynamic parameters required to do the filtering are provided when the listener is registered:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener(), <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1</span>}, <span class="predefined-constant">null</span>);</code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Filter instances have to marshallable when they are deployed in a cluster so that the filtering can happen right where the event is generated, even if the even is generated in a different node to where the listener is registered. To make them marshallable, either make them extend <code>Serializable</code>, <code>Externalizable</code>, or provide a custom <code>Externalizer</code> for them. </td> </tr> </table> </div> <div class="sect4"> <h5 id="skipping_notifications"><a class="anchor" href="#skipping_notifications"></a>Skipping Notifications</h5> <div class="paragraph"> <p>Include the <code>SKIP_LISTENER_NOTIFICATION</code> flag when calling remote API methods to perform operations without getting event notifications from the server. For example, to prevent listener notifications when creating or modifying values, set the flag as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">remoteCache.withFlags(Flag.SKIP_LISTENER_NOTIFICATION).put(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="customizing_events"><a class="anchor" href="#customizing_events"></a>1.1.13. Customizing Events</h4> <div class="paragraph"> <p>The events generated by default contain just enough information to make the event relevant but they avoid cramming too much information in order to reduce the cost of sending them. Optionally, the information shipped in the events can be customised in order to contain more information, such as values, or to contain even less information. This customization is done with <code>CacheEventConverter</code> instances generated by a <code>CacheEventConverterFactory</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverter</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.NamedFactory</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-converter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">StaticConverterFactory</span> <span class="directive">implements</span> CacheEventConverterFactory {
   <span class="directive">final</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; staticConverter = <span class="keyword">new</span> StaticCacheEventConverter();
   <span class="directive">public</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; getConverter(<span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> staticConverter;
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// needed when running in a cluster</span>
<span class="type">class</span> <span class="class">StaticCacheEventConverter</span> <span class="directive">implements</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">public</span> CustomEvent convert(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata, <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, newValue);
   }
}

<span class="comment">// Needs to be Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// regardless of cluster or local caches</span>
<span class="directive">static</span> <span class="type">class</span> <span class="class">CustomEvent</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Integer</span> key;
   <span class="directive">final</span> <span class="predefined-type">String</span> value;
   CustomEvent(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> value) {
      <span class="local-variable">this</span>.key = key;
      <span class="local-variable">this</span>.value = value;
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>In the example above, the converter generates a new custom event which includes the value as well as the key in the event. This will result in bigger event payloads compared with default events, but if combined with filtering, it can reduce its network bandwidth cost.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> The target type of the converter must be either <code>Serializable</code> or <code>Externalizable</code>. In this particular case of converters, providing an Externalizer will not work by default since the default Hot Rod client marshaller does not support them. </td> </tr> </table> </div> <div class="paragraph"> <p>Handling custom events requires a slightly different client listener implementation to the one demonstrated previously. To be more precise, it needs to handle <code>ClientCacheEntryCustomEvent</code> instances:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.annotation</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.event</span>.*;

<span class="annotation">@ClientListener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomEventPrintListener</span> {

   <span class="annotation">@ClientCacheEntryCreated</span>
   <span class="annotation">@ClientCacheEntryModified</span>
   <span class="annotation">@ClientCacheEntryRemoved</span>
   <span class="directive">public</span> <span class="type">void</span> handleCustomEvent(ClientCacheEntryCustomEvent&lt;CustomEvent&gt; e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

}</code></pre> </div> </div> <div class="paragraph"> <p>The <code>ClientCacheEntryCustomEvent</code> received in the callback exposes the custom event via <code>getEventData</code> method, and the <code>getType</code> method provides information on whether the event generated was as a result of cache entry creation, modification or removal.</p> </div> <div class="paragraph"> <p>Similar to filtering, to be able to register a listener with this converter factory, the factory has to be given a unique name, and the Hot Rod server needs to be plugged with the name and the cache event converter factory instance. Plugging the Infinispan Server with an event converter involves the following steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file with the converter implementation within it.</p> </li> <li> <p>Optional: If the cache uses custom key/value classes, these must be included in the JAR so that the callbacks can be executed with the correctly unmarshalled key and/or value instances. If the client listener has <code>useRawData</code> enabled, this is not necessary since the callback key/value instances will be provided in binary format.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</code> file within the JAR file and within it, write the fully qualified class name of the converter class implementation.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> <div class="paragraph"> <p>On top of that, the client listener needs to be linked with this converter factory by adding the factory&#8217;s name to the @ClientListener annotation:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientListener</span>(converterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-converter</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomEventPrintListener</span> { ... }</code></pre> </div> </div> <div class="paragraph"> <p>And, register the listener with the server:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> CustomEventPrintListener());</code></pre> </div> </div> <div class="paragraph"> <p>Dynamic converter instances that convert based on parameters provided when the listener is registered are also possible. Converters use the parameters received by the converter factories to enable this option. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverter</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-converter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">DynamicCacheEventConverterFactory</span> <span class="directive">implements</span> CacheEventConverterFactory {
   <span class="directive">public</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; getConverter(<span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> DynamicCacheEventConverter(params);
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers needed when running in a cluster</span>
<span class="type">class</span> <span class="class">DynamicCacheEventConverter</span> <span class="directive">implements</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params;

   DynamicCacheEventConverter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="local-variable">this</span>.params = params;
   }

   <span class="directive">public</span> CustomEvent convert(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="comment">// If the key matches a key given via parameter, only send the key information</span>
      <span class="keyword">if</span> (params[<span class="integer">0</span>].equals(key))
         <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, <span class="predefined-constant">null</span>);

      <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, newValue);
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>The dynamic parameters required to do the conversion are provided when the listener is registered:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener(), <span class="predefined-constant">null</span>, <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1</span>});</code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Converter instances have to marshallable when they are deployed in a cluster, so that the conversion can happen right where the event is generated, even if the even is generated in a different node to where the listener is registered. To make them marshallable, either make them extend <code>Serializable</code>, <code>Externalizable</code>, or provide a custom <code>Externalizer</code> for them. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="filter_and_custom_events"><a class="anchor" href="#filter_and_custom_events"></a>1.1.14. Filter and Custom Events</h4> <div class="paragraph"> <p>If you want to do both event filtering and customization, it&#8217;s easier to implement <code>org.infinispan.notifications.cachelistener.filter.CacheEventFilterConverter</code> which allows both filter and customization to happen in a single step. For convenience, it&#8217;s recommended to extend <code>org.infinispan.notifications.cachelistener.filter.AbstractCacheEventFilterConverter</code> instead of implementing <code>org.infinispan.notifications.cachelistener.filter.CacheEventFilterConverter</code> directly. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverter</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-filter-converter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">DynamicCacheEventFilterConverterFactory</span> <span class="directive">implements</span> CacheEventFilterConverterFactory {
   <span class="directive">public</span> CacheEventFilterConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; getFilterConverter(<span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> DynamicCacheEventFilterConverter(params);
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers needed when running in a cluster</span>
<span class="comment">//</span>
<span class="type">class</span> <span class="class">DynamicCacheEventFilterConverter</span> <span class="directive">extends</span> AbstractCacheEventFilterConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params;

   DynamicCacheEventFilterConverter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="local-variable">this</span>.params = params;
   }

   <span class="directive">public</span> CustomEvent filterAndConvert(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="comment">// If the key matches a key given via parameter, only send the key information</span>
      <span class="keyword">if</span> (params[<span class="integer">0</span>].equals(key))
         <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, <span class="predefined-constant">null</span>);

      <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, newValue);
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>Similar to filters and converters, to be able to register a listener with this combined filter/converter factory, the factory has to be given a unique name via the <code>@NamedFactory</code> annotation, and the Hot Rod server needs to be plugged with the name and the cache event converter factory instance. Plugging the Infinispan Server with an event converter involves the following steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file with the converter implementation within it.</p> </li> <li> <p>Optional: If the cache uses custom key/value classes, these must be included in the JAR so that the callbacks can be executed with the correctly unmarshalled key and/or value instances. If the client listener has <code>useRawData</code> enabled, this is not necessary since the callback key/value instances will be provided in binary format.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.notifications.cachelistener.filter.CacheEventFilterConverterFactory</code> file within the JAR file and within it, write the fully qualified class name of the converter class implementation.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> <div class="paragraph"> <p>From a client perspective, to be able to use the combined filter and converter class, the client listener must define the same filter factory and converter factory names, e.g.:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientListener</span>(filterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-filter-converter</span><span class="delimiter">&quot;</span></span>, converterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-filter-converter</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomEventPrintListener</span> { ... }</code></pre> </div> </div> <div class="paragraph"> <p>The dynamic parameters required in the example above are provided when the listener is registered via either filter or converter parameters. If filter parameters are non-empty, those are used, otherwise, the converter parameters:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> CustomEventPrintListener(), <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1</span>}, <span class="predefined-constant">null</span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="event_marshalling"><a class="anchor" href="#event_marshalling"></a>1.1.15. Event Marshalling</h4> <div class="paragraph"> <p>Hot Rod servers can store data in different formats, but in spite of that, Java Hot Rod client users can still develop <code>CacheEventConverter</code> or <code>CacheEventFilter</code> instances that work on typed objects. By default, filters and converter will use data as POJO (application/x-java-object) but it is possible to override the desired format by overriding the method <code>format()</code> from the filter/converter. If the format returns <code>null</code>, the filter/converter will receive data as it&#8217;s stored.</p> </div> <div class="paragraph"> <p>As indicated in the <a href="#hot_rod_marshalling_data">Marshalling Data</a> section, Hot Rod Java clients can be configured to use a different <code>org.infinispan.commons.marshall.Marshaller</code> instance. If doing this and deploying <code>CacheEventConverter</code> or <code>CacheEventFilter</code> instances, to be able to present filters/converter with Java Objects rather than marshalled content, the server needs to be able to convert between objects and the binary format produced by the marshaller.</p> </div> <div class="paragraph"> <p>To deploy a Marshaller instance server-side, follow a similar method to the one used to deploy <code>CacheEventConverter</code> or <code>CacheEventFilter</code> instances:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file with the converter implementation within it.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.commons.marshall.Marshaller</code> file within the JAR file and within it, write the fully qualified class name of the marshaller class implementation.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> <div class="paragraph"> <p>Note that the Marshaller could be deployed in either a separate jar, or in the same jar as the <code>CacheEventConverter</code> and/or <code>CacheEventFilter</code> instances.</p> </div> <div class="sect4"> <h5 id="protostream_deployment"><a class="anchor" href="#protostream_deployment"></a>Deploying Protostream Marshallers</h5> <div class="paragraph"> <p>If a cache stores Protobuf content, as it happens when using ProtoStream marshaller in the Hot Rod client, it&#8217;s not necessary to deploy a custom marshaller since the format is already support by the server: there are transcoders from Protobuf format to most common formats like JSON and POJO.</p> </div> <div class="paragraph"> <p>When using filters/converters with those caches, and it&#8217;s desirable to use filter/converters with Java Objects rather binary Protobuf data, it&#8217;s necessary to configure the extra ProtoStream marshallers so that the server can unmarshall the data before filtering/converting. To do so, you must configure the required <a href="#protostream">SerializationContextInitializer(s)</a> as part of the <a href="#protostream_cm_config">server&#8217;s configuration</a>.</p> </div> </div> </div> <div class="sect3"> <h4 id="listener_state_handling"><a class="anchor" href="#listener_state_handling"></a>1.1.16. Listener State Handling</h4> <div class="paragraph"> <p>Client listener annotation has an optional <code>includeCurrentState</code> attribute that specifies whether state will be sent to the client when the listener is added or when there&#8217;s a failover of the listener.</p> </div> <div class="paragraph"> <p>By default, <code>includeCurrentState</code> is false, but if set to true and a client listener is added in a cache already containing data, the server iterates over the cache contents and sends an event for each entry to the client as a <code>ClientCacheEntryCreated</code> (or custom event if configured). This allows clients to build some local data structures based on the existing content. Once the content has been iterated over, events are received as normal, as cache updates are received. If the cache is clustered, the entire cluster wide contents are iterated over.</p> </div> <div class="paragraph"> <p><code>includeCurrentState</code> also controls whether state is received when the node where the client event listener is registered fails and it&#8217;s moved to a different node. The next section discusses this topic in depth.</p> </div> </div> <div class="sect3"> <h4 id="listener_failure_handling"><a class="anchor" href="#listener_failure_handling"></a>1.1.17. Listener Failure Handling</h4> <div class="paragraph"> <p>When a Hot Rod client registers a client listener, it does so in a single node in a cluster. If that node fails, the Java Hot Rod client detects that transparently and fails over all listeners registered in the node that failed to another node.</p> </div> <div class="paragraph"> <p>During this fail over the client might miss some events. To avoid missing these events, the client listener annotation contains an optional parameter called <code>includeCurrentState</code> which if set to true, when the failover happens, the cache contents can iterated over and <code>ClientCacheEntryCreated</code> events (or custom events if configured) are generated. By default, <code>includeCurrentState</code> is set to false.</p> </div> <div class="paragraph"> <p>Java Hot Rod clients can be made aware of such fail over event by adding a callback to handle it:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientCacheFailover</span>
<span class="directive">public</span> <span class="type">void</span> handleFailover(ClientCacheFailoverEvent e) {
  ...
}</code></pre> </div> </div> <div class="paragraph"> <p>This is very useful in use cases where the client has cached some data, and as a result of the fail over, taking in account that some events could be missed, it could decide to clear any locally cached data when the fail over event is received, with the knowledge that after the fail over event, it will receive events for the contents of the entire cache.</p> </div> </div> <div class="sect3"> <h4 id="near_caching"><a class="anchor" href="#near_caching"></a>1.1.18. Near Caching</h4> <div class="paragraph"> <p>The Java Hot Rod client can be optionally configured with a near cache, which means that the Hot Rod client can keep a local cache that stores recently used data. Enabling near caching can significantly improve the performance of read operations <code>get</code> and <code>getVersioned</code> since data can potentially be located locally within the Hot Rod client instead of having to go remote.</p> </div> <div class="paragraph"> <p>To enable near caching, the user must set the near cache mode to <code>INVALIDATED</code>. By doing that near cache is populated upon retrievals from the server via calls to <code>get</code> or <code>getVersioned</code> operations. When near cached entries are updated or removed server-side, the cached near cache entries are invalidated. If a key is requested after it&#8217;s been invalidated, it&#8217;ll have to be re-fetched from the server.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> You should not use <code>maxIdle</code> expiration with near caches, as near-cache reads will not propagate the last access change to the server and to the other clients. </td> </tr> </table> </div> <div class="paragraph"> <p>When near cache is enabled, its size must be configured by defining the maximum number of entries to keep in the near cache. When the maximum is reached, near-cached entries are evicted. If providing <code>0</code> or a negative value, it is assumed that the near cache is unbounded.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Users should be careful when configuring near cache to be unbounded since it shifts the responsibility to keep the near cache&#8217;s size within the boundaries of the client JVM to the user. </td> </tr> </table> </div> <div class="paragraph"> <p>The Hot Rod client&#8217;s near cache mode is configured using the <code>NearCacheMode</code> enumeration and calling:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.NearCacheMode</span>;
...

<span class="comment">// Unbounded invalidated near cache</span>
ConfigurationBuilder unbounded = <span class="keyword">new</span> ConfigurationBuilder();
unbounded.nearCache().mode(NearCacheMode.INVALIDATED).maxEntries(-<span class="integer">1</span>);

<span class="comment">// Bounded invalidated near cache</span>
ConfigurationBuilder bounded = <span class="keyword">new</span> ConfigurationBuilder();
bounded.nearCache().mode(NearCacheMode.INVALIDATED).maxEntries(<span class="integer">100</span>);</code></pre> </div> </div> <div class="paragraph"> <p>Since the configuration is shared by all caches obtained from a single <code>RemoteCacheManager</code>, you may not want to enable near-caching for all of them. You can use the <code>cacheNamePattern</code> configuration attribute to define a regular expression which matches the names of the caches for which you want near-caching. Caches whose name don&#8217;t match the regular expression, will not have near-caching enabled.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Bounded invalidated near cache with pattern matching</span>
ConfigurationBuilder bounded = <span class="keyword">new</span> ConfigurationBuilder();
bounded.nearCache()
  .mode(NearCacheMode.INVALIDATED)
  .maxEntries(<span class="integer">100</span>)
  .cacheNamePattern(<span class="string"><span class="delimiter">&quot;</span><span class="content">near.*</span><span class="delimiter">&quot;</span></span>); <span class="comment">// enable near-cache only for caches whose name starts with 'near'</span></code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Near caches work the same way for local caches as they do for clustered caches, but in a clustered cache scenario, if the server node sending the near cache notifications to the Hot Rod client goes down, the Hot Rod client transparently fails over to another node in the cluster, clearing the near cache along the way. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="unsupported_methods"><a class="anchor" href="#unsupported_methods"></a>1.1.19. Unsupported methods</h4> <div class="paragraph"> <p>Some of the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html">Cache</a> methods are not being supported by the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> . Calling one of these methods results in an <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/UnsupportedOperationException.html">UnsupportedOperationException</a> being thrown. Most of these methods do not make sense on the remote cache (e.g. listener management operations), or correspond to methods that are not supported by local cache as well (e.g. containsValue). Another set of unsupported operations are some of the atomic operations inherited from <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">ConcurrentMap</a> :</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> remove(<span class="predefined-type">Object</span> key, <span class="predefined-type">Object</span> value);
<span class="type">boolean</span> replace(<span class="predefined-type">Object</span> key, <span class="predefined-type">Object</span> value);
<span class="type">boolean</span> replace(<span class="predefined-type">Object</span> key, <span class="predefined-type">Object</span> oldValue, <span class="predefined-type">Object</span> value);</code></pre> </div> </div> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> offers alternative versioned methods for these atomic operations, that are also network friendly, by not sending the whole value object over the network, but a version identifier. See the section on versioned API.</p> </div> <div class="paragraph"> <p>Each one of these unsupported operation is documented in the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> javadoc.</p> </div> </div> <div class="sect3"> <h4 id="return_values"><a class="anchor" href="#return_values"></a>1.1.20. Return values</h4> <div class="paragraph"> <p>There is a set of methods that alter a cached entry and return the previous existing value, e.g.:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">V remove(<span class="predefined-type">Object</span> key);
V put(K key, V value);</code></pre> </div> </div> <div class="paragraph"> <p>By default on RemoteCache, these operations return null even if such a previous value exists. This approach reduces the amount of data sent over the network. However, if these return values are needed they can be enforced on a per invocation basis using flags:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">initialValue</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> <span class="predefined-constant">null</span> == cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>.equals(cache.withFlags(Flag.FORCE_RETURN_VALUE).put(<span class="string"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span>,
<span class="error"> </span><span class="error"> </span> <span class="string"><span class="delimiter">&quot;</span><span class="content">newValue</span><span class="delimiter">&quot;</span></span>));</code></pre> </div> </div> <div class="paragraph"> <p>This default behavior can can be changed through force-return-value=true configuration parameter (see configuration section bellow).</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="hr_transactions"><a class="anchor" href="#hr_transactions"></a>2. Hot Rod Transactions</h2> <div class="sectionbody"> <div class="paragraph"> <p>You can configure and use Hot Rod clients in JTA <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Transaction.html">Transaction</a>s.</p> </div> <div class="paragraph"> <p>To participate in a transaction, the Hot Rod client requires the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> with which it interacts and whether it participates in the transaction through the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Synchronization.html">Synchronization</a> or <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a> interface.</p> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="paragraph"> <p>Transactions are optimistic in that clients acquire write locks on entries during the prepare phase. To avoid data inconsistency, be sure to read about <a href="#hr_transactions_force_return_value">Detecting Conflicts with Transactions</a>.</p> </div> </td> </tr> </table> </div> <div class="sect2"> <h3 id="hr_transactions_config_server"><a class="anchor" href="#hr_transactions_config_server"></a>2.1. Configuring the Server</h3> <div class="paragraph"> <p>Caches in the server must also be transactional for clients to participate in JTA <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Transaction.html">Transaction</a>s.</p> </div> <div class="paragraph"> <p>The following server configuration is required, otherwise transactions rollback only:</p> </div> <div class="ulist"> <ul> <li> <p>Isolation level must be <code>REPEATABLE_READ</code>.</p> </li> <li> <p>Locking mode must be <code>PESSIMISTIC</code>. In a future release, <code>OPTIMISTIC</code> locking mode will be supported.</p> </li> <li> <p>Transaction mode should be <code>NON_XA</code> or <code>NON_DURABLE_XA</code>. Hot Rod transactions cannot use <code>FULL_XA</code> because it degrades performance.</p> </li> </ul> </div> <div class="paragraph"> <p>Hot Rod transactions have their own recovery mechanism.</p> </div> </div> <div class="sect2"> <h3 id="hr_transactions_config_client"><a class="anchor" href="#hr_transactions_config_client"></a>2.2. Configuring Hot Rod Clients</h3> <div class="paragraph"> <p>When you create the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a>, you can set the default <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/TransactionMode.html">TransactionMode</a> that the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> uses.</p> </div> <div class="paragraph"> <p>The <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> lets you create only one configuration for transactional caches, as in the following example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
<span class="comment">//other client configuration parameters</span>
cb.transaction().transactionManagerLookup(GenericTransactionManagerLookup.getInstance());
cb.transaction().transactionMode(TransactionMode.NON_XA);
cb.transaction().timeout(<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.MINUTES)
RemoteCacheManager rmc = <span class="keyword">new</span> RemoteCacheManager(cb.build());</code></pre> </div> </div> <div class="paragraph"> <p>The preceding configuration applies to all instances of a remote cache. If you need to apply different configurations to remote cache instances, you can override the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> configuration. See <a href="#hr_transactions_override_rcm">Overriding RemoteCacheManager Configuration</a>.</p> </div> <div class="paragraph"> <p>See <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/ConfigurationBuilder.html">ConfigurationBuilder</a> Javadoc for documentation on configuration parameters.</p> </div> <div class="paragraph"> <p>You can also configure the Java Hot Rod client with a properties file, as in the following example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>infinispan.client.hotrod.transaction.transaction_manager_lookup = org.infinispan.client.hotrod.transaction.lookup.GenericTransactionManagerLookup
infinispan.client.hotrod.transaction.transaction_mode = NON_XA
infinispan.client.hotrod.transaction.timeout = 60000</code></pre> </div> </div> <div class="sect3"> <h4 id="hr_transactions_tmlookup"><a class="anchor" href="#hr_transactions_tmlookup"></a>2.2.1. TransactionManagerLookup Interface</h4> <div class="paragraph"> <p><code>TransactionManagerLookup</code> provides an entry point to fetch a <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p> </div> <div class="paragraph"> <p>Available implementations of <code>TransactionManagerLookup</code>:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1"><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/transaction/lookup/GenericTransactionManagerLookup.html">GenericTransactionManagerLookup</a></dt> <dd> <p>A lookup class that locates <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>s running in Java EE application servers. Defaults to the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/transaction/manager/RemoteTransactionManager.html">RemoteTransactionManager</a> if it cannot find a <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p> </dd> </dl> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>In most cases, <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/transaction/lookup/GenericTransactionManagerLookup.html">GenericTransactionManagerLookup</a> is suitable. However, you can implement the <code>TransactionManagerLookup</code> interface if you need to integrate a custom <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p> </div> </td> </tr> </table> </div> <div class="dlist"> <dl> <dt class="hdlist1"><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/transaction/lookup/RemoteTransactionManagerLookup.html">RemoteTransactionManagerLookup</a></dt> <dd> <p>A basic, and volatile, <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> if no other implementation is available. Note that this implementation has significant limitations when handling concurrent transactions and recovery.</p> </dd> </dl> </div> </div> <div class="sect3"> <h4 id="hr_transactions_modes"><a class="anchor" href="#hr_transactions_modes"></a>2.2.2. Transaction Modes</h4> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/TransactionMode.html">TransactionMode</a> controls how a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interacts with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="paragraph"> <p>Configure transaction modes on both the Infinispan server and your client application. If clients attempt to perform transactional operations on non-transactional caches, runtime exceptions can occur.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Transaction modes are the same in both the Infinispan configuration and client settings. Use the following modes with your client, see the Infinispan configuration schema for the server:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1"><code>NONE</code></dt> <dd> <p>The <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> does not interact with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>. This is the default mode and is non-transactional.</p> </dd> <dt class="hdlist1"><code>NON_XA</code></dt> <dd> <p>The <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interacts with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> via <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Synchronization.html">Synchronization</a>.</p> </dd> <dt class="hdlist1"><code>NON_DURABLE_XA</code></dt> <dd> <p>The <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interacts with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> via <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a>. Recovery capabilities are disabled.</p> </dd> <dt class="hdlist1"><code>FULL_XA</code></dt> <dd> <p>The <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interacts with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> via <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a>. Recovery capabilities are enabled. Invoke the <code>XaResource.recover()</code> method to retrieve transactions to recover.</p> </dd> </dl> </div> </div> </div> <div class="sect2"> <h3 id="hr_transactions_override_rcm"><a class="anchor" href="#hr_transactions_override_rcm"></a>2.3. Overriding Configuration for Cache Instances</h3> <div class="paragraph"> <p>Because <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> does not support different configurations for each cache instance. However, <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> includes the <code>getCache(String)</code> method that returns the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> instances and lets you override some configuration parameters, as follows:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1"><code>getCache(String cacheName, TransactionMode transactionMode)</code></dt> <dd> <p>Returns a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> and overrides the configured <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/TransactionMode.html">TransactionMode</a>.</p> </dd> <dt class="hdlist1"><code>getCache(String cacheName, boolean forceReturnValue, TransactionMode transactionMode)</code></dt> <dd> <p>Same as previous, but can also force return values for write operations.</p> </dd> <dt class="hdlist1"><code>getCache(String cacheName, TransactionManager transactionManager)</code></dt> <dd> <p>Returns a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> and overrides the configured <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p> </dd> <dt class="hdlist1"><code>getCache(String cacheName, boolean forceReturnValue, TransactionManager transactionManager)</code></dt> <dd> <p>Same as previous, but can also force return values for write operations.</p> </dd> <dt class="hdlist1"><code>getCache(String cacheName, TransactionMode transactionMode, TransactionManager transactionManager)</code></dt> <dd> <p>Returns a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> and overrides the configured <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/TransactionMode.html">TransactionMode</a>. Uses the configured values, if <code>transactionManager</code> or <code>transactionMode</code> is null.</p> </dd> <dt class="hdlist1"><code>getCache(String cacheName, boolean forceReturnValue, TransactionMode transactionMode, TransactionManager transactionManager)</code></dt> <dd> <p>Same as previous, but can also force return values for write operations.</p> </dd> </dl> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>The <code>getCache(String)</code> method returns <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> instances regardless of whether they are transaction or not. <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> includes a <code>getTransactionManager()</code> method that returns the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> that the cache uses. If the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> is not transactional, the method returns <code>null</code>.</p> </div> </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="hr_transactions_force_return_value"><a class="anchor" href="#hr_transactions_force_return_value"></a>2.4. Detecting Conflicts with Transactions</h3> <div class="paragraph"> <p>Transactions use the initial values of keys to detect conflicts. For example, "k" has a value of "v" when a transaction begins. During the prepare phase, the transaction fetches "k" from the server to read the value. If the value has changed, the transaction rolls back to avoid a conflict.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>Transactions use versions to detect changes instead of checking value equality.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>The <code>forceReturnValue</code> parameter controls write operations to the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> and helps avoid conflicts. It has the following values:</p> </div> <div class="ulist"> <ul> <li> <p>If <code>true</code>, the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> fetches the most recent value from the server before performing write operations. However, the <code>forceReturnValue</code> parameter applies only to write operations that access the key for the first time.</p> </li> <li> <p>If <code>false</code>, the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> does not fetch the most recent value from the server before performing write operations. Because this setting</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>This parameter does not affect <em>conditional</em> write operations such as <code>replace</code> or <code>putIfAbsent</code> because they require the most recent value.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>The following transactions provide an example where the <code>forceReturnValue</code> parameter can prevent conflicting write operations:</p> </div> <div class="listingblock"> <div class="title">Transaction 1 (TX1)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...
TransactionManager tm = ...

tm.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
tm.commit();</code></pre> </div> </div> <div class="listingblock"> <div class="title">Transaction 2 (TX2)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...
TransactionManager tm = ...

tm.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v2</span><span class="delimiter">&quot;</span></span>);
tm.commit();</code></pre> </div> </div> <div class="paragraph"> <p>In this example, TX1 and TX2 are executed in parallel. The initial value of "k" is "v".</p> </div> <div class="ulist"> <ul> <li> <p>If <code>forceReturnValue = true</code>, the <code>cache.put()</code> operation fetches the value for "k" from the server in both TX1 and TX2. The transaction that acquires the lock for "k" first then commits. The other transaction rolls back during the commit phase because the transaction can detect that "k" has a value other than "v".</p> </li> <li> <p>If <code>forceReturnValue = false</code>, the <code>cache.put()</code> operation does not fetch the value for "k" from the server and returns null. Both TX1 and TX2 can successfully commit, which results in a conflict. This occurs because neither transaction can detect that the initial value of "k" changed.</p> </li> </ul> </div> <div class="paragraph"> <p>The following transactions include <code>cache.get()</code> operations to read the value for "k" before doing the <code>cache.put()</code> operations:</p> </div> <div class="listingblock"> <div class="title">Transaction 1 (TX1)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...
TransactionManager tm = ...

tm.begin();
cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
tm.commit();</code></pre> </div> </div> <div class="listingblock"> <div class="title">Transaction 2 (TX2)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...
TransactionManager tm = ...

tm.begin();
cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v2</span><span class="delimiter">&quot;</span></span>);
tm.commit();</code></pre> </div> </div> <div class="paragraph"> <p>In the preceding examples, TX1 and TX2 both read the key so the <code>forceReturnValue</code> parameter does not take effect. One transaction commits, the other rolls back. However, the <code>cache.get()</code> operation requires an additional server request. If you do not need the return value for the <code>cache.put()</code> operation that server request is inefficient.</p> </div> </div> <div class="sect2"> <h3 id="hr_transactions_ex_use_config"><a class="anchor" href="#hr_transactions_ex_use_config"></a>2.5. Using the Configured Transaction Manager and Transaction Mode</h3> <div class="paragraph"> <p>The following example shows how to use the <code>TransactionManager</code> and <code>TransactionMode</code> that you configure in the <code>RemoteCacheManager</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//Configure the transaction manager and transaction mode.</span>
org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.transaction().transactionManagerLookup(RemoteTransactionManagerLookup.getInstance());
cb.transaction().transactionMode(TransactionMode.NON_XA);

RemoteCacheManager rcm = <span class="keyword">new</span> RemoteCacheManager(cb.build());

<span class="comment">//The my-cache instance uses the RemoteCacheManager configuration.</span>
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = rcm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span>);

<span class="comment">//Return the transaction manager that the cache uses.</span>
TransactionManager tm = cache.getTransactionManager();

<span class="comment">//Perform a simple transaction.</span>
tm.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">K1 value is </span><span class="delimiter">&quot;</span></span> + cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>));
tm.commit();</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="hr_transactions_ex_override_tm"><a class="anchor" href="#hr_transactions_ex_override_tm"></a>2.6. Overriding the Transaction Manager</h3> <div class="paragraph"> <p>The following example shows how to override <code>TransactionManager</code> with the <code>getCache</code> method:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//Configure the transaction manager and transaction mode.</span>
org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.transaction().transactionManagerLookup(RemoteTransactionManagerLookup.getInstance());
cb.transaction().transactionMode(TransactionMode.NON_XA);

RemoteCacheManager rcm = <span class="keyword">new</span> RemoteCacheManager(cb.build());

<span class="comment">//Define a custom TransactionManager.</span>
TransactionManager myCustomTM = ...

<span class="comment">//Override the TransactionManager for the my-cache instance. Use the default configuration if null is returned.</span>
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = rcm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>, myCustomTM);

<span class="comment">//Perform a simple transaction.</span>
myCustomTM.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">K1 value is </span><span class="delimiter">&quot;</span></span> + cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>));
myCustomTM.commit();</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="hr_transactions_ex_override_mode"><a class="anchor" href="#hr_transactions_ex_override_mode"></a>2.7. Overriding the Transaction Mode</h3> <div class="paragraph"> <p>The following example shows how to override <code>TransactionMode</code> with the <code>getCache</code> method:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//Configure the transaction manager and transaction mode.</span>
org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.transaction().transactionManagerLookup(RemoteTransactionManagerLookup.getInstance());
cb.transaction().transactionMode(TransactionMode.NON_XA);

RemoteCacheManager rcm = <span class="keyword">new</span> RemoteCacheManager(cb.build());

<span class="comment">//Override the transaction mode for the my-cache instance.</span>
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = rcm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span>, TransactionMode.NON_DURABLE_XA, <span class="predefined-constant">null</span>);

<span class="comment">//Return the transaction manager that the cache uses.</span>
TransactionManager tm = cache.getTransactionManager();

<span class="comment">//Perform a simple transaction.</span>
tm.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">K1 value is </span><span class="delimiter">&quot;</span></span> + cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>));
tm.commit();</code></pre> </div> </div> <div class="sect3"> <h4 id="client_intelligence"><a class="anchor" href="#client_intelligence"></a>2.7.1. Client Intelligence</h4> <div class="paragraph"> <p>Client intelligence refers to mechanisms the <code>HotRod</code> protocol provides for clients to locate and send requests to Infinispan servers.</p> </div> <div class="paragraph"> <div class="title">Basic intelligence</div> <p>Clients do not store any information about Infinispan clusters or key hash values.</p> </div> <div class="paragraph"> <div class="title">Topology-aware</div> <p>Clients receive and store information about Infinispan clusters. Clients maintain an internal mapping of the cluster topology that changes whenever servers join or leave clusters.</p> </div> <div class="paragraph"> <p>To receive a cluster topology, clients need the address (<code>IP:HOST</code>) of at least one Hot Rod server at startup. After the client connects to the server, Infinispan transmits the topology to the client. When servers join or leave the cluster, Infinispan transmits an updated topology to the client.</p> </div> <div class="paragraph"> <div class="title">Distribution-aware</div> <p>Clients are topology-aware and store consistent hash values for keys.</p> </div> <div class="paragraph"> <p>For example, take a <code>put(k,v)</code> operation. The client calculates the hash value for the key so it can locate the exact server on which the data resides. Clients can then connect directly to the owner to dispatch the operation.</p> </div> <div class="paragraph"> <p>The benefit of distribution-aware intelligence is that Infinispan servers do not need to look up values based on key hashes, which uses less resources on the server side. Another benefit is that servers respond to client requests more quickly because it skips additional network roundtrips.</p> </div> </div> <div class="sect3"> <h4 id="request_balancing"><a class="anchor" href="#request_balancing"></a>2.7.2. Request Balancing</h4> <div class="paragraph"> <p>Clients that use topology-aware intelligence use request balancing for all requests. The default balancing strategy is round-robin, so topology-aware clients always send requests to servers in round-robin order.</p> </div> <div class="paragraph"> <p>For example, <code>s1</code>, <code>s2</code>, <code>s3</code> are servers in a Infinispan cluster. Clients perform request balancing as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CacheContainer cacheContainer = <span class="keyword">new</span> RemoteCacheManager();
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheContainer.getCache();

<span class="comment">//client sends put request to s1</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>);
<span class="comment">//client sends put request to s2</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>);
<span class="comment">//client sends get request to s3</span>
<span class="predefined-type">String</span> value = cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>);
<span class="comment">//client dispatches to s1 again</span>
cache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>);
<span class="comment">//and so on...</span></code></pre> </div> </div> <div class="paragraph"> <p>Clients that use distribution-aware intelligence use request balancing only for failed requests. When requests fail, distribution-aware clients retry the request on the next available server.</p> </div> <div class="paragraph"> <div class="title">Custom balancing policies</div> <p>You can implement <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/FailoverRequestBalancingStrategy.html">FailoverRequestBalancingStrategy</a> and specify your class in your <code>hotrod-client.properties</code> configuration.</p> </div> </div> <div class="sect3"> <h4 id="persistent_connections"><a class="anchor" href="#persistent_connections"></a>2.7.3. Persistent connections</h4> <div class="paragraph"> <p>In order to avoid creating a TCP connection on each request (which is a costly operation), the client keeps a pool of persistent connections to all the available servers and it reuses these connections whenever it is possible. The validity of the connections is checked using an async thread that iterates over the connections in the pool and sends a HotRod ping command to the server. By using this connection validation process the client is being proactive: there&#8217;s a hight chance for broken connections to be found while being idle in the pool and no on actual request from the application.</p> </div> <div class="paragraph"> <p>The number of connections per server, total number of connections, how long should a connection be kept idle in the pool before being closed - all these (and more) can be configured. Please refer to the javadoc of <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> for a list of all possible configuration elements.</p> </div> </div> <div class="sect3"> <h4 id="hot_rod_marshalling_data"><a class="anchor" href="#hot_rod_marshalling_data"></a>2.7.4. Marshalling data</h4> <div class="paragraph"> <p>The Hot Rod client allows one to plug in a custom marshaller for transforming user objects into byte arrays and the other way around. This transformation is needed because of Hot Rod&#8217;s binary nature - it doesn&#8217;t know about objects.</p> </div> <div class="paragraph"> <p>The marshaller can be plugged through the "marshaller" configuration element (see Configuration section): the value should be the fully qualified name of a class implementing the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/marshall/Marshaller.html">Marshaller</a> interface. This is a optional parameter, if not specified it defaults to the <a href="#protostream">ProtoStreamMarshaller</a></p> </div> <div class="paragraph"> <div class="title">WARNING: If developing your own custom marshaller, take care of potential injection attacks.</div> <p>To avoid such attacks, make the marshaller verify that any class names read, before instantiating it, is amongst the expected/allowed class names.</p> </div> <div class="paragraph"> <p>The client configuration can be enhanced with a list of regular expressions for classes that are allowed to be read.</p> </div> <div class="paragraph"> <div class="title">WARNING: These checks are opt-in, so if not configured, any class can be read.</div> <p>In the example below, only classes with fully qualified names containing <code>Person</code> or <code>Employee</code> would be allowed:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</span>;

...
ConfigurationBuilder configBuilder = ...
configBuilder.addJavaSerialWhiteList(<span class="string"><span class="delimiter">&quot;</span><span class="content">.*Person.*</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">.*Employee.*</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="sect4"> <h5 id="protostream"><a class="anchor" href="#protostream"></a>ProtoStream</h5> <div class="paragraph"> <p>Since version 10.0, the default marshaller for the client is the Protobuf based <a href="#protostream">ProtoStreamMarshaller</a>. Keeping your objects stored in protobuf format has the benefit of being able to consume them with compatible clients written in different languages. To aid with the configuration of the marshaller&#8217;s SerializationContext, we have extended the client configuration to allow for SerializationContextInitializer(s) to be provided by the user and applied on RemoteCacheManager startup.</p> </div> <div class="paragraph"> <p>SerializationContextInitailizers can be configured as follows:</p> </div> <div class="ulist"> <ul> <li> <p>Via a comma-separated list of SerializationContextInitializer implementation&#8217;s in <code>hotrod-client.properties</code></p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">infinispan.client.hotrod.context-initializers=org.infinispan.example.LibraryInitializerImpl,org.infinispan.example.AnotherExampleSciImpl</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder()
      .addServer().host(<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>).port(hotRodServer.getPort())
      .addContextInitializers(<span class="keyword">new</span> LibraryInitializerImpl(), <span class="keyword">new</span> AnotherExampleSciImpl())
      .build();
RemoteCacheManager rcm = <span class="keyword">new</span> RemoteCacheManager(builder);</code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="reading_data_in_different_data_formats"><a class="anchor" href="#reading_data_in_different_data_formats"></a>2.7.5. Reading data in different data formats</h4> <div class="paragraph"> <p>By default, every Hot Rod client operation will use the configured marshaller when reading and writing from the server for both keys and values. See <a href="#hot_rod_marshalling_data">Marshalling Data</a>. Using the DataFormat API, it&#8217;s possible to decorate remote caches so that all operations can happen with a custom data format.</p> </div> <div class="sect4"> <h5 id="using_different_marshallers_for_key_and_values"><a class="anchor" href="#using_different_marshallers_for_key_and_values"></a>Using different marshallers for Key and Values</h5> <div class="paragraph"> <p>Marshallers for Keys and Values can be overridden at run time. For example, to bypass all serialization in the Hot Rod client and read the byte[] as they are stored in the server:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Existing Remote cache instance</span>
RemoteCache&lt;<span class="predefined-type">String</span>, Pojo&gt; remoteCache = ...

<span class="comment">// IdentityMarshaller is a no-op marshaller</span>
DataFormat rawKeyAndValues = DataFormat.builder().keyMarshaller(IdentityMarshaller.INSTANCE).valueMarshaller(IdentityMarshaller.INSTANCE).build();

<span class="comment">// Will create a new instance of RemoteCache with the supplied DataFormat</span>
RemoteCache&lt;<span class="type">byte</span><span class="type">[]</span>, <span class="type">byte</span><span class="type">[]</span>&gt; rawResultsCache = remoteCache.withDataFormat(rawKeyAndValues);</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="reading_data_in_different_formats"><a class="anchor" href="#reading_data_in_different_formats"></a>Reading data in different formats</h5> <div class="paragraph"> <p>Apart from defining custom key and value marshallers, it&#8217;s also possible to request/send data in different formats specified by a <code>org.infinispan.commons.dataconversion.MediaType</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Existing remote cache using ProtostreamMarshaller</span>
RemoteCache&lt;<span class="predefined-type">String</span>, Pojo&gt; protobufCache = ...

<span class="comment">// Request values returned as JSON, using the UTF8StringMarshaller that converts between UTF-8 to String:</span>
DataFormat jsonString = DataFormat.builder().valueType(MediaType.APPLICATION_JSON).valueMarshaller(<span class="keyword">new</span> UTF8StringMarshaller().build();

RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; jsonStrCache = remoteCache.withDataFormat(jsonString);

<span class="comment">// Alternativelly, it's possible to request JSON values but marshalled/unmarshalled with a custom value marshaller that returns `org.codehaus.jackson.JsonNode` objects:</span>
DataFormat jsonNode = DataFormat.builder().valueType(MediaType.APPLICATION_JSON).valueMarshaller(<span class="keyword">new</span> CustomJacksonMarshaller().build();

RemoteCache&lt;<span class="predefined-type">String</span>, JsonNode&gt; jsonNodeCache = remoteCache.withDataFormat(jsonNode);</code></pre> </div> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> The data conversions happen in the server, and if it doesn&#8217;t support converting from the storage format to the request format and vice versa, an error will be returned. </td> </tr> </table> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Using different marshallers and formats for the key, with <code>.keyMarshaller()</code> and <code>.keyType()</code> may interfere with the client intelligence routing mechanism, causing it contact the server that is not the owner of the key during Hot Rod operations. This will not result in errors but can result in extra hops inside the cluster to execute the operation. If performance is critical, make sure to use the keys in the format stored by the server. </td> </tr> </table> </div> </div> </div> <div class="sect3"> <h4 id="statistics"><a class="anchor" href="#statistics"></a>2.7.6. Statistics</h4> <div class="paragraph"> <p>Various server usage statistics can be obtained through the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> .stats() method. This returns a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/ServerStatistics.html">ServerStatistics</a> object - please refer to javadoc for details on the available statistics.</p> </div> </div> <div class="sect3"> <h4 id="multi_get_operations"><a class="anchor" href="#multi_get_operations"></a>2.7.7. Multi-Get Operations</h4> <div class="paragraph"> <p>The Java Hot Rod client does not provide multi-get functionality out of the box but clients can build it themselves with the given APIs.</p> </div> </div> <div class="sect3"> <h4 id="server_hotrod_failover"><a class="anchor" href="#server_hotrod_failover"></a>2.7.8. Failover capabilities</h4> <div class="paragraph"> <p>Hot Rod clients' capabilities to keep up with topology changes helps with request balancing and more importantly, with the ability to failover operations if one or several of the servers fail.</p> </div> <div class="paragraph"> <p>Some of the conditional operations mentioned above, including <code>putIfAbsent</code>, <code>replace</code> with and without version, and conditional <code>remove</code> have strict method return guarantees, as well as those operations where returning the previous value is forced.</p> </div> <div class="paragraph"> <p>In spite of failures, these methods return values need to be guaranteed, and in order to do so, it&#8217;s necessary that these methods are not applied partially in the cluster in the event of failure. For example, imagine a <code>replace()</code> operation called in a server for key=k1 with <code>Flag.FORCE_RETURN_VALUE</code>, whose current value is <code>A</code> and the replace wants to set it to <code>B</code>. If the replace fails, it could happen that some servers contain <code>B</code> and others contain <code>A</code>, and during the failover, the original <code>replace()</code> could end up returning <code>B</code>, if the replace failovers to a node where <code>B</code> is set, or could end up returning <code>A</code>.</p> </div> <div class="paragraph"> <p>To avoid this kind of situations, whenever Java Hot Rod client users want to use conditional operations, or operations whose previous value is required, it&#8217;s important that the cache is configured to be transactional in order to avoid incorrect conditional operations or return values.</p> </div> </div> <div class="sect3"> <h4 id="site_cluster_failover"><a class="anchor" href="#site_cluster_failover"></a>2.7.9. Site Cluster Failover</h4> <div class="paragraph"> <p>On top of the in-cluster failover, Hot Rod clients are also able to failover to different clusters, which could be represented as an independent site.</p> </div> <div class="paragraph"> <p>The way site cluster failover works is that if all the main cluster nodes are not available, the client checks to see if any other clusters have been defined in which cases it tries to failover to the alternative cluster. If the failover succeeds, the client will remain connected to the alternative cluster until this becomes unavailable, in which case it&#8217;ll try any other clusters defined, and ultimately, it&#8217;ll try the original server settings.</p> </div> <div class="paragraph"> <p>To configure a cluster in the Hot Rod client, one host/port pair details must be provided for each of the clusters configured. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb
      = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.addCluster().addClusterNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cluster-host</span><span class="delimiter">&quot;</span></span>, <span class="integer">11222</span>);
RemoteCacheManager rmc = <span class="keyword">new</span> RemoteCacheManager(cb.build());</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Remember that regardless of the cluster definitions, the initial server(s) configuration must be provided unless the initial servers can be resolved using the default server host and port details. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="manual_site_cluster_switch"><a class="anchor" href="#manual_site_cluster_switch"></a>2.7.10. Manual Site Cluster Switch</h4> <div class="paragraph"> <p>As well as supporting automatic site cluster failover, Java Hot Rod clients can also switch between site clusters manually by calling RemoteCacheManager&#8217;s <code>switchToCluster(clusterName)</code> and <code>switchToDefaultCluster()</code>.</p> </div> <div class="paragraph"> <p>Using <code>switchToCluster(clusterName)</code>, users can force a client to switch to one of the clusters pre-defined in the Hot Rod client configuration. To switch to the initial servers defined in the client configuration, call <code>switchToDefaultCluster()</code>.</p> </div> </div> <div class="sect3"> <h4 id="hotrod_java_client_monitoring"><a class="anchor" href="#hotrod_java_client_monitoring"></a>2.7.11. Monitoring the Hot Rod client</h4> <div class="paragraph"> <p>The Hot Rod client can be monitored and managed via JMX. By enabling statistics, an MBean will be registered for the <code>RemoteCacheManager</code> as well as for each <code>RemoteCache</code> obtained through it. Through these MBeans it is possible to obtain statistics about remote and near-cache hits/misses and connection pool usage.</p> </div> </div> <div class="sect3"> <h4 id="concurrent_updates"><a class="anchor" href="#concurrent_updates"></a>2.7.12. Concurrent Updates</h4> <div class="paragraph"> <p>Data structures, such as Infinispan <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html">Cache</a> , that are accessed and modified concurrently can suffer from data consistency issues unless there&#8217;re mechanisms to guarantee data correctness. Infinispan Cache, since it implements <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">ConcurrentMap</a> , provides operations such as <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#replace-K-V-V-">conditional replace</a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#putIfAbsent-K-V-">putIfAbsent</a> , and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#remove-java.lang.Object-java.lang.Object-">conditional remove</a> to its clients in order to guarantee data correctness. It even allows clients to operate against cache instances within JTA transactions, hence providing the necessary data consistency guarantees.</p> </div> <div class="paragraph"> <p>However, when it comes to Hot Rod protocol backed servers, clients do not yet have the ability to start remote transactions but they can call instead versioned operations to mimic the conditional methods provided by the embedded Infinispan cache instance API. Let&#8217;s look at a real example to understand how it works.</p> </div> <div class="sect4"> <h5 id="data_consistency_problem"><a class="anchor" href="#data_consistency_problem"></a>Data Consistency Problem</h5> <div class="paragraph"> <p>Imagine you have two ATMs that connect using Hot Rod to a bank where an account&#8217;s balance is stored. Two closely followed operations to retrieve the latest balance could return 500 CHF (swiss francs) as shown below:</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./../../topics/images/server_modules_6.png" alt="server modules 6"> </div> <div class="title">Figure 2. Concurrent readers</div> </div> <div class="paragraph"> <p>Next a customer connects to the first ATM and requests 400 CHF to be retrieved. Based on the last value read, the ATM could calculate what the new balance is, which is 100 CHF, and request a put with this new value. Let&#8217;s imagine now that around the same time another customer connects to the ATM and requests 200 CHF to be retrieved. Let&#8217;s assume that the ATM thinks it has the latest balance and based on its calculations it sets the new balance to 300 CHF:</p> </div> <div class="imageblock"> <div class="content"> <img src="./../../topics/images/server_modules_7.png" alt="Concurrent updates"> </div> </div> <div class="paragraph"> <p>Obviously, this would be wrong. Two concurrent updates have resulted in an incorrect account balance. The second update should not have been allowed since the balance the second ATM had was incorrect. Even if the ATM would have retrieved the balance before calculating the new balance, someone could have updated between the new balance being retrieved and the update. Before finding out how to solve this issue in a client-server scenario with Hot Rod, let&#8217;s look at how this is solved when Infinispan clients run in peer-to-peer mode where clients and Infinispan live within the same JVM.</p> </div> </div> <div class="sect4"> <h5 id="embedded_mode_solution"><a class="anchor" href="#embedded_mode_solution"></a>Embedded-mode Solution</h5> <div class="paragraph"> <p>If the ATM and the Infinispan instance storing the bank account lived in the same JVM, the ATM could use the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#replace-K-V-V-">conditional replace API</a> referred at the beginning of this article. So, it could send the previous known value to verify whether it has changed since it was last read. By doing so, the first operation could double check that the balance is still 500 CHF when it was to update to 100 CHF. Now, when the second operation comes, the current balance would not be 500 CHF any more and hence the conditional replace call would fail, hence avoiding data consistency issues:</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./../../topics/images/server_modules_8.png" alt="server modules 8"> </div> <div class="title">Figure 3. P2P solution</div> </div> </div> <div class="sect4"> <h5 id="client_server_solution"><a class="anchor" href="#client_server_solution"></a>Client-Server Solution</h5> <div class="paragraph"> <p>In theory, Hot Rod could use the same p2p solution but sending the previous value would be not practical. In this example, the previous value is just an integer but the value could be a lot bigger and hence forcing clients to send it to the server would be rather wasteful. Instead, Hot Rod offers versioned operations to deal with this situation.</p> </div> <div class="paragraph"> <p>Basically, together with each key/value pair, Hot Rod stores a version number which uniquely identifies each modification. So, using an operation called getVersioned or getWithVersion, clients can retrieve not only the value associated with a key, but also the current version. So, if we look at the previous example once again, the ATMs could call getVersioned and get the balance&#8217;s version:</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./../../topics/images/server_modules_9.png" alt="server modules 9"> </div> <div class="title">Figure 4. Get versioned</div> </div> <div class="paragraph"> <p>When the ATMs wanted to modify the balance, instead of just calling put, they could call replaceIfUnmodified operation passing the latest version number of which the clients are aware of. The operation will only succeed if the version passed matches the version in the server. So, the first modification by the ATM would be allowed since the client passes 1 as version and the server side version for the balance is also 1. On the other hand, the second ATM would not be able to make the modification because after the first ATMs modification the version would have been incremented to 2, and now the passed version (1) and the server side version (2) would not match:</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./../../topics/images/server_modules_10.png" alt="server modules 10"> </div> <div class="title">Figure 5. Replace if versions match</div> </div> </div> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2019-10-27 08:15:43 UTC </div> </div> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script> <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script> </body> </html>