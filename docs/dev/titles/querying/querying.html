<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="generator" content="Asciidoctor 1.5.8"> <title>Indexing and Querying with Infinispan 10.0</title> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"> <style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> <style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style> <link rel="canonical" href="http://infinispan.org/docs/stable/user_guide/user_guide.html"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css"> <link rel="stylesheet" href="../../css/css.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script> <script src="../../js/js.js"></script> </head> <body class="book toc2 toc-left"> <div id="header"> <h1>Indexing and Querying with Infinispan 10.0</h1> <div id="toc" class="toc2"> <div id="toctitle">Table of Contents</div> <ul class="sectlevel1"> <li><a href="#indexing_querying">1. Indexing and Querying</a> <ul class="sectlevel2"> <li><a href="#overview">1.1. Overview</a></li> <li><a href="#query_library">1.2. Embedded Querying</a> <ul class="sectlevel3"> <li><a href="#quick_example">1.2.1. Quick example</a></li> <li><a href="#indexing">1.2.2. Indexing</a> <ul class="sectlevel4"> <li><a href="#configuration">Configuration</a> <ul class="sectlevel5"> <li><a href="#general_format">General format</a></li> <li><a href="#index_names">Index names</a></li> <li><a href="#specifying_indexed_entities">Specifying indexed Entities</a></li> </ul> </li> <li><a href="#query_index_mode">Index mode</a></li> <li><a href="#query_index_manager">Index Managers</a></li> <li><a href="#query_shared_index">Shared indexes</a> <ul class="sectlevel5"> <li><a href="#effect_of_the_index_mode">Effect of the index mode</a></li> <li><a href="#infinispanindexmanager">InfinispanIndexManager</a></li> <li><a href="#query_affinity_index_manager">AffinityIndexManager</a></li> </ul> </li> <li><a href="#query_non_shared_index">Non-shared indexes</a> <ul class="sectlevel5"> <li><a href="#effect_of_the_index_mode_2">Effect of the index mode</a></li> <li><a href="#query_directory_based">directory-based index manager</a></li> <li><a href="#near_real_time_index_manager">near-real-time index manager</a></li> </ul> </li> <li><a href="#external_indexes">External indexes</a> <ul class="sectlevel5"> <li><a href="#elasticsearch_indexmanager_experimental">Elasticsearch IndexManager (experimental)</a></li> </ul> </li> <li><a href="#query_autoconfig">Automatic configuration</a></li> <li><a href="#query_massindexer">Re-indexing</a></li> <li><a href="#query_indexless">Indexless</a></li> <li><a href="#query_hybrid">Hybrid</a></li> <li><a href="#mapping_entities">Mapping Entities</a> <ul class="sectlevel5"> <li><a href="#documentid">@DocumentId</a></li> <li><a href="#transformable_keys">@Transformable keys</a></li> <li><a href="#query_configuration_api">Programmatic mapping</a></li> </ul> </li> </ul> </li> <li><a href="#query_apis">1.2.3. Querying APIs</a> <ul class="sectlevel4"> <li><a href="#query_hibernatesearch">Hibernate Search</a> <ul class="sectlevel5"> <li><a href="#running_lucene_queries">Running Lucene queries</a></li> <li><a href="#using_the_hibernate_search_dsl">Using the Hibernate Search DSL</a></li> <li><a href="#faceted_search">Faceted Search</a></li> <li><a href="#query_spatial">Spatial Queries</a></li> <li><a href="#query_clustered_query_api">IndexedQueryMode</a></li> </ul> </li> <li><a href="#query_dsl">Infinispan Query DSL</a> <ul class="sectlevel5"> <li><a href="#filtering_operators">Filtering operators</a></li> <li><a href="#filtering_based_on_attributes_of_embedded_entities">Filtering based on attributes of embedded entities</a></li> <li><a href="#boolean_conditions">Boolean conditions</a></li> <li><a href="#nested_conditions">Nested conditions</a></li> <li><a href="#projections">Projections</a></li> <li><a href="#sorting">Sorting</a></li> <li><a href="#pagination">Pagination</a></li> <li><a href="#grouping_and_aggregation">Grouping and Aggregation</a></li> <li><a href="#aggregations">Aggregations</a></li> <li><a href="#evaluation_of_queries_with_grouping_and_aggregation">Evaluation of queries with grouping and aggregation</a></li> <li><a href="#using_named_query_parameters">Using Named Query Parameters</a></li> <li><a href="#more_query_dsl_samples">More Query DSL samples</a></li> </ul> </li> <li><a href="#query_ickle">Ickle</a> <ul class="sectlevel5"> <li><a href="#ickle_query_language_parser_syntax">Ickle Query Language Parser Syntax</a></li> <li><a href="#fuzzy_queries">Fuzzy Queries</a></li> <li><a href="#range_queries">Range Queries</a></li> <li><a href="#phrase_queries">Phrase Queries</a></li> <li><a href="#proximity_queries">Proximity Queries</a></li> <li><a href="#wildcard_queries">Wildcard Queries</a></li> <li><a href="#regular_expression_queries">Regular Expression Queries</a></li> <li><a href="#boosting_queries">Boosting Queries</a></li> </ul> </li> <li><a href="#query_continuous">Continuous Query</a> <ul class="sectlevel5"> <li><a href="#continuous_query_execution">Continuous Query Execution</a></li> <li><a href="#running_continuous_queries">Running Continuous Queries</a></li> <li><a href="#removing_continuous_queries">Removing Continuous Queries</a></li> <li><a href="#notes_on_performance_of_continuous_queries">Notes on performance of Continuous Queries</a></li> </ul> </li> </ul> </li> </ul> </li> <li><a href="#query_remote">1.3. Remote Querying</a> <ul class="sectlevel3"> <li><a href="#storing_protobuf">1.3.1. Storing Protobuf encoded entities</a></li> <li><a href="#using_annotations">1.3.2. Using annotations</a></li> <li><a href="#indexing_of_protobuf_encoded_entries">1.3.3. Indexing of Protobuf encoded entries</a></li> <li><a href="#a_remote_query_example">1.3.4. A remote query example</a></li> <li><a href="#analysis">1.3.5. Analysis</a> <ul class="sectlevel4"> <li><a href="#default_analyzers">Default Analyzers</a></li> <li><a href="#using_analyzer_definitions">Using Analyzer Definitions</a></li> <li><a href="#creating_custom_analyzer_definitions">Creating Custom Analyzer Definitions</a></li> </ul> </li> </ul> </li> <li><a href="#statistics">1.4. Statistics</a></li> <li><a href="#query_performance">1.5. Performance Tuning</a> <ul class="sectlevel3"> <li><a href="#batch_writing_in_sync_mode">1.5.1. Batch writing in SYNC mode</a></li> <li><a href="#writing_using_async_mode">1.5.2. Writing using async mode</a></li> <li><a href="#index_reader_async_strategy">1.5.3. Index reader async strategy</a></li> <li><a href="#lucene_options">1.5.4. Lucene Options</a></li> </ul> </li> </ul> </li> </ul> </div> </div> <div id="content"> <div class="sect1"> <h2 id="indexing_querying"><a class="anchor" href="#indexing_querying"></a>1. Indexing and Querying</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="overview"><a class="anchor" href="#overview"></a>1.1. Overview</h3> <div class="paragraph"> <p>Infinispan supports indexing and searching of Java Pojo(s) or objects encoded via <a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a> stored in the grid using powerful search APIs which complement its main Map-like API.</p> </div> <div class="paragraph"> <p>Querying is possible both in <a href="#query_library">library</a> and <a href="#query_remote">client/server mode</a> (for Java, C#, Node.js and other clients), and Infinispan can index data using <a href="http://lucene.apache.org/">Apache Lucene</a>, offering an efficient <a href="https://en.wikipedia.org/wiki/Full-text_search">full-text</a> capable search engine in order to cover a wide range of data retrieval use cases.</p> </div> <div class="paragraph"> <p>Indexing configuration relies on a schema definition, and for that Infinispan can use annotated Java classes when in library mode, and protobuf schemas for remote clients written in other languages. By standardizing on protobuf, Infinispan allows full interoperability between Java and non-Java clients.</p> </div> <div class="paragraph"> <p>Apart from indexed queries, Infinispan can run queries over non-indexed data (<a href="#query_indexless">indexless queries</a>) and over partially indexed data (<a href="#query_hybrid">hybrid queries</a>).</p> </div> <div class="paragraph"> <p>In terms of Search APIs, Infinispan has its own query language called <em><a href="#query_ickle">Ickle</a></em>, which is string-based and adds support for full-text querying. The <a href="#query_dsl">Query DSL</a> can be used for both embedded and remote java clients when full-text is not required; for Java embedded clients Infinispan offers the <a href="#query_hibernatesearch">Hibernate Search Query API</a> which supports running Lucene queries in the grid, apart from advanced search capabilities like Faceted and Spatial search.</p> </div> <div class="paragraph"> <p>Finally, Infinispan has support for <a href="#query_continuous">Continuous Queries</a>, which works in a reverse manner to the other APIs: instead of creating, executing a query and obtain results, it allows a client to register queries that will be evaluated continuously as data in the cluster changes, generating notifications whenever the changed data matches the queries.</p> </div> </div> <div class="sect2"> <h3 id="query_library"><a class="anchor" href="#query_library"></a>1.2. Embedded Querying</h3> <div class="paragraph"> <p>Embedded querying is available when Infinispan is used as a library. No protobuf mapping is required, and both indexing and searching are done on top of Java objects. When in library mode, it is possible to run Lucene queries directly and use all the available <a href="#query_apis">Query APIs</a> and it also allows flexible indexing configurations to keep latency to a minimal.</p> </div> <div class="sect3"> <h4 id="quick_example"><a class="anchor" href="#quick_example"></a>1.2.1. Quick example</h4> <div class="paragraph"> <p>We&#8217;re going to store <em>Book</em> instances in an Infinispan cache called "books". <em>Book</em> instances will be indexed, so we enable indexing for the cache, letting Infinispan <a href="#query_autoconfig">configure the indexing automatically</a>:</p> </div> <div class="paragraph"> <p>Infinispan configuration:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
    <span class="tag">&lt;cache-container&gt;</span>
        <span class="tag">&lt;transport</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-cluster</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-config</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/distributed-cache&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Obtaining the cache:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.Cache</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.manager.DefaultCacheManager</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.manager.EmbeddedCacheManager</span>;

EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.xml</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Book</span>&gt; cache = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Each <em>Book</em> will be defined as in the following example; we have to choose which properties are indexed, and for each property we can optionally choose advanced indexing options using the annotations defined in the Hibernate Search project.</p> </div> <div class="listingblock"> <div class="title">Book.java</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.hibernate.search.annotations</span>.*;
<span class="keyword">import</span> <span class="include">java.util.Date</span>;
<span class="keyword">import</span> <span class="include">java.util.HashSet</span>;
<span class="keyword">import</span> <span class="include">java.util.Set</span>;

<span class="comment">//Values you want to index need to be annotated with @Indexed, then you pick which fields and how they are to be indexed:</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> title;
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> description;
   <span class="annotation">@Field</span> <span class="annotation">@DateBridge</span>(resolution=Resolution.YEAR) <span class="predefined-type">Date</span> publicationYear;
   <span class="annotation">@IndexedEmbedded</span> <span class="predefined-type">Set</span>&lt;Author&gt; authors = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;Author&gt;();
}</code></pre> </div> </div> <div class="listingblock"> <div class="title">Author.java</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> name;
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> surname;
   <span class="comment">// hashCode() and equals() omitted</span>
}</code></pre> </div> </div> <div class="paragraph"> <p>Now assuming we stored several <em>Book</em> instances in our Infinispan <em>Cache</em> , we can search them for any matching field as in the following example.</p> </div> <div class="paragraph"> <p>Using a Lucene Query:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// get the search manager from the cache:</span>
SearchManager searchManager = org.infinispan.query.Search.getSearchManager(cache);

<span class="comment">// create any standard Lucene query, via Lucene's QueryParser or any other means:</span>
org.apache.lucene.search.Query fullTextQuery = <span class="comment">//any Apache Lucene Query</span>

<span class="comment">// convert the Lucene query to a CacheQuery:</span>
CacheQuery cacheQuery = searchManager.getQuery( fullTextQuery );

<span class="comment">// get the results:</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Object</span>&gt; found = cacheQuery.list();</code></pre> </div> </div> <div class="paragraph"> <p>A Lucene Query is often created by parsing a query in text format such as "title:infinispan AND authors.name:sanne", or by using the query builder provided by Hibernate Search.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// get the search manager from the cache:</span>
SearchManager searchManager = org.infinispan.query.Search.getSearchManager( cache );

<span class="comment">// you could make the queries via Lucene APIs, or use some helpers:</span>
QueryBuilder queryBuilder = searchManager.buildQueryBuilderForClass(<span class="predefined-type">Book</span>.class).get();

<span class="comment">// the queryBuilder has a nice fluent API which guides you through all options.</span>
<span class="comment">// this has some knowledge about your object, for example which Analyzers</span>
<span class="comment">// need to be applied, but the output is a fairly standard Lucene Query.</span>
org.apache.lucene.search.Query luceneQuery = queryBuilder.phrase()
                  .onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>)
                  .andField(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>)
                  .sentence(<span class="string"><span class="delimiter">&quot;</span><span class="content">a book on highly scalable query engines</span><span class="delimiter">&quot;</span></span>)
                  .createQuery();

<span class="comment">// the query API itself accepts any Lucene Query, and on top of that</span>
<span class="comment">// you can restrict the result to selected class types:</span>
CacheQuery query = searchManager.getQuery(luceneQuery, <span class="predefined-type">Book</span>.class);

<span class="comment">// and there are your results!</span>
<span class="predefined-type">List</span> objectList = query.list();

<span class="keyword">for</span> (<span class="predefined-type">Object</span> book : objectList) {
      <span class="predefined-type">System</span>.out.println(book);
}</code></pre> </div> </div> <div class="paragraph"> <p>Apart from <em>list()</em> you have the option for streaming results, or use pagination.</p> </div> <div class="paragraph"> <p>For searches that do not require Lucene or full-text capabilities and are mostly about aggregation and exact matches, we can use the Infinispan Query DSL API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.QueryFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.Query</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;

<span class="comment">// get the query factory:</span>
QueryFactory queryFactory = Search.getQueryFactory(cache);

<span class="predefined-type">Query</span> q = queryFactory.from(<span class="predefined-type">Book</span>.class)
            .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.surname</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">King</span><span class="delimiter">&quot;</span></span>)
            .build();

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; list = q.list();</code></pre> </div> </div> <div class="paragraph"> <p>Finally, we can use an <a href="#query_ickle">Ickle</a> query directly, allowing for Lucene syntax in one or more predicates:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.QueryFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.Query</span>;

<span class="comment">// get the query factory:</span>
QueryFactory queryFactory = Search.getQueryFactory(cache);


<span class="predefined-type">Query</span> q = queryFactory.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from Book b where b.author.name = 'Stephen' and </span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content">b.description : (+'dark' -'tower')</span><span class="delimiter">&quot;</span></span>);

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; list = q.list();</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="indexing"><a class="anchor" href="#indexing"></a>1.2.2. Indexing</h4> <div class="paragraph"> <p>Indexing in Infinispan happens on a per-cache basis and by default a cache is not indexed. Enabling indexing is not mandatory but queries using an index will have a vastly superior performance. On the other hand, enabling indexing can impact negatively the write throughput of a cluster, so make sure to check the <a href="#query_performance">query performance guide</a> for some strategies to minimize this impact depending on the cache type and use case.</p> </div> <div class="sect4"> <h5 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h5> <div class="sect5"> <h6 id="general_format"><a class="anchor" href="#general_format"></a>General format</h6> <div class="paragraph"> <p>To enable indexing via XML, you need to add the <code>&lt;indexing&gt;</code> element plus the <code>index</code> (<a href="#query_index_mode">index mode</a>) to your cache configuration, and optionally pass additional properties.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">property.name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>some value<span class="tag">&lt;/property&gt;</span>
         <span class="tag">&lt;/indexing&gt;</span>
      <span class="tag">&lt;/replicated-cache&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Programmatic:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache</span>.*;

ConfigurationBuilder cacheCfg = ...
cacheCfg.indexing().index(Index.ALL)
      .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">property name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">propery value</span><span class="delimiter">&quot;</span></span>)</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="index_names"><a class="anchor" href="#index_names"></a>Index names</h6> <div class="paragraph"> <p>Each property inside the <code>index</code> element is prefixed with the index name, for the index named <code>org.infinispan.sample.Car</code> the <code>directory_provider</code> is <code>local-heap</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">    ...
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.sample.Car.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>local-heap<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
    ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">cacheCfg.indexing()
   .index(Index.ALL)
      .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.sample.Car.directory_provider</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">local-heap</span><span class="delimiter">&quot;</span></span>)</code></pre> </div> </div> <div class="paragraph"> <p>Infinispan creates an index for each entity existent in a cache, and it allows to configure those indexes independently. For a class annotated with <code>@Indexed</code>, the index name is the fully qualified class name, unless overridden with the <code>name</code> argument in the annotation.</p> </div> <div class="paragraph"> <p>In the snippet below, the default storage for all entities is <code>infinispan</code>, but <code>Boat</code> instances will be stored on <code>local-heap</code> in an index named <code>boatIndex</code>. <code>Airplane</code> entities will also be stored in <code>local-heap</code>. Any other entity&#8217;s index will be configured with the property prefixed by <code>default</code>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.infinispan.sample</span>;

<span class="annotation">@Indexed</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">boatIndex</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Boat</span> {

}

<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Airplane</span> {

}</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">    ...
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>infinispan<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">boatIndex.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>local-heap<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.sample.Airplane.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ram
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
    ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> </div> <div class="sect5"> <h6 id="specifying_indexed_entities"><a class="anchor" href="#specifying_indexed_entities"></a>Specifying indexed Entities</h6> <div class="paragraph"> <p>Infinispan can automatically recognize and manage indexes for different entity types in a cache. Future versions of Infinispan will remove this capability so it&#8217;s recommended to declare upfront which types are going to be indexed (list them by their fully qualified class name). This can be done via xml:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;indexed-entities&gt;</span>
                <span class="tag">&lt;indexed-entity&gt;</span>com.acme.query.test.Car<span class="tag">&lt;/indexed-entity&gt;</span>
                <span class="tag">&lt;indexed-entity&gt;</span>com.acme.query.test.Truck<span class="tag">&lt;/indexed-entity&gt;</span>
            <span class="tag">&lt;/indexed-entities&gt;</span>
         <span class="tag">&lt;/indexing&gt;</span>
      <span class="tag">&lt;/replicated-cache&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>or programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"> cacheCfg.indexing()
      .index(Index.ALL)
       .addIndexedEntity(Car.class)
       .addIndexedEntity(Truck.class)</code></pre> </div> </div> <div class="paragraph"> <p>In server mode, the class names listed under the 'indexed-entities' element must use the 'extended' class name format which is composed of a JBoss Modules module identifier, a slot name, and the fully qualified class name, these three components being separated by the ':' character, (eg. "com.acme.my-module-with-entity-classes:my-slot:com.acme.query.test.Car"). The entity classes must be located in the referenced module, which can be either a user supplied module deployed in the 'modules' folder of your server or a plain jar deployed in the 'deployments' folder. The module in question will become an automatic dependency of your Cache, so its eventual redeployment will cause the cache to be restarted.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Only for server, if you fail to follow the requirement of using 'extended' class names and use a plain class name its resolution will fail due to missing class because the wrong ClassLoader is being used (the Infinispan&#8217;s internal class path is being used). </td> </tr> </table> </div> </div> </div> <div class="sect4"> <h5 id="query_index_mode"><a class="anchor" href="#query_index_mode"></a>Index mode</h5> <div class="paragraph"> <p>An Infinispan node typically receives data from two sources: local and remote. Local translates to clients manipulating data using the map API in the same JVM; remote data comes from other Infinispan nodes during replication or rebalancing.</p> </div> <div class="paragraph"> <p>The index mode configuration defines, from a node in the cluster point of view, which data gets indexed.</p> </div> <div class="paragraph"> <p>Possible values:</p> </div> <div class="ulist"> <ul> <li> <p>ALL: all data is indexed, local and remote.</p> </li> <li> <p>LOCAL: only local data is indexed.</p> </li> <li> <p>PRIMARY_OWNER: Only entries containing keys that the node is primary owner will be indexed, regardless of local or remote origin.</p> </li> <li> <p>NONE: no data is indexed. Equivalent to not configure indexing at all.</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="query_index_manager"><a class="anchor" href="#query_index_manager"></a>Index Managers</h5> <div class="paragraph"> <p>Index managers are central components in Infinispan Querying responsible for the indexing configuration, distribution and internal lifecycle of several query components such as Lucene&#8217;s <em>IndexReader</em> and <em>IndexWriter</em>. Each Index Manager is associated with a <em>Directory Provider</em>, which defines the physical storage of the index.</p> </div> <div class="paragraph"> <p>Regarding index distribution, Infinispan can be configured with shared or non-shared indexes.</p> </div> </div> <div class="sect4"> <h5 id="query_shared_index"><a class="anchor" href="#query_shared_index"></a>Shared indexes</h5> <div class="paragraph"> <p>A shared index is a single, distributed, cluster-wide index for a certain cache. The main advantage is that the index is visible from every node and can be queried as if the index were local, there is no need to <a href="#query_clustered_query_api">broadcast</a> queries to all members and aggregate the results. The downside is that Lucene does not allow more than a single process writing to the index at the same time, and the coordination of lock acquisitions needs to be done by a proper shared index capable index manager. In any case, having a single write lock cluster-wise can lead to some degree of contention under heavy writing.</p> </div> <div class="paragraph"> <p>Infinispan supports shared indexes leveraging the Infinispan Directory Provider, which stores indexes in a separate set of caches. Two index managers are available to use shared indexes: InfinispanIndexManager and AffinityIndexManager.</p> </div> <div class="sect5"> <h6 id="effect_of_the_index_mode"><a class="anchor" href="#effect_of_the_index_mode"></a>Effect of the index mode</h6> <div class="paragraph"> <p>Shared indexes should not use the <code>ALL</code> index mode since it&#8217;d lead to redundant indexing: since there is a single index cluster wide, the entry would get indexed when inserted via Cache API, and another time when Infinispan replicates it to another node. The <code>ALL</code> mode is usually associates with <a href="#query_non_shared_index">non-shared indexes</a> in order to create full index replicas on each node.</p> </div> </div> <div class="sect5"> <h6 id="infinispanindexmanager"><a class="anchor" href="#infinispanindexmanager"></a>InfinispanIndexManager</h6> <div class="paragraph"> <p>This index manager uses the Infinispan Directory Provider, and is suitable for creating shared indexes. Index mode should be set to <code>LOCAL</code> in this configuration.</p> </div> <div class="paragraph"> <p>Configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            org.infinispan.query.indexmanager.InfinispanIndexManager
        <span class="tag">&lt;/property&gt;</span>
        <span class="comment">&lt;!-- optional: tailor each index cache --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.locking_cachename</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>LuceneIndexesLocking_custom<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.data_cachename</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>LuceneIndexesData_custom<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.metadata_cachename</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>LuceneIndexesMetadata_custom<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span>

<span class="comment">&lt;!-- Optional --&gt;</span>
<span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesLocking_custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;--</span> <span class="attribute-name">extra</span> <span class="attribute-name">configuration</span> <span class="attribute-name">--</span><span class="tag">&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span>

<span class="comment">&lt;!-- Optional --&gt;</span>
<span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesMetadata_custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;--</span> <span class="attribute-name">extra</span> <span class="attribute-name">configuration</span> <span class="attribute-name">--</span><span class="tag">&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span>

<span class="comment">&lt;!-- Optional --&gt;</span>
<span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesData_custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;--</span> <span class="attribute-name">extra</span> <span class="attribute-name">configuration</span> <span class="attribute-name">--</span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Indexes are stored in a set of clustered caches, called by default <em>LuceneIndexesData</em>, <em>LuceneIndexesMetadata</em> and <em>LuceneIndexesLocking</em>.</p> </div> <div class="paragraph"> <p>The <em>LuceneIndexesLocking</em> cache is used to store Lucene locks, and it is a very small cache: it will contain one entry per entity (index).</p> </div> <div class="paragraph"> <p>The <em>LuceneIndexesMetadata</em> cache is used to store info about the logical files that are part of the index, such as names, chunks and sizes and it is also small in size.</p> </div> <div class="paragraph"> <p>The <em>LuceneIndexesData</em> cache is where most of the index is located: it is much bigger then the other two but should be smaller than the data in the cache itself, thanks to Lucene&#8217;s efficient storing techniques.</p> </div> <div class="paragraph"> <p>It&#8217;s not necessary to redefine the configuration of those 3 cases, Infinispan will pick sensible defaults. Reasons re-define them would be performance tuning for a specific scenario, or for example to make them persistent by configuring a cache store.</p> </div> <div class="paragraph"> <p>In order to avoid index corruption when two or more nodes of the cluster try to write to the index at the same time, the <em>InfinispanIndexManager</em> internally elects a master in the cluster (which is the JGroups coordinator) and forwards all indexing works to this master.</p> </div> </div> <div class="sect5"> <h6 id="query_affinity_index_manager"><a class="anchor" href="#query_affinity_index_manager"></a>AffinityIndexManager</h6> <div class="paragraph"> <p>The AffinityIndexManager is an <strong>experimental</strong> index manager used for shared indexes that also stores indexes using the Infinispan Directory Provider. Unlike the InfinispanIndexManager, it does not have a single node (master) that handles all the indexing cluster wide, but rather splits the index using multiple shards, each shard being responsible for indexing data associated with one or more Infinispan segments. For an in-depth description of the inner workings, please see the <a href="https://github.com/infinispan/infinispan/wiki/Index-affinity-proposal">design doc</a>.</p> </div> <div class="paragraph"> <p>The PRIMARY_OWNER index mode is required, together with a special kind of <code>KeyPartitioner</code>.</p> </div> <div class="paragraph"> <p>XML Configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">key-partitioner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.distribution.ch.impl.AffinityPartitioner</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PRIMARY_OWNER</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            org.infinispan.query.affinity.AffinityIndexManager
        <span class="tag">&lt;/property&gt;</span>
        <span class="comment">&lt;!-- optional: control the number of shards, the default is 4 --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.sharding_strategy.nbr_of_shards</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>10<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Programmatic:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.distribution.ch.impl.AffinityPartitioner</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.affinity.AffinityIndexManager</span>;

ConfigurationBuilder cacheCfg = ...
cacheCfg.clustering().hash().keyPartitioner(<span class="keyword">new</span> AffinityPartitioner());
cacheCfg.indexing()
      .index(Index.PRIMARY_OWNER)
      .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span>, AffinityIndexManager.class.getName())
      .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">default.sharding_strategy.nbr_of_shards</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>)</code></pre> </div> </div> <div class="paragraph"> <p>The <code>AffinityIndexManager</code> by default will have as many shards as Infinispan segments, but this value is configurable as seen in the example above.</p> </div> <div class="paragraph"> <p>The number of shards affects directly the query performance and writing throughput: generally speaking, a high number of shards offers better write throughput but has an adverse effect on query performance.</p> </div> </div> </div> <div class="sect4"> <h5 id="query_non_shared_index"><a class="anchor" href="#query_non_shared_index"></a>Non-shared indexes</h5> <div class="paragraph"> <p>Non-shared indexes are independent indexes at each node. This setup is particularly advantageous for replicated caches where each node has all the cluster data and thus can hold all the indexes as well, offering optimal query performance with zero network latency when querying. Another advantage is, since the index is local to each node, there is less contention during writes due to the fact that each node is subjected to its own index lock, not a cluster wide one.</p> </div> <div class="paragraph"> <p>Since each node might hold a partial index, it may be necessary to link#query_clustered_query_api[broadcast] queries in order to get correct search results, which can add latency. If the cache is REPL, though, the broadcast is not necessary: each node can hold a full local copy of the index and queries runs at optimal speed taking advantage of a local index.</p> </div> <div class="paragraph"> <p>Infinispan has two index managers suitable for non-shared indexes: <code>directory-based</code> and <code>near-real-time</code>. Storage wise, non-shared indexes can be located in ram, filesystem, or Infinispan local caches.</p> </div> <div class="sect5"> <h6 id="effect_of_the_index_mode_2"><a class="anchor" href="#effect_of_the_index_mode_2"></a>Effect of the index mode</h6> <div class="paragraph"> <p>The <code>directory-based</code> and <code>near-real-time</code> index managers can be associated with different <a href="#query_index_mode">index modes</a>, resulting in different index distributions.</p> </div> <div class="paragraph"> <p>REPL caches combined with the <code>ALL</code> index mode will result in a full copy of the cluster-wide index on each node. This mode allows queries to become effectively local without network latency. This is the recommended mode to index any REPL cache, and that&#8217;s the choice picked by the <a href="#query_autoconfig">auto-config</a> when the a REPL cache is detected. The <code>ALL</code> mode should not be used with DIST caches.</p> </div> <div class="paragraph"> <p>REPL or DIST caches combined with <code>LOCAL</code> index mode will cause each node to index only data inserted from the same JVM, causing an uneven distribution of the index. In order to obtain correct query results, it&#8217;s necessary to use <a href="#query_clustered_query_api">broadcast</a> queries.</p> </div> <div class="paragraph"> <p>REPL or DIST caches combined with <code>PRIMARY_OWNER</code> will also need broadcast queries. Differently from the <code>LOCAL</code> mode, each node&#8217;s index will contain indexed entries which key is primarily owned by the node according to the consistent hash, leading to a more evenly distributed indexes among the nodes.</p> </div> </div> <div class="sect5"> <h6 id="query_directory_based"><a class="anchor" href="#query_directory_based"></a>directory-based index manager</h6> <div class="paragraph"> <p>This is the default Index Manager used when no index manager is configured. The <code>directory-based</code> index manager is used to manage indexes backed by a local lucene directory. It supports <em>ram</em>, <em>filesystem</em> and non-clustered <em>infinispan</em> storage.</p> </div> <div class="paragraph"> <p><strong class="small">Filesystem storage</strong></p> </div> <div class="paragraph"> <p>This is the default storage, and used when index manager configuration is omitted. The index is stored in the filesystem using a <a href="https://lucene.apache.org/core/6_0_0/core/org/apache/lucene/store/MMapDirectory.html">MMapDirectory</a>. It is the recommended storage for local indexes. Although indexes are persistent on disk, they get memory mapped by Lucene and thus offer decent query performance.</p> </div> <div class="paragraph"> <p>Configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="comment">&lt;!-- Optional: define base folder for indexes --&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexBase</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${java.io.tmpdir}/baseDir<span class="tag">&lt;/property&gt;</span>
   <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Infinispan will create a different folder under <code>default.indexBase</code> for each entity (index) present in the cache.</p> </div> <div class="paragraph"> <p><strong class="small">Ram storage</strong></p> </div> <div class="paragraph"> <p>Index is stored in memory using a <a href="https://lucene.apache.org/core/6_0_0/core/org/apache/lucene/store/RAMDirectory.html">Lucene RAMDirectory</a>. Not recommended for large indexes or highly concurrent situations. Indexes stored in Ram are not persistent, so after a cluster shutdown a <a href="#query_massindexer">re-index</a> is needed. Configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>local-heap<span class="tag">&lt;/property&gt;</span>
   <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p><strong class="small">Infinispan storage</strong></p> </div> <div class="paragraph"> <p>Infinispan storage makes use of the Infinispan Lucene directory that saves the indexes to a set of caches; those caches can be configured like any other Infinispan cache, for example by adding a cache store to have indexes persisted elsewhere apart from memory. In order to use Infinispan storage with a non-shared index, it&#8217;s necessary to use LOCAL caches for the indexes:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.locking_cachename</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>LuceneIndexesLocking_custom<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.data_cachename</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>LuceneIndexesData_custom<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.metadata_cachename</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>LuceneIndexesMetadata_custom<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span>

<span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesLocking_custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span>

<span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesMetadata_custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span>

<span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesData_custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> </div> <div class="sect5"> <h6 id="near_real_time_index_manager"><a class="anchor" href="#near_real_time_index_manager"></a>near-real-time index manager</h6> <div class="paragraph"> <p>Similar to the <code>directory-based</code> index manager but takes advantage of the Near-Real-Time features of Lucene. It has better write performance than the <code>directory-based</code> because it flushes the index to the underlying store less often. The drawback is that unflushed index changes can be lost in case of a non-clean shutdown. Can be used in conjunction with <code>local-heap</code>, <code>filesystem</code> and local infinispan storage. Configuration for each different storage type is the same as the <a href="#query_directory_based">directory-based</a> index manager.</p> </div> <div class="paragraph"> <p>Example with ram:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>near-real-time<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>local-heap<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Example with filesystem:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>near-real-time<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre> </div> </div> </div> </div> <div class="sect4"> <h5 id="external_indexes"><a class="anchor" href="#external_indexes"></a>External indexes</h5> <div class="paragraph"> <p>Apart from having shared and non-shared indexes managed by Infinispan itself, it is possible to offload indexing to a third party search engine: currently Infinispan supports Elasticsearch as a external index storage.</p> </div> <div class="sect5"> <h6 id="elasticsearch_indexmanager_experimental"><a class="anchor" href="#elasticsearch_indexmanager_experimental"></a>Elasticsearch IndexManager (experimental)</h6> <div class="paragraph"> <p>This index manager forwards all indexes to an external Elasticsearch server. This is an experimental integration and some features may not be available, for example <code>indexNullAs</code> for <code>@IndexedEmbedded</code> annotations is <a href="https://hibernate.atlassian.net/browse/HSEARCH-2389">not currently supported</a>.</p> </div> <div class="paragraph"> <p>Configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>elasticsearch<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.elasticsearch.host</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>link:http://elasticHost:9200<span class="tag">&lt;/property&gt;</span>
    <span class="comment">&lt;!-- other elasticsearch configurations --&gt;</span>
<span class="tag">&lt;/indexing&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The index mode should be set to <code>LOCAL</code>, since Infinispan considers Elasticsearch as a single shared index. More information about Elasticsearch integration, including the full description of the configuration properties can be found at the <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#elasticsearch-integration">Hibernate Search manual</a>.</p> </div> </div> </div> <div class="sect4"> <h5 id="query_autoconfig"><a class="anchor" href="#query_autoconfig"></a>Automatic configuration</h5> <div class="paragraph"> <p>The attribute auto-config provides a simple way of configuring indexing based on the cache type. For replicated and local caches, the indexing is configured to be persisted on disk and not shared with any other processes. Also, it is configured so that minimum delay exists between the moment an object is indexed and the moment it is available for searches (near real time).</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-config</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;/indexing&gt;</span>
      <span class="tag">&lt;/local-cache&gt;</span></code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> it is possible to redefine any property added via auto-config, and also add new properties, allowing for advanced tuning. </td> </tr> </table> </div> <div class="paragraph"> <p>The auto config adds the following properties for replicated and local caches:</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Property name</th> <th class="tableblock halign-left valign-top">value</th> <th class="tableblock halign-left valign-top">description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">default.directory_provider</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">filesystem</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Filesystem based index. More details at <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-configuration-directory">Hibernate Search documentation</a></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">default.exclusive_index_use</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">indexing operation in exclusive mode, allowing Hibernate Search to optimize writes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">default.indexmanager</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">near-real-time</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">make use of Lucene near real time feature, meaning indexed objects are promptly available to searches</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">default.reader.strategy</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">shared</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Reuse index reader across several queries, thus avoiding reopening it</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>For distributed caches, the auto-config configure indexes in Infinispan itself, internally handled as a master-slave mechanism where indexing operations are sent to a single node which is responsible to write to the index.</p> </div> <div class="paragraph"> <p>The auto config properties for distributed caches are:</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Property name</th> <th class="tableblock halign-left valign-top">value</th> <th class="tableblock halign-left valign-top">description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">default.directory_provider</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">infinispan</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Indexes stored in Infinispan. More details at <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#infinispan-directories">Hibernate Search documentation</a></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">default.exclusive_index_use</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">indexing operation in exclusive mode, allowing Hibernate Search to optimize writes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">default.indexmanager</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">org.infinispan.query.indexmanager.InfinispanIndexManager</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Delegates index writing to a single node in the Infinispan cluster</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">default.reader.strategy</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">shared</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Reuse index reader across several queries, avoiding reopening it</p></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="query_massindexer"><a class="anchor" href="#query_massindexer"></a>Re-indexing</h5> <div class="paragraph"> <p>Occasionally you might need to rebuild the Lucene index by reconstructing it from the data stored in the Cache. You need to rebuild the index if you change the definition of what is indexed on your types, or if you change for example some <em>Analyzer</em> parameter, as Analyzers affect how the index is written. Also, you might need to rebuild the index if you had it destroyed by some system administration mistake. To rebuild the index just get a reference to the MassIndexer and start it; beware it might take some time as it needs to reprocess all data in the grid!</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Blocking execution</span>
SearchManager searchManager = Search.getSearchManager(cache);
searchManager.getMassIndexer().start();

<span class="comment">// Non blocking execution</span>
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; future = searchManager.getMassIndexer().startAsyc();</code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> This is also available as a <code>start</code> JMX operation on the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/jmxComponents.html#MassIndexer">MassIndexer MBean</a> registered under the name <code>org.infinispan:type=Query,manager="{name-of-cache-manager}",cache="{name-of-cache}",component=MassIndexer</code>. </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="query_indexless"><a class="anchor" href="#query_indexless"></a>Indexless</h5> <div class="paragraph"> <p>TODO</p> </div> </div> <div class="sect4"> <h5 id="query_hybrid"><a class="anchor" href="#query_hybrid"></a>Hybrid</h5> <div class="paragraph"> <p>TODO</p> </div> </div> <div class="sect4"> <h5 id="mapping_entities"><a class="anchor" href="#mapping_entities"></a>Mapping Entities</h5> <div class="paragraph"> <p>Infinispan relies on the rich API of <a href="http://hibernate.org/search/">Hibernate Search</a> in order to define fine grained configuration for indexing at entity level. This configuration includes which fields are annotated, which analyzers should be used, how to map nested objects and so on. Detailed documentation is available at <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-mapping">the Hibernate Search manual</a>.</p> </div> <div class="sect5"> <h6 id="documentid"><a class="anchor" href="#documentid"></a>@DocumentId</h6> <div class="paragraph"> <p>Unlike Hibernate Search, using <em>@DocumentId</em> to mark a field as identifier does not apply to Infinispan values; in Infinispan the identifier for all <em>@Indexed</em> objects is the key used to store the value. You can still customize how the key is indexed using a combination of <em>@Transformable</em> , custom types and custom <em>FieldBridge</em> implementations.</p> </div> </div> <div class="sect5"> <h6 id="transformable_keys"><a class="anchor" href="#transformable_keys"></a>@Transformable keys</h6> <div class="paragraph"> <p>The key for each value needs to be indexed as well, and the key instance must be transformed in a <em>String</em>. Infinispan includes some default transformation routines to encode common primitives, but to use a custom key you must provide an implementation of <em>org.infinispan.query.Transformer</em> .</p> </div> <div class="paragraph"> <p><strong class="small">Registering a key Transformer via annotations</strong></p> </div> <div class="paragraph"> <p>You can annotate your key class with <em>org.infinispan.query.Transformable</em> and your custom transformer implementation will be picked up automatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transformable</span>(transformer = CustomTransformer.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomKey</span> {
   ...
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomTransformer</span> <span class="directive">implements</span> <span class="predefined-type">Transformer</span> {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Object</span> fromString(<span class="predefined-type">String</span> s) {
      ...
      return <span class="keyword">new</span> CustomKey(...);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> toString(<span class="predefined-type">Object</span> customType) {
      CustomKey ck = (CustomKey) customType;
      <span class="keyword">return</span> ...
   }
}</code></pre> </div> </div> <div class="paragraph"> <p><strong class="small">Registering a key Transformer via the cache indexing configuration</strong></p> </div> <div class="paragraph"> <p>You can use the <em>key-transformers</em> xml element in both embedded and server config:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml">   <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-config</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
           <span class="tag">&lt;key-transformers&gt;</span>
               <span class="tag">&lt;key-transformer</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomKey</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transformer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomTransformer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
           <span class="tag">&lt;/key-transformers&gt;</span>
       <span class="tag">&lt;/indexing&gt;</span>
   <span class="tag">&lt;/replicated-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>or alternatively, you can achieve the same effect by using the Java configuration API (embedded mode):</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">   ConfigurationBuilder builder = ...
   builder.indexing().autoConfig(<span class="predefined-constant">true</span>)
         .addKeyTransformer(CustomKey.class, CustomTransformer.class);</code></pre> </div> </div> <div class="paragraph"> <p><strong class="small">Registering a Transformer programmatically at runtime</strong></p> </div> <div class="paragraph"> <p>Using this technique, you don&#8217;t have to annotate your custom key type and you also do not add the transformer to the, cache indexing configuration, instead, you can add it to the <em>SearchManagerImplementor</em> dynamically at runtime by invoking <em>org.infinispan.query.spi.SearchManagerImplementor.registerKeyTransformer(Class&lt;?&gt;, Class&lt;? extends Transformer&gt;)</em>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">org.infinispan.query.spi.SearchManagerImplementor manager = Search.getSearchManager(cache).unwrap(SearchManagerImplementor.class);
manager.registerKeyTransformer(keyClass, keyTransformerClass);</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This approach is deprecated since 10.0 because it can lead to situations when a newly started node receives cache entries via initial state transfer and is not able to index them because the needed key transformers are not yet registered (and can only be registered after the Cache has been fully started). This undesirable situation is avoided if you register your key transformers using the other available approaches (configuration and annotation). </td> </tr> </table> </div> </div> <div class="sect5"> <h6 id="query_configuration_api"><a class="anchor" href="#query_configuration_api"></a>Programmatic mapping</h6> <div class="paragraph"> <p>Instead of using annotations to map an entity to the index, it&#8217;s also possible to configure it programmatically.</p> </div> <div class="paragraph"> <p>In the following example we map an object <em>Author</em> which is to be stored in the grid and made searchable on two properties but without annotating the class.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.apache.lucene.search.Query</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.cfg.Environment</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.cfg.SearchMapping</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.query.dsl.QueryBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.Cache</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.Configuration</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.Index</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.manager.DefaultCacheManager</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.CacheQuery</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.SearchManager</span>;

<span class="keyword">import</span> <span class="include">java.io.IOException</span>;
<span class="keyword">import</span> <span class="include">java.lang.annotation.ElementType</span>;
<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

SearchMapping mapping = <span class="keyword">new</span> SearchMapping();
mapping.entity(Author.class).indexed()
       .property(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">ElementType</span>.METHOD).field()
       .property(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">ElementType</span>.METHOD).field();

<span class="predefined-type">Properties</span> properties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
properties.put(Environment.MODEL_MAPPING, mapping);
properties.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.search.[other options]</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">[...]</span><span class="delimiter">&quot;</span></span>);

<span class="predefined-type">Configuration</span> infinispanConfiguration = <span class="keyword">new</span> ConfigurationBuilder()
        .indexing().index(Index.LOCAL)
        .withProperties(properties)
        .build();

DefaultCacheManager cacheManager = <span class="keyword">new</span> DefaultCacheManager(infinispanConfiguration);

Cache&lt;<span class="predefined-type">Long</span>, Author&gt; cache = cacheManager.getCache();
SearchManager sm = Search.getSearchManager(cache);

Author author = <span class="keyword">new</span> Author(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Surtani</span><span class="delimiter">&quot;</span></span>);
cache.put(author.getId(), author);

QueryBuilder qb = sm.buildQueryBuilderForClass(Author.class).get();
<span class="predefined-type">Query</span> q = qb.keyword().onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>).matching(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>).createQuery();
CacheQuery cq = sm.getQuery(q, Author.class);
<span class="keyword">assert</span> cq.getResultSize() == <span class="integer">1</span>;</code></pre> </div> </div> </div> </div> </div> <div class="sect3"> <h4 id="query_apis"><a class="anchor" href="#query_apis"></a>1.2.3. Querying APIs</h4> <div class="paragraph"> <p>You can query Infinispan using:</p> </div> <div class="ulist"> <ul> <li> <p>Lucene or Hibernate Search Queries. Infinispan exposes the Hibernate Search DSL, which produces Lucene queries. You can run Lucene queries on single nodes or broadcast queries to multiple nodes in an Infinispan cluster.</p> </li> <li> <p>Ickle queries, a custom string-based query language with full-text extensions.</p> </li> </ul> </div> <div class="sect4"> <h5 id="query_hibernatesearch"><a class="anchor" href="#query_hibernatesearch"></a>Hibernate Search</h5> <div class="paragraph"> <p>Apart from supporting Hibernate Search annotations to configure indexing, it&#8217;s also possible to query the cache using other Hibernate Search APIs</p> </div> <div class="sect5"> <h6 id="running_lucene_queries"><a class="anchor" href="#running_lucene_queries"></a>Running Lucene queries</h6> <div class="paragraph"> <p>To run a Lucene query directly, simply create and wrap it in a <em>CacheQuery</em>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.SearchManager</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.Query</span>;


SearchManager searchManager = Search.getSearchManager(cache);
<span class="predefined-type">Query</span> query = searchManager.buildQueryBuilderForClass(<span class="predefined-type">Book</span>.class).get()
            .keyword().wildcard().onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).matching(<span class="string"><span class="delimiter">&quot;</span><span class="content">*test*</span><span class="delimiter">&quot;</span></span>).createQuery();
CacheQuery&lt;<span class="predefined-type">Book</span>&gt; cacheQuery = searchManager.getQuery(query);</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="using_the_hibernate_search_dsl"><a class="anchor" href="#using_the_hibernate_search_dsl"></a>Using the Hibernate Search DSL</h6> <div class="paragraph"> <p>The Hibernate Search DSL can be used to create the Lucene Query, example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.SearchManager</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.search.Query</span>;

Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Book</span>&gt; cache = ...

SearchManager searchManager = Search.getSearchManager(cache);

<span class="predefined-type">Query</span> luceneQuery = searchManager
                         .buildQueryBuilderForClass(<span class="predefined-type">Book</span>.class).get()
                         .range().onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">year</span><span class="delimiter">&quot;</span></span>).from(<span class="integer">2005</span>).to(<span class="integer">2010</span>)
                         .createQuery();

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Object</span>&gt; results = searchManager.getQuery(luceneQuery).list();</code></pre> </div> </div> <div class="paragraph"> <p>For a detailed description of the query capabilities of this DSL, see the relevant section of the <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#section-building-lucene-queries">Hibernate Search manual</a>.</p> </div> </div> <div class="sect5"> <h6 id="faceted_search"><a class="anchor" href="#faceted_search"></a>Faceted Search</h6> <div class="paragraph"> <p>Infinispan support <a href="https://en.wikipedia.org/wiki/Faceted_search">Faceted Searches</a> by using the Hibernate Search <code>FacetManager</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Cache is indexed</span>
Cache&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">Book</span>&gt; cache = ...

<span class="comment">// Obtain the Search Manager</span>
SearchManager searchManager = Search.getSearchManager(cache);

<span class="comment">// Create the query builder</span>
QueryBuilder queryBuilder = searchManager.buildQueryBuilderForClass(<span class="predefined-type">Book</span>.class).get();

<span class="comment">// Build any Lucene Query. Here it's using the DSL to do a Lucene term query on a book name</span>
<span class="predefined-type">Query</span> luceneQuery = queryBuilder.keyword().wildcard().onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>).matching(<span class="string"><span class="delimiter">&quot;</span><span class="content">bitcoin</span><span class="delimiter">&quot;</span></span>).createQuery();

<span class="comment">// Wrap into a cache Query</span>
CacheQuery&lt;<span class="predefined-type">Book</span>&gt; query = searchManager.getQuery(luceneQuery);

<span class="comment">// Define the Facet characteristics</span>
FacetingRequest request = queryBuilder.facet()
                .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">year_facet</span><span class="delimiter">&quot;</span></span>)
                .onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">year</span><span class="delimiter">&quot;</span></span>)
                .discrete()
                .orderedBy(FacetSortOrder.COUNT_ASC)
                .createFacetingRequest();

<span class="comment">// Associated the FacetRequest with the query</span>
FacetManager facetManager = query.getFacetManager().enableFaceting(request);

<span class="comment">// Obtain the facets</span>
<span class="predefined-type">List</span>&lt;Facet&gt; facetList = facetManager.getFacets(<span class="string"><span class="delimiter">&quot;</span><span class="content">year_facet</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>A Faceted search like above will return the number books that match 'bitcoin' released on a yearly basis, for example:</p> </div> <div class="listingblock"> <div class="content"> <pre>AbstractFacet{facetingName='year_facet', fieldName='year', value='2008', count=1}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2009', count=1}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2010', count=1}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2011', count=1}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2012', count=1}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2016', count=1}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2015', count=2}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2013', count=3}</pre> </div> </div> <div class="paragraph"> <p>For more info about Faceted Search, see <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#query-faceting">Hibernate Search Faceting</a></p> </div> </div> <div class="sect5"> <h6 id="query_spatial"><a class="anchor" href="#query_spatial"></a>Spatial Queries</h6> <div class="paragraph"> <p>Infinispan also supports <a href="https://en.wikipedia.org/wiki/Spatial_query">Spatial Queries</a>, allowing to combining full-text with restrictions based on distances, geometries or geographic coordinates.</p> </div> <div class="paragraph"> <p>Example, we start by using the <code>@Spatial</code> annotation in our entity that will be searched, together with <code>@Latitude</code> and <code>@Longitude</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Indexed</span>
<span class="annotation">@Spatial</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Restaurant</span> {

      <span class="annotation">@Latitude</span>
      <span class="directive">private</span> <span class="predefined-type">Double</span> latitude;

      <span class="annotation">@Longitude</span>
      <span class="directive">private</span> <span class="predefined-type">Double</span> longitude;

      <span class="annotation">@Field</span>(store = Store.YES)
      <span class="predefined-type">String</span> name;

      <span class="comment">// Getters, Setters and other members omitted</span>

   }</code></pre> </div> </div> <div class="paragraph"> <p>to run spatial queries, the Hibernate Search DSL can be used:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Cache is configured as indexed</span>
Cache&lt;<span class="predefined-type">String</span>, Restaurant&gt; cache = ...

<span class="comment">// Obtain the SearchManager</span>
Searchmanager searchManager = Search.getSearchManager(cache);

<span class="comment">// Build the Lucene Spatial Query</span>
<span class="predefined-type">Query</span> query = Search.getSearchManager(cache).buildQueryBuilderForClass(Restaurant.class).get()
          .spatial()
            .within( <span class="integer">2</span>, Unit.KM )
              .ofLatitude( centerLatitude )
              .andLongitude( centerLongitude )
            .createQuery();

<span class="comment">// Wrap in a cache Query</span>
CacheQuery&lt;Restaurant&gt; cacheQuery = searchManager.getQuery(query);

<span class="predefined-type">List</span>&lt;Restaurant&gt; nearBy = cacheQuery.list();</code></pre> </div> </div> <div class="paragraph"> <p>More info on <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#spatial">Hibernate Search manual</a></p> </div> </div> <div class="sect5"> <h6 id="query_clustered_query_api"><a class="anchor" href="#query_clustered_query_api"></a>IndexedQueryMode</h6> <div class="paragraph"> <p>It&#8217;s possible to specify a query mode for indexed queries. IndexedQueryMode.BROADCAST allows to broadcast a query to each node of the cluster, retrieve the results and combine them before returning to the caller. It is suitable for use in conjunction with <a href="#query_non_shared_index">non-shared indexes</a>, since each node&#8217;s local index will have only a subset of the data indexed.</p> </div> <div class="paragraph"> <p>IndexedQueryMode.FETCH will execute the query in the caller. If all the indexes for the cluster wide data are available locally, performance will be optimal, otherwise this query mode may involve fetching indexes data from remote nodes.</p> </div> <div class="paragraph"> <p>The IndexedQueryMode is supported for Lucene Queries and Ickle String queries at the moment (no Infinispan Query DSL).</p> </div> <div class="paragraph"> <p>Example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CacheQuery&lt;Person&gt; broadcastQuery = Search.getSearchManager(cache).getQuery(<span class="keyword">new</span> MatchAllDocsQuery(), IndexedQueryMode.BROADCAST);

<span class="predefined-type">List</span>&lt;Person&gt; result = broadcastQuery.list();</code></pre> </div> </div> </div> </div> <div class="sect4"> <h5 id="query_dsl"><a class="anchor" href="#query_dsl"></a>Infinispan Query DSL</h5> <div class="paragraph"> <p>Infinispan provides its own query DSL, independent of Lucene and Hibernate Search. Decoupling the query API from the underlying query and indexing mechanism makes it possible to introduce new alternative engines in the future, besides Lucene, and still being able to use the same uniform query API. The current implementation of indexing and searching is still based on Hibernate Search and Lucene so all indexing related aspects presented in this chapter still apply.</p> </div> <div class="paragraph"> <p>The new API simplifies the writing of queries by not exposing the user to the low level details of constructing Lucene query objects and also has the advantage of being available to remote Hot Rod clients. But before delving into further details, let&#8217;s examine first a simple example of writing a query for the <em>Book</em> entity from the previous example.</p> </div> <div class="listingblock"> <div class="title">Query example using Infinispan's query DSL</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.dsl</span>.*;

<span class="comment">// get the DSL query factory from the cache, to be used for constructing the Query object:</span>
QueryFactory qf = org.infinispan.query.Search.getQueryFactory(cache);

<span class="comment">// create a query for all the books that have a title which contains &quot;engine&quot;:</span>
org.infinispan.query.dsl.Query query = qf.from(<span class="predefined-type">Book</span>.class)
      .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%engine%</span><span class="delimiter">&quot;</span></span>)
      .build();

<span class="comment">// get the results:</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; list = query.list();</code></pre> </div> </div> <div class="paragraph"> <p>The API is located in the <em>org.infinispan.query.dsl</em> package. A query is created with the help of the <em>QueryFactory</em> instance which is obtained from the per-cache <em>SearchManager</em>. Each <em>QueryFactory</em> instance is bound to the same <em>Cache</em> instance as the <em>SearchManager</em>, but it is otherwise a stateless and thread-safe object that can be used for creating multiple queries in parallel.</p> </div> <div class="paragraph"> <p>Query creation starts with the invocation of the <code>from(Class entityType)</code> method which returns a <em>QueryBuilder</em> object that is further responsible for creating queries targeted to the specified entity class from the given cache.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> A query will always target a single entity type and is evaluated over the contents of a single cache. Running a query over multiple caches or creating queries that target several entity types (joins) is not supported. </td> </tr> </table> </div> <div class="paragraph"> <p>The <em>QueryBuilder</em> accumulates search criteria and configuration specified through the invocation of its DSL methods and is ultimately used to build a <em>Query</em> object by the invocation of the <code>QueryBuilder.build()</code> method that completes the construction. Being a stateful object, it cannot be used for constructing multiple queries at the same time (except for <a href="#nested_conditions">nested queries</a>) but can be reused afterwards.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This <em>QueryBuilder</em> is different from the one from Hibernate Search but has a somewhat similar purpose, hence the same name. We are considering renaming it in near future to prevent ambiguity. </td> </tr> </table> </div> <div class="paragraph"> <p>Executing the query and fetching the results is as simple as invoking the <code>list()</code> method of the <em>Query</em> object. Once executed the <em>Query</em> object is not reusable. If you need to re-execute it in order to obtain fresh results then a new instance must be obtained by calling <code>QueryBuilder.build()</code>.</p> </div> <div class="sect5"> <h6 id="filtering_operators"><a class="anchor" href="#filtering_operators"></a>Filtering operators</h6> <div class="paragraph"> <p>Constructing a query is a hierarchical process of composing multiple criteria and is best explained following this hierarchy.</p> </div> <div class="paragraph"> <p>The simplest possible form of a query criteria is a restriction on the values of an entity attribute according to a filtering operator that accepts zero or more arguments. The entity attribute is specified by invoking the <code>having(String attributePath)</code> method of the query builder which returns an intermediate context object (<a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/query/dsl/FilterConditionEndContext.html"><em>FilterConditionEndContext</em></a>) that exposes all the available operators. Each of the methods defined by <em>FilterConditionEndContext</em> is an operator that accepts an argument, except for <code>between</code> which has two arguments and <code>isNull</code> which has no arguments. The arguments are statically evaluated at the time the query is constructed, so if you&#8217;re looking for a feature similar to SQL&#8217;s correlated sub-queries, that is not currently available.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// a single query criterion</span>
QueryBuilder qb = ...
qb.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate Search in Action</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <table class="tableblock frame-all grid-all stretch"> <caption class="title">Table 1. <em>FilterConditionEndContext</em> exposes the following filtering operators:</caption> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Filter</th> <th class="tableblock halign-left valign-top">Arguments</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">in</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Collectionvalues</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left operand is equal to one of the elements from the Collection of values given as argument.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">in</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Object&#8230;&#8203;values</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left operand is equal to one of the (fixed) list of values given as argument.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">contains</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains the given element.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">containsAll</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Collectionvalues</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains all the elements of the given collection, in any order.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">containsAll</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Object&#8230;&#8203;values</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains all of the the given elements, in any order.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">containsAny</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Collectionvalues</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains any of the elements of the given collection.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">containsAny</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Object&#8230;&#8203;values</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains any of the the given elements.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">isNull</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is null.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">like</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Stringpattern</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be a String) matches a wildcard pattern that follows the JPA rules.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">eq</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is equal to the given value.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">equal</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Alias for eq.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">gt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is greater than the given value.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">gte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is greater than or equal to the given value.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">lt</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is less than the given value.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">lte</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is less than or equal to the given value.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">between</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Objectfrom, Objectto</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is between the given range limits.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>It&#8217;s important to note that query construction requires a multi-step chaining of method invocation that must be done in the proper sequence, must be properly completed exactly <em>once</em> and must not be done twice, or it will result in an error. The following examples are invalid, and depending on each case they lead to criteria being ignored (in benign cases) or an exception being thrown (in more serious ones).</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Incomplete construction. This query does not have any filter on &quot;title&quot; attribute yet,</span>
<span class="comment">// although the author may have intended to add one.</span>
QueryBuilder qb1 = ...
qb1.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Query</span> q1 = qb1.build(); <span class="comment">// consequently, this query matches all Book instances regardless of title!</span>

<span class="comment">// Duplicated completion. This results in an exception at run-time.</span>
<span class="comment">// Maybe the author intended to connect two conditions with a boolean operator,</span>
<span class="comment">// but this does NOT actually happen here.</span>
QueryBuilder qb2 = ...
qb2.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>);
qb2.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%clustering%</span><span class="delimiter">&quot;</span></span>);   <span class="comment">// will throw java.lang.IllegalStateException: Sentence already started. Cannot use 'having(..)' again.</span>
<span class="predefined-type">Query</span> q2 = qb2.build();</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="filtering_based_on_attributes_of_embedded_entities"><a class="anchor" href="#filtering_based_on_attributes_of_embedded_entities"></a>Filtering based on attributes of embedded entities</h6> <div class="paragraph"> <p>The <code>having</code> method also accepts dot separated attribute paths for referring to <em>embedded entity</em> attributes, so the following is a valid query:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have an author named &quot;Manik&quot;</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
      .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.name</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>)
      .build();</code></pre> </div> </div> <div class="paragraph"> <p>Each part of the attribute path must refer to an existing indexed attribute in the corresponding entity or embedded entity class respectively. It&#8217;s possible to have multiple levels of embedding.</p> </div> </div> <div class="sect5"> <h6 id="boolean_conditions"><a class="anchor" href="#boolean_conditions"></a>Boolean conditions</h6> <div class="paragraph"> <p>Combining multiple attribute conditions with logical conjunction (<code>and</code>) and disjunction (<code>or</code>) operators in order to create more complex conditions is demonstrated in the following example. The well known operator precedence rule for boolean operators applies here, so the order of DSL method invocations during construction is irrelevant. Here <code>and</code> operator still has higher priority than <code>or</code> even though <code>or</code> was invoked first.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have &quot;Data Grid&quot; in their title</span>
<span class="comment">// or have an author named &quot;Manik&quot; and their description contains &quot;clustering&quot;</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>)
  .or().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.name</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>)
  .and().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%clustering%</span><span class="delimiter">&quot;</span></span>)
  .build();</code></pre> </div> </div> <div class="paragraph"> <p>Boolean negation is achieved with the <code>not</code> operator, which has highest precedence among logical operators and applies only to the next simple attribute condition.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that do not have &quot;Data Grid&quot; in their title and are authored by &quot;Manik&quot;</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .not().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>)
  .and().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.name</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>)
  .build();</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="nested_conditions"><a class="anchor" href="#nested_conditions"></a>Nested conditions</h6> <div class="paragraph"> <p>Changing the precedence of logical operators is achieved with nested filter conditions. Logical operators can be used to connect two simple attribute conditions as presented before, but can also connect a simple attribute condition with the subsequent complex condition created with the same query factory.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have an author named &quot;Manik&quot; and their title contains</span>
<span class="comment">// &quot;Data Grid&quot; or their description contains &quot;clustering&quot;</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.name</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>)
  .and(queryFactory.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>)
          .or().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%clustering%</span><span class="delimiter">&quot;</span></span>))
  .build();</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="projections"><a class="anchor" href="#projections"></a>Projections</h6> <div class="paragraph"> <p>In some use cases returning the whole domain object is overkill if only a small subset of the attributes are actually used by the application, especially if the domain entity has embedded entities. The query language allows you to specify a subset of attributes (or attribute paths) to return - the projection. If projections are used then the <code>Query.list()</code> will not return the whole domain entity but will return a <em>List</em> of <em>Object[]</em>, each slot in the array corresponding to a projected attribute.</p> </div> <div class="paragraph"> <p>TODO document what needs to be configured for an attribute to be available for projection.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have &quot;Data Grid&quot; in their title or description</span>
<span class="comment">// and return only their title and publication year</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>)
  .or().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>))
  .build();</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="sorting"><a class="anchor" href="#sorting"></a>Sorting</h6> <div class="paragraph"> <p>Ordering the results based on one or more attributes or attribute paths is done with the <code>QueryBuilder.orderBy( )</code> method which accepts an attribute path and a sorting direction. If multiple sorting criteria are specified, then the order of invocation of <code>orderBy</code> method will dictate their precedence. But you have to think of the multiple sorting criteria as acting together on the tuple of specified attributes rather than in a sequence of individual sorting operations on each attribute.</p> </div> <div class="paragraph"> <p>TODO document what needs to be configured for an attribute to be available for sorting.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have &quot;Data Grid&quot; in their title or description</span>
<span class="comment">// and return them sorted by the publication year and title</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .orderBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, SortOrder.DESC)
  .orderBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, SortOrder.ASC)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>)
  .or().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>))
  .build();</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="pagination"><a class="anchor" href="#pagination"></a>Pagination</h6> <div class="paragraph"> <p>You can limit the number of returned results by setting the <em>maxResults</em> property of <em>QueryBuilder</em>. This can be used in conjunction with setting the <em>startOffset</em> in order to achieve pagination of the result set.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have &quot;clustering&quot; in their title</span>
<span class="comment">// sorted by publication year and title</span>
<span class="comment">// and return 3'rd page of 10 results</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .orderBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, SortOrder.DESC)
  .orderBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, SortOrder.ASC)
  .startOffset(<span class="integer">20</span>)
  .maxResults(<span class="integer">10</span>)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%clustering%</span><span class="delimiter">&quot;</span></span>)
  .build();</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Even if the results being fetched are limited to <em>maxResults</em> you can still find the total number of matching results by calling <code>Query.getResultSize()</code>. </td> </tr> </table> </div> <div class="paragraph"> <p>TODO Does pagination make sense if no stable sort criteria is defined? Luckily when running on Lucene and no sort criteria is specified we still have the order of relevance, but this has to be defined for other search engines.</p> </div> </div> <div class="sect5"> <h6 id="grouping_and_aggregation"><a class="anchor" href="#grouping_and_aggregation"></a>Grouping and Aggregation</h6> <div class="paragraph"> <p>Infinispan has the ability to group query results according to a set of grouping fields and construct aggregations of the results from each group by applying an aggregation function to the set of values that fall into each group. Grouping and aggregation can only be applied to projection queries. The supported aggregations are: avg, sum, count, max, min. The set of grouping fields is specified with the <em>groupBy(field)</em> method, which can be invoked multiple times. The order used for defining grouping fields is not relevant. All fields selected in the projection must either be grouping fields or else they must be aggregated using one of the grouping functions described below. A projection field can be aggregated and used for grouping at the same time. A query that selects only grouping fields but no aggregation fields is legal. </p> </div> <div class="paragraph"> <p>Example: Grouping Books by author and counting them.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
    .select(<span class="predefined-type">Expression</span>.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>), <span class="predefined-type">Expression</span>.count(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>))
    .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%engine%</span><span class="delimiter">&quot;</span></span>)
    .groupBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>)
    .build();</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> A projection query in which all selected fields have an aggregation function applied and no fields are used for grouping is allowed. In this case the aggregations will be computed globally as if there was a single global group. </td> </tr> </table> </div> </div> <div class="sect5"> <h6 id="aggregations"><a class="anchor" href="#aggregations"></a>Aggregations</h6> <div class="paragraph"> <p>The following aggregation functions may be applied to a field: avg, sum, count, max, min</p> </div> <div class="ulist"> <ul> <li> <p>avg() - Computes the average of a set of numbers. Accepted values are primitive numbers and instances of <em>java.lang.Number</em>. The result is represented as <em>java.lang.Double</em>. If there are no non-null values the result is <em>null</em> instead.</p> </li> <li> <p>count() - Counts the number of non-null rows and returns a <em>java.lang.Long</em>. If there are no non-null values the result is <em>0</em> instead.</p> </li> <li> <p>max() - Returns the greatest value found. Accepted values must be instances of <em>java.lang.Comparable</em>. If there are no non-null values the result is <em>null</em> instead.</p> </li> <li> <p>min() - Returns the smallest value found. Accepted values must be instances of <em>java.lang.Comparable</em>. If there are no non-null values the result is <em>null</em> instead.</p> </li> <li> <p>sum() - Computes the sum of a set of Numbers. If there are no non-null values the result is <em>null</em> instead. The following table indicates the return type based on the specified field.</p> </li> </ul> </div> <table class="tableblock frame-all grid-all stretch"> <caption class="title">Table 2. Table sum return type</caption> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Field Type</th> <th class="tableblock halign-left valign-top">Return Type</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Integral (other than BigInteger)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Float or Double</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Double</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">BigInteger</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">BigInteger</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td> </tr> </tbody> </table> </div> <div class="sect5"> <h6 id="evaluation_of_queries_with_grouping_and_aggregation"><a class="anchor" href="#evaluation_of_queries_with_grouping_and_aggregation"></a>Evaluation of queries with grouping and aggregation</h6> <div class="paragraph"> <p>Aggregation queries can include filtering conditions, like usual queries. Filtering can be performed in two stages: before and after the grouping operation. All filter conditions defined before invoking the <em>groupBy</em> method will be applied before the grouping operation is performed, directly to the cache entries (not to the final projection). These filter conditions may reference any fields of the queried entity type, and are meant to restrict the data set that is going to be the input for the grouping stage. All filter conditions defined after invoking the <em>groupBy</em> method will be applied to the projection that results from the projection and grouping operation. These filter conditions can either reference any of the <em>groupBy</em> fields or aggregated fields. Referencing aggregated fields that are not specified in the select clause is allowed; however, referencing non-aggregated and non-grouping fields is forbidden. Filtering in this phase will reduce the amount of groups based on their properties. Sorting may also be specified similar to usual queries. The ordering operation is performed after the grouping operation and can reference any of the <em>groupBy</em> fields or aggregated fields.</p> </div> </div> <div class="sect5"> <h6 id="using_named_query_parameters"><a class="anchor" href="#using_named_query_parameters"></a>Using Named Query Parameters</h6> <div class="paragraph"> <p>Instead of building a new Query object for every execution it is possible to include named parameters in the query which can be substituted with actual values before execution. This allows a query to be defined once and be efficiently executed many times. Parameters can only be used on the right-hand side of an operator and are defined when the query is created by supplying an object produced by the <em>org.infinispan.query.dsl.Expression.param(String paramName)</em> method to the operator instead of the usual constant value. Once the parameters have been defined they can be set by invoking either <em>Query.setParameter(parameterName, value)</em> or <em>Query.setParameters(parameterMap)</em> as shown in the examples below. </p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl</span>.*;
[...]

QueryFactory queryFactory = Search.getQueryFactory(cache);
<span class="comment">// Defining a query to search for various authors and publication years</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
    .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>)
    .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>).eq(<span class="predefined-type">Expression</span>.param(<span class="string"><span class="delimiter">&quot;</span><span class="content">authorName</span><span class="delimiter">&quot;</span></span>))
    .and()
    .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>).eq(<span class="predefined-type">Expression</span>.param(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>))
    .build();

<span class="comment">// Set actual parameter values</span>
query.setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">authorName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>);
query.setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, <span class="integer">2010</span>);

<span class="comment">// Execute the query</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; found = query.list();</code></pre> </div> </div> <div class="paragraph"> <p>Alternatively, multiple parameters may be set at once by supplying a map of actual parameter values: </p> </div> <div class="listingblock"> <div class="title">Setting multiple named parameters at once</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util.Map</span>;
<span class="keyword">import</span> <span class="include">java.util.HashMap</span>;

[...]

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; parameterMap = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
parameterMap.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">authorName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>);
parameterMap.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, <span class="integer">2010</span>);

query.setParameters(parameterMap);</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> A significant portion of the query parsing, validation and execution planning effort is performed during the first execution of a query with parameters. This effort is not repeated during subsequent executions leading to better performance compared to a similar query using constant values instead of query parameters. </td> </tr> </table> </div> </div> <div class="sect5"> <h6 id="more_query_dsl_samples"><a class="anchor" href="#more_query_dsl_samples"></a>More Query DSL samples</h6> <div class="paragraph"> <p>Probably the best way to explore using the Query DSL API is to have a look at our tests suite. <a href="https://github.com/infinispan/infinispan/blob/master/query/src/test/java/org/infinispan/query/dsl/embedded/QueryDslConditionsTest.java">QueryDslConditionsTest</a> is a fine example.</p> </div> </div> </div> <div class="sect4"> <h5 id="query_ickle"><a class="anchor" href="#query_ickle"></a>Ickle</h5> <div class="paragraph"> <p>Create relational and full-text queries in both Library and Remote Client-Server mode with the Ickle query language.</p> </div> <div class="paragraph"> <p>Ickle is string-based and has the following characteristics:</p> </div> <div class="ulist"> <ul> <li> <p>Query Java classes and supports Protocol Buffers.</p> </li> <li> <p>Queries can target a single entity type.</p> </li> <li> <p>Queries can filter on properties of embedded objects, including collections.</p> </li> <li> <p>Supports projections, aggregations, sorting, named parameters.</p> </li> <li> <p>Supports indexed and non-indexed execution.</p> </li> <li> <p>Supports complex boolean expressions.</p> </li> <li> <p>Supports full-text queries.</p> </li> <li> <p>Does not support computations in expressions, such as <code>user.age &gt; sqrt(user.shoeSize+3)</code>.</p> </li> <li> <p>Does not support joins.</p> </li> <li> <p>Does not support subqueries.</p> </li> <li> <p>Is supported across various {Infinispan} APIs. Whenever a Query is produced by the QueryBuilder is accepted, including continuous queries or in event filters for listeners.</p> </li> </ul> </div> <div class="paragraph"> <p>To use the API, first obtain a QueryFactory to the cache and then call the .create() method, passing in the string to use in the query. For instance:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">QueryFactory qf = Search.getQueryFactory(remoteCache);
<span class="predefined-type">Query</span> q = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_bank_account.Transaction where amount &gt; 20</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>When using Ickle all fields used with full-text operators must be both <code>Indexed</code> and <code>Analysed</code>.</p> </div> <div class="sect5"> <h6 id="ickle_query_language_parser_syntax"><a class="anchor" href="#ickle_query_language_parser_syntax"></a>Ickle Query Language Parser Syntax</h6> <div class="paragraph"> <p>The parser syntax for the Ickle query language has some notable rules:</p> </div> <div class="ulist"> <ul> <li> <p>Whitespace is not significant.</p> </li> <li> <p>Wildcards are not supported in field names.</p> </li> <li> <p>A field name or path must always be specified, as there is no default field.</p> </li> <li> <p><code>&amp;&amp;</code> and <code>||</code> are accepted instead of <code>AND</code> or <code>OR</code> in both full-text and JPA predicates.</p> </li> <li> <p><code>!</code> may be used instead of <code>NOT</code>.</p> </li> <li> <p>A missing boolean operator is interpreted as <code>OR</code>.</p> </li> <li> <p>String terms must be enclosed with either single or double quotes.</p> </li> <li> <p>Fuzziness and boosting are not accepted in arbitrary order; fuzziness always comes first.</p> </li> <li> <p><code>!=</code> is accepted instead of <code>&lt;&gt;</code>.</p> </li> <li> <p>Boosting cannot be applied to <code>&gt;</code>,<code>&gt;=</code>,<code>&lt;</code>,<code></code> operators. Ranges may be used to achieve the same result.</p> </li> </ul> </div> </div> <div class="sect5"> <h6 id="fuzzy_queries"><a class="anchor" href="#fuzzy_queries"></a>Fuzzy Queries</h6> <div class="paragraph"> <p>To execute a fuzzy query add <code>~</code> along with an integer, representing the distance from the term used, after the term. For instance</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> fuzzyQuery = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_bank_account.Transaction where description : 'cofee'~2</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="range_queries"><a class="anchor" href="#range_queries"></a>Range Queries</h6> <div class="paragraph"> <p>To execute a range query define the given boundaries within a pair of braces, as seen in the following example:</p> </div> <div class="paragraph"> <p>Query rangeQuery = qf.create("from sample_bank_account.Transaction where amount : [20 to 50]");</p> </div> </div> <div class="sect5"> <h6 id="phrase_queries"><a class="anchor" href="#phrase_queries"></a>Phrase Queries</h6> <div class="paragraph"> <p>A group of words may be searched by surrounding them in quotation marks, as seen in the following example:</p> </div> <div class="paragraph"> <p>Query q = qf.create("from sample_bank_account.Transaction where description : 'bus fare'");</p> </div> </div> <div class="sect5"> <h6 id="proximity_queries"><a class="anchor" href="#proximity_queries"></a>Proximity Queries</h6> <div class="paragraph"> <p>To execute a proximity query, finding two terms within a specific distance, add a <code>~</code> along with the distance after the phrase. For instance, the following example will find the words canceling and fee provided they are not more than 3 words apart:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> proximityQuery = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_bank_account.Transaction where description : 'canceling fee'~3 </span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="wildcard_queries"><a class="anchor" href="#wildcard_queries"></a>Wildcard Queries</h6> <div class="paragraph"> <p>Both single-character and multi-character wildcard searches may be performed:</p> </div> <div class="ulist"> <ul> <li> <p>A single-character wildcard search may be used with the ? character.</p> </li> <li> <p>A multi-character wildcard search may be used with the * character.</p> </li> </ul> </div> <div class="paragraph"> <p>To search for text or test the following single-character wildcard search would be used:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> wildcardQuery = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_bank_account.Transaction where description : 'te?t'</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>To search for test, tests, or tester the following multi-character wildcard search would be useD:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> wildcardQuery = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_bank_account.Transaction where description : 'test*'</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="regular_expression_queries"><a class="anchor" href="#regular_expression_queries"></a>Regular Expression Queries</h6> <div class="paragraph"> <p>Regular expression queries may be performed by specifing a pattern between /. Ickle uses Lucenes regular expression syntax, so to search for the words moat or boat the following could be used:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> regExpQuery = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_library.Book  where title : /[mb]oat/</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="boosting_queries"><a class="anchor" href="#boosting_queries"></a>Boosting Queries</h6> <div class="paragraph"> <p>Terms may be boosted by adding a ^ after the term to increase their relevance in a given query, the higher the boost factor the more relevant the term will be. For instance to search for titles containing beer and wine with a higher relevance on beer, by a factor of 3, the following could be used:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> boostedQuery = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_library.Book where title : beer^3 OR wine</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> </div> <div class="sect4"> <h5 id="query_continuous"><a class="anchor" href="#query_continuous"></a>Continuous Query</h5> <div class="paragraph"> <p>Continuous Queries allow an application to register a listener which will receive the entries that currently match a query filter, and will be continuously notified of any changes to the queried data set that result from further cache operations. This includes incoming matches, for values that have joined the set, updated matches, for matching values that were modified and continue to match, and outgoing matches, for values that have left the set. By using a Continuous Query the application receives a steady stream of events instead of having to repeatedly execute the same query to discover changes, resulting in a more efficient use of resources. For instance, all of the following use cases could utilize Continuous Queries:</p> </div> <div class="ulist"> <ul> <li> <p>Return all persons with an age between 18 and 25 (assuming the Person entity has an <em>age</em> property and is updated by the user application).</p> </li> <li> <p>Return all transactions higher than $2000.</p> </li> <li> <p>Return all times where the lap speed of F1 racers were less than 1:45.00s (assuming the cache contains Lap entries and that laps are entered live during the race).</p> </li> </ul> </div> <div class="sect5"> <h6 id="continuous_query_execution"><a class="anchor" href="#continuous_query_execution"></a>Continuous Query Execution</h6> <div class="paragraph"> <p>A continuous query uses a listener that is notified when:</p> </div> <div class="ulist"> <ul> <li> <p>An entry starts matching the specified query, represented by a <em>Join</em> event.</p> </li> <li> <p>A matching entry is updated and continues to match the query, represented by an <em>Update</em> event.</p> </li> <li> <p>An entry stops matching the query, represented by a <em>Leave</em> event.</p> </li> </ul> </div> <div class="paragraph"> <p>When a client registers a continuous query listener it immediately begins to receive the results currently matching the query, received as <em>Join</em> events as described above. In addition, it will receive subsequent notifications when other entries begin matching the query, as <em>Join</em> events, or stop matching the query, as <em>Leave</em> events, as a consequence of any cache operations that would normally generate creation, modification, removal, or expiration events. Updated cache entries will generate <em>Update</em> events if the entry matches the query filter before and after the operation. To summarize, the logic used to determine if the listener receives a <em>Join</em>, <em>Update</em> or <em>Leave</em> event is:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>If the query on both the old and new values evaluate false, then the event is suppressed.</p> </li> <li> <p>If the query on the old value evaluates false and on the new value evaluates true, then a <em>Join</em> event is sent.</p> </li> <li> <p>If the query on both the old and new values evaluate true, then an <em>Update</em> event is sent.</p> </li> <li> <p>If the query on the old value evaluates true and on the new value evaluates false, then a <em>Leave</em> event is sent.</p> </li> <li> <p>If the query on the old value evaluates true and the entry is removed or expired, then a <em>Leave</em> event is sent.</p> </li> </ol> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Continuous Queries can use the full power of the Query DSL except: grouping, aggregation, and sorting operations. </td> </tr> </table> </div> </div> <div class="sect5"> <h6 id="running_continuous_queries"><a class="anchor" href="#running_continuous_queries"></a>Running Continuous Queries</h6> <div class="paragraph"> <p>To create a continuous query you&#8217;ll start by creating a Query object first. This is described in <a href="#query_dsl">the Query DSL section</a>. Then you&#8217;ll need to obtain the ContinuousQuery (<em>org.infinispan.query.api.continuous.ContinuousQuery</em>) object of your cache and register the query and a continuous query listener (<em>org.infinispan.query.api.continuous.ContinuousQueryListener</em>) with it. A ContinuousQuery object associated to a cache can be obtained by calling the static method <em>org.infinispan.client.hotrod.Search.getContinuousQuery(RemoteCache&lt;K, V&gt; cache)</em> if running in remote mode or <em>org.infinispan.query.Search.getContinuousQuery(Cache&lt;K, V&gt; cache)</em> when running in embedded mode. Once the listener has been created it may be registered by using the addContinuousQueryListener method of ContinuousQuery:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">continuousQuery.addContinuousQueryListener(query, listener);</code></pre> </div> </div> <div class="paragraph"> <p>The following example demonstrates a simple continuous query use case in embedded mode: </p> </div> <div class="listingblock"> <div class="title">Registering a Continuous Query</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.api.continuous.ContinuousQuery</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.api.continuous.ContinuousQueryListener</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.QueryFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.Query</span>;

<span class="keyword">import</span> <span class="include">java.util.Map</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.ConcurrentHashMap</span>;

[...]

<span class="comment">// We have a cache of Persons</span>
Cache&lt;<span class="predefined-type">Integer</span>, Person&gt; cache = ...

<span class="comment">// We begin by creating a ContinuousQuery instance on the cache</span>
ContinuousQuery&lt;<span class="predefined-type">Integer</span>, Person&gt; continuousQuery = Search.getContinuousQuery(cache);

<span class="comment">// Define our query. In this case we will be looking for any Person instances under 21 years of age.</span>
QueryFactory queryFactory = Search.getQueryFactory(cache);
<span class="predefined-type">Query</span> query = queryFactory.from(Person.class)
    .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span>).lt(<span class="integer">21</span>)
    .build();

<span class="directive">final</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">Integer</span>, Person&gt; matches = <span class="keyword">new</span> <span class="predefined-type">ConcurrentHashMap</span>&lt;<span class="predefined-type">Integer</span>, Person&gt;();

<span class="comment">// Define the ContinuousQueryListener</span>
ContinuousQueryListener&lt;<span class="predefined-type">Integer</span>, Person&gt; listener = <span class="keyword">new</span> ContinuousQueryListener&lt;<span class="predefined-type">Integer</span>, Person&gt;() {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> resultJoining(<span class="predefined-type">Integer</span> key, Person value) {
        matches.put(key, value);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> resultUpdated(<span class="predefined-type">Integer</span> key, Person value) {
        <span class="comment">// we do not process this event</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> resultLeaving(<span class="predefined-type">Integer</span> key) {
        matches.remove(key);
    }
};

<span class="comment">// Add the listener and the query</span>
continuousQuery.addContinuousQueryListener(query, listener);

[...]

<span class="comment">// Remove the listener to stop receiving notifications</span>
continuousQuery.removeContinuousQueryListener(listener);</code></pre> </div> </div> <div class="paragraph"> <p>As Person instances having an age less than 21 are added to the cache they will be received by the listener and will be placed into the <em>matches</em> map, and when these entries are removed from the cache or their age is modified to be greater or equal than 21 they will be removed from <em>matches</em>.</p> </div> </div> <div class="sect5"> <h6 id="removing_continuous_queries"><a class="anchor" href="#removing_continuous_queries"></a>Removing Continuous Queries</h6> <div class="paragraph"> <p>To stop the query from further execution just remove the listener:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">continuousQuery.removeContinuousQueryListener(listener);</code></pre> </div> </div> </div> <div class="sect5"> <h6 id="notes_on_performance_of_continuous_queries"><a class="anchor" href="#notes_on_performance_of_continuous_queries"></a>Notes on performance of Continuous Queries</h6> <div class="paragraph"> <p>Continuous queries are designed to provide a constant stream of updates to the application, potentially resulting in a very large number of events being generated for particularly broad queries. A new temporary memory allocation is made for each event. This behavior may result in memory pressure, potentially leading to <em>OutOfMemoryErrors</em> (especially in remote mode) if queries are not carefully designed. To prevent such issues it is strongly recommended to ensure that each query captures the minimal information needed both in terms of number of matched entries and size of each match (projections can be used to capture the interesting properties), and that each <em>ContinuousQueryListener</em> is designed to quickly process all received events without blocking and to avoid performing actions that will lead to the generation of new matching events from the cache it listens to.</p> </div> </div> </div> </div> </div> <div class="sect2"> <h3 id="query_remote"><a class="anchor" href="#query_remote"></a>1.3. Remote Querying</h3> <div class="paragraph"> <p>Apart from supporting indexing and searching of Java entities to embedded clients, Infinispan introduced support for remote, language neutral, querying.</p> </div> <div class="paragraph"> <p>This leap required two major changes:</p> </div> <div class="ulist"> <ul> <li> <p>Since non-JVM clients cannot benefit from directly using <a href="http://lucene.apache.org/">Apache Lucene</a>'s Java API, Infinispan defines its own new <a href="#query_dsl">query language</a>, based on an internal DSL that is easily implementable in all languages for which we currently have an implementation of the Hot Rod client.</p> </li> <li> <p>In order to enable indexing, the entities put in the cache by clients can no longer be opaque binary blobs understood solely by the client. Their structure has to be known to both server and client, so a common way of encoding structured data had to be adopted. Furthermore, allowing multi-language clients to access the data requires a language and platform-neutral encoding. Google&#8217;s <a href="http://code.google.com/p/protobuf/">Protocol Buffers</a> was elected as an encoding format for both over-the-wire and storage due to its efficiency, robustness, good multi-language support and support for schema evolution.</p> </li> </ul> </div> <div class="sect3"> <h4 id="storing_protobuf"><a class="anchor" href="#storing_protobuf"></a>1.3.1. Storing Protobuf encoded entities</h4> <div class="paragraph"> <p>Remote clients that want to be able to index and query their stored entities must do so using the Protobuf encoding format. This is <em>key</em> for the search capability to work. But it&#8217;s also possible to store Protobuf entities just for gaining the benefit of platform independence and not enable indexing if you do not need it.</p> </div> <div class="paragraph"> <p>Protobuf is all about structured data, so first thing you do to use it is define the structure of your data. This is accomplished by declaring protocol buffer message types in .proto files, like in the following example. Protobuf is a broad subject, we will not detail it here, so please consult the Protobuf <a href="https://developers.google.com/protocol-buffers/docs/overview">Developer Guide</a> for an in-depth explanation. It suffices to say for now that our example defines an entity (message type in protobuf speak) named <em>Book</em>, placed in a package named <em>book_sample</em>. Our entity declares several fields of primitive types and a repeatable field (an array basically) named <em>authors</em>. The <em>Author</em> message instances are embedded in the <em>Book</em> message instance.</p> </div> <div class="listingblock"> <div class="title">library.proto</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="proto">package book_sample;

message Book {
  required string title = 1;
  required string description = 2;
  required int32 publicationYear = 3; // no native Date type available in Protobuf

  repeated Author authors = 4;
}

message Author {
  required string name = 1;
  required string surname = 2;
}</code></pre> </div> </div> <div class="paragraph"> <p>There are a few important notes we need to make about Protobuf messages:</p> </div> <div class="ulist"> <ul> <li> <p>nesting of messages is possible, but the resulting structure is strictly a tree, never a graph</p> </li> <li> <p>there is no concept of type inheritance</p> </li> <li> <p>collections are not supported but arrays can be easily emulated using repeated fields</p> </li> </ul> </div> <div class="paragraph"> <p>Using Protobuf with the Java Hot Rod client is a two step process. First, the client must be configured to use a dedicated marshaller, <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/marshall/ProtoStreamMarshaller.html"><em>ProtoStreamMarshaller</em></a>. This marshaller uses the <a href="https://github.com/infinispan/protostream"><em>ProtoStream</em></a> library to assist you in encoding your objects. The second step is instructing <em>ProtoStream</em> library on how to marshall your message types. The following example highlights this process.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td> <td class="code"><pre><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.marshall.ProtoStreamMarshaller</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.protostream.SerializationContext</span>;
...

ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder.addServer()
    .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">10.1.2.3</span><span class="delimiter">&quot;</span></span>).port(<span class="integer">11234</span>)
    .marshaller(<span class="keyword">new</span> ProtoStreamMarshaller());

RemoteCacheManager remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());

SerializationContext serCtx = ProtoStreamMarshaller.getSerializationContext(remoteCacheManager);

FileDescriptorSource fds = <span class="keyword">new</span> FileDescriptorSource();
fds.addProtoFiles(<span class="string"><span class="delimiter">&quot;</span><span class="content">/library.proto</span><span class="delimiter">&quot;</span></span>);
serCtx.registerProtoFiles(fds);
serCtx.registerMarshaller(<span class="keyword">new</span> BookMarshaller());
serCtx.registerMarshaller(<span class="keyword">new</span> AuthorMarshaller());

<span class="comment">// Book and Author classes omitted for brevity</span></pre></td> </tr></table></code></pre> </div> </div> <div class="paragraph"> <p>The interesting part in this sample is obtaining the <em>SerializationContext</em> associated to the <em>RemoteCacheManager</em> and then instructing ProtoStream about the protobuf types we want to marshall. The <em>SerializationContext</em> is provided by the library for this purpose. The <code>SerializationContext.registerProtoFiles</code> method receives the name of one or more classpath resources that is expected to be a protobuf definition containing our type declarations.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> A <em>RemoteCacheManager</em> has no <em>SerializationContext</em> associated with it unless it was configured to use a <em>ProtoStreamMarshaller</em>. </td> </tr> </table> </div> <div class="paragraph"> <p>The next relevant part is the registration of per entity marshallers for our domain model types. They must be provided by the user for each type or marshalling will fail. Writing marshallers is a simple process. The <em>BookMarshaller</em> example should get you started. The most important thing you need to consider is they need to be stateless and threadsafe as a single instance of them is being used.</p> </div> <div class="listingblock"> <div class="title">BookMarshaller.java</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.protostream.MessageMarshaller</span>;
...

public <span class="type">class</span> <span class="class">BookMarshaller</span> <span class="directive">implements</span> MessageMarshaller&lt;<span class="predefined-type">Book</span>&gt; {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> getTypeName() {
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">book_sample.Book</span><span class="delimiter">&quot;</span></span>;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Book</span>&gt; getJavaClass() {
      <span class="keyword">return</span> <span class="predefined-type">Book</span>.class;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> writeTo(ProtoStreamWriter writer, <span class="predefined-type">Book</span> book) <span class="directive">throws</span> <span class="exception">IOException</span> {
      writer.writeString(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, book.getTitle());
      writer.writeString(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>, book.getDescription());
      writer.writeInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, book.getPublicationYear());
      writer.writeCollection(<span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>, book.getAuthors(), Author.class);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Book</span> readFrom(ProtoStreamReader reader) <span class="directive">throws</span> <span class="exception">IOException</span> {
      <span class="predefined-type">String</span> title = reader.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">String</span> description = reader.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>);
      <span class="type">int</span> publicationYear = reader.readInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">Set</span>&lt;Author&gt; authors = reader.readCollection(<span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;(), Author.class);
      <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">Book</span>(title, description, publicationYear, authors);
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>Once you&#8217;ve followed these steps to setup your client you can start reading and writing Java objects to the remote cache and the actual data stored in the cache will be protobuf encoded provided that marshallers were registered with the remote client for all involved types (<em>Book</em> and <em>Author</em> in our example). Keeping your objects stored in protobuf format has the benefit of being able to consume them with compatible clients written in different languages.</p> </div> <div class="paragraph"> <p>TODO Add reference to sample in C++ client user guide</p> </div> </div> <div class="sect3"> <h4 id="using_annotations"><a class="anchor" href="#using_annotations"></a>1.3.2. Using annotations</h4> <div class="paragraph"> <p>TODO</p> </div> </div> <div class="sect3"> <h4 id="indexing_of_protobuf_encoded_entries"><a class="anchor" href="#indexing_of_protobuf_encoded_entries"></a>1.3.3. Indexing of Protobuf encoded entries</h4> <div class="paragraph"> <p>After configuring the client as described in the previous section you can start configuring indexing for your caches on the server side. Activating indexing and the various indexing specific configurations is identical to embedded mode and is detailed in the <a href="#query_configuration_api">Querying Infinispan</a> chapter.</p> </div> <div class="paragraph"> <p>There is however an extra configuration step involved. While in embedded mode the indexing metadata is obtained via Java reflection by analyzing the presence of various Hibernate Search annotations on the entry&#8217;s class, this is obviously not possible if the entry is protobuf encoded. The server needs to obtain the relevant metadata from the same descriptor (.proto file) as the client. The descriptors are stored in a dedicated cache on the server named <em>'___protobuf_metadata'</em>. Both keys and values in this cache are plain strings. Registering a new schema is therefore as simple as performing a <em>put</em> operation on this cache using the schema&#8217;s name as key and the schema file itself as the value. Alternatively you can use the CLI (via the cache-container=*:register-proto-schemas() operation), the Management Console or the <em>ProtobufMetadataManager</em> MBean via JMX. Be aware that, when security is enabled, access to the schema cache via the remote protocols requires that the user belongs to the '___schema_manager' role.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Once indexing is enabled for a cache all fields of Protobuf encoded entries will be fully indexed unless you use the <em>@Indexed</em> and <em>@Field</em> protobuf schema pseudo-annotations in order to control precisely what fields need to get indexed. The default behaviour can be very inefficient when dealing with types having many or very larger fields so we encourage you to always specify what fields should be indexed instead of relying on the default indexing behaviour. The indexing behaviour for protobuf message types that are not annotated can also be modified per each schema file by setting the protobuf schema option <em>'indexed_by_default'</em> to <em>false</em> (its default value is considered <em>true</em>) at the beginning of your schema file. </td> </tr> </table> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="protobuf">option indexed_by_default = false;  // This disables indexing of types that are not annotated for indexing</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="a_remote_query_example"><a class="anchor" href="#a_remote_query_example"></a>1.3.4. A remote query example</h4> <div class="paragraph"> <p>You&#8217;ve managed to configure both client and server to talk protobuf and you&#8217;ve enabled indexing. Let&#8217;s put some data in the cache and try to search for it then!</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl</span>.*;
...

RemoteCacheManager remoteCacheManager = ...;
RemoteCache&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">Book</span>&gt; remoteCache = remoteCacheManager.getCache();

<span class="predefined-type">Book</span> book1 = <span class="keyword">new</span> <span class="predefined-type">Book</span>();
book1.setTitle(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate in Action</span><span class="delimiter">&quot;</span></span>);
remoteCache.put(<span class="integer">1</span>, book1);

<span class="predefined-type">Book</span> book2 = <span class="keyword">new</span> <span class="predefined-type">Book</span>();
book2.setTile(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate Search in Action</span><span class="delimiter">&quot;</span></span>);
remoteCache.put(<span class="integer">2</span>, book2);

QueryFactory qf = Search.getQueryFactory(remoteCache);
<span class="predefined-type">Query</span> query = qf.from(<span class="predefined-type">Book</span>.class)
            .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Hibernate Search%</span><span class="delimiter">&quot;</span></span>)
            .build();

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; list = query.list(); <span class="comment">// Voila! We have our book back from the cache!</span></code></pre> </div> </div> <div class="paragraph"> <p>The key part of creating a query is obtaining the <em>QueryFactory</em> for the remote cache using the <em>org.infinispan.client.hotrod.Search.getQueryFactory()</em> method. Once you have this creating the query is similar to embedded mode which is covered in <a href="#query_dsl">this</a> section.</p> </div> </div> <div class="sect3"> <h4 id="analysis"><a class="anchor" href="#analysis"></a>1.3.5. Analysis</h4> <div class="paragraph"> <p>Analysis is a process that converts input data into one or more terms that you can index and query.</p> </div> <div class="sect4"> <h5 id="default_analyzers"><a class="anchor" href="#default_analyzers"></a>Default Analyzers</h5> <div class="paragraph"> <p>Infinispan provides a set of default analyzers as follows:</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Definition</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>standard</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Splits text fields into tokens, treating whitespace and punctuation as delimiters.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>simple</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Tokenizes input streams by delimiting at non-letters and then converting all letters to lowercase characters. Whitespace and non-letters are discarded.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>whitespace</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Splits text streams on whitespace and returns sequences of non-whitespace characters as tokens.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>keyword</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Treats entire text fields as single tokens.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>stemmer</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Stems English words using the Snowball Porter filter.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>ngram</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Generates n-gram tokens that are 3 grams in size by default.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>filename</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Splits text fields into larger size tokens than the <code>standard</code> analyzer, treating whitespace as a delimiter and converts all letters to lowercase characters.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>These analyzer definitions are based on Apache Lucene and are provided "as-is". For more information about tokenizers, filters, and CharFilters, see the appropriate Lucene documentation.</p> </div> </div> <div class="sect4"> <h5 id="using_analyzer_definitions"><a class="anchor" href="#using_analyzer_definitions"></a>Using Analyzer Definitions</h5> <div class="paragraph"> <p>To use analyzer definitions, reference them by name in the <em>.proto</em> schema file.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Include the <code>Analyze.YES</code> attribute to indicate that the property is analyzed.</p> </li> <li> <p>Specify the analyzer definition with the <code>@Analyzer</code> annotation.</p> </li> </ol> </div> <div class="paragraph"> <p>The following example shows referenced analyzer definitions:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="protobuf">/* @Indexed */
message TestEntity {

    /* @Field(store = Store.YES, analyze = Analyze.YES, analyzer = @Analyzer(definition = &quot;keyword&quot;)) */
    optional string id = 1;

    /* @Field(store = Store.YES, analyze = Analyze.YES, analyzer = @Analyzer(definition = &quot;simple&quot;)) */
    optional string name = 2;
}</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="creating_custom_analyzer_definitions"><a class="anchor" href="#creating_custom_analyzer_definitions"></a>Creating Custom Analyzer Definitions</h5> <div class="paragraph"> <p>If you require custom analyzer definitions, do the following:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create an implementation of the <code>ProgrammaticSearchMappingProvider</code> interface packaged in a <code>JAR</code> file.</p> </li> <li> <p>Provide a file named <code>org.infinispan.query.spi.ProgrammaticSearchMappingProvider</code> in the <code>META-INF/services/</code> directory of your <code>JAR</code>. This file should contain the fully qualified class name of your implementation.</p> </li> <li> <p>Copy the <code>JAR</code> to the <code>standalone/deployments</code> directory of your Infinispan installation.</p> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="paragraph"> <p>Your deployment must be available to the Infinispan server during startup. You cannot add the deployment if the server is already running.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>The following is an example implementation of the <code>ProgrammaticSearchMappingProvider</code> interface:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.core.LowerCaseFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.core.StopFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.standard.StandardFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.standard.StandardTokenizerFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.cfg.SearchMapping</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.Cache</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.spi.ProgrammaticSearchMappingProvider</span>;

<span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">MyAnalyzerProvider</span> <span class="directive">implements</span> ProgrammaticSearchMappingProvider {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> defineMappings(Cache cache, SearchMapping searchMapping) {
      searchMapping
            .analyzerDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-with-stop</span><span class="delimiter">&quot;</span></span>, StandardTokenizerFactory.class)
               .filter(StandardFilterFactory.class)
               .filter(LowerCaseFilterFactory.class)
               .filter(StopFilterFactory.class);
   }
}</code></pre> </div> </div> </li> <li> <p>Specify the <code>JAR</code> in the cache container configuration, for example:</p> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;modules&gt;</span>
     <span class="tag">&lt;module</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">deployment.analyzers.jar</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/modules&gt;</span>
...</code></pre> </div> </div> </li> </ol> </div> </div> </div> </div> <div class="sect2"> <h3 id="statistics"><a class="anchor" href="#statistics"></a>1.4. Statistics</h3> <div class="paragraph"> <p>Query <a href="http://docs.jboss.org/hibernate/search/5.7/api/org/hibernate/search/stat/Statistics.html"><em>Statistics</em></a> can be obtained from the <em>SearchManager</em>, as demonstrated in the following code snippet.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">SearchManager searchManager = Search.getSearchManager(cache);
org.hibernate.search.stat.Statistics statistics = searchManager.getStatistics();</code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> This data is also available via JMX through the <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#_statisticsinfombean">Hibernate Search StatisticsInfoMBean</a> registered under the name <code>org.infinispan:type=Query,manager="{name-of-cache-manager}",cache="{name-of-cache}",component=Statistics</code>. Please note this MBean is always registered by Infinispan but the statistics are collected only if statistics collection is enabled at cache level. </td> </tr> </table> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Hibernate Search has its own configuration properties <code>hibernate.search.jmx_enabled</code> and <code>hibernate.search.generate_statistics</code> for JMX statistics as explained <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-monitoring">here</a>. Using them with Infinispan Query is forbidden as it will only lead to duplicated MBeans and unpredictable results. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="query_performance"><a class="anchor" href="#query_performance"></a>1.5. Performance Tuning</h3> <div class="sect3"> <h4 id="batch_writing_in_sync_mode"><a class="anchor" href="#batch_writing_in_sync_mode"></a>1.5.1. Batch writing in SYNC mode</h4> <div class="paragraph"> <p>By default, the <a href="#query_index_manager">Index Managers</a> work in sync mode, meaning when data is written to Infinispan, it will perform the indexing operations synchronously. This synchronicity guarantees indexes are always consistent with the data (and thus visible in searches), but can slowdown write operations since it will also perform a commit to the index. Committing is an extremely expensive operation in Lucene, and for that reason, multiple writes from different nodes can be automatically batched into a single commit to reduce the impact.</p> </div> <div class="paragraph"> <p>So, when doing data loads to Infinispan with index enabled, try to use multiple threads to take advantage of this batching.</p> </div> <div class="paragraph"> <p>If using multiple threads does not result in the required performance, an alternative is to load data with indexing temporarily disabled and run a <a href="#query_massindexer">re-indexing</a> operation afterwards. This can be done writing data with the <code>SKIP_INDEXING</code> flag:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">cache.getAdvancedCache().withFlags(Flag.SKIP_INDEXING).put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="writing_using_async_mode"><a class="anchor" href="#writing_using_async_mode"></a>1.5.2. Writing using async mode</h4> <div class="paragraph"> <p>If it&#8217;s acceptable a small delay between data writes and when that data is visible in queries, an index manager can be configured to work in <strong>async mode</strong>. The async mode offers much better writing performance, since in this mode commits happen at a configurable interval.</p> </div> <div class="paragraph"> <p>Configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              org.infinispan.query.indexmanager.InfinispanIndexManager
        <span class="tag">&lt;/property&gt;</span>
        <span class="comment">&lt;!-- Index data in async mode --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.worker.execution</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>async<span class="tag">&lt;/property&gt;</span>
        <span class="comment">&lt;!-- Optional: configure the commit interval, default is 1000ms --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.index_flush_interval</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>500<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="index_reader_async_strategy"><a class="anchor" href="#index_reader_async_strategy"></a>1.5.3. Index reader async strategy</h4> <div class="paragraph"> <p>Lucene internally works with snapshots of the index: once an <em>IndexReader</em> is opened, it will only see the index changes up to the point it was opened; further index changes will not be visible until the <em>IndexReader</em> is refreshed. The Index Managers used in Infinispan by default will check the freshness of the index readers before every query and refresh them if necessary.</p> </div> <div class="paragraph"> <p>It is possible to tune this strategy to relax this freshness checking to a pre-configured interval by using the <code>reader.strategy</code> configuration set as <code>async</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">key-partitioner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.distribution.ch.impl.AffinityPartitioner</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PRIMARY_OWNER</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              org.infinispan.query.affinity.AffinityIndexManager
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.reader.strategy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>async<span class="tag">&lt;/property&gt;</span>
        <span class="comment">&lt;!-- refresh reader every 1s, default is 5s --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.reader.async_refresh_period_ms</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>1000<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The async reader strategy is particularly useful for Index Managers that rely on shards, such as the AffinityIndexManager.</p> </div> </div> <div class="sect3"> <h4 id="lucene_options"><a class="anchor" href="#lucene_options"></a>1.5.4. Lucene Options</h4> <div class="paragraph"> <p>It is possible to apply tuning options in Lucene directly. For more details, see the <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#_lucene_configuration">Hibernate Search manual</a>.</p> </div> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2019-07-12 16:02:11 UTC </div> </div> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script> <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script> </body> </html>