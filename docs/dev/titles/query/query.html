<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Querying Infinispan caches</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GPD7V946LB"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-GPD7V946LB');
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css">
<link rel="stylesheet" href="../../css/css.css">
<link rel="stylesheet" href="/assets/css/clipboard.css">
<link rel="stylesheet" href="/assets/css/cookieconsent.css">
<link rel="shortcut icon" type="image/png" href="/favicon.ico" >
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script>
<script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
<script src="/assets/javascript/copy.js" type="text/javascript"></script>
<script src="/assets/javascript/cookieconsent.umd.js" type="text/javascript"></script>
<script src="/assets/javascript/cookieconsent.config.js" type="module"></script>
<script src="../../js/js.js"></script>
<link rel="canonical" href="https://infinispan.org/docs/stable/titles/query/query.html">
<style>
.hidden {
    display: none;
}

.switch {
    border-width: 1px 1px 0 1px;
    border-style: solid;
    border-color: #7a2518;
    display: inline-block;
}

.switch--item {
    padding: 10px;
    background-color: #ffffff;
    color: #7a2518;
    display: inline-block;
    cursor: pointer;
}

.switch--item.selected {
    background-color: #7a2519;
    color: #ffffff;
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script type="text/javascript">
function addBlockSwitches() {
    $('.primary').each(function() {
        primary = $(this);
        createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
        primary.children('.title').remove();
    });
    $('.secondary').each(function(idx, node) {
        secondary = $(node);
        primary = findPrimary(secondary);
        switchItem = createSwitchItem(secondary, primary.children('.switch'));
        switchItem.content.addClass('hidden');
        findPrimary(secondary).append(switchItem.content);
        secondary.remove();
    });
}

function createBlockSwitch(primary) {
    blockSwitch = $('<div class="switch"></div>');
    primary.prepend(blockSwitch);
    return blockSwitch;
}

function findPrimary(secondary) {
    candidate = secondary.prev();
    while (!candidate.is('.primary')) {
        candidate = candidate.prev();
    }
    return candidate;
}

function createSwitchItem(block, blockSwitch) {
    blockName = block.children('.title').text();
    content = block.children('.content').first().append(block.next('.colist'));
    item = $('<div class="switch--item">' + blockName + '</div>');
    item.on('click', '', content, function(e) {
        $(this).addClass('selected');
        $(this).siblings().removeClass('selected');
        e.data.siblings('.content').addClass('hidden');
        e.data.removeClass('hidden');
    });
    blockSwitch.append(item);
    return {'item': item, 'content': content};
}

$(addBlockSwitches);

</script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Querying Infinispan caches</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#indexing-caches">1. Indexing Infinispan caches</a>
<ul class="sectlevel2">
<li><a href="#indexing-caches_indexing-caches">1.1. Configuring Infinispan to index caches</a>
<ul class="sectlevel3">
<li><a href="#indexing-configuration_indexing-caches">1.1.1. Index configuration</a>
<ul class="sectlevel4">
<li><a href="#automatic_strategy_and_shared_cache_stores">Automatic strategy and shared cache stores</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#indexing-annotations_indexing-caches">1.2. Infinispan native indexing annotations</a>
<ul class="sectlevel3">
<li><a href="#'indexing-annotations-overview_indexing-caches`">1.2.1. Overview of the Infinispan indexing annotations</a></li>
</ul>
</li>
<li><a href="#rebuilding-indexes_indexing-caches">1.3. Rebuilding indexes</a></li>
<li><a href="#update-index-schema_indexing-caches">1.4. Updating index schema</a></li>
<li><a href="#non-indexed-queries_indexing-caches">1.5. Non-indexed queries</a></li>
</ul>
</li>
<li><a href="#ickle-query-language">2. Creating Ickle queries</a>
<ul class="sectlevel2">
<li><a href="#ickle-queries_ickle-query-language">2.1. Ickle queries</a>
<ul class="sectlevel3">
<li><a href="#pagination">2.1.1. Pagination</a></li>
<li><a href="#number_of_hits">2.1.2. Number of hits</a>
<ul class="sectlevel4">
<li><a href="#hit_count_accuracy">Hit count accuracy</a></li>
</ul>
</li>
<li><a href="#iteration">2.1.3. Iteration</a></li>
<li><a href="#named_query_parameters">2.1.4. Named query parameters</a></li>
<li><a href="#query_execution">2.1.5. Query execution</a></li>
</ul>
</li>
<li><a href="#ickle-query-syntax_ickle-query-language">2.2. Ickle query language syntax</a>
<ul class="sectlevel3">
<li><a href="#filtering_operators">2.2.1. Filtering operators</a></li>
<li><a href="#boolean_conditions">2.2.2. Boolean conditions</a></li>
<li><a href="#nested_conditions">2.2.3. Nested conditions</a></li>
<li><a href="#projections_with_select_statements">2.2.4. Projections with SELECT statements</a>
<ul class="sectlevel4">
<li><a href="#project_cache_entry_version">Project cache entry version</a></li>
<li><a href="#project_cache_entry_value">Project cache entry value</a></li>
<li><a href="#score_projection">Project the score</a></li>
</ul>
</li>
<li><a href="#ickle-query-syntax-nested-objects_joins_ickle-query-language">2.2.5. Nested objects joins</a>
<ul class="sectlevel4">
<li><a href="#nested_objects_joins_example">Nested objects joins: example</a></li>
</ul>
</li>
<li><a href="#grouping_and_aggregation">2.2.6. Grouping and aggregation</a></li>
<li><a href="#delete_statements">2.2.7. DELETE statements</a></li>
</ul>
</li>
<li><a href="#full-text-search_ickle-query-language">2.3. Full-text queries</a>
<ul class="sectlevel3">
<li><a href="#fuzzy_queries">2.3.1. Fuzzy queries</a></li>
<li><a href="#range_queries">2.3.2. Range queries</a></li>
<li><a href="#phrase_queries">2.3.3. Phrase queries</a></li>
<li><a href="#proximity_queries">2.3.4. Proximity queries</a></li>
<li><a href="#wildcard_queries">2.3.5. Wildcard queries</a></li>
<li><a href="#regular_expression_queries">2.3.6. Regular expression queries</a></li>
<li><a href="#boosting_queries">2.3.7. Boosting queries</a></li>
</ul>
</li>
<li><a href="#vector-search_ickle-query-language">2.4. Vector search queries</a>
<ul class="sectlevel3">
<li><a href="#vector_search_parameters">2.4.1. Vector search parameters</a></li>
<li><a href="#score_projection_with_vector_search">2.4.2. Score projection with vector search</a></li>
<li><a href="#filtering_entities">2.4.3. Filtering entities</a></li>
<li><a href="#vector_field_attributes">2.4.4. Vector field attributes</a>
<ul class="sectlevel4">
<li><a href="#similarity">Similarity</a></li>
<li><a href="#beanwidth">Beanwidth</a></li>
<li><a href="#max_connections">Max Connections</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spatial_search_ickle-query-language">2.5. Spatial queries</a>
<ul class="sectlevel3">
<li><a href="#spatial_fields_mapping">2.5.1. Spatial fields mapping</a>
<ul class="sectlevel4">
<li><a href="#spatial_mapping_geopoint">Spatial mapping: <code>@GeoPoint</code></a></li>
<li><a href="#spatial_mapping_geofield">Spatial mapping: <code>@GeoField</code></a></li>
</ul>
</li>
<li><a href="#spatial_predicates">2.5.2. Spatial predicates</a>
<ul class="sectlevel4">
<li><a href="#spatial_predicate_circle">Spatial predicate: <code>circle</code></a></li>
<li><a href="#spatial_predicate_box">Spatial predicate: <code>box</code></a></li>
<li><a href="#spatial_predicate_polygon">Spatial predicate: <code>polygon</code></a></li>
</ul>
</li>
<li><a href="#spatial_sorting">2.5.3. Spatial sorting</a></li>
<li><a href="#spatial_projections">2.5.4. Spatial projections</a></li>
<li><a href="#spatial_search_unit_ickle-query-language">2.5.5. Supported unit measures</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#query-remote">3. Querying remote caches</a>
<ul class="sectlevel2">
<li><a href="#querying-hot-rod_query-remote">3.1. Querying caches from Hot Rod Java clients</a></li>
<li><a href="#querying-protostream-common-types_query-remote">3.2. Querying ProtoStream common types</a></li>
<li><a href="#querying-console_query-remote">3.3. Querying caches from Infinispan Console and CLI</a></li>
<li><a href="#using-analyzers_query-remote">3.4. Using analyzers with remote caches</a>
<ul class="sectlevel3">
<li><a href="#default-analyzers_query-remote">3.4.1. Default analyzer definitions</a></li>
<li><a href="#creating-analyzers_query-remote">3.4.2. Creating custom analyzer definitions</a></li>
</ul>
</li>
<li><a href="#queries_by_keys_query-remote">3.5. Queries by keys</a>
<ul class="sectlevel3">
<li><a href="#key_property_name">3.5.1. Key property name</a></li>
<li><a href="#key_include_depth">3.5.2. Key include depth</a></li>
</ul>
</li>
<li><a href="#queries_server_tasks_query-remote">3.6. Remote queries from server tasks</a></li>
</ul>
</li>
<li><a href="#query-embedded">4. Querying embedded caches</a>
<ul class="sectlevel2">
<li><a href="#querying-embedded-caches_query-embedded">4.1. Querying embedded caches</a></li>
<li><a href="#entity-mapping-annotations_query-embedded">4.2. Entity mapping annotations</a></li>
</ul>
</li>
<li><a href="#query-continuous">5. Creating continuous queries</a>
<ul class="sectlevel2">
<li><a href="#continuous-queries_query-continuous">5.1. Continuous queries</a>
<ul class="sectlevel3">
<li><a href="#continuous-query-performance_query-continuous">5.1.1. Continuous queries and Infinispan performance</a></li>
</ul>
</li>
<li><a href="#creating-continuous-queries_query-continuous">5.2. Creating continuous queries</a></li>
</ul>
</li>
<li><a href="#query-monitoring-tuning">6. Monitoring and tuning Infinispan queries</a>
<ul class="sectlevel2">
<li><a href="#getting-query-statistics_query-monitoring-tuning">6.1. Getting query statistics</a></li>
<li><a href="#tuning-query-performance_query-monitoring-tuning">6.2. Tuning query performance</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Use the Ickle query language with Infinispan caches to efficiently and quickly gain real-time insights into your data.
Learn how to configure indexing and perform queries on remote and embedded caches.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="indexing-caches"><a class="anchor" href="#indexing-caches"></a>1. Indexing Infinispan caches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan can create indexes of values in your caches to improve query performance, providing faster results than non-indexed queries.
Indexing also lets you use full-text search capabilities in your queries.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan uses <a href="http://lucene.apache.org/">Apache Lucene</a> technology to index values in caches.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="indexing-caches_indexing-caches"><a class="anchor" href="#indexing-caches_indexing-caches"></a>1.1. Configuring Infinispan to index caches</h3>
<div class="paragraph">
<p>Enable indexing in your cache configuration and specify which entities Infinispan should include when creating indexes.</p>
</div>
<div class="paragraph">
<p>You should always configure Infinispan to index caches when using queries.
Indexing provides a significant performance boost to your queries, allowing you to get faster insights into your data.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enable indexing in your cache configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing&gt;
    &lt;!-- Indexing configuration goes here. --&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Adding an <code>indexing</code> element to your configuration enables indexing without the need to include the <code>enabled=true</code> attribute.</p>
</div>
<div class="paragraph">
<p>For remote caches adding this element also implicitly configures encoding as ProtoStream.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Specify the entities to index with the <code>indexed-entity</code> element.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing&gt;
    &lt;indexed-entities&gt;
      &lt;indexed-entity&gt;...&lt;/indexed-entity&gt;
    &lt;/indexed-entities&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="protobuf_messages" class="discrete">Protobuf messages</h4>
<div class="ulist">
<ul>
<li>
<p>Specify the message declared in the schema as the value of the <code>indexed-entity</code> element, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing&gt;
    &lt;indexed-entities&gt;
      &lt;indexed-entity&gt;org.infinispan.sample.Car&lt;/indexed-entity&gt;
      &lt;indexed-entity&gt;org.infinispan.sample.Truck&lt;/indexed-entity&gt;
    &lt;/indexed-entities&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration indexes the <code>Book</code> message in a schema with the <code>book_sample</code> package name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">package book_sample;

/* @Indexed */
message Book {

    /* @Text(projectable = true) */
    optional string title = 1;

    /* @Text(projectable = true) */
    optional string description = 2;

    // no native Date type available in Protobuf
    optional int32 publicationYear = 3;

    repeated Author authors = 4;
}

message Author {
    optional string name = 1;
    optional string surname = 2;
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
<h4 id="java_objects" class="discrete">Java objects</h4>
<div class="ulist">
<ul>
<li>
<p>Specify the fully qualified name (FQN) of each class that includes the <code>@Indexed</code> annotation.</p>
</li>
</ul>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing&gt;
    &lt;indexed-entities&gt;
      &lt;indexed-entity&gt;book_sample.Book&lt;/indexed-entity&gt;
    &lt;/indexed-entities&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import org.infinispan.configuration.cache.*;

ConfigurationBuilder config=new ConfigurationBuilder();
config.indexing().enable().storage(FILESYSTEM).path("/some/folder").addIndexedEntity(Book.class);</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../../apidocs/org/infinispan/configuration/cache/IndexingConfigurationBuilder.html"><code>org.infinispan.configuration.cache.IndexingConfigurationBuilder</code></a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="indexing-configuration_indexing-caches"><a class="anchor" href="#indexing-configuration_indexing-caches"></a>1.1.1. Index configuration</h4>
<div class="paragraph">
<p>Infinispan configuration controls how indexes are stored and constructed.</p>
</div>
<h5 id="index_storage" class="discrete">Index storage</h5>
<div class="paragraph">
<p>You can configure how Infinispan stores indexes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On the host file system, which is the default and persists indexes between restarts.</p>
</li>
<li>
<p>In JVM heap memory, which means that indexes do not survive restarts.<br>
You should store indexes in JVM heap memory only for small datasets.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">File system</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing storage="filesystem" path="${java.io.tmpdir}/baseDir"&gt;
    &lt;!-- Indexing configuration goes here. --&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">JVM heap memory</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing storage="local-heap"&gt;
    &lt;!-- Additional indexing configuration goes here. --&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<h6 id="index_path" class="discrete">Index path</h6>
<div class="paragraph">
<p>Specifies a filesystem path for the index when storage is 'filesystem'.
The value can be a relative or absolute path. Relative paths are created
relative to the configured global persistent location, or to the current
working directory when global state is disabled.</p>
</div>
<div class="paragraph">
<p>By default, the cache name is used as a relative path for index path.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When setting a custom value, ensure that there are no conflicts between caches using the same indexed entities.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="indexing-configuration_startup-mode" class="discrete">Index startup mode</h5>
<div class="paragraph">
<p>When Infinispan starts caches it can perform operations to ensure the index is consistent with data in the cache.
By default it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Automatically clear (purge) or reindex the cache.</p>
<div class="ulist">
<ul>
<li>
<p>If data is volatile and the index is persistent then Infinispan performs the clear (purge) the indexes when it starts.</p>
</li>
<li>
<p>If data is persistent and the index is volatile then Infinispan reindex the cache when it starts.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The purge operation is performed synchronously, since it is usually very fast. So by the time the cache finishes to start, the operation will be completed.
The cache becomes available only when the purge completes.</p>
</div>
<div class="paragraph">
<p>The reindex operation is performed asynchronously, since it might take a longer time to complete, depending on the size of the cache.
If an indexed query is performed during the reindex the result could be partial.
It is always possible to check if a reindex is ongoing accessing to <a href="../query/query.html#getting-query-statistics_query-monitoring-tuning">the query statistics</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>But you can manually configure it to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Purge the index when the cache starts.</p>
</li>
<li>
<p>Reindex the cache when it starts.</p>
</li>
<li>
<p>No indexing operation takes place when a cache starts</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the case of a manual configuration can lead to possible inconsistencies,
a log message will be presented when the cache starts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Clear the index when the cache starts</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing storage="filesystem" startup-mode="purge"&gt;
    &lt;!-- Additional indexing configuration goes here. --&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Rebuild the index when the cachin this case</div>
<p>a warning message will be logged when the cache is startede starts</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing storage="local-heap" startup-mode="reindex"&gt;
    &lt;!-- Additional indexing configuration goes here. --&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="automatic_strategy_and_shared_cache_stores"><a class="anchor" href="#automatic_strategy_and_shared_cache_stores"></a>Automatic strategy and shared cache stores</h5>
<div class="paragraph">
<p>In case of:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A shared storage is configured</p>
</li>
<li>
<p>The indexes are persistent on file system</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>AUTO</code> startup mode will apply the <code>REINDEX</code> strategy.
This is done in order to not miss potential updates in case of crash and recovery of an indexed node.</p>
</div>
<div class="paragraph">
<p>Thus <code>AUTO</code> in this case may penalize the average user using a shared cache store that does not do any eviction,
since more reindex than necessary will be triggered.
For this reason if:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A shared storage is configured</p>
</li>
<li>
<p>The indexes are persistent on file system</p>
</li>
<li>
<p>Automatic evictions are not possible: cache memory <code>max-size</code> and <code>max-count</code> are not used</p>
</li>
<li>
<p>Manual eviction using the embedded API <code>cache.eviction()</code> is not used</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>to use <code>NONE</code> in place of <code>AUTO</code> as the index startup strategy.</p>
</div>
<h5 id="indexing_mode" class="discrete">Indexing mode</h5>
<div class="paragraph">
<p><code>indexing-mode</code> controls how cache operations are propagated to the indexes.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>auto</code></dt>
<dd>
<p>Infinispan immediately applies any changes to the cache to the indexes. This is the default mode.</p>
</dd>
<dt class="hdlist1"><code>manual</code></dt>
<dd>
<p>Infinispan updates indexes only when the reindex operation is explicitly invoked. Configure <code>manual</code> mode, for example, when you want to perform batch updates to the indexes.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Set the <code>indexing-mode</code> to <code>manual</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing indexing-mode="manual"&gt;
    &lt;!-- Additional indexing configuration goes here. --&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<h5 id="use_java_entities" class="discrete">Use Java Entities</h5>
<div class="paragraph">
<p>If the cache is protostream-encoded and the indexes initialized from a Infinispan server instance,
the indexed entities must be the indexed Protobuf messages defined on some Proto schema.
It is possible to change this behavior forcing the indexes be defined on the indexed entities that are discovered
from the java entities locally accessible from the server VM.
Useful in case we want to run embedded queries from a server task, in the case the cache is Protobuf encoded.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing use-java-embedded-entities="true"&gt;
    &lt;!-- Additional indexing configuration goes here. --&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<h5 id="index_reader" class="discrete">Index reader</h5>
<div class="paragraph">
<p>The index reader is an internal component that provides access to the indexes to perform queries. As the index content changes, Infinispan needs to refresh the reader so that search results are up to date.
You can configure the refresh interval for the index reader.
By default Infinispan reads the index before each query if the index changed since the last refresh.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing storage="filesystem" path="${java.io.tmpdir}/baseDir"&gt;
    &lt;!-- Sets an interval of one second for the index reader. --&gt;
    &lt;index-reader refresh-interval="1s"/&gt;
    &lt;!-- Additional indexing configuration goes here. --&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<h5 id="index_writer" class="discrete">Index writer</h5>
<div class="paragraph">
<p>The index writer is an internal component that constructs an index composed of one or more segments (sub-indexes) that can be merged over time to improve performance.
Fewer segments usually means less overhead during a query because index reader operations need to take into account all segments.</p>
</div>
<div class="paragraph">
<p>Infinispan uses Apache Lucene internally and indexes entries in two tiers: memory and storage.
New entries go to the memory index first and then, when a flush happens, to the configured index storage.
Periodic commit operations occur that create segments from the previously flushed data and make all the index changes permanent.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>index-writer</code> configuration is optional.
The defaults should work for most cases and custom configurations should only be used to tune performance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing storage="filesystem" path="${java.io.tmpdir}/baseDir"&gt;
    &lt;index-writer commit-interval="2s"
                  low-level-trace="false"
                  max-buffered-entries="32"
                  queue-count="1"
                  queue-size="10000"
                  ram-buffer-size="400"
                  thread-pool-size="2"&gt;
      &lt;index-merge calibrate-by-deletes="true"
                   factor="3"
                   max-entries="2000"
                   min-size="10"
                   max-size="20"/&gt;
    &lt;/index-writer&gt;
    &lt;!-- Additional indexing configuration goes here. --&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Index writer configuration attributes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commit-interval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Amount of time, in milliseconds, that index changes that are buffered in memory are flushed to the index storage and a commit is performed. Because operation is costly, small values should be avoided. The default is 1000 ms (1 second).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max-buffered-entries</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of entries that can be buffered in-memory before they are flushed to the index storage. Large values result in faster indexing but use more memory. When used in combination with the <code>ram-buffer-size</code> attribute, a flush occurs for whichever event happens first.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ram-buffer-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum amount of memory that can be used for buffering added entries and deletions before they are flushed to the index storage. Large values result in faster indexing but use more memory. For faster indexing performance you should set this attribute instead of <code>max-buffered-entries</code>. When used in combination with the <code>max-buffered-entries</code> attribute, a flush occurs for whichever event happens first.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>thread-pool-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This configuration is ignored since Infinispan 15.0. The indexing engine now uses the Infinispan thread pools.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>queue-count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default 4. Number of internal queues to use for each indexed type. Each queue holds a batch of modifications that is applied to the index and queues are processed in parallel. Increasing the number of queues will lead to an increase of indexing throughput, but only if the bottleneck is CPU.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>queue-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default 4000. Maximum number of elements each queue can hold. Increasing the <code>queue-size</code> value increases the amount of memory that is used during indexing operations. Setting a value that is too small can lead to <code>CacheBackpressureFullException</code> or <code>RejectedExecutionExceptionOperationSubmitter</code> since index operation requests are never blocked. In this case to solve the issue increase the <code>queue-size</code> or set the <code>queue-count</code> to 1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>low-level-trace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables low-level trace information for indexing operations. Enabling this attribute substantially degrades performance. You should use this low-level tracing only as a last resource for troubleshooting.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To configure how Infinispan merges index segments, you use the <code>index-merge</code> sub-element.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Index merge configuration attributes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max-entries</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of entries that an index segment can have before merging. Segments with more than this number of entries are not merged. Smaller values perform better on frequently changing indexes, larger values provide better search performance if the index does not change often.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>factor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of segments that are merged at once. With smaller values, merging happens more often, which uses more resources, but the total number of segments will be lower on average, increasing search performance. Larger values (greater than 10) are best for heavy writing scenarios.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>min-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Minimum target size of segments, in MB, for background merges. Segments smaller than this size are merged more aggressively. Setting a value that is too large might result in expensive merge operations, even though they are less frequent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum size of segments, in MB, for background merges. Segments larger than this size are never merged in the background. Settings this to a lower value helps reduce memory requirements and avoids some merging operations at the cost of optimal search speed. This attribute is ignored when forcefully merging an index and <code>max-forced-size</code> applies instead.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max-forced-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum size of segments, in MB, for forced merges and overrides the <code>max-size</code> attribute. Set this to the same value as <code>max-size</code> or lower. However setting the value too low degrades search performance because documents are deleted.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>calibrate-by-deletes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the number of deleted entries in an index should be taken into account when counting the entries in the segment. Setting <code>false</code> will lead to more frequent merges caused by <code>max-entries</code>, but will more aggressively merge segments with many deleted documents, improving query performance.</p></td>
</tr>
</tbody>
</table>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../../configuration-schema/index.html">Infinispan configuration schema reference</a></p>
</li>
</ul>
</div>
<h5 id="index_sharding" class="discrete">Index sharding</h5>
<div class="paragraph">
<p>When you have a large amount of data, you can configure Infinispan to split index data into multiple indexes called shards.
Enabling data distribution among shards improves performance.
By default, sharding is disabled.</p>
</div>
<div class="paragraph">
<p>Use the <code>shards</code> attribute to configure the number of indexes.
The number of shards must be greater then <code>1</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache&gt;
  &lt;indexing&gt;
    &lt;index-sharding shards="6" /&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="indexing-annotations_indexing-caches"><a class="anchor" href="#indexing-annotations_indexing-caches"></a>1.2. Infinispan native indexing annotations</h3>
<div class="paragraph">
<p>When you enable indexing in caches, you configure Infinispan to create indexes.
You also need to provide Infinispan with a structured representation of the entities in your caches so it can actually index them.</p>
</div>
<div class="sect3">
<h4 id="'indexing-annotations-overview_indexing-caches`"><a class="anchor" href="#'indexing-annotations-overview_indexing-caches`"></a>1.2.1. Overview of the Infinispan indexing annotations</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">@Indexed</dt>
<dd>
<p>Indicates entities, or Protobuf message types, that Infinispan indexes.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To indicate the fields that Infinispan indexes use the indexing annotations.
You can use these annotations the same way for both embedded and remote queries.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">@Basic</dt>
<dd>
<p>Supports any type of field.
Use the <code>@Basic</code> annotation for numbers and short strings that don&#8217;t require any transformation or processing.</p>
</dd>
<dt class="hdlist1">@Decimal</dt>
<dd>
<p>Use this annotation for fields that represent decimal values.</p>
</dd>
<dt class="hdlist1">@Keyword</dt>
<dd>
<p>Use this annotation for fields that are strings and intended for exact matching.
Keyword fields are not analyzed or tokenized during indexing.</p>
</dd>
<dt class="hdlist1">@Text</dt>
<dd>
<p>Use this annotation for fields that contain textual data and are intended for full-text search capabilities. You can use the analyzer to process the text and to generate individual tokens.</p>
</dd>
<dt class="hdlist1">@Vector</dt>
<dd>
<p>Use this annotation to mark vector fields representing embeddings, on which can be defined kNN-predicates.</p>
</dd>
<dt class="hdlist1">@Embedded</dt>
<dd>
<p>Use this annotation to mark a field as an embedded object within the parent entity.
The <code>NESTED</code> structure preserves the original object relationship structure while the <code>FLATTENED</code> structure makes the leaf fields multivalued of the parent entity.
The default structure used by <code>@Embedded</code> is <code>NESTED</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><code>NESTED</code> embedded can be used in <a href="../query/query.html#ickle-query-syntax-nested-objects_joins_ickle-query-language">nested objects joins</a>.</p>
</div>
<div class="paragraph">
<p>Each of the annotations supports a set of attributes that you can use to further describe how the entity is indexed.</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<caption class="title">Table 3. Infinispan annotations and supported attributes</caption>
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Supported attributes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">@Basic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">searchable, sortable, projectable, aggregable, indexNullAs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">@Decimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">searchable, sortable, projectable, aggregable, indexNullAs, decimalScale</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">@Keyword</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">searchable, sortable, projectable, aggregable, indexNullAs, normalizer, norms</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">@Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">searchable, projectable, norms, analyzer, searchAnalyzer
, termVector</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">@Vector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">searchable, projectable, dimension, similarity, beamWidth, maxConnections</p></td>
</tr>
</tbody>
</table>
<h4 id="using_infinispan_annotations" class="discrete">Using Infinispan annotations</h4>
<div class="paragraph">
<p>You can provide Infinispan with indexing annotations in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Annotate your Java classes or fields directly using the Infinispan annotations.<br>
You then generate or update your Protobuf schema, <code>.proto</code> files, before uploading them to Infinispan Server.</p>
</li>
<li>
<p>Annotate Protobuf schema directly with <code>@Indexed</code> and <code>@Basic</code>, <code>@Keyword</code> or <code>@Text</code>.<br>
You then upload your Protobuf schema to Infinispan Server.</p>
<div class="paragraph">
<p>For example, the following schema uses the <code>@Text</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">/**
  * @Text(projectable = true)
  */
required string street = 1;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rebuilding-indexes_indexing-caches"><a class="anchor" href="#rebuilding-indexes_indexing-caches"></a>1.3. Rebuilding indexes</h3>
<div class="paragraph">
<p>Rebuilding an index reconstructs it from the data stored in the cache.
You should rebuild indexes when you change things like the definitions of indexed types or analyzers.
Likewise, you can rebuild indexes after you delete them for whatever reason.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Rebuilding indexes can take a long time to complete because the process takes place for all data in the grid.
While the rebuild operation is in progress, queries might also return fewer results.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Rebuild indexes in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Call the <code>reindexCache()</code> method to programmatically rebuild an index from a Hot Rod Java client:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">remoteCacheManager.administration().reindexCache("MyCache");</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For remote caches you can also rebuild indexes from Infinispan Console.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Call the <code>index.run()</code> method to rebuild indexes for embedded caches as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Indexer indexer = Search.getIndexer(cache);
CompletionStage&lt;Void&gt; future = index.run();</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Check the status of reindexing operation with the <code>reindexing</code> attribute of the index statistics.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="update-index-schema_indexing-caches"><a class="anchor" href="#update-index-schema_indexing-caches"></a>1.4. Updating index schema</h3>
<div class="paragraph">
<p>The update index schema operation lets you add schema changes with a minimal downtime.
Instead of removing previously indexed data and recreating the index schema, Infinispan adds new fields to the existing schema.
Updating index schema is much faster than rebuilding the index but you can update schema only when your changes do not affect fields that were already indexed.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can update index schema only when your changes does not affect previously indexed fields.
When you change index field definitions or when you delete fields, you must rebuild the index.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Update index schema for a given cache:</p>
<div class="ulist">
<ul>
<li>
<p>Call the <code>updateIndexSchema()</code> method to programmatically update the index schema from a Hot Rod Java client:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">remoteCacheManager.administration().updateIndexSchema("MyCache");</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For remote caches, you can update index schema from the Infinispan Console or using the <a href="../rest/rest.html#rest_v2_query_updateIndexSchema">REST API</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../query/query.html#rebuilding-indexes_indexing-caches">Rebuilding indexes</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="non-indexed-queries_indexing-caches"><a class="anchor" href="#non-indexed-queries_indexing-caches"></a>1.5. Non-indexed queries</h3>
<div class="paragraph">
<p>Infinispan recommends indexing caches for the best performance for queries.
However you can query caches that are non-indexed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For embedded caches, you can perform non-indexed queries on Plain Old Java Objects (POJOs).</p>
</li>
<li>
<p>For remote caches, you must use ProtoStream encoding with the <code>application/x-protostream</code> media type to perform non-indexed queries.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ickle-query-language"><a class="anchor" href="#ickle-query-language"></a>2. Creating Ickle queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan provides an Ickle query language that lets you create relational and full-text queries.</p>
</div>
<div class="sect2">
<h3 id="ickle-queries_ickle-query-language"><a class="anchor" href="#ickle-queries_ickle-query-language"></a>2.1. Ickle queries</h3>
<div class="paragraph">
<p>To use the API, call the cache <code>.query()</code> method and provide the query string.</p>
</div>
<div class="paragraph">
<p>For instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Remote Query using protobuf
Query&lt;Transaction&gt; q = remoteCache.query("from sample_bank_account.Transaction where amount &gt; 20");

// Embedded Query using Java Objects
Query&lt;Book&gt; q = cache.query("from org.infinispan.sample.Book where price &gt; 20");

// Execute the query
QueryResult&lt;Book&gt; queryResult = q.execute();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A query will always target a single entity type and is evaluated over the contents of a single cache. Running a query over multiple caches or creating queries that target several entity types (joins) is not supported.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Executing the query and fetching the results is as simple as invoking the <code>execute()</code> method of the <code>Query</code> object. Once
executed, calling <code>execute()</code> on the same instance will re-execute the query.</p>
</div>
<div class="sect3">
<h4 id="pagination"><a class="anchor" href="#pagination"></a>2.1.1. Pagination</h4>
<div class="paragraph">
<p>You can limit the number of returned results by using  the <code>Query.maxResults(int maxResults)</code>. This can be used in
conjunction with <code>Query.startOffset(long startOffset)</code> to achieve pagination of the result set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// sorted by year and match all books that have "clustering" in their title
// and return the third page of 10 results
Query&lt;Book&gt; query = cache.query("FROM org.infinispan.sample.Book WHERE title like '%clustering%' ORDER BY year").startOffset(20).maxResults(10)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you don&#8217;t explicitly set the <code>maxResults</code> for a query instance, Infinispan limits the number of results returned by the query to <code>100</code>.
You can change the default limit by setting the <code>query.default-max-results</code> cache property.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="number_of_hits"><a class="anchor" href="#number_of_hits"></a>2.1.2. Number of hits</h4>
<div class="paragraph">
<p>The <code>QueryResult</code> object includes the <code>.hitCount()</code> method, which returns a hit count value that represents the total number of results from a query, regardless of any pagination parameter.</p>
</div>
<div class="paragraph">
<p>Additionally, <code>QueryResult</code> object contains a boolean value returned by the <code>.isExact()</code> method which indicates whether the hit count number is exact or a lower bound.
The hit count is only available for indexed queries for performance reasons.</p>
</div>
<div class="sect4">
<h5 id="hit_count_accuracy"><a class="anchor" href="#hit_count_accuracy"></a>Hit count accuracy</h5>
<div class="paragraph">
<p>You can limit the required accuracy of hit counts by setting <code>hit-count-accuracy</code> attribute.
When dealing with large data sets, precise hit counts can impact performance.
Setting a limit to the hit count accuracy, lets you achieve faster query responses while ensuring that the provided hit counts remain sufficiently accurate for your application&#8217;s needs.</p>
</div>
<div class="paragraph">
<p>The default accuracy of the <code>hit-count-accuracy</code> attribute is limited to <code>10000</code>.
This means that for any query, Infinispan provides exact hit count up to maximum of 10,000.
If the effective hit count is higher than 10,000, Infinispan returns a lower bound estimate of the count.
You can change the default limit by setting the <code>query.hit-count-accuracy</code> cache property.
Alternatively, it can be set on each query instance.</p>
</div>
<div class="paragraph">
<p>When the actual hit count exceeds the limit set by the <code>hit-count-accuracy</code>, the <code>.isExact()</code> method or the <code>hit_count_exact</code> JSON field will be <code>false</code>, indicating that the returned hit count is an estimation.
Setting this value to <code>Integer.MAX</code> would return accurate results for any query, but this can severely impact query performance.</p>
</div>
<div class="paragraph">
<p>For optimal performance set the property value slightly above the expected hit count. If you do not require accurate hit counts, set it to a low value.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="iteration"><a class="anchor" href="#iteration"></a>2.1.3. Iteration</h4>
<div class="paragraph">
<p>The <code>Query</code> object has the <code>.iterator()</code> method to obtain the results lazily. It returns an instance of <code>CloseableIterator</code> that must be closed after usage.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The iteration support for Remote Queries is currently limited, as it will first fetch all entries to the client
before iterating.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="named_query_parameters"><a class="anchor" href="#named_query_parameters"></a>2.1.4. Named query parameters</h4>
<div class="paragraph">
<p>Instead of building a new Query object for every execution it is possible to include named parameters in the query which
can be substituted with actual values before execution. This allows a query to be defined once and be efficiently
executed many times. Parameters can only be used on the right-hand side of an operator and are defined when the query is
created by supplying an object produced by the <code>org.infinispan.query.dsl.Expression.param(String paramName)</code> method to
the operator instead of the usual constant value. Once the parameters have been defined they can be set by invoking either
<code>Query.setParameter(parameterName, value)</code> or <code>Query.setParameters(parameterMap)</code> as shown in the examples below.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Defining a query to search for various authors and publication years
Query&lt;Book&gt; query = cache.query("SELECT title FROM org.infinispan.sample.Book WHERE author = :authorName AND publicationYear = :publicationYear").build();

// Set actual parameter values
query.setParameter("authorName", "Doe");
query.setParameter("publicationYear", 2010);

// Execute the query
List&lt;Book&gt; found = query.execute().list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can supply a map of actual parameter values to set multiple parameters at once:
</p>
</div>
<div class="listingblock">
<div class="title">Setting multiple named parameters at once</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Map&lt;String, Object&gt; parameterMap = new HashMap&lt;&gt;();
parameterMap.put("authorName", "Doe");
parameterMap.put("publicationYear", 2010);

query.setParameters(parameterMap);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A significant portion of the query parsing, validation and execution planning effort is performed during the first
execution of a query with parameters. This effort is not repeated during subsequent executions leading to better
performance compared to a similar query using constant values instead of query parameters.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="query_execution"><a class="anchor" href="#query_execution"></a>2.1.5. Query execution</h4>
<div class="paragraph">
<p>The <code>Query</code> API provides two methods for executing Ickle queries on a cache:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Query.execute()</code> runs a SELECT statement and returns a result.</p>
</li>
<li>
<p><code>Query.executeStatement()</code> runs a DELETE statement and modifies data.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You should always invoke <code>executeStatement()</code> to modify data and invoke <code>execute()</code> to get the result of a query.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../../apidocs/org/infinispan/query/dsl/Query.html#execute()">org.infinispan.query.dsl.Query.execute()</a></p>
</li>
<li>
<p><a href="../../apidocs/org/infinispan/query/dsl/Query.html#executeStatement()">org.infinispan.query.dsl.Query.executeStatement()</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ickle-query-syntax_ickle-query-language"><a class="anchor" href="#ickle-query-syntax_ickle-query-language"></a>2.2. Ickle query language syntax</h3>
<div class="paragraph">
<p>The Ickle query language is subset of the <a href="https://en.wikipedia.org/wiki/Java_Persistence_Query_Language">JPQL</a> query language, with some extensions for full-text.</p>
</div>
<div class="paragraph">
<p>The parser syntax has some notable rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Whitespace is not significant.</p>
</li>
<li>
<p>Wildcards are not supported in field names.</p>
</li>
<li>
<p>A field name or path must always be specified, as there is no default field.</p>
</li>
<li>
<p><code>&amp;&amp;</code> and <code>||</code> are accepted instead of <code>AND</code> or <code>OR</code> in both full-text and JPA predicates.</p>
</li>
<li>
<p><code>!</code> may be used instead of <code>NOT</code>.</p>
</li>
<li>
<p>A missing boolean operator is interpreted as <code>OR</code>.</p>
</li>
<li>
<p>String terms must be enclosed with either single or double quotes.</p>
</li>
<li>
<p>Fuzziness and boosting are not accepted in arbitrary order; fuzziness always comes first.</p>
</li>
<li>
<p><code>!=</code> is accepted instead of <code>&lt;&gt;</code>.</p>
</li>
<li>
<p>Boosting cannot be applied to <code>&gt;</code>,<code>&gt;=</code>,<code>&lt;</code>,<code>&lt;=</code> operators. Ranges may be used to achieve the same result.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="filtering_operators"><a class="anchor" href="#filtering_operators"></a>2.2.1. Filtering operators</h4>
<div class="paragraph">
<p>Ickle support many filtering operators that can be used for both indexed and non-indexed fields.</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>in</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left operand is equal to one of the elements from the Collection of values given as argument.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FROM Book WHERE isbn IN ('ZZ', 'X1234')</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>like</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be a String) matches a wildcard pattern that follows the JPA rules.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FROM Book WHERE title LIKE '%Java%'</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>=</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is an exact match of the given value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FROM Book WHERE name = 'Programming Java'</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>!=</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is different from the given value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FROM Book WHERE language != 'English'</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is greater than the given value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FROM Book WHERE price &gt; 20</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&gt;=</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is greater than or equal to the given value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FROM Book WHERE price &gt;= 20</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is less than the given value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FROM Book WHERE year &lt; 2020</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;=</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is less than or equal to the given value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FROM Book WHERE price  &#8656; 50</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>between</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is between the given range limits.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FROM Book WHERE price BETWEEN 50 AND 100</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="boolean_conditions"><a class="anchor" href="#boolean_conditions"></a>2.2.2. Boolean conditions</h4>
<div class="paragraph">
<p>Combining multiple attribute conditions with logical conjunction (<code>and</code>) and disjunction (<code>or</code>) operators in order to
create more complex conditions is demonstrated in the following example. The well known operator precedence rule for
boolean operators applies here, so the order of the operators is irrelevant. Here <code>and</code>
operator still has higher priority than <code>or</code> even though <code>or</code> was invoked first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql"># match all books that have "Data Grid" in their title
# or have an author named "Manik" and their description contains "clustering"

FROM org.infinispan.sample.Book WHERE title LIKE '%Data Grid%' OR author.name = 'Manik' AND description like '%clustering%'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Boolean negation has highest precedence among logical operators and applies only to the next simple attribute condition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql"># match all books that do not have "Data Grid" in their title and are authored by "Manik"
FROM org.infinispan.sample.Book WHERE title != 'Data Grid' AND author.name = 'Manik'</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="nested_conditions"><a class="anchor" href="#nested_conditions"></a>2.2.3. Nested conditions</h4>
<div class="paragraph">
<p>Changing the precedence of logical operators is achieved with parenthesis:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql"># match all books that have an author named "Manik" and their title contains
# "Data Grid" or their description contains "clustering"
FROM org.infinispan.sample.Book WHERE author.name = 'Manik' AND ( title like '%Data Grid%' OR description like '% clustering%')</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="projections_with_select_statements"><a class="anchor" href="#projections_with_select_statements"></a>2.2.4. Projections with SELECT statements</h4>
<div class="paragraph">
<p>In some use cases returning the whole domain object is overkill if only a small subset of the attributes are actually
used by the application, especially if the domain entity has embedded entities. The query language allows you to specify
a subset of attributes (or attribute paths) to return - the projection. If projections are used then the <code>QueryResult.list()</code>
will not return the whole domain entity but will return a <code>List</code> of <code>Object[]</code>, each slot in the array corresponding to
a projected attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql"># match all books that have "Data Grid" in their title or description
# and return only their title and publication year
SELECT title, publicationYear FROM org.infinispan.sample.Book WHERE title like '%Data Grid%' OR description like '%Data Grid%'</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="project_cache_entry_version"><a class="anchor" href="#project_cache_entry_version"></a>Project cache entry version</h5>
<div class="paragraph">
<p>It is possible to project the cache entry version, using the <code>version</code> projection function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql"># return the title, publication year and the cache entry version
SELECT b.title, b.publicationYear, version(b) FROM org.infinispan.sample.Book b WHERE b.title like '%Data Grid%'</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="project_cache_entry_value"><a class="anchor" href="#project_cache_entry_value"></a>Project cache entry value</h5>
<div class="paragraph">
<p>It is possible to project the cache entry value together with other projections.
It can be used for instance to project the cache entry value together with the cache entry version
in the same <code>Object[]</code> returned hit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql"># return the cache entry value and the cache entry version
SELECT b, version(b) FROM org.infinispan.sample.Book b WHERE b.title like '%Data Grid%'</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="score_projection"><a class="anchor" href="#score_projection"></a>Project the score</h5>
<div class="paragraph">
<p>If the query is indexed, it is possible to project the score obtained by each matching together with other projections.
It can be used for instance to project the cache entry value together with the score
in the same <code>Object[]</code> returned hit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql"># return the cache entry value and the the score of the matching
SELECT b, score(b) FROM org.infinispan.sample.Book b WHERE b.title like '%Data Grid%'</code></pre>
</div>
</div>
<h4 id="sorting" class="discrete">Sorting</h4>
<div class="paragraph">
<p>Ordering the results based on one or more attributes or attribute paths is done with the <code>ORDER BY</code> clause. If multiple sorting criteria
are specified, then the order will dictate their precedence.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql"># match all books that have "Data Grid" in their title or description
# and return them sorted by the publication year and title
FROM org.infinispan.sample.Book WHERE title like '%Data Grid%' ORDER BY publicationYear DESC, title ASC</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ickle-query-syntax-nested-objects_joins_ickle-query-language"><a class="anchor" href="#ickle-query-syntax-nested-objects_joins_ickle-query-language"></a>2.2.5. Nested objects joins</h4>
<div class="paragraph">
<p>When multivalued <a href="../query/query.html#indexing-annotations-overview_indexing-caches"><code>NESTED</code> embedded entities</a> are defined on a parent entity,
it is possible to treat the parent / embedded relation as a one to many relation.
This means that the <code>join</code> operator can be used to select all the parent entities that contain an embedded
entity satisfying some conditions.
This is in general not possible if the embedded reference is marked as <code>FLATTENED</code>, because in this case the
embedded fields will be treated as (multivalued) parent entity fields.</p>
</div>
<div class="sect4">
<h5 id="nested_objects_joins_example"><a class="anchor" href="#nested_objects_joins_example"></a>Nested objects joins: example</h5>
<div class="paragraph">
<p>Suppose we have a parent entity <code>Team</code> having <code>Player</code> as a multivalued nested embedded entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Proto
@Indexed
public record Team(@Basic String name, @Embedded(structure = Structure.NESTED) List&lt;Player&gt; firstTeam, @Embedded(structure = Structure.FLATTENED) List&lt;Player&gt; replacements) {

   @ProtoSchema(includeClasses = {Team.class, Player.class}, schemaPackageName = "model")
   public interface TeamSchema extends GeneratedSchema {
      TeamSchema INSTANCE = new TeamSchemaImpl();
   }
}

@Proto
public record Player(@Basic String name, @Basic String color, @Basic Integer number) {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given this mapping, the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">select t.name from model.Team t join t.firstTeam p where (p.color ='red' AND p.number=7) or (p.color='blue' AND p.number=7)</code></pre>
</div>
</div>
<div class="paragraph">
<p>will return all the teams present on the system having at least one player in the first team group
in turn having number 7 and color red or blue.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="grouping_and_aggregation"><a class="anchor" href="#grouping_and_aggregation"></a>2.2.6. Grouping and aggregation</h4>
<div class="paragraph">
<p>Infinispan has the ability to group query results according to a set of grouping fields and construct aggregations of
the results from each group by applying an aggregation function to the set of values that fall into each group.
Grouping and aggregation can only be applied to projection queries (queries with one or more field in the SELECT clause).</p>
</div>
<div class="paragraph">
<p>The supported aggregations are: <code>avg</code>, <code>sum</code>, <code>count</code>, <code>max</code>, and <code>min</code>.</p>
</div>
<div class="paragraph">
<p>The set of grouping fields is specified with the <code>GROUP BY</code> clause and the order used for defining grouping fields is
not relevant. All fields selected in the projection must either be grouping fields
or else they must be aggregated using one of the grouping functions described below. A projection field can be
aggregated and used for grouping at the same time. A query that selects only grouping fields but no aggregation fields
is legal.

Example: Grouping Books by author and counting them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT author, COUNT(title) FROM org.infinispan.sample.Book WHERE title LIKE '%engine%' GROUP BY author</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A projection query in which all selected fields have an aggregation function applied and no fields are used for
grouping is allowed. In this case the aggregations will be computed globally as if there was a single global group.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="aggregations" class="discrete">Aggregations</h5>
<div class="paragraph">
<p>You can apply the following aggregation functions to a field:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Index merge attributes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Aggregation function</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>avg()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Computes the average of a set of numbers. Accepted values are primitive numbers and instances of <code>java.lang.Number</code>. The result is represented as <code>java.lang.Double</code>. If there are no non-null values the result is <code>null</code> instead.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>count()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counts the number of non-null rows and returns a <code>java.lang.Long</code>. If there are no non-null values the result is <code>0</code> instead.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the greatest value found. Accepted values must be instances of <code>java.lang.Comparable</code>. If there are no non-null values the result is <code>null</code> instead.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>min()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the smallest value found. Accepted values must be instances of <code>java.lang.Comparable</code>. If there are no non-null values the result is <code>null</code> instead.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sum()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Computes the sum of a set of Numbers. If there are no non-null values the result is <code>null</code> instead. The following table indicates the return type based on the specified field.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Table sum return type</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Type</th>
<th class="tableblock halign-left valign-top">Return Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integral (other than BigInteger)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Float or Double</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Double</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigInteger</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigInteger</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
</tr>
</tbody>
</table>
<h5 id="evaluation_of_queries_with_grouping_and_aggregation" class="discrete">Evaluation of queries with grouping and aggregation</h5>
<div class="paragraph">
<p>Aggregation queries can include filtering conditions, like usual queries. Filtering can be performed in two stages: before
and after the grouping operation. All filter conditions defined before invoking the <code>groupBy()</code> method will be applied
before the grouping operation is performed, directly to the cache entries (not to the final projection). These filter
conditions can reference any fields of the queried entity type, and are meant to restrict the data set that is going to
be the input for the grouping stage. All filter conditions defined after invoking the <code>groupBy()</code> method will be applied to
the projection that results from the projection and grouping operation. These filter conditions can either reference any
of the <code>groupBy()</code> fields or aggregated fields. Referencing aggregated fields that are not specified in the select clause
is allowed; however, referencing non-aggregated and non-grouping fields is forbidden. Filtering in this phase will
reduce the amount of groups based on their properties. Sorting can also be specified similar to usual queries. The
ordering operation is performed after the grouping operation and can reference any of the <code>groupBy()</code> fields or aggregated
fields.</p>
</div>
</div>
<div class="sect3">
<h4 id="delete_statements"><a class="anchor" href="#delete_statements"></a>2.2.7. DELETE statements</h4>
<div class="paragraph">
<p>You can delete entities from Infinispan caches with the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">DELETE FROM &lt;entityName&gt; [WHERE condition]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Reference only single entities with <code>&lt;entityName&gt;</code>. DELETE queries cannot use joins.</p>
</li>
<li>
<p>WHERE conditions are optional.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>DELETE queries cannot use any of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Projections with SELECT statements</p>
</li>
<li>
<p>Grouping and aggregation</p>
</li>
<li>
<p>ORDER BY clauses</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Invoke the <code>Query.executeStatement()</code> method to execute DELETE statements.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../../apidocs/org/infinispan/query/dsl/Query.html#executeStatement()">org.infinispan.query.dsl.Query.executeStatement()</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="full-text-search_ickle-query-language"><a class="anchor" href="#full-text-search_ickle-query-language"></a>2.3. Full-text queries</h3>
<div class="paragraph">
<p>You can perform full-text searches with the Ickle query language.</p>
</div>
<div class="sect3">
<h4 id="fuzzy_queries"><a class="anchor" href="#fuzzy_queries"></a>2.3.1. Fuzzy queries</h4>
<div class="paragraph">
<p>To execute a fuzzy query add <code>~</code> along with an integer, representing the distance from the term used, after the term.
For instance</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">FROM sample_bank_account.Transaction WHERE description : 'cofee'~2</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="range_queries"><a class="anchor" href="#range_queries"></a>2.3.2. Range queries</h4>
<div class="paragraph">
<p>To execute a range query define the given boundaries within a pair of braces, as seen in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">FROM sample_bank_account.Transaction WHERE amount : [20 to 50]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="phrase_queries"><a class="anchor" href="#phrase_queries"></a>2.3.3. Phrase queries</h4>
<div class="paragraph">
<p>A group of words can be searched by surrounding them in quotation marks, as seen in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">FROM sample_bank_account.Transaction WHERE description : 'bus fare'</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proximity_queries"><a class="anchor" href="#proximity_queries"></a>2.3.4. Proximity queries</h4>
<div class="paragraph">
<p>To execute a proximity query, finding two terms within a specific distance, add a <code>~</code> along with the distance after the phrase.
For instance, the following example will find the words canceling and fee provided they are not more than 3 words apart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">FROM sample_bank_account.Transaction WHERE description : 'canceling fee'~3</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="wildcard_queries"><a class="anchor" href="#wildcard_queries"></a>2.3.5. Wildcard queries</h4>
<div class="paragraph">
<p>To search for "text" or "test", use the <code>?</code> single-character wildcard search:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">FROM sample_bank_account.Transaction where description : 'te?t'</code></pre>
</div>
</div>
<div class="paragraph">
<p>To search for "test", "tests", or "tester", use the <code>*</code> multi-character wildcard search:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">FROM sample_bank_account.Transaction where description : 'test*'</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="regular_expression_queries"><a class="anchor" href="#regular_expression_queries"></a>2.3.6. Regular expression queries</h4>
<div class="paragraph">
<p>Regular expression queries can be performed by specifying a pattern between <code>/</code>. Ickle uses Lucenes regular expression syntax, so to search for the words <code>moat</code> or <code>boat</code> the following could be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">FROM sample_library.Book  where title : /[mb]oat/</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="boosting_queries"><a class="anchor" href="#boosting_queries"></a>2.3.7. Boosting queries</h4>
<div class="paragraph">
<p>Terms can be boosted by adding a <code>^</code> after the term to increase their relevance in a given query, the higher the boost factor the more relevant the term will be. For instance to search for titles containing beer and wine with a higher relevance on beer, by a factor of 3, the following could be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">FROM sample_library.Book WHERE title : beer^3 OR wine</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vector-search_ickle-query-language"><a class="anchor" href="#vector-search_ickle-query-language"></a>2.4. Vector search queries</h3>
<div class="paragraph">
<p>You can perform vector kNN searches with the Ickle query language using the special operator <code>&lt;-&gt;</code> to define predicates.</p>
</div>
<div class="paragraph">
<p>This is an example of kNN query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">from play.Item i where i.myVector &lt;-&gt; [7,7,7]~3</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query will find the items that have the <code>myVector</code> fields that are within <code>3</code> nearest neighbourhood from the vector <code>[7,7,7]</code>.</p>
</div>
<div class="paragraph">
<p>Notice that in order to use this kind of search the entity, in our example <code>play.Item</code>, has to be <code>@Indexed</code> and
the field, in our example <code>myVector</code>, should be annotated with <code>@Vector</code>.</p>
</div>
<div class="paragraph">
<p>We support two kinds of vector field types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>byte</code> / <code>Byte</code> (to work with byte vectors)</p>
</li>
<li>
<p><code>float</code> / <code>Float</code> (to work with float vectors)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can have different vector fields on the same entity, but in any case you can have only one vector predicate on your queries.</p>
</div>
<div class="sect3">
<h4 id="vector_search_parameters"><a class="anchor" href="#vector_search_parameters"></a>2.4.1. Vector search parameters</h4>
<div class="paragraph">
<p>Both the k-value and the vector can be passed as query parameter.
The k-value scalar can be expressed with the usual placeholder <code>:k</code> in the Ickle text.
For the vector we can use either a placeholder for each term of the vector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Query&lt;Item&gt; query = cache.query("from play.Item i where i.floatVector &lt;-&gt; [:a,:b,:c]~:k");
query.setParameter("a", 1);
query.setParameter("b", 4.3);
query.setParameter("c", 3.3);
query.setParameter("k", 4);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or a placeholder can be used for the entire vector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Query&lt;Item&gt; query = cache.query("from play.Item i where i.floatVector &lt;-&gt; [:a]~:k");
query.setParameter("a", new float[]{7.1f, 7.0f, 3.1f});
query.setParameter("k", 3);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="score_projection_with_vector_search"><a class="anchor" href="#score_projection_with_vector_search"></a>2.4.2. Score projection with vector search</h4>
<div class="paragraph">
<p>Is very common also to return the score of the computation, using the <a href="../query/query.html#score_projection">score projection</a>.
In the case of vector search the query will be like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Query&lt;Object[]&gt; query = cache.query("select i, score(i) from play.Item i where i.floatVector &lt;-&gt; [:a]~:k");
query.setParameter("a", new float[]{7.1f, 7.0f, 3.1f});
query.setParameter("k", 3);

List&lt;Object[]&gt; resultList = query.list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the first element of each array will contain the entity,
and the second element will contain the score of the matching.</p>
</div>
</div>
<div class="sect3">
<h4 id="filtering_entities"><a class="anchor" href="#filtering_entities"></a>2.4.3. Filtering entities</h4>
<div class="paragraph">
<p>Instead of applying the kNN search to the entire population of entities of a given type,
you can limiting the searching set applying classic predicates (match, full-text-search, range, &#8230;&#8203;) to the kNN queries,
defining what we call a filtering clause.</p>
</div>
<div class="paragraph">
<p>A filtering clause can contain any kind of predicates with the only exception of kNN predicates that cannot be included.</p>
</div>
<div class="paragraph">
<p>For instance the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Query&lt;Object[]&gt; query = remoteCache.query(
   "select score(i), i from Item i where i.floatVector &lt;-&gt; [:a]~:k filtering (i.buggy : 'cat' or i.text : 'code')");
query.setParameter("a", new float[]{7, 7, 7});
query.setParameter("k", 3);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Will return the nearest 3 items from the point <code>[7,7,7]</code> selecting only the items that have a text containing the term <code>cat</code> or <code>code</code>.</p>
</div>
<div class="paragraph">
<p>The filtering queries is a way to apply the classic indexed search to the new vector search.</p>
</div>
</div>
<div class="sect3">
<h4 id="vector_field_attributes"><a class="anchor" href="#vector_field_attributes"></a>2.4.4. Vector field attributes</h4>
<div class="paragraph">
<p>It is always required to specify the <strong>dimension</strong> of the vector field.</p>
</div>
<div class="paragraph">
<p>The other mapping attributes are optional, since Infinispan will have a default for each of them.
You can configure them, for instance, to tune the desired accuracy / performance.</p>
</div>
<div class="sect4">
<h5 id="similarity"><a class="anchor" href="#similarity"></a>Similarity</h5>
<div class="paragraph">
<p>Different <code>VectorSimilarity</code> algorithms are supported</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Distance</th>
<th class="tableblock halign-left valign-top">Score</th>
<th class="tableblock halign-left valign-top">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>L2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(d(x,y) = \sqrt{\sum_{i=1}^{n} (x_i - y_i)^2 } \)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(s = \frac{1}{1+d^2}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the Infinispan default</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INNER_PRODUCT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(d(x,y) = \sum_{i=1}^{n} x_i \cdot y_i \)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(s = \frac{1}{1+d}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To use this similarity efficiently, both index and search vectors must be normalized</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MAX_INNER_PRODUCT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(d(x,y) = \sum_{i=1}^{n} x_i \cdot y_i \)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s = \begin{cases}
\frac{1}{1-d} &amp; \text{if d &lt; 0}\\
d+1 &amp; \text{otherwise}
\end{cases}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This similarity does not require vector normalization</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>COSINE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(d(x,y) = \frac{1 - \sum_{i=1} ^{n} x_i \cdot y_i }{ \sqrt{ \sum_{i=1} ^{n} x_i^2 } \sqrt{ \sum_{i=1} ^{n} y_i^2 }} \)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(s = \frac{1}{1+d}\)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This similarity cannot be of <code>zero magnitude</code>, e.g. when a vector is all zeroes: <code>[0,0,0,&#8230;&#8203; 0,0]</code>, the cosine is not defined and will result in an error.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="beanwidth"><a class="anchor" href="#beanwidth"></a>Beanwidth</h5>
<div class="paragraph">
<p>Changing the <code>beamWidth</code> you can modify the the size of the dynamic list used during k-NN graph creation.
It affects how vectors are stored. Higher values lead to a more accurate graph but slower indexing speed.
The Infinispan default is 512.</p>
</div>
</div>
<div class="sect4">
<h5 id="max_connections"><a class="anchor" href="#max_connections"></a>Max Connections</h5>
<div class="paragraph">
<p>The number of neighbors each node will be connected to in the HNSW graph.
Modifying this value will have an impact on memory consumption. It is recommended to keep this value between 2 and 100.
The Infinispan default is 16.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spatial_search_ickle-query-language"><a class="anchor" href="#spatial_search_ickle-query-language"></a>2.5. Spatial queries</h3>
<div class="paragraph">
<p>It is possible to define spatial fields in the index domain that can be queried using spatial predicates.</p>
</div>
<div class="paragraph">
<p>A spatial field denotes a spatial point that is represented by a pair of geographical coordinatees:
the latitude and the longitude.</p>
</div>
<div class="paragraph">
<p>When entities are added to an indexed cache, and their type is configured to be indexed,
the mapped spatial fields will be included in the indexes and available for querying.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Spatial queries are not supported by non-indexed queries.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="spatial_fields_mapping"><a class="anchor" href="#spatial_fields_mapping"></a>2.5.1. Spatial fields mapping</h4>
<div class="sect4">
<h5 id="spatial_mapping_geopoint"><a class="anchor" href="#spatial_mapping_geopoint"></a>Spatial mapping: <code>@GeoPoint</code></h5>
<div class="paragraph">
<p>This option uses a type-level indexing annotation <code>@GeoPoint</code> for each spatial field to be defined.
One or more `@GeoPoint`s can be added to the indexed entity.</p>
</div>
<div class="paragraph">
<p>The only mandatory attribute is the <code>fieldName</code> attribute and it is used to denote the field name in the index domain.
If more than one <code>@GeoPoint</code> are defined on the same entity, their names must be different.</p>
</div>
<div class="paragraph">
<p>For each of them, we require to have on the same entity two double-typed fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>one annotated with <code>@Latitude</code>, that will store the latitude of the given point</p>
</li>
<li>
<p>one annotated with <code>@Longitude</code>, that will store the longitude of the given point</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Where <code>@Latitude</code> and <code>@Longitude</code> must have <code>fieldName</code> attribute
equals to the <code>fieldName</code> attribute of the corresponding <code>@GeoPoint</code> annotation.</p>
</div>
<div class="paragraph">
<p>Here is an example of an entity defining two points: <code>departure</code> and <code>arrival</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. TrainRoute</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">@Proto <i class="conum" data-value="1"></i><b>(1)</b>
@Indexed
@GeoPoint(fieldName = "departure", projectable = true, sortable = true) <i class="conum" data-value="2"></i><b>(2)</b>
@GeoPoint(fieldName = "arrival", projectable = true, sortable = true) <i class="conum" data-value="3"></i><b>(3)</b>
public record TrainRoute(
      @Keyword(normalizer = "lowercase") String name,
      @Latitude(fieldName = "departure") Double departureLat, <i class="conum" data-value="4"></i><b>(4)</b>
      @Longitude(fieldName = "departure") Double departureLon, <i class="conum" data-value="5"></i><b>(5)</b>
      @Latitude(fieldName = "arrival") Double arrivalLat, <i class="conum" data-value="6"></i><b>(6)</b>
      @Longitude(fieldName = "arrival") Double arrivalLon <i class="conum" data-value="7"></i><b>(7)</b>
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@Proto</code> annotation, indicating that the entity is supposed to be used for remote queries</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A <code>departure</code> point. Optionally sortable and projectable.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>An <code>arrival</code> point. Optionally sortable and projectable.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>departure</code> 's latitude.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>departure</code> 's longitude.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <code>arrival</code> 's latitude.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The <code>arrival</code> 's longitude.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Also a single point can be defined, here is an example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Restaurant</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">@Proto
@Indexed
@GeoPoint(fieldName = "location", projectable = true, sortable = true) <i class="conum" data-value="1"></i><b>(1)</b>
public record Restaurant(
      @Keyword(normalizer = "lowercase", projectable = true, sortable = true) String name,
      @Text String description,
      @Text String address,
      @Latitude(fieldName = "location") Double latitude, <i class="conum" data-value="2"></i><b>(2)</b>
      @Longitude(fieldName = "location") Double longitude, <i class="conum" data-value="3"></i><b>(3)</b>
      @Basic Float score
) {

   @ProtoSchema( <i class="conum" data-value="4"></i><b>(4)</b>
         includeClasses = { Restaurant.class, TrainRoute.class }, <i class="conum" data-value="5"></i><b>(5)</b>
         schemaFileName = "geo.proto",
         schemaPackageName = "geo",
         syntax = ProtoSyntax.PROTO3
   )
   public interface RestaurantSchema extends GeneratedSchema {
      RestaurantSchema INSTANCE = new RestaurantSchemaImpl();
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A <code>location</code> point. Optionally sortable and projectable.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>location</code> 's latitude.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>location</code> 's longitude.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Generate a protobuf schema for the specified entities</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="spatial_mapping_geofield"><a class="anchor" href="#spatial_mapping_geofield"></a>Spatial mapping: <code>@GeoField</code></h5>
<div class="paragraph">
<p>Alternatively, the special field types <code>*.LatLng</code> can be used to define spatial fields.
The spatial fields (or the corresponding properties) must be also annotated with <code>@GeoField</code>.</p>
</div>
<div class="paragraph">
<p>Here is an example of embedded query mapping using <code>@GeoField</code> annotations on <code>LatLng</code> fields:</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Hiking</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">import org.infinispan.api.annotations.indexing.model.LatLng; <i class="conum" data-value="1"></i><b>(1)</b>

@Indexed
public record Hiking(@Keyword String name, @GeoField LatLng start, @GeoField LatLng end) { <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For embedded queries, use <code>org.infinispan.api.annotations.indexing.model.LatLng</code> as type for any spatial field.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the spatial fields with <code>@GeoField</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Here is an example of remote query mapping using <code>@GeoField</code> annotations on <code>LatLng</code> fields:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. ProtoHiking</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">import org.infinispan.commons.api.query.geo.LatLng; <i class="conum" data-value="1"></i><b>(1)</b>

@Proto
@Indexed
public record ProtoHiking(@Keyword String name, @GeoField LatLng start, @GeoField LatLng end) { <i class="conum" data-value="2"></i><b>(2)</b>

   @ProtoSchema(
         dependsOn = LatLng.LatLngSchema.class, <i class="conum" data-value="3"></i><b>(3)</b>
         includeClasses = ProtoHiking.class,
         schemaFileName = "hiking.proto",
         schemaPackageName = "geo",
         syntax = ProtoSyntax.PROTO3
   )
   public interface ProtoHikingSchema extends GeneratedSchema {
      ProtoHikingSchema INSTANCE = new ProtoHikingSchemaImpl();
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For remote queries, use <code>org.infinispan.commons.api.query.geo.LatLng</code> as type for any spatial field.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the spatial fields with <code>@GeoField</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The schema must be generated with the explicit dependency on <code>LatLng.LatLngSchema.class</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The corresponding proto schema for remote queries will be:</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. hiking.proto</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Proto hljs" data-lang="Proto">syntax = "proto3";
package geo;

import "latlng.proto";

/**
 * @Indexed
 */
message ProtoHiking {

   /**
    * @Keyword
    */
   string name = 1;

   /**
    * @GeoField
    */
   google.type.LatLng start = 2; <i class="conum" data-value="1"></i><b>(1)</b>

   /**
    * @GeoField
    */
   google.type.LatLng end = 3; <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Google standard type <code>google.type.LatLng</code> will be used to store spatial fields in the data domain.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="spatial_predicates"><a class="anchor" href="#spatial_predicates"></a>2.5.2. Spatial predicates</h4>
<div class="sect4">
<h5 id="spatial_predicate_circle"><a class="anchor" href="#spatial_predicate_circle"></a>Spatial predicate: <code>circle</code></h5>
<div class="paragraph">
<p>This predicate selects entities having points within a given distance from a center point.</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. Within circle</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">Query&lt;Restaurant&gt; query = cache.query("from geo.Restaurant r where r.location within circle(41.91, 12.46, :distance)"); <i class="conum" data-value="1"></i><b>(1)</b>
query.setParameter("distance", 100); <i class="conum" data-value="2"></i><b>(2)</b>
List&lt;Restaurant&gt; list = query.list();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We select all the restaurants within 100 meters from a given center, in this case 41.91, 12.46.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Parameters can be extracted for all the values passed to the <code>within circle</code> predicate.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>By default, meters will be applied as distance unit.
It is possible to change it, for instance using kilometers:</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. Within circle specifying a different unit measure</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">Query&lt;Restaurant&gt; query = cache.query("from geo.Restaurant r where r.location within circle(41.91, 12.46, :distance km)"); <i class="conum" data-value="1"></i><b>(1)</b>
query.setParameter("distance", 0.1); <i class="conum" data-value="2"></i><b>(2)</b>
List&lt;Restaurant&gt; list = query.list();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We select all the restaurants within 0.1 Km from a given center, in this case 41.91, 12.46.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Parameters can be extracted for all the values passed to the <code>within circle</code> predicate.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>See <a href="../query/query.html#spatial_search_unit_ickle-query-language">Supported unit measures</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="spatial_predicate_box"><a class="anchor" href="#spatial_predicate_box"></a>Spatial predicate: <code>box</code></h5>
<div class="paragraph">
<p>This predicate selects entities having points contained in a given rectangle (or box).
The <code>within box</code> predicate has arity 4 and it takes as argument:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The latitude of the top left box point.</p>
</li>
<li>
<p>The longitude of the top left box point.</p>
</li>
<li>
<p>The latitude of the bottom right box point.</p>
</li>
<li>
<p>The longitude of the bottom right box point.</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="title">Example 8. Within box</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">Query&lt;Restaurant&gt; query = cache.query("from geo.Restaurant r where r.location within box(41.91, 12.45, 41.90, 12.46)"); <i class="conum" data-value="1"></i><b>(1)</b>
List&lt;Restaurant&gt; list = query.list();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We select all the restaurants contained in the given box.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="spatial_predicate_polygon"><a class="anchor" href="#spatial_predicate_polygon"></a>Spatial predicate: <code>polygon</code></h5>
<div class="paragraph">
<p>This predicate selects entities having points within an arbitrary polygon.
The <code>within polygon</code> predicate has n-arity, and each argument is a geo point expressed in terms of latitude and longitude.
Each point is enclosed by brackets.</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. Within polygon</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">Query&lt;Restaurant&gt; query = cache.query("from geo.Restaurant r where r.location within polygon((41.91, 12.45), (41.91, 12.46), (41.90, 12.46), (41.90, 12.46))"); <i class="conum" data-value="1"></i><b>(1)</b>
List&lt;Restaurant&gt; list = query.list();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We select all the restaurants contained in the polygon identified by the provided vertex points.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="spatial_sorting"><a class="anchor" href="#spatial_sorting"></a>2.5.3. Spatial sorting</h4>
<div class="paragraph">
<p>Use any spatial field to sort the query result.
In particular the result can be sorted according to the distance from a given point (the query point),
by default in ascending order, to any spatial point owned by the entity.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In this case the spatial field must be sortable, by setting the attribute <code>sortable</code> to <code>true</code> of the corresponding <code>@GeoPoint</code>
or <code>@GeoField</code> annotation used to map the spatial field.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an example of usage:</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. Order by distance</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">Query&lt;Restaurant&gt; query = cache.query("from geo.Restaurant r order by distance(r.location, 41.91, 12.46)"); <i class="conum" data-value="1"></i><b>(1)</b>
List&lt;Restaurant&gt; list = query.list();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Restaurants are ordered according to their distances from the given query point (41.91, 12.46).</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="spatial_projections"><a class="anchor" href="#spatial_projections"></a>2.5.4. Spatial projections</h4>
<div class="paragraph">
<p>Project the distance between a given point (query point) and an entity&#8217;s spatial field by using the <code>distance</code> predicate in the <code>from</code> clause.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In this case the spatial field must be projectable, setting the <code>projectable</code> attribute  to <code>true</code> of the corresponding <code>@GeoPoint</code>
or <code>@GeoField</code> annotation used to map the spatial field.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an example of usage:</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. Project the distances</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">Query&lt;Object[]&gt; projectQuery = remoteCache.query("select r.name, distance(r.location, 41.91, 12.46) from geo.Restaurant r"); <i class="conum" data-value="1"></i><b>(1)</b>
List&lt;Object[]&gt; projectList = projectQuery.list();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pair the restaurant names with their respective distances from the query point (41.91, 12.46).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Also for spatial projections it is possible to change the default unit measure (meters).
Here is an example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 12. Project the distances specifying a different unit measure</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">Query&lt;Object[]&gt; projectQuery = remoteCache.query("select r.name, distance(r.location, 41.91, 12.46, yd) from geo.Restaurant r"); <i class="conum" data-value="1"></i><b>(1)</b>
List&lt;Object[]&gt; projectList = projectQuery.list();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pair the restaurant names with their respective distances (using yards as unit measure) from the query point (41.91, 12.46).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>See <a href="../query/query.html#spatial_search_unit_ickle-query-language">Supported unit measures</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="spatial_search_unit_ickle-query-language"><a class="anchor" href="#spatial_search_unit_ickle-query-language"></a>2.5.5. Supported unit measures</h4>
<div class="paragraph">
<p>These are the supported unit measures that can be used in spatial queries:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Supported unit measure</th>
<th class="tableblock halign-left valign-top">Symbol to use in the query</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">METERS (default)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>m</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KILOMETERS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>km</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MILES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mi</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">YARDS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>yd</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NAUTICAL_MILES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nm</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="query-remote"><a class="anchor" href="#query-remote"></a>3. Querying remote caches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can index and query remote caches on Infinispan Server.</p>
</div>
<div class="sect2">
<h3 id="querying-hot-rod_query-remote"><a class="anchor" href="#querying-hot-rod_query-remote"></a>3.1. Querying caches from Hot Rod Java clients</h3>
<div class="paragraph">
<p>Infinispan lets you programmatically query remote caches from Java clients through the Hot Rod endpoint.
This procedure explains how to index query a remote cache that stores <code>Book</code> instances.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Add the ProtoStream processor to your <code>pom.xml</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Infinispan provides this processor for the <code>@ProtoField</code> annotations so you can generate Protobuf schemas and perform queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
      &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
      &lt;version&gt;...&lt;/version&gt;
      &lt;configuration&gt;
        &lt;annotationProcessorPaths&gt;
          &lt;annotationProcessorPath&gt;
            &lt;groupId&gt;org.infinispan.protostream&lt;/groupId&gt;
            &lt;artifactId&gt;protostream-processor&lt;/artifactId&gt;
            &lt;version&gt;...&lt;/version&gt;
          &lt;/annotationProcessorPath&gt;
        &lt;/annotationProcessorPaths&gt;
      &lt;/configuration&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add indexing annotations to your class, as in the following example:</p>
<div class="listingblock">
<div class="title">Book.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.infinispan.api.annotations.indexing.Basic;
import org.infinispan.api.annotations.indexing.Indexed;
import org.infinispan.api.annotations.indexing.Text;
import org.infinispan.protostream.annotations.ProtoFactory;
import org.infinispan.protostream.annotations.ProtoField;

@Indexed
public class Book {

   @Text
   @ProtoField(number = 1)
   final String title;

   @Text
   @ProtoField(number = 2)
   final String description;

   @Basic
   @ProtoField(number = 3, defaultValue = "0")
   final int publicationYear;

   @ProtoFactory
   Book(String title, String description, int publicationYear) {
      this.title = title;
      this.description = description;
      this.publicationYear = publicationYear;
   }
   // public Getter methods omitted for brevity
}</code></pre>
</div>
</div>
</li>
<li>
<p>Implement the <code>SerializationContextInitializer</code> interface in a new class and then add the <code>@ProtoSchema</code> annotation.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Reference the class that includes the <code>@ProtoField</code> annotations with the <code>includeClasses</code> parameter.</p>
</li>
<li>
<p>Define a name for the Protobuf schema that you generate and filesystem path with the <code>schemaFileName</code> and <code>schemaFilePath</code> parameters.</p>
</li>
<li>
<p>Specify the package name for the Protobuf schema with the <code>schemaPackageName</code> parameter.</p>
<div class="listingblock">
<div class="title">RemoteQueryInitializer.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.infinispan.protostream.SerializationContextInitializer;
import org.infinispan.protostream.annotations.ProtoSchema;

@ProtoSchema(
      includeClasses = {
            Book.class
      },
      schemaFileName = "book.proto",
      schemaFilePath = "proto/",
      schemaPackageName = "book_sample")
public interface RemoteQueryInitializer extends SerializationContextInitializer {
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Compile your project.</p>
<div class="paragraph">
<p>The code examples in this procedure generate a <code>proto/book.proto</code> schema and an <code>RemoteQueryInitializerImpl.java</code> implementation of the annotated <code>Book</code> class.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Next steps</div>
<p>Create a remote cache that configures Infinispan to index your entities.
For example, the following remote cache indexes the <code>Book</code> entity in the <code>book.proto</code> schema that you generated in the previous step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;replicated-cache name="books"&gt;
  &lt;indexing&gt;
    &lt;indexed-entities&gt;
      &lt;indexed-entity&gt;book_sample.Book&lt;/indexed-entity&gt;
    &lt;/indexed-entities&gt;
  &lt;/indexing&gt;
&lt;/replicated-cache&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <code>RemoteQuery</code> class does the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Registers the <code>RemoteQueryInitializerImpl</code> serialization context with a Hot Rod Java client.</p>
</li>
<li>
<p>Registers the Protobuf schema, <code>book.proto</code>, with Infinispan Server.</p>
</li>
<li>
<p>Adds two <code>Book</code> instances to the remote cache.</p>
</li>
<li>
<p>Performs a full-text query that matches books by keywords in the title.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">RemoteQuery.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.infinispan;

import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;

import org.infinispan.client.hotrod.RemoteCache;
import org.infinispan.client.hotrod.RemoteCacheManager;
import org.infinispan.client.hotrod.Search;
import org.infinispan.client.hotrod.configuration.ConfigurationBuilder;
import org.infinispan.query.dsl.Query;
import org.infinispan.query.dsl.QueryFactory;
import org.infinispan.query.remote.client.ProtobufMetadataManagerConstants;

public class RemoteQuery {

   public static void main(String[] args) throws Exception {
      ConfigurationBuilder clientBuilder = new ConfigurationBuilder();
      // RemoteQueryInitializerImpl is generated
      clientBuilder.addServer().host("127.0.0.1").port(11222)
            .security().authentication().username("user").password("user")
            .addContextInitializers(new RemoteQueryInitializerImpl());

      RemoteCacheManager remoteCacheManager = new RemoteCacheManager(clientBuilder.build());

      // Grab the generated protobuf schema and registers in the server.
      Path proto = Paths.get(RemoteQuery.class.getClassLoader()
            .getResource("proto/book.proto").toURI());
      String protoBufCacheName = ProtobufMetadataManagerConstants.PROTOBUF_METADATA_CACHE_NAME;
      remoteCacheManager.getCache(protoBufCacheName).put("book.proto", Files.readString(proto));

      // Obtain the 'books' remote cache
      RemoteCache&lt;Object, Object&gt; remoteCache = remoteCacheManager.getCache("books");

      // Add some Books
      Book book1 = new Book("Infinispan in Action", "Learn Infinispan with using it", 2015);
      Book book2 = new Book("Cloud-Native Applications with Java and Quarkus", "Build robust and reliable cloud applications", 2019);

      remoteCache.put(1, book1);
      remoteCache.put(2, book2);

      // Execute a full-text query
      Query&lt;Book&gt; query = remoteCache.query("FROM book_sample.Book WHERE title:'java'");

      List&lt;Book&gt; list = query.execute().list(); // Voila! We have our book back from the cache!
   }
}</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../encoding/encoding.html">Encoding Infinispan caches and marshalling data</a></p>
</li>
<li>
<p><a href="../encoding/encoding.html#protostream-annotations_marshalling">Encoding Infinispan caches and marshalling data: ProtoStream annotations</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="querying-protostream-common-types_query-remote"><a class="anchor" href="#querying-protostream-common-types_query-remote"></a>3.2. Querying ProtoStream common types</h3>
<div class="paragraph">
<p>Perform Ickle queries on caches that store data as ProtoStream common types such as <code>BigInteger</code> and <code>BigDecimal</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add indexing annotations to your class, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Indexed
public class CalculusIndexed {
    @Basic
    @ProtoField(value = 1)
    public BigInteger getPurchases() {
      return purchases;
    }

    @Decimal // the scale is 2 by default
    @ProtoField(value = 2)
    public BigDecimal getProspect() {
      return prospect;
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Set the <code>dependsOn</code> attribute to <code>CommonTypes.class</code> to indicate that the generated Protobuf schema can reference and use <code>CommonTypes</code> types such as <code>BigInteger</code> and <code>BigDecimal</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ProtoSchema(includeClasses = CalculusIndexed.class, dependsOn = CommonTypes.class,
     schemaFilePath = "/protostream", schemaFileName = "calculus-indexed.proto",
     schemaPackageName = "lab.indexed")
public interface CalculusIndexedSchema extends GeneratedSchema {
}</code></pre>
</div>
</div>
</li>
<li>
<p>Perform queries:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Query&lt;Product&gt; query = cache.query("from lab.indexed.CalculusIndexed c where c.purchases &gt; 9");
QueryResult&lt;Product&gt; result = query.execute();
// play with the result

query = cache.query("from lab.indexed.CalculusIndexed c where c.prospect = 2.2");
result = query.execute();
// play with the result</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../encoding/encoding.html#protostream-types_marshalling">ProtoStream Types Marshalling</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="querying-console_query-remote"><a class="anchor" href="#querying-console_query-remote"></a>3.3. Querying caches from Infinispan Console and CLI</h3>
<div class="paragraph">
<p>Infinispan Console and the Infinispan Command Line Interface (CLI) let you query indexed and non-indexed remote caches.
You can also use any HTTP client to index and query caches via the REST API.</p>
</div>
<div class="paragraph">
<p>This procedure explains how to index and query a remote cache that stores <code>Person</code> instances.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Have at least one running Infinispan Server instance.</p>
</li>
<li>
<p>Have Infinispan credentials with create permissions.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add indexing annotations to your Protobuf schema, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-json hljs" data-lang="json">package org.infinispan.example;

/* @Indexed */
message Person {

    /* @Basic */
    optional int32 id = 1;

    /* @Keyword(projectable = true) */
    required string name = 2;

    /* @Keyword(projectable = true) */
    required string surname = 3;

    /* @Basic(projectable = true, sortable = true) */
    optional int32 age = 6;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the Infinispan CLI, use the <code class="command">schema upload</code> command with the <code>--file</code> option as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">schema upload --file person.proto person.proto</code></pre>
</div>
</div>
</li>
<li>
<p>Create a cache named <strong>people</strong> that uses ProtoStream encoding and configures Infinispan to index entities declared in your Protobuf schema.</p>
<div class="paragraph">
<p>The following cache indexes the <code>Person</code> entity from the previous step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-json hljs" data-lang="json">&lt;distributed-cache name="people"&gt;
  &lt;encoding media-type="application/x-protostream"/&gt;
  &lt;indexing&gt;
    &lt;indexed-entities&gt;
      &lt;indexed-entity&gt;org.infinispan.example.Person&lt;/indexed-entity&gt;
    &lt;/indexed-entities&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the CLI, use the <code class="command">create cache</code> command with the <code class="command">--file=</code> option as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">create cache --file=people.xml people</code></pre>
</div>
</div>
</li>
<li>
<p>Add entries to the cache.</p>
<div class="paragraph">
<p>To query a remote cache, it needs to contain some data.
For this example procedure, create entries that use the following JSON values:</p>
</div>
<div class="listingblock">
<div class="title">PersonOne.json</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-json hljs" data-lang="json">{
  "_type":"org.infinispan.example.Person",
  "id":1,
  "name":"Person",
  "surname":"One",
  "age":44
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">PersonTwo.json</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-json hljs" data-lang="json">{
  "_type":"org.infinispan.example.Person",
  "id":2,
  "name":"Person",
  "surname":"Two",
  "age":27
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">PersonThree.json</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-json hljs" data-lang="json">{
  "_type":"org.infinispan.example.Person",
  "id":3,
  "name":"Person",
  "surname":"Three",
  "age":35
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the CLI, use the <code class="command">put</code> command with the <code class="command">--file=</code> option to add each entry, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">put --cache=people --encoding=application/json --file=personOne.json personone</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>From Infinispan Console, you must select <strong>Custom Type</strong> for the <strong>Value content type</strong> field when you add values in JSON format with custom types .</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Query your remote cache.</p>
<div class="paragraph">
<p>From the CLI, use the <code class="command">query</code> command from the context of the remote cache.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">query "from org.infinispan.example.Person p WHERE p.name='Person' ORDER BY p.age ASC"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query returns all entries with a name that matches <code>Person</code> by age in ascending order.</p>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../rest/rest.html">Infinispan REST API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="using-analyzers_query-remote"><a class="anchor" href="#using-analyzers_query-remote"></a>3.4. Using analyzers with remote caches</h3>
<div class="paragraph">
<p>Analyzers convert input data into terms that you can index and query.
You specify analyzer definitions with the <code>@Text</code> annotation in your Java classes or directly in Protobuf schema.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Annotate the property with the <code>@Text</code> annotation to indicate that its value is analyzed.</p>
</li>
<li>
<p>Use the <code>analyzer</code> attribute to specify the desired analyzer that you want to use for indexing and searching.</p>
</li>
</ol>
</div>
<div class="listingblock primary">
<div class="title">Protobuf schema</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-protobuf hljs" data-lang="protobuf">/* @Indexed */
message TestEntity {

    /* @Keyword(projectable = true) */
    optional string id = 1;

    /* @Text(projectable = true, analyzer = "simple") */
    optional string name = 2;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Java classes</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Text(projectable = true, analyzer = "whitespace")
@ProtoField(value = 1)
private String id;

@Text(projectable = true, analyzer = "simple")
@ProtoField(value = 2)
private String description;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="default-analyzers_query-remote"><a class="anchor" href="#default-analyzers_query-remote"></a>3.4.1. Default analyzer definitions</h4>
<div class="paragraph">
<p>Infinispan provides a set of default analyzer definitions.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Definition</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>standard</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Splits text fields into tokens, treating whitespace and punctuation as delimiters.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>simple</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tokenizes input streams by delimiting at non-letters and then converting all letters to lowercase characters. Whitespace and non-letters are discarded.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>whitespace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Splits text streams on whitespace and returns sequences of non-whitespace characters as tokens.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keyword</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Treats entire text fields as single tokens.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stemmer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stems English words using the Snowball Porter filter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ngram</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generates n-gram tokens that are 3 grams in size by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>filename</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Splits text fields into larger size tokens than the <code>standard</code> analyzer, treating whitespace as a delimiter and converts all letters to lowercase characters.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lowercase</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts all the letters of the text to lowercase characters, the text is not tokenized (normalizer).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These analyzer definitions are based on Apache Lucene.
For more information about tokenizers, filters, and CharFilters, see the Apache Lucene documentation.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://lucene.apache.org/core/9_6_0/">Apache Lucene Documentation</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="creating-analyzers_query-remote"><a class="anchor" href="#creating-analyzers_query-remote"></a>3.4.2. Creating custom analyzer definitions</h4>
<div class="paragraph">
<p>Create custom analyzer definitions and add them to your Infinispan Server installations.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Stop Infinispan Server if it is running.</p>
<div class="paragraph">
<p>Infinispan Server loads classes at startup only.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Implement the <code>ProgrammaticSearchMappingProvider</code> API.</p>
</li>
<li>
<p>Package your implementation in a JAR with the fully qualified class (FQN) in the following file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">META-INF/services/org.infinispan.query.spi.ProgrammaticSearchMappingProvider</code></pre>
</div>
</div>
</li>
<li>
<p>Copy your JAR file to the <code>server/lib</code> directory of your Infinispan Server installation.</p>
</li>
<li>
<p>Start Infinispan Server.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title"><code>ProgrammaticSearchMappingProvider</code> example</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import org.apache.lucene.analysis.core.LowerCaseFilterFactory;
import org.apache.lucene.analysis.core.StopFilterFactory;
import org.apache.lucene.analysis.standard.StandardFilterFactory;
import org.apache.lucene.analysis.standard.StandardTokenizerFactory;
import org.hibernate.search.cfg.SearchMapping;
import org.infinispan.Cache;
import org.infinispan.query.spi.ProgrammaticSearchMappingProvider;

public final class MyAnalyzerProvider implements ProgrammaticSearchMappingProvider {

   @Override
   public void defineMappings(Cache cache, SearchMapping searchMapping) {
      searchMapping
            .analyzerDef("standard-with-stop", StandardTokenizerFactory.class)
               .filter(StandardFilterFactory.class)
               .filter(LowerCaseFilterFactory.class)
               .filter(StopFilterFactory.class);
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="queries_by_keys_query-remote"><a class="anchor" href="#queries_by_keys_query-remote"></a>3.5. Queries by keys</h3>
<div class="paragraph">
<p>You can define the key of a cache entry as <code>Indexed</code> type to index the key fields as well the value fields allowing the keys to be used in Ickle queries.</p>
</div>
<div class="paragraph">
<p>To define an <code>Indexed</code> key, specify the fully qualified name of the ProtocolBuffer message type to use as the key type in the <code>keyEntity</code> attribute of the <code>@Indexed</code> annotation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This feature is available only with indexed remote queries.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Specify the <code>keyEntity</code> of an indexed entity</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.infinispan.api.annotations.indexing.Basic;
import org.infinispan.api.annotations.indexing.Indexed;
import org.infinispan.api.annotations.indexing.Text;
import org.infinispan.protostream.GeneratedSchema;
import org.infinispan.protostream.annotations.ProtoFactory;
import org.infinispan.protostream.annotations.ProtoField;
import org.infinispan.protostream.annotations.ProtoSchema;

@Indexed(keyEntity = "model.StructureKey")
public class Structure {

   private final String code;
   private final String description;
   private final Integer value;

   @ProtoFactory
   public Structure(String code, String description, Integer value) {
      this.code = code;
      this.description = description;
      this.value = value;
   }

   @ProtoField(1)
   @Basic
   public String getCode() {
      return code;
   }

   @ProtoField(2)
   @Text
   public String getDescription() {
      return description;
   }

   @ProtoField(3)
   @Basic
   public Integer getValue() {
      return value;
   }

   @ProtoSchema(includeClasses = { Structure.class, StructureKey.class }, schemaPackageName = "model")
   public interface StructureSchema extends GeneratedSchema {
      StructureSchema INSTANCE = new StructureSchemaImpl();
   }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Define the key entity and its indexed fields</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.infinispan.api.annotations.indexing.Basic;
import org.infinispan.api.annotations.indexing.Indexed;
import org.infinispan.api.annotations.indexing.Keyword;
import org.infinispan.protostream.annotations.ProtoFactory;
import org.infinispan.protostream.annotations.ProtoField;

@Indexed
public class StructureKey {

   private String zone;
   private Integer row;
   private Integer column;

   @ProtoFactory
   public StructureKey(String zone, Integer row, Integer column) {
      this.zone = zone;
      this.row = row;
      this.column = column;
   }

   @Keyword(projectable = true, sortable = true)
   @ProtoField(1)
   public String getZone() {
      return zone;
   }

   @Basic(projectable = true, sortable = true)
   @ProtoField(2)
   public Integer getRow() {
      return row;
   }

   @Basic(projectable = true, sortable = true)
   @ProtoField(3)
   public Integer getColumn() {
      return column;
   }
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="key_property_name"><a class="anchor" href="#key_property_name"></a>3.5.1. Key property name</h4>
<div class="paragraph">
<p>By default, the key fields will be targeted using the property named <code>key</code>.</p>
</div>
<div class="listingblock">
<div class="title">Use key properties in the Ickle queries</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-slq hljs" data-lang="slq">select s.key.column from model.Structure s where s.key.zone = 'z7'</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the value already has a property named <code>key</code>, the definition of the key entity could create a naming conflict
with the properties.
For this reason, and also in general,
it is possible to change the name to assign as a prefix for the property keys changing the attribute <code>keyPropertyName</code>
of the <code>@Indexed</code> annotation.</p>
</div>
</div>
<div class="sect3">
<h4 id="key_include_depth"><a class="anchor" href="#key_include_depth"></a>3.5.2. Key include depth</h4>
<div class="paragraph">
<p>An entity key can have embedded entities. You can limit the depth for the embedded entity fields that are indexed by changing the attribute <code>keyIncludeDepth</code>, which defaults to <code>3</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="queries_server_tasks_query-remote"><a class="anchor" href="#queries_server_tasks_query-remote"></a>3.6. Remote queries from server tasks</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The feature is marked as experimental.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Indexes for remote caches encoded with ProtoBuf can be used to run queries from server tasks,
even if the server tasks are run embedded with the server JVM.</p>
</div>
<div class="paragraph">
<p>Here is an example:</p>
</div>
<div class="listingblock">
<div class="title">Run remote queries from a server task</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.infinispan.server.functional.extensions;

import java.util.Map;

import org.infinispan.commons.api.query.Query;
import org.infinispan.commons.api.query.QueryResult;
import org.infinispan.protostream.sampledomain.User;
import org.infinispan.tasks.ServerTask;
import org.infinispan.tasks.TaskContext;
import org.infinispan.tasks.query.RemoteQueryAccess;

public class RemoteQueryAccessTask implements ServerTask&lt;Integer&gt; {

   private static final ThreadLocal&lt;TaskContext&gt; taskContext = new ThreadLocal&lt;&gt;();
   private static final String QUERY = "FROM pro.User WHERE name = :name order by id";
   private static final String QUERY_PROJ = "select id, name, surname " + QUERY;

   @Override
   public void setTaskContext(TaskContext ctx) {
      taskContext.set(ctx);
   }

   @Override
   public Integer call() {
      TaskContext ctx = taskContext.get();
      String name = (String) ctx.getParameters().get().get("name");
      RemoteQueryAccess remoteQueryAccess = ctx.getRemoteQueryAccess().get();

      Map&lt;String, Object&gt; params = Map.of("name", name);
      Query&lt;User&gt; query = remoteQueryAccess.query(QUERY);
      query.setParameters(params);
      QueryResult&lt;User&gt; result1 = query.execute();

      Query&lt;Object[]&gt; queryProj = remoteQueryAccess.query(QUERY_PROJ);
      query.setParameters(params);
      QueryResult&lt;Object[]&gt; result2 = queryProj.execute();

      return result1.count().value() + result2.count().value();
   }

   @Override
   public String getName() {
      return "remote-query-access-task";
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>RemoteQueryAccess</code> can be obtained from the <code>TaskContext</code>.</p>
</div>
<div class="paragraph">
<p>It allows run the remote queries.</p>
</div>
<div class="paragraph">
<p>Using the method <code>executeQuery</code>, that will take the following parameter:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>queryString</code>: the Iclke query to execute, as it was executed from a client</p>
</li>
<li>
<p><code>namedParametersMap</code>: the parameters to pass to the query</p>
</li>
<li>
<p><code>offset</code> and <code>maxResults</code>: for pagination</p>
</li>
<li>
<p><code>hitCountAccuracy</code>: the bound up to hit count will be exact</p>
</li>
<li>
<p><code>local</code>: if the query should report results only considering the local index shard</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The feature is marked as experimental.
Several query APIs are not available from this setting.
In particular is not possible to execute a statement, verify if a query has projections defined, it is not possible to use
Neither the iterator, nor the entity iterator, timeouts and forcing the score to be computed.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="query-embedded"><a class="anchor" href="#query-embedded"></a>4. Querying embedded caches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use embedded queries when you add Infinispan as a library to custom applications.</p>
</div>
<div class="paragraph">
<p>Protobuf mapping is not required with embedded queries.
Indexing and querying are both done on top of Java objects.</p>
</div>
<div class="sect2">
<h3 id="querying-embedded-caches_query-embedded"><a class="anchor" href="#querying-embedded-caches_query-embedded"></a>4.1. Querying embedded caches</h3>
<div class="paragraph">
<p>This section explains how to query an embedded cache using an example cache named "books" that stores indexed <code>Book</code> instances.</p>
</div>
<div class="paragraph">
<p>In this example, each <code>Book</code> instance defines which properties are indexed and specifies some advanced indexing options with Hibernate Search annotations as follows:</p>
</div>
<div class="listingblock">
<div class="title">Book.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.infinispan.sample;

import java.time.LocalDate;
import java.util.HashSet;
import java.util.Set;

import org.infinispan.api.annotations.indexing.*;

// Annotate values with @Indexed to add them to indexes
// Annotate each field according to how you want to index it
@Indexed
public class Book {
   @Keyword
   String title;

   @Text
   String description;

   @Keyword
   String isbn;

   @Basic
   LocalDate publicationDate;

   @Embedded
   Set&lt;Author&gt; authors = new HashSet&lt;Author&gt;();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Author.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.infinispan.sample;

import org.infinispan.api.annotations.indexing.Text;

public class Author {
   @Text
   String name;

   @Text
   String surname;
}</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure Infinispan to index the "books" cache and specify <code>org.infinispan.sample.Book</code> as the entity to index.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;distributed-cache name="books"&gt;
  &lt;indexing path="${user.home}/index"&gt;
    &lt;indexed-entities&gt;
      &lt;indexed-entity&gt;org.infinispan.sample.Book&lt;/indexed-entity&gt;
    &lt;/indexed-entities&gt;
  &lt;/indexing&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Obtain the cache.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.infinispan.Cache;
import org.infinispan.manager.DefaultCacheManager;
import org.infinispan.manager.EmbeddedCacheManager;

EmbeddedCacheManager manager = new DefaultCacheManager("infinispan.xml");
Cache&lt;String, Book&gt; cache = manager.getCache("books");</code></pre>
</div>
</div>
</li>
<li>
<p>Perform queries for fields in the <code>Book</code> instances that are stored in the Infinispan cache, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Create an Ickle query that performs a full-text search using the ':' operator on the 'title' and 'authors.name' fields
// You can perform full-text search only on indexed caches
Query&lt;Book&gt; fullTextQuery = cache.query("FROM org.infinispan.sample.Book b WHERE b.title:'infinispan' AND b.authors.name:'sanne'");

// Use the '=' operator to query fields in caches that are indexed or not
// Non full-text operators apply only to fields that are not analyzed
Query&lt;Book&gt; exactMatchQuery= cache.query("FROM org.infinispan.sample.Book b WHERE b.isbn = '12345678' AND b.authors.name : 'sanne'");

// You can use full-text and non-full text operators in the same query
Query&lt;Book&gt; query= cache.query("FROM org.infinispan.sample.Book b where b.authors.name : 'Stephen' and b.description : (+'dark' -'tower')");

// Get the results
List&lt;Book&gt; found=query.execute().list();</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="entity-mapping-annotations_query-embedded"><a class="anchor" href="#entity-mapping-annotations_query-embedded"></a>4.2. Entity mapping annotations</h3>
<div class="paragraph">
<p>Add annotations to your Java classes to map your entities to indexes.</p>
</div>
<div class="paragraph">
<div class="title">Hibernate Search API</div>
<p>Infinispan uses the <a href="http://hibernate.org/search/">Hibernate Search</a> API to define fine grained configuration for indexing at entity level.
This configuration includes which fields are annotated, which analyzers should be used, how to map nested objects, and so on.</p>
</div>
<div class="paragraph">
<p>The following sections provide information that applies to entity mapping annotations for use with Infinispan.</p>
</div>
<div class="paragraph">
<p>For complete detail about these annotations, you should refer to <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#mapper-orm-mapping">the Hibernate Search manual</a>.</p>
</div>
<h4 id="documentid" class="discrete">@DocumentId</h4>
<div class="paragraph">
<p>Unlike Hibernate Search, using <code>@DocumentId</code> to mark a field as identifier does not apply to Infinispan values; in Infinispan the identifier for all <code>@Indexed</code> objects is the key used to store the value. You can still customize how the key is indexed using a combination of <code>@Transformable</code> , custom types and custom <code>FieldBridge</code> implementations.</p>
</div>
<h4 id="transformable_keys" class="discrete">@Transformable keys</h4>
<div class="paragraph">
<p>The key for each value needs to be indexed as well, and the key instance must be transformed in a <code>String</code>. Infinispan includes some default transformation routines to encode common primitives, but to use a custom key you must provide an implementation of <code>org.infinispan.query.Transformer</code> .</p>
</div>
<div class="paragraph">
<div class="title">Registering a key Transformer via annotations</div>
<p>You can annotate your key class with <code>org.infinispan.query.Transformable</code> and your custom transformer implementation
will be picked up automatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Transformable(transformer = CustomTransformer.class)
public class CustomKey {
   ...
}

public class CustomTransformer implements Transformer {
   @Override
   public Object fromString(String s) {
      ...
      return new CustomKey(...);
   }

   @Override
   public String toString(Object customType) {
      CustomKey ck = (CustomKey) customType;
      return ...
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Registering a key Transformer via the cache indexing configuration</div>
<p>Use the <code>key-transformers</code> xml element in both embedded and server config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;replicated-cache name="test"&gt;
  &lt;indexing&gt;
    &lt;key-transformers&gt;
      &lt;key-transformer key="com.mycompany.CustomKey"
                       transformer="com.mycompany.CustomTransformer"/&gt;
    &lt;/key-transformers&gt;
  &lt;/indexing&gt;
&lt;/replicated-cache&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, use the Java configuration API (embedded mode):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">   ConfigurationBuilder builder = ...
   builder.indexing().enable()
         .addKeyTransformer(CustomKey.class, CustomTransformer.class);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="query-continuous"><a class="anchor" href="#query-continuous"></a>5. Creating continuous queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Applications can register listeners to receive continual updates about cache entries that match query filters.</p>
</div>
<div class="sect2">
<h3 id="continuous-queries_query-continuous"><a class="anchor" href="#continuous-queries_query-continuous"></a>5.1. Continuous queries</h3>
<div class="paragraph">
<p>Continuous queries provide applications with real-time notifications about data in Infinispan caches that are filtered by queries.
When entries match the query Infinispan sends the updated data to any listeners, which provides a stream of events instead of applications having to execute the query.</p>
</div>
<div class="paragraph">
<p>Continuous queries can notify applications about incoming matches, for values that have joined the set; updated matches, for matching values that were modified and continue to match; and outgoing matches, for values that have left the set.</p>
</div>
<div class="paragraph">
<p>For example, continuous queries can notify applications about all:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Persons with an age between 18 and 25, assuming the <code>Person</code> entity has an <code>age</code> property and is updated by the user application.</p>
</li>
<li>
<p>Transactions for dollar amounts larger than $2000.</p>
</li>
<li>
<p>Times where the lap speed of F1 racers were less than 1:45.00 seconds, assuming the cache contains Lap entries and that laps are entered during the race.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Continuous queries can use all query capabilities except for grouping, aggregation, and sorting operations.</p>
</div>
</td>
</tr>
</table>
</div>
<h4 id="how_continuous_queries_work" class="discrete">How continuous queries work</h4>
<div class="paragraph">
<p>Continuous queries notify client listeners with the following events:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>Join</code></dt>
<dd>
<p>A cache entry matches the query.</p>
</dd>
<dt class="hdlist1"><code>Update</code></dt>
<dd>
<p>A cache entry that matches the query is updated and still matches the query.</p>
</dd>
<dt class="hdlist1"><code>Leave</code></dt>
<dd>
<p>A cache entry no longer matches the query.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When a client registers a continuous query listener it immediately receives <code>Join</code> events for any entries that match the query.
Client listeners receive subsequent events each time a cache operation modifies entries that match the query.</p>
</div>
<div class="paragraph">
<p>Infinispan determines when to send <code>Join</code>, <code>Update</code>, or <code>Leave</code> events to client listeners as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the query on both the old and new value does not match, Infinispan does not sent an event.</p>
</li>
<li>
<p>If the query on the old value does not match but the new value does, Infinispan sends a <code>Join</code> event.</p>
</li>
<li>
<p>If the query on both the old and new values match, Infinispan sends an <code>Update</code> event.</p>
</li>
<li>
<p>If the query on the old value matches but the new value does not, Infinispan sends a <code>Leave</code> event.</p>
</li>
<li>
<p>If the query on the old value matches and the entry is then deleted or it expires, Infinispan sends a <code>Leave</code> event.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="continuous-query-performance_query-continuous"><a class="anchor" href="#continuous-query-performance_query-continuous"></a>5.1.1. Continuous queries and Infinispan performance</h4>
<div class="paragraph">
<p>Continuous queries provide a constant stream of updates to applications, which can generate a significant number of events.
Infinispan temporarily allocates memory for each event it generates, which can result in memory pressure and potentially lead to <code>OutOfMemoryError</code> exceptions, especially for remote caches.
For this reason, you should carefully design your continuous queries to avoid any performance impact.</p>
</div>
<div class="paragraph">
<p>Infinispan strongly recommends that you limit the scope of your continuous queries to the smallest amount of information that you need.
To achieve this, you can use projections and predicates.
For example, the following statement provides results about only a subset of fields that match the criteria rather than the entire entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-sql hljs" data-lang="sql">SELECT field1, field2 FROM Entity WHERE x AND y</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also important to ensure that each <code>ContinuousQueryListener</code> you create can quickly process all received events without blocking threads.
To achieve this, you should avoid any cache operations that generate events unnecessarily.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-continuous-queries_query-continuous"><a class="anchor" href="#creating-continuous-queries_query-continuous"></a>5.2. Creating continuous queries</h3>
<div class="paragraph">
<p>You can create continuous queries for remote and embedded caches.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>Query</code> object.</p>
</li>
<li>
<p>Obtain the <code>ContinuousQuery</code> object of your cache by calling
the appropriate method:</p>
<div class="ulist">
<ul>
<li>
<p>Remote caches: <code>org.infinispan.client.hotrod.Search.getContinuousQuery(RemoteCache&lt;K, V&gt; cache)</code></p>
</li>
<li>
<p>Embedded caches: <code>org.infinispan.query.Search.getContinuousQuery(Cache&lt;K, V&gt; cache)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Register the query and a <code>ContinuousQueryListener</code> object as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">continuousQuery.addContinuousQueryListener(query, listener);</code></pre>
</div>
</div>
</li>
<li>
<p>When you no longer need the continuous query, remove the listener as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">continuousQuery.removeContinuousQueryListener(listener);</code></pre>
</div>
</div>
</li>
</ol>
</div>
<h4 id="continuous_query_example" class="discrete">Continuous query example</h4>
<div class="paragraph">
<p>The following code example demonstrates a simple continuous query with an embedded cache.</p>
</div>
<div class="paragraph">
<p>In this example, the listener receives notifications when any <code>Person</code> instances under the age of 21 are added to the cache.
Those <code>Person</code> instances are also added to the "matches" map.
When the entries are removed from the cache or their age becomes greater than or equal to 21, they are removed from "matches" map.
</p>
</div>
<div class="listingblock">
<div class="title">Registering a Continuous Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.infinispan.query.api.continuous.ContinuousQuery;
import org.infinispan.query.api.continuous.ContinuousQueryListener;
import org.infinispan.query.Search;
import org.infinispan.query.dsl.QueryFactory;
import org.infinispan.query.dsl.Query;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

[...]

// We have a cache of Person objects.
Cache&lt;Integer, Person&gt; cache = ...

// Create a ContinuousQuery instance on the cache.
ContinuousQuery&lt;Integer, Person&gt; continuousQuery = Search.getContinuousQuery(cache);

// Define a query.
// In this example, we search for Person instances under 21 years of age.
Query query = cache.query("FROM Person p WHERE p.age &lt; 21");

final Map&lt;Integer, Person&gt; matches = new ConcurrentHashMap&lt;Integer, Person&gt;();

// Define the ContinuousQueryListener.
ContinuousQueryListener&lt;Integer, Person&gt; listener = new ContinuousQueryListener&lt;Integer, Person&gt;() {
    @Override
    public void resultJoining(Integer key, Person value) {
        matches.put(key, value);
    }

    @Override
    public void resultUpdated(Integer key, Person value) {
        // We do not process this event.
    }

    @Override
    public void resultLeaving(Integer key) {
        matches.remove(key);
    }
};

// Add the listener and the query.
continuousQuery.addContinuousQueryListener(query, listener);

[...]

// Remove the listener to stop receiving notifications.
continuousQuery.removeContinuousQueryListener(listener);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="query-monitoring-tuning"><a class="anchor" href="#query-monitoring-tuning"></a>6. Monitoring and tuning Infinispan queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan exposes statistics for queries and provides attributes that you can adjust to improve query performance.</p>
</div>
<div class="sect2">
<h3 id="getting-query-statistics_query-monitoring-tuning"><a class="anchor" href="#getting-query-statistics_query-monitoring-tuning"></a>6.1. Getting query statistics</h3>
<div class="paragraph">
<p>Collect statistics to gather information about performance of your indexes and queries, including information such as the types of indexes, average time for queries to complete
and the number of possible failures on indexing operations.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Do one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Invoke the <code>getSearchStatistics()</code> or <code>getClusteredSearchStatistics()</code> methods for embedded caches.</p>
</li>
<li>
<p>Use <code>GET</code> requests to obtain statistics for remote caches from the REST API.</p>
</li>
</ul>
</div>
<div class="listingblock primary">
<div class="title">Embedded caches</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">// Statistics for the local cluster member
SearchStatistics statistics = Search.getSearchStatistics(cache);

// Consolidated statistics for the whole cluster
CompletionStage&lt;SearchStatisticsSnapshot&gt; statistics = Search.getClusteredSearchStatistics(cache)</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Remote caches</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-none hljs">GET /rest/v2/caches/{cacheName}/search/stats</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tuning-query-performance_query-monitoring-tuning"><a class="anchor" href="#tuning-query-performance_query-monitoring-tuning"></a>6.2. Tuning query performance</h3>
<div class="paragraph">
<p>Use the following guidelines to help you improve the performance of indexing operations and queries.</p>
</div>
<div class="paragraph">
<div class="title">Checking index usage statistics</div>
<p>Queries against partially indexed caches return slower results.
For instance, if some fields in a schema are not annotated then the resulting index does not include those fields.</p>
</div>
<div class="paragraph">
<p>Start tuning query performance by checking the time it takes for each type of query to run.
If your queries seem to be slow, you should make sure that queries are using the indexes for caches and that all entities and field mappings are indexed.</p>
</div>
<div class="paragraph">
<div class="title">Adjusting the commit interval for indexes</div>
<p>Indexing can degrade write throughput for Infinispan clusters.
The <code>commit-interval</code> attribute defines the interval, in milliseconds, between which index changes that are buffered in memory are flushed to the index storage and a commit is performed.</p>
</div>
<div class="paragraph">
<p>This operation is costly so you should avoid configuring an interval that is too small. The default is 1000 ms (1 second).</p>
</div>
<div class="paragraph">
<div class="title">Adjusting the refresh interval for queries</div>
<p>The <code>refresh-interval</code> attribute defines the interval, in milliseconds, between which the index reader is refreshed.</p>
</div>
<div class="paragraph">
<p>The default value is <code>0</code>, which returns data in queries as soon as it is written to a cache.</p>
</div>
<div class="paragraph">
<p>A value greater than <code>0</code> results in some stale query results but substantially increases throughput, especially in write-heavy scenarios.
If you do not need data returned in queries as soon as it is written, you should adjust the refresh interval to improve query performance.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-07-28 09:46:18 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>