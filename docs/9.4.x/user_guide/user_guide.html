<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Infinispan 9.4 User Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<link rel="canonical" href="http://infinispan.org/docs/stable/user_guide/user_guide.html">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css">
<link rel="stylesheet" href="../css/css.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script>
<script src="../js/js.js"></script>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Infinispan 9.4 User Guide</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#what_is_infinispan">1.1. What is Infinispan ?</a></li>
<li><a href="#why_use_infinispan">1.2. Why use Infinispan ?</a>
<ul class="sectlevel3">
<li><a href="#as_a_local_cache">1.2.1. As a local cache</a></li>
<li><a href="#as_a_clustered_cache">1.2.2. As a clustered cache</a></li>
<li><a href="#as_a_clustering_building_block_for_your_applications">1.2.3. As a clustering building block for your applications</a></li>
<li><a href="#as_a_remote_cache">1.2.4. As a remote cache</a></li>
<li><a href="#as_a_data_grid">1.2.5. As a data grid</a></li>
<li><a href="#as_a_geographical_backup_for_your_data">1.2.6. As a geographical backup for your data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cache_manager">2. The Embedded CacheManager</a>
<ul class="sectlevel2">
<li><a href="#cache_configuration">2.1. Configuration</a>
<ul class="sectlevel3">
<li><a href="#cache_configuration_declarative">2.1.1. Configuring caches declaratively</a>
<ul class="sectlevel4">
<li><a href="#cache_configuration_templates">Cache configuration templates</a></li>
<li><a href="#cache_configuration_wildcards">Cache configuration wildcards</a></li>
<li><a href="#cache_configuration_declarative_ref">Declarative configuration reference</a></li>
</ul>
</li>
<li><a href="#cache_configuration_programmatic">2.1.2. Configuring caches programmatically</a>
<ul class="sectlevel4">
<li><a href="#cache_configuration_programmatic_api">ConfigurationBuilder Programmatic Configuration API</a></li>
<li><a href="#configuring_the_transport">Configuring the transport</a></li>
<li><a href="#using_a_custom_jchannel">Using a custom JChannel</a></li>
<li><a href="#enabling_jmx_mbeans_and_statistics">Enabling JMX MBeans and statistics</a></li>
<li><a href="#configuring_the_thread_pools">Configuring the thread pools</a></li>
<li><a href="#configuring_transactions_and_locking">Configuring transactions and locking</a></li>
<li><a href="#configuring_cache_stores">Configuring cache stores</a></li>
<li><a href="#cache_configuration_programmatic_advanced">Advanced programmatic configuration</a></li>
</ul>
</li>
<li><a href="#cache_configuration_migration">2.1.3. Configuration Migration Tools</a></li>
<li><a href="#cache_configuration_clustered">2.1.4. Clustered Configuration</a>
<ul class="sectlevel4">
<li><a href="#using_an_external_jgroups_file">Using an external JGroups file</a></li>
<li><a href="#use_one_of_the_pre_configured_jgroups_files">Use one of the pre-configured JGroups files</a>
<ul class="sectlevel5">
<li><a href="#tuning_jgroups_settings">Tuning JGroups settings</a></li>
</ul>
</li>
<li><a href="#further_reading">Further reading</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#obtaining_caches">2.2. Obtaining caches</a></li>
<li><a href="#clustering_information">2.3. Clustering Information</a>
<ul class="sectlevel3">
<li><a href="#member_information">2.3.1. Member Information</a></li>
<li><a href="#other_methods">2.3.2. Other methods</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cache_api">3. The Cache API</a>
<ul class="sectlevel2">
<li><a href="#the_cache_interface">3.1. The Cache interface</a>
<ul class="sectlevel3">
<li><a href="#performance_concerns_of_certain_map_methods">3.1.1. Performance Concerns of Certain Map Methods</a></li>
<li><a href="#mortal_and_immortal_data">3.1.2. Mortal and Immortal Data</a></li>
<li><a href="#expiration_and_mortal_data">3.1.3. Expiration and Mortal Data</a></li>
<li><a href="#putforexternalread_operation">3.1.4. putForExternalRead operation</a></li>
</ul>
</li>
<li><a href="#the_advancedcache_interface">3.2. The AdvancedCache interface</a>
<ul class="sectlevel3">
<li><a href="#flags">3.2.1. Flags</a></li>
<li><a href="#custom_interceptors">3.2.2. Custom Interceptors</a></li>
</ul>
</li>
<li><a href="#listeners_and_notifications">3.3. Listeners and Notifications</a>
<ul class="sectlevel3">
<li><a href="#cache_level_notifications">3.3.1. Cache-level notifications</a>
<ul class="sectlevel4">
<li><a href="#cluster_listeners">Cluster Listeners</a></li>
<li><a href="#event_filtering_and_conversion">Event filtering and conversion</a></li>
<li><a href="#initial_state_events">Initial State Events</a></li>
<li><a href="#duplicate_events">Duplicate Events</a></li>
</ul>
</li>
<li><a href="#cache_manager_level_notifications">3.3.2. Cache manager-level notifications</a></li>
<li><a href="#synchronicity_of_events">3.3.3. Synchronicity of events</a>
<ul class="sectlevel4">
<li><a href="#asynchronous_thread_pool">Asynchronous thread pool</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cache_asynchronous_api">3.4. Asynchronous API</a>
<ul class="sectlevel3">
<li><a href="#why_use_such_an_api">3.4.1. Why use such an API?</a></li>
<li><a href="#which_processes_actually_happen_asynchronously">3.4.2. Which processes actually happen asynchronously?</a></li>
<li><a href="#notifying_futures">3.4.3. Notifying futures</a></li>
<li><a href="#further_reading_2">3.4.4. Further reading</a></li>
</ul>
</li>
<li><a href="#invocation_flags">3.5. Invocation Flags</a>
<ul class="sectlevel3">
<li><a href="#examples">3.5.1. Examples</a>
<ul class="sectlevel4">
<li><a href="#suppressing_return_values_from_a_put_or_remove">Suppressing return values from a put() or remove()</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#tree_api_module">3.6. Tree API Module</a>
<ul class="sectlevel3">
<li><a href="#what_is_tree_api_about">3.6.1. What is Tree API about?</a></li>
<li><a href="#using_the_tree_api">3.6.2. Using the Tree API</a>
<ul class="sectlevel4">
<li><a href="#dependencies">Dependencies</a></li>
</ul>
</li>
<li><a href="#creating_a_tree_cache">3.6.3. Creating a Tree Cache</a></li>
<li><a href="#manipulating_data_in_a_tree_cache">3.6.4. Manipulating data in a Tree Cache</a></li>
<li><a href="#common_operations">3.6.5. Common Operations</a></li>
<li><a href="#locking_in_the_tree_api">3.6.6. Locking in the Tree API</a></li>
<li><a href="#listeners_for_tree_cache_events">3.6.7. Listeners for tree cache events</a></li>
</ul>
</li>
<li><a href="#functional_map_api">3.7. Functional Map API</a>
<ul class="sectlevel3">
<li><a href="#asynchronous_and_lazy">3.7.1. Asynchronous and Lazy</a></li>
<li><a href="#function_transparency">3.7.2. Function transparency</a></li>
<li><a href="#constructing_functional_maps">3.7.3. Constructing Functional Maps</a></li>
<li><a href="#read_only_map_api">3.7.4. Read-Only Map API</a>
<ul class="sectlevel4">
<li><a href="#read_only_entry_view">Read-Only Entry View</a></li>
</ul>
</li>
<li><a href="#write_only_map_api">3.7.5. Write-Only Map API</a>
<ul class="sectlevel4">
<li><a href="#write_only_entry_view">Write-Only Entry View</a></li>
</ul>
</li>
<li><a href="#read_write_map_api">3.7.6. Read-Write Map API</a>
<ul class="sectlevel4">
<li><a href="#read_write_entry_view">Read-Write Entry View</a></li>
</ul>
</li>
<li><a href="#meta_parameter">3.7.7. Metadata Parameter Handling</a></li>
<li><a href="#_invocation_parameter">3.7.8. Invocation Parameter</a></li>
<li><a href="#functional_listeners">3.7.9. Functional Listeners</a>
<ul class="sectlevel4">
<li><a href="#write_listeners">Write Listeners</a></li>
<li><a href="#read_write_listeners">Read-Write Listeners</a></li>
</ul>
</li>
<li><a href="#marshalling_of_functions">3.7.10. Marshalling of Functions</a></li>
<li><a href="#use_cases_for_functional_api">3.7.11. Use Cases for Functional API</a></li>
</ul>
</li>
<li><a href="#data_encoding">3.8. Encoding</a>
<ul class="sectlevel3">
<li><a href="#overview">3.8.1. Overview</a></li>
<li><a href="#default_encoders">3.8.2. Default encoders</a></li>
<li><a href="#overriding_programmatically">3.8.3. Overriding programmatically</a></li>
<li><a href="#defining_custom_encoders">3.8.4. Defining custom Encoders</a></li>
<li><a href="#encoding_media_type">3.8.5. MediaType</a>
<ul class="sectlevel4">
<li><a href="#configuration">Configuration</a></li>
<li><a href="#mediatype_override">Overriding the MediaType Programmatically</a></li>
<li><a href="#transcoders_and_encoders">Transcoders and Encoders</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#eviction_anchor">4. Eviction and Data Container</a>
<ul class="sectlevel2">
<li><a href="#eviction_enabling">4.1. Enabling Eviction</a>
<ul class="sectlevel3">
<li><a href="#eviction_strategy">4.1.1. Eviction strategy</a></li>
<li><a href="#eviction_types">4.1.2. Eviction types</a></li>
<li><a href="#eviction_storage_type">4.1.3. Storage type</a></li>
<li><a href="#eviction_defaults">4.1.4. More defaults</a></li>
</ul>
</li>
<li><a href="#expiration_anchor">4.2. Expiration</a>
<ul class="sectlevel3">
<li><a href="#expiration_settings">4.2.1. Difference between Eviction and Expiration</a></li>
</ul>
</li>
<li><a href="#expiration_details">4.3. Expiration details</a>
<ul class="sectlevel3">
<li><a href="#expiration_maxidle">4.3.1. Maximum Idle Expiration</a>
<ul class="sectlevel4">
<li><a href="#expiration_maxidle_local">Local Max Idle</a></li>
<li><a href="#expiration_maxidle_clustered">Clustered Max Idle</a></li>
</ul>
</li>
<li><a href="#eviction_expiration_config">4.3.2. Configuration</a></li>
<li><a href="#eviction_expiration_config_mem">4.3.3. Memory Based Eviction Configuration</a></li>
<li><a href="#eviction_expiration_config_default">4.3.4. Default values</a></li>
<li><a href="#expiration_using">4.3.5. Using expiration</a></li>
</ul>
</li>
<li><a href="#expiration_designs">4.4. Expiration designs</a></li>
</ul>
</li>
<li><a href="#persistence">5. Persistence</a>
<ul class="sectlevel2">
<li><a href="#configuration_2">5.1. Configuration</a></li>
<li><a href="#cache_passivation">5.2. Cache Passivation</a>
<ul class="sectlevel3">
<li><a href="#limitations">5.2.1. Limitations</a></li>
<li><a href="#cache_loader_behavior_with_passivation_disabled_vs_enabled">5.2.2. Cache Loader Behavior with Passivation Disabled vs Enabled</a></li>
</ul>
</li>
<li><a href="#cache_loaders_and_transactional_caches">5.3. Cache Loaders and transactional caches</a></li>
<li><a href="#write_through_and_write_behind_caching">5.4. Write-Through And Write-Behind Caching</a>
<ul class="sectlevel3">
<li><a href="#write_through_synchronous">5.4.1. Write-Through (Synchronous)</a></li>
<li><a href="#write_behind_asynchronous">5.4.2. Write-Behind (Asynchronous)</a></li>
<li><a href="#segmented_stores">5.4.3. Segmented Stores</a></li>
</ul>
</li>
<li><a href="#filesystem_based_cache_stores">5.5. Filesystem based cache stores</a>
<ul class="sectlevel3">
<li><a href="#sfs_cache_store">5.5.1. Single File Store</a>
<ul class="sectlevel4">
<li><a href="#segmentation_support">Segmentation support</a></li>
<li><a href="#declarative_configuration">Declarative Configuration</a></li>
<li><a href="#programmatic_configuration">Programmatic Configuration</a></li>
</ul>
</li>
<li><a href="#sifs_cache_store">5.5.2. Soft-Index File Store</a>
<ul class="sectlevel4">
<li><a href="#segmentation_support_2">Segmentation support</a></li>
<li><a href="#configuration_3">Configuration</a></li>
<li><a href="#current_limitations">Current limitations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#jdbc_cache_store">5.6. JDBC String based Cache Store</a>
<ul class="sectlevel3">
<li><a href="#connection_management_pooling">5.6.1. Connection management (pooling)</a></li>
<li><a href="#sample_configurations">5.6.2. Sample configurations</a></li>
</ul>
</li>
<li><a href="#remote_cache_store">5.7. Remote store</a>
<ul class="sectlevel3">
<li><a href="#segmentation_support_3">5.7.1. Segmentation support</a></li>
<li><a href="#sample_usage">5.7.2. Sample Usage</a></li>
</ul>
</li>
<li><a href="#cluster_cache_loader">5.8. Cluster cache loader</a></li>
<li><a href="#cli_cache_loader">5.9. Command-Line Interface cache loader</a></li>
<li><a href="#rocksdb_cache_store">5.10. RocksDB Cache Store</a>
<ul class="sectlevel3">
<li><a href="#introduction_2">5.10.1. Introduction</a></li>
<li><a href="#segmentation_support_4">5.10.2. Segmentation support</a>
<ul class="sectlevel4">
<li><a href="#sample_usage_2">Sample Usage</a></li>
</ul>
</li>
<li><a href="#configuration_4">5.10.3. Configuration</a>
<ul class="sectlevel4">
<li><a href="#sample_programatic_configuration">Sample Programatic Configuration</a></li>
<li><a href="#sample_xml_configuration">Sample XML Configuration</a></li>
</ul>
</li>
<li><a href="#additional_references">5.10.4. Additional References</a></li>
</ul>
</li>
<li><a href="#leveldb_cache_store">5.11. LevelDB Cache Store</a></li>
<li><a href="#jpa_cache_store">5.12. JPA Cache Store</a>
<ul class="sectlevel3">
<li><a href="#sample_usage_3">5.12.1. Sample Usage</a></li>
<li><a href="#configuration_5">5.12.2. Configuration</a>
<ul class="sectlevel4">
<li><a href="#sample_programatic_configuration_2">Sample Programatic Configuration</a></li>
<li><a href="#sample_xml_configuration_2">Sample XML Configuration</a></li>
</ul>
</li>
<li><a href="#additional_references_2">5.12.3. Additional References</a></li>
</ul>
</li>
<li><a href="#custom_cache_stores">5.13. Custom Cache Stores</a>
<ul class="sectlevel3">
<li><a href="#hotrod_deployment">5.13.1. HotRod Deployment</a></li>
</ul>
</li>
<li><a href="#store_migrator">5.14. Store Migrator</a>
<ul class="sectlevel3">
<li><a href="#migrating_cache_stores">5.14.1. Migrating Cache Stores</a></li>
<li><a href="#store_migrator_properties">5.14.2. Store Migrator Properties</a>
<ul class="sectlevel4">
<li><a href="#common_properties">Common Properties</a></li>
<li><a href="#jdbc_properties">JDBC Properties</a></li>
<li><a href="#leveldbrocksdb_properties">LevelDB/RocksDB Properties</a></li>
<li><a href="#singlefilestore_properties">SingleFileStore Properties</a></li>
<li><a href="#softindexfilestore_properties">SoftIndexFileStore Properties</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spi">5.15. SPI</a></li>
<li><a href="#more_implementations">5.16. More implementations</a></li>
</ul>
</li>
<li><a href="#clustering">6. Clustering</a>
<ul class="sectlevel2">
<li><a href="#which_cache_mode_should_i_use">6.1. Which cache mode should I use?</a></li>
<li><a href="#local_mode">6.2. Local Mode</a>
<ul class="sectlevel3">
<li><a href="#simple_cache">6.2.1. Simple Cache</a>
<ul class="sectlevel4">
<li><a href="#declarative_configuration_2">Declarative configuration</a></li>
<li><a href="#programmatic_configuration_2">Programmatic configuration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#invalidation_mode">6.3. Invalidation Mode</a></li>
<li><a href="#replicated_mode">6.4. Replicated Mode</a></li>
<li><a href="#distribution_mode">6.5. Distribution Mode</a>
<ul class="sectlevel3">
<li><a href="#read_consistency">6.5.1. Read consistency</a></li>
<li><a href="#key_ownership">6.5.2. Key Ownership</a>
<ul class="sectlevel4">
<li><a href="#capacity_factors">Capacity Factors</a></li>
<li><a href="#zero_capacity_node">Zero Capacity Node</a></li>
<li><a href="#hashing_configuration">Hashing Configuration</a></li>
</ul>
</li>
<li><a href="#initial_cluster_size">6.5.3. Initial cluster size</a></li>
<li><a href="#l1_caching">6.5.4. L1 Caching</a></li>
<li><a href="#server_hinting">6.5.5. Server Hinting</a>
<ul class="sectlevel4">
<li><a href="#configuration_6">Configuration</a></li>
</ul>
</li>
<li><a href="#key_affinity_service">6.5.6. Key affinity service</a>
<ul class="sectlevel4">
<li><a href="#api">API</a></li>
<li><a href="#lifecycle">Lifecycle</a></li>
<li><a href="#topology_changes">Topology changes</a></li>
</ul>
</li>
<li><a href="#grouping_api">6.5.7. The Grouping API</a>
<ul class="sectlevel4">
<li><a href="#how_does_it_work">How does it work?</a></li>
<li><a href="#how_do_i_use_the_grouping_api">How do I use the grouping API?</a></li>
<li><a href="#advanced_interface">Advanced Interface</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scattered_mode">6.6. Scattered Mode</a></li>
<li><a href="#asynchronous_options">6.7. Asynchronous Options</a>
<ul class="sectlevel3">
<li><a href="#asynchronous_communications">6.7.1. Asynchronous Communications</a></li>
<li><a href="#asynchronous_api">6.7.2. Asynchronous API</a></li>
<li><a href="#return_values">6.7.3. Return Values</a></li>
</ul>
</li>
<li><a href="#partition_handling">6.8. Partition handling</a>
<ul class="sectlevel3">
<li><a href="#split_brain">6.8.1. Split brain</a>
<ul class="sectlevel4">
<li><a href="#split_strategies">Split Strategies</a>
<ul class="sectlevel5">
<li><a href="#allow_read_writes">ALLOW_READ_WRITES</a></li>
<li><a href="#deny_read_writes">DENY_READ_WRITES</a></li>
<li><a href="#allow_reads">ALLOW_READS</a></li>
</ul>
</li>
<li><a href="#current_limitations_2">Current limitations</a></li>
</ul>
</li>
<li><a href="#successive_node_failures">6.8.2. Successive nodes stopped</a></li>
<li><a href="#conflict_manager">6.8.3. Conflict Manager</a>
<ul class="sectlevel4">
<li><a href="#detecting_conflicts">Detecting Conflicts</a></li>
<li><a href="#merge_policies">Merge Policies</a></li>
</ul>
</li>
<li><a href="#conflict_manager_usage">6.8.4. Usage</a></li>
<li><a href="#partition_handling_configuration">6.8.5. Configuring partition handling</a>
<ul class="sectlevel4">
<li><a href="#partition_handling_custom_merge_policy">Implement a custom merge policy</a></li>
<li><a href="#deploy_custom_merge_policies_to_a_infinispan_server_instance">Deploy custom merge policies to a Infinispan server instance</a></li>
</ul>
</li>
<li><a href="#partition_handling_monitoring">6.8.6. Monitoring and administration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#marshalling">7. Marshalling</a>
<ul class="sectlevel2">
<li><a href="#the_role_of_jboss_marshalling">7.1. The Role Of JBoss Marshalling</a></li>
<li><a href="#support_for_non_serializable_objects">7.2. Support For Non-Serializable Objects</a>
<ul class="sectlevel3">
<li><a href="#store_binary">7.2.1. Store As Binary</a>
<ul class="sectlevel4">
<li><a href="#equality_considerations">Equality Considerations</a></li>
<li><a href="#store_by_value_via_defensive_copying">Store-by-value via defensive copying</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#advanced_configuration">7.3. Advanced Configuration</a>
<ul class="sectlevel3">
<li><a href="#troubleshooting">7.3.1. Troubleshooting</a></li>
</ul>
</li>
<li><a href="#user_defined_externalizers">7.4. User Defined Externalizers</a>
<ul class="sectlevel3">
<li><a href="#benefits_of_externalizers">7.4.1. Benefits of Externalizers</a></li>
<li><a href="#user_friendly_externalizers">7.4.2. User Friendly Externalizers</a></li>
<li><a href="#advanced_externalizers">7.4.3. Advanced Externalizers</a>
<ul class="sectlevel4">
<li><a href="#linking_externalizers_with_marshaller_classes">Linking Externalizers with Marshaller Classes</a></li>
<li><a href="#externalizer_identifier">Externalizer Identifier</a></li>
<li><a href="#registering_advanced_externalizers">Registering Advanced Externalizers</a></li>
<li><a href="#preassigned_externalizer_id_ranges">Preassigned Externalizer Id Ranges</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#transactions">8. Transactions</a>
<ul class="sectlevel2">
<li><a href="#tx_configuration">8.1. Configuring transactions</a></li>
<li><a href="#tx_isolation_levels">8.2. Isolation levels</a></li>
<li><a href="#tx_locking">8.3. Transaction locking</a>
<ul class="sectlevel3">
<li><a href="#pessimistic_transactional_cache">8.3.1. Pessimistic transactional cache</a></li>
<li><a href="#optimistic_transactional_cache">8.3.2. Optimistic transactional cache</a></li>
<li><a href="#what_do_i_need_pessimistic_or_optimistic_transactions">8.3.3. What do I need - pessimistic or optimistic transactions?</a></li>
</ul>
</li>
<li><a href="#tx_write_skew">8.4. Write Skews</a>
<ul class="sectlevel3">
<li><a href="#forcing_write_locks_on_keys_in_pessimitic_transactions">8.4.1. Forcing write locks on keys in pessimitic transactions</a></li>
</ul>
</li>
<li><a href="#dealing_with_exceptions">8.5. Dealing with exceptions</a></li>
<li><a href="#tx_sync_enlist">8.6. Enlisting Synchronizations</a></li>
<li><a href="#tx_batching">8.7. Batching</a>
<ul class="sectlevel3">
<li><a href="#api_2">8.7.1. API</a></li>
<li><a href="#batching_and_jta">8.7.2. Batching and JTA</a></li>
</ul>
</li>
<li><a href="#tx_recovery">8.8. Transaction recovery</a>
<ul class="sectlevel3">
<li><a href="#when_to_use_recovery">8.8.1. When to use recovery</a></li>
<li><a href="#how_does_it_work_2">8.8.2. How does it work</a></li>
<li><a href="#configuring_recovery">8.8.3. Configuring recovery</a>
<ul class="sectlevel4">
<li><a href="#enable_jmx_support">Enable JMX support</a></li>
</ul>
</li>
<li><a href="#recovery_cache">8.8.4. Recovery cache</a></li>
<li><a href="#integration_with_the_transaction_manager">8.8.5. Integration with the transaction manager</a></li>
<li><a href="#tx_recovery_reconciliation">8.8.6. Reconciliation</a>
<ul class="sectlevel4">
<li><a href="#force_commitrollback_based_on_xid">Force commit/rollback based on XID</a></li>
</ul>
</li>
<li><a href="#want_to_know_more">8.8.7. Want to know more?</a></li>
</ul>
</li>
<li><a href="#tx_total_order">8.9. Total Order based commit protocol</a>
<ul class="sectlevel3">
<li><a href="#overview_2">8.9.1. Overview</a>
<ul class="sectlevel4">
<li><a href="#commit_in_one_phase">Commit in one phase</a></li>
<li><a href="#commit_in_two_phases">Commit in two phases</a></li>
<li><a href="#transaction_recovery">Transaction Recovery</a></li>
<li><a href="#state_transfer">State Transfer</a></li>
</ul>
</li>
<li><a href="#configuration_7">8.9.2. Configuration</a></li>
<li><a href="#when_to_use_it">8.9.3. When to use it?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#locking_concurrency">9. Locking and Concurrency</a>
<ul class="sectlevel2">
<li><a href="#locking_implementation_details">9.1. Locking implementation details</a>
<ul class="sectlevel3">
<li><a href="#how_does_it_work_in_clustered_caches">9.1.1. How does it work in clustered caches?</a>
<ul class="sectlevel4">
<li><a href="#non_transactional_caches">Non Transactional caches</a></li>
</ul>
</li>
<li><a href="#transactional_caches">9.1.2. Transactional caches</a></li>
<li><a href="#isolation_levels">9.1.3. Isolation levels</a></li>
<li><a href="#the_lockmanager">9.1.4. The LockManager</a></li>
<li><a href="#lock_striping">9.1.5. Lock striping</a></li>
<li><a href="#concurrency_levels">9.1.6. Concurrency levels</a></li>
<li><a href="#lock_timeout">9.1.7. Lock timeout</a></li>
<li><a href="#consistency">9.1.8. Consistency</a></li>
</ul>
</li>
<li><a href="#data_versioning">9.2. Data Versioning</a></li>
</ul>
</li>
<li><a href="#execute_code_grid">10. Executing code in the Grid</a>
<ul class="sectlevel2">
<li><a href="#cluster_executor">10.1. Cluster Executor</a>
<ul class="sectlevel3">
<li><a href="#filtering_execution_nodes">10.1.1. Filtering execution nodes</a></li>
<li><a href="#timeout">10.1.2. Timeout</a></li>
<li><a href="#single_node_submission">10.1.3. Single Node Submission</a>
<ul class="sectlevel4">
<li><a href="#failover">Failover</a></li>
</ul>
</li>
<li><a href="#example_pi_approximation">10.1.4. Example: PI Approximation</a></li>
</ul>
</li>
<li><a href="#streams">10.2. Streams</a>
<ul class="sectlevel3">
<li><a href="#common_stream_operations">10.2.1. Common stream operations</a></li>
<li><a href="#key_filtering">10.2.2. Key filtering</a></li>
<li><a href="#segment_based_filtering">10.2.3. Segment based filtering</a></li>
<li><a href="#localinvalidation">10.2.4. Local/Invalidation</a></li>
<li><a href="#example">10.2.5. Example</a></li>
</ul>
</li>
<li><a href="#distributionreplicationscattered">10.3. Distribution/Replication/Scattered</a>
<ul class="sectlevel3">
<li><a href="#rehash_aware">10.3.1. Rehash Aware</a></li>
<li><a href="#serialization">10.3.2. Serialization</a></li>
<li><a href="#parallel_computation">10.3.3. Parallel Computation</a></li>
<li><a href="#task_timeout">10.3.4. Task timeout</a></li>
<li><a href="#injection">10.3.5. Injection</a></li>
<li><a href="#distributed_stream_execution">10.3.6. Distributed Stream execution</a></li>
<li><a href="#key_based_rehash_aware_operators">10.3.7. Key based rehash aware operators</a></li>
<li><a href="#intermediate_operation_exceptions">10.3.8. Intermediate operation exceptions</a></li>
<li><a href="#examples_2">10.3.9. Examples</a></li>
</ul>
</li>
<li><a href="#distributed_execution">10.4. Distributed Execution</a>
<ul class="sectlevel3">
<li><a href="#distributedcallable_api">10.4.1. DistributedCallable API</a></li>
<li><a href="#callable_and_cdi">10.4.2. Callable and CDI</a></li>
<li><a href="#distributedexecutorservice_distributedtaskbuilder_and_distributedtask_api">10.4.3. DistributedExecutorService, DistributedTaskBuilder and DistributedTask API</a></li>
<li><a href="#distributed_task_failover">10.4.4. Distributed task failover</a></li>
<li><a href="#distributed_task_execution_policy">10.4.5. Distributed task execution policy</a></li>
<li><a href="#examples_3">10.4.6. Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#indexing_querying">11. Indexing and Querying</a>
<ul class="sectlevel2">
<li><a href="#overview_3">11.1. Overview</a></li>
<li><a href="#query_library">11.2. Embedded Querying</a>
<ul class="sectlevel3">
<li><a href="#quick_example">11.2.1. Quick example</a></li>
<li><a href="#indexing">11.2.2. Indexing</a>
<ul class="sectlevel4">
<li><a href="#configuration_8">Configuration</a>
<ul class="sectlevel5">
<li><a href="#general_format">General format</a></li>
<li><a href="#index_names">Index names</a></li>
<li><a href="#specifying_indexed_entities">Specifying indexed Entities</a></li>
</ul>
</li>
<li><a href="#query_index_mode">Index mode</a></li>
<li><a href="#query_index_manager">Index Managers</a></li>
<li><a href="#query_shared_index">Shared indexes</a>
<ul class="sectlevel5">
<li><a href="#effect_of_the_index_mode">Effect of the index mode</a></li>
<li><a href="#infinispanindexmanager">InfinispanIndexManager</a></li>
<li><a href="#query_affinity_index_manager">AffinityIndexManager</a></li>
</ul>
</li>
<li><a href="#query_non_shared_index">Non-shared indexes</a>
<ul class="sectlevel5">
<li><a href="#effect_of_the_index_mode_2">Effect of the index mode</a></li>
<li><a href="#query_directory_based">directory-based index manager</a></li>
<li><a href="#near_real_time_index_manager">near-real-time index manager</a></li>
</ul>
</li>
<li><a href="#external_indexes">External indexes</a>
<ul class="sectlevel5">
<li><a href="#elasticsearch_indexmanager_experimental">Elasticsearch IndexManager (experimental)</a></li>
</ul>
</li>
<li><a href="#query_autoconfig">Automatic configuration</a></li>
<li><a href="#query_massindexer">Re-indexing</a></li>
<li><a href="#mapping_entities">Mapping Entities</a>
<ul class="sectlevel5">
<li><a href="#documentid">@DocumentId</a></li>
<li><a href="#transformable_keys">@Transformable keys</a></li>
<li><a href="#query_configuration_api">Programmatic mapping</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#query_apis">11.2.3. Querying APIs</a>
<ul class="sectlevel4">
<li><a href="#query_hibernatesearch">Hibernate Search</a>
<ul class="sectlevel5">
<li><a href="#running_lucene_queries">Running Lucene queries</a></li>
<li><a href="#using_the_hibernate_search_dsl">Using the Hibernate Search DSL</a></li>
<li><a href="#faceted_search">Faceted Search</a></li>
<li><a href="#query_spatial">Spatial Queries</a></li>
<li><a href="#query_clustered_query_api">IndexedQueryMode</a></li>
</ul>
</li>
<li><a href="#query_dsl">Infinispan Query DSL</a>
<ul class="sectlevel5">
<li><a href="#filtering_operators">Filtering operators</a></li>
<li><a href="#filtering_based_on_attributes_of_embedded_entities">Filtering based on attributes of embedded entities</a></li>
<li><a href="#boolean_conditions">Boolean conditions</a></li>
<li><a href="#nested_conditions">Nested conditions</a></li>
<li><a href="#projections">Projections</a></li>
<li><a href="#sorting">Sorting</a></li>
<li><a href="#pagination">Pagination</a></li>
<li><a href="#grouping_and_aggregation">Grouping and Aggregation</a></li>
<li><a href="#aggregations">Aggregations</a></li>
<li><a href="#evaluation_of_queries_with_grouping_and_aggregation">Evaluation of queries with grouping and aggregation</a></li>
<li><a href="#using_named_query_parameters">Using Named Query Parameters</a></li>
<li><a href="#more_query_dsl_samples">More Query DSL samples</a></li>
</ul>
</li>
<li><a href="#query_ickle">Ickle</a>
<ul class="sectlevel5">
<li><a href="#ickle_query_language_parser_syntax">Ickle Query Language Parser Syntax</a></li>
<li><a href="#fuzzy_queries">Fuzzy Queries</a></li>
<li><a href="#range_queries">Range Queries</a></li>
<li><a href="#phrase_queries">Phrase Queries</a></li>
<li><a href="#proximity_queries">Proximity Queries</a></li>
<li><a href="#wildcard_queries">Wildcard Queries</a></li>
<li><a href="#regular_expression_queries">Regular Expression Queries</a></li>
<li><a href="#boosting_queries">Boosting Queries</a></li>
</ul>
</li>
<li><a href="#query_continuous">Continuous Query</a>
<ul class="sectlevel5">
<li><a href="#continuous_query_execution">Continuous Query Execution</a></li>
<li><a href="#running_continuous_queries">Running Continuous Queries</a></li>
<li><a href="#removing_continuous_queries">Removing Continuous Queries</a></li>
<li><a href="#notes_on_performance_of_continuous_queries">Notes on performance of Continuous Queries</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#query_remote">11.3. Remote Querying</a>
<ul class="sectlevel3">
<li><a href="#storing_protobuf">11.3.1. Storing Protobuf encoded entities</a></li>
<li><a href="#indexing_of_protobuf_encoded_entries">11.3.2. Indexing of Protobuf encoded entries</a></li>
<li><a href="#a_remote_query_example">11.3.3. A remote query example</a></li>
<li><a href="#analysis">11.3.4. Analysis</a>
<ul class="sectlevel4">
<li><a href="#default_analyzers">Default Analyzers</a></li>
<li><a href="#using_analyzer_definitions">Using Analyzer Definitions</a></li>
<li><a href="#creating_custom_analyzer_definitions">Creating Custom Analyzer Definitions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#statistics">11.4. Statistics</a></li>
<li><a href="#query_performance">11.5. Performance Tuning</a>
<ul class="sectlevel3">
<li><a href="#batch_writing_in_sync_mode">11.5.1. Batch writing in SYNC mode</a></li>
<li><a href="#writing_using_async_mode">11.5.2. Writing using async mode</a></li>
<li><a href="#index_reader_async_strategy">11.5.3. Index reader async strategy</a></li>
<li><a href="#lucene_options">11.5.4. Lucene Options</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#clustered_counters">12. Clustered Counters</a>
<ul class="sectlevel2">
<li><a href="#installation_and_configuration">12.1. Installation and Configuration</a>
<ul class="sectlevel3">
<li><a href="#list_counter_names">12.1.1. List counter names</a></li>
</ul>
</li>
<li><a href="#the_countermanager_interface">12.2. The <code>CounterManager</code> interface.</a>
<ul class="sectlevel3">
<li><a href="#remove_a_counter_via_countermanager">12.2.1. Remove a counter via CounterManager</a></li>
</ul>
</li>
<li><a href="#the_counter">12.3. The Counter</a>
<ul class="sectlevel3">
<li><a href="#the_strongcounter_interface_when_the_consistency_or_bounds_matters">12.3.1. The <code>StrongCounter</code> interface: when the consistency or bounds matters.</a>
<ul class="sectlevel4">
<li><a href="#bounded_strongcounter">Bounded <code>StrongCounter</code></a></li>
<li><a href="#uses_cases">Uses cases</a></li>
<li><a href="#usage_examples">Usage Examples</a></li>
</ul>
</li>
<li><a href="#the_weakcounter_interface_when_speed_is_needed">12.3.2. The <code>WeakCounter</code> interface: when speed is needed</a>
<ul class="sectlevel4">
<li><a href="#weak_counter_interface">Weak Counter Interface</a></li>
<li><a href="#uses_cases_2">Uses cases</a></li>
<li><a href="#examples_4">Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#clustered_counters_notify_events">12.4. Notifications and Events</a></li>
</ul>
</li>
<li><a href="#clustered_lock">13. Clustered Lock</a>
<ul class="sectlevel2">
<li><a href="#installation">13.1. Installation</a></li>
<li><a href="#clusteredlock_configuration">13.2. ClusteredLock Configuration</a>
<ul class="sectlevel3">
<li><a href="#clustered_lock_ownership">13.2.1. Ownership</a></li>
<li><a href="#reentrancy">13.2.2. Reentrancy</a></li>
</ul>
</li>
<li><a href="#clusteredlockmanager_interface">13.3. ClusteredLockManager Interface</a></li>
<li><a href="#clustered_lock_interface">13.4. ClusteredLock Interface</a>
<ul class="sectlevel3">
<li><a href="#clustered_lock_usage">13.4.1. Usage Examples</a></li>
</ul>
</li>
<li><a href="#clusteredlockmanager_configuration">13.5. ClusteredLockManager Configuration</a></li>
</ul>
</li>
<li><a href="#multimap_cache">14. Multimap Cache</a>
<ul class="sectlevel2">
<li><a href="#installation_and_configuration_2">14.1. Installation and configuration</a></li>
<li><a href="#multimapcache_api">14.2. MultimapCache API</a>
<ul class="sectlevel3">
<li><a href="#completablefuturevoid_putk_key_v_value">14.2.1. CompletableFuture&lt;Void&gt; put(K key, V value)</a></li>
<li><a href="#completablefuturecollectionv_getk_key">14.2.2. CompletableFuture&lt;Collection&lt;V&gt;&gt; get(K key)</a></li>
<li><a href="#completablefutureboolean_removek_key">14.2.3. CompletableFuture&lt;Boolean&gt; remove(K key)</a></li>
<li><a href="#completablefutureboolean_removek_key_v_value">14.2.4. CompletableFuture&lt;Boolean&gt; remove(K key, V value)</a></li>
<li><a href="#completablefuturevoid_removepredicate_super_v_p">14.2.5. CompletableFuture&lt;Void&gt; remove(Predicate&lt;? super V&gt; p)</a></li>
<li><a href="#completablefutureboolean_containskeyk_key">14.2.6. CompletableFuture&lt;Boolean&gt; containsKey(K key)</a></li>
<li><a href="#completablefutureboolean_containsvaluev_value">14.2.7. CompletableFuture&lt;Boolean&gt; containsValue(V value)</a></li>
<li><a href="#completablefutureboolean_containsentryk_key_v_value">14.2.8. CompletableFuture&lt;Boolean&gt; containsEntry(K key, V value)</a></li>
<li><a href="#completablefuturelong_size">14.2.9. CompletableFuture&lt;Long&gt; size()</a></li>
<li><a href="#boolean_supportsduplicates">14.2.10. boolean supportsDuplicates()</a></li>
</ul>
</li>
<li><a href="#creating_a_multimap_cache">14.3. Creating a Multimap Cache</a>
<ul class="sectlevel3">
<li><a href="#embedded_mode">14.3.1. Embedded mode</a></li>
</ul>
</li>
<li><a href="#limitations_2">14.4. Limitations</a>
<ul class="sectlevel3">
<li><a href="#support_for_duplicates">14.4.1. Support for duplicates</a></li>
<li><a href="#eviction">14.4.2. Eviction</a></li>
<li><a href="#transactions_2">14.4.3. Transactions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cdi_support">15. CDI Support</a>
<ul class="sectlevel2">
<li><a href="#maven_dependencies">15.1. Maven Dependencies</a></li>
<li><a href="#embedded_cache_integration">15.2. Embedded cache integration</a>
<ul class="sectlevel3">
<li><a href="#inject_an_embedded_cache">15.2.1. Inject an embedded cache</a></li>
<li><a href="#override_the_default_embedded_cache_manager_and_configuration">15.2.2. Override the default embedded cache manager and configuration</a></li>
<li><a href="#configure_the_transport_for_clustered_use">15.2.3. Configure the transport for clustered use</a></li>
</ul>
</li>
<li><a href="#remote_cache_integration">15.3. Remote cache integration</a>
<ul class="sectlevel3">
<li><a href="#inject_a_remote_cache">15.3.1. Inject a remote cache</a></li>
<li><a href="#override_the_default_remote_cache_manager">15.3.2. Override the default remote cache manager</a></li>
</ul>
</li>
<li><a href="#use_a_custom_remoteembedded_cache_manager_for_one_or_more_cache">15.4. Use a custom remote/embedded cache manager for one or more cache</a></li>
<li><a href="#use_jcache_caching_annotations">15.5. Use JCache caching annotations</a></li>
<li><a href="#use_cache_events_and_cdi">15.6. Use Cache events and CDI</a></li>
</ul>
</li>
<li><a href="#jcache_jsr_107">16. JCache (JSR-107) provider</a>
<ul class="sectlevel2">
<li><a href="#dependencies_2">16.1. Dependencies</a></li>
<li><a href="#create_a_local_cache">16.2. Create a local cache</a></li>
<li><a href="#create_a_remote_cache">16.3. Create a remote cache</a></li>
<li><a href="#store_and_retrieve_data">16.4. Store and retrieve data</a></li>
<li><a href="#comparing_java_util_concurrent_concurrentmap_and_javax_cache_cache_apis">16.5. Comparing java.util.concurrent.ConcurrentMap and javax.cache.Cache APIs</a></li>
<li><a href="#clustering_jcache_instances">16.6. Clustering JCache instances</a></li>
</ul>
</li>
<li><a href="#jmx_mgmt_tooling">17. Management Tooling</a>
<ul class="sectlevel2">
<li><a href="#jmx">17.1. JMX</a>
<ul class="sectlevel3">
<li><a href="#understanding_the_exposed_mbeans">17.1.1. Understanding The Exposed MBeans</a></li>
<li><a href="#enabling_jmx_statistics">17.1.2. Enabling JMX Statistics</a></li>
<li><a href="#monitoring_cluster_health">17.1.3. Monitoring cluster health</a></li>
<li><a href="#multiple_jmx_domains">17.1.4. Multiple JMX Domains</a></li>
<li><a href="#registering_mbeans_in_non_default_mbean_servers">17.1.5. Registering MBeans In Non-Default MBean Servers</a></li>
<li><a href="#available_mbeans">17.1.6. Available MBeans</a></li>
</ul>
</li>
<li><a href="#command_line_interface">17.2. Command-Line Interface (CLI)</a>
<ul class="sectlevel3">
<li><a href="#commands">17.2.1. Commands</a>
<ul class="sectlevel4">
<li><a href="#abort">abort</a></li>
<li><a href="#begin">begin</a></li>
<li><a href="#cache">cache</a></li>
<li><a href="#clearcache">clearcache</a></li>
<li><a href="#commit">commit</a></li>
<li><a href="#container">container</a></li>
<li><a href="#create">create</a></li>
<li><a href="#deny">deny</a></li>
<li><a href="#disconnect">disconnect</a></li>
<li><a href="#encoding">encoding</a></li>
<li><a href="#end">end</a></li>
<li><a href="#evict">evict</a></li>
<li><a href="#get">get</a></li>
<li><a href="#grant">grant</a></li>
<li><a href="#info">info</a></li>
<li><a href="#locate">locate</a></li>
<li><a href="#put">put</a></li>
<li><a href="#replace">replace</a></li>
<li><a href="#roles">roles</a></li>
<li><a href="#rollback">rollback</a></li>
<li><a href="#site">site</a></li>
<li><a href="#start">start</a></li>
<li><a href="#stats">stats</a></li>
</ul>
</li>
<li><a href="#upgrade">17.2.2. upgrade</a></li>
<li><a href="#version">17.2.3. version</a></li>
<li><a href="#data_types">17.2.4. Data Types</a></li>
<li><a href="#time_values">17.2.5. Time Values</a></li>
<li><a href="#starting_stopping_endpoints">17.2.6. Starting and Stopping Infinispan Endpoints</a></li>
</ul>
</li>
<li><a href="#hawt_io">17.3. Hawt.io</a></li>
<li><a href="#writing_plugins_for_other_management_tools">17.4. Writing plugins for other management tools</a></li>
</ul>
</li>
<li><a href="#custom_interceptors_chapter">18. Custom Interceptors</a>
<ul class="sectlevel2">
<li><a href="#adding_custom_interceptors_declaratively">18.1. Adding custom interceptors declaratively</a></li>
<li><a href="#adding_custom_interceptors_programatically">18.2. Adding custom interceptors programatically</a></li>
<li><a href="#custom_interceptor_design">18.3. Custom interceptor design</a></li>
</ul>
</li>
<li><a href="#cloud_services">19. Running on Cloud Services</a>
<ul class="sectlevel2">
<li><a href="#generic_discovery_protocols">19.1. Generic Discovery protocols</a>
<ul class="sectlevel3">
<li><a href="#tcpping">19.1.1. TCPPing</a></li>
<li><a href="#gossiprouter">19.1.2. GossipRouter</a></li>
</ul>
</li>
<li><a href="#amazon_web_services">19.2. Amazon Web Services</a></li>
<li><a href="#native_s3_ping">19.3. NATIVE_S3_PING</a>
<ul class="sectlevel3">
<li><a href="#jdbc_ping">19.3.1. JDBC_PING</a></li>
</ul>
</li>
<li><a href="#microsoft_azure">19.4. Microsoft Azure</a>
<ul class="sectlevel3">
<li><a href="#azure_ping">19.4.1. AZURE_PING</a></li>
</ul>
</li>
<li><a href="#google_compute_engine">19.5. Google Compute Engine</a>
<ul class="sectlevel3">
<li><a href="#google_ping">19.5.1. GOOGLE_PING</a></li>
</ul>
</li>
<li><a href="#cloud_services_k8s">19.6. Kubernetes</a>
<ul class="sectlevel3">
<li><a href="#cloud_services_kube_ping">19.6.1. Kube_PING</a></li>
<li><a href="#cloud_services_dns_ping">19.6.2. DNS_PING</a></li>
<li><a href="#using_kubernetes_and_openshift_rolling_updates">19.6.3. Using Kubernetes and OpenShift Rolling Updates</a></li>
<li><a href="#rolling_upgrades_with_kubernetes_and_openshift">19.6.4. Rolling upgrades with Kubernetes and OpenShift</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#client_server">20. Client/Server</a>
<ul class="sectlevel2">
<li><a href="#why_clientserver">20.1. Why Client/Server?</a></li>
<li><a href="#why_use_embedded_mode">20.2. Why use embedded mode?</a></li>
<li><a href="#server_modules">20.3. Server Modules</a></li>
<li><a href="#which_protocol_should_i_use">20.4. Which protocol should I use?</a></li>
<li><a href="#hot_rod_server_usage">20.5. Using Hot Rod Server</a></li>
<li><a href="#hot_rod_protocol">20.6. Hot Rod Protocol</a>
<ul class="sectlevel3">
<li><a href="#hot_rod_protocol_1_0">20.6.1. Hot Rod Protocol 1.0</a>
<ul class="sectlevel4">
<li><a href="#request_header">Request Header</a></li>
<li><a href="#hot_rod_response_header">Response Header</a></li>
<li><a href="#topology_change_headers">Topology Change Headers</a></li>
<li><a href="#topology_aware_client_topology_change_header">Topology-Aware Client Topology Change Header</a></li>
<li><a href="#distribution_aware_client_topology_change_header">Distribution-Aware Client Topology Change Header</a></li>
<li><a href="#operations">Operations</a></li>
<li><a href="#example_put_request">Example - Put request</a></li>
</ul>
</li>
<li><a href="#hot_rod_protocol_1_1">20.6.2. Hot Rod Protocol 1.1</a>
<ul class="sectlevel4">
<li><a href="#request_header_2">Request Header</a></li>
<li><a href="#distribution_aware_client_topology_change_header_2">Distribution-Aware Client Topology Change Header</a></li>
<li><a href="#server_node_hash_code_calculation">Server node hash code calculation</a></li>
</ul>
</li>
<li><a href="#hot_rod_protocol_1_2">20.6.3. Hot Rod Protocol 1.2</a>
<ul class="sectlevel4">
<li><a href="#request_header_3">Request Header</a></li>
<li><a href="#response_header">Response Header</a></li>
<li><a href="#operations_2">Operations</a></li>
</ul>
</li>
<li><a href="#hot_rod_protocol_1_3">20.6.4. Hot Rod Protocol 1.3</a>
<ul class="sectlevel4">
<li><a href="#request_header_4">Request Header</a></li>
<li><a href="#response_header_2">Response Header</a></li>
<li><a href="#operations_3">Operations</a></li>
</ul>
</li>
<li><a href="#hot_rod_protocol_2_0">20.6.5. Hot Rod Protocol 2.0</a>
<ul class="sectlevel4">
<li><a href="#request_header_5">Request Header</a></li>
<li><a href="#response_header_3">Response Header</a></li>
<li><a href="#distribution_aware_client_topology_change_header_3">Distribution-Aware Client Topology Change Header</a></li>
<li><a href="#operations_4">Operations</a></li>
<li><a href="#remote_events">Remote Events</a></li>
</ul>
</li>
<li><a href="#hot_rod_protocol_2_1">20.6.6. Hot Rod Protocol 2.1</a>
<ul class="sectlevel4">
<li><a href="#request_header_6">Request Header</a></li>
<li><a href="#operations_5">Operations</a></li>
</ul>
</li>
<li><a href="#hot_rod_protocol_2_2">20.6.7. Hot Rod Protocol 2.2</a>
<ul class="sectlevel4">
<li><a href="#operations_6">Operations</a></li>
</ul>
</li>
<li><a href="#hot_rod_protocol_2_3">20.6.8. Hot Rod Protocol 2.3</a>
<ul class="sectlevel4">
<li><a href="#operations_7">Operations</a></li>
</ul>
</li>
<li><a href="#hot_rod_protocol_2_4">20.6.9. Hot Rod Protocol 2.4</a>
<ul class="sectlevel4">
<li><a href="#operations_8">Operations</a></li>
</ul>
</li>
<li><a href="#hot_rod_protocol_2_5">20.6.10. Hot Rod Protocol 2.5</a></li>
<li><a href="#hot_rod_protocol_2_6">20.6.11. Hot Rod Protocol 2.6</a></li>
<li><a href="#hot_rod_protocol_2_7">20.6.12. Hot Rod Protocol 2.7</a></li>
<li><a href="#hot_rod_protocol_2_8">20.6.13. Hot Rod Protocol 2.8</a>
<ul class="sectlevel4">
<li><a href="#request_header_7">Request Header</a></li>
</ul>
</li>
<li><a href="#hot_rod_protocol_2_9">20.6.14. Hot Rod Protocol 2.9</a></li>
<li><a href="#hot_rod_hash_functions">20.6.15. Hot Rod Hash Functions</a></li>
<li><a href="#hot_rod_admin_tasks">20.6.16. Hot Rod Admin Tasks</a>
<ul class="sectlevel4">
<li><a href="#admin_tasks">Admin tasks</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#hotrod_java_client">20.7. Java Hot Rod client</a>
<ul class="sectlevel3">
<li><a href="#configuration_9">20.7.1. Configuration</a></li>
<li><a href="#authentication">20.7.2. Authentication</a>
<ul class="sectlevel4">
<li><a href="#digest_md5">DIGEST-MD5</a></li>
<li><a href="#plain">PLAIN</a></li>
<li><a href="#external">EXTERNAL</a></li>
<li><a href="#gssapi_kerberos">GSSAPI (Kerberos)</a></li>
<li><a href="#custom_callbackhandlers">Custom CallbackHandlers</a></li>
</ul>
</li>
<li><a href="#hr_encryption">20.7.3. Encryption</a>
<ul class="sectlevel4">
<li><a href="#sni">SNI</a></li>
<li><a href="#client_certificates">Client certificates</a></li>
</ul>
</li>
<li><a href="#hr_basic_api">20.7.4. Basic API</a></li>
<li><a href="#remotecache_keyset_entryset_values">20.7.5. RemoteCache(.keySet|.entrySet|.values)</a></li>
<li><a href="#remote_iterator">20.7.6. Remote Iterator</a></li>
<li><a href="#hr_versioned_api">20.7.7. Versioned API</a></li>
<li><a href="#async_api">20.7.8. Async API</a></li>
<li><a href="#streaming_api">20.7.9. Streaming API</a></li>
<li><a href="#creating_event_listeners">20.7.10. Creating Event Listeners</a></li>
<li><a href="#removing_event_listeners">20.7.11. Removing Event Listeners</a></li>
<li><a href="#filtering_events">20.7.12. Filtering Events</a></li>
<li><a href="#skipping_notifications">20.7.13. Skipping Notifications</a></li>
<li><a href="#customizing_events">20.7.14. Customizing Events</a></li>
<li><a href="#filter_and_custom_events">20.7.15. Filter and Custom Events</a></li>
<li><a href="#event_marshalling">20.7.16. Event Marshalling</a>
<ul class="sectlevel4">
<li><a href="#protostream_deployment">Deploying Protostream Marshallers</a></li>
</ul>
</li>
<li><a href="#listener_state_handling">20.7.17. Listener State Handling</a></li>
<li><a href="#listener_failure_handling">20.7.18. Listener Failure Handling</a></li>
<li><a href="#near_caching">20.7.19. Near Caching</a></li>
<li><a href="#unsupported_methods">20.7.20. Unsupported methods</a></li>
<li><a href="#return_values_2">20.7.21. Return values</a></li>
<li><a href="#hr_transactions">20.7.22. Hot Rod Transactions</a>
<ul class="sectlevel4">
<li><a href="#hr_transactions_config_server">Configuring the Server</a></li>
<li><a href="#hr_transactions_config_client">Configuring Hot Rod Clients</a>
<ul class="sectlevel5">
<li><a href="#hr_transactions_tmlookup">TransactionManagerLookup Interface</a></li>
<li><a href="#hr_transactions_modes">Transaction Modes</a></li>
</ul>
</li>
<li><a href="#hr_transactions_override_rcm">Overriding Configuration for Cache Instances</a></li>
<li><a href="#hr_transactions_force_return_value">Detecting Conflicts with Transactions</a></li>
<li><a href="#hr_transactions_ex_use_config">Using the Configured Transaction Manager and Transaction Mode</a></li>
<li><a href="#hr_transactions_ex_override_tm">Overriding the Transaction Manager</a></li>
<li><a href="#hr_transactions_ex_override_mode">Overriding the Transaction Mode</a></li>
</ul>
</li>
<li><a href="#client_intelligence">20.7.23. Client Intelligence</a>
<ul class="sectlevel4">
<li><a href="#request_balancing">Request Balancing</a></li>
</ul>
</li>
<li><a href="#persistent_connections">20.7.24. Persistent connections</a></li>
<li><a href="#hot_rod_marshalling_data">20.7.25. Marshalling data</a></li>
<li><a href="#reading_data_in_different_data_formats">20.7.26. Reading data in different data formats</a>
<ul class="sectlevel4">
<li><a href="#using_different_marshallers_for_key_and_values">Using different marshallers for Key and Values</a></li>
<li><a href="#reading_data_in_different_formats">Reading data in different formats</a></li>
</ul>
</li>
<li><a href="#statistics_2">20.7.27. Statistics</a></li>
<li><a href="#multi_get_operations">20.7.28. Multi-Get Operations</a></li>
<li><a href="#server_hotrod_failover">20.7.29. Failover capabilities</a></li>
<li><a href="#site_cluster_failover">20.7.30. Site Cluster Failover</a></li>
<li><a href="#manual_site_cluster_switch">20.7.31. Manual Site Cluster Switch</a></li>
<li><a href="#hotrod_java_client_monitoring">20.7.32. Monitoring the Hot Rod client</a></li>
<li><a href="#concurrent_updates">20.7.33. Concurrent Updates</a>
<ul class="sectlevel4">
<li><a href="#data_consistency_problem">Data Consistency Problem</a></li>
<li><a href="#embedded_mode_solution">Embedded-mode Solution</a></li>
<li><a href="#client_server_solution">Client-Server Solution</a></li>
</ul>
</li>
<li><a href="#javadocs">20.7.34. Javadocs</a></li>
</ul>
</li>
<li><a href="#rest_server">20.8. REST Server</a>
<ul class="sectlevel3">
<li><a href="#rest_run_server">20.8.1. Running the REST server</a>
<ul class="sectlevel4">
<li><a href="#rest_security">Security</a></li>
</ul>
</li>
<li><a href="#rest_supported_protocols">20.8.2. Supported protocols</a></li>
<li><a href="#rest_api">20.8.3. REST API</a>
<ul class="sectlevel4">
<li><a href="#rest_server_data_format">Data formats</a>
<ul class="sectlevel5">
<li><a href="#rest_server_data_format_config">Configuration</a></li>
<li><a href="#rest_server_data_format_support">Supported formats</a></li>
<li><a href="#rest_accept">Accept header</a></li>
<li><a href="#rest_key_content_type">Key-Content-Type header</a></li>
</ul>
</li>
<li><a href="#rest_server_put_data">Putting data in</a>
<ul class="sectlevel5">
<li><a href="#rest_server_put_request"><code>PUT /{cacheName}/{cacheKey}</code></a></li>
<li><a href="#rest_server_post_request"><code>POST /{cacheName}/{cacheKey}</code></a></li>
</ul>
</li>
<li><a href="#rest_server_get_data">Getting data back out</a>
<ul class="sectlevel5">
<li><a href="#rest_server_get_request"><code>GET /{cacheName}/{cacheKey}</code></a></li>
<li><a href="#rest_server_head_request"><code>HEAD /{cacheName}/{cacheKey}</code></a></li>
</ul>
</li>
<li><a href="#rest_server_list_keys">Listing keys</a>
<ul class="sectlevel5">
<li><a href="#rest_server_list_get"><code>GET /{cacheName}</code></a></li>
</ul>
</li>
<li><a href="#rest_server_remove_data">Removing data</a>
<ul class="sectlevel5">
<li><a href="#rest_server_delete_keys"><code>DELETE /{cacheName}/{cacheKey}</code></a></li>
<li><a href="#rest_server_delete_cache"><code>DELETE /{cacheName}</code></a></li>
</ul>
</li>
<li><a href="#rest_server_query">Querying</a>
<ul class="sectlevel5">
<li><a href="#rest_server_query_get"><code>GET /{cacheName}?action=search&amp;query={ickle query}</code></a></li>
<li><a href="#rest_server_query_post"><code>POST /{cacheName}?action=search</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#rest_server_cors">20.8.4. CORS</a></li>
<li><a href="#rest_server_client">20.8.5. Client side code</a>
<ul class="sectlevel4">
<li><a href="#rest_server_client_ruby">Ruby example</a></li>
<li><a href="#rest_server_client_python">Python 3 example</a></li>
<li><a href="#rest_server_client_java">Java example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#memcached_server">20.9. Memcached Server</a>
<ul class="sectlevel3">
<li><a href="#memcached_client_encoding">20.9.1. Client Encoding</a></li>
<li><a href="#command_clarifications">20.9.2. Command Clarifications</a>
<ul class="sectlevel4">
<li><a href="#flush_all">Flush All</a></li>
</ul>
</li>
<li><a href="#unsupported_features">20.9.3. Unsupported Features</a>
<ul class="sectlevel4">
<li><a href="#individual_stats">Individual Stats</a></li>
<li><a href="#statistic_settings">Statistic Settings</a></li>
<li><a href="#settings_with_arguments_parameter">Settings with Arguments Parameter</a></li>
<li><a href="#delete_hold_time_parameter">Delete Hold Time Parameter</a></li>
<li><a href="#verbosity_command">Verbosity Command</a></li>
</ul>
</li>
<li><a href="#talking_to_infinispan_memcached_servers_from_non_java_clients">20.9.4. Talking To Infinispan Memcached Servers From Non-Java Clients</a>
<ul class="sectlevel4">
<li><a href="#multi_clustered_server_tutorial">Multi Clustered Server Tutorial</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#execute_code_remote_grid">20.10. Executing code in the Remote Grid</a></li>
<li><a href="#scripting">20.11. Scripting</a>
<ul class="sectlevel3">
<li><a href="#installing_scripts">20.11.1. Installing scripts</a></li>
<li><a href="#script_metadata">20.11.2. Script metadata</a>
<ul class="sectlevel4">
<li><a href="#metadata_properties">Metadata properties</a></li>
</ul>
</li>
<li><a href="#script_bindings">20.11.3. Script bindings</a></li>
<li><a href="#script_parameters">20.11.4. Script parameters</a></li>
<li><a href="#running_scripts_using_the_hot_rod_java_client">20.11.5. Running Scripts using the Hot Rod Java client</a></li>
<li><a href="#distributed_execution_2">20.11.6. Distributed execution</a></li>
</ul>
</li>
<li><a href="#server_tasks">20.12. Server Tasks</a></li>
</ul>
</li>
<li><a href="#compat_mode">21. Compatibility Mode</a>
<ul class="sectlevel2">
<li><a href="#enable_compatibility_mode">21.1. Enable Compatibility Mode</a>
<ul class="sectlevel3">
<li><a href="#optional_configuring_compatibility_marshaller">21.1.1. Optional: Configuring Compatibility Marshaller</a></li>
</ul>
</li>
<li><a href="#code_examples">21.2. Code examples</a></li>
</ul>
</li>
<li><a href="#endpoint_interop">22. Protocol Interoperability</a>
<ul class="sectlevel2">
<li><a href="#considerations_with_media_types_and_endpoint_interoperability">22.1. Considerations with Media Types and Endpoint Interoperability</a></li>
<li><a href="#rest_hot_rod_and_memcached_interoperability_with_text_based_storage">22.2. REST, Hot Rod, and Memcached Interoperability with Text-Based Storage</a></li>
<li><a href="#rest_hot_rod_and_memcached_interoperability_with_custom_java_objects">22.3. REST, Hot Rod, and Memcached Interoperability with Custom Java Objects</a></li>
<li><a href="#java_and_non_java_client_interoperability_with_protobuf">22.4. Java and Non-Java Client Interoperability with Protobuf</a></li>
<li><a href="#embedded_remote_interop">22.5. Custom Code Interoperability</a>
<ul class="sectlevel3">
<li><a href="#converting_data_on_demand">22.5.1. Converting Data On Demand</a></li>
<li><a href="#storing_data_as_pojos">22.5.2. Storing Data as POJOs</a></li>
</ul>
</li>
<li><a href="#entities_deploy">22.6. Deploying Entity Classes</a></li>
<li><a href="#trying_the_interoperability_demo">22.7. Trying the Interoperability Demo</a></li>
</ul>
</li>
<li><a href="#security">23. Security</a>
<ul class="sectlevel2">
<li><a href="#security_embedded">23.1. Embedded Security</a>
<ul class="sectlevel3">
<li><a href="#security_embedded_permissions">23.1.1. Embedded Permissions</a>
<ul class="sectlevel4">
<li><a href="#security_embedded_cache_mgr_permissions">Cache Manager permissions</a></li>
<li><a href="#security_embedded_cache_permissions">Cache permissions</a></li>
</ul>
</li>
<li><a href="#security_embedded_api">23.1.2. Embedded API</a></li>
<li><a href="#security_embedded_config">23.1.3. Embedded Configuration</a>
<ul class="sectlevel4">
<li><a href="#security_role_mappers">Role Mappers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#security_cluster">23.2. Cluster security</a></li>
</ul>
</li>
<li><a href="#integrations">24. Integrations</a>
<ul class="sectlevel2">
<li><a href="#apache_spark">24.1. Apache Spark</a></li>
<li><a href="#apache_hadoop">24.2. Apache Hadoop</a></li>
<li><a href="#integrations_lucene_directory">24.3. Apache Lucene</a>
<ul class="sectlevel3">
<li><a href="#lucene_compatibility">24.3.1. Lucene compatibility</a></li>
<li><a href="#maven_dependencies_2">24.3.2. Maven dependencies</a></li>
<li><a href="#how_to_use_it">24.3.3. How to use it</a></li>
<li><a href="#configuration_10">24.3.4. Configuration</a>
<ul class="sectlevel4">
<li><a href="#lock_cache">Lock Cache</a></li>
<li><a href="#metadata_cache">Metadata Cache</a></li>
<li><a href="#data_cache">Data Cache</a></li>
</ul>
</li>
<li><a href="#using_a_cacheloader">24.3.5. Using a CacheLoader</a></li>
<li><a href="#storing_the_index_in_a_database">24.3.6. Storing the index in a database</a></li>
<li><a href="#loading_an_existing_lucene_index">24.3.7. Loading an existing Lucene Index</a></li>
<li><a href="#architectural_limitations">24.3.8. Architectural limitations</a></li>
<li><a href="#suggestions_for_optimal_performance">24.3.9. Suggestions for optimal performance</a>
<ul class="sectlevel4">
<li><a href="#jgroups_and_networking_stack">JGroups and networking stack</a></li>
<li><a href="#using_a_cachestore">Using a CacheStore</a></li>
<li><a href="#apply_standard_lucene_tuning">Apply standard Lucene tuning</a></li>
<li><a href="#disable_batching_and_transactions">Disable batching and transactions</a></li>
<li><a href="#set_the_right_chunk_size">Set the right chunk size</a></li>
</ul>
</li>
<li><a href="#demo">24.3.10. Demo</a></li>
<li><a href="#additional_links">24.3.11. Additional Links</a></li>
</ul>
</li>
<li><a href="#integrations_directory_provider">24.4. Directory Provider for Hibernate Search</a>
<ul class="sectlevel3">
<li><a href="#maven_dependencies_3">24.4.1. Maven dependencies</a></li>
<li><a href="#how_to_use_it_2">24.4.2. How to use it</a></li>
<li><a href="#configuration_11">24.4.3. Configuration</a></li>
<li><a href="#architecture_considerations">24.4.4. Architecture considerations</a></li>
</ul>
</li>
<li><a href="#integrations_jpa_hibernate">24.5. JPA/Hibernate 2L Cache</a>
<ul class="sectlevel3">
<li><a href="#deployment_scenarios">24.5.1. Deployment Scenarios</a>
<ul class="sectlevel4">
<li><a href="#single_node_standalone_hibernate_application">Single-Node Standalone Hibernate Application</a></li>
<li><a href="#single_node_standalone_spring_application">Single-Node Standalone Spring Application</a></li>
<li><a href="#single_node_wildfly_application">Single-Node WildFly Application</a></li>
<li><a href="#multi_node_standalone_hibernate_application">Multi-Node Standalone Hibernate Application</a></li>
<li><a href="#multi_node_standalone_spring_application">Multi-Node Standalone Spring Application</a></li>
<li><a href="#multi_node_wildfly_application">Multi-Node Wildfly Application</a></li>
</ul>
</li>
<li><a href="#configuration_reference">24.5.2. Configuration Reference</a>
<ul class="sectlevel4">
<li><a href="#default_local_configuration_second_level">Default Local Configuration</a></li>
<li><a href="#default_cluster_configuration_second_level">Default Cluster Configuration</a></li>
<li><a href="#configuration_properties">Configuration Properties</a></li>
</ul>
</li>
<li><a href="#cache_strategies">24.5.3. Cache Strategies</a></li>
<li><a href="#using_minimal_puts">24.5.4. Using minimal puts</a></li>
</ul>
</li>
<li><a href="#integrations_hibernate_ogm">24.6. JPA / Hibernate OGM</a></li>
<li><a href="#spring_integration">24.7. Using Infinispan with Spring</a>
<ul class="sectlevel3">
<li><a href="#spring_boot_starter">24.7.1. Spring Boot Starter</a></li>
<li><a href="#spring_cache_provider">24.7.2. Setting Up Infinispan as a Spring Cache Provider</a>
<ul class="sectlevel4">
<li><a href="#spring_add_support">Adding Spring Cache Support</a></li>
<li><a href="#spring_configure_cache_provider">Configuring Infinispan as the Spring Cache Provider</a></li>
</ul>
</li>
<li><a href="#spring_add_caching">24.7.3. Adding Caching to Your Application</a>
<ul class="sectlevel4">
<li><a href="#spring_add_entries">Adding Cache Entries</a></li>
<li><a href="#spring_remove_entries">Deleting Cache Entries</a></li>
</ul>
</li>
<li><a href="#spring_configure_timeouts">24.7.4. Configuring Timeouts for Cache Operations</a></li>
<li><a href="#spring_externalize_sessions">24.7.5. Externalizing Sessions Using Spring Session</a></li>
</ul>
</li>
<li><a href="#infinispan_modules_for_wildfly_eap">24.8. Infinispan modules for WildFly / EAP</a>
<ul class="sectlevel3">
<li><a href="#modules_installation_section">24.8.1. Installation</a></li>
<li><a href="#application_dependencies">24.8.2. Application Dependencies</a>
<ul class="sectlevel4">
<li><a href="#infinispan_core">Infinispan core</a></li>
<li><a href="#remote">Remote</a></li>
<li><a href="#embedded_query">Embedded Query</a></li>
<li><a href="#lucene_directory">Lucene Directory</a></li>
<li><a href="#hibernate_search_directory_provider_for_infinispan">Hibernate Search directory provider for Infinispan</a>
<ul class="sectlevel5">
<li><a href="#usage_with_wildfly_internal_hibernate_search_modules">Usage with WildFly Internal Hibernate Search Modules</a></li>
<li><a href="#usage_with_other_hibernate_search_modules">Usage with other Hibernate Search modules</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#usage">24.8.3. Usage</a>
<ul class="sectlevel4">
<li><a href="#embedded_mode_2">Embedded Mode</a></li>
<li><a href="#server_mode">Server Mode</a>
<ul class="sectlevel5">
<li><a href="#configuration_12">Configuration</a></li>
<li><a href="#accessing_containers_and_caches">Accessing Containers and Caches</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#troubleshooting_2">24.8.4. Troubleshooting</a>
<ul class="sectlevel4">
<li><a href="#enable_logging">Enable logging</a></li>
<li><a href="#print_dependency_tree">Print dependency tree</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#grid_file">25. Grid File System</a>
<ul class="sectlevel2">
<li><a href="#webdav_demo">25.1. WebDAV demo</a></li>
</ul>
</li>
<li><a href="#x_site_replication">26. Cross site replication</a>
<ul class="sectlevel2">
<li><a href="#sample_deployment">26.1. Sample deployment</a>
<ul class="sectlevel3">
<li><a href="#local_clusters_jgroups_xml_configuration">26.1.1. Local cluster&#8217;s jgroups .xml configuration</a></li>
<li><a href="#relay2_configuration_file">26.1.2. RELAY2 configuration file</a></li>
</ul>
</li>
<li><a href="#data_replication">26.2. Data replication</a>
<ul class="sectlevel3">
<li><a href="#non_transactional_caches_2">26.2.1. Non transactional caches</a></li>
<li><a href="#transactional_caches_2">26.2.2. Transactional caches</a>
<ul class="sectlevel4">
<li><a href="#synchronous_local_cluster_with_async_backup">Synchronous local cluster with async backup</a></li>
<li><a href="#synchronous_local_cluster_with_sync_backup">Synchronous local cluster with sync backup</a></li>
<li><a href="#asynchronous_local_cluster">Asynchronous local cluster</a></li>
</ul>
</li>
<li><a href="#replication_of_expired_cache_entries_across_sites">26.2.3. Replication of expired cache entries across sites</a></li>
<li><a href="#xsite_concurrent_writes">26.2.4. Deadlocks and Conflicting Entries</a></li>
</ul>
</li>
<li><a href="#taking_a_site_offline">26.3. Taking a site offline</a>
<ul class="sectlevel3">
<li><a href="#configuration_13">26.3.1. Configuration</a></li>
<li><a href="#bringing_sites_back_online">26.3.2. Bringing Sites Back Online</a></li>
</ul>
</li>
<li><a href="#pushing_state_transfer_to_sites">26.4. Pushing State Transfer to Sites</a>
<ul class="sectlevel3">
<li><a href="#handling_joinleave_nodes">26.4.1. Handling join/leave nodes</a></li>
<li><a href="#handling_broken_link_between_sites">26.4.2. Handling broken link between sites</a></li>
<li><a href="#system_administrator_operations">26.4.3. System Administrator Operations</a></li>
<li><a href="#x_site_st_configuration">26.4.4. Configuration</a></li>
</ul>
</li>
<li><a href="#x_site_reference">26.5. Reference</a></li>
</ul>
</li>
<li><a href="#rolling_upgrades">27. Performing Rolling Upgrades</a>
<ul class="sectlevel2">
<li><a href="#setting_up_a_target_cluster">27.1. Setting Up a Target Cluster</a></li>
<li><a href="#synchronizing_data_from_the_source_cluster">27.2. Synchronizing Data from the Source Cluster</a></li>
<li><a href="#custom_commands">27.3. Custom Commands</a>
<ul class="sectlevel3">
<li><a href="#an_example">27.3.1. An Example</a></li>
<li><a href="#preassigned_custom_command_id_ranges">27.3.2. Preassigned Custom Command Id Ranges</a></li>
</ul>
</li>
<li><a href="#extending_the_configuration_builders_and_parsers">27.4. Extending the configuration builders and parsers</a></li>
</ul>
</li>
<li><a href="#arch_overview">28. Architectural Overview</a>
<ul class="sectlevel2">
<li><a href="#cache_hierarchy">28.1. Cache hierarchy</a></li>
<li><a href="#arch_commands">28.2. Commands</a></li>
<li><a href="#visitors">28.3. Visitors</a></li>
<li><a href="#interceptors">28.4. Interceptors</a></li>
<li><a href="#putting_it_all_together">28.5. Putting it all together</a></li>
<li><a href="#subsystem_managers">28.6. Subsystem Managers</a>
<ul class="sectlevel3">
<li><a href="#distributionmanager">28.6.1. DistributionManager</a></li>
<li><a href="#transactionmanager">28.6.2. TransactionManager</a></li>
<li><a href="#rpcmanager">28.6.3. RpcManager</a></li>
<li><a href="#lockmanager">28.6.4. LockManager</a></li>
<li><a href="#persistencemanager">28.6.5. PersistenceManager</a></li>
<li><a href="#datacontainer">28.6.6. DataContainer</a></li>
<li><a href="#configuration_14">28.6.7. Configuration</a></li>
</ul>
</li>
<li><a href="#componentregistry">28.7. ComponentRegistry</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Welcome to the official Infinispan user guide.
This comprehensive document will guide you through every last detail of Infinispan.
Because of this, it can be a poor starting point if you are new to Infinispan.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For newbies, starting with the <a href="../getting_started/getting_started.html">Getting Started Guide</a>
or one of the <a href="http://www.infinispan.org/documentation">Quickstarts</a> is probably a better bet.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="../faqs/faqs.html">Frequently Asked Questions</a> and <a href="../glossary/glossary.html">Glossary</a>
are also useful documents to have alongside this user guide.</p>
</div>
<div class="sect2">
<h3 id="what_is_infinispan"><a class="anchor" href="#what_is_infinispan"></a>1.1. What is Infinispan ?</h3>
<div class="paragraph">
<p>Infinispan is a distributed in-memory key/value data store with optional schema, available under the Apache License 2.0.
It can be used both as an embedded Java library and as a language-independent service accessed remotely over a variety of
protocols (Hot Rod, REST, Memcached and WebSockets). It offers advanced functionality such as transactions, events,
querying and distributed processing as well as numerous integrations with frameworks such as the JCache API standard,
CDI, Hibernate, WildFly, Spring Cache, Spring Session, Lucene, Spark and Hadoop.</p>
</div>
</div>
<div class="sect2">
<h3 id="why_use_infinispan"><a class="anchor" href="#why_use_infinispan"></a>1.2. Why use Infinispan ?</h3>
<div class="sect3">
<h4 id="as_a_local_cache"><a class="anchor" href="#as_a_local_cache"></a>1.2.1. As a local cache</h4>
<div class="paragraph">
<p>The primary use for Infinispan is to provide a fast in-memory cache of frequently accessed data. Suppose you have a slow
data source (database, web service, text file, etc): you could load some or all of that data in memory so that it&#8217;s just a
memory access away from your code. Using Infinispan is better than using a simple ConcurrentHashMap, since it has additional
useful features such as expiration and eviction.</p>
</div>
</div>
<div class="sect3">
<h4 id="as_a_clustered_cache"><a class="anchor" href="#as_a_clustered_cache"></a>1.2.2. As a clustered cache</h4>
<div class="paragraph">
<p>If your data doesn&#8217;t fit in a single node, or you want to invalidate entries across multiple instances of your application,
Infinispan can scale horizontally to several hundred nodes.</p>
</div>
</div>
<div class="sect3">
<h4 id="as_a_clustering_building_block_for_your_applications"><a class="anchor" href="#as_a_clustering_building_block_for_your_applications"></a>1.2.3. As a clustering building block for your applications</h4>
<div class="paragraph">
<p>If you need to make your application cluster-aware, integrate Infinispan and get access to features like topology change
notifications, cluster communication and clustered execution.</p>
</div>
</div>
<div class="sect3">
<h4 id="as_a_remote_cache"><a class="anchor" href="#as_a_remote_cache"></a>1.2.4. As a remote cache</h4>
<div class="paragraph">
<p>If you want to be able to scale your caching layer independently from your application, or you need to make your data
available to different applications, possibly even using different languages / platforms, use Infinispan Server and its
various clients.</p>
</div>
</div>
<div class="sect3">
<h4 id="as_a_data_grid"><a class="anchor" href="#as_a_data_grid"></a>1.2.5. As a data grid</h4>
<div class="paragraph">
<p>Data you place in Infinispan doesn&#8217;t have to be temporary: use Infinispan as your primary store and use its powerful features
such as transactions, notifications, queries, distributed execution, distributed streams, analytics to process data quickly.</p>
</div>
</div>
<div class="sect3">
<h4 id="as_a_geographical_backup_for_your_data"><a class="anchor" href="#as_a_geographical_backup_for_your_data"></a>1.2.6. As a geographical backup for your data</h4>
<div class="paragraph">
<p>Infinispan supports replication between clusters, allowing you to backup your data across geographically remote sites.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cache_manager"><a class="anchor" href="#cache_manager"></a>2. The Embedded CacheManager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The CacheManager is Infinispan&#8217;s main entry point. You use a CacheManager to</p>
</div>
<div class="ulist">
<ul>
<li>
<p>configure and obtain caches</p>
</li>
<li>
<p>manage and monitor your nodes</p>
</li>
<li>
<p>execute code across a cluster</p>
</li>
<li>
<p>more&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Depending on whether you are embedding Infinispan in your application or you are using it remotely, you will be
dealing with either an <code>EmbeddedCacheManager</code> or a <code>RemoteCacheManager</code>. While they share some methods and properties,
be aware that there are semantic differences between them. The following chapters focus mostly on the <em>embedded</em>
implementation. For details on the <em>remote</em> implementation refer to <a href="#hotrod_java_client">Hot Rod Java Client</a>.</p>
</div>
<div class="paragraph">
<p>CacheManagers are heavyweight objects, and we foresee no more than one CacheManager being used per JVM
(unless specific setups require more than one; but either way, this would be a minimal and finite
number of instances).</p>
</div>
<div class="paragraph">
<p>The simplest way to create a CacheManager is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager();</code></pre>
</div>
</div>
<div class="paragraph">
<p>which starts the most basic, local mode, non-clustered cache manager with no caches. CacheManagers have a lifecycle
and the default constructors also call <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#start--">start()</a>.
Overloaded versions of the constructors are available, that do not start the CacheManager, although keep in
mind that CacheManagers need to be started before they can be used to create Cache instances.</p>
</div>
<div class="paragraph">
<p>Once constructed, CacheManagers should be made available to any component that require to interact with it via some form
of application-wide scope such as JNDI, a ServletContext or via some other mechanism such as an IoC container.</p>
</div>
<div class="paragraph">
<p>When you are done with a CacheManager, you must stop it so that it can release its resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">manager.stop();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will ensure all caches within its scope are properly stopped, thread pools are shutdown. If the CacheManager was
clustered it will also leave the cluster gracefully.</p>
</div>
<div class="sect2">
<h3 id="cache_configuration"><a class="anchor" href="#cache_configuration"></a>2.1. Configuration</h3>
<div class="paragraph">
<p>Infinispan offers both declarative and programmatic configuration.</p>
</div>
<div class="sect3">
<h4 id="cache_configuration_declarative"><a class="anchor" href="#cache_configuration_declarative"></a>2.1.1. Configuring caches declaratively</h4>
<div class="paragraph">
<p>Declarative configuration comes in a form of XML document that adheres to a provided Infinispan configuration XML
<a href="http://www.infinispan.org/schemas/infinispan-config-9.4.xsd">schema</a>.</p>
</div>
<div class="paragraph">
<p>Every aspect of Infinispan that can be configured declaratively can also be configured programmatically.
In fact, declarative configuration, behind the scenes, invokes the programmatic configuration API as the XML configuration file is being processed.
One can even use a combination of these approaches.
For example, you can read static XML configuration files and at runtime programmatically tune that same configuration.
Or you can use a certain static configuration defined in XML as a starting point or template for defining additional configurations in runtime.</p>
</div>
<div class="paragraph">
<p>There are two main configuration abstractions in Infinispan: <code>global</code> and <code>cache</code>.</p>
</div>
<div class="paragraph">
<div class="title">Global configuration</div>
<p>Global configuration defines global settings shared among all cache instances created by a single <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/EmbeddedCacheManager.html">EmbeddedCacheManager</a>.
Shared resources like thread pools, serialization/marshalling settings, transport and network settings, JMX domains are all part of global configuration.</p>
</div>
<div class="paragraph">
<div class="title">Cache configuration</div>
<p>Cache configuration is specific to the actual caching domain itself: it specifies eviction, locking, transaction, clustering, persistence etc.
You can specify as many named cache configurations as you need. One of these caches can be indicated as the <code>default</code> cache,
which is the cache returned by the <code>CacheManager.getCache()</code> API, whereas other named caches are retrieved via the <code>CacheManager.getCache(String name)</code> API.</p>
</div>
<div class="paragraph">
<p>Whenever they are specified, named caches inherit settings from the default cache while additional behavior can be specified or overridden.
Infinispan also provides a very flexible inheritance mechanism, where you can define a hierarchy of configuration templates,
allowing multiple caches to share the same settings, or overriding specific parameters as necessary.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Embedded and Server configuration use different schemas, but we strive to maintain them as compatible as possible so that you
can easily migrate between the two.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One of the major goals of Infinispan is to aim for zero configuration.
A simple XML configuration file containing nothing more than a single infinispan element is enough to get you started.
The configuration file listed below provides sensible defaults and is perfectly valid.</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan</span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, that would only give you the most basic, local mode, non-clustered cache manager with no caches.
Non-basic configurations are very likely to use customized global and default cache elements.</p>
</div>
<div class="paragraph">
<p>Declarative configuration is the most common approach to configuring Infinispan cache instances.
In order to read XML configuration files one would typically construct an instance of DefaultCacheManager by pointing to an XML file containing Infinispan configuration.
Once the configuration file is read you can obtain reference to the default cache instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-config-file.xml</span><span class="delimiter">&quot;</span></span>);
Cache defaultCache = manager.getCache();</code></pre>
</div>
</div>
<div class="paragraph">
<p>or any other named instance specified in <code>my-config-file.xml</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache someNamedCache = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">someNamedCache</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The name of the default cache is defined in the <code>&lt;cache-container&gt;</code> element of the XML configuration file, and additional
caches can be configured using the <code>&lt;local-cache&gt;</code>,<code>&lt;distributed-cache&gt;</code>,<code>&lt;invalidation-cache&gt;</code> or <code>&lt;replicated-cache&gt;</code> elements.</p>
</div>
<div class="paragraph">
<p>The following example shows the simplest possible configuration for each of the cache types supported by Infinispan:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;transport</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycluster</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;invalidation-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invalidation</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">repl-sync</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dist-sync</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="cache_configuration_templates"><a class="anchor" href="#cache_configuration_templates"></a>Cache configuration templates</h5>
<div class="paragraph">
<p>As mentioned above, Infinispan supports the notion of <em>configuration templates</em>. These are full or partial configuration
declarations which can be shared among multiple caches or as the basis for more complex configurations.</p>
</div>
<div class="paragraph">
<p>The following example shows how a configuration named <code>local-template</code> is used to define a cache named <code>local</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="comment">&lt;!-- template configurations --&gt;</span>
      <span class="tag">&lt;local-cache-configuration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local-template</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;expiration</span> <span class="attribute-name">interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/local-cache-configuration&gt;</span>

      <span class="comment">&lt;!-- cache definitions --&gt;</span>
      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local-template</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Templates can inherit from previously defined templates, augmenting and/or overriding some or all of the configuration elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="comment">&lt;!-- template configurations --&gt;</span>
      <span class="tag">&lt;local-cache-configuration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">base-template</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;expiration</span> <span class="attribute-name">interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/local-cache-configuration&gt;</span>

      <span class="tag">&lt;local-cache-configuration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">extended-template</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">base-template</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;expiration</span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;memory&gt;</span>
            <span class="tag">&lt;object</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/memory&gt;</span>
      <span class="tag">&lt;/local-cache-configuration&gt;</span>

      <span class="comment">&lt;!-- cache definitions --&gt;</span>
      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">base-template</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local-bounded</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">extended-template</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, <code>base-template</code> defines a local cache with a specific <em>expiration</em> configuration. The <code>extended-template</code>
configuration inherits from <code>base-template</code>, overriding just a single parameter of the <em>expiration</em> element (all other
attributes are inherited) and adds a <em>memory</em> element. Finally, two caches are defined: <code>local</code> which uses the <code>base-template</code>
configuration and <code>local-bounded</code> which uses the <code>extended-template</code> configuration.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Be aware that for multi-valued elements (such as <code>properties</code>) the inheritance is additive, i.e. the child configuration will be the result of merging the properties from the parent and its own.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="cache_configuration_wildcards"><a class="anchor" href="#cache_configuration_wildcards"></a>Cache configuration wildcards</h5>
<div class="paragraph">
<p>An alternative way to apply templates to caches is to use wildcards in the template name, e.g. <code>basecache*</code>. Any cache whose name matches the template wildcard will inherit that configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
    <span class="tag">&lt;cache-container&gt;</span>
        <span class="tag">&lt;local-cache-configuration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">basecache*</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;expiration</span> <span class="attribute-name">interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10500</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">11</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">11</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache-configuration&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">basecache-1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">basecache-2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Above, caches <code>basecache-1</code> and <code>basecache-2</code> will use the <code>basecache*</code> configuration. The configuration will also
be applied when retrieving undefined caches programmatically.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If a cache name matches multiple wildcards, i.e. it is ambiguous, an exception will be thrown.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="cache_configuration_declarative_ref"><a class="anchor" href="#cache_configuration_declarative_ref"></a>Declarative configuration reference</h5>
<div class="paragraph">
<p>For more details on the declarative configuration schema, refer to the <a href="https://docs.jboss.org/infinispan/9.4/configdocs/">configuration reference</a>.
If you are using XML editing tools for configuration writing you can use the provided Infinispan <a href="http://infinispan.org/schemas/infinispan-config-9.4.xsd">schema</a> to assist you.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cache_configuration_programmatic"><a class="anchor" href="#cache_configuration_programmatic"></a>2.1.2. Configuring caches programmatically</h4>
<div class="paragraph">
<p>Programmatic Infinispan configuration is centered around the CacheManager and ConfigurationBuilder API.
Although every single aspect of Infinispan configuration could be set programmatically, the most usual approach is to create a starting point in a form of XML configuration file and then in runtime, if needed, programmatically tune a specific configuration to suit the use case best.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-config-file.xml</span><span class="delimiter">&quot;</span></span>);
Cache defaultCache = manager.getCache();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s assume that a new synchronously replicated cache is to be configured programmatically.
First, a fresh instance of Configuration object is created using ConfigurationBuilder helper object, and the cache mode is set to synchronous replication.
Finally, the configuration is defined/registered with a manager.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().clustering().cacheMode(CacheMode.REPL_SYNC).build();

<span class="predefined-type">String</span> newCacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">repl</span><span class="delimiter">&quot;</span></span>;
manager.defineConfiguration(newCacheName, c);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(newCacheName);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default cache configuration (or any other cache configuration) can be used as a starting point for creation of a new cache.
For example, lets say that <code>infinispan-config-file.xml</code> specifies a replicated cache as a default and that a distributed cache is desired with a specific L1 lifespan while at the same time retaining all other aspects of a default cache.
Therefore, the starting point would be to read an instance of a default Configuration object and use <code>ConfigurationBuilder</code> to construct and modify cache mode and L1 lifespan on a new <code>Configuration</code> object. As a final step the configuration is defined/registered with a manager.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-config-file.xml</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Configuration</span> dcc = manager.getDefaultCacheConfiguration();
<span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().read(dcc).clustering().cacheMode(CacheMode.DIST_SYNC).l1().lifespan(<span class="integer">60000L</span>).build();
<span class="error"></span>
<span class="predefined-type">String</span> newCacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">distributedWithL1</span><span class="delimiter">&quot;</span></span>;
manager.defineConfiguration(newCacheName, c);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(newCacheName);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As long as the base configuration is the default named cache, the previous code works perfectly fine. However, other times the base configuration might be another named cache. So, how can new configurations be defined based on other defined caches? Take the previous example and imagine that instead of taking the default cache as base, a named cache called "replicatedCache" is used as base. The code would look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-config-file.xml</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Configuration</span> rc = manager.getCacheConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().read(rc).clustering().cacheMode(CacheMode.DIST_SYNC).l1().lifespan(<span class="integer">60000L</span>).build();
<span class="error"></span>
<span class="predefined-type">String</span> newCacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">distributedWithL1</span><span class="delimiter">&quot;</span></span>;
manager.defineConfiguration(newCacheName, c);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(newCacheName);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Refer to <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/CacheManager.html">CacheManager</a> , <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/configuration/cache/ConfigurationBuilder.html">ConfigurationBuilder</a> , <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/configuration/cache/Configuration.html">Configuration</a> , and <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/configuration/global/GlobalConfiguration.html">GlobalConfiguration</a> javadocs for more details.</p>
</div>
<div class="sect4">
<h5 id="cache_configuration_programmatic_api"><a class="anchor" href="#cache_configuration_programmatic_api"></a>ConfigurationBuilder Programmatic Configuration API</h5>
<div class="paragraph">
<p>While the above paragraph shows how to combine declarative and programmatic configuration, starting from an XML configuration is completely optional.
The ConfigurationBuilder fluent interface style allows for easier to write and more readable programmatic configuration.
This approach can be used for both the global and the cache level configuration.
GlobalConfiguration objects are constructed using GlobalConfigurationBuilder while Configuration objects are built using ConfigurationBuilder.
Let&#8217;s look at some examples on configuring both global and cache level options with this API:</p>
</div>
</div>
<div class="sect4">
<h5 id="configuring_the_transport"><a class="anchor" href="#configuring_the_transport"></a>Configuring the transport</h5>
<div class="paragraph">
<p>One of the most commonly configured global option is the transport layer, where you indicate how an Infinispan node will discover the others:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder().transport()
        .defaultTransport()
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .clusterName(<span class="string"><span class="delimiter">&quot;</span><span class="content">qa-cluster</span><span class="delimiter">&quot;</span></span>)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">configurationFile</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-tcp.xml</span><span class="delimiter">&quot;</span></span>)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .machineId(<span class="string"><span class="delimiter">&quot;</span><span class="content">qa-machine</span><span class="delimiter">&quot;</span></span>).rackId(<span class="string"><span class="delimiter">&quot;</span><span class="content">qa-rack</span><span class="delimiter">&quot;</span></span>)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .build();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="using_a_custom_jchannel"><a class="anchor" href="#using_a_custom_jchannel"></a>Using a custom JChannel</h5>
<div class="paragraph">
<p>If you want to construct the JGroups <a href="http://www.jgroups.org/manual4/index.html#JChannel">JChannel</a> by yourself, you can do so.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The JChannel must not be already connected.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder global = <span class="keyword">new</span> GlobalConfigurationBuilder();
JChannel jchannel = <span class="keyword">new</span> JChannel();
<span class="comment">// Configure the jchannel to your needs.</span>
JGroupsTransport transport = <span class="keyword">new</span> JGroupsTransport(jchannel);
global.transport().transport(transport);
<span class="keyword">new</span> DefaultCacheManager(global.build());</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="enabling_jmx_mbeans_and_statistics"><a class="anchor" href="#enabling_jmx_mbeans_and_statistics"></a>Enabling JMX MBeans and statistics</h5>
<div class="paragraph">
<p>Sometimes you might also want to enable collection of <a href="https://docs.jboss.org/infinispan/9.4/apidocs/jmxComponents.html">global JMX statistics</a>
at cache manager level or get information about the transport. To enable global JMX statistics simply do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
<span class="error"></span> .globalJmxStatistics()
  .enable()
<span class="error"></span> .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that by not enabling (or by explicitly disabling) global JMX statistics your are just turning off statistics
collection. The corresponding MBean is still registered and can be used to manage the cache manager in general, but the
statistics attributes do not return meaningful values.</p>
</div>
<div class="paragraph">
<p>Further options at the global JMX statistics level allows you to configure the cache manager name which comes handy when you have multiple cache managers running on the same system, or how to locate the JMX MBean Server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
<span class="error"></span> .globalJmxStatistics()
<span class="error"></span><span class="error"></span><span class="error"></span> .cacheManagerName(<span class="string"><span class="delimiter">&quot;</span><span class="content">SalesCacheManager</span><span class="delimiter">&quot;</span></span>)
<span class="error"></span><span class="error"></span><span class="error"></span> .mBeanServerLookup(<span class="keyword">new</span> JBossMBeanServerLookup())
<span class="error"></span> .build();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuring_the_thread_pools"><a class="anchor" href="#configuring_the_thread_pools"></a>Configuring the thread pools</h5>
<div class="paragraph">
<p>Some of the Infinispan features are powered by a group of the thread pool executors which can also be tweaked at this global level. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
<span class="error"></span>  .replicationQueueThreadPool()
     .threadPoolFactory(ScheduledThreadPoolExecutorFactory.create())
<span class="error"></span> .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can not only configure global, cache manager level, options, but you can also configure cache level options such as the cluster mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> config = <span class="keyword">new</span> ConfigurationBuilder()
<span class="error"></span> .clustering()
<span class="error"></span><span class="error"></span><span class="error"></span> .cacheMode(CacheMode.DIST_SYNC)
<span class="error"></span><span class="error"></span><span class="error"></span> .sync()
<span class="error"></span><span class="error"></span><span class="error"></span> .l1().lifespan(<span class="integer">25000L</span>)
<span class="error"></span><span class="error"></span><span class="error"></span> .hash().numOwners(<span class="integer">3</span>)
<span class="error"></span> .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or you can configure <a href="#eviction_anchor">eviction and expiration settings</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> config = <span class="keyword">new</span> ConfigurationBuilder()
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .memory()
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .size(<span class="integer">20000</span>)
          .expiration()
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .wakeUpInterval(<span class="integer">5000L</span>)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .maxIdle(<span class="integer">120000L</span>)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .build();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuring_transactions_and_locking"><a class="anchor" href="#configuring_transactions_and_locking"></a>Configuring transactions and locking</h5>
<div class="paragraph">
<p>An application might also want to interact with an Infinispan cache within the boundaries of JTA and to do that you need to configure the transaction layer and optionally tweak the locking settings. When interacting with transactional caches, you might want to enable recovery to deal with transactions that finished with an heuristic outcome and if you do that, you will often want to enable JMX management and statistics gathering too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> config = <span class="keyword">new</span> ConfigurationBuilder()
  .locking()
<span class="error"></span><span class="error"></span><span class="error"></span> .concurrencyLevel(<span class="integer">10000</span>).isolationLevel(IsolationLevel.REPEATABLE_READ)
<span class="error"></span><span class="error"></span><span class="error"></span> .lockAcquisitionTimeout(<span class="integer">12000L</span>).useLockStriping(<span class="predefined-constant">false</span>).writeSkewCheck(<span class="predefined-constant">true</span>)
    .versioning().enable().scheme(VersioningScheme.SIMPLE)
<span class="error"></span> .transaction()
<span class="error"></span><span class="error"></span><span class="error"></span> .transactionManagerLookup(<span class="keyword">new</span> GenericTransactionManagerLookup())
<span class="error"></span><span class="error"></span><span class="error"></span> .recovery()
<span class="error"></span> .jmxStatistics()
<span class="error"></span> .build();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuring_cache_stores"><a class="anchor" href="#configuring_cache_stores"></a>Configuring cache stores</h5>
<div class="paragraph">
<p>Configuring Infinispan with chained cache stores is simple too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> config = <span class="keyword">new</span> ConfigurationBuilder()
   .persistence().passivation(<span class="predefined-constant">false</span>)
<span class="error"></span><span class="error"></span><span class="error"></span>.addSingleFileStore().location(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp</span><span class="delimiter">&quot;</span></span>).async().enable()
<span class="error"></span><span class="error"></span><span class="error"></span>.preload(<span class="predefined-constant">false</span>).shared(<span class="predefined-constant">false</span>).threadPoolSize(<span class="integer">20</span>).build();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cache_configuration_programmatic_advanced"><a class="anchor" href="#cache_configuration_programmatic_advanced"></a>Advanced programmatic configuration</h5>
<div class="paragraph">
<p>The fluent configuration can also be used to configure more advanced or exotic options, such as advanced externalizers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
<span class="error"></span> .serialization()
<span class="error"></span><span class="error"></span><span class="error"></span> .addAdvancedExternalizer(<span class="integer">998</span>, <span class="keyword">new</span> PersonExternalizer())
<span class="error"></span><span class="error"></span><span class="error"></span> .addAdvancedExternalizer(<span class="integer">999</span>, <span class="keyword">new</span> AddressExternalizer())
<span class="error"></span> .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, add custom interceptors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> config = <span class="keyword">new</span> ConfigurationBuilder()
<span class="error"></span> .customInterceptors().addInterceptor()
<span class="error"></span><span class="error"></span>  .interceptor(<span class="keyword">new</span> FirstInterceptor()).position(InterceptorConfiguration.Position.FIRST)
    .interceptor(<span class="keyword">new</span> LastInterceptor()).position(InterceptorConfiguration.Position.LAST)
    .interceptor(<span class="keyword">new</span> FixPositionInterceptor()).index(<span class="integer">8</span>)
    .interceptor(<span class="keyword">new</span> AfterInterceptor()).after(NonTransactionalLockingInterceptor.class)
    .interceptor(<span class="keyword">new</span> BeforeInterceptor()).before(CallInterceptor.class)
<span class="error"></span> .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>For information on the individual configuration options, please check the <a href="https://docs.jboss.org/infinispan/9.4/configdocs/">configuration guide</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cache_configuration_migration"><a class="anchor" href="#cache_configuration_migration"></a>2.1.3. Configuration Migration Tools</h4>
<div class="paragraph">
<p>The configuration format of Infinispan has changed since schema version 6.0 in order to align the embedded schema with the one used
by the server. For this reason, when upgrading to schema 7.x or later, you should use the configuration converter included in the
<em>all</em> distribution. Simply invoke it from the command-line passing the old configuration file as the first parameter and the name
of the converted file as the second parameter.</p>
</div>
<div class="paragraph">
<p>To convert on Unix/Linux/macOS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">bin/config-converter.sh oldconfig.xml newconfig.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>on Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">bin\config-converter.bat oldconfig.xml newconfig.xml</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you wish to help write conversion tools from other caching systems, please contact <a href="https://lists.jboss.org/mailman/listinfo/infinispan-dev">infinispan-dev</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cache_configuration_clustered"><a class="anchor" href="#cache_configuration_clustered"></a>2.1.4. Clustered Configuration</h4>
<div class="paragraph">
<p>Infinispan uses <a href="http://www.jgroups.org">JGroups</a> for network communications when in clustered mode.
Infinispan ships with <em>pre-configured</em> JGroups stacks that make it easy for you to jump-start a clustered configuration.</p>
</div>
<div class="sect4">
<h5 id="using_an_external_jgroups_file"><a class="anchor" href="#using_an_external_jgroups_file"></a>Using an external JGroups file</h5>
<div class="paragraph">
<p>If you are configuring your cache programmatically, all you need to do is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration gc = <span class="keyword">new</span> GlobalConfigurationBuilder()
   .transport().defaultTransport()
   .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">configurationFile</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups.xml</span><span class="delimiter">&quot;</span></span>)
   .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>and if you happen to use an XML file to configure Infinispan, just use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;jgroups&gt;</span>
     <span class="tag">&lt;stack-file</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">external-file</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/jgroups&gt;</span>
 <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="tag">&lt;transport</span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">external-file</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;/cache-container&gt;</span>

 ...

<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In both cases above, Infinispan looks for <em>jgroups.xml</em> first in your classpath, and then for an absolute path name if not found in the classpath.</p>
</div>
</div>
<div class="sect4">
<h5 id="use_one_of_the_pre_configured_jgroups_files"><a class="anchor" href="#use_one_of_the_pre_configured_jgroups_files"></a>Use one of the pre-configured JGroups files</h5>
<div class="paragraph">
<p>Infinispan ships with a few different JGroups files (packaged in infinispan-core.jar) which means they will already be on your classpath by default.
All you need to do is specify the file name, e.g., instead of <code>jgroups.xml</code> above, specify <code>/default-configs/default-jgroups-tcp.xml</code>.</p>
</div>
<div class="paragraph">
<p>The configurations available are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>default-jgroups-udp.xml - Uses UDP as a transport, and UDP multicast for discovery.  Usually suitable for larger (over 100 nodes) clusters <em>or</em> if you are using <a href="#replicated_mode">replication</a> or <a href="#invalidation_mode">invalidation</a>. Minimises opening too many sockets.</p>
</li>
<li>
<p>default-jgroups-tcp.xml - Uses TCP as a transport and UDP multicast for discovery.  Better for smaller clusters (under 100 nodes) <em>only if</em> you are using <a href="#distribution_mode">distribution</a>, as TCP is more efficient as a point-to-point protocol</p>
</li>
<li>
<p>default-jgroups-ec2.xml - Uses TCP as a transport and <a href="http://jgroups.org/manual/index.html#_s3_ping">S3_PING</a> for discovery.  Suitable on <a href="http://aws.amazon.com/ec2/">Amazon EC2</a> nodes where UDP multicast isn&#8217;t available.</p>
</li>
<li>
<p>default-jgroups-kubernetes.xml - Uses TCP as a transport and <a href="https://github.com/jgroups-extras/jgroups-kubernetes">KUBE_PING</a> for discovery.  Suitable on <a href="http://kubernetes.io/">Kubernetes</a> and <a href="https://www.openshift.org/">OpenShift</a> nodes where UDP multicast is not always available.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="tuning_jgroups_settings"><a class="anchor" href="#tuning_jgroups_settings"></a>Tuning JGroups settings</h6>
<div class="paragraph">
<p>The settings above can be further tuned without editing the XML files themselves.
Passing in certain system properties to your JVM at startup can affect the behaviour of some of these settings.  The table below shows you which settings can be configured in this way.  E.g.,</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ java -cp ... -Djgroups.tcp.port=1234 -Djgroups.tcp.address=10.11.12.13</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. default-jgroups-udp.xml</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>System Property</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Default</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Required?</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.mcast_addr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for multicast (both for communications and discovery).  Must be a valid <a href="http://compnetworking.about.com/od/workingwithipaddresses/l/aa042400b.htm">Class D</a> IP address, suitable for IP multicast.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">228.6.7.8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.mcast_port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for multicast socket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">46655</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.ip_ttl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the time-to-live (TTL) for IP multicast packets. The value here refers to the number of network hops a packet is allowed to make before it is dropped</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. default-jgroups-tcp.xml</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>System Property</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Default</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Required?</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for the TCP transport.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">127.0.0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for TCP socket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7800</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.mcast_addr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for multicast (for discovery).  Must be a valid <a href="http://compnetworking.about.com/od/workingwithipaddresses/l/aa042400b.htm">Class D</a> IP address, suitable for IP multicast.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">228.6.7.8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.mcast_port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for multicast socket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">46655</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.ip_ttl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the time-to-live (TTL) for IP multicast packets. The value here refers to the number of network hops a packet is allowed to make before it is dropped</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. default-jgroups-ec2.xml</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>System Property</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Default</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Required?</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for the TCP transport.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">127.0.0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for TCP socket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7800</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.s3.access_key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Amazon S3 access key used to access an S3 bucket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.s3.secret_access_key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Amazon S3 secret key used to access an S3 bucket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.s3.bucket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Amazon S3 bucket to use.  Must be unique and must already exist</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. default-jgroups-kubernetes.xml</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>System Property</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Description</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Default</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Required?</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for the TCP transport.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eth0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for TCP socket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7800</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="further_reading"><a class="anchor" href="#further_reading"></a>Further reading</h5>
<div class="paragraph">
<p>JGroups also supports more system property overrides, details of which can be found on this page: <a href="http://www.jgroups.org/manual4/index.html#SystemProperties">SystemProps</a></p>
</div>
<div class="paragraph">
<p>In addition, the JGroups configuration files shipped with Infinispan are intended as a jumping off point to getting something up and running, and working.  More often than not though, you will want to fine-tune your JGroups stack further to extract every ounce of performance from your network equipment.  For this, your next stop should be the JGroups manual which has a <a href="http://jgroups.org/manual/html/protlist.html">detailed section</a> on configuring each of the protocols you see in a JGroups configuration file.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="obtaining_caches"><a class="anchor" href="#obtaining_caches"></a>2.2. Obtaining caches</h3>
<div class="paragraph">
<p>After you configure the <code>CacheManager</code>, you can obtain and control caches.</p>
</div>
<div class="paragraph">
<p>Invoke the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getCache--"><code>getCache()</code></a> method to obtain caches, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; myCache = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding operation creates a cache named <code>myCache</code>, if it does not already exist, and returns it.</p>
</div>
<div class="paragraph">
<p>Using the <code>getCache()</code> method creates the cache only on the node where you invoke the method. In other words, it performs a local operation that must be invoked on each node across the cluster. Typically, applications deployed across multiple nodes obtain caches during initialization to ensure that caches are <em>symmetric</em> and exist on each node.</p>
</div>
<div class="paragraph">
<p>Invoke the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/EmbeddedCacheManagerAdmin.html#createCache--"><code>createCache()</code></a> method to create caches dynamically across the entire cluster, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; myCache = manager.administration().createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">myTemplate</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding operation also automatically creates caches on any nodes that subsequently join the cluster.</p>
</div>
<div class="paragraph">
<p>Caches that you create with the <code>createCache()</code> method are ephemeral by default. If the entire cluster shuts down, the cache is not automatically created again when it restarts.</p>
</div>
<div class="paragraph">
<p>Use the PERMANENT flag to ensure that caches can survive restarts, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; myCache = manager.administration().withFlags(AdminFlag.PERMANENT).createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">myTemplate</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the PERMANENT flag to take effect, you must enable global state and set a configuration storage provider.</p>
</div>
<div class="paragraph">
<p>For more information about configuration storage providers, see <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/configuration/global/GlobalStateConfigurationBuilder.html#configurationStorage-org.infinispan.globalstate.ConfigurationStorage-">GlobalStateConfigurationBuilder#configurationStorage()</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="clustering_information"><a class="anchor" href="#clustering_information"></a>2.3. Clustering Information</h3>
<div class="paragraph">
<p>The <code>EmbeddedCacheManager</code> has quite a few methods to provide information
as to how the cluster is operating.  The following methods only really make
sense when being used in a clustered environment (that is when a Transport
is configured).</p>
</div>
<div class="sect3">
<h4 id="member_information"><a class="anchor" href="#member_information"></a>2.3.1. Member Information</h4>
<div class="paragraph">
<p>When you are using a cluster it is very important to be able to find information
about membership in the cluster including who is the owner of the cluster.</p>
</div>
<div class="paragraph">
<div class="title"><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getMembers--">getMembers()</a></div>
<p>The getMembers() method returns all of the nodes in the current cluster.</p>
</div>
<div class="paragraph">
<div class="title"><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getCoordinator--">getCoordinator()</a></div>
<p>The getCoordinator() method will tell you which one of the members is the coordinator
of the cluster.  For most intents you shouldn&#8217;t need to care who the coordinator is.
You can use <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#isCoordinator--">isCoordinator()</a>
method directly to see if the local node is the coordinator as well.</p>
</div>
</div>
<div class="sect3">
<h4 id="other_methods"><a class="anchor" href="#other_methods"></a>2.3.2. Other methods</h4>
<div class="paragraph">
<div class="title"><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getTransport--">getTransport()</a></div>
<p>This method provides you access to the underlying Transport that is used to send
messages to other nodes.  In most cases a user wouldn&#8217;t ever need to go to
this level, but if you want to get Transport specific information (in this
case JGroups) you can use this mechanism.</p>
</div>
<div class="paragraph">
<div class="title"><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getStats--">getStats()</a></div>
<p>The stats provided here are coalesced from all of the active caches in this manager.
These stats can be useful to see if there is something wrong going on with your
cluster overall.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cache_api"><a class="anchor" href="#cache_api"></a>3. The Cache API</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="the_cache_interface"><a class="anchor" href="#the_cache_interface"></a>3.1. The Cache interface</h3>
<div class="paragraph">
<p>Infinispan&#8217;s Caches are manipulated through the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html">Cache</a> interface.</p>
</div>
<div class="paragraph">
<p>A Cache exposes simple methods for adding, retrieving and removing entries, including atomic mechanisms exposed by the JDK&#8217;s ConcurrentMap interface.  Based on the cache mode used, invoking these methods will trigger a number of things to happen, potentially even including replicating an entry to a remote node or looking up an entry from a remote node, or potentially a cache store.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For simple usage, using the Cache API should be no different from using the JDK Map API, and hence migrating from simple in-memory caches based on a Map to Infinispan&#8217;s Cache should be trivial.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="performance_concerns_of_certain_map_methods"><a class="anchor" href="#performance_concerns_of_certain_map_methods"></a>3.1.1. Performance Concerns of Certain Map Methods</h4>
<div class="paragraph">
<p>Certain methods exposed in Map have certain performance consequences when used with Infinispan, such as
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html#size--">size()</a> ,
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html#values--">values()</a> ,
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html#keySet--">keySet()</a> and
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html#entrySet--">entrySet()</a> .
Specific methods on the <code>keySet</code>, <code>values</code> and <code>entrySet</code> are fine for use please see their Javadoc for further details.</p>
</div>
<div class="paragraph">
<p>Attempting to perform these operations globally would have large performance impact as well as become a scalability bottleneck.  As such, these methods should only be used for informational or debugging purposes only.</p>
</div>
<div class="paragraph">
<p>It should be noted that using certain flags with the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/AdvancedCache.html#withFlags-org.infinispan.context.Flag&#8230;&#8203;-">withFlags</a> method can mitigate some of these concerns, please check each method&#8217;s documentation for more details.</p>
</div>
<div class="paragraph">
<p>For more performance tips, have a look at our <a href="../performance_guide/performance_guide.html">Performance Guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mortal_and_immortal_data"><a class="anchor" href="#mortal_and_immortal_data"></a>3.1.2. Mortal and Immortal Data</h4>
<div class="paragraph">
<p>Further to simply storing entries, Infinispan&#8217;s cache API allows you to attach mortality information to data.  For example, simply using <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">put(key, value)</a> would create an <em>immortal</em> entry, i.e., an entry that lives in the cache forever, until it is removed (or evicted from memory to prevent running out of memory).  If, however, you put data in the cache using <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/BasicCache.html#put-K-V-long-java.util.concurrent.TimeUnit-">put(key, value, lifespan, timeunit)</a> , this creates a <em>mortal</em> entry, i.e., an entry that has a fixed lifespan and expires after that lifespan.</p>
</div>
<div class="paragraph">
<p>In addition to <em>lifespan</em> , Infinispan also supports <em>maxIdle</em> as an additional metric with which to determine expiration.  Any combination of lifespans or maxIdles can be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="expiration_and_mortal_data"><a class="anchor" href="#expiration_and_mortal_data"></a>3.1.3. Expiration and Mortal Data</h4>
<div class="paragraph">
<p>See <a href="#expiration_anchor">Expiration</a> for more information about using mortal data with Infinispan.</p>
</div>
</div>
<div class="sect3">
<h4 id="putforexternalread_operation"><a class="anchor" href="#putforexternalread_operation"></a>3.1.4. putForExternalRead operation</h4>
<div class="paragraph">
<p>Infinispan&#8217;s <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html">Cache</a> class contains a different 'put' operation called <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html#putForExternalRead-K-V-">putForExternalRead</a> . This operation is particularly useful when Infinispan is used as a temporary cache for data that is persisted elsewhere.  Under heavy read scenarios, contention in the cache should not delay the real transactions at hand, since caching should just be an optimization and not something that gets in the way.</p>
</div>
<div class="paragraph">
<p>To achieve this, putForExternalRead acts as a put call that only operates if the key is not present in the cache, and fails fast and silently if another thread is trying to store the same key at the same time. In this particular scenario, caching data is a way to optimise the system and it&#8217;s not desirable that a failure in caching affects the on-going transaction, hence why failure is handled differently. putForExternalRead is considered to be a fast operation because regardless of whether it&#8217;s successful or not, it doesn&#8217;t wait for any locks, and so returns to the caller promptly.</p>
</div>
<div class="paragraph">
<p>To understand how to use this operation, let&#8217;s look at basic example. Imagine a cache of Person instances, each keyed by a PersonId , whose data originates in a separate data store. The following code shows the most common pattern of using <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html#putForExternalRead-K-V-">putForExternalRead</a> within the context of this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Id of the person to look up, provided by the application</span>
PersonId id = ...;

<span class="comment">// Get a reference to the cache where person instances will be stored</span>
Cache&lt;PersonId, Person&gt; cache = ...;

<span class="comment">// First, check whether the cache contains the person instance</span>
<span class="comment">// associated with with the given id</span>
Person cachedPerson = cache.get(id);

<span class="keyword">if</span> (cachedPerson == <span class="predefined-constant">null</span>) {
   <span class="comment">// The person is not cached yet, so query the data store with the id</span>
   Person person = dataStore.lookup(id);

   <span class="comment">// Cache the person along with the id so that future requests can</span>
   <span class="comment">// retrieve it from memory rather than going to the data store</span>
   cache.putForExternalRead(id, person);
} <span class="keyword">else</span> {
   <span class="comment">// The person was found in the cache, so return it to the application</span>
   <span class="keyword">return</span> cachedPerson;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html#putForExternalRead-K-V-">putForExternalRead</a> should never be used as a mechanism to update the cache with a new Person instance originating from application execution (i.e. from a transaction that modifies a Person&#8217;s address). When updating cached values, please use the standard <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">put</a> operation, otherwise the possibility of caching corrupt data is likely.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the_advancedcache_interface"><a class="anchor" href="#the_advancedcache_interface"></a>3.2. The AdvancedCache interface</h3>
<div class="paragraph">
<p>In addition to the simple Cache interface, Infinispan offers an <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> interface, geared towards extension authors.  The AdvancedCache offers the ability to inject custom interceptors, access certain internal components and to apply flags to alter the default behavior of certain cache methods.  The following code snippet depicts how an AdvancedCache can be obtained:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AdvancedCache advancedCache = cache.getAdvancedCache();</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="flags"><a class="anchor" href="#flags"></a>3.2.1. Flags</h4>
<div class="paragraph">
<p>Flags are applied to regular cache methods to alter the behavior of certain methods.  For a list of all available flags, and their effects, see the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/context/Flag.html">Flag</a> enumeration.  Flags are applied using <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/AdvancedCache.html#withFlags-org.infinispan.context.Flag&#8230;&#8203;-">AdvancedCache.withFlags()</a> .  This builder method can be used to apply any number of flags to a cache invocation, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">advancedCache.withFlags(Flag.CACHE_MODE_LOCAL, Flag.SKIP_LOCKING)
<span class="error"></span><span class="error"></span> .withFlags(Flag.FORCE_SYNCHRONOUS)
<span class="error"></span><span class="error"></span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="custom_interceptors"><a class="anchor" href="#custom_interceptors"></a>3.2.2. Custom Interceptors</h4>
<div class="paragraph">
<p>The AdvancedCache interface also offers advanced developers a mechanism with which to attach custom interceptors.  Custom interceptors allow developers to alter the behavior of the cache API methods, and the AdvancedCache interface allows developers to attach these interceptors programmatically, at run-time.  See the AdvancedCache Javadocs for more details.</p>
</div>
<div class="paragraph">
<p>For more information on writing custom interceptors, see <a href="#custom_interceptors_chapter">Custom Interceptors</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="listeners_and_notifications"><a class="anchor" href="#listeners_and_notifications"></a>3.3. Listeners and Notifications</h3>
<div class="paragraph">
<p>Infinispan offers a listener API, where clients can register for and get notified when events take place.  This annotation-driven API applies to 2 different levels: cache level events and cache manager level events.</p>
</div>
<div class="paragraph">
<p>Events trigger a notification which is dispatched to listeners.   Listeners are simple <a href="http://en.wikipedia.org/wiki/Plain_Old_Java_Object">POJO</a> s annotated with <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/notifications/Listener.html">@Listener</a> and registered using the methods defined in the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/notifications/Listenable.html">Listenable</a> interface.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Both Cache and CacheManager implement Listenable, which means you can attach listeners to either a cache or a cache manager, to receive either cache-level or cache manager-level notifications.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, the following class defines a listener to print out some information every time a new entry is added to the cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PrintWhenAdded</span> {

<span class="error"></span> <span class="annotation">@CacheEntryCreated</span>
<span class="error"></span> <span class="directive">public</span> <span class="type">void</span> print(CacheEntryCreatedEvent event) {
<span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">New entry </span><span class="delimiter">&quot;</span></span> + event.getKey() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> created in the cache</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span> }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more comprehensive examples, please see the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/notifications/Listener.html">Javadocs for @Listener</a>.</p>
</div>
<div class="sect3">
<h4 id="cache_level_notifications"><a class="anchor" href="#cache_level_notifications"></a>3.3.1. Cache-level notifications</h4>
<div class="paragraph">
<p>Cache-level events occur on a per-cache basis, and by default are only raised on nodes where the events occur.  Note in a distributed cache these events are only raised on the owners of data being affected.  Examples of cache-level events are entries being added, removed, modified, etc.  These events trigger notifications to listeners registered to a specific cache.</p>
</div>
<div class="paragraph">
<p>Please see the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for a comprehensive list of all cache-level notifications, and their respective method-level annotations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please refer to the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for the list of cache-level notifications available in Infinispan.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="cluster_listeners"><a class="anchor" href="#cluster_listeners"></a>Cluster Listeners</h5>
<div class="paragraph">
<p>The cluster listeners should be used when it is desirable to listen to the cache events on a single node.</p>
</div>
<div class="paragraph">
<p>To do so all that is required is set to annotate your listener as being clustered.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span> (clustered = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyClusterListener</span> { .... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are some limitations to cluster listeners from a non clustered listener.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A cluster listener can only listen to <code>@CacheEntryModified</code>, <code>@CacheEntryCreated</code>, <code>@CacheEntryRemoved</code> and <code>@CacheEntryExpired</code> events.  Note this means any other type of event will not be listened to for this listener.</p>
</li>
<li>
<p>Only the post event is sent to a cluster listener, the pre event is ignored.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="event_filtering_and_conversion"><a class="anchor" href="#event_filtering_and_conversion"></a>Event filtering and conversion</h5>
<div class="paragraph">
<p>All applicable events on the node where the listener is installed will be raised to the listener.  It is possible to dynamically filter what events are raised by using a <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/filter/KeyFilter.html">KeyFilter</a> (only allows filtering on keys) or <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventFilter.html">CacheEventFilter</a> (used to filter for keys, old value, old metadata, new value, new metadata, whether command was retried, if the event is before the event (ie. isPre) and also the command type).</p>
</div>
<div class="paragraph">
<p>The example here shows a simple <code>KeyFilter</code> that will only allow events to be raised when an event modified the entry for the key <code>Only Me</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SpecificKeyFilter</span> <span class="directive">implements</span> KeyFilter&lt;<span class="predefined-type">String</span>&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> keyToAccept;

    <span class="directive">public</span> SpecificKeyFilter(<span class="predefined-type">String</span> keyToAccept) {
      <span class="keyword">if</span> (keyToAccept == <span class="predefined-constant">null</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>();
      }
      <span class="local-variable">this</span>.keyToAccept = keyToAccept;
    }

    <span class="type">boolean</span> accept(<span class="predefined-type">String</span> key) {
      <span class="keyword">return</span> keyToAccept.equals(key);
    }
}

...
cache.addListener(listener, <span class="keyword">new</span> SpecificKeyFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">Only Me</span><span class="delimiter">&quot;</span></span>));
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be useful when you want to limit what events you receive in a more efficient manner.</p>
</div>
<div class="paragraph">
<p>There is also a <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventConverter.html">CacheEventConverter</a> that can be supplied that allows for converting a value to another before raising the event.  This can be nice to modularize any code that does value conversions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The mentioned filters and converters are especially beneficial when used in conjunction with a Cluster Listener.  This is because the filtering and conversion is done on the node where the event originated and not on the node where event is listened to.  This can provide benefits of not having to replicate events across the cluster (filter) or even have reduced payloads (converter).
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="initial_state_events"><a class="anchor" href="#initial_state_events"></a>Initial State Events</h5>
<div class="paragraph">
<p>When a listener is installed it will only be notified of events after it is fully installed.</p>
</div>
<div class="paragraph">
<p>It may be desirable to get the current state of the cache contents upon first registration of listener by having an event generated of type <code>@CacheEntryCreated</code> for each element in the cache.  Any additionally generated events during this initial phase will be queued until appropriate events have been raised.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This only works for clustered listeners at this time.  <a href="https://issues.jboss.org/browse/ISPN-4608">ISPN-4608</a> covers adding this for non clustered listeners.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="duplicate_events"><a class="anchor" href="#duplicate_events"></a>Duplicate Events</h5>
<div class="paragraph">
<p>It is possible in a non transactional cache to receive duplicate events.  This is possible when the primary owner of a key goes down while trying to perform a write operation such as a put.</p>
</div>
<div class="paragraph">
<p>Infinispan internally will rectify the put operation by sending it to the new primary owner for the given key automatically, however there are no guarantees in regards to if the write was first replicated to backups.  Thus more than 1 of the following write events (<code>CacheEntryCreatedEvent</code>, <code>CacheEntryModifiedEvent</code> &amp; <code>CacheEntryRemovedEvent</code>) may be sent on a single operation.</p>
</div>
<div class="paragraph">
<p>If more than one event is generated Infinispan will mark the event that it was generated by a retried command to help the user to know when this occurs without having to pay attention to view changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyRetryListener</span> {
  <span class="annotation">@CacheEntryModified</span>
  <span class="directive">public</span> <span class="type">void</span> entryModified(CacheEntryModifiedEvent event) {
    <span class="keyword">if</span> (event.isCommandRetried()) {
      <span class="comment">// Do something</span>
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also when using a <code>CacheEventFilter</code> or <code>CacheEventConverter</code> the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/notifications/cachelistener/filter/EventType.html">EventType</a> contains a method <code>isRetry</code> to tell if the event was generated due to retry.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cache_manager_level_notifications"><a class="anchor" href="#cache_manager_level_notifications"></a>3.3.2. Cache manager-level notifications</h4>
<div class="paragraph">
<p>Cache manager-level events occur on a cache manager.  These too are global and  cluster-wide, but involve events that affect all caches created by a single cache manager.  Examples of cache manager-level events are nodes joining or leaving a cluster, or caches starting or stopping.</p>
</div>
<div class="paragraph">
<p>Please see the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/notifications/cachemanagerlistener/annotation/package-summary.html">Javadocs  on the org.infinispan.notifications.cachemanagerlistener.annotation package</a> for a comprehensive list of all cache manager-level notifications,  and their respective method-level annotations.</p>
</div>
</div>
<div class="sect3">
<h4 id="synchronicity_of_events"><a class="anchor" href="#synchronicity_of_events"></a>3.3.3. Synchronicity of events</h4>
<div class="paragraph">
<p>By default, all notifications are dispatched in the same thread that generates the event.  This means that you <em>must</em> write your listener such that it does not block or do anything that takes too long, as it would prevent the thread from progressing.  Alternatively, you could annotate your listener as <em>asynchronous</em> , in which case a separate thread pool will be used to dispatch the notification and prevent blocking the event originating thread.  To do this, simply annotate your listener such:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span> (sync = <span class="predefined-constant">false</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyAsyncListener</span> { .... }</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="asynchronous_thread_pool"><a class="anchor" href="#asynchronous_thread_pool"></a>Asynchronous thread pool</h5>
<div class="paragraph">
<p>To tune the thread pool used to dispatch such asynchronous notifications, use the <a href="http://docs.jboss.org/infinispan/9.4/configdocs/infinispan-config-9.4.html"><code>&lt;listener-executor /&gt;</code></a> XML element in your configuration file.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cache_asynchronous_api"><a class="anchor" href="#cache_asynchronous_api"></a>3.4. Asynchronous API</h3>
<div class="paragraph">
<p>In addition to synchronous API methods like <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">Cache.put()</a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#remove-java.lang.Object-">Cache.remove()</a> , etc., Infinispan also has an asynchronous, non-blocking API where you can achieve the same results in a non-blocking fashion.</p>
</div>
<div class="paragraph">
<p>These methods are named in a similar fashion to their blocking counterparts, with "Async" appended. E.g., <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/AsyncCache.html#putAsync-K-V-">Cache.putAsync()</a> , <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/AsyncCache.html#removeAsync-java.lang.Object-">Cache.removeAsync()</a> , etc. These asynchronous counterparts return a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Future.html">Future</a> containing the actual result of the operation.</p>
</div>
<div class="paragraph">
<p>For example, in a cache parameterized as <code>Cache&lt;String, String&gt;</code>, <code>Cache.put(String key, String value)</code> returns a <code>String</code>.
<code>Cache.putAsync(String key, String value)</code> would return a <code>Future&lt;String&gt;</code>.</p>
</div>
<div class="sect3">
<h4 id="why_use_such_an_api"><a class="anchor" href="#why_use_such_an_api"></a>3.4.1. Why use such an API?</h4>
<div class="paragraph">
<p>Non-blocking APIs are powerful in that they provide all of the guarantees of synchronous communications - with the ability to handle communication failures and exceptions - with the ease of not having to block until a call completes. This allows you to better harness parallelism in your system. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;<span class="predefined-type">Future</span>&lt;?&gt;&gt; futures = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;<span class="predefined-type">Future</span>&lt;?&gt;&gt;();
futures.add(cache.putAsync(key1, value1)); <span class="comment">// does not block</span>
futures.add(cache.putAsync(key2, value2)); <span class="comment">// does not block</span>
futures.add(cache.putAsync(key3, value3)); <span class="comment">// does not block</span>

<span class="comment">// the remote calls for the 3 puts will effectively be executed</span>
<span class="comment">// in parallel, particularly useful if running in distributed mode</span>
<span class="comment">// and the 3 keys would typically be pushed to 3 different nodes</span>
<span class="comment">// in the cluster</span>

<span class="comment">// check that the puts completed successfully</span>
<span class="keyword">for</span> (<span class="predefined-type">Future</span>&lt;?&gt; f: futures) f.get();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="which_processes_actually_happen_asynchronously"><a class="anchor" href="#which_processes_actually_happen_asynchronously"></a>3.4.2. Which processes actually happen asynchronously?</h4>
<div class="paragraph">
<p>There are 4 things in Infinispan that can be considered to be on the critical path of a typical write operation.
These are, in order of cost:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>network calls</p>
</li>
<li>
<p>marshalling</p>
</li>
<li>
<p>writing to a cache store (optional)</p>
</li>
<li>
<p>locking</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As of Infinispan 4.0, using the async methods will take the network calls and marshalling off the critical path. For various technical reasons, writing to a cache store and acquiring locks, however, still happens in the caller&#8217;s thread. In future, we plan to take these offline as well. See <a href="http://lists.jboss.org/pipermail/infinispan-dev/2010-January/002219.html">this developer mail list thread</a> about this topic.</p>
</div>
</div>
<div class="sect3">
<h4 id="notifying_futures"><a class="anchor" href="#notifying_futures"></a>3.4.3. Notifying futures</h4>
<div class="paragraph">
<p>Strictly, these methods do not return JDK Futures, but rather a sub-interface known as a <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/util/concurrent/NotifyingFuture.html">NotifyingFuture</a> . The main difference is that you can attach a listener to a NotifyingFuture such that you could be notified when the future completes. Here is an example of making use of a notifying future:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">FutureListener futureListener = <span class="keyword">new</span> FutureListener() {

   <span class="directive">public</span> <span class="type">void</span> futureDone(<span class="predefined-type">Future</span> future) {
<span class="error"></span><span class="error"></span><span class="error"></span>   <span class="keyword">try</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>future.get();
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>} <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="comment">// Future did not complete successfully</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Help!</span><span class="delimiter">&quot;</span></span>);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>}
<span class="error"></span><span class="error"></span><span class="error"></span>}
};
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span>
cache.putAsync(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>).attachListener(futureListener);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="further_reading_2"><a class="anchor" href="#further_reading_2"></a>3.4.4. Further reading</h4>
<div class="paragraph">
<p>The Javadocs on the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html">Cache</a> interface has some examples on using the asynchronous API, as does <a href="http://infinispan.blogspot.com/2009/05/whats-so-cool-about-asynchronous-api.html">this article</a> by Manik Surtani introducing the API.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="invocation_flags"><a class="anchor" href="#invocation_flags"></a>3.5. Invocation Flags</h3>
<div class="paragraph">
<p>An important aspect of getting the most of Infinispan is the use of per-invocation flags in order to provide specific behaviour to each particular cache call. By doing this, some important optimizations can be implemented potentially saving precious time and network resources. One of the most popular usages of flags can be found right in Cache API, underneath the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html#putForExternalRead-K-V-">putForExternalRead()</a> method which is used to load an Infinispan cache with data read from an external resource. In order to make this call efficient, Infinispan basically calls a normal put operation passing the following flags: <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/context/Flag.html#FAIL_SILENTLY">FAIL_SILENTLY</a> , <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/context/Flag.html#FORCE_ASYNCHRONOUS">FORCE_ASYNCHRONOUS</a> , <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/context/Flag.html#ZERO_LOCK_ACQUISITION_TIMEOUT">ZERO_LOCK_ACQUISITION_TIMEOUT</a></p>
</div>
<div class="paragraph">
<p>What Infinispan is doing here is effectively saying that when putting data read from external read, it will use an almost-zero lock acquisition time and that if the locks cannot be acquired, it will fail silently without throwing any exception related to lock acquisition. It also specifies that regardless of the cache mode, if the cache is clustered, it will replicate asynchronously and so won&#8217;t wait for responses from other nodes. The combination of all these flags make this kind of operation very efficient, and the efficiency comes from the fact this type of <em>putForExternalRead</em> calls are used with the knowledge that client can always head back to a persistent store of some sorts to retrieve the data that should be stored in memory. So, any attempt to store the data is just a best effort and if not possible, the client should try again if there&#8217;s a cache miss.</p>
</div>
<div class="sect3">
<h4 id="examples"><a class="anchor" href="#examples"></a>3.5.1. Examples</h4>
<div class="paragraph">
<p>If you want to use these or any other flags available, which by the way are described in detail the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/context/Flag.html">Flag enumeration</a> , you simply need to get hold of the advanced cache and add the flags you need via the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/AdvancedCache.html#withFlags-org.infinispan.context.Flag&#8230;&#8203;-">withFlags()</a> method call. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache cache = ...
cache.getAdvancedCache()
<span class="error"></span><span class="error"></span> .withFlags(Flag.SKIP_CACHE_STORE, Flag.CACHE_MODE_LOCAL)
<span class="error"></span><span class="error"></span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s worth noting that these flags are only active for the duration of the cache operation. If the same flags need to be used in several invocations, even if they&#8217;re in the same transaction, <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/AdvancedCache.html#withFlags-org.infinispan.context.Flag&#8230;&#8203;-">withFlags()</a> needs to be called repeatedly. Clearly, if the cache operation is to be replicated in another node, the flags are carried over to the remote nodes as well.</p>
</div>
<div class="sect4">
<h5 id="suppressing_return_values_from_a_put_or_remove"><a class="anchor" href="#suppressing_return_values_from_a_put_or_remove"></a>Suppressing return values from a put() or remove()</h5>
<div class="paragraph">
<p>Another very important use case is when you want a write operation such as put() to <em>not</em> return the previous value. To do that, you need to use two flags to make sure that in a distributed environment, no remote lookup is done to potentially get previous value, and if the cache is configured with a cache loader, to avoid loading the previous value from the cache store. You can see these two flags in action in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache cache = ...
cache.getAdvancedCache()
<span class="error"></span><span class="error"></span> .withFlags(Flag.SKIP_REMOTE_LOOKUP, Flag.SKIP_CACHE_LOAD)
<span class="error"></span><span class="error"></span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information, please check the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/context/Flag.html">Flag enumeration</a> javadoc.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tree_api_module"><a class="anchor" href="#tree_api_module"></a>3.6. Tree API Module</h3>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/package-summary.html">Infinispan&#8217;s tree API module</a> offers clients the possibility of storing data using a tree-structure like API. This API is similar to the one <a href="http://docs.jboss.org/jbosscache/3.2.1.GA/apidocs/org/jboss/cache/package-summary.html">provided by JBoss Cache</a>, hence the tree module is perfect for those users wanting to migrate their applications from JBoss Cache to Infinispan, who want to limit changes their codebase as part of the migration. Besides, it&#8217;s important to understand that Infinispan provides this tree API much more efficiently than JBoss Cache did, so if you&#8217;re a user of the tree API in JBoss Cache, you should consider migrating to Infinispan.</p>
</div>
<div class="sect3">
<h4 id="what_is_tree_api_about"><a class="anchor" href="#what_is_tree_api_about"></a>3.6.1. What is Tree API about?</h4>
<div class="paragraph">
<p>The aim of this API is to store information in a hierarchical way. The hierarchy is defined using paths represented as <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/Fqn.html">Fqn or fully qualified names</a> , for example: <em>/this/is/a/fqn/path</em> or <em>/another/path</em> . In the hierarchy, there&#8217;s a special path called root which represents the starting point of all paths and it&#8217;s represented as: <em>/</em></p>
</div>
<div class="paragraph">
<p>Each FQN path is represented as a node where users can store data using a key/value pair style API (i.e. a Map). For example, in <em>/persons/john</em> , you could store information belonging to John, for example: surname=Smith, birthdate=05/02/1980&#8230;&#8203;etc.</p>
</div>
<div class="paragraph">
<p>Please remember that users should not use root as a place to store data. Instead, users should define their own paths and store data there. The following sections will delve into the practical aspects of this API.</p>
</div>
</div>
<div class="sect3">
<h4 id="using_the_tree_api"><a class="anchor" href="#using_the_tree_api"></a>3.6.2. Using the Tree API</h4>
<div class="sect4">
<h5 id="dependencies"><a class="anchor" href="#dependencies"></a>Dependencies</h5>
<div class="paragraph">
<p>For your application to use the tree API, you need to import infinispan-tree.jar which can be located in the Infinispan binary distributions, or you can simply add a dependency to this module in your pom.xml:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
  ...
 <span class="tag">&lt;dependency&gt;</span>
 <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
 <span class="tag">&lt;artifactId&gt;</span>infinispan-tree<span class="tag">&lt;/artifactId&gt;</span>
 <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
 <span class="tag">&lt;/dependency&gt;</span>
 ...
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="creating_a_tree_cache"><a class="anchor" href="#creating_a_tree_cache"></a>3.6.3. Creating a Tree Cache</h4>
<div class="paragraph">
<p>The first step to use the tree API is to actually create a tree cache. To do so, you need to create an Infinispan Cache as you&#8217;d normally do, and using the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/TreeCacheFactory.html">TreeCacheFactory</a> , create an instance of <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/TreeCache.html">TreeCache</a> . A very important note to remember here is that the Cache instance passed to the factory must be configured with invocation batching. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.config.Configuration</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.tree.TreeCacheFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.tree.TreeCache</span>;
...
Configuration config = <span class="keyword">new</span> <span class="predefined-type">Configuration</span>();
config.setInvocationBatchingEnabled(<span class="predefined-constant">true</span>);
Cache cache = <span class="keyword">new</span> DefaultCacheManager(config).getCache();
TreeCache treeCache = TreeCacheFactory.createTreeCache(cache);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manipulating_data_in_a_tree_cache"><a class="anchor" href="#manipulating_data_in_a_tree_cache"></a>3.6.4. Manipulating data in a Tree Cache</h4>
<div class="paragraph">
<p>The Tree API effectively provides two ways to interact with the data:</p>
</div>
<div class="paragraph">
<p>Via <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/TreeCache.html">TreeCache</a> convenience methods: These methods are located within the TreeCache interface and enable users to <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/TreeCache.html#put-java.lang.String-K-V-">store</a> , <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/TreeCache.html#get-org.infinispan.tree.Fqn-K-">retrieve</a> , <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/TreeCache.html#move-org.infinispan.tree.Fqn-org.infinispan.tree.Fqn-">move</a> , <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/TreeCache.html#remove-org.infinispan.tree.Fqn-K-">remove</a> &#8230;&#8203;etc data with a single call that takes the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/Fqn.html">Fqn</a> , in String or Fqn format, and the data involved in the call. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">treeCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">/persons/john</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.tree.Fqn</span>;
...
Fqn johnFqn = Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons/john</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Calendar</span> calendar = <span class="predefined-type">Calendar</span>.getInstance();
calendar.set(<span class="integer">1980</span>, <span class="integer">5</span>, <span class="integer">2</span>);
treeCache.put(johnFqn, <span class="string"><span class="delimiter">&quot;</span><span class="content">birthdate</span><span class="delimiter">&quot;</span></span>, calendar.getTime()));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Via <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/Node.html">Node</a> API: It allows finer control over the individual nodes that form the FQN, allowing manipulation of nodes relative to a particular node. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.tree.Node</span>;
...
TreeCache treeCache = ...
Fqn johnFqn = Fqn.fromElements(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>);
Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; john = treeCache.getRoot().addChild(johnFqn);
john.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Node persons = treeCache.getRoot().addChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>));
Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; john = persons.addChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
john.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or even:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Fqn personsFqn = Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>);
Fqn johnFqn = Fqn.fromRelative(personsFqn, Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; john = treeCache.getRoot().addChild(johnFqn);
john.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>A node also provides the ability to access its <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/Node.html#getParent--">parent</a> or <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tree/Node.html#getChildren--">children</a> . For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; john = ...
Node persons = john.getParent();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; personsChildren = persons.getChildren();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="common_operations"><a class="anchor" href="#common_operations"></a>3.6.5. Common Operations</h4>
<div class="paragraph">
<p>In the previous section, some of the most used operations, such as addition and retrieval, have been shown. However, there are other important operations that are worth mentioning, such as remove:</p>
</div>
<div class="paragraph">
<p>You can for example remove an entire node, i.e. <em>/persons/john</em> , using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">treeCache.removeNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">/persons/john</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or remove a child node, i.e. persons that a child of root, via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">treeCache.getRoot().removeChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also remove a particular key/value pair in a node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Node john = treeCache.getRoot().getChild(Fqn.fromElements(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
john.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or you can remove all data in a node with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Node john = treeCache.getRoot().getChild(Fqn.fromElements(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
john.clearData();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another important operation supported by Tree API is the ability to move nodes around in the tree. Imagine we have a node called "john" which is located under root node. The following example is going to show how to we can move "john" node to be under "persons" node:</p>
</div>
<div class="paragraph">
<p>Current tree structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> /persons
 /john</pre>
</div>
</div>
<div class="paragraph">
<p>Moving trees from one FQN to another:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Node john = treeCache.getRoot().addChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
Node persons = treeCache.getRoot().getChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>));
treeCache.move(john.getFqn(), persons.getFqn());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Final tree structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>   /persons/john</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="locking_in_the_tree_api"><a class="anchor" href="#locking_in_the_tree_api"></a>3.6.6. Locking in the Tree API</h4>
<div class="paragraph">
<p>Understanding when and how locks are acquired when manipulating the tree structure is important in order to maximise the performance of any client application interacting against the tree, while at the same time maintaining consistency.</p>
</div>
<div class="paragraph">
<p>Locking on the tree API happens on a per node basis. So, if you&#8217;re putting or updating a key/value under a particular node, a write lock is acquired for that node. In such case, no write locks are acquired for parent node of the node being modified, and no locks are acquired for children nodes.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re adding or removing a node, the parent is not locked for writing. In JBoss Cache, this behaviour was configurable with the default being that parent was not locked for insertion or removal.</p>
</div>
<div class="paragraph">
<p>Finally, when a node is moved, the node that&#8217;s been moved and any of its children are locked, but also the target node and the new location of the moved node and its children. To understand this better, let&#8217;s look at an example:</p>
</div>
<div class="paragraph">
<p>Imagine you have a hierarchy like this and we want to move c/ to be underneath b/:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> /
 --|--
 / \
 a c
 | |
 b e
 |
 d</pre>
</div>
</div>
<div class="paragraph">
<p>The end result would be something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> /
 |
 a
 |
 b
 --|--
 / \
 d c
 |
 e</pre>
</div>
</div>
<div class="paragraph">
<p>To make this move, locks would have been acquired on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>/a/b</em> - because it&#8217;s the parent underneath which the data will be put</p>
</li>
<li>
<p><em>/c</em> and <em>/c/e</em> - because they&#8217;re the nodes that are being moved</p>
</li>
<li>
<p><em>/a/b/c</em> and <em>/a/b/c/e</em> - because that&#8217;s new target location for the nodes being moved</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="listeners_for_tree_cache_events"><a class="anchor" href="#listeners_for_tree_cache_events"></a>3.6.7. Listeners for tree cache events</h4>
<div class="paragraph">
<p>The current Infinispan listeners have been designed with key/value store notifications in mind, and hence they do not map to tree cache events correctly. Tree cache specific listeners that map directly to tree cache events (i.e. adding a child&#8230;&#8203;etc) are desirable but these are not yet available. If you&#8217;re interested in this type of listeners, please follow <a href="https://issues.jboss.org/browse/ISPN-1935">this issue</a> to find out about any progress in this area.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functional_map_api"><a class="anchor" href="#functional_map_api"></a>3.7. Functional Map API</h3>
<div class="paragraph">
<p>Infinispan 8 introduces a new experimental API for interacting with your
data which takes advantage of the functional programming additions and
improved asynchronous programming capabilities available in Java 8.</p>
</div>
<div class="paragraph">
<p>Infinispan&#8217;s <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.html">Functional Map API</a>
is a distilled map-like asynchronous API which uses functions to interact with data.</p>
</div>
<div class="sect3">
<h4 id="asynchronous_and_lazy"><a class="anchor" href="#asynchronous_and_lazy"></a>3.7.1. Asynchronous and Lazy</h4>
<div class="paragraph">
<p>Being an asynchronous API, all methods that return a single result,
return a CompletableFuture which wraps the result, so you can use the
resources of your system more efficiently by having the possibility to
receive callbacks when the
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>
has completed, or you can chain or compose them with other CompletableFuture.</p>
</div>
<div class="paragraph">
<p>For those operations that return multiple results, the API returns
instances of a
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Traversable.html"><code>Traversable</code></a>
interface which offers a lazy pull-style
API for working with multiple results.
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Traversable.html"><code>Traversable</code></a>
, being a lazy pull-style API, can still be asynchronous underneath
since the user can decide to work on the traversable at a later stage,
and the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Traversable.html"><code>Traversable</code></a>
implementation itself can decide when to compute
those results.</p>
</div>
</div>
<div class="sect3">
<h4 id="function_transparency"><a class="anchor" href="#function_transparency"></a>3.7.2. Function transparency</h4>
<div class="paragraph">
<p>Since the content of the functions is transparent to Infinispan, the API
has been split into 3 interfaces for read-only (
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadOnlyMap.html"><code>ReadOnlyMap</code></a>
), read-write (
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html"><code>ReadWriteMap</code></a>
) and write-only (
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html"><code>WriteOnlyMap</code></a>
) operations respectively, in order to provide hints to the Infinispan
internals on the type of work needed to support functions.</p>
</div>
</div>
<div class="sect3">
<h4 id="constructing_functional_maps"><a class="anchor" href="#constructing_functional_maps"></a>3.7.3. Constructing Functional Maps</h4>
<div class="paragraph">
<p>To construct any of the read-only, write-only or read-write map
instances, an Infinispan
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a>
is required, which is retrieved from the Cache Manager, and using the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a>
, static method
factory methods are used to create
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadOnlyMap.html"><code>ReadOnlyMap</code></a>
,
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html"><code>ReadWriteMap</code></a>
or
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html"><code>WriteOnlyMap</code></a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.impl</span>.*;

AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...

FunctionalMapImpl&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; functionalMap = FunctionalMapImpl.create(cache);
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ReadOnlyMapImpl.create(functionalMap);
WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = WriteOnlyMapImpl.create(functionalMap);
ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ReadWriteMapImpl.create(functionalMap);</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
At this stage, the Functional Map API is experimental and hence the
way FunctionalMap, ReadOnlyMap, WriteOnlyMap and ReadWriteMap are constructed
is temporary.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="read_only_map_api"><a class="anchor" href="#read_only_map_api"></a>3.7.4. Read-Only Map API</h4>
<div class="paragraph">
<p>Read-only operations have the advantage that no locks are acquired
for the duration of the operation. Here&#8217;s an example on how to the
equivalent operation for
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#get-java.lang.Object-">Map.get(K)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...
CompletableFuture&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt; readFuture = readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, ReadEntryView::find);
readFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read-only map also exposes operations to retrieve multiple keys in one go:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Traversable</span>;

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

Set&lt;<span class="predefined-type">String</span>&gt; keys = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;(<span class="predefined-type">Arrays</span>.asList(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>));
Traversable&lt;<span class="predefined-type">String</span>&gt; values = readOnlyMap.evalMany(keys, ReadEntryView::get);
values.forEach(<span class="predefined-type">System</span>.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, read-only map also exposes methods to read all existing keys as well
as entries, which include both key and value information.</p>
</div>
<div class="sect4">
<h5 id="read_only_entry_view"><a class="anchor" href="#read_only_entry_view"></a>Read-Only Entry View</h5>
<div class="paragraph">
<p>The function parameters for read-only maps provide the user with a
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html">read-only entry view</a>
to interact with the data in the cache, which include these operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#key--"><code>key()</code></a>
method returns the key for which this function is being executed.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#find--"><code>find()</code></a>
returns a Java 8 <code>Optional</code> wrapping the value if present,
otherwise it returns an empty optional. Unless the value is guaranteed to
be associated with the key, it&#8217;s recommended to use <code>find()</code> to verify
whether there&#8217;s a value associated with the key.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#get--"><code>get()</code></a>
returns the value associated with the key. If the key has no value
associated with it, calling <code>get()</code> throws a <code>NoSuchElementException</code>.
<code>get()</code> can be considered as a shortcut of <code>ReadEntryView.find().get()</code>
which should be used only when the caller has guarantees that there&#8217;s
definitely a value associated with the key.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/MetaParam.Lookup.html#findMetaParam-java.lang.Class-"><code>findMetaParam(Class&lt;T&gt; type)</code></a>
allows metadata parameter information
associated with the cache entry to be looked up, for example: entry
lifespan, last  accessed time&#8230;&#8203;etc.
See <a href="#meta_parameter">Metadata Parameter Handling</a> to find out more.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="write_only_map_api"><a class="anchor" href="#write_only_map_api"></a>3.7.5. Write-Only Map API</h4>
<div class="paragraph">
<p>Write-only operations include operations that insert or update data in the
cache and also removals. Crucially, a write-only operation does not attempt
to read any previous value associated with the key. This is an important
optimization since that means neither the cluster nor any persistence stores
will be looked up to retrieve previous values. In the main Infinispan Cache,
this kind of optimization was achieved using a local-only per-invocation
flag, but the use case is so common that in this new functional API, this
optimization is provided as a first-class citizen.</p>
</div>
<div class="paragraph">
<p>Using
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html">write-only map API</a>
, an operation equivalent to
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>javax.cache.Cache</code> (<code>JCache</code>)</a>
's void returning
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java#L194"><code>put</code></a>
can be achieved this way, followed by an attempt to read the stored
value using the read-only map API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
   (v, view) -&gt; view.set(v));
CompletableFuture&lt;<span class="predefined-type">String</span>&gt; readFuture = writeFuture.thenCompose(r -&gt;
   readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, ReadEntryView::get));
readFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple key/value pairs can be stored in one go using
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#evalMany-java.util.Map-java.util.function.BiConsumer-"><code>evalMany</code></a>
API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

Map&lt;K, <span class="predefined-type">String</span>&gt; data = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
data.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>);
data.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span>);
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writerAllFuture = writeOnlyMap.evalMany(data, (v, view) -&gt; view.set(v));
writerAllFuture.thenAccept(x -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Write completed</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove all contents of the cache, there are two possibilities with
different semantics. If using
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#evalAll-java.util.function.Consumer-"><code>evalAll</code></a>
each cached entry is iterated over and the function is called
with that entry&#8217;s information. Using this method also results in listeners being invoked. See <a href="#functional_listeners">functional listeners</a> for more information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; removeAllFuture = writeOnlyMap.evalAll(WriteEntryView::remove);
removeAllFuture.thenAccept(x -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">All entries removed</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The alternative way to remove all entries is to call
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#truncate--"><code>truncate</code></a>
operation which clears the entire cache contents in one go without
invoking any listeners and is best-effort:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; truncateFuture = writeOnlyMap.truncate();
truncateFuture.thenAccept(x -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Cache contents cleared</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="write_only_entry_view"><a class="anchor" href="#write_only_entry_view"></a>Write-Only Entry View</h5>
<div class="paragraph">
<p>The function parameters for write-only maps provide the user with a
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/EntryView.WriteEntryView.html">write-only entry view</a>
to modify the data in the cache, which include these
operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/EntryView.WriteEntryView.html#set-V-org.infinispan.commons.api.functional.MetaParam.Writable&#8230;&#8203;-"><code>set(V, MetaParam.Writable&#8230;&#8203;)</code></a>
method allows for a new value to be
associated with the cache entry for which this function is executed, and it
optionally takes zero or more metadata parameters to be stored along with
the value. See <a href="#meta_parameter">Metadata Parameter Handling</a> for more information.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/EntryView.WriteEntryView.html#remove--"><code>remove()</code></a>
method removes the cache entry, including both value and metadata
parameters associated with this key.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="read_write_map_api"><a class="anchor" href="#read_write_map_api"></a>3.7.6. Read-Write Map API</h4>
<div class="paragraph">
<p>The final type of operations we have are readwrite operations, and within
this category CAS-like (CompareAndSwap) operations can be found.
This type of operations require previous value associated with the key
to be read and for locks to be acquired before executing the function.
The vast majority of operations within
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a>
and
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>
APIs fall within this category, and they can easily be implemented using the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html">read-write map API</a>
. Moreover, with
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html">read-write map API</a>
, you can make CASlike comparisons not only based on value equality
but based on metadata parameter equality such as version information,
and you can send back previous value or boolean instances to signal
whether the CASlike comparison succeeded.</p>
</div>
<div class="paragraph">
<p>Implementing a write operation that returns the previous value associated
with the cache entry is easy to achieve with the read-write map API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ...

CompletableFuture&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt; readWriteFuture = readWriteMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
   (v, view) -&gt; {
      Optional&lt;V&gt; prev = rw.find();
      view.set(v);
      <span class="keyword">return</span> prev;
   });
readWriteFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#replace-K-V-V-"><code>ConcurrentMap.replace(K, V, V)</code></a>
is a replace function that compares the
value present in the map and if it&#8217;s equals to the value passed in as
first parameter, the second value is stored, returning a boolean
indicating whether the replace was successfully completed. This operation
can easily be implemented using the read-write map API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ...

String oldValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">old-value</span><span class="delimiter">&quot;</span></span>;
CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; replaceFuture = readWriteMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>, (v, view) -&gt; {
   <span class="keyword">return</span> view.find().map(prev -&gt; {
      <span class="keyword">if</span> (prev.equals(oldValue)) {
         rw.set(v);
         <span class="keyword">return</span> <span class="predefined-constant">true</span>; <span class="comment">// previous value present and equals to the expected one</span>
      }
      <span class="keyword">return</span> <span class="predefined-constant">false</span>; <span class="comment">// previous value associated with key does not match</span>
   }).orElse(<span class="predefined-constant">false</span>); <span class="comment">// no value associated with this key</span>
});
replaceFuture.thenAccept(replaced -&gt; <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Value was replaced? %s%n</span><span class="delimiter">&quot;</span></span>, replaced));</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The function in the example above captures <code>oldValue</code> which is an
external value to the function which is valid use case.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Read-write map API contains <code>evalMany</code> and <code>evalAll</code> operations which behave
similar to the write-only map offerings, except that they enable previous
value and metadata parameters to be read.</p>
</div>
<div class="sect4">
<h5 id="read_write_entry_view"><a class="anchor" href="#read_write_entry_view"></a>Read-Write Entry View</h5>
<div class="paragraph">
<p>The function parameters for read-write maps provide the user with the
possibility to query the information associated with the key, including
value and metadata parameters, and the user can also use this
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/EntryView.ReadWriteEntryView.html">read-write entry view</a>
to modify the data in the cache.</p>
</div>
<div class="paragraph">
<p>The operations are exposed by read-write entry views are a union of
the operations exposed by <a href="#read_only_entry_view">read-only entry views</a>
and <a href="#write_only_entry_view">write-only entry views</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="meta_parameter"><a class="anchor" href="#meta_parameter"></a>3.7.7. Metadata Parameter Handling</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/MetaParam.html">Metadata parameters</a>
provide extra information about the cache entry, such
as version information, lifespan, last accessed/used time&#8230;&#8203;etc. Some of
these can be provided by the user, e.g. version, lifespan&#8230;&#8203;etc, but some
others are computed internally and can only be queried, e.g. last
accessed/used time.</p>
</div>
<div class="paragraph">
<p>The functional map API provides a flexible way to store metadata parameters
along with an cache entry. To be able to store a metadata parameter, it must
extend
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/MetaParam.Lookup.html"><code>MetaParam.Writable</code></a>
interface, and implement the methods to allow the
internal logic to extra the data. Storing is done via the
<code>set(V, MetaParam.Writable&#8230;&#8203;)</code> method in the <a href="#write_only_entry_view">write-only entry view</a> or <a href="#read_write_entry_view">read-write entry view</a> function parameters.</p>
</div>
<div class="paragraph">
<p>Querying metadata parameters is available via the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/MetaParam.Lookup.html#findMetaParam-java.lang.Class-"><code>findMetaParam(Class)</code></a>
method
available via <a href="#read_write_entry_view">read-write entry view</a> or
<a href="#read_only_entry_view">read-only entry views</a> or function parameters.</p>
</div>
<div class="paragraph">
<p>Here is an example showing how to store metadata parameters and how to query
them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.time.Duration</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.MetaParam</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
   (v, view) -&gt; view.set(v, <span class="keyword">new</span> MetaLifespan(<span class="predefined-type">Duration</span>.ofHours(<span class="integer">1</span>).toMillis())));
CompletableFuture&lt;MetaLifespan&gt; readFuture = writeFuture.thenCompose(r -&gt;
   readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, view -&gt; view.findMetaParam(MetaLifespan.class).get()));
readFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the metadata parameter is generic, for example
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/MetaParam.MetaEntryVersion.html"><code>MetaEntryVersion&lt;T&gt;</code></a>
, retrieving the metadata parameter along with a specific type can be tricky
if using <code>.class</code> static helper in a class because it does not return a
<code>Class&lt;T&gt;</code> but only <code>Class</code>, and hence any generic information in the class is
lost:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">String</span>&gt; readFuture = readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, view -&gt; {
   <span class="comment">// If caller depends on the typed information, this is not an ideal way to retrieve it</span>
   <span class="comment">// If the caller does not depend on the specific type, this works just fine.</span>
   Optional&lt;MetaEntryVersion&gt; version = view.findMetaParam(MetaEntryVersion.class);
   <span class="keyword">return</span> view.get();
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>When generic information is important the user can define a static helper
method that coerces the static class retrieval to the type requested,
and then use that helper method in the call to <code>findMetaParam</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">MetaEntryVersion</span>&lt;T&gt; <span class="directive">implements</span> MetaParam.Writable&lt;EntryVersion&lt;T&gt;&gt; {
   ...
   public <span class="directive">static</span> &lt;T&gt; T type() { <span class="keyword">return</span> (T) MetaEntryVersion.class; }
   ...
}

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">String</span>&gt; readFuture = readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, view -&gt; {
   <span class="comment">// The caller wants guarantees that the metadata parameter for version is numeric</span>
   <span class="comment">// e.g. to query the actual version information</span>
   Optional&lt;MetaEntryVersion&lt;<span class="predefined-type">Long</span>&gt;&gt; version = view.findMetaParam(MetaEntryVersion.type());
   <span class="keyword">return</span> view.get();
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, users are free to create new instances of metadata parameters to
suit their needs. They are stored and retrieved in the very same way as done
for the metadata parameters already provided by the functional map API.</p>
</div>
</div>
<div class="sect3">
<h4 id="_invocation_parameter"><a class="anchor" href="#_invocation_parameter"></a>3.7.8. Invocation Parameter</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Param.html">Per-invocation parameters</a>
are applied to regular functional map API calls to
alter the behaviour of certain aspects. Adding per invocation parameters is
done using the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.html#withParams-org.infinispan.commons.api.functional.Param&#8230;&#8203;-"><code>withParams(Param&lt;?&gt;&#8230;&#8203;)</code></a>
method.</p>
</div>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Param.FutureMode.html"><code>Param.FutureMode</code></a>
tweaks whether a method returning a
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>
will span a thread to invoke the method, or instead will use the caller
thread. By default, whenever a call is made to a method returning a
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>
, a separate thread will be span to execute the method asynchronously.
However, if the caller will immediately block waiting for the
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>
to complete, spanning a different thread is wasteful, and hence
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Param.FutureMode.html#COMPLETED"><code>Param.FutureMode.COMPLETED</code></a>
can be passed as per-invocation parameter to avoid creating that extra thread. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Param</span>.*;

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMapCompleted = readOnlyMap.withParams(FutureMode.COMPLETED);
Optional&lt;<span class="predefined-type">String</span>&gt; readFuture = readOnlyMapCompleted.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, ReadEntryView::find).get();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Param.PersistenceMode controls whether a write operation will be propagated
to a persistence store. The default behaviour is for all write-operations
to be propagated to the persistence store if the cache is configured with
a persistence store. By passing PersistenceMode.SKIP as parameter,
the write operation skips the persistence store and its effects are only
seen in the in-memory contents of the cache. PersistenceMode.SKIP can
be used to implement an
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html#evict-K-"><code>Cache.evict()</code></a>
method which removes data from memory but leaves the persistence store
untouched:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Param</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; skiPersistMap = writeOnlyMap.withParams(PersistenceMode.SKIP);
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; removeFuture = skiPersistMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, WriteEntryView::remove);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that there&#8217;s no need for another PersistenceMode option to skip
reading from the persistence store, because a write operation can skip
reading previous value from the store by calling a write-only operation
via the WriteOnlyMap.</p>
</div>
<div class="paragraph">
<p>Finally, new Param implementations are normally provided by the functional
map API since they tweak how the internal logic works. So, for the most part
of users, they should limit themselves to using the Param instances exposed
by the API. The exception to this rule would be advanced users who decide
to add new interceptors to the internal stack. These users have the ability
to query these parameters within the interceptors.</p>
</div>
</div>
<div class="sect3">
<h4 id="functional_listeners"><a class="anchor" href="#functional_listeners"></a>3.7.9. Functional Listeners</h4>
<div class="paragraph">
<p>The functional map offers a listener API, where clients can register for and
get notified when events take place. These notifications are post-event, so
that means the events are received after the event has happened.</p>
</div>
<div class="paragraph">
<p>The listeners that can be registered are split into two categories:
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.html">write listeners</a>
and
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.html">read-write listeners</a>.</p>
</div>
<div class="sect4">
<h5 id="write_listeners"><a class="anchor" href="#write_listeners"></a>Write Listeners</h5>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.html">Write listeners</a>
enable user to register listeners for any cache entry write events
that happen in either a read-write or write-only functional map.</p>
</div>
<div class="paragraph">
<p>Listeners for write events cannot distinguish between cache entry
created and cache entry modify/update events because they don&#8217;t have
access to the previous value. All they know is that a new non-null
entry has been written.</p>
</div>
<div class="paragraph">
<p>However, write event listeners can distinguish between entry removals
and cache entry create/modify-update events because they can query
what the new entry&#8217;s value via
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#find--"><code>ReadEntryView.find()</code></a>
method.</p>
</div>
<div class="paragraph">
<p>Adding a write listener is done via the WriteListeners interface
which is accessible via both
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html#listeners--"><code>ReadWriteMap.listeners()</code></a>
and
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#listeners--"><code>WriteOnlyMap.listeners()</code></a>
 method.</p>
</div>
<div class="paragraph">
<p>A write listener implementation can be defined either passing a function
to
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.html#onWrite-java.util.function.Consumer-"><code>onWrite(Consumer&lt;ReadEntryView&lt;K, V&gt;&gt;)</code></a>
method, or passing a
WriteListener implementation to
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.html#add-org.infinispan.commons.api.functional.Listeners.WriteListeners.WriteListener-"><code>add(WriteListener&lt;K, V&gt;)</code></a>
method.
Either way, all these methods return an
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html">AutoCloseable</a>
instance that can be used to de-register the function listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Listeners.WriteListeners.WriteListener</span>;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; woMap = ...

AutoCloseable writeFunctionCloseHandler = woMap.listeners().onWrite(written -&gt; {
   <span class="comment">// `written` is a ReadEntryView of the written entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
});
AutoCloseable writeCloseHanlder = woMap.listeners().add(<span class="keyword">new</span> WriteListener&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;() {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onWrite(ReadEntryView&lt;K, V&gt; written) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
   }
});

<span class="comment">// Either wrap handler in a try section to have it auto close...</span>
<span class="keyword">try</span>(writeFunctionCloseHandler) {
   <span class="comment">// Write entries using read-write or write-only functional map API</span>
   ...
}
<span class="comment">// Or close manually</span>
writeCloseHanlder.close();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="read_write_listeners"><a class="anchor" href="#read_write_listeners"></a>Read-Write Listeners</h5>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.html">Read-write listeners</a>
enable users to register listeners for cache entry created, modified
and removed events, and also register listeners for any cache entry
write events.</p>
</div>
<div class="paragraph">
<p>Entry created, modified and removed events can only be fired when these
originate on a read-write functional map, since this is the only one
that guarantees that the previous value has been read, and hence the
differentiation between create, modified and removed can be fully
guaranteed.</p>
</div>
<div class="paragraph">
<p>Adding a read-write listener is done via the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.html"><code>ReadWriteListeners</code></a>
interface which is accessible via
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html#listeners--"><code>ReadWriteMap.listeners()</code></a>
method.</p>
</div>
<div class="paragraph">
<p>If interested in only one of the event types, the simplest way to add a
listener is to pass a function to either
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onCreate-org.infinispan.commons.api.functional.EntryView.ReadEntryView-"><code>onCreate</code></a>
,
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onModify-org.infinispan.commons.api.functional.EntryView.ReadEntryView-org.infinispan.commons.api.functional.EntryView.ReadEntryView-"><code>onModify</code></a>
or
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onRemove-org.infinispan.commons.api.functional.EntryView.ReadEntryView-"><code>onRemove</code></a>
methods. All these methods return an AutoCloseable instance that can be
used to de-register the function listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; rwMap = ...
AutoCloseable createClose = rwMap.listeners().onCreate(created -&gt; {
   <span class="comment">// `created` is a ReadEntryView of the created entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Created: %s%n</span><span class="delimiter">&quot;</span></span>, created.get());
});
AutoCloseable modifyClose = rwMap.listeners().onModify((before, after) -&gt; {
   <span class="comment">// `before` is a ReadEntryView of the entry before update</span>
   <span class="comment">// `after` is a ReadEntryView of the entry after update</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Before: %s%n</span><span class="delimiter">&quot;</span></span>, before.get());
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">After: %s%n</span><span class="delimiter">&quot;</span></span>, after.get());
});
AutoCloseable removeClose = rwMap.listeners().onRemove(removed -&gt; {
   <span class="comment">// `removed` is a ReadEntryView of the removed entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Removed: %s%n</span><span class="delimiter">&quot;</span></span>, removed.get());
});
AutoCloseable writeClose = woMap.listeners().onWrite(written -&gt; {
   <span class="comment">// `written` is a ReadEntryView of the written entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
});
...
<span class="comment">// Either wrap handler in a try section to have it auto close...</span>
try(createClose) {
   <span class="comment">// Create entries using read-write functional map API</span>
   ...
}
<span class="comment">// Or close manually</span>
modifyClose.close();</code></pre>
</div>
</div>
<div class="paragraph">
<p>If listening for two or more event types, it&#8217;s better to pass in an
implementation of
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.WriteListener.html"><code>ReadWriteListener</code></a>
interface via the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.html#add-org.infinispan.commons.api.functional.Listeners.ReadWriteListeners.ReadWriteListener-"><code>ReadWriteListeners.add()</code></a>
method. <code>ReadWriteListener</code> offers the same <code>onCreate</code>/<code>onModify</code>/<code>onRemove</code>
callbacks with default method implementations that are empty:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Listeners.ReadWriteListeners.ReadWriteListener</span>;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; rwMap = ...
AutoCloseable readWriteClose = rwMap.listeners.add(<span class="keyword">new</span> ReadWriteListener&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;() {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onCreate(ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; created) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Created: %s%n</span><span class="delimiter">&quot;</span></span>, created.get());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onModify(ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; before, ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; after) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Before: %s%n</span><span class="delimiter">&quot;</span></span>, before.get());
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">After: %s%n</span><span class="delimiter">&quot;</span></span>, after.get());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onRemove(ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; removed) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Removed: %s%n</span><span class="delimiter">&quot;</span></span>, removed.get());
   }
);
AutoCloseable writeClose = rwMap.listeners.add(<span class="keyword">new</span> WriteListener&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;() {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onWrite(ReadEntryView&lt;K, V&gt; written) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
   }
);

<span class="comment">// Either wrap handler in a try section to have it auto close...</span>
<span class="keyword">try</span>(readWriteClose) {
   <span class="comment">// Create/update/remove entries using read-write functional map API</span>
   ...
}
<span class="comment">// Or close manually</span>
writeClose.close();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="marshalling_of_functions"><a class="anchor" href="#marshalling_of_functions"></a>3.7.10. Marshalling of Functions</h4>
<div class="paragraph">
<p>Running functional map in a cluster of nodes involves marshalling and
replication of the operation parameters under certain circumstances.</p>
</div>
<div class="paragraph">
<p>To be more precise, when write operations are executed in a cluster,
regardless of read-write or write-only operations, all the parameters
to the method and the functions are replicated to other nodes.</p>
</div>
<div class="paragraph">
<p>There are multiple ways in which a function can be marshalled. The simplest
way, which is also the most costly option in terms of payload size, is
to mark the function as
<a href="https://docs.oracle.com/javase/8/docs/api/java/io/Serializable.html"><code>Serializable</code></a>
:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

<span class="comment">// Force a function to be Serializable</span>
Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; function =
   (Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; &amp; <span class="predefined-type">Serializable</span>) wv -&gt; wv.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>);

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, function);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan provides overloads for all functional methods that make lambdas
passed directly to the API serializable by default; the compiler automatically selects
this overload if that&#8217;s possible. Therefore you can call</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, wv -&gt; wv.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>without doing the cast described above.</p>
</div>
<div class="paragraph">
<p>A more economical way to marshall a function is to provide an Infinispan
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/marshall/Externalizer.html"><code>Externalizer</code></a> for it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.Externalizer</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.SerializeFunctionWith</span>;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

<span class="comment">// Force a function to be Serializable</span>
Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; function = <span class="keyword">new</span> SetStringConstant&lt;&gt;();
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, function);

<span class="annotation">@SerializeFunctionWith</span>(value = SetStringConstant.Externalizer0.class)
<span class="type">class</span> <span class="class">SetStringConstant</span> <span class="directive">implements</span> Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> accept(WriteEntryView&lt;<span class="predefined-type">String</span>&gt; view) {
      view.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>);
   }

   <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">Externalizer0</span> <span class="directive">implements</span> Externalizer&lt;<span class="predefined-type">Object</span>&gt; {
      <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> oo, <span class="predefined-type">Object</span> o) {
         <span class="comment">// No-op</span>
      }
      <span class="directive">public</span> <span class="predefined-type">Object</span> readObject(<span class="predefined-type">ObjectInput</span> input) {
         <span class="keyword">return</span> <span class="keyword">new</span> SetStringConstant&lt;&gt;();
      }
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To help users take advantage of the tiny payloads generated by
<code>Externalizer</code>-based functions, the functional API comes with a helper
class called
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/marshall/MarshallableFunctions.html"><code>org.infinispan.commons.marshall.MarshallableFunctions</code></a>
which provides marshallable functions for some of the most commonly user
functions.</p>
</div>
<div class="paragraph">
<p>In fact, all the functions required to implement
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a>
and
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>
using the functional map API have been defined in
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/marshall/MarshallableFunctions.html"><code>MarshallableFunctions</code></a>.
For example, here is an implementation of JCache&#8217;s
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java#L283"><code>boolean putIfAbsent(K, V)</code></a>
using functional map API which can be run in a cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.MarshallableFunctions</span>;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ...

CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; future = readWriteMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1,
   MarshallableFunctions.setValueIfAbsentReturnBoolean());
future.thenAccept(stored -&gt; System.out.printf(</span><span class="delimiter">&quot;</span></span>Value was put? %s%n<span class="string"><span class="delimiter">&quot;</span><span class="content">, stored));</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="use_cases_for_functional_api"><a class="anchor" href="#use_cases_for_functional_api"></a>3.7.11. Use Cases for Functional API</h4>
<div class="paragraph">
<p>This new API is meant to complement existing Key/Value Infinispan API
offerings, so you&#8217;ll still be able to use
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a>
or
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>
standard APIs if that&#8217;s what suits your use case best.</p>
</div>
<div class="paragraph">
<p>The target audience for this new API is either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Distributed or persistent caching/inmemorydatagrid users that want
to benefit from CompletableFuture and/or Traversable for async/lazy data
grid or caching data manipulation. The clear advantage here is that threads
do not need to be idle waiting for remote operations to complete, but
instead these can be notified when remote operations complete and then
chain them with other subsequent operations.</p>
</li>
<li>
<p>Users who want to go beyond the standard operations exposed by
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a>
and
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>, for example, if you want to do a replace
operation using metadata parameter equality instead of value equality, or
if you want to retrieve metadata information from values and so on.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="data_encoding"><a class="anchor" href="#data_encoding"></a>3.8. Encoding</h3>
<div class="sect3">
<h4 id="overview"><a class="anchor" href="#overview"></a>3.8.1. Overview</h4>
<div class="paragraph">
<p>Encoding is the data conversion operation done by Infinispan caches before storing data, and when reading back from storage.</p>
</div>
<div class="paragraph">
<p>It allows dealing with a certain data format during API calls (map, listeners, stream, etc) while the format effectively stored
is different.</p>
</div>
<div class="paragraph">
<p>The data conversions are handled by instances of <em>org.infinispan.commons.dataconversion.Encoder</em> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Encoder</span> {

   <span class="comment">/**
    * Convert data in the read/write format to the storage format.
    *
    * @param content data to be converted, never null.
    * @return Object in the storage format.
    */</span>
   <span class="predefined-type">Object</span> toStorage(<span class="predefined-type">Object</span> content);

   <span class="comment">/**
    * Convert from storage format to the read/write format.
    *
    * @param content data as stored in the cache, never null.
    * @return data in the read/write format
    */</span>
   <span class="predefined-type">Object</span> fromStorage(<span class="predefined-type">Object</span> content);

   <span class="comment">/**
     * Returns the {@link MediaType} produced by this encoder or null if the storage format is not known.
     */</span>
   MediaType getStorageFormat();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="default_encoders"><a class="anchor" href="#default_encoders"></a>3.8.2. Default encoders</h4>
<div class="paragraph">
<p>Infinispan automatically picks the Encoder depending on the cache configuration. The table below shows which internal Encoder is used for several configurations:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Mode</th>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Encoder</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Embedded/Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IdentityEncoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passthrough encoder, no conversion done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Embedded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">StorageType.OFF_HEAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GlobalMarshallerEncoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the Infinispan internal marshaller to convert to byte[]. May delegate to the configured marshaller in the cache manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Embedded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#store_binary">StorageType.BINARY</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BinaryEncoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the Infinispan internal marshaller to convert to byte[], except for primitives and String.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">StorageType.OFF_HEAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IdentityEncoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store byte[]s directly as received by remote clients</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="overriding_programmatically"><a class="anchor" href="#overriding_programmatically"></a>3.8.3. Overriding programmatically</h4>
<div class="paragraph">
<p>Is is possible to override programmatically the encoding used for both keys and values, by calling the <em>.withEncoding()</em> method variants from <em>AdvancedCache</em>.</p>
</div>
<div class="paragraph">
<p>Example, consider the following cache configured as OFF_HEAP:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Read and write POJO, storage will be byte[] since for</span>
<span class="comment">// OFF_HEAP the GlobalMarshallerEncoder is used internally:</span>
cache.put(<span class="integer">1</span>, <span class="keyword">new</span> Pojo())
Pojo value = cache.get(<span class="integer">1</span>)

<span class="comment">// Get the content in its stored format by overriding</span>
<span class="comment">// the internal encoder with a no-op encoder (IdentityEncoder)</span>
Cache&lt;?,?&gt; rawContent = cache.getAdvancedCache().withValueEncoding(IdentityEncoder.class)
<span class="type">byte</span><span class="type">[]</span> marshalled = rawContent.get(<span class="integer">1</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The override can be useful if any operation in the cache does not require decoding, such as counting number of entries,
or calculating the size of byte[] of an OFF_HEAP cache.</p>
</div>
</div>
<div class="sect3">
<h4 id="defining_custom_encoders"><a class="anchor" href="#defining_custom_encoders"></a>3.8.4. Defining custom Encoders</h4>
<div class="paragraph">
<p>A custom encoder can be registered in the <em>EncoderRegistry</em>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Ensure that the registration is done in every node of the cluster, before starting the caches.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider a custom encoder used to compress/decompress with gzip:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">GzipEncoder</span> <span class="directive">implements</span> <span class="predefined-type">Encoder</span> {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Object</span> toStorage(<span class="predefined-type">Object</span> content) {
      <span class="keyword">assert</span> content <span class="keyword">instanceof</span> <span class="predefined-type">String</span>;
      <span class="keyword">return</span> compress(content.toString());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Object</span> fromStorage(<span class="predefined-type">Object</span> content) {
      <span class="keyword">assert</span> content <span class="keyword">instanceof</span> <span class="type">byte</span><span class="type">[]</span>;
      <span class="keyword">return</span> decompress((<span class="type">byte</span><span class="type">[]</span>) content);
   }

   <span class="directive">private</span> <span class="type">byte</span><span class="type">[]</span> compress(<span class="predefined-type">String</span> str) {
      <span class="keyword">try</span> (<span class="predefined-type">ByteArrayOutputStream</span> baos = <span class="keyword">new</span> <span class="predefined-type">ByteArrayOutputStream</span>();
           <span class="predefined-type">GZIPOutputStream</span> gis = <span class="keyword">new</span> <span class="predefined-type">GZIPOutputStream</span>(baos)) {
         gis.write(str.getBytes(<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>));
         gis.close();
         <span class="keyword">return</span> baos.toByteArray();
      } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unabled to compress</span><span class="delimiter">&quot;</span></span>, e);
      }
   }

   <span class="directive">private</span> <span class="predefined-type">String</span> decompress(<span class="type">byte</span><span class="type">[]</span> compressed) {
      <span class="keyword">try</span> (<span class="predefined-type">GZIPInputStream</span> gis = <span class="keyword">new</span> <span class="predefined-type">GZIPInputStream</span>(<span class="keyword">new</span> <span class="predefined-type">ByteArrayInputStream</span>(compressed));
           <span class="predefined-type">BufferedReader</span> bf = <span class="keyword">new</span> <span class="predefined-type">BufferedReader</span>(<span class="keyword">new</span> <span class="predefined-type">InputStreamReader</span>(gis, <span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>))) {
         <span class="predefined-type">StringBuilder</span> result = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>();
         <span class="predefined-type">String</span> line;
         <span class="keyword">while</span> ((line = bf.readLine()) != <span class="predefined-constant">null</span>) {
            result.append(line);
         }
         <span class="keyword">return</span> result.toString();
      } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unable to decompress</span><span class="delimiter">&quot;</span></span>, e);
      }
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> MediaType getStorageFormat() {
      <span class="keyword">return</span> MediaType.parse(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/gzip</span><span class="delimiter">&quot;</span></span>);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> isStorageFormatFilterable() {
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">short</span> id() {
      <span class="keyword">return</span> <span class="integer">10000</span>;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It can be registered by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalComponentRegistry registry = cacheManager.getGlobalComponentRegistry();
EncoderRegistry encoderRegistry = registry.getComponent(EncoderRegistry.class);
encoderRegistry.registerEncoder(<span class="keyword">new</span> GzipEncoder());</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then be used to write and read data from a cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...

<span class="comment">// Decorate cache with the newly registered encoder, without encoding keys (IdentityEncoder)</span>
<span class="comment">// but compressing values</span>
AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; compressingCache = (AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;) cache.withEncoding(IdentityEncoder.class, GzipEncoder.class);

<span class="comment">// All values will be stored compressed...</span>
compressingCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">297931749</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">0412c789a37f5086f743255cfa693dd5</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// ... but API calls deals with String</span>
<span class="predefined-type">String</span> value = compressingCache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">297931749</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Bypassing the value encoder to obtain the value as it is stored</span>
<span class="predefined-type">Object</span> value = compressingCache.withEncoding(IdentityEncoder.class).get(<span class="string"><span class="delimiter">&quot;</span><span class="content">297931749</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// value is a byte[] which is the compressed value</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="encoding_media_type"><a class="anchor" href="#encoding_media_type"></a>3.8.5. MediaType</h4>
<div class="paragraph">
<p>A Cache can optionally be configured with a <code>org.infinispan.commons.dataconversion.MediaType</code> for keys and values. By describing the data format of the cache, Infinispan is able to convert data on the fly during cache operations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The MediaType configuration is more suitable when storing binary data. When using server mode, it&#8217;s common to have a MediaType configured and clients such as REST or Hot Rod reading and writing in different formats.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The data conversion between MediaType formats are handled by instances of <code>org.infinispan.commons.dataconversion.Transcoder</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Transcoder</span> {

   <span class="comment">/**
    * Transcodes content between two different {@link MediaType}.
    *
    * @param content         Content to transcode.
    * @param contentType     The {@link MediaType} of the content.
    * @param destinationType The target {@link MediaType} to convert.
    * @return the transcoded content.
    */</span>
   <span class="predefined-type">Object</span> transcode(<span class="predefined-type">Object</span> content, MediaType contentType, MediaType destinationType);

   <span class="comment">/**
    * @return all the {@link MediaType} handled by this Transcoder.
    */</span>
   <span class="predefined-type">Set</span>&lt;MediaType&gt; getSupportedMediaTypes();
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h5>
<div class="paragraph">
<p>Declarative:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;cache&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object; type=java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xml; charset=UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Programmatic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();

cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>);
cfg.encoding().value().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="mediatype_override"><a class="anchor" href="#mediatype_override"></a>Overriding the MediaType Programmatically</h5>
<div class="paragraph">
<p>It&#8217;s possible to decorate the Cache with a different MediaType, allowing cache operations to be executed sending and receiving different data formats.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">DefaultCacheManager cacheManager = <span class="keyword">new</span> DefaultCacheManager();

<span class="comment">// The cache will store POJO for keys and values</span>
ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();
cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span>);
cfg.encoding().value().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span>);

cacheManager.defineConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span>, cfg.build());

Cache&lt;<span class="predefined-type">Integer</span>, Person&gt; cache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span>);

cache.put(<span class="integer">1</span>, <span class="keyword">new</span> Person(<span class="string"><span class="delimiter">&quot;</span><span class="content">John</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>));

<span class="comment">// Wraps cache using 'application/x-java-object' for keys but JSON for values</span>
Cache&lt;<span class="predefined-type">Integer</span>, <span class="type">byte</span><span class="type">[]</span>&gt; jsonValuesCache = (Cache&lt;<span class="predefined-type">Integer</span>, <span class="type">byte</span><span class="type">[]</span>&gt;) cache.getAdvancedCache().withMediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);

<span class="type">byte</span><span class="type">[]</span> json = jsonValuesCache.get(<span class="integer">1</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Will return the value in JSON format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">_type</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.sample.Person</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">John</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Most Transcoders are installed when server mode is used; when using library mode, an extra dependency, <em>org.infinispan:infinispan-server-core</em> should be added to the project.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="transcoders_and_encoders"><a class="anchor" href="#transcoders_and_encoders"></a>Transcoders and Encoders</h5>
<div class="paragraph">
<p>Usually there will be none or only one data conversion involved in a cache operation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No conversion by default on caches using in embedded or server mode;</p>
</li>
<li>
<p><em>Encoder</em> based conversion for embedded caches without MediaType configured, but using OFF_HEAP or BINARY;</p>
</li>
<li>
<p><em>Transcoder</em> based conversion for caches used in server mode with multiple REST and Hot Rod clients sending
and receiving data in different formats. Those caches will have MediaType configured describing the storage.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>But it&#8217;s possible to have both encoders and transcoders being used simultaneously for advanced use cases.</p>
</div>
<div class="paragraph">
<p>Consider an example, a cache that stores marshalled objects (with jboss marshaller) content but for security reasons a transparent encryption layer should be added in order to avoid storing "plain" data to an external store.
Clients should be able to read and write data in multiple formats.</p>
</div>
<div class="paragraph">
<p>This can be achieved by configuring the cache with the the MediaType that describes the storage regardless of the encoding layer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();
cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-jboss-marshalling</span><span class="delimiter">&quot;</span></span>);
cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-jboss-marshalling</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The transparent encryption can be added by decorating the cache with a special <em>Encoder</em> that encrypts/decrypts with storing/retrieving, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Scrambler</span> <span class="directive">implements</span> <span class="predefined-type">Encoder</span> {

   <span class="predefined-type">Object</span> toStorage(<span class="predefined-type">Object</span> content) {
      <span class="comment">// Encrypt data</span>
   }

   <span class="predefined-type">Object</span> fromStorage(<span class="predefined-type">Object</span> content) {
      <span class="comment">// Decrypt data</span>
   }

   MediaType getStorageFormat() {
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">application/scrambled</span><span class="delimiter">&quot;</span></span>;
   }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make sure all data written to the cache will be stored encrypted, it&#8217;s necessary to decorate the cache with the Encoder above and perform all cache operations in this decorated cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache&lt;?,?&gt; secureStorageCache = cache.getAdvancedCache().withEncoding(Scrambler.class).put(k,v);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The capability of reading data in multiple formats can be added by decorating the cache with the desired MediaType:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Obtain a stream of values in XML format from the secure cache</span>
secureStorageCache.getAdvancedCache().withMediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xml</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xml</span><span class="delimiter">&quot;</span></span>).values().stream();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Internally, Infinispan will first apply the encoder <em>fromStorage</em> operation to obtain the entries, that will be in "application/x-jboss-marshalling" format and then apply a successive conversion to "application/xml" by using the adequate Transcoder.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="eviction_anchor"><a class="anchor" href="#eviction_anchor"></a>4. Eviction and Data Container</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan supports eviction of entries, such that you do not run out of memory.
Eviction is typically used in conjunction with a cache store, so that entries are
not permanently lost when evicted, since eviction only removes entries from
memory and not from cache stores or the rest of the cluster.</p>
</div>
<div class="paragraph">
<p>Infinispan supports storing data in a few different formats.  Data can be
stored as the object iself, binary as a byte[], and off-heap which stores the
byte[] in native memory.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Passivation is also a popular option when using eviction, so that only a
single copy of an entry is maintained - either in memory or in a cache store,
but not both. The main benefit of using passivation over a regular cache store
is that updates to entries which exist in memory are cheaper since the update
doesn&#8217;t need to be made to the cache store as well.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Eviction occurs on a <em>local</em> basis, and is not cluster-wide.  Each
node runs an eviction thread to analyse the contents of its in-memory container
and decide what to evict. Eviction does not take into account the amount of free
memory in the JVM as threshold to  starts evicting entries. You have to set <code>size</code>
attribute of the eviction element to be greater than zero in order for eviction
to be turned on. If size is too large you can run out of memory. The <code>size</code>
attribute will probably take some tuning in each use case.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="eviction_enabling"><a class="anchor" href="#eviction_enabling"></a>4.1. Enabling Eviction</h3>
<div class="paragraph">
<p>Eviction is configured by adding the
<a href="http://docs.jboss.org/infinispan/9.4/configdocs/infinispan-config-9.4.html"><code>&lt;memory /&gt;</code></a>
element to your <code>&lt;*-cache /&gt;</code> configuration sections or using
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/configuration/cache/MemoryConfigurationBuilder.html">MemoryConfigurationBuilder</a>
API programmatic approach.</p>
</div>
<div class="paragraph">
<p>All cache entry are evicted by piggybacking on user threads that are hitting the cache.</p>
</div>
<div class="sect3">
<h4 id="eviction_strategy"><a class="anchor" href="#eviction_strategy"></a>4.1.1. Eviction strategy</h4>
<div class="paragraph">
<p>Strategies control how the eviction is handled.</p>
</div>
<div class="paragraph">
<p>The possible choices are</p>
</div>
<div class="paragraph">
<div class="title"><code>NONE</code></div>
<p>Eviction is not enabled and it is assumed that the user will not invoke evict directly
on the cache. If passivation is enabled this will cause aa warning message to be
emitted. This is the default strategy.</p>
</div>
<div class="paragraph">
<div class="title"><code>MANUAL</code></div>
<p>This strategy is just like &lt;b&gt;NONE&lt;/b&gt; except that it assumes the user will be
invoking evict directly. This way if passivation is enabled no warning message
is logged.</p>
</div>
<div class="paragraph">
<div class="title"><code>REMOVE</code></div>
<p>This strategy will actually evict "old" entries to make room for incoming ones.</p>
</div>
<div class="paragraph">
<p>Eviction is handled by <a href="https://github.com/ben-manes/caffeine">Caffeine</a> utilizing
the TinyLFU algorithm with an additional admission window.  This was chosen as
provides high hit rate while also requiring low memory overhead.  This provides a
better hit ratio than LRU while also requiring less memory than LIRS.</p>
</div>
<div class="paragraph">
<div class="title"><code>EXCEPTION</code></div>
<p>This strategy actually prevents new entries from being created by throwing
a <code>ContainerFullException</code>. This strategy only works with transactional caches
that always run with 2 phase commit, that is no 1 phase commit or synchronization
optimizations allowed.</p>
</div>
</div>
<div class="sect3">
<h4 id="eviction_types"><a class="anchor" href="#eviction_types"></a>4.1.2. Eviction types</h4>
<div class="paragraph">
<p>Eviction type applies only when the size is set to something greater than 0.
The eviction type below determines when the container will decide to remove
entries.</p>
</div>
<div class="paragraph">
<div class="title"><code>COUNT</code></div>
<p>This type of eviction will remove entries based on how many there are in the
cache.  Once the count of entries has grown larger than the <code>size</code> then an
entry will be removed to make room.</p>
</div>
<div class="paragraph">
<div class="title"><code>MEMORY</code></div>
<p>This type of eviction will estimate how much each entry will take up in memory
and will remove an entry when the total size of all entries is larger than
the configured <code>size</code>.  This type does not work with <code>OBJECT</code> storage type
below.</p>
</div>
</div>
<div class="sect3">
<h4 id="eviction_storage_type"><a class="anchor" href="#eviction_storage_type"></a>4.1.3. Storage type</h4>
<div class="paragraph">
<p>Infinispan allows the user to configure in what form their data is stored.  Each
form supports the same features of Infinispan, however eviction can be limited
for some forms.  There are currently three storage formats that Infinispan
provides, they are:</p>
</div>
<div class="paragraph">
<div class="title"><code>OBJECT</code></div>
<p>Stores the keys and values as objects in the Java heap  Only <code>COUNT</code> eviction
type is supported.</p>
</div>
<div class="paragraph">
<div class="title"><code>BINARY</code></div>
<p>Stores the keys and values as a byte[] in the Java heap.  This will use the configured
marshaller for the cache if there is one.  Both <code>COUNT</code> and
<code>MEMORY</code> eviction types are supported.</p>
</div>
<div class="paragraph">
<div class="title"><code>OFF-HEAP</code></div>
<p>Stores the keys and values in native memory outside of the
Java heap as bytes.  The configured marshaller will be used if the cache has one.
Both <code>COUNT</code> and <code>MEMORY</code> eviction types are supported.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Both <code>BINARY</code> and <code>OFF-HEAP</code> violate equality and hashCode that they are
dictated by the resulting byte[] they generate instead of the object instance.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="eviction_defaults"><a class="anchor" href="#eviction_defaults"></a>4.1.4. More defaults</h4>
<div class="paragraph">
<p>By default when no <code>&lt;memory /&gt;</code> element is specified, no eviction takes place,
<code>OBJECT</code> storage type is used, and a strategy of <code>NONE</code> is assumed.</p>
</div>
<div class="paragraph">
<p>In case there is an memory element, this table describes the behaviour of eviction
based on information provided in the xml configuration ("-" in Supplied size or
Supplied strategy column means that the attribute wasn&#8217;t supplied)</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Supplied size</th>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top">Eviction behaviour</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no eviction as an object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;object strategy="MANUAL" /&gt; &lt;/memory&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no eviction as an object and won&#8217;t log warning if passivation is enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt; 0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;object size="100" /&gt; &lt;/memory&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eviction takes place and stored as objects</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt; 0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;binary size="100" eviction="MEMORY"/&gt; &lt;/memory&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eviction takes place and stored as a binary removing to make sure memory doens&#8217;t go higher than 100</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt; 0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;off-heap size="100" /&gt; &lt;/memory&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eviction takes place and stored in off-heap</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt; 0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;off-heap size="100" strategy="EXCEPTION" /&gt; &lt;/memory&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">entries are stored in off-heap and if 100 entries are in container exceptions will be thrown for additional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;object size="0" /&gt; &lt;/memory&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no eviction</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt; 0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;memory&gt; &lt;object size="-1" /&gt; &lt;/memory&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no eviction</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="expiration_anchor"><a class="anchor" href="#expiration_anchor"></a>4.2. Expiration</h3>
<div class="paragraph">
<p>Similar to, but unlike eviction, is expiration. Expiration allows you to attach
lifespan and/or maximum idle times to entries. Entries that exceed these times
are treated as invalid and are removed. When removed expired entries are not
passivated like evicted entries (if passivation is turned on).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Unlike eviction, expired entries are removed globally - from memory, cache
stores, and cluster-wide.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default entries created are immortal and do not have a lifespan or maximum
idle time.  Using the cache API, mortal entries can be created with lifespans
and/or maximum idle times.  Further, default lifespans and/or maximum idle
times can be configured by adding the
<a href="http://docs.jboss.org/infinispan/9.4/configdocs/infinispan-config-9.4.html">&lt;expiration /&gt;</a>
element to your <code>&lt;*-cache /&gt;</code>  configuration sections.</p>
</div>
<div class="paragraph">
<p>When an entry expires it resides in the data container or cache store until it
is accessed again by a user request. An expiration reaper is also available to
check for expired entries and remove them at a configurable interval of
milliseconds.</p>
</div>
<div class="paragraph">
<p>You can enable the expiration reaper declaratively with the <code>reaper-interval</code>
attribute or programmatically with the <code>enableReaper</code> method in the
<code>ExpirationConfigurationBuilder</code> class.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>The expiration reaper cannot be disabled when a cache store is present.</p>
</li>
<li>
<p>When using a maximum idle time in a clustered cache, you should always enable
the expiration reaper. For more information, see
<a href="#expiration_maxidle_clustered">Clustered Max Idle</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="expiration_settings"><a class="anchor" href="#expiration_settings"></a>4.2.1. Difference between Eviction and Expiration</h4>
<div class="paragraph">
<p>Both Eviction and Expiration are means of cleaning the cache of unused entries
and thus guarding the heap against <code>OutOfMemory</code> exceptions, so now a brief
explanation of the difference.</p>
</div>
<div class="paragraph">
<p>With <em>eviction</em> you set <em>maximal number of entries</em> you want to keep in the
cache and if this limit is exceeded, some candidates are found to be removed
according to a choosen <em>eviction strategy</em> (LRU, LIRS, etc&#8230;&#8203;). Eviction can be
setup to work with passivation, which is eviction to a cache store.</p>
</div>
<div class="paragraph">
<p>With <em>expiration</em> you set <em>time criteria</em> for entries to specify <em>how long you
want to keep them</em> in the cache.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>lifespan</em></dt>
<dd>
<p>Specifies how long entries can remain in the cache before they expire. The
default value is <code>-1</code>, which is unlimited time.</p>
</dd>
<dt class="hdlist1"><em>maximum idle time</em></dt>
<dd>
<p>Specifies how long entries can remain idle before they expire. An entry in the
cache is idle when no operation is performed with the key. The default value is
<code>-1</code>, which is unlimited time.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="expiration_details"><a class="anchor" href="#expiration_details"></a>4.3. Expiration details</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>Expiration</em> is a top-level construct, represented in the configuration as
well as in the cache API.</p>
</li>
<li>
<p>While eviction is <em>local to each cache instance</em> , expiration is
<em>cluster-wide</em> .  Expiration <code>lifespan</code> and <code>maxIdle</code> values are replicated
along with the cache entry.</p>
</li>
<li>
<p>Maximum idle times for cache entries require additional network messages in
clustered environments. For this reason, setting <code>maxIdle</code> in clustered caches
can result in slower operation times.</p>
</li>
<li>
<p>Expiration lifespan and <code>maxIdle</code> are also persisted in CacheStores, so this information survives eviction/passivation.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="expiration_maxidle"><a class="anchor" href="#expiration_maxidle"></a>4.3.1. Maximum Idle Expiration</h4>
<div class="paragraph">
<p>Maximum idle expiration has different behavior in local and clustered cache environments.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Maximum idle expiration, <code>max-idle</code>, does not currently work with entries stored in off-heap memory.
Likewise, <code>max-idle</code> does not work if caches use cache stores as a persistence layer.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="expiration_maxidle_local"><a class="anchor" href="#expiration_maxidle_local"></a>Local Max Idle</h5>
<div class="paragraph">
<p>In local cache mode, Infinispan expires entries with the <code>maxIdle</code> configuration when:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>accessed directly (<code>Cache.get()</code>).</p>
</li>
<li>
<p>iterated upon (<code>Cache.size()</code>).</p>
</li>
<li>
<p>the expiration reaper thread runs.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="expiration_maxidle_clustered"><a class="anchor" href="#expiration_maxidle_clustered"></a>Clustered Max Idle</h5>
<div class="paragraph">
<p>In clustered cache modes, when clients read entries that have <code>max-idle</code>
expiration values, Infinispan sends touch commands to all owners. This ensures
that the entries have the same relative access time across the cluster.</p>
</div>
<div class="paragraph">
<p>When nodes detect that an entry reaches the maximum idle time, Infinispan
removes it from the cache and does not return the entry to the client that
requested it.</p>
</div>
<div class="paragraph">
<p>Before using <code>max-idle</code> with clustered cache modes, you should review the following points:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Cache.get()</code> does not return until the touch commands complete. This synchronous behavior increases latency of client requests.</p>
</li>
<li>
<p>Clustered <code>max-idle</code> also updates the "recently accessed" metadata for cache entries on all owners, which Infinispan uses for eviction.</p>
</li>
<li>
<p>With scattered cache mode, Infinispan sends touch commands to all nodes, not
just primary and backup owners.</p>
</li>
<li>
<p>Iteration across a clustered cache returns entries that might be expired
with the maximum idle time. This behavior ensures performance because no
remote invocations are performed during the iteration. However this does not
refresh any expired entries, which are removed by the expiration reaper or
when accessed directly (<code>Cache.get()</code>).</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Clustered caches should always use the expiration reaper with the <code>maxIdle</code>
configuration.</p>
</li>
<li>
<p>When using <code>maxIdle</code> expiration with exception-based eviction, entries that
are expired but not removed from the cache count towards the size of the data
container.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="eviction_expiration_config"><a class="anchor" href="#eviction_expiration_config"></a>4.3.2. Configuration</h4>
<div class="paragraph">
<p>Eviction and Expiration may be configured using the programmatic or
declarative XML configuration. This configuration is on a per-cache basis.
Valid eviction/expiration-related configuration elements are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Eviction --&gt;</span>
<span class="tag">&lt;memory&gt;</span>
   <span class="tag">&lt;object</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/memory&gt;</span>
<span class="comment">&lt;!-- Expiration --&gt;</span>
<span class="tag">&lt;expiration</span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Programmatically, the same would be defined using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
               .memory().size(<span class="integer">2000</span>)
               .expiration().wakeUpInterval(<span class="integer">5000l</span>).lifespan(<span class="integer">1000l</span>).maxIdle(<span class="integer">500l</span>)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .build();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="eviction_expiration_config_mem"><a class="anchor" href="#eviction_expiration_config_mem"></a>4.3.3. Memory Based Eviction Configuration</h4>
<div class="paragraph">
<p>Memory based eviction may require some additional configuration options if you
are using your own custom types (as Infinispan is normally used).  In this case
Infinispan cannot estimate the memory usage of your classes and as such you are
required to use <code>storeAsBinary</code> when memory based eviction is used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Enable memory based eviction with 1 GB/&gt;
&lt;memory&gt;
   &lt;binary size=&quot;1000000000&quot; eviction=&quot;MEMORY&quot;/&gt;
&lt;/memory&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
               .memory()
               .storageType(StorageType.BINARY)
               .evictionType(EvictionType.MEMORY)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .size(<span class="integer">1</span>_000_000_000)
               .build();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="eviction_expiration_config_default"><a class="anchor" href="#eviction_expiration_config_default"></a>4.3.4. Default values</h4>
<div class="paragraph">
<p>Eviction is disabled by default. Default values are used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>size: -1 is used if not specified, which means unlimited entries.</p>
</li>
<li>
<p>0 means no entries, and the eviction thread will strive to keep the cache empty.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Expiration lifespan and maxIdle both default to -1, which means that entries will be created immortal by default. This can be overridden per entry with the API.</p>
</div>
</div>
<div class="sect3">
<h4 id="expiration_using"><a class="anchor" href="#expiration_using"></a>4.3.5. Using expiration</h4>
<div class="paragraph">
<p>Expiration allows you to set either a lifespan or a maximum idle time on each key/value pair stored in the cache.  This can either be set cache-wide using the configuration, as described above, or it can be defined per-key/value pair using the Cache interface.  Any values defined per key/value pair overrides the cache-wide default for the specific entry in question.</p>
</div>
<div class="paragraph">
<p>For example, assume the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;expiration</span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// this entry will expire in 1000 millis</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pinot noir</span><span class="delimiter">&quot;</span></span>, pinotNoirPrice);

<span class="comment">// this entry will expire in 2000 millis</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">chardonnay</span><span class="delimiter">&quot;</span></span>, chardonnayPrice, <span class="integer">2</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);

<span class="comment">// this entry will expire 1000 millis after it is last accessed</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pinot grigio</span><span class="delimiter">&quot;</span></span>, pinotGrigioPrice, -<span class="integer">1</span>,
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">TimeUnit</span>.SECONDS, <span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);

<span class="comment">// this entry will expire 1000 millis after it is last accessed, or</span>
<span class="comment">// in 5000 millis, which ever triggers first</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">riesling</span><span class="delimiter">&quot;</span></span>, rieslingPrice, <span class="integer">5</span>,
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">TimeUnit</span>.SECONDS, <span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="expiration_designs"><a class="anchor" href="#expiration_designs"></a>4.4. Expiration designs</h3>
<div class="paragraph">
<p>Central to expiration is an ExpirationManager.</p>
</div>
<div class="paragraph">
<p>The purpose of the ExpirationManager is to drive the expiration thread which
periodically purges items from the DataContainer.  If the expiration thread is
disabled (wakeupInterval set to -1) expiration can be kicked off manually
using ExprationManager.processExpiration(), for example from another
maintenance thread that may run periodically in your application.</p>
</div>
<div class="paragraph">
<p>The expiration manager processes expirations in the following manner:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Causes the data container to purge expired entries</p>
</li>
<li>
<p>Causes cache stores (if any) to purge expired entries</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="persistence"><a class="anchor" href="#persistence"></a>5. Persistence</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Persistence allows configuring external (persistent) storage engines complementary to the default in memory storage offered by Infinispan.
An external persistent storage might be useful for several reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Increased Durability. Memory is volatile, so a cache store could increase the life-span of the information store in the cache.</p>
</li>
<li>
<p>Write-through. Interpose Infinispan as a caching layer between an application and a (custom) external storage engine.</p>
</li>
<li>
<p>Overflow Data. By using eviction and passivation, one can store only the "hot" data in memory and overflow the data that is less frequently used to disk.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The integration with the persistent store is done through the following SPI: CacheLoader, CacheWriter, AdvancedCacheLoader and AdvancedCacheWriter (discussed in the following sections).</p>
</div>
<div class="paragraph">
<p>These SPIs allow for the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Alignment with <a href="http://jcp.org/en/jsr/detail?id=107">JSR-107</a>. The <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/spi/CacheWriter.html">CacheWriter</a> and <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/spi/CacheLoader.html">CacheLoader</a> interface are similar to the the loader and writer in JSR 107. This should considerably help writing portable stores across JCache compliant vendors.</p>
</li>
<li>
<p>Simplified Transaction Integration. All necessary locking is handled by Infinispan automatically and implementations dont have to be concerned with coordinating concurrent access to the store. Even though concurrent writes on the same key are not going to happen (depending locking mode in use), implementors should expect operations on the store to happen from multiple/different threads and code the implementation accordingly.</p>
</li>
<li>
<p>Parallel Iteration. It is now possible to iterate over entries in the store with multiple threads in parallel.</p>
</li>
<li>
<p>Reduced Serialization. This translates in less CPU usage. The new API exposes the stored entries in serialized format. If an entry is fetched from persistent storage for the sole purpose of being sent remotely, we no longer need to deserialize it (when reading from the store) and serialize it back (when writing to the wire). Now we can write to the wire the serialized format as read from the storage directly.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="configuration_2"><a class="anchor" href="#configuration_2"></a>5.1. Configuration</h3>
<div class="paragraph">
<p>Stores (readers and/or writers) can be configured in a chain. Cache read operation looks at all of the specified <code>CacheLoader</code> s, in the order they are configured, until it finds a valid and non-null element of data. When performing writes all cache <code>CacheWriter</code> s are written to, except if the <code>ignoreModifications</code> element has been set to true for a specific cache writer.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Implementing both a CacheWriter and CacheLoader</div>
<div class="paragraph">
<p>Store providers should implement both the <code>CacheWriter</code> and the <code>CacheLoader</code> interfaces. Stores that do this are considered both for reading and writing (assuming <code>read-only=false</code>) data.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">This is the configuration of a custom(not shipped with infinispan) store:
   <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCustomStore</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;store</span>
            <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.acme.CustomStore</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">singleton</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">segmented</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

            <span class="tag">&lt;write-behind</span> <span class="attribute-name">modification-queue-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">thread-pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">23</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${system.property}<span class="tag">&lt;/property&gt;</span>
         <span class="tag">&lt;/store&gt;</span>
      <span class="tag">&lt;/persistence&gt;</span>
   <span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Parameters that you can use to configure persistence are as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>connection-attempts</code></dt>
<dd>
<p>Sets the maximum number of attempts to start each configured
CacheWriter/CacheLoader. If the attempts to start are not successful, an
exception is thrown and the cache does not start.</p>
</dd>
<dt class="hdlist1"><code>connection-interval</code></dt>
<dd>
<p>Specifies the time, in milliseconds, to wait between connection attempts on
startup. A negative or zero value means no wait between connection attempts.</p>
</dd>
<dt class="hdlist1"><code>availability-interval</code></dt>
<dd>
<p>Specifies the time, in milliseconds, between availability checks to determine
if the PersistenceManager is available. In other words, this interval sets how
often stores/loaders are polled via their
<code>org.infinispan.persistence.spi.CacheWriter#isAvailable</code> or
<code>org.infinispan.persistence.spi.CacheLoader#isAvailable</code> implementation. If a
single store/loader is not available, an exception is thrown during cache
operations.</p>
</dd>
<dt class="hdlist1"><code>passivation</code></dt>
<dd>
<p>Enables passivation. The default value is <code>false</code> (boolean).</p>
<div class="paragraph">
<p>This property has a significant impact on Infinispan interactions with the loaders. See <a href="#cache_passivation">Cache Passivation</a> for more information.</p>
</div>
</dd>
<dt class="hdlist1"><code>class</code></dt>
<dd>
<p>Defines the class of the store and must implement <code>CacheLoader</code>, <code>CacheWriter</code>,
or both.</p>
</dd>
<dt class="hdlist1"><code>fetch-state</code></dt>
<dd>
<p>Fetches the persistent state of a cache when joining a cluster. The default
value is <code>false</code> (boolean).</p>
<div class="paragraph">
<p>The purpose of this property is to retrieve the persistent state of a cache and
apply it to the local cache store of a node when it joins a cluster. Fetching
the persistent state does not apply if a cache store is shared because it
accesses the same data as the other stores.</p>
</div>
<div class="paragraph">
<p>This property can be <code>true</code> for one configured cache loader only. If more than
one cache loader fetches the persistent state, a configuration exception is
thrown when the cache service starts.</p>
</div>
</dd>
<dt class="hdlist1"><code>preload</code></dt>
<dd>
<p>Pre-loads data into memory from the cache loader when the cache starts. The
default value is <code>false</code> (boolean).</p>
<div class="paragraph">
<p>This property is useful when data in the cache loader is required immediately
after startup to prevent delays with cache operations when the data is loaded
lazily. This property can provide a "warm cache" on startup but it impacts
performance because it affects start time.</p>
</div>
<div class="paragraph">
<p>Pre-loading data is done locally, so any data loaded is stored locally in the node only. The pre-loaded data is not replicated or distributed. Likewise, Infinispan pre-loads data only up to the maximum configured number of entries in <a href="#eviction_anchor">eviction</a>.</p>
</div>
</dd>
<dt class="hdlist1"><code>shared</code></dt>
<dd>
<p>Determines if the cache loader is shared between cache instances. The default value is <code>false</code> (boolean).</p>
<div class="paragraph">
<p>This property prevents duplicate writes of data to the cache loader by
different cache instances. An example is where all cache instances in a cluster
use the same JDBC settings for the same remote, shared database.</p>
</div>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>segmented</code></dt>
<dd>
<p>Configures a cache store to segment data. The default value is <code>false</code>
(boolean).</p>
<div class="paragraph">
<p>If <code>true</code> the cache store stores data in buckets. The <code>hash.numSegments</code> property configures how many buckets there are for storing data.</p>
</div>
<div class="paragraph">
<p>Depending on the cache store implementation, segmenting data can cause slower
write operations. However, performance improves for other cache operations. See
<a href="#segmented_stores">Segmented Stores</a> for more information.</p>
</div>
</dd>
<dt class="hdlist1"><code>read-only</code></dt>
<dd>
<p>Prevents new data from being persisted to the cache store. The default value is
<code>false</code> (boolean).</p>
</dd>
<dt class="hdlist1"><code>purge</code></dt>
<dd>
<p>Empties the specified cache loader at startup. The default value is <code>false</code>
(boolean). This property takes effect only if the <code>read-only</code> property is set
to <code>false</code>.</p>
</dd>
<dt class="hdlist1"><code>max-batch-size</code></dt>
<dd>
<p>Sets the maximum size of a batch to insert of delete from the cache store. The
default value is #{AbstractStore-maxBatchSize}.</p>
<div class="paragraph">
<p>If the value is less than <code>1</code>, no upper limit applies to the number of
operations in a batch.</p>
</div>
</dd>
<dt class="hdlist1"><code>write-behind</code></dt>
<dd>
<p>Asynchronously persists data to the cache store. The default value is <code>false</code>
(boolean). See <a href="#write_behind_asynchronous">Asynchronous Write-Behind</a> for
more information.</p>
</dd>
<dt class="hdlist1"><code>singleton</code></dt>
<dd>
<p>Enables one node in the cluster, the coordinator, to store modifications. The
default value is <code>false</code> (boolean).</p>
<div class="paragraph">
<p>Whenever data enters a node, it is replicated or distributed to keep the
in-memory state of the caches synchronized. The coordinator is responsible for
pushing that state to disk.</p>
</div>
<div class="paragraph">
<p>If <code>true</code> you must set this property on all nodes in the cluster. Only the
coordinator of the cluster persists data. However, all nodes must have this
property enabled to prevent other nodes from persisting data.</p>
</div>
<div class="paragraph">
<p>You cannot enable the <code>singleton</code> property if the cache store is shared.</p>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can define additional attributes in the <code>properties</code> section to configure
specific aspects of each cache loader, such as the <code>myProp</code> attribute in the previous example.</p>
</div>
<div class="paragraph">
<p>Other cache loaders with more complex configurations also include additional
properties. See the following JDBC cache store configuration for examples.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The preceding configuration applies a generic cache store implementation.
However, the default Infinispan store implementation has a more complex
configuration schema, in which the <code>properties</code> section is replaced with XML
attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="comment">&lt;!-- note that class is missing and is induced by the fileStore element name --&gt;</span>
<span class="tag">&lt;file-store</span>
           <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;write-behind</span> <span class="attribute-name">thread-pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;/file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same configuration can be achieved programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">   ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
   builder.persistence()
         .passivation(<span class="predefined-constant">false</span>)
         .addSingleFileStore()
            .preload(<span class="predefined-constant">true</span>)
            .shared(<span class="predefined-constant">false</span>)
            .fetchPersistentState(<span class="predefined-constant">true</span>)
            .ignoreModifications(<span class="predefined-constant">false</span>)
            .purgeOnStartup(<span class="predefined-constant">false</span>)
            .location(<span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">java.io.tmpdir</span><span class="delimiter">&quot;</span></span>))
            .async()
               .enabled(<span class="predefined-constant">true</span>)
               .threadPoolSize(<span class="integer">5</span>)
            .singleton()
               .enabled(<span class="predefined-constant">true</span>)
               .pushStateWhenCoordinator(<span class="predefined-constant">true</span>)
               .pushStateTimeout(<span class="integer">20000</span>);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cache_passivation"><a class="anchor" href="#cache_passivation"></a>5.2. Cache Passivation</h3>
<div class="paragraph">
<p>A CacheWriter can be used to enforce entry passivation and activation on eviction in a cache. Cache passivation is the
process of removing an object from in-memory cache and writing it to a secondary data store (e.g., file system, database)
on eviction. Cache activation is the process of restoring an object from the data store into the in-memory cache when
it&#8217;s needed to be used. In order to fully support passivation, a store needs to be both a CacheWriter and a CacheLoader.
In both cases, the configured cache store is used to read from the loader and write to the data writer.</p>
</div>
<div class="paragraph">
<p>When an eviction policy in effect evicts an entry from the cache, if passivation is enabled, a notification that the
entry is being passivated will be emitted to the cache listeners and the entry will be stored. When a user attempts to
retrieve a entry that was evicted earlier, the entry is (lazily) loaded from the cache loader into memory. When the
entry has been loaded a notification is emitted to the cache listeners that the entry has been activated. In order to
enable passivation just set passivation to true (false by default). When passivation is used, only the first cache loader
configured is used and all others are ignored.</p>
</div>
<div class="sect3">
<h4 id="limitations"><a class="anchor" href="#limitations"></a>5.2.1. Limitations</h4>
<div class="paragraph">
<p>Due to the unique nature of passivation, it is not supported with some other store configurations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Transactional store - Passivation writes/removes entries from the store
outside the scope of the actual Infinispan commit boundaries.</p>
</li>
<li>
<p>Shared store - Shared store requires entries always being in the store for
other owners. Thus passivation makes no sense as we can&#8217;t remove the entry from
the store.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="cache_loader_behavior_with_passivation_disabled_vs_enabled"><a class="anchor" href="#cache_loader_behavior_with_passivation_disabled_vs_enabled"></a>5.2.2. Cache Loader Behavior with Passivation Disabled vs Enabled</h4>
<div class="paragraph">
<p>When passivation is disabled, whenever an element is modified, added or removed, then that modification is persisted in
the backend store via the cache loader. There is no direct relationship between eviction and cache loading.
If you don&#8217;t use eviction, what&#8217;s in the persistent store is basically a copy of what&#8217;s in memory. If you do use eviction,
what&#8217;s in the persistent store is basically a superset of what&#8217;s in memory (i.e. it includes entries that have been
evicted from memory). When passivation is enabled, and with an unshared store, there is a direct relationship between
eviction and the cache loader.
Writes to the persistent store via the cache loader only occur as part of the eviction process. Data is deleted from the
persistent store when the application reads it back into memory. In this case, what&#8217;s in memory and what&#8217;s in the
persistent store are two subsets of the total information set, with no intersection between the subsets.
With a shared store, entries which have been passivated in the past will continue to exist in the store, although they
may have a stale value if this has been overwritten in memory.</p>
</div>
<div class="paragraph">
<p>The following is a simple example, showing what state is in RAM and in the persistent store after each step of a 6 step process:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operation</th>
<th class="tableblock halign-left valign-top">Passivation Off</th>
<th class="tableblock halign-left valign-top">Passivation On, Shared Off</th>
<th class="tableblock halign-left valign-top">Passivation On, Shared On</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Insert keyOne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br>
<strong>Disk:</strong> keyOne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br>
<strong>Disk:</strong> (none)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br>
<strong>Disk:</strong> (none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Insert keyTwo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne, keyTwo<br>
<strong>Disk:</strong> keyOne, keyTwo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne, keyTwo<br>
<strong>Disk:</strong> (none)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne, keyTwo<br>
<strong>Disk:</strong> (none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eviction thread runs, evicts keyOne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyTwo<br>
<strong>Disk:</strong> keyOne, keyTwo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyTwo<br>
<strong>Disk:</strong> keyOne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyTwo<br>
<strong>Disk:</strong> keyOne</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read keyOne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne, keyTwo<br>
<strong>Disk:</strong> keyOne, keyTwo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne, keyTwo<br>
<strong>Disk:</strong> (none)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne, keyTwo<br>
<strong>Disk:</strong> keyOne</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eviction thread runs, evicts keyTwo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br>
<strong>Disk:</strong> keyOne, keyTwo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br>
<strong>Disk:</strong> keyTwo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br>
<strong>Disk:</strong> keyOne, keyTwo</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove keyTwo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br>
<strong>Disk:</strong> keyOne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br>
<strong>Disk:</strong> (none)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> keyOne<br>
<strong>Disk:</strong> keyOne</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="cache_loaders_and_transactional_caches"><a class="anchor" href="#cache_loaders_and_transactional_caches"></a>5.3. Cache Loaders and transactional caches</h3>
<div class="paragraph">
<p>When a cache is transactional and a cache loader is present, the cache loader won&#8217;t be enlisted in the transaction in which the cache is part.
That means that it is possible to have inconsistencies at cache loader level: the transaction to succeed applying the in-memory state but (partially) fail applying the changes to the store.
Manual recovery would not work with caches stores.</p>
</div>
</div>
<div class="sect2">
<h3 id="write_through_and_write_behind_caching"><a class="anchor" href="#write_through_and_write_behind_caching"></a>5.4. Write-Through And Write-Behind Caching</h3>
<div class="paragraph">
<p>Infinispan can optionally be configured with one or several cache stores allowing it to store data in a persistent location such as shared JDBC database, a local filesystem, etc. Infinispan can handle updates to the cache store in two different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Write-Through (Synchronous)</p>
</li>
<li>
<p>Write-Behind (Asynchronous)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="write_through_synchronous"><a class="anchor" href="#write_through_synchronous"></a>5.4.1. Write-Through (Synchronous)</h4>
<div class="paragraph">
<p>In this mode, which is supported in version 4.0, when clients update a cache entry, i.e. via a Cache.put() invocation, the call will not return until Infinispan has gone to the underlying cache store and has updated it. Normally, this means that updates to the cache store are done within the boundaries of the client thread.</p>
</div>
<div class="paragraph">
<p>The main advantage of this mode is that the cache store is updated at the same time as the cache, hence the cache store is consistent with the cache contents. On the other hand, using this mode reduces performance because the latency of having to access and update the cache store directly impacts the duration of the cache operation.</p>
</div>
<div class="paragraph">
<p>Configuring a write-through or synchronous cache store does not require any particular configuration option. By default, unless marked explicitly as write-behind or asynchronous, all cache stores are write-through or synchronous. Please find below a sample configuration file of a write-through unshared local file cache store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;file-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="write_behind_asynchronous"><a class="anchor" href="#write_behind_asynchronous"></a>5.4.2. Write-Behind (Asynchronous)</h4>
<div class="paragraph">
<p>In this mode, updates to the cache are asynchronously written to the cache
store. Infinispan puts pending changes into a modification queue so that it can quickly store changes.</p>
</div>
<div class="paragraph">
<p>The configured number of threads consume the queue and apply the modifications
to the underlying cache store. If the configured number of threads cannot consume the modifications fast enough, or if the underlying store becomes unavailable, the modification queue becomes full. In this event, the cache store becomes write-through until the queue can accept new entries.</p>
</div>
<div class="paragraph">
<p>This mode provides an advantage in that cache operations are not affected by
updates to the underlying store. However, because updates happen
asynchronously, there is a period of time during which data in the cache store
is inconsistent with data in the cache.</p>
</div>
<div class="paragraph">
<p>The write-behind strategy is suitable for cache stores with low latency and
small operational cost; for example, an unshared file-based cache store that is
local to the cache itself. In this case, the time during which data is
inconsistent between the cache store and the cache is reduced to the lowest
possible period.</p>
</div>
<div class="paragraph">
<p>The following is an example configuration for the write-behind strategy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;file-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="comment">&lt;!-- start write-behind configuration --&gt;</span>
   <span class="tag">&lt;write-behind</span> <span class="attribute-name">modification-queue-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">thread-pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">23</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="comment">&lt;!-- end write-behind configuration --&gt;</span>
   <span class="tag">&lt;/file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="segmented_stores"><a class="anchor" href="#segmented_stores"></a>5.4.3. Segmented Stores</h4>
<div class="paragraph">
<p>You can configure stores so that data resides in segments to which keys map.
See <a href="#key_ownership">Key Ownership</a> for more information about segments and
ownership.</p>
</div>
<div class="paragraph">
<p>Segmented stores increase read performance for bulk operations; for example,
streaming over data (<code>Cache.size</code>, <code>Cache.entrySet.stream</code>), pre-loading the
cache, and doing state transfer operations.</p>
</div>
<div class="paragraph">
<p>However, segmented stores can also result in loss of performance for write
operations. This performance loss applies particularly to batch write
operations that can take place with transactions or write-behind stores. For
this reason, you should evaluate the overhead for write operations before you
enable segmented stores. The performance gain for bulk read operations might
not be acceptable if there is a significant performance loss for write
operations.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Loss of data can occur if the number of segments in a cache store are not
changed gracefully. For this reason, if you change the <code>numSegments</code> setting in the store configuration, you must migrate the existing store to use the new configuration.</p>
</div>
<div class="paragraph">
<p>The recommended method to migrate the cache store configuration is to perform a
rolling upgrade. The store migrator supports migrating a non-segmented cache
store to a segmented cache store only. The store migrator does not currently
support migrating from a segmented cache store.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Not all cache stores support segmentation. See the appropriate section for each
store to determine if it supports segmentation.</p>
</div>
<div class="paragraph">
<p>If you plan to convert or write a new store to support segmentation, see the
following SPI section that provides more details.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="filesystem_based_cache_stores"><a class="anchor" href="#filesystem_based_cache_stores"></a>5.5. Filesystem based cache stores</h3>
<div class="paragraph">
<p>A filesystem-based cache store is typically used when you want to have a
cache with a cache store available locally which stores data that has
overflowed from memory, having exceeded size and/or time restrictions.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Usage of filesystem-based cache stores on shared filesystems like NFS,
Windows shares, etc. should be avoided as these do not implement proper
file locking and can cause data corruption. File systems are inherently
not transactional, so when attempting to use your cache in a transactional
context, failures when writing to the file (which happens during the commit
phase) cannot be recovered.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sfs_cache_store"><a class="anchor" href="#sfs_cache_store"></a>5.5.1. Single File Store</h4>
<div class="paragraph">
<p>The single file cache store keeps all data in a single file. The way it
looks up data is by keeping an in-memory index of keys and the positions of
their values in this file. This results in greater performance compared to old
file cache store. There is one caveat though. Since the single file based
cache store keeps keys in memory, it can lead to increased memory consumption,
and hence it&#8217;s not recommended for caches with big keys.</p>
</div>
<div class="paragraph">
<p>In certain use cases, this cache store suffers from fragmentation: if you
store larger and larger values, the space is not reused and instead the entry
is appended at the end of the file. The space (now empty) is reused only if you
write another entry that can fit there. Also, when you remove all entries from
the cache, the file won&#8217;t shrink, and neither will be de-fragmented.</p>
</div>
<div class="paragraph">
<p>These are the available configuration options for the single file cache store:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>path</code> is the file-system location where Infinispan stores data.</p>
<div class="paragraph">
<p>For embedded deployments, Infinispan stores data to the current working
directory. To store data in a different location, specify the absolute path to
that directory as the value.</p>
</div>
<div class="paragraph">
<p>For server deployments, Infinispan stores data in
<code>$ISPN_HOME/data</code>.
You should not change the default location for Infinispan server. In other
words, do not set a value for <code>path</code> with server deployments.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>you should create a path declaration and
use the <code>relative-to</code> attribute for the file store location. If you set
<code>relative-to</code> to a directory location or environment variable, Infinispan
server startup fails.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>max-entries</code> specifies the maximum number of entries to keep in this file
store. As mentioned before, in order to speed up lookups, the single file
cache store keeps an index of keys and their corresponding position in the
file. To avoid this index resulting in memory consumption problems, this
cache store can bounded by a maximum number of entries that it stores. If
this limit is exceeded, entries are removed permanently using the LRU
algorithm both from  the in-memory index and the underlying file based
cache store. So, setting a maximum limit only makes sense when Infinispan is
used as a cache, whose contents can be recomputed or they can be retrieved
from the authoritative data store. If this maximum limit is set when the
Infinispan is used as an authoritative data store, it could lead to data
loss, and hence it&#8217;s not recommended for this use case. The default value is
<code>-1</code> which means that the file store size is unlimited.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="segmentation_support"><a class="anchor" href="#segmentation_support"></a>Segmentation support</h5>
<div class="paragraph">
<p>The single file cache store supports segmentation and creates a separate
instance per segment. Segmentation results in multiple directories under the
configured directory, where each directory is a number that represents the
segment to which the data maps.</p>
</div>
</div>
<div class="sect4">
<h5 id="declarative_configuration"><a class="anchor" href="#declarative_configuration"></a>Declarative Configuration</h5>
<div class="paragraph">
<p>The following examples show declarative configuration for a single file cache
store.</p>
</div>
<div class="listingblock">
<div class="title">Library Mode</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
 <span class="tag">&lt;file-store</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/myDataStore</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server Mode</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
 <span class="tag">&lt;file-store</span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="programmatic_configuration"><a class="anchor" href="#programmatic_configuration"></a>Programmatic Configuration</h5>
<div class="paragraph">
<p>The following example shows programmatic configuration for a single file cache store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addSingleFileStore()
    .location(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/myDataStore</span><span class="delimiter">&quot;</span></span>)
    .maxEntries(<span class="integer">5000</span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sifs_cache_store"><a class="anchor" href="#sifs_cache_store"></a>5.5.2. Soft-Index File Store</h4>
<div class="paragraph">
<p>The Soft-Index File Store is an experimental local file-based.
It is a pure Java implementation that tries to get
around Single File Store&#8217;s drawbacks by implementing a variant of B+ tree that
is cached in-memory using Java&#8217;s soft references - here&#8217;s where the name
Soft-Index File Store comes from. This B+ tree (called Index) is offloaded on
filesystem to single file that does not need to be persisted - it is purged and
rebuilt when the cache store restarts, its purpose is only offloading.</p>
</div>
<div class="paragraph">
<p>The data that should be persisted are stored in a set of files that are written
in append-only way - that means that if you store this on conventional magnetic
disk, it does not have to seek when writing a burst of entries. It is not
stored in single file but set of files. When the usage of any of these files
drops below 50% (the entries from the file are overwritten to another file),
the file starts to be collected, moving the live entries into different file
and in the end removing that file from disk.</p>
</div>
<div class="paragraph">
<p>Most of the structures in Soft Index File Store are bounded, therefore you don&#8217;t
have to be afraid of OOMEs. For example, you can configure the limits for
concurrently open files as well.</p>
</div>
<div class="sect4">
<h5 id="segmentation_support_2"><a class="anchor" href="#segmentation_support_2"></a>Segmentation support</h5>
<div class="paragraph">
<p>The Soft-Index file store supports segmentation and creates a separate
instance per segment. Segmentation results in multiple directories under the configured directory, where each directory is a number that represents the segment to which the data maps.</p>
</div>
</div>
<div class="sect4">
<h5 id="configuration_3"><a class="anchor" href="#configuration_3"></a>Configuration</h5>
<div class="paragraph">
<p>Here is an example of Soft-Index File Store configuration via XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
    <span class="tag">&lt;soft-index-file-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:soft-index:8.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;index</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/index</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;data</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/data</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/soft-index-file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Programmatic configuration would look as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addStore(SoftIndexFileStoreConfigurationBuilder.class)
        .indexLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/index</span><span class="delimiter">&quot;</span></span>);
        .dataLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/sifs/testCache/data</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="current_limitations"><a class="anchor" href="#current_limitations"></a>Current limitations</h5>
<div class="paragraph">
<p>Size of a node in the Index is limited, by default it is 4096 bytes, though it
can be configured. This size also limits the key length (or rather the length
of the serialized form): you can&#8217;t use keys longer than size of the node
- 15 bytes. Moreover, the key length is stored as 'short', limiting it to 32767
bytes. There&#8217;s no way how you can use longer keys - SIFS throws an exception
when the key is longer after serialization.</p>
</div>
<div class="paragraph">
<p>When entries are stored with expiration, SIFS cannot detect that some of those
entries are expired. Therefore, such old file will not be compacted (method
AdvancedStore.purgeExpired() is not implemented). This can lead to excessive
file-system space usage.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc_cache_store"><a class="anchor" href="#jdbc_cache_store"></a>5.6. JDBC String based Cache Store</h3>
<div class="paragraph">
<p>A cache store which relies on the provided JDBC driver to load/store values in the underlying database.</p>
</div>
<div class="paragraph">
<p>Each key in the cache is stored in its own row in the database. In order to store each key in its own row, this store relies
on a (pluggable) bijection that maps the each key to a String object. The bijection is defined by the Key2StringMapper interface.
Infinispans ships a default implementation (smartly named DefaultTwoWayKey2StringMapper) that knows how to handle primitive types.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default Infinispan shares are not stored, meaning that all nodes in the cluster will write to the underlying store upon each update.
If you wish for an operation to only be written to the underlying database once, you must configure the JDBC store to be shared.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The JDBC string-based cache store does not support segmentation. Support will
be available in a future release.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="connection_management_pooling"><a class="anchor" href="#connection_management_pooling"></a>5.6.1. Connection management (pooling)</h4>
<div class="paragraph">
<p>In order to obtain a connection to the database the JDBC cache store relies on a <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/jdbc/connectionfactory/ConnectionFactory.html">ConnectionFactory</a>
implementation. The connection factory is specified programmatically using one of the connectionPool(), dataSource()
or simpleConnection() methods on the JdbcStringBasedStoreConfigurationBuilder class or declaratively using one of the
<code>&lt;connectionPool /&gt;</code>, <code>&lt;dataSource /&gt;</code> or <code>&lt;simpleConnection /&gt;</code> elements.</p>
</div>
<div class="paragraph">
<p>Infinispan ships with three ConnectionFactory implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/jdbc/configuration/PooledConnectionFactoryConfigurationBuilder.html">PooledConnectionFactoryConfigurationBuilder</a>
is a factory based on <a href="https://github.com/brettwooldridge/HikariCP">HikariCP</a>. Additional properties for HikariCP can
be provided by a properties file, either via placing a <code>hikari.properties</code> file on the classpath or by specifying the
path to the file via <code>PooledConnectionFactoryConfiguration.propertyFile</code> or <code>properties-file</code> in the connection pool&#8217;s
xml config. N.B. a properties file specified explicitly in the configuration is loaded instead of the <code>hikari.properties</code>
file on the class path and Connection pool characteristics which are explicitly set in PooledConnectionFactoryConfiguration
always override the values loaded from a properties file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to the official <a href="https://github.com/brettwooldridge/HikariCP">documentation</a> for details of all configuration properties.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/jdbc/configuration/ManagedConnectionFactoryConfigurationBuilder.html">ManagedConnectionFactoryConfigurationBuilder</a>
is a connection factory that can be used within managed environments, such as application servers. It knows how to look
into the JNDI tree at a certain location (configurable) and delegate connection management to the DataSource.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/jdbc/configuration/SimpleConnectionFactoryConfigurationBuilder.html">SimpleConnectionFactoryConfigurationBuilder</a>
is a factory implementation that will create database connection on a per invocation basis. Not recommended in production.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>PooledConnectionFactory</code> is generally recommended for stand-alone deployments (i.e. not running within AS or servlet container).
<code>ManagedConnectionFactory</code> can be used when running in a managed environment where a <code>DataSource</code> is present, so that
connection pooling is performed within the <code>DataSource</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sample_configurations"><a class="anchor" href="#sample_configurations"></a>5.6.2. Sample configurations</h4>
<div class="paragraph">
<p>Below is a sample configuration for the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a>.
For detailed description of all the parameters used refer to the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;string-keyed-jdbc-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:jdbc:9.4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">dialect</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">H2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;connection-pool</span> <span class="attribute-name">connection-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_string_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">driver</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/string-keyed-table&gt;</span>
   <span class="tag">&lt;/string-keyed-jdbc-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence().addStore(JdbcStringBasedStoreConfigurationBuilder.class)
      .shared(<span class="predefined-constant">true</span>)
      .table()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
      .connectionPool()
         .connectionUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_string_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span>)
         .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>)
         .driverClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, below is an example of a JDBC cache store with a managed connection factory, which is chosen implicitly by specifying a datasource JNDI location:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;string-keyed-jdbc-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:jdbc:9.4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">dialect</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">H2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;data-source</span> <span class="attribute-name">jndi-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/StringStoreWithManagedConnectionTest/DS</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/string-keyed-table&gt;</span>
   <span class="tag">&lt;/string-keyed-jdbc-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence().addStore(JdbcStringBasedStoreConfigurationBuilder.class)
      .shared(<span class="predefined-constant">true</span>)
      .table()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
      .dataSource()
         .jndiUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/StringStoreWithManagedConnectionTest/DS</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="remote_cache_store"><a class="anchor" href="#remote_cache_store"></a>5.7. Remote store</h3>
<div class="paragraph">
<p>The <code>RemoteStore</code> is a cache loader and writer implementation that stores data in a remote Infinispan cluster. In order to communicate with the remote cluster, the <code>RemoteStore</code> uses the HotRod client/server architecture. HotRod bering the load balancing and fault tolerance of calls and the possibility to fine-tune the connection between the RemoteCacheStore and the actual cluster. Please refer to Hot Rod for more information on the protocol, client and server configuration. For a list of RemoteStore configuration refer to the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/remote/configuration/RemoteStoreConfigurationBuilder.html">javadoc</a> . Example:</p>
</div>
<div class="sect3">
<h4 id="segmentation_support_3"><a class="anchor" href="#segmentation_support_3"></a>5.7.1. Segmentation support</h4>
<div class="paragraph">
<p>The <code>RemoteStore</code> store supports segmentation because it can publish keys and
entries by segment, allowing for more efficient bulk operations.</p>
</div>
<div class="paragraph">
<p>Segmentation is only supported when the remote server supports at
least protocol version 2.3 or newer.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Ensure the number of segments and hash are the same between the
store configured cache and the remote server otherwise bulk operations
will not return correct results.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="sample_usage"><a class="anchor" href="#sample_usage"></a>5.7.2. Sample Usage</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;remote-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:remote:8.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">raw-values</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;remote-server</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">12111</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;remote-server</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">two</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;connection-pool</span> <span class="attribute-name">max-active</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exhausted-action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE_NEW</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;write-behind</span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence().addStore(RemoteStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>)
      .ignoreModifications(<span class="predefined-constant">false</span>)
      .purgeOnStartup(<span class="predefined-constant">false</span>)
      .remoteCacheName(<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span>)
      .rawValues(<span class="predefined-constant">true</span>)
.addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>).port(<span class="integer">12111</span>)
      .addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">two</span><span class="delimiter">&quot;</span></span>)
      .connectionPool()
      .maxActive(<span class="integer">10</span>)
      .exhaustedAction(ExhaustedAction.CREATE_NEW)
      .async().enable();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this sample configuration, the remote cache store is configured to use the remote cache named "mycache" on servers "one" and "two". It also configures connection pooling and provides a custom transport executor. Additionally the cache store is asynchronous.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cluster_cache_loader"><a class="anchor" href="#cluster_cache_loader"></a>5.8. Cluster cache loader</h3>
<div class="paragraph">
<p>The ClusterCacheLoader is a cache loader implementation that retrieves data from other cluster members.</p>
</div>
<div class="paragraph">
<p>It is a cache loader only as it doesn&#8217;t persist anything (it is not a Store), therefore features like <em>fetchPersistentState</em> (and like) are not applicable.</p>
</div>
<div class="paragraph">
<p>A cluster cache loader can be used as a non-blocking (partial) alternative to <em>stateTransfer</em> : keys not already available in the local node are fetched on-demand from other nodes in the cluster. This is a kind of lazy-loading of the cache content.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The cluster cache loader does not support segmentation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;cluster-loader</span> <span class="attribute-name">remote-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addClusterLoader()
    .remoteCallTimeout(<span class="integer">500</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a list of ClusterCacheLoader configuration refer to the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/configuration/cache/ClusterLoaderConfiguration.html">javadoc</a> .</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The ClusterCacheLoader does not support preloading(preload=true). It also won&#8217;t provide state if fetchPersistentSate=true.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="cli_cache_loader"><a class="anchor" href="#cli_cache_loader"></a>5.9. Command-Line Interface cache loader</h3>
<div class="paragraph">
<p>The Command-Line Interface (CLI) cache loader is a cache loader implementation
that retrieves data from another Infinispan node using the CLI. The node to
which the CLI connects to could be a standalone node, or could be a node that
it&#8217;s part of a cluster. This cache loader is read-only, so it will only be
used to retrieve data, and hence, won&#8217;t be used when persisting data.</p>
</div>
<div class="paragraph">
<p>The CLI cache loader is configured with a connection URL pointing to the
Infinispan node to which connect to. Here is an example:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Details on the format of the URL and how to make sure a node can
receive invocations via the CLI can be found in the <a href="#command_line_interface">Command-Line Interface chapter</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Command-Line Interface (CLI) cache loader does not support segmentation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
 <span class="tag">&lt;cli-loader</span> <span class="attribute-name">connection</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jmx://1.2.3.4:4444/MyCacheManager/myCache</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addStore(CLInterfaceLoaderConfigurationBuilder.class)
    .connectionString(<span class="string"><span class="delimiter">&quot;</span><span class="content">jmx://1.2.3.4:4444/MyCacheManager/myCache</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rocksdb_cache_store"><a class="anchor" href="#rocksdb_cache_store"></a>5.10. RocksDB Cache Store</h3>
<div class="paragraph">
<p>Infinispan supports using RocksDB as a cache store.</p>
</div>
<div class="sect3">
<h4 id="introduction_2"><a class="anchor" href="#introduction_2"></a>5.10.1. Introduction</h4>
<div class="paragraph">
<p><a href="http://rocksdb.org/">RocksDB</a> is a fast key-value filesystem-based storage from Facebook. It started as a fork of
Google&#8217;s LevelDB, but provides superior performance and reliability, especially in highly concurrent scenarios.</p>
</div>
</div>
<div class="sect3">
<h4 id="segmentation_support_4"><a class="anchor" href="#segmentation_support_4"></a>5.10.2. Segmentation support</h4>
<div class="paragraph">
<p>The RocksDB cache store supports segmentation and creates a separate column
family per segment, which substantially improves lookup performance and
iteration. However, write operations are a little slower when the cache store
is segmented.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You should not configure more than a few hundred segments. RocksDB is not
designed to have an unlimited number of column families. Too many segments also
significantly increases startup time for the cache store.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="sample_usage_2"><a class="anchor" href="#sample_usage_2"></a>Sample Usage</h5>
<div class="paragraph">
<p>The RocksDB cache store requires 2 filesystem directories to be configured - each directory contains a RocksDB database:
one location is used to store non-expired data, while the second location is used to store expired keys pending purge.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
                                .addStore(RocksDBStoreConfigurationBuilder.class)
                                .build();
EmbeddedCacheManager cacheManager = <span class="keyword">new</span> DefaultCacheManager(cacheConfig);

Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">usersCache</span><span class="delimiter">&quot;</span></span>);
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User(...));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration_4"><a class="anchor" href="#configuration_4"></a>5.10.3. Configuration</h4>
<div class="paragraph">
<p>It is also possible to configure the underlying rocks db instance. This can be done
via properties in the store configuration. Any property that is prefixed with the
name <code>database</code> will configure the rocks db database. Data is now stored in column
families, these can be configured independently of the database by setting
a property prefixed with the name <code>data</code>.</p>
</div>
<div class="paragraph">
<p>Note that you do not have to supply properties and this is entirely optional.</p>
</div>
<div class="sect4">
<h5 id="sample_programatic_configuration"><a class="anchor" href="#sample_programatic_configuration"></a>Sample Programatic Configuration</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">database.max_background_compactions</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>);
props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">data.write_buffer_size</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">512MB</span><span class="delimiter">&quot;</span></span>);

<span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
                                .addStore(RocksDBStoreConfigurationBuilder.class)
                                .location(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/rocksdb/data</span><span class="delimiter">&quot;</span></span>)
                                .expiredLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/rocksdb/expired</span><span class="delimiter">&quot;</span></span>)
        .properties(props)
                                .build();</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">location</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory to use for RocksDB to store primary cache store data.  The directory will be auto-created if it does not exit.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">expiredLocation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory to use for RocksDB to store expiring data pending to be purged permanently.  The directory will be auto-created if it does not exit.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">expiryQueueSize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of the in-memory queue to hold expiring entries before it gets flushed into expired RocksDB store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">clearThreshold</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">There are two methods to clear all entries in RocksDB.  One method is to iterate through all entries and remove each entry individually.  The other method is to delete the database and re-init.  For smaller databases, deleting individual entries is faster than the latter method.  This configuration sets the max number of entries allowed before using the latter method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">compressionType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration for RocksDB for data compression, see CompressionType enum for options</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">blockSize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration for RocksDB - see <a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide">documentation</a> for performance tuning</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cacheSize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration for RocksDB - see <a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide">documentation</a> for performance tuning</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="sample_xml_configuration"><a class="anchor" href="#sample_xml_configuration"></a>Sample XML Configuration</h5>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vehicleCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;persistence&gt;</span>
      <span class="tag">&lt;rocksdb-store</span><span class="error"></span><span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/rocksdb/data</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;expiration</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/rocksdb/expired</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">database.max_background_compactions</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>2<span class="tag">&lt;/property&gt;</span>
         <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">data.write_buffer_size</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>512MB<span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;/rocksdb-store&gt;</span>
   <span class="tag">&lt;/persistence&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan servers log warning messages at startup when you add configuration
properties that are specific to RocksDB.</p>
</div>
<div class="paragraph">
<p>For example, as in the preceding example, if you set <code>data.write_buffer_size</code>
in your configuration, then the following message is written to logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>WARN  [org.infinispan.configuration.parsing.XmlConfigHelper] ISPN000292:
Unrecognized attribute 'data.write_buffer_size'. Please check your
configuration. Ignoring!</pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan applies the RocksDB properties even though the log message
indicates they do not take effect. You can ignore these <code>WARN</code> messages.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="additional_references"><a class="anchor" href="#additional_references"></a>5.10.4. Additional References</h4>
<div class="paragraph">
<p>Refer to the <a href="https://github.com/infinispan/infinispan/blob/master/persistence/rocksdb/src/test/java/org/infinispan/persistence/rocksdb/config/ConfigurationTest.java">test case</a> for code samples in action.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="https://github.com/infinispan/infinispan/tree/master/persistence/rocksdb/src/test/resources/config/">test configurations</a> for configuration samples.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="leveldb_cache_store"><a class="anchor" href="#leveldb_cache_store"></a>5.11. LevelDB Cache Store</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The LevelDB Cache Store has been deprecated and has been replaced with the
RocksDB Cache Store. If you have existing data stored in a LevelDB Cache Store,
the RocksDB Cache Store will convert it to the new SST-based format
on the first run.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="jpa_cache_store"><a class="anchor" href="#jpa_cache_store"></a>5.12. JPA Cache Store</h3>
<div class="paragraph">
<p>The implementation depends on JPA 2.0 specification to access entity meta model.</p>
</div>
<div class="paragraph">
<p>In normal use cases, it&#8217;s recommended to leverage Infinispan for JPA second level cache and/or query cache.
However, if you&#8217;d like to use only Infinispan API and you want Infinispan to persist into a cache store using a common format (e.g., a database with well defined schema), then JPA Cache Store could be right for you.</p>
</div>
<div class="ulist">
<div class="title">Things to note</div>
<ul>
<li>
<p>When using JPA Cache Store, the key should be the ID of the entity, while the value should be the entity object.</p>
</li>
<li>
<p>Only a single <code>@Id</code> or <code>@EmbeddedId</code> annotated property is allowed.</p>
</li>
<li>
<p>Auto-generated ID is not supported.</p>
</li>
<li>
<p>Lastly, all entries will be stored as immortal entries.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The JPA cache store does not support segmentation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sample_usage_3"><a class="anchor" href="#sample_usage_3"></a>5.12.1. Sample Usage</h4>
<div class="paragraph">
<p>For example, given a persistence unit "myPersistenceUnit", and a JPA entity User:</p>
</div>
<div class="listingblock">
<div class="title">persistence.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myPersistenceUnit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
<span class="tag">&lt;/persistence-unit&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>User entity class</p>
</div>
<div class="listingblock">
<div class="title">User.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
        <span class="annotation">@Id</span>
        <span class="directive">private</span> <span class="predefined-type">String</span> username;
        <span class="directive">private</span> <span class="predefined-type">String</span> firstName;
        <span class="directive">private</span> <span class="predefined-type">String</span> lastName;

        ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can configure a cache "usersCache" to use JPA Cache Store, so that when you put data into the cache, the data would be persisted into the database based on JPA configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager cacheManager = ...;


<span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
            .addStore(JpaStoreConfigurationBuilder.class)
            .persistenceUnitName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.loaders.jpa.configurationTest</span><span class="delimiter">&quot;</span></span>)
            .entityClass(User.class)
            .build();
cacheManager.defineCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">usersCache</span><span class="delimiter">&quot;</span></span>, cacheConfig);

Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">usersCache</span><span class="delimiter">&quot;</span></span>);
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User(...));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Normally a single Infinispan cache can store multiple types of key/value pairs, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>);
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User());
Cache&lt;<span class="predefined-type">Integer</span>, Teacher&gt; teachersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>);
teachersCache.put(<span class="integer">1</span>, <span class="keyword">new</span> Teacher());</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that, when a cache is configured to use a JPA Cache Store, that cache would only be able to store ONE type of data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myJPACache</span><span class="delimiter">&quot;</span></span>); <span class="comment">// configured for User entity class</span>
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User());
Cache&lt;<span class="predefined-type">Integer</span>, Teacher&gt; teachersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myJPACache</span><span class="delimiter">&quot;</span></span>); <span class="comment">// cannot do this when this cache is configured to use a JPA cache store</span>
teachersCache.put(<span class="integer">1</span>, <span class="keyword">new</span> Teacher());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use of <code>@EmbeddedId</code> is supported so that you can also use composite keys.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Vehicle</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
        <span class="annotation">@EmbeddedId</span>
        <span class="directive">private</span> VehicleId id;
        <span class="directive">private</span> <span class="predefined-type">String</span> color;        ...
}

<span class="annotation">@Embeddable</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">VehicleId</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span>
{
        <span class="directive">private</span> <span class="predefined-type">String</span> state;
        <span class="directive">private</span> <span class="predefined-type">String</span> licensePlate;
        ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, auto-generated IDs (e.g., <code>@GeneratedValue</code>) is not supported.
When putting things into the cache with a JPA cache store, the key should be the ID value!</p>
</div>
</div>
<div class="sect3">
<h4 id="configuration_5"><a class="anchor" href="#configuration_5"></a>5.12.2. Configuration</h4>
<div class="sect4">
<h5 id="sample_programatic_configuration_2"><a class="anchor" href="#sample_programatic_configuration_2"></a>Sample Programatic Configuration</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
             .addStore(JpaStoreConfigurationBuilder.class)
             .persistenceUnitName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.loaders.jpa.configurationTest</span><span class="delimiter">&quot;</span></span>)
             .entityClass(User.class)
             .build();</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">persistenceUnitName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JPA persistence unit name in JPA configuration (persistence.xml) that contains the JPA entity class</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">entityClass</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JPA entity class that is expected to be stored in this cache.  Only one class is allowed.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="sample_xml_configuration_2"><a class="anchor" href="#sample_xml_configuration_2"></a>Sample XML Configuration</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vehicleCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;jpa-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:jpa:7.0</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">persistence-unit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.persistence.jpa.configurationTest</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">entity-class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.persistence.jpa.entity.Vehicle</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                /<span class="error">&gt;</span>
   <span class="tag">&lt;/persistence&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">persistence-unit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JPA persistence unit name in JPA configuration (persistence.xml) that contains the JPA entity class</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">entity-class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fully qualified JPA entity class name that is expected to be stored in this cache.  Only one class is allowed.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="additional_references_2"><a class="anchor" href="#additional_references_2"></a>5.12.3. Additional References</h4>
<div class="paragraph">
<p>Refer to the <a href="https://github.com/infinispan/infinispan/blob/master/persistence/jpa/src/test/java/org/infinispan/persistence/jpa/JpaConfigurationTest.java">test case</a> for code samples in action.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="https://github.com/infinispan/infinispan/blob/master/persistence/jpa/src/test/resources/config/jpa-config.xml">test configurations</a> for configuration samples.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="custom_cache_stores"><a class="anchor" href="#custom_cache_stores"></a>5.13. Custom Cache Stores</h3>
<div class="paragraph">
<p>If the provided cache stores do not fulfill all of your requirements, it is possible for you to implement your own store.
The steps required to create your own store are as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Write your custom store by implementing one of the following interfaces:</p>
<div class="ulist">
<ul>
<li>
<p><code>org.infinispan.persistence.spi.AdvancedCacheWriter</code></p>
</li>
<li>
<p><code>org.infinispan.persistence.spi.AdvancedCacheLoader</code></p>
</li>
<li>
<p><code>org.infinispan.persistence.spi.CacheLoader</code></p>
</li>
<li>
<p><code>org.infinispan.persistence.spi.CacheWriter</code></p>
</li>
<li>
<p><code>org.infinispan.persistence.spi.ExternalStore</code></p>
</li>
<li>
<p><code>org.infinispan.persistence.spi.AdvancedLoadWriteStore</code></p>
</li>
<li>
<p><code>org.infinispan.persistence.spi.TransactionalCacheWriter</code></p>
</li>
<li>
<p><code>org.infinispan.persistence.spi.SegmentedAdvancedLoadWriteStore</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Annotate your store class with the <code>@Store</code> annotation and specify the properties relevant to your store, e.g. is it
possible for the store to be shared in Replicated or Distributed mode: <code>@Store(shared = true)</code>.</p>
</li>
<li>
<p>Create a custom cache store configuration and builder. This requires extending <code>AbstractStoreConfiguration</code> and <code>AbstractStoreConfigurationBuilder</code>.
As an optional step, you should add the following annotations to your configuration - <code>@ConfigurationFor</code>, <code>@BuiltBy</code> as well
as adding <code>@ConfiguredBy</code> to your store implementation class.  These additional annotations will ensure that your custom
configuration builder is used to parse your store configuration from xml. If these annotations are not added, then the
<code>CustomStoreConfigurationBuilder</code> will be used to parse the common store attributes defined in <code>AbstractStoreConfiguration</code>
and any additional elements will be ignored. If a store and its configuration do not declare the <code>@Store</code> and <code>@ConfigurationFor</code>
annotations respectively, a warning message will be logged upon cache initialisation.</p>
<div class="paragraph">
<p>If you wish for your store to be segmented, where it will craete a different
store instance per segment, instead of extending <code>AbstractStoreConfiguration</code>
you should extend <code>AbstractSegmentedStoreConfiguration</code>.</p>
</div>
</li>
<li>
<p>Add your custom store to your cache&#8217;s configuration:</p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Add your custom store to the ConfigurationBuilder, for example:</p>
<div class="literalblock">
<div class="content">
<pre>Configuration config = new ConfigurationBuilder()
            .persistence()
            .addStore(CustomStoreConfigurationBuilder.class)
            .build();</pre>
</div>
</div>
</li>
<li>
<p>Define your custom store via xml:</p>
<div class="literalblock">
<div class="content">
<pre>&lt;local-cache name="customStoreExample"&gt;
  &lt;persistence&gt;
    &lt;store class="org.infinispan.persistence.dummy.DummyInMemoryStore" /&gt;
  &lt;/persistence&gt;
&lt;/local-cache&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="hotrod_deployment"><a class="anchor" href="#hotrod_deployment"></a>5.13.1. HotRod Deployment</h4>
<div class="paragraph">
<p>A Custom Cache Store can be packaged into a separate JAR file and deployed in a HotRod server using the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Follow <a href="#custom_cache_stores">Custom Cache Stores</a>, steps 1-3&gt;&gt; in the previous section and package your implementations in a JAR file (or use a Custom Cache Store Archetype).</p>
</li>
<li>
<p>In your Jar create a proper file under <code>META-INF/services/</code>, which contains the fully qualified class name of your store implementation.
The name of this service file should reflect the interface that your store implements. For example, if your store implements
the <code>AdvancedCacheWriter</code> interface than you need to create the following file:</p>
<div class="ulist">
<ul>
<li>
<p><code>/META-INF/services/org.infinispan.persistence.spi.AdvancedCacheWriter</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Deploy the JAR file in the Infinispan Server.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="store_migrator"><a class="anchor" href="#store_migrator"></a>5.14. Store Migrator</h3>
<div class="paragraph">
<p>Infinispan 9.0 introduced changes to internal marshalling functionality that are not backwardly compatible with previous versions of Infinispan. As a result, Infinispan 9.x and later cannot read cache stores created in earlier versions of Infinispan.
Additionally, Infinispan no longer provides some store implementations such as JDBC Mixed and Binary stores.</p>
</div>
<div class="paragraph">
<p>You can use <code>StoreMigrator.java</code> to migrate cache stores. This migration tool reads data from cache stores in previous versions and rewrites the content for compatibility with the current marshalling implementation.</p>
</div>
<div class="sect3">
<h4 id="migrating_cache_stores"><a class="anchor" href="#migrating_cache_stores"></a>5.14.1. Migrating Cache Stores</h4>
<div class="paragraph">
<p>To perform a migration with <code>StoreMigrator</code>,</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Put <code>infinispan-tools-9.4.jar</code> and dependencies for your source and target databases, such as JDBC drivers, on your classpath.</p>
</li>
<li>
<p>Create a <code>.properties</code> file that contains configuration properties for the source and target cache stores.</p>
<div class="paragraph">
<p>You can find an example properties file that contains all applicable configuration options in <a href="https://github.com/infinispan/infinispan/blob/master/tools/src/main/resources/migrator.properties">migrator.properties</a>.</p>
</div>
</li>
<li>
<p>Specify <code>.properties</code> file as an argument for <code>StoreMigrator</code>.</p>
</li>
<li>
<p>Run <code>mvn exec:java</code> to execute the migrator.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>See the following example Maven <code>pom.xml</code> for <code>StoreMigrator</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;project</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/POM/4.0.0</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;modelVersion&gt;</span>4.0.0<span class="tag">&lt;/modelVersion&gt;</span>

    <span class="tag">&lt;groupId&gt;</span>org.infinispan.example<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jdbc-migrator-example<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span>

    <span class="tag">&lt;dependencies&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>infinispan-tools<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>

        <span class="comment">&lt;!-- ADD YOUR REQUIRED DEPENDENCIES HERE --&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>

    <span class="tag">&lt;build&gt;</span>
        <span class="tag">&lt;plugins&gt;</span>
            <span class="tag">&lt;plugin&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.codehaus.mojo<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>exec-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>1.2.1<span class="tag">&lt;/version&gt;</span>
                <span class="tag">&lt;executions&gt;</span>
                    <span class="tag">&lt;execution&gt;</span>
                        <span class="tag">&lt;goals&gt;</span>
                            <span class="tag">&lt;goal&gt;</span>java<span class="tag">&lt;/goal&gt;</span>
                        <span class="tag">&lt;/goals&gt;</span>
                    <span class="tag">&lt;/execution&gt;</span>
                <span class="tag">&lt;/executions&gt;</span>
                <span class="tag">&lt;configuration&gt;</span>
                    <span class="tag">&lt;mainClass&gt;</span>StoreMigrator<span class="tag">&lt;/mainClass&gt;</span>
                    <span class="tag">&lt;arguments&gt;</span>
                        <span class="tag">&lt;argument&gt;</span><span class="comment">&lt;!-- PATH TO YOUR MIGRATOR.PROPERTIES FILE --&gt;</span><span class="tag">&lt;/argument&gt;</span>
                    <span class="tag">&lt;/arguments&gt;</span>
                <span class="tag">&lt;/configuration&gt;</span>
            <span class="tag">&lt;/plugin&gt;</span>
        <span class="tag">&lt;/plugins&gt;</span>
    <span class="tag">&lt;/build&gt;</span>
<span class="tag">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
</div>
<div class="sect3">
<h4 id="store_migrator_properties"><a class="anchor" href="#store_migrator_properties"></a>5.14.2. Store Migrator Properties</h4>
<div class="paragraph">
<p>All migrator properties are configured within the context of a source or target store. Each property must start with either <code>source.</code> or <code>target.</code>.</p>
</div>
<div class="paragraph">
<p>All properties in the following sections apply to both source and target stores,
except for <code>table.binary.*</code> properties because it is not possible to migrate to a binary table.</p>
</div>
<div class="sect4">
<h5 id="common_properties"><a class="anchor" href="#common_properties"></a>Common Properties</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example value</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDBC_STRING | JDBC_BINARY | JDBC_MIXED | LEVELDB | ROCKSDB | SINGLE_FILE_STORE | SOFT_INDEX_FILE_STORE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDBC_MIXED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cache_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the cache associated with the store</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">persistentMixedCache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">segment_count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">How many segments this store will be created with. If not provided store will not be segmented. (supported as target only - JDBC not yet supported)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It should be noted that the <strong>segment_count</strong> property should match how many
segments your cache will be using. That is that it should match the
<code>clustering.hash.numSegments</code> config value. If these do not match, data
will not be properly read when running the cache.</p>
</div>
</div>
<div class="sect4">
<h5 id="jdbc_properties"><a class="anchor" href="#jdbc_properties"></a>JDBC Properties</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example value</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dialect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The dialect of the underlying database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">POSTGRES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">marshaller.type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The marshaller to use for the store. Possible values are:</p>
<p class="tableblock">- <code>LEGACY</code> Infinispan 8.2.x marshaller. Valid for source stores only.</p>
<p class="tableblock">- <code>CURRENT</code> Infinispan 9.x marshaller.</p>
<p class="tableblock">- <code>CUSTOM</code> Custom marshaller.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CURRENT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">marshaller.class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The class of the marshaller if type=CUSTOM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.example.CustomMarshaller</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">marshaller.externalizers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A comma-separated list of custom AdvancedExternalizer implementations to load <code>[id]:&lt;Externalizer class&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>25:Externalizer1,org.example.Externalizer2</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connection_pool.connection_url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The JDBC connection url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jdbc:postgresql:postgres</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connection_pool.driver_class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The class of the JDBC driver</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.postrgesql.Driver</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connection_pool.username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database username</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connection_pool.password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database password</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">db.major_version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database major version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">db.minor_version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database minor version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">db.disable_upsert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disable db upsert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">db.disable_indexing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prevent table index being created</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">table.<code>&lt;binary|string&gt;</code>.table_name_prefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Additional prefix for table name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tablePrefix</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">table.<code>&lt;binary|string&gt;</code>.<code>&lt;id|data|timestamp&gt;</code>.name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the column</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id_column</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">table.<code>&lt;binary|string&gt;</code>.<code>&lt;id|data|timestamp&gt;</code>.type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of the column</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARCHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key_to_string_mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TwoWayKey2StringMapper Class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.infinispan.persistence.keymappers. DefaultTwoWayKey2StringMapper</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="leveldbrocksdb_properties"><a class="anchor" href="#leveldbrocksdb_properties"></a>LevelDB/RocksDB Properties</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example value</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">location</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The location of the db directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/some/example/dir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">compression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The compression type to be used</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SNAPPY</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="singlefilestore_properties"><a class="anchor" href="#singlefilestore_properties"></a>SingleFileStore Properties</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example value</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">location</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The directory containing the store&#8217;s .dat file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/some/example/dir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="softindexfilestore_properties"><a class="anchor" href="#softindexfilestore_properties"></a>SoftIndexFileStore Properties</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example value</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">location</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The location of the db directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/some/example/dir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">index_location</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The location of the db&#8217;s index</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/some/example/dir-index</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Target Only</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Following sections describe the SPI and also discuss the SPI implementations that Infinispan ships out of the box.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spi"><a class="anchor" href="#spi"></a>5.15. SPI</h3>
<div class="paragraph">
<p>The following class diagram presents the main SPI interfaces of the persistence API:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/Figure2_1_persistence_API.png" alt="Figure2 1 persistence API">
</div>
<div class="title">Figure 1. Persistence SPI</div>
</div>
<div class="paragraph">
<p>Some notes about the classes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/io/ByteBuffer.html">ByteBuffer</a> - abstracts the serialized form of an object</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/spi/MarshalledEntry.html">MarshalledEntry</a> - abstracts the information held within
a persistent store corresponding to a key-value added to the cache. Provides method for reading this information both in serialized (<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/io/ByteBuffer.html">ByteBuffer</a>) and deserialized (Object) format. Normally data read from the store is kept in serialized format and lazily deserialized on demand, within the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/spi/MarshalledEntry.html">MarshalledEntry</a> implementation</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/spi/CacheWriter.html">CacheWriter</a> and <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/spi/CacheLoader.html">CacheLoader</a> provide basic methods for reading and writing to a store</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/spi/AdvancedCacheLoader.html">AdvancedCacheLoader</a> and <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/spi/AdvancedCacheWriter.html">AdvancedCacheWriter</a> provide operations to manipulate the underlaying storage in bulk: parallel iteration and purging of expired entries, clear and size.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/spi/SegmentedAdvancedLoadWriteStore.html">SegmentedAdvancedLoadWriteStore</a> provide all the various operations that deal with segments.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A cache store can be segmented if it does one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implements the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/spi/SegmentedAdvancedLoadWriteStore.html">SegmentedAdvancedLoadWriteStore</a> interface. In this case only a single
store instance is used per cache.</p>
</li>
<li>
<p>Has a configuration that extends the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/configuration/cache/AbstractSegmentedConfiguration.html">AbstractSegmentedConfiguration</a> abstract class. Doing this requires you to implement the <code>newConfigurationFrom</code> method where it is expected
that a new <code>StoreConfiguration</code> instance is created per invocation. This
creates a store instance per segment to which a node can write. Stores might
start and stop as data is moved between nodes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A provider might choose to only implement a subset of these interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Not implementing the  <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/spi/AdvancedCacheWriter.html">AdvancedCacheWriter</a> makes the given writer not usable for purging expired entries or clear</p>
</li>
<li>
<p>If a loader does not implement the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/persistence/spi/AdvancedCacheLoader.html">AdvancedCacheLoader</a>
inteface, then it will not participate in preloading nor in cache iteration
(required also for stream operations).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you&#8217;re looking at migrating your existing store to the new API or to write a new store implementation, the <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/persistence/file/SingleFileStore.java">SingleFileStore</a> might be a good starting point/example.</p>
</div>
</div>
<div class="sect2">
<h3 id="more_implementations"><a class="anchor" href="#more_implementations"></a>5.16. More implementations</h3>
<div class="paragraph">
<p>Many more cache loader and cache store implementations exist.
Visit <a href="http://infinispan.org/cache-store-implementations">this website</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clustering"><a class="anchor" href="#clustering"></a>6. Clustering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A cache manager can be configured to be either local (standalone) or clustered.
When clustered, manager instances use JGroups' discovery protocols to automatically
discover neighboring instances on the same local network and form a cluster.</p>
</div>
<div class="paragraph">
<p>Creating a local-only cache manager is trivial: just use the no-argument
<code>DefaultCacheManager</code> constructor, or supply the following XML configuration file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan</span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To start a clustered cache manager, you need to create a clustered configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder gcb = GlobalConfigurationBuilder.defaultClusteredBuilder();
DefaultCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(gcb.build());</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;cache-container&gt;</span>
    <span class="tag">&lt;transport</span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Individual caches can then be configured in different modes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Local</strong>: changes and reads are never replicated. This is the only mode available in
non-clustered cache managers.</p>
</li>
<li>
<p><strong>Invalidation</strong>: changes are not replicated, instead the key is invalidated on all
nodes; reads are local.</p>
</li>
<li>
<p><strong>Replicated</strong>: changes are replicated to all nodes, reads are always local.</p>
</li>
<li>
<p><strong>Distributed</strong>: changes are replicated to a fixed number of nodes, reads request the
value from at least one of the owner nodes.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="which_cache_mode_should_i_use"><a class="anchor" href="#which_cache_mode_should_i_use"></a>6.1. Which cache mode should I use?</h3>
<div class="paragraph">
<p>Which cache you should use depends on the qualities/guarantees you need for your data. The following table summarizes the most important ones:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 13.6363%;">
<col style="width: 13.6363%;">
<col style="width: 13.6363%;">
<col style="width: 13.6363%;">
<col style="width: 13.6363%;">
<col style="width: 13.6367%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-center valign-top">Simple</th>
<th class="tableblock halign-center valign-top">Local</th>
<th class="tableblock halign-center valign-top">Invalidation</th>
<th class="tableblock halign-center valign-top">Replicated</th>
<th class="tableblock halign-center valign-top">Distributed</th>
<th class="tableblock halign-center valign-top">Scattered</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clustered</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">No</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">No</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Yes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Yes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Yes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Yes</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read performance</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Highest</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">High</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">High</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">High</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Medium</strong><br>
(owners)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Medium</strong><br>
(primary)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write performance</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Highest</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">High</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Low</strong><br>
(all nodes, no data)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Lowest</strong><br>
(all nodes)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Medium</strong><br>
(owner nodes)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Higher</strong><br>
(single RPC)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Capacity</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Smallest node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Cluster</strong><br>
\$(sum_(i=1)^"nodes""node_capacity")/"owners"\$</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Cluster</strong><br>
\$(sum_(i=1)^"nodes""node_capacity")/"2"\$</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Availability</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All nodes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Owner nodes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Owner nodes</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Features</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">No TX, persistence, indexing</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">No TX</strong></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="local_mode"><a class="anchor" href="#local_mode"></a>6.2. Local Mode</h3>
<div class="paragraph">
<p>While Infinispan is particularly interesting in clustered mode, it also offers a very
capable local mode.
In this mode, it acts as a simple, in-memory data cache similar to a <code>ConcurrentHashMap</code>.</p>
</div>
<div class="paragraph">
<p>But why would one use a local cache rather than a map?
Caches offer a lot of features over and above a simple map, including write-through and
write-behind to a persistent store, eviction of entries to prevent running out of memory,
and expiration.</p>
</div>
<div class="paragraph">
<p>Infinispan&#8217;s <code>Cache</code> interface extends JDK&#8217;s <code>ConcurrentMap</code>&#8201;&#8212;&#8201;making migration from a
map to Infinispan trivial.</p>
</div>
<div class="paragraph">
<p>Infinispan caches also support transactions, either integrating with an existing
transaction manager or running a separate one.
Local caches transactions have two choices:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When to lock?
<strong>Pessimistic locking</strong> locks keys on a write operation or when the user calls
<code>AdvancedCache.lock(keys)</code> explicitly.
<strong>Optimistic locking</strong> only locks keys during the transaction commit, and instead it throws
a <code>WriteSkewCheckException</code> at commit time, if another transaction modified the same keys
after the current transaction read them.</p>
</li>
<li>
<p>Isolation level.
We support <strong>read-committed</strong> and <strong>repeatable read</strong>.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="simple_cache"><a class="anchor" href="#simple_cache"></a>6.2.1. Simple Cache</h4>
<div class="paragraph">
<p>Traditional local caches use the same architecture as clustered caches, i.e. they use the interceptor stack.
That way a lot of the implementation can be reused. However, if the advanced features
are not needed and performance is more important, the interceptor stack can be stripped
away and simple cache can be used.</p>
</div>
<div class="paragraph">
<p>So, which features are stripped away? From the configuration perspective, simple cache does not support:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>transactions and invocation batching</p>
</li>
<li>
<p>persistence (cache stores and loaders)</p>
</li>
<li>
<p>custom interceptors (there&#8217;s no interceptor stack!)</p>
</li>
<li>
<p>indexing</p>
</li>
<li>
<p>compatibility (embedded/server mode)</p>
</li>
<li>
<p>store as binary (which is hardly useful for local caches)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From the API perspective these features throw an exception:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>adding custom interceptors</p>
</li>
<li>
<p>Distributed Executors Framework</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So, what&#8217;s left?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>basic map-like API</p>
</li>
<li>
<p>cache listeners (local ones)</p>
</li>
<li>
<p>expiration</p>
</li>
<li>
<p>eviction</p>
</li>
<li>
<p>security</p>
</li>
<li>
<p>JMX access</p>
</li>
<li>
<p>statistics (though for max performance it is recommended to switch this off using statistics-available=false)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="declarative_configuration_2"><a class="anchor" href="#declarative_configuration_2"></a>Declarative configuration</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"> <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mySimpleCache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">simple-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- expiration, eviction, security... --&gt;</span>
 <span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="programmatic_configuration_2"><a class="anchor" href="#programmatic_configuration_2"></a>Programmatic configuration</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CacheManager cm = getCacheManager();
ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder().simpleCache(<span class="predefined-constant">true</span>);
cm.defineConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">mySimpleCache</span><span class="delimiter">&quot;</span></span>, builder.build());
Cache cache = cm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">mySimpleCache</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simple cache checks against features it does not support, if you configure it to use e.g. transactions,
configuration validation will throw an exception.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="invalidation_mode"><a class="anchor" href="#invalidation_mode"></a>6.3. Invalidation Mode</h3>
<div class="paragraph">
<p>In invalidation, the caches on different nodes do not actually share any data.
Instead, when a key is written to, the cache only aims to remove data that may be stale
from other nodes.
This cache mode only makes sense if you have another, permanent store for your data such
as a database and are only using Infinispan as an optimization in a read-heavy system,
to prevent hitting the database for every read.
If a cache is configured for invalidation, every time data is changed in a cache, other
caches in the cluster receive a message informing them that their data is now stale and
should be removed from memory and from any local store.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/clustering-invalidation.svg" alt="clustering invalidation">
</div>
<div class="title">Figure 2. Invalidation mode</div>
</div>
<div class="paragraph">
<p>Sometimes the application reads a value from the external store and wants to write it to
the local cache, without removing it from the other nodes.
To do this, it must call <code>Cache.putForExternalRead(key, value)</code> instead of
<code>Cache.put(key, value)</code>.</p>
</div>
<div class="paragraph">
<p>Invalidation mode can be used with a shared cache store.
A write operation will both update the shared store, and it would remove the stale values
from the other nodes' memory.
The benefit of this is twofold: network traffic is minimized as invalidation messages are
very small compared to replicating the entire value, and also other caches in the cluster
look up modified data in a lazy manner, only when needed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Never use invalidation mode with a <strong>local</strong> store.
The invalidation message will not remove entries in the local store, and some
nodes will keep seeing the stale value.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An invalidation cache can also be configured with a special cache loader, <code>ClusterLoader</code>.
When <code>ClusterLoader</code> is enabled, read operations that do not find the key on the local
node will request it from all the other nodes first, and store it in memory locally.
In certain situation it will store stale values, so only use it if you have a high
tolerance for stale values.</p>
</div>
<div class="paragraph">
<p>Invalidation mode can be synchronous or asynchronous.
When synchronous, a write blocks until all nodes in the cluster have evicted the stale
value. When asynchronous, the originator broadcasts invalidation messages but doesn&#8217;t
wait for responses.
That means other nodes still see the stale value for a while after the write completed on
the originator.</p>
</div>
<div class="paragraph">
<p>Transactions can be used to batch the invalidation messages.
Transactions acquire the key lock on the primary owner.
To find more about how primary owners are assigned, please read the
<a href="#key_ownership">Key Ownership</a> section.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With pessimistic locking, each write triggers a lock message, which is
broadcast to all the nodes.
During transaction commit, the originator broadcasts a one-phase prepare message
(optionally fire-and-forget) which invalidates all affected keys and releases the locks.</p>
</li>
<li>
<p>With optimistic locking, the originator broadcasts a prepare message, a commit message,
and an unlock message (optional).
Either the one-phase prepare or the unlock message is fire-and-forget,
and the last message always releases the locks.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="replicated_mode"><a class="anchor" href="#replicated_mode"></a>6.4. Replicated Mode</h3>
<div class="paragraph">
<p>Entries written to a replicated cache on any node will be replicated to all other nodes
in the cluster, and can be retrieved locally from any node.
Replicated mode provides a quick and easy way to share state across a cluster,
however replication practically only performs well in small clusters (under 10 nodes),
due to the number of messages needed for a write scaling linearly with the cluster size.
Infinispan can be configured to use UDP multicast, which mitigates this problem to some
degree.</p>
</div>
<div class="paragraph">
<p>Each key has a primary owner, which serializes data container updates in order to
provide consistency.
To find more about how primary owners are assigned, please read the
<a href="#key_ownership">Key Ownership</a> section.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/clustering-replicated.svg" alt="clustering replicated">
</div>
<div class="title">Figure 3. Replicated mode</div>
</div>
<div class="paragraph">
<p>Replicated mode can be synchronous or asynchronous.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Synchronous replication blocks the caller (e.g. on a <code>cache.put(key, value)</code>) until
the modifications have been replicated successfully to all the nodes in the cluster.</p>
</li>
<li>
<p>Asynchronous replication performs replication in the background, and write operations
return immediately.
Asynchronous replication is not recommended, because communication errors, or errors
that happen on remote nodes are not reported to the caller.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If transactions are enabled, write operations are not replicated through the primary
owner.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With pessimistic locking, each write triggers a lock message, which is
broadcast to all the nodes.
During transaction commit, the originator broadcasts a one-phase prepare message and an
unlock message (optional).
Either the one-phase prepare or the unlock message is fire-and-forget.</p>
</li>
<li>
<p>With optimistic locking, the originator broadcasts a prepare message, a commit message,
and an unlock message (optional).
Again, either the one-phase prepare or the unlock message is fire-and-forget.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="distribution_mode"><a class="anchor" href="#distribution_mode"></a>6.5. Distribution Mode</h3>
<div class="paragraph">
<p>Distribution tries to keep a fixed number of copies of any entry in the cache,
configured as <code>numOwners</code>.
This allows the cache to scale linearly, storing more data as nodes are added to the
cluster.</p>
</div>
<div class="paragraph">
<p>As nodes join and leave the cluster, there will be times when a key has more or less than
<code>numOwners</code> copies.
In particular, if <code>numOwners</code> nodes leave in quick succession, some entries will be lost,
so we say that a distributed cache tolerates <code>numOwners - 1</code> node failures.</p>
</div>
<div class="paragraph">
<p>The number of copies represents a trade-off between performance and durability of data.
The more copies you maintain, the lower performance will be, but also the lower the risk
of losing data due to server or network failures.
Regardless of how many copies are maintained, distribution still scales linearly, and
this is key to Infinispan&#8217;s scalability.</p>
</div>
<div class="paragraph">
<p>The owners of a key are split into one <strong>primary owner</strong>, which coordinates writes to the
key, and zero or more <strong>backup owners</strong>.
To find more about how primary and backup owners are assigned, please read the
<a href="#key_ownership">Key Ownership</a> section.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/clustering-distributed.svg" alt="clustering distributed">
</div>
<div class="title">Figure 4. Distributed mode</div>
</div>
<div class="paragraph">
<p>A read operation will request the value from the primary owner, but if it doesn&#8217;t respond
in a reasonable amount of time, we request the value from the backup owners as well.
(The <code>infinispan.stagger.delay</code> system property, in milliseconds, controls the delay
between requests.)
A read operation may require <code>0</code> messages if the key is present in the local cache,
or up to <code>2 * numOwners</code> messages if all the owners are slow.</p>
</div>
<div class="paragraph">
<p>A write operation will also result in at most <code>2 * numOwners</code> messages: one message from
the originator to the primary owner, <code>numOwners - 1</code> messages from the primary to the
backups, and the corresponding ACK messages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cache topology changes may cause retries and additional messages, both for reads
and for writes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Just as replicated mode, distributed mode can also be synchronous or asynchronous.
And as in replicated mode, asynchronous replication is not recommended because it can
lose updates.
In addition to losing updates, asynchronous distributed caches can also see a stale value
when a thread writes to a key and then immediately reads the same key.</p>
</div>
<div class="paragraph">
<p>Transactional distributed caches use the same kinds of messages as transactional
replicated caches, except lock/prepare/commit/unlock messages are sent only to the
<strong>affected nodes</strong> (all the nodes that own at least one key affected by the transaction)
instead of being broadcast to all the nodes in the cluster.
As an optimization, if the transaction writes to a single key and the originator is the
primary owner of the key, lock messages are not replicated.</p>
</div>
<div class="sect3">
<h4 id="read_consistency"><a class="anchor" href="#read_consistency"></a>6.5.1. Read consistency</h4>
<div class="paragraph">
<p>Even with synchronous replication, distributed caches are not linearizable.
(For transactional caches, we say they do not support serialization/snapshot isolation.)
We can have one thread doing a single put:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cache.get(k) -&gt; v1
cache.put(k, v2)
cache.get(k) -&gt; v2</code></pre>
</div>
</div>
<div class="paragraph">
<p>But another thread might see the values in a different order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cache.get(k) -&gt; v2
cache.get(k) -&gt; v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reason is that read can return the value from <strong>any</strong> owner, depending on how fast
the primary owner replies.
The write is not atomic across all the owners&#8201;&#8212;&#8201;in fact, the primary commits the update
only after it receives a confirmation from the backup.
While the primary is waiting for the confirmation message from the backup, reads from the
backup will see the new value, but reads from the primary will see the old one.</p>
</div>
</div>
<div class="sect3">
<h4 id="key_ownership"><a class="anchor" href="#key_ownership"></a>6.5.2. Key Ownership</h4>
<div class="paragraph">
<p>Distributed caches split entries into a fixed number of segments and assign
each segment to a list of owner nodes. Replicated caches do the same, with the
exception that every node is an owner.</p>
</div>
<div class="paragraph">
<p>The first node in the list of owners is the <strong>primary owner</strong>. The other nodes in
the list are <strong>backup owners</strong>. When the cache topology changes, because a node
joins or leaves the cluster, the segment ownership table is broadcast to every
node. This allows nodes to locate keys without making multicast requests or
maintaining metadata for each key.</p>
</div>
<div class="paragraph">
<p>The <code>numSegments</code> property configures the number of segments available.
However, the number of segments cannot change unless the cluster is restarted.</p>
</div>
<div class="paragraph">
<p>Likewise the key-to-segment mapping cannot change. Keys must always map to the
same segments regardless of cluster topology changes. It is important that the
key-to-segment mapping evenly distributes the number of segments allocated to each node while minimizing the number of segments that must move when the cluster topology changes.</p>
</div>
<div class="paragraph">
<p>You can customize the key-to-segment mapping by configuring a
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/distribution/ch/KeyPartitioner.html">KeyPartitioner</a> or by using the
<a href="#grouping_api">Grouping API</a>.</p>
</div>
<div class="paragraph">
<p>However, Infinispan provides the following implementations:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">SyncConsistentHashFactory</dt>
<dd>
<p>Uses an algorithm based on
<a href="http://en.wikipedia.org/wiki/Consistent_hashing">consistent hashing</a>. Selected by default when server hinting is disabled.</p>
<div class="paragraph">
<p>This implementation always assigns keys to the same nodes in every cache as
long as the cluster is symmetric. In other words, all caches run on all nodes.
This implementation does have some negative points in that the load distribution is slightly uneven. It also moves more segments than strictly necessary on a join or leave.</p>
</div>
</dd>
<dt class="hdlist1">TopologyAwareSyncConsistentHashFactory</dt>
<dd>
<p>Similar to <code>SyncConsistentHashFactory</code>, but adapted for
<a href="#server_hinting">Server Hinting</a>. Selected by default when server hinting is enabled.</p>
</dd>
<dt class="hdlist1">DefaultConsistentHashFactory</dt>
<dd>
<p>Achieves a more even distribution than <code>SyncConsistentHashFactory</code>, but with one
disadvantage. The order in which nodes join the cluster determines which nodes
own which segments. As a result, keys might be assigned to different nodes in
different caches.</p>
<div class="paragraph">
<p>Was the default from version 5.2 to version 8.1 with server hinting disabled.</p>
</div>
</dd>
<dt class="hdlist1">TopologyAwareConsistentHashFactory</dt>
<dd>
<p>Similar to <em>DefaultConsistentHashFactory</em>, but adapted for
<a href="#server_hinting">Server Hinting</a>.</p>
<div class="paragraph">
<p>Was the default from version 5.2 to version 8.1 with server hinting enabled.</p>
</div>
</dd>
<dt class="hdlist1">ReplicatedConsistentHashFactory</dt>
<dd>
<p>Used internally to implement replicated caches. You should never explicitly
select this algorithm in a distributed cache.</p>
</dd>
</dl>
</div>
<div class="sect4">
<h5 id="capacity_factors"><a class="anchor" href="#capacity_factors"></a>Capacity Factors</h5>
<div class="paragraph">
<p>Capacity factors allocate segment-to-node mappings based on resources available
to nodes.</p>
</div>
<div class="paragraph">
<p>To configure capacity factors, you specify any non-negative number and the
Infinispan hashing algorithm assigns each node a load weighted by its
capacity factor (both as a primary owner and as a backup owner).</p>
</div>
<div class="paragraph">
<p>For example, nodeA has 2x the memory available than nodeB in the same
Infinispan cluster. In this case, setting <code>capacityFactor</code> to a value of <code>2</code>
configures Infinispan to allocate 2x the number of segments to nodeA.</p>
</div>
<div class="paragraph">
<p>Setting a capacity factor of <code>0</code> is possible but is recommended only in cases
where nodes are not joined to the cluster long enough to be useful data owners.</p>
</div>
</div>
<div class="sect4">
<h5 id="zero_capacity_node"><a class="anchor" href="#zero_capacity_node"></a>Zero Capacity Node</h5>
<div class="paragraph">
<p>You might need to configure a whole node where the capacity factor is <code>0</code> for every cache,
user defined caches and internal caches.
When defining a zero capacity node, the node won&#8217;t hold any data.
This is how you declare a zero capacity node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">   <span class="tag">&lt;cache-container</span> <span class="attribute-name">zero-capacity-node</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> GlobalConfigurationBuilder().zeroCapacityNode(<span class="predefined-constant">true</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, note that this will be true for distributed caches only. If you are using replicated
caches, the node will still keep a copy of the value. Use only distributed caches to make the
best use of this feature.</p>
</div>
</div>
<div class="sect4">
<h5 id="hashing_configuration"><a class="anchor" href="#hashing_configuration"></a>Hashing Configuration</h5>
<div class="paragraph">
<p>This is how you configure hashing declaratively, via XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">   <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">distributedCache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">segments</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">capacity-factor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And this is how you can configure it programmatically, in Java:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering()
      .cacheMode(CacheMode.DIST_SYNC)
      .hash()
         .numOwners(<span class="integer">2</span>)
         .numSegments(<span class="integer">100</span>)
         .capacityFactor(<span class="integer">2</span>)
   .build();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="initial_cluster_size"><a class="anchor" href="#initial_cluster_size"></a>6.5.3. Initial cluster size</h4>
<div class="paragraph">
<p>Infinispan&#8217;s very dynamic nature in handling topology changes (i.e. nodes being added / removed
at runtime) means that, normally, a node doesn&#8217;t wait for the presence of other nodes before
starting. While this is very flexible, it might not be suitable for applications which require
a specific number of nodes to join the cluster before caches are started. For this reason,
you can specify how many nodes should have joined the cluster before proceeding with cache
initialization. To do this, use the <code>initialClusterSize</code> and <code>initialClusterTimeout</code> transport
properties. The declarative XML configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">   <span class="tag">&lt;transport</span> <span class="attribute-name">initial-cluster-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-cluster-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The programmatic Java configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration global = <span class="keyword">new</span> GlobalConfigurationBuilder()
   .transport()
       .initialClusterSize(<span class="integer">4</span>)
       .initialClusterTimeout(<span class="integer">30000</span>)
   .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration will wait for <em>4</em> nodes to join the cluster before initialization. If
the initial nodes do not appear within the specified timeout, the cache manager will fail to
start.</p>
</div>
</div>
<div class="sect3">
<h4 id="l1_caching"><a class="anchor" href="#l1_caching"></a>6.5.4. L1 Caching</h4>
<div class="paragraph">
<p>When L1 is enabled, a node will keep the result of remote reads locally for a short
period of time (configurable, 10 minutes by default), and repeated lookups will return
the local L1 value instead of asking the owners again.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/clustering-l1.svg" alt="clustering l1">
</div>
<div class="title">Figure 5. L1 caching</div>
</div>
<div class="paragraph">
<p>L1 caching is not free though.
Enabling it comes at a cost, and this cost is that every entry update must broadcast an
invalidation message to all the nodes.
L1 entries can be evicted just like any other entry when the the cache is configured
with a maximum size.
Enabling L1 will improve performance for repeated reads of non-local keys, but it will
slow down writes and it will increase memory consumption to some degree.</p>
</div>
<div class="paragraph">
<p>Is L1 caching right for you?
The correct approach is to benchmark your application with and without L1 enabled and see
what works best for your access pattern.</p>
</div>
</div>
<div class="sect3">
<h4 id="server_hinting"><a class="anchor" href="#server_hinting"></a>6.5.5. Server Hinting</h4>
<div class="paragraph">
<p>The following topology hints can be specified:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Machine</dt>
<dd>
<p>This is probably the most useful, when multiple JVM instances run on the
same node, or even when multiple virtual machines run on the same physical machine.</p>
</dd>
<dt class="hdlist1">Rack</dt>
<dd>
<p>In larger clusters, nodes located on the same rack are more likely to experience a
hardware or network failure at the same time.</p>
</dd>
<dt class="hdlist1">Site</dt>
<dd>
<p>Some clusters may have nodes in multiple physical locations for extra resilience.
Note that <a href="#x_site_replication">Cross site replication</a> is another alternative for
clusters that need to span two or more data centres.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>All of the above are optional.
When provided, the distribution algorithm will try to spread the ownership of each
segment across as many sites, racks, and machines (in this order) as possible.</p>
</div>
<div class="sect4">
<h5 id="configuration_6"><a class="anchor" href="#configuration_6"></a>Configuration</h5>
<div class="paragraph">
<p>The hints are configured at transport level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;transport</span>
    <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MyCluster</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">machine</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LinuxServer01</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">rack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Rack01</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">US-WestCoast</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="key_affinity_service"><a class="anchor" href="#key_affinity_service"></a>6.5.6. Key affinity service</h4>
<div class="paragraph">
<p>In a distributed cache, a key is allocated to a list of nodes with an opaque algorithm.
There is no easy way to reverse the computation and generate a key that maps to a
particular node.
However, we can generate a sequence of (pseudo-)random keys, see what their primary
owner is, and hand them out to the application when it needs a key mapping to a
particular node.</p>
</div>
<div class="sect4">
<h5 id="api"><a class="anchor" href="#api"></a>API</h5>
<div class="paragraph">
<p>Following code snippet depicts how a reference to this service can be obtained and used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// 1. Obtain a reference to a cache</span>
Cache cache = ...
Address address = cache.getCacheManager().getAddress();

<span class="comment">// 2. Create the affinity service</span>
KeyAffinityService keyAffinityService = KeyAffinityServiceFactory.newLocalKeyAffinityService(
      cache,
      <span class="keyword">new</span> RndKeyGenerator(),
      <span class="predefined-type">Executors</span>.newSingleThreadExecutor(),
      <span class="integer">100</span>);

<span class="comment">// 3. Obtain a key for which the local node is the primary owner</span>
<span class="predefined-type">Object</span> localKey = keyAffinityService.getKeyForAddress(address);

<span class="comment">// 4. Insert the key in the cache</span>
cache.put(localKey, <span class="string"><span class="delimiter">&quot;</span><span class="content">yourValue</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service is started at step 2: after this point it uses the supplied <em>Executor</em> to
generate and queue keys.
At step 3, we obtain a key from the service, and at step 4 we use it.</p>
</div>
</div>
<div class="sect4">
<h5 id="lifecycle"><a class="anchor" href="#lifecycle"></a>Lifecycle</h5>
<div class="paragraph">
<p><code>KeyAffinityService</code> extends <code>Lifecycle</code>, which allows stopping and (re)starting it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Lifecycle</span> {
<span class="error"></span><span class="error"></span> <span class="type">void</span> start();
<span class="error"></span><span class="error"></span> <span class="type">void</span> stop();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service is instantiated through <code>KeyAffinityServiceFactory</code>. All the factory methods
have an <code>Executor</code> parameter, that is used for asynchronous key generation (so that it
won&#8217;t happen in the caller&#8217;s thread).
It is the user&#8217;s responsibility to handle the shutdown of this <code>Executor</code>.</p>
</div>
<div class="paragraph">
<p>The <code>KeyAffinityService</code>, once started, needs to be explicitly stopped. This stops the
background key generation and releases other held resources.</p>
</div>
<div class="paragraph">
<p>The only situation in which <code>KeyAffinityService</code> stops by itself is when the cache manager
with which it was registered is shutdown.</p>
</div>
</div>
<div class="sect4">
<h5 id="topology_changes"><a class="anchor" href="#topology_changes"></a>Topology changes</h5>
<div class="paragraph">
<p>When the cache topology changes (i.e. nodes join or leave the cluster), the ownership of
the keys generated by the <code>KeyAffinityService</code> might change.
The key affinity service keep tracks of these topology changes and doesn&#8217;t return keys
that would currently map to a different node, but it won&#8217;t do anything about keys
generated earlier.</p>
</div>
<div class="paragraph">
<p>As such, applications should treat <code>KeyAffinityService</code> purely as an optimization, and
they should not rely on the location of a generated key for correctness.</p>
</div>
<div class="paragraph">
<p>In particular, applications should not rely on keys generated by <code>KeyAffinityService</code>
for the same address to always be located together.
Collocation of keys is only provided by the <a href="#grouping_api">Grouping API</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="grouping_api"><a class="anchor" href="#grouping_api"></a>6.5.7. The Grouping API</h4>
<div class="paragraph">
<p>Complementary to <a href="#key_affinity_service">Key affinity service</a> and similar to
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/atomic/AtomicMap.html">AtomicMap</a>,
the grouping API allows you to co-locate a group of entries on the same nodes, but without
being able to select the actual nodes.</p>
</div>
<div class="sect4">
<h5 id="how_does_it_work"><a class="anchor" href="#how_does_it_work"></a>How does it work?</h5>
<div class="paragraph">
<p>By default, the segment of a key is computed using the key&#8217;s <code>hashCode()</code>.
If you use the grouping API, Infinispan will compute the segment of the group and use
that as the segment of the key.
See the <a href="#key_ownership">Key Ownership</a> section for more details on how segments are
then mapped to nodes.</p>
</div>
<div class="paragraph">
<p>When the group API is in use, it is important that every node can still compute the
owners of every key without contacting other nodes.
For this reason, the group cannot be specified manually.
The group can either be intrinsic to the entry (generated by the key class) or extrinsic
(generated by an external function).</p>
</div>
</div>
<div class="sect4">
<h5 id="how_do_i_use_the_grouping_api"><a class="anchor" href="#how_do_i_use_the_grouping_api"></a>How do I use the grouping API?</h5>
<div class="paragraph">
<p>First, you must enable groups. If you are configuring Infinispan programmatically, then call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering().hash().groups().enabled()
   .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, if you are using XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache&gt;</span>
 <span class="tag">&lt;groups</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have control of the key class (you can alter the class definition, it&#8217;s not part of
an unmodifiable library), then we recommend using an intrinsic group.
The intrinsic group is specified by adding the <code>@Group</code> annotation to a method.
Let&#8217;s take a look at an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">User</span> {
   ...
   String office;
   ...

   public <span class="type">int</span> hashCode() {
      <span class="comment">// Defines the hash for the key, normally used to determine location</span>
      ...
   }

   <span class="comment">// Override the location by specifying a group</span>
   <span class="comment">// All keys in the same group end up with the same owners</span>
   <span class="annotation">@Group</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> getOffice() {
      <span class="keyword">return</span> office;
   }
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The group method must return a <code>String</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you don&#8217;t have control over the key class, or the determination of the group is an
orthogonal concern to the key class, we recommend using an extrinsic group.
An extrinsic group is specified by implementing the <code>Grouper</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Grouper</span>&lt;T&gt; {
    <span class="predefined-type">String</span> computeGroup(T key, <span class="predefined-type">String</span> group);

    <span class="predefined-type">Class</span>&lt;T&gt; getKeyType();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If multiple <code>Grouper</code> classes are configured for the same key type, all of them will be
called, receiving the value computed by the previous one.
If the key class also has a <code>@Group</code> annotation, the first <code>Grouper</code> will receive the
group computed by the annotated method.
This allows you even greater control over the group when using an intrinsic group.
Let&#8217;s take a look at an example <code>Grouper</code> implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">KXGrouper</span> <span class="directive">implements</span> Grouper&lt;<span class="predefined-type">String</span>&gt; {

   <span class="comment">// The pattern requires a String key, of length 2, where the first character is</span>
   <span class="comment">// &quot;k&quot; and the second character is a digit. We take that digit, and perform</span>
   <span class="comment">// modular arithmetic on it to assign it to group &quot;0&quot; or group &quot;1&quot;.</span>
   <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">Pattern</span> kPattern = <span class="predefined-type">Pattern</span>.compile(<span class="string"><span class="delimiter">&quot;</span><span class="content">(^k)(&lt;a&gt;</span><span class="char">\\</span><span class="content">d&lt;/a&gt;)$</span><span class="delimiter">&quot;</span></span>);

   <span class="directive">public</span> <span class="predefined-type">String</span> computeGroup(<span class="predefined-type">String</span> key, <span class="predefined-type">String</span> group) {
      <span class="predefined-type">Matcher</span> matcher = kPattern.matcher(key);
      <span class="keyword">if</span> (matcher.matches()) {
         <span class="predefined-type">String</span> g = <span class="predefined-type">Integer</span>.parseInt(matcher.group(<span class="integer">2</span>)) % <span class="integer">2</span> + <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
         <span class="keyword">return</span> g;
      } <span class="keyword">else</span> {
         <span class="keyword">return</span> <span class="predefined-constant">null</span>;
      }
   }

   <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;<span class="predefined-type">String</span>&gt; getKeyType() {
      <span class="keyword">return</span> <span class="predefined-type">String</span>.class;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Grouper</code> implementations must be registered explicitly in the cache configuration.
If you are configuring Infinispan programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering().hash().groups().enabled().addGrouper(<span class="keyword">new</span> KXGrouper())
   .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, if you are using XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache&gt;</span>
   <span class="tag">&lt;groups</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;grouper</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.KXGrouper</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/groups&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="advanced_interface"><a class="anchor" href="#advanced_interface"></a>Advanced Interface</h5>
<div class="paragraph">
<p><code>AdvancedCache</code> has two group-specific methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/AdvancedCache.html#getGroup-java.lang.String-">getGroup(groupName)</a></dt>
<dd>
<p>Retrieves all keys in the cache that belong to a group.</p>
</dd>
<dt class="hdlist1"><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/AdvancedCache.html#removeGroup-java.lang.String-">removeGroup(groupName)</a></dt>
<dd>
<p>Removes all the keys in the cache that belong to a group.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Both methods iterate over the entire data container and store (if present), so they can
be slow when a cache contains lots of small groups.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scattered_mode"><a class="anchor" href="#scattered_mode"></a>6.6. Scattered Mode</h3>
<div class="paragraph">
<p>Scattered mode is very similar to Distribution Mode as it allows linear scaling of the cluster.
It allows single node failure by maintaining two copies of the data (as Distribution Mode with numOwners=2).
Unlike Distributed, the location of data is not fixed; while we use the same Consistent Hash algorithm
to locate the primary owner, the backup copy is stored on the node that wrote the data last time.
When the write originates on the primary owner, backup copy is stored on any other node (the exact location
of this copy is not important).</p>
</div>
<div class="paragraph">
<p>This has the advantage of single RPC for any write (Distribution Mode requires one or two RPCs), but reads
have to always target the primary owner. That results in faster writes but possibly slower reads, and therefore this
mode is more suitable for write-intensive applications.</p>
</div>
<div class="paragraph">
<p>Storing multiple backup copies also results in slightly higher memory consumption. In order to remove out-of-date
backup copies, invalidation messages are broadcast in the cluster, which generates some overhead. This makes
scattered mode less performant in very big clusters (this behaviour might be optimized in the future).</p>
</div>
<div class="paragraph">
<p>When a node crashes, the primary copy may be lost. Therefore, the cluster has to reconcile the backups
and find out the last written backup copy. This process results in more network traffic during state transfer.</p>
</div>
<div class="paragraph">
<p>Since the writer of data is also a backup, even if we specify machine/rack/site ids on the transport level the cluster
cannot be resilient to more than one failure on the same machine/rack/site.</p>
</div>
<div class="paragraph">
<p>Currently it is not possible to use scattered mode in transactional cache. Asynchronous replication
is not supported either; use asynchronous Cache API instead. Functional commands are not implemented neither
but these are expected to be added soon.</p>
</div>
<div class="paragraph">
<p>The cache is configured in a similar way as the other cache modes, here is an example of declarative configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">   <span class="tag">&lt;scattered-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">scatteredCache</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And this is how you can configure it programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering().cacheMode(CacheMode.SCATTERED_SYNC)
   .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Scattered mode is not exposed in the server configuration as the server is usually accessed through the Hot Rod
protocol. The protocol automatically selects primary owner for the writes and therefore the write (in distributed
mode with two owner) requires single RPC inside the cluster, too. Therefore, scattered cache would not bring
the performance benefit.</p>
</div>
</div>
<div class="sect2">
<h3 id="asynchronous_options"><a class="anchor" href="#asynchronous_options"></a>6.7. Asynchronous Options</h3>
<div class="sect3">
<h4 id="asynchronous_communications"><a class="anchor" href="#asynchronous_communications"></a>6.7.1. Asynchronous Communications</h4>
<div class="paragraph">
<p>All clustered cache modes can be configured to use asynchronous communications with the
<a href="https://docs.jboss.org/infinispan/9.4/configdocs/"><code>mode="ASYNC"</code></a>
attribute on the <code>&lt;replicated-cache/&gt;</code>, <code>&lt;distributed-cache&gt;</code>, or <code>&lt;invalidation-cache/&gt;</code>
element.</p>
</div>
<div class="paragraph">
<p>With asynchronous communications, the originator node does not receive any
acknowledgement from the other nodes about the status of the operation, so there is no
way to check if it succeeded on other nodes.</p>
</div>
<div class="paragraph">
<p>We do not recommend asynchronous communications in general, as they can cause
inconsistencies in the data, and the results are hard to reason about.
Nevertheless, sometimes speed is more important than consistency, and the option is
available for those cases.</p>
</div>
</div>
<div class="sect3">
<h4 id="asynchronous_api"><a class="anchor" href="#asynchronous_api"></a>6.7.2. Asynchronous API</h4>
<div class="paragraph">
<p>The Asynchronous API allows you to use synchronous communications,
but without blocking the user thread.</p>
</div>
<div class="paragraph">
<p>There is one caveat:
The asynchronous operations do NOT preserve the program order.
If a thread calls <code>cache.putAsync(k, v1); cache.putAsync(k, v2)</code>, the final value of <code>k</code>
may be either <code>v1</code> or <code>v2</code>.
The advantage over using asynchronous communications is that the final value can&#8217;t be
<code>v1</code> on one node and <code>v2</code> on another.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Prior to version 9.0, the asynchronous API was emulated by borrowing a thread from
an internal thread pool and running a blocking operation on that thread.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="return_values"><a class="anchor" href="#return_values"></a>6.7.3. Return Values</h4>
<div class="paragraph">
<p>Because the <code>Cache</code> interface extends <code>java.util.Map</code>, write methods like
<code>put(key, value)</code> and <code>remove(key)</code> return the previous value by default.</p>
</div>
<div class="paragraph">
<p>In some cases, the return value may not be correct:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When using <code>AdvancedCache.withFlags()</code> with <code>Flag.IGNORE_RETURN_VALUE</code>,
<code>Flag.SKIP_REMOTE_LOOKUP</code>, or <code>Flag.SKIP_CACHE_LOAD</code>.</p>
</li>
<li>
<p>When the cache is configured with <code>unreliable-return-values="true"</code>.</p>
</li>
<li>
<p>When using asynchronous communications.</p>
</li>
<li>
<p>When there are multiple concurrent writes to the same key, and the cache topology
changes.
The topology change will make Infinispan retry the write operations, and a retried
operation&#8217;s return value is not reliable.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Transactional caches return the correct previous value in cases 3 and 4.
However, transactional caches also have a gotcha: in distributed mode, the
read-committed isolation level is implemented as repeatable-read.
That means this example of "double-checked locking" won&#8217;t work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache cache = ...
TransactionManager tm = ...

tm.begin();
<span class="keyword">try</span> {
   <span class="predefined-type">Integer</span> v1 = cache.get(k);
   <span class="comment">// Increment the value</span>
   <span class="predefined-type">Integer</span> v2 = cache.put(k, v1 + <span class="integer">1</span>);
   <span class="keyword">if</span> (Objects.equals(v1, v2) {
      <span class="comment">// success</span>
   } <span class="keyword">else</span> {
      <span class="comment">// retry</span>
   }
} <span class="keyword">finally</span> {
  tm.commit();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The correct way to implement this is to use
<code>cache.getAdvancedCache().withFlags(Flag.FORCE_WRITE_LOCK).get(k)</code>.</p>
</div>
<div class="paragraph">
<p>In caches with optimistic locking, writes can also return stale previous values. Write skew checks can avoid stale previous values. For more information, see <a href="#tx_write_skew">Write Skews</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="partition_handling"><a class="anchor" href="#partition_handling"></a>6.8. Partition handling</h3>
<div class="paragraph">
<p>An Infinispan cluster is built out of a number of nodes where data is stored. In order
not to lose data in the presence of node failures, Infinispan copies the same data&#8201;&#8212;&#8201;cache
entry in Infinispan parlance&#8201;&#8212;&#8201;over multiple nodes. This level of data redundancy is
configured through the <code>numOwners</code> configuration attribute and ensures that as long as
fewer than <code>numOwners</code> nodes crash simultaneously, Infinispan has a copy of the data
available.</p>
</div>
<div class="paragraph">
<p>However, there might be catastrophic situations in which more than <code>numOwners</code> nodes
disappear from the cluster:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Split brain</dt>
<dd>
<p>Caused e.g. by a router crash, this splits the cluster in two or more
partitions, or sub-clusters that operate independently. In these circumstances,
multiple clients reading/writing from different partitions see different versions
of the same cache entry, which for many application is problematic. Note there are
ways to alleviate the possibility for the split brain to happen, such as redundant networks or
 <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/s2-networkscripts-interfaces-chan.html">IP bonding</a>.
 These only reduce the window of time for the problem to occur, though.</p>
</dd>
<dt class="hdlist1"><code>numOwners</code> nodes crash in sequence</dt>
<dd>
<p>When at least <code>numOwners</code> nodes crash in rapid
succession and Infinispan does not have the time to properly rebalance its state between
crashes, the result is partial data loss.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The partition handling functionality discussed in this section allows the user to configure what operations can be
performed on a cache in the event of a split brain occurring. Infinispan provides multiple partition handling strategies,
which in terms of Brewer&#8217;s <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a> determine whether availability or
consistency is sacrificed in the presence of partition(s). Below is a list of the provided strategies:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strategy</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">CAP</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DENY_READ_WRITES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the partition does not have all owners for a given segment, both reads and writes are denied for all keys in that segment.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Consistency</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALLOW_READS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows reads for a given key if it exists in this partition, but only allows writes if this partition contains all owners of a segment.
This is still a consistent approach because some entries are readable if available in this partition, but from a client application perspective it is not deterministic.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Consistency</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALLOW_READ_WRITES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allow entries on each partition to diverge, with conflict resolution attempted upon the partitions merging.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Availability</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The requirements of your application should determine which strategy is appropriate. For example, DENY_READ_WRITES is more
appropriate for applications that have high consistency requirements; i.e. when the data read from the system must be accurate.
Whereas if Infinispan is used as a best-effort cache, partitions maybe perfectly tolerable and the ALLOW_READ_WRITES might
be more appropriate as it favours availability over consistency.</p>
</div>
<div class="paragraph">
<p>The following sections describe how Infinispan handles <a href="#split_brain">split brain</a> and <a href="#successive_node_failures">successive failures</a> for each of the partition handling strategies. This is followed by a section
describing how Infinispan allows for automatic conflict resolution upon partition merges via <a href="#merge_policies">merge policies</a>.
Finally, we provide a section describing <a href="#partition_handling_configuration">how to configure partition handling strategies and merge policies</a>.</p>
</div>
<div class="sect3">
<h4 id="split_brain"><a class="anchor" href="#split_brain"></a>6.8.1. Split brain</h4>
<div class="paragraph">
<p>In a split brain situation, each network partition will install its own
JGroups view, removing the nodes from the other partition(s).
We don&#8217;t have a direct way of determining whether the has been split into
two or more partitions, since the partitions are unaware of each other.
Instead, we assume the cluster has split when one or more nodes
disappear from the JGroups cluster without sending an explicit leave message.</p>
</div>
<div class="sect4">
<h5 id="split_strategies"><a class="anchor" href="#split_strategies"></a>Split Strategies</h5>
<div class="paragraph">
<p>In this section, we detail how each partition handling strategy behaves in the event of split brain occurring.</p>
</div>
<div class="sect5">
<h6 id="allow_read_writes"><a class="anchor" href="#allow_read_writes"></a>ALLOW_READ_WRITES</h6>
<div class="paragraph">
<p>Each partition continues to function as an independent cluster, with all partitions remaining in AVAILABLE mode.
This means that each partition may only see a part of the data, and each partition could write conflicting updates in
the cache. During a partition merge these conflicts are automatically resolved by utilising the <a href="#conflict_manager">ConflictManager</a>
and the configured <a href="#merge_policies">EntryMergePolicy</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="deny_read_writes"><a class="anchor" href="#deny_read_writes"></a>DENY_READ_WRITES</h6>
<div class="paragraph">
<p>When a split is detected each partition does not start a rebalance immediately, but first it checks whether it should
enter <strong>DEGRADED</strong> mode instead:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If at least one segment has lost all its owners (meaning at least
<em>numOwners</em> nodes left since the last rebalance ended), the partition enters
DEGRADED mode.</p>
</li>
<li>
<p>If the partition does not contain a simple majority of the nodes (floor(numNodes/2) + 1)
in the <em>latest stable topology</em>, the partition also enters DEGRADED mode.</p>
</li>
<li>
<p>Otherwise the partition keeps functioning normally, and it starts a rebalance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <em>stable topology</em> is updated every time a rebalance operation ends and the coordinator determines
that another rebalance is not necessary.</p>
</div>
<div class="paragraph">
<p>These rules ensures that at most one partition stays in AVAILABLE mode, and
the other partitions enter DEGRADED mode.</p>
</div>
<div class="paragraph">
<p>When a partition is in DEGRADED mode, it only allows access to the keys that are wholly owned:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Requests (reads and writes) for entries that have all the copies on nodes within
this partition are honoured.</p>
</li>
<li>
<p>Requests for entries that are partially or totally owned by nodes that disappeared
are rejected with an <code>AvailabilityException</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This guarantees that partitions cannot write different values for the same key
(cache is consistent), and also that one partition can not read keys that have been
updated in the other partitions (no stale data).</p>
</div>
<div class="paragraph">
<p>To exemplify, consider the initial cluster <code>M = {A, B, C, D}</code>, configured in distributed
mode with <code>numOwners = 2</code>.
Further on, consider three keys <code>k1</code>, <code>k2</code> and <code>k3</code> (that might exist in the cache or not)
such that <code>owners(k1) = {A,B}</code>, <code>owners(k2) = {B,C}</code> and <code>owners(k3) = {C,D}</code>.
Then the network splits in two partitions, <code>N1 = {A, B}</code> and <code>N2 = {C, D}</code>, they enter
DEGRADED mode and behave like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>on <code>N1</code>, <code>k1</code> is available for read/write, <code>k2</code> (partially owned) and <code>k3</code> (not owned)
are not available and accessing them results in an <code>AvailabilityException</code></p>
</li>
<li>
<p>on <code>N2</code>, <code>k1</code> and <code>k2</code> are not available for read/write, <code>k3</code> is available</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A relevant aspect of the partition handling process is the fact that when a
split brain happens, the resulting partitions rely on the original segment
mapping (the one that existed before the split brain) in order
to calculate key ownership. So it doesn&#8217;t matter if <code>k1</code>, <code>k2</code>, or <code>k3</code> already
existed cache or not, their availability is the same.</p>
</div>
<div class="paragraph">
<p>If at a further point in time the network heals and <code>N1</code> and <code>N2</code> partitions
merge back together into the initial cluster <code>M</code>, then <code>M</code> exits the degraded
mode and becomes fully available again. During this merge operation, because
<code>M</code> has once again become fully available, the <a href="#conflict_manager">ConflictManager</a>
and the configured <a href="#merge_policies">EntryMergePolicy</a> are used to check for
any conflicts that may have occurred in the interim period between the split
brain occurring and being detected.</p>
</div>
<div class="paragraph">
<p>As another example, the cluster could split in two partitions <code>O1 = {A, B, C}</code>
and <code>O2 = {D}</code>, partition <code>O1</code> will stay fully
available (rebalancing cache entries on the remaining members).
Partition <code>O2</code>, however, will detect a split and enter the degraded mode.
Since it doesn&#8217;t have any fully owned keys, it will reject any read or write
operation with an <code>AvailabilityException</code>.</p>
</div>
<div class="paragraph">
<p>If afterwards partitions <code>O1</code> and <code>O2</code> merge back into <code>M</code>, then the <a href="#conflict_manager">ConflictManager</a>
attempts to resolve any conflicts and <code>D</code> once again becomes fully available.</p>
</div>
</div>
<div class="sect5">
<h6 id="allow_reads"><a class="anchor" href="#allow_reads"></a>ALLOW_READS</h6>
<div class="paragraph">
<p>Partitions are handled in the same manner as DENY_READ_WRITES, except that when a partition is in DEGRADED mode read
operations on a partially owned key WILL not throw an AvailabilityException.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="current_limitations_2"><a class="anchor" href="#current_limitations_2"></a>Current limitations</h5>
<div class="paragraph">
<p>Two partitions could start up isolated, and as long as they don&#8217;t merge they
can read and write inconsistent data. In the future, we will allow custom
availability strategies (e.g. check that a certain node is part of the cluster,
or check that an external machine is accessible) that could handle that
situation as well.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="successive_node_failures"><a class="anchor" href="#successive_node_failures"></a>6.8.2. Successive nodes stopped</h4>
<div class="paragraph">
<p>As mentioned in the previous section, Infinispan can&#8217;t detect whether a node
left the JGroups view because of a process/machine crash, or because of a
network failure: whenever a node leaves the JGroups cluster abruptly, it is
assumed to be because of a network problem.</p>
</div>
<div class="paragraph">
<p>If the configured number of copies (<code>numOwners</code>) is greater than 1, the
cluster can remain available and will try to make new replicas of the data
on the crashed node. However, other nodes might crash during the rebalance process.
If more than <code>numOwners</code> nodes crash in a short interval of time, there is a
chance that some cache entries have disappeared from the cluster altogether.
In this case, with the DENY_READ_WRITES or ALLOW_READS strategy enabled, Infinispan
assumes (incorrectly) that there is a split brain and enters DEGRADED mode
as described in the split-brain section.</p>
</div>
<div class="paragraph">
<p>The administrator can also shut down more than <code>numOwners</code> nodes in
rapid succession, causing the loss of the data stored only on those nodes.
When the administrator shuts down a node gracefully, Infinispan knows that
the node can&#8217;t come back.
However, the cluster doesn&#8217;t keep track of how each node left, and the cache
still enters DEGRADED mode as if those nodes had crashed.</p>
</div>
<div class="paragraph">
<p>At this stage there is no way for the cluster to recover its state,
except stopping it and repopulating it on restart with the data from an
external source.
Clusters are expected to be configured with an appropriate <code>numOwners</code> in
order to avoid <code>numOwners</code> successive node failures, so this situation
should be pretty rare.
If the application can handle losing some of the data in the cache, the
administrator can force the availability mode back to AVAILABLE via JMX.</p>
</div>
</div>
<div class="sect3">
<h4 id="conflict_manager"><a class="anchor" href="#conflict_manager"></a>6.8.3. Conflict Manager</h4>
<div class="paragraph">
<p>The conflict manager is a tool that allows users to retrieve all stored replica values for a given key. In addition to
allowing users to process a stream of cache entries whose stored replicas have conflicting values. Furthermore, by
utilising implementations of the <a href="#merge_policies">EntryMergePolicy</a> interface it is possible for said conflicts to
be resolved automatically.</p>
</div>
<div class="sect4">
<h5 id="detecting_conflicts"><a class="anchor" href="#detecting_conflicts"></a>Detecting Conflicts</h5>
<div class="paragraph">
<p>Conflicts are detected by retrieving each of the stored values for a given key. The conflict manager retrieves the value stored
from each of the key&#8217;s write owners defined by the current consistent hash. The .equals method of the stored values is
then used to determine whether all values are equal. If all values are equal then no conflicts exist for the key, otherwise
a conflict has occurred. Note that null values are returned if no entry exists on a given node, therefore we deem a conflict
to have occurred if both a null and non-null value exists for a given key.</p>
</div>
</div>
<div class="sect4">
<h5 id="merge_policies"><a class="anchor" href="#merge_policies"></a>Merge Policies</h5>
<div class="paragraph">
<p>In the event of conflicts arising between one or more replicas of a given CacheEntry, it is necessary for a conflict
resolution algorithm to be defined, therefore we provide the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/conflict/EntryMergePolicy.html">EntryMergePolicy</a> interface. This interface consists
of a single method, "merge", whose returned CacheEntry is utilised as the "resolved" entry for a given key. When a non-null
CacheEntry is returned, this entries value is "put" to all replicas in the cache. However when the merge implementation
returns a null value, all replicas associated with the conflicting key are removed from the cache.</p>
</div>
<div class="paragraph">
<p>The merge method takes two parameters: the "preferredEntry" and "otherEntries". In the context of a partition merge,
the preferredEntry is the primary replica of a CacheEntry stored in the partition that contains the most nodes or if
partitions are equal the one with the largest topologyId. In the event of overlapping partitions, i.e. a node A is
present in the topology of both partitions {A}, {A,B,C}, we pick {A} as the preferred partition as it will have the higher
topologId as the other partition&#8217;s topology is behind. When a partition merge is not occurring, the "preferredEntry" is
simply the primary replica of the CacheEntry. The second parameter, "otherEntries" is simply a list of all other entries
associated with the key for which a conflict was detected.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
EntryMergePolicy::merge is only called when a conflict has been detected, it is not called if all CacheEntrys are
the same.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Currently Infinispan provides the following implementations of EntryMergePolicy:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Policy</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.NONE (default)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No attempt is made to resolve conflicts. Entries hosted on the minority partition are removed and the nodes
  in this partition do not hold any data until the rebalance starts. Note, this behaviour is equivalent to prior Infinispan
  versions which did not support conflict resolution.
  Note, in this case all changes made to entries hosted on the minority partition are lost, but once the rebalance has
  finished all entries will be consistent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.PREFERRED_ALWAYS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Always utilise the "preferredEntry". MergePolicy.NONE is almost equivalent to PREFERRED_ALWAYS, albeit without the
  performance impact of performing conflict resolution, therefore MergePolicy.NONE should be chosen unless the following
  scenario is a concern. When utilising the DENY_READ_WRITES or DENY_READ strategy, it is possible for a write operation
  to only partially complete when the partitions enter DEGRADED mode, resulting in replicas containing inconsistent values.
  MergePolicy.PREFERRED_ALWAYS will detect said inconsistency and resolve it, whereas with MergePolicy.NONE the CacheEntry
  replicas will remain inconsistent after the cluster has rebalanced.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.PREFERRED_NON_NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Utilise the "preferredEntry" if it is non-null, otherwise utilise the first entry from "otherEntries".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.REMOVE_ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Always remove a key from the cache when a conflict is detected.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fully qualified class name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The custom implementation for merge will be used <a href="#partition_handling_custom_merge_policy">Custom merge policy</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="conflict_manager_usage"><a class="anchor" href="#conflict_manager_usage"></a>6.8.4. Usage</h4>
<div class="paragraph">
<p>During a partition merge the ConflictManager automatically attempts to resolve conflicts utilising the configured
EntryMergePolicy, however it is also possible to manually search for/resolve conflicts as required by your application.</p>
</div>
<div class="paragraph">
<p>The code below shows how to retrieve an EmbeddedCacheManager&#8217;s ConflictManager, how to retrieve all versions of a given
key and how to check for conflicts across a given cache.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">example-config.xml</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">testCache</span><span class="delimiter">&quot;</span></span>);
ConflictManager&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; crm = ConflictManagerFactory.get(cache.getAdvancedCache());

<span class="comment">// Get All Versions of Key</span>
<span class="predefined-type">Map</span>&lt;Address, InternalCacheValue&lt;<span class="predefined-type">String</span>&gt;&gt; versions = crm.getAllVersions(<span class="integer">1</span>);

<span class="comment">// Process conflicts stream and perform some operation on the cache</span>
Stream&lt;<span class="predefined-type">Map</span>&lt;Address, InternalCacheEntry&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;&gt;&gt; stream = crm.getConflicts();
stream.forEach(map -&gt; {
   CacheEntry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; entry = map.values().iterator().next();
   <span class="predefined-type">Object</span> conflictKey = entry.getKey();
   cache.remove(conflictKey);
});

<span class="comment">// Detect and then resolve conflicts using the configured EntryMergePolicy</span>
crm.resolveConflicts();

<span class="comment">// Detect and then resolve conflicts using the passed EntryMergePolicy instance</span>
crm.resolveConflicts((preferredEntry, otherEntries) -&gt; preferredEntry);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Although the <code>ConflictManager::getConflicts</code> stream is processed per entry, the underlying spliterator is in
fact lazily-loading cache entries on a per segment basis.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="partition_handling_configuration"><a class="anchor" href="#partition_handling_configuration"></a>6.8.5. Configuring partition handling</h4>
<div class="paragraph">
<p>Unless the cache is distributed or replicated, partition handling configuration is ignored. The default partition
handling strategy is ALLOW_READ_WRITES and the default EntryMergePolicy is MergePolicies::PREFERRED_ALWAYS.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">the-default-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;partition-handling</span> <span class="attribute-name">when-split</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALLOW_READ_WRITES</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">merge-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PREFERRED_NON_NULL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same can be achieved programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder dcc = <span class="keyword">new</span> ConfigurationBuilder();
dcc.clustering().partitionHandling()
                    .whenSplit(PartitionHandling.ALLOW_READ_WRITES)
                    .mergePolicy(MergePolicies.PREFERRED_ALWAYS);</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="partition_handling_custom_merge_policy"><a class="anchor" href="#partition_handling_custom_merge_policy"></a>Implement a custom merge policy</h5>
<div class="paragraph">
<p>It&#8217;s also possible to provide custom implementations of the EntryMergePolicy</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">the-default-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;partition-handling</span> <span class="attribute-name">when-split</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALLOW_READ_WRITES</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">merge-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.example.CustomMergePolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder dcc = <span class="keyword">new</span> ConfigurationBuilder();
dcc.clustering().partitionHandling()
                    .whenSplit(PartitionHandling.ALLOW_READ_WRITES)
                    .mergePolicy(<span class="keyword">new</span> CustomMergePolicy());</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomMergePolicy</span> <span class="directive">implements</span> EntryMergePolicy&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> CacheEntry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; merge(CacheEntry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; preferredEntry, <span class="predefined-type">List</span>&lt;CacheEntry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt; otherEntries) {
      <span class="comment">// decide which entry should be used</span>

      <span class="keyword">return</span> the_solved_CacheEntry;
   }</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="deploy_custom_merge_policies_to_a_infinispan_server_instance"><a class="anchor" href="#deploy_custom_merge_policies_to_a_infinispan_server_instance"></a>Deploy custom merge policies to a Infinispan server instance</h5>
<div class="paragraph">
<p>To utilise a custom EntryMergePolicy implementation on the server, it&#8217;s necessary for the implementation class(es) to be deployed to the server. This is accomplished by utilising the java service-provider convention and packaging the class files in a jar which has a META-INF/services/org.infinispan.conflict.EntryMergePolicy file containing the fully qualified class name of the EntryMergePolicy implementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># list all necessary implementations of EntryMergePolicy with the full qualified name
org.example.CustomMergePolicy</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order for a Custom merge policy to be utilised on the server, you should <a href="#embedded_remote_interop">enable object storage</a>, if your policies semantics require access to the stored Key/Value objects. This is because cache entries in the server may be stored in a marshalled format and the Key/Value objects returned to your policy would be instances of WrappedByteArray.
However, if the custom policy only depends on the metadata associated with a cache entry, then object storage is not required and should be avoided (unless needed for other reasons) due to the additional performance cost of marshalling data per request.
Finally, object storage is never required if one of the provided merge policies is used.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="partition_handling_monitoring"><a class="anchor" href="#partition_handling_monitoring"></a>6.8.6. Monitoring and administration</h4>
<div class="paragraph">
<p>The availability mode of a cache is exposed in JMX as an attribute in the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/jmxComponents.html#Cache">Cache MBean</a>.
The attribute is writable, allowing an administrator to forcefully migrate
a cache from DEGRADED mode back to AVAILABLE (at the cost of
consistency).</p>
</div>
<div class="paragraph">
<p>The availability mode is also accessible via the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a>
interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AdvancedCache ac = cache.getAdvancedCache();

<span class="comment">// Read the availability</span>
<span class="type">boolean</span> available = ac.getAvailability() == AvailabilityMode.AVAILABLE;

<span class="comment">// Change the availability</span>
<span class="keyword">if</span> (!available) {
   ac.setAvailability(AvailabilityMode.AVAILABLE);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="marshalling"><a class="anchor" href="#marshalling"></a>7. Marshalling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Marshalling is the process of converting Java POJOs into something that can be written in a format that can be transferred over the wire.
Unmarshalling is the reverse process whereby data read from a wire format is transformed back into Java POJOs. Infinispan uses marshalling/unmarshalling in order to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Transform data so that it can be send over to other Infinispan nodes in a cluster.</p>
</li>
<li>
<p>Transform data so that it can be stored in underlying cache stores.</p>
</li>
<li>
<p>Store data in Infinispan in a wire format to provide lazy deserialization capabilities.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="the_role_of_jboss_marshalling"><a class="anchor" href="#the_role_of_jboss_marshalling"></a>7.1. The Role Of JBoss Marshalling</h3>
<div class="paragraph">
<p>Since performance is a very important factor in this process, Infinispan uses JBoss Marshalling framework instead of standard Java Serialization in order to marshall/unmarshall Java POJOs. Amongst other things, this framework enables Infinispan to provide highly efficient ways to marshall internal Infinispan Java POJOs that are constantly used. Apart from providing more efficient ways to marshall Java POJOs, including internal Java classes, JBoss Marshalling uses highly performant <code>java.io.ObjectOutput</code> and <code>java.io.ObjectInput</code> implementations compared to standard <code>java.io.ObjectOutputStream</code> and <code>java.io.ObjectInputStream</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="support_for_non_serializable_objects"><a class="anchor" href="#support_for_non_serializable_objects"></a>7.2. Support For Non-Serializable Objects</h3>
<div class="paragraph">
<p>From a users perspective, a very common concern is whether Infinispan supports storing non-Serializable objects. In 4.0, an Infinispan cache instance can only store non-Serializable key or value objects if, and only if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cache is configured to be a local cache <em>and&#8230;&#8203;</em></p>
</li>
<li>
<p>cache is not configured with lazy serialization <em>and&#8230;&#8203;</em></p>
</li>
<li>
<p>cache is not configured with any write-behind cache store</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If either of these options is true, key/value pairs in the cache will need to be marshalled and currently they require to either to extend <code>java.io.Serializable</code> or <code>java.io.Externalizable</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Since Infinispan 5.0, marshalling non-Serializable key/value objects are supported as long as users can to provide meaningful Externalizer implementations for these non-Seralizable objects.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you&#8217;re unable to retrofit Serializable or Externalizable into the classes whose instances are stored in Infinispan, you could alternatively use something like <a href="http://x-stream.github.io/">XStream</a> to convert your Non-Serializable objects into a String that can be stored into Infinispan. The one caveat about using XStream is that it slows down the process of storing key/value objects due to the XML transformation that it needs to do.</p>
</div>
<div class="sect3">
<h4 id="store_binary"><a class="anchor" href="#store_binary"></a>7.2.1. Store As Binary</h4>
<div class="paragraph">
<p>Store as binary enables data to be stored in its serialized form. This can be useful to achieve lazy deserialization, which is the mechanism by which Infinispan by which serialization and deserialization of objects is deferred till the point in time in which they are used and needed. This typically means that any deserialization happens using the thread context class loader of the invocation that requires deserialization, and is an effective mechanism to provide classloader isolation. By default lazy deserialization is disabled but if you want to enable it, you can do it like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Via XML at the Cache level, either under <code>&lt;*-cache /&gt;</code> element:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;memory&gt;</span>
   <span class="tag">&lt;binary</span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/memory&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Programmatically:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = ...
builder.memory().storageType(StorageType.BINARY);</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="equality_considerations"><a class="anchor" href="#equality_considerations"></a>Equality Considerations</h5>
<div class="paragraph">
<p>When using lazy deserialization/storing as binary, keys and values are wrapped as <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/marshall/">WrappedBytes</a>.
It is this wrapper class that transparently takes care of serialization and deserialization on demand, and internally may have a reference to the object itself being wrapped, or the serialized, byte array representation of this object.</p>
</div>
<div class="paragraph">
<p>This has a particular effect on the behavior of equality.
The equals() method of this class will either compare binary representations (byte arrays) or delegate to the wrapped object instance&#8217;s equals() method, depending on whether both instances being compared are in serialized or deserialized form at the time of comparison.
If one of the instances being compared is in one form and the other in another form, then one instance is either serialized or deserialized.</p>
</div>
<div class="paragraph">
<p>This will affect the way keys stored in the cache will work, when <code>storeAsBinary</code> is used, since comparisons happen on the key which will be wrapped by a MarshalledValue.Implementers of equals() methods on their keys need to be aware of the behavior of equality comparison, when a key is wrapped as a MarshalledValue, as detailed above.</p>
</div>
</div>
<div class="sect4">
<h5 id="store_by_value_via_defensive_copying"><a class="anchor" href="#store_by_value_via_defensive_copying"></a>Store-by-value via defensive copying</h5>
<div class="paragraph">
<p>The configuration <code>storeAsBinary</code> offers the possibility to enable defensive copying, which allows for store-by-value like behaviour.</p>
</div>
<div class="paragraph">
<p>Infinispan marshalls objects the moment they&#8217;re stored, hence changes made to object references are not stored in the cache, not even for local caches. This provides store-by-value like behaviour. Enabling <code>storeAsBinary</code> can be achieved:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Via XML at the Cache level, either under <code>&lt;*-cache /&gt;</code> or <code>&lt;default /&gt;</code> elements:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;store-as-binary</span> <span class="attribute-name">keys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">values</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Programmatically:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = ...
builder.storeAsBinary().enable().storeKeysAsBinary(<span class="predefined-constant">true</span>).storeValuesAsBinary(<span class="predefined-constant">true</span>);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advanced_configuration"><a class="anchor" href="#advanced_configuration"></a>7.3. Advanced Configuration</h3>
<div class="paragraph">
<p>Internally, Infinispan uses an implementation of <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/marshall/Marshaller.html">this Marshaller interface</a> in order to marshall/unmarshall Java objects so that they&#8217;re sent other nodes in the grid, or so that they&#8217;re stored in a cache store, or even so to transform them into byte arrays for lazy deserialization.</p>
</div>
<div class="paragraph">
<p>By default, Infinispan uses the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/marshall/core/GlobalMarshaller.html">GlobalMarshaller</a>.
Optionally, Infinispan users can provide their own marshaller, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Via XML at the CacheManager level, under <code>&lt;cache-manager /&gt;</code> element:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;serialization</span> <span class="attribute-name">marshaller</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.MyMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Programmatically:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = ...
builder.serialization().marshaller(myMarshaller); <span class="comment">// needs an instance of the marshaller</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>7.3.1. Troubleshooting</h4>
<div class="paragraph">
<p>Sometimes it might happen that the Infinispan marshalling layer, and in particular JBoss Marshalling, might have issues marshalling/unmarshalling some user object. In Infinispan 4.0, marshalling exceptions will contain further information on the objects that were being marshalled. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java.io.NotSerializableException: java.lang.Object
at org.jboss.marshalling.river.RiverMarshaller.doWriteObject(RiverMarshaller.java:857)
at org.jboss.marshalling.AbstractMarshaller.writeObject(AbstractMarshaller.java:407)
at org.infinispan.marshall.exts.ReplicableCommandExternalizer.writeObject(ReplicableCommandExternalizer.java:54)
at org.infinispan.marshall.jboss.ConstantObjectTable$ExternalizerAdapter.writeObject(ConstantObjectTable.java:267)
at org.jboss.marshalling.river.RiverMarshaller.doWriteObject(RiverMarshaller.java:143)
at org.jboss.marshalling.AbstractMarshaller.writeObject(AbstractMarshaller.java:407)
at org.infinispan.marshall.jboss.JBossMarshaller.objectToObjectStream(JBossMarshaller.java:167)
at org.infinispan.marshall.VersionAwareMarshaller.objectToBuffer(VersionAwareMarshaller.java:92)
at org.infinispan.marshall.VersionAwareMarshaller.objectToByteBuffer(VersionAwareMarshaller.java:170)
at org.infinispan.marshall.DefaultMarshallerTest.testNestedNonSerializable(VersionAwareMarshallerTest.java:415)
Caused by: an exception which occurred:
in object java.lang.Object@b40ec4
in object org.infinispan.commands.write.PutKeyValueCommand@df661da7
... Removed 22 stack frames</pre>
</div>
</div>
<div class="paragraph">
<p>The way the "in object" messages are read is the same in which stacktraces are read. The highest "in object" being the most inner one and the lowest "in object" message being the most outer one. So, the above example indicates that a java.lang.Object instance contained in an instance of org.infinispan.commands.write.PutKeyValueCommand could not be serialized because java.lang.Object@b40ec4 is not serializable.</p>
</div>
<div class="paragraph">
<p>This is not all though! If you enable DEBUG or TRACE logging levels, marshalling exceptions will contain show the toString() representations of objects in the stacktrace. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java.io.NotSerializableException: java.lang.Object
...
Caused by: an exception which occurred:
in object java.lang.Object@b40ec4
-&gt; toString = java.lang.Object@b40ec4
in object org.infinispan.commands.write.PutKeyValueCommand@df661da7
-&gt; toString = PutKeyValueCommand{key=k, value=java.lang.Object@b40ec4, putIfAbsent=false, lifespanMillis=0, maxIdleTimeMillis=0}</pre>
</div>
</div>
<div class="paragraph">
<p>With regards to unmarshalling exceptions, showing such level of information it&#8217;s a lot more complicated but where possible. Infinispan will provide class type information. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java.io.IOException: Injected failure!
at org.infinispan.marshall.DefaultMarshallerTest$1.readExternal(VersionAwareMarshallerTest.java:426)
at org.jboss.marshalling.river.RiverUnmarshaller.doReadNewObject(RiverUnmarshaller.java:1172)
at org.jboss.marshalling.river.RiverUnmarshaller.doReadObject(RiverUnmarshaller.java:273)
at org.jboss.marshalling.river.RiverUnmarshaller.doReadObject(RiverUnmarshaller.java:210)
at org.jboss.marshalling.AbstractUnmarshaller.readObject(AbstractUnmarshaller.java:85)
at org.infinispan.marshall.jboss.JBossMarshaller.objectFromObjectStream(JBossMarshaller.java:210)
at org.infinispan.marshall.VersionAwareMarshaller.objectFromByteBuffer(VersionAwareMarshaller.java:104)
at org.infinispan.marshall.VersionAwareMarshaller.objectFromByteBuffer(VersionAwareMarshaller.java:177)
at org.infinispan.marshall.DefaultMarshallerTest.testErrorUnmarshalling(VersionAwareMarshallerTest.java:431)
Caused by: an exception which occurred:
in object of type org.infinispan.marshall.DefaultMarshallerTest$1</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, an IOException was thrown when trying to unmarshall a instance of the inner class org.infinispan.marshall.DefaultMarshallerTest$1. In similar fashion to marshalling exceptions, when DEBUG or TRACE logging levels are enabled, classloader information of the class type is provided. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java.io.IOException: Injected failure!
...
Caused by: an exception which occurred:
in object of type org.infinispan.marshall.DefaultMarshallerTest$1
-&gt; classloader hierarchy:
-&gt; type classloader = sun.misc.Launcher$AppClassLoader@198dfaf
-&gt;...file:/opt/eclipse/configuration/org.eclipse.osgi/bundles/285/1/.cp/eclipse-testng.jar
-&gt;...file:/opt/eclipse/configuration/org.eclipse.osgi/bundles/285/1/.cp/lib/testng-jdk15.jar
-&gt;...file:/home/galder/jboss/infinispan/code/trunk/core/target/test-classes/
-&gt;...file:/home/galder/jboss/infinispan/code/trunk/core/target/classes/
-&gt;...file:/home/galder/.m2/repository/org/testng/testng/5.9/testng-5.9-jdk15.jar
-&gt;...file:/home/galder/.m2/repository/net/jcip/jcip-annotations/1.0/jcip-annotations-1.0.jar
-&gt;...file:/home/galder/.m2/repository/org/easymock/easymockclassextension/2.4/easymockclassextension-2.4.jar
-&gt;...file:/home/galder/.m2/repository/org/easymock/easymock/2.4/easymock-2.4.jar
-&gt;...file:/home/galder/.m2/repository/cglib/cglib-nodep/2.1_3/cglib-nodep-2.1_3.jar
-&gt;...file:/home/galder/.m2/repository/javax/xml/bind/jaxb-api/2.1/jaxb-api-2.1.jar
-&gt;...file:/home/galder/.m2/repository/javax/xml/stream/stax-api/1.0-2/stax-api-1.0-2.jar
-&gt;...file:/home/galder/.m2/repository/javax/activation/activation/1.1/activation-1.1.jar
-&gt;...file:/home/galder/.m2/repository/jgroups/jgroups/2.8.0.CR1/jgroups-2.8.0.CR1.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/javaee/jboss-transaction-api/1.0.1.GA/jboss-transaction-api-1.0.1.GA.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/marshalling/river/1.2.0.CR4-SNAPSHOT/river-1.2.0.CR4-SNAPSHOT.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/marshalling/marshalling-api/1.2.0.CR4-SNAPSHOT/marshalling-api-1.2.0.CR4-SNAPSHOT.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/jboss-common-core/2.2.14.GA/jboss-common-core-2.2.14.GA.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/logging/jboss-logging-spi/2.0.5.GA/jboss-logging-spi-2.0.5.GA.jar
-&gt;...file:/home/galder/.m2/repository/log4j/log4j/1.2.14/log4j-1.2.14.jar
-&gt;...file:/home/galder/.m2/repository/com/thoughtworks/xstream/xstream/1.2/xstream-1.2.jar
-&gt;...file:/home/galder/.m2/repository/xpp3/xpp3_min/1.1.3.4.O/xpp3_min-1.1.3.4.O.jar
-&gt;...file:/home/galder/.m2/repository/com/sun/xml/bind/jaxb-impl/2.1.3/jaxb-impl-2.1.3.jar
-&gt; parent classloader = sun.misc.Launcher$ExtClassLoader@1858610
-&gt;...file:/usr/java/jdk1.5.0_19/jre/lib/ext/localedata.jar
-&gt;...file:/usr/java/jdk1.5.0_19/jre/lib/ext/sunpkcs11.jar
-&gt;...file:/usr/java/jdk1.5.0_19/jre/lib/ext/sunjce_provider.jar
-&gt;...file:/usr/java/jdk1.5.0_19/jre/lib/ext/dnsns.jar
... Removed 22 stack frames
&lt;/code&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Finding the root cause of marshalling/unmarshalling exceptions can sometimes be really daunting but we hope that the above improvements would help get to the bottom of those in a more quicker and efficient manner.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="user_defined_externalizers"><a class="anchor" href="#user_defined_externalizers"></a>7.4. User Defined Externalizers</h3>
<div class="paragraph">
<p>One of the key aspects of Infinispan is that it often needs to marshall/unmarshall objects in order to provide some of its functionality. For example, if it needs to store objects in a write-through or write-behind cache store, the stored objects need marshalling. If a cluster of Infinispan nodes is formed, objects shipped around need marshalling. Even if you enable lazy deserialization, objects need to be marshalled so that they can be lazily unmarshalled with the correct classloader.</p>
</div>
<div class="paragraph">
<p>Using standard JDK serialization is slow and produces payloads that are too big and can affect bandwidth usage. On top of that, JDK serialization does not work well with objects that are supposed to be immutable. In order to avoid these issues, Infinispan uses <a href="http://jboss.org/jbossmarshalling">JBoss Marshalling</a> for marshalling/unmarshalling objects. JBoss Marshalling is fast, produces very space efficient payloads, and on top of that during unmarshalling, it enables users to have full control over how to construct objects, hence allowing objects to carry on being immutable.</p>
</div>
<div class="paragraph">
<p>Starting with 5.0, users of Infinispan can now benefit from this marshalling framework as well, and they can provide their own externalizer implementations, but before finding out how to provide externalizers, let&#8217;s look at the benefits they bring.</p>
</div>
<div class="sect3">
<h4 id="benefits_of_externalizers"><a class="anchor" href="#benefits_of_externalizers"></a>7.4.1. Benefits of Externalizers</h4>
<div class="paragraph">
<p>The JDK provides a simple way to serialize objects which, in its simplest form, is just a matter of extending <a href="https://docs.oracle.com/javase/8/docs/api/java/io/Serializable.html">java.io.Serializable</a> , but as it&#8217;s well known, this is known to be slow and it generates payloads that are far too big. An alternative way to do serialization, still relying on JDK serialization, is for your objects to extend <a href="https://docs.oracle.com/javase/8/docs/api/java/io/Externalizable.html">java.io.Externalizable</a> . This allows for users to provide their own ways to marshall/unmarshall classes, but has some serious issues because, on top of relying on slow JDK serialization, it forces the class that you want to serialize to extend this interface, which has two side effects: The first is that you&#8217;re forced to modify the source code of the class that you want to marshall/unmarshall which you might not be able to do because you either, don&#8217;t own the source, or you don&#8217;t even have it. Secondly, since Externalizable implementations do not control object creation, you&#8217;re forced to add set methods in order to restore the state, hence potentially forcing your immutable objects to become mutable.</p>
</div>
<div class="paragraph">
<p>Instead of relying on JDK serialization, Infinispan uses JBoss Marshalling to serialize objects and requires any classes to be serialized to be associated with an <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/marshall/Externalizer.html">Externalizer</a> interface implementation that knows how to transform an object of a particular class into a serialized form and how to read an object of that class from a given input. Infinispan does not force the objects to be serialized to implement Externalizer. In fact, it is recommended that a separate class is used to implement the Externalizer interface because, contrary to JDK serialization, Externalizer implementations control how objects of a particular class are created when trying to read an object from a stream. This means that readObject() implementations are responsible of creating object instances of the target class, hence giving users a lot of flexibility on how to create these instances (whether direct instantiation, via factory or reflection), and more importantly, allows target classes to carry on being immutable. This type of externalizer architecture promotes good OOP designs principles, such as the principle of <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">single responsibility</a> .</p>
</div>
<div class="paragraph">
<p>It&#8217;s quite common, and in general recommended, that Externalizer implementations are stored as inner static public classes within classes that they externalize. The advantages of doing this is that related code stays together, making it easier to maintain. In Infinispan, there are two ways in which Infinispan can be plugged with user defined externalizers:</p>
</div>
</div>
<div class="sect3">
<h4 id="user_friendly_externalizers"><a class="anchor" href="#user_friendly_externalizers"></a>7.4.2. User Friendly Externalizers</h4>
<div class="paragraph">
<p>In the simplest possible form, users just need to provide an <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/marshall/Externalizer.html">Externalizer</a> implementation for the type that they want to marshall/unmarshall, and then annotate the marshalled type class with {@link SerializeWith} annotation indicating the externalizer class to use. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.Externalizer</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.SerializeWith</span>;

<span class="annotation">@SerializeWith</span>(Person.PersonExternalizer.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Person</span> {

<span class="error"></span><span class="error"></span> <span class="directive">final</span> <span class="predefined-type">String</span> name;
<span class="error"></span><span class="error"></span> <span class="directive">final</span> <span class="type">int</span> age;

<span class="error"></span><span class="error"></span> <span class="directive">public</span> Person(<span class="predefined-type">String</span> name, <span class="type">int</span> age) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="local-variable">this</span>.name = name;
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="local-variable">this</span>.age = age;
<span class="error"></span><span class="error"></span> }

<span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">PersonExternalizer</span> <span class="directive">implements</span> Externalizer&lt;Person&gt; {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="annotation">@Override</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, Person person)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">throws</span> <span class="exception">IOException</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> output.writeObject(person.name);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> output.writeInt(person.age);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="annotation">@Override</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">public</span> Person readObject(<span class="predefined-type">ObjectInput</span> input)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">return</span> <span class="keyword">new</span> Person((<span class="predefined-type">String</span>) input.readObject(), input.readInt());
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span> }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>At runtime JBoss Marshalling will inspect the object and discover that it is marshallable (thanks to the annotation) and so marshall it using the externalizer class passed. To make externalizer implementations easier to code and more typesafe, make sure you define type <code>&lt;T&gt;</code> as the type of object that&#8217;s being marshalled/unmarshalled.</p>
</div>
<div class="paragraph">
<p>Even though this way of defining externalizers is very user friendly, it has some disadvantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Due to several constraints of the model, such as support for different versions of the same class or the need to marshall the Externalizer class, the payload sizes generated via this method are not the most efficient.</p>
</li>
<li>
<p>This model requires that the marshalled class be annotated with link:https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/marshall/SerializeWith.html but a user might need to provide an Externalizer for a class for which source code is not available, or for any other constraints, it cannot be modified.</p>
</li>
<li>
<p>The use of annotations by this model might be limiting for framework developers or service providers that try to abstract lower level details, such as the marshalling layer, away from the user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you&#8217;re affected by any of these disadvantages, an alternative method to provide externalizers is available via more advanced externalizers:</p>
</div>
</div>
<div class="sect3">
<h4 id="advanced_externalizers"><a class="anchor" href="#advanced_externalizers"></a>7.4.3. Advanced Externalizers</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/marshall/AdvancedExternalizer.html">AdvancedExternalizer</a> provides an alternative way to provide externalizers for marshalling/unmarshalling user defined classes that overcome the deficiencies of the more user-friendly externalizer definition model explained in Externalizer. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.marshall.AdvancedExternalizer</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Person</span> {

<span class="error"></span><span class="error"></span> <span class="directive">final</span> <span class="predefined-type">String</span> name;
<span class="error"></span><span class="error"></span> <span class="directive">final</span> <span class="type">int</span> age;

<span class="error"></span><span class="error"></span> <span class="directive">public</span> Person(<span class="predefined-type">String</span> name, <span class="type">int</span> age) {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="local-variable">this</span>.name = name;
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="local-variable">this</span>.age = age;
<span class="error"></span><span class="error"></span> }

<span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">PersonExternalizer</span> <span class="directive">implements</span> AdvancedExternalizer&lt;Person&gt; {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="annotation">@Override</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, Person person)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">throws</span> <span class="exception">IOException</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> output.writeObject(person.name);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> output.writeInt(person.age);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="annotation">@Override</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">public</span> Person readObject(<span class="predefined-type">ObjectInput</span> input)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">return</span> <span class="keyword">new</span> Person((<span class="predefined-type">String</span>) input.readObject(), input.readInt());
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="annotation">@Override</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> Person&gt;&gt; getTypeClasses() {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">return</span> <span class="predefined-type">Util</span>.&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> Person&gt;&gt;asSet(Person.class);
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }

<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="annotation">@Override</span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="directive">public</span> <span class="predefined-type">Integer</span> getId() {
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">return</span> <span class="integer">2345</span>;
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> }
<span class="error"></span><span class="error"></span> }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first noticeable difference is that this method does not require user classes to be annotated in anyway, so it can be used with classes for which source code is not available or that cannot be modified. The bound between the externalizer and the classes that are marshalled/unmarshalled is set by providing an implementation for <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/marshall/AdvancedExternalizer.html#getTypeClasses--">getTypeClasses()</a> which should return the list of classes that this externalizer can marshall:</p>
</div>
<div class="sect4">
<h5 id="linking_externalizers_with_marshaller_classes"><a class="anchor" href="#linking_externalizers_with_marshaller_classes"></a>Linking Externalizers with Marshaller Classes</h5>
<div class="paragraph">
<p>Once the Externalizer&#8217;s readObject() and writeObject() methods have been implemented, it&#8217;s time to link them up together with the type classes that they externalize. To do so, the Externalizer implementation must provide a getTypeClasses() implementation. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.util.Util</span>;
...
<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> ReplicableCommand&gt;&gt; getTypeClasses() {
<span class="error"></span> <span class="keyword">return</span> <span class="predefined-type">Util</span>.asSet(LockControlCommand.class, RehashControlCommand.class,
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> StateTransferControlCommand.class, GetKeyValueCommand.class,
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ClusteredGetCommand.class,
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> SingleRpcCommand.class, CommitCommand.class,
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> PrepareCommand.class, RollbackCommand.class,
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> ClearCommand.class, EvictCommand.class,
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> InvalidateCommand.class, InvalidateL1Command.class,
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> PutKeyValueCommand.class, PutMapCommand.class,
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> RemoveCommand.class, ReplaceCommand.class);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the code above, ReplicableCommandExternalizer indicates that it can externalize several type of commands. In fact, it marshalls all commands that extend ReplicableCommand interface, but currently the framework only supports class equality comparison and so, it&#8217;s not possible to indicate that the classes to marshalled are all children of a particular class/interface.</p>
</div>
<div class="paragraph">
<p>However there might sometimes when the classes to be externalized are private and hence it&#8217;s not possible to reference the actual class instance. In this situations, users can attempt to look up the class with the given fully qualified class name and pass that back. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">List</span>&gt;&gt; getTypeClasses() {
<span class="error"></span> <span class="keyword">return</span> <span class="predefined-type">Util</span>.&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">List</span>&gt;&gt;asSet(
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="predefined-type">Util</span>.loadClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">java.util.Collections$SingletonList</span><span class="delimiter">&quot;</span></span>));
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="externalizer_identifier"><a class="anchor" href="#externalizer_identifier"></a>Externalizer Identifier</h5>
<div class="paragraph">
<p>Secondly, in order to save the maximum amount of space possible in the payloads generated, advanced externalizers require externalizer implementations to provide a positive identified via <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/marshall/AdvancedExternalizer.html#getId--">getId()</a> implementations or via XML/programmatic configuration that identifies the externalizer when unmarshalling a payload. In order for this to work however, advanced externalizers require externalizers to be registered on cache manager creation time via XML or programmatic configuration which will be explained in next section. On the contrary, externalizers based on Externalizer and SerializeWith require no pre-registration whatsoever. Internally, Infinispan uses this advanced externalizer mechanism in order to marshall/unmarshall internal classes.</p>
</div>
<div class="paragraph">
<p>So, getId() should return a positive integer that allows the externalizer to be identified at read time to figure out which Externalizer should read the contents of the incoming buffer, or it can return null. If getId() returns null, it is indicating that the id of this advanced externalizer will be defined via XML/programmatic configuration, which will be explained in next section.</p>
</div>
<div class="paragraph">
<p>Regardless of the source of the the id, using a positive integer allows for very efficient variable length encoding of numbers, and it&#8217;s much more efficient than shipping externalizer implementation class information or class name around. Infinispan users can use any positive integer as long as it does not clash with any other identifier in the system. It&#8217;s important to understand that a user defined externalizer can even use the same numbers as the externalizers in the Infinispan Core project because the internal Infinispan Core externalizers are special and they use a different number space to the user defined externalizers. On the contrary, users should avoid using numbers that are within the pre-assigned identifier ranges which can be found at the end of this article. Infinispan checks for id duplicates on startup, and if any are found, startup is halted with an error.</p>
</div>
<div class="paragraph">
<p>When it comes to maintaining which ids are in use, it&#8217;s highly recommended that this is done in a centralized way. For example, getId() implementations could reference a set of statically defined identifiers in a separate class or interface. Such class/interface would give a global view of the identifiers in use and so can make it easier to assign new ids.</p>
</div>
</div>
<div class="sect4">
<h5 id="registering_advanced_externalizers"><a class="anchor" href="#registering_advanced_externalizers"></a>Registering Advanced Externalizers</h5>
<div class="paragraph">
<p>The following example shows the type of configuration required to register an advanced externalizer implementation for Person object shown earlier stored as a static inner class within it:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
 <span class="tag">&lt;cache-container&gt;</span>
 <span class="tag">&lt;serialization&gt;</span>
  <span class="tag">&lt;advanced-externalizer</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Person$PersonExternalizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;/serialization&gt;</span>
 <span class="tag">&lt;/cache-container&gt;</span>
 ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = ...
builder.serialization()
<span class="error"></span><span class="error"></span> .addAdvancedExternalizer(<span class="keyword">new</span> Person.PersonExternalizer());</code></pre>
</div>
</div>
<div class="paragraph">
<p>As mentioned earlier, when listing these externalizer implementations, users can optionally provide the identifier of the externalizer via XML or programmatically instead of via getId() implementation. Again, this offers a centralized way to maintain the identifiers but it&#8217;s important that the rules are clear: An AdvancedExternalizer implementation, either via XML/programmatic configuration or via annotation, needs to be associated with an identifier. If it isn&#8217;t, Infinispan will throw an error and abort startup. If a particular AdvancedExternalizer implementation defines an id both via XML/programmatic configuration and annotation, the value defined via XML/programmatically is the one that will be used. Here&#8217;s an example of an externalizer whose id is defined at registration time:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
 <span class="tag">&lt;cache-container&gt;</span>
 <span class="tag">&lt;serialization&gt;</span>
  <span class="tag">&lt;advanced-externalizer</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Person$PersonExternalizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;/serialization&gt;</span>
 <span class="tag">&lt;/cache-container&gt;</span>
 ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = ...
builder.serialization()
<span class="error"></span><span class="error"></span> .addAdvancedExternalizer(<span class="integer">123</span>, <span class="keyword">new</span> Person.PersonExternalizer());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, a couple of notes about the programmatic configuration. GlobalConfiguration.addExternalizer() takes varargs, so it means that it is possible to register multiple externalizers in just one go, assuming that their ids have already been defined via @Marshalls annotation. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">builder.serialization()
<span class="error"></span><span class="error"></span> .addAdvancedExternalizer(<span class="keyword">new</span> Person.PersonExternalizer(),
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="keyword">new</span> Address.AddressExternalizer());</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="preassigned_externalizer_id_ranges"><a class="anchor" href="#preassigned_externalizer_id_ranges"></a>Preassigned Externalizer Id Ranges</h5>
<div class="paragraph">
<p>This is the list of Externalizer identifiers that are used by Infinispan based modules or frameworks. Infinispan users should avoid using ids within these ranges.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Tree Module:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000 - 1099</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Server Modules:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1100 - 1199</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Infinispan Second Level Cache:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1200 - 1299</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Lucene Directory:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1300 - 1399</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate OGM:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1400 - 1499</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Search:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1500 - 1599</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Query Module:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1600 - 1699</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Remote Query Module:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1700 - 1799</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Scripting Module:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1800 - 1849</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Server Event Logger Module:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1850 - 1899</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Remote Store:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1900 - 1999</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Counters:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2000 - 2049</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Multimap:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2050 - 2099</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Locks:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2100 - 2149</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="transactions"><a class="anchor" href="#transactions"></a>8. Transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan can be configured to use and to participate in JTA compliant transactions.
Alternatively, if transaction support is disabled, it is equivalent to using autocommit in JDBC calls, where modifications are potentially replicated after every change (if replication is enabled).</p>
</div>
<div class="paragraph">
<p>On every cache operation Infinispan does the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Retrieves the current <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Transaction.html">Transaction</a> associated with the thread</p>
</li>
<li>
<p>If not already done, registers <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a> with the transaction manager to be notified when a transaction commits or is rolled back.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In order to do this, the cache has to be provided with a reference to the environment&#8217;s <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.
This is usually done by configuring the cache with the class name of an implementation of the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/transaction/lookup/TransactionManagerLookup.html">TransactionManagerLookup</a> interface.
When the cache starts, it will create an instance of this class and invoke its <code>getTransactionManager()</code> method, which returns a reference to the <code>TransactionManager</code>.</p>
</div>
<div class="paragraph">
<p>Infinispan ships with several transaction manager lookup classes:</p>
</div>
<div class="ulist">
<div class="title">Transaction manager lookup implementations</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/transaction/lookup/EmbeddedTransactionManagerLookup.html">EmbeddedTransactionManagerLookup</a>:
This provides with a basic transaction manager which should only be used for embedded mode when no other implementation is available.
This implementation has some severe limitations to do with concurrent transactions and recovery.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/transaction/lookup/JBossStandaloneJTAManagerLookup.html">JBossStandaloneJTAManagerLookup</a>:
If you&#8217;re running Infinispan in a standalone environment, or in JBoss AS 7 and earlier, and WildFly 8, 9, and 10, this should be your default choice for transaction manager.
It&#8217;s a fully fledged transaction manager based on <a href="http://narayana.io/">JBoss Transactions</a> which overcomes all the deficiencies of the <code>EmbeddedTransactionManager</code>.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/transaction/lookup/WildflyTransactionManagerLookup.html">WildflyTransactionManagerLookup</a>:
If you&#8217;re running Infinispan in Wildfly 11 or later, this should be your default choice for transaction manager.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/transaction/lookup/GenericTransactionManagerLookup.html">GenericTransactionManagerLookup</a>:
This is a lookup class that locate transaction managers in the most popular Java EE application servers.
If no transaction manager can be found, it defaults on the <code>EmbeddedTransactionManager</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WARN: <code>DummyTransactionManagerLookup</code> has been deprecated in 9.0 and it will be removed in the future.
Use <code>EmbeddedTransactionManagerLookup</code> instead.</p>
</div>
<div class="paragraph">
<p>Once initialized, the <code>TransactionManager</code> can also be obtained from the <code>Cache</code> itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//the cache must have a transactionManagerLookupClass defined</span>
Cache cache = cacheManager.getCache();

<span class="comment">//equivalent with calling TransactionManagerLookup.getTransactionManager();</span>
TransactionManager tm = cache.getAdvancedCache().getTransactionManager();</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="tx_configuration"><a class="anchor" href="#tx_configuration"></a>8.1. Configuring transactions</h3>
<div class="paragraph">
<p>Transactions are configured at cache level.
Below is the configuration that affects a transaction behaviour and a small description of each configuration attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;locking</span>
   <span class="attribute-name">isolation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">READ_COMMITTED</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">write-skew</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;transaction</span>
   <span class="attribute-name">locking</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OPTIMISTIC</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">auto-commit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">complete-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">notifications</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DEFAULT</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">reaper-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">recovery-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">__recoveryInfoCacheName__</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">stop-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">transaction-manager-lookup</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.transaction.lookup.GenericTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;versioning</span>
   <span class="attribute-name">scheme</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.locking()
    .isolationLevel(IsolationLevel.READ_COMMITTED)
    .writeSkewCheck(<span class="predefined-constant">false</span>);
builder.transaction()
    .lockingMode(LockingMode.OPTIMISTIC)
    .autoCommit(<span class="predefined-constant">true</span>)
    .completedTxTimeout(<span class="integer">60000</span>)
    .transactionMode(TransactionMode.NON_TRANSACTIONAL)
    .useSynchronization(<span class="predefined-constant">false</span>)
    .notifications(<span class="predefined-constant">true</span>)
    .transactionProtocol(TransactionProtocol.DEFAULT)
    .reaperWakeUpInterval(<span class="integer">30000</span>)
    .cacheStopTimeout(<span class="integer">30000</span>)
    .transactionManagerLookup(<span class="keyword">new</span> GenericTransactionManagerLookup())
    .recovery()
    .enabled(<span class="predefined-constant">false</span>)
    .recoveryInfoCacheName(<span class="string"><span class="delimiter">&quot;</span><span class="content">__recoveryInfoCacheName__</span><span class="delimiter">&quot;</span></span>);
builder.versioning()
    .enabled(<span class="predefined-constant">false</span>)
    .scheme(VersioningScheme.NONE);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>isolation</code> - configures the isolation level. Check section <a href="#tx_isolation_levels">Isolation Levels</a> for more details.
Default is <code>REPEATABLE_READ</code>.</p>
</li>
<li>
<p><code>write-skew</code> - enables write skew checks (deprecated). Infinispan automatically sets this attribute in Library Mode. Default is <code>false</code> for <code>READ_COMMITTED</code>. Default is <code>true</code> for <code>REPEATABLE_READ</code>. See <a href="#tx_write_skew">Write Skews</a> for more details.</p>
</li>
<li>
<p><code>locking</code> - configures whether the cache uses optimistic or pessimistic locking. Check section <a href="#tx_locking">Transaction Locking</a> for more details.
Default is <code>OPTIMISTIC</code>.</p>
</li>
<li>
<p><code>auto-commit</code> - if enable, the user does not need to start a transaction manually for a single operation. The transaction is automatically started and committed.
Default is <code>true</code>.</p>
</li>
<li>
<p><code>complete-timeout</code> - the duration in milliseconds to keep information about completed transactions. Default is <code>60000</code>.</p>
</li>
<li>
<p><code>mode</code> - configures whether the cache is transactional or not. Default is <code>NONE</code>. The available options are:</p>
<div class="ulist">
<ul>
<li>
<p><code>NONE</code> - non transactional cache</p>
</li>
<li>
<p><code>FULL_XA</code> - XA transactional cache with recovery enabled. Check section <a href="#tx_recovery">Transaction recovery</a> for more details about recovery.</p>
</li>
<li>
<p><code>NON_DURABLE_XA</code> - XA transactional cache with recovery disabled.</p>
</li>
<li>
<p><code>NON_XA</code> - transactional cache with integration via <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Synchronization.html">Synchronization</a> instead of XA.
Check section <a href="#tx_sync_enlist">Enlisting Synchronizations</a> for details.</p>
</li>
<li>
<p><code>BATCH</code>-  transactional cache using batch to group operations. Check section <a href="#tx_batching">Batching</a> for details.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>notifications</code> - enables/disables triggering transactional events in cache listeners. Default is <code>true</code>.</p>
</li>
<li>
<p><code>protocol</code> - configures the protocol uses. Default is <code>DEFAULT</code>. Values available are:</p>
<div class="ulist">
<ul>
<li>
<p><code>DEFAULT</code> - uses the traditional Two-Phase-Commit protocol. It is described below.</p>
</li>
<li>
<p><code>TOTAL_ORDER</code> - uses total order ensured by the <code>Transport</code> to commit transactions. Check section <a href="#tx_total_order">Total Order based commit protocol</a> for details.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>reaper-interval</code> - the time interval in millisecond at which the thread that cleans up transaction completion information kicks in.
Defaults is <code>30000</code>.</p>
</li>
<li>
<p><code>recovery-cache</code> - configures the cache name to store the recovery information. Check section <a href="#tx_recovery">Transaction recovery</a> for more details about recovery.
Default is <code><em>recoveryInfoCacheName</em></code>.</p>
</li>
<li>
<p><code>stop-timeout</code> - the time in millisecond to wait for ongoing transaction when the cache is stopping. Default is  <code>30000</code>.</p>
</li>
<li>
<p><code>transaction-manager-lookup</code> - configures the fully qualified class name of a class that looks up a reference to a <code>javax.transaction.TransactionManager</code>.
Default is <code>org.infinispan.transaction.lookup.GenericTransactionManagerLookup</code>.</p>
</li>
<li>
<p>Versioning <code>scheme</code> - configure the version scheme to use when write skew is enabled with optimistic or total order transactions.
Check section <a href="#tx_write_skew">Write Skews</a> for more details. Default is <code>NONE</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more details on how Two-Phase-Commit (2PC) is implemented in Infinispan and how locks are being acquired see the section below.
More details about the configuration settings are available in <a href="http://docs.jboss.org/infinispan/9.4/configdocs/">Configuration reference</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="tx_isolation_levels"><a class="anchor" href="#tx_isolation_levels"></a>8.2. Isolation levels</h3>
<div class="paragraph">
<p>Infinispan offers two isolation levels - <a href="https://en.wikipedia.org/wiki/Isolation_(database_systems)#Read_committed">READ_COMMITTED</a> and <a href="https://en.wikipedia.org/wiki/Isolation_(database_systems)#Repeatable_reads">REPEATABLE_READ</a>.</p>
</div>
<div class="paragraph">
<p>These isolation levels determine when readers see a concurrent write, and are internally implemented using different subclasses of <code>MVCCEntry</code>, which have different behaviour in how state is committed back to the data container.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a more detailed example that should help understand the difference between <code>READ_COMMITTED</code> and <code>REPEATABLE_READ</code> in the context of Infinispan.
With <code>READ_COMMITTED</code>, if between two consecutive read calls on the same key, the key has been updated by another transaction, the second read may return the new updated value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Thread1: tx1.begin()
Thread1: cache.get(k) <span class="comment">// returns v</span>
Thread2:                                       tx2.begin()
Thread2:                                       cache.get(k) <span class="comment">// returns v</span>
Thread2:                                       cache.put(k, v2)
Thread2:                                       tx2.commit()
Thread1: cache.get(k) <span class="comment">// returns v2!</span>
Thread1: tx1.commit()</code></pre>
</div>
</div>
<div class="paragraph">
<p>With <code>REPEATABLE_READ</code>, the final get will still return <code>v</code>.
So, if you&#8217;re going to retrieve the same key multiple times within a transaction, you should use <code>REPEATABLE_READ</code>.</p>
</div>
<div class="paragraph">
<p>However, as read-locks are not acquired even for <code>REPEATABLE_READ</code>, this phenomena can occur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>) <span class="comment">// returns 1</span>
cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>) <span class="comment">// returns 1</span>

Thread1: tx1.begin()
Thread1: cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>, <span class="integer">2</span>)
Thread1: cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>, <span class="integer">2</span>)
Thread2:                                       tx2.begin()
Thread2:                                       cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>) <span class="comment">// returns 1</span>
Thread1: tx1.commit()
Thread2:                                       cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>) <span class="comment">// returns 2</span>
Thread2:                                       tx2.commit()</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tx_locking"><a class="anchor" href="#tx_locking"></a>8.3. Transaction locking</h3>
<div class="sect3">
<h4 id="pessimistic_transactional_cache"><a class="anchor" href="#pessimistic_transactional_cache"></a>8.3.1. Pessimistic transactional cache</h4>
<div class="paragraph">
<p>From a lock acquisition perspective, pessimistic transactions obtain locks on keys at the time the key is written.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A lock request is sent to the primary owner (can be an explicit lock request or an operation)</p>
</li>
<li>
<p>The primary owner tries to acquire the lock:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If it succeed, it sends back a positive reply;</p>
</li>
<li>
<p>Otherwise, a negative reply is sent and the transaction is rollback.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">transactionManager.begin();
cache.put(k1,v1); <span class="comment">//k1 is locked.</span>
cache.remove(k2); <span class="comment">//k2 is locked when this returns</span>
transactionManager.commit();</code></pre>
</div>
</div>
<div class="paragraph">
<p>When <code>cache.put(k1,v1)</code> returns, <code>k1</code> is locked and no other transaction running anywhere in the cluster can write to it.
Reading <code>k1</code> is still possible.
The lock on <code>k1</code> is released when the transaction completes (commits or rollbacks).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For conditional operations, the validation is performed in the originator.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="optimistic_transactional_cache"><a class="anchor" href="#optimistic_transactional_cache"></a>8.3.2. Optimistic transactional cache</h4>
<div class="paragraph">
<p>With optimistic transactions locks are being acquired at transaction prepare time and are only being held up to the point the transaction commits (or rollbacks).
This is different from the 5.0 default locking model where local locks are being acquire on writes and cluster locks are being acquired during prepare time.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The prepare is sent to all the owners.</p>
</li>
<li>
<p>The primary owners try to acquire the locks needed:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If locking succeeds, it performs the write skew check.</p>
</li>
<li>
<p>If the write skew check succeeds (or is disabled), send a positive reply.</p>
</li>
<li>
<p>Otherwise, a negative reply is sent and the transaction is rolled back.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">transactionManager.begin();
cache.put(k1,v1);
cache.remove(k2);
transactionManager.commit(); <span class="comment">//at prepare time, K1 and K2 is locked until committed/rolled back.</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For conditional commands, the validation still happens on the originator.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="what_do_i_need_pessimistic_or_optimistic_transactions"><a class="anchor" href="#what_do_i_need_pessimistic_or_optimistic_transactions"></a>8.3.3. What do I need - pessimistic or optimistic transactions?</h4>
<div class="paragraph">
<p>From a use case perspective, optimistic transactions should be used when there is <em>not</em> a lot of contention between multiple transactions running at the same time.
That is because the optimistic transactions rollback if data has changed between the time it was read and the time it was committed (with write skew check enabled).</p>
</div>
<div class="paragraph">
<p>On the other hand, pessimistic transactions might be a better fit when there is high contention on the keys and transaction rollbacks are less desirable.
Pessimistic transactions are more costly by their nature: each write operation potentially involves a RPC for lock acquisition.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tx_write_skew"><a class="anchor" href="#tx_write_skew"></a>8.4. Write Skews</h3>
<div class="paragraph">
<p>Write skews occur when two transactions independently and simultaneously read and write to the same key. The result of a write skew is that both transactions successfully commit updates to the same key but with different values.</p>
</div>
<div class="paragraph">
<p>In Library Mode, Infinispan automatically performs write skew checks to ensure data consistency for <code>REPEATABLE_READ</code> isolation levels in optimistic transactions. This allows Infinispan to detect and roll back one of the transactions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>write-skew</code> attribute is deprecated for Library Mode. In Remote Client/Server Mode, this attribute is not a valid declaration.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When operating in <code>LOCAL</code> mode, write skew checks rely on Java object references to compare differences, which provides a reliable technique for checking for write skews.</p>
</div>
<div class="paragraph">
<p>In clustered environments, you should configure data versioning to ensure reliable write skew checks. Infinispan provides an implementation of the <code>EntryVersion</code> interface called <code>SIMPLE</code> versioning, which is backed by a long that is incremented each time the entry is updated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;versioning</span> <span class="attribute-name">scheme</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SIMPLE|NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> ConfigurationBuilder().versioning().scheme(SIMPLE);</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="forcing_write_locks_on_keys_in_pessimitic_transactions"><a class="anchor" href="#forcing_write_locks_on_keys_in_pessimitic_transactions"></a>8.4.1. Forcing write locks on keys in pessimitic transactions</h4>
<div class="paragraph">
<p>To avoid write-skews with pessimistic transactions, lock keys at read-time with <code>Flag.FORCE_WRITE_LOCK</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>In non-transactional caches, <code>Flag.FORCE_WRITE_LOCK</code> does not work. The <code>get()</code> call reads the key value but does not acquire locks remotely.</p>
</li>
<li>
<p>You should use <code>Flag.FORCE_WRITE_LOCK</code> with transactions in which the entity is updated later in the same transaction.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Compare the following code snippets for an example of <code>Flag.FORCE_WRITE_LOCK</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// begin the transaction</span>
<span class="keyword">if</span> (!cache.getAdvancedCache().lock(key)) {
   <span class="comment">// abort the transaction because the key was not locked</span>
} <span class="keyword">else</span> {
   cache.get(key);
   cache.put(key, value);
   <span class="comment">// commit the transaction</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// begin the transaction</span>
<span class="keyword">try</span> {
   <span class="comment">// throws an exception if the key is not locked.</span>
   cache.getAdvancedCache().withFlags(Flag.FORCE_WRITE_LOCK).get(key);
   cache.put(key, value);
} <span class="keyword">catch</span> (CacheException e) {
   <span class="comment">// mark the transaction rollback-only</span>
}
<span class="comment">// commit or rollback the transaction</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dealing_with_exceptions"><a class="anchor" href="#dealing_with_exceptions"></a>8.5. Dealing with exceptions</h3>
<div class="paragraph">
<p>If a <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/CacheException.html">CacheException</a> (or a subclass of it) is thrown by a cache method within the scope of a JTA transaction, then the transaction is automatically marked for rollback.</p>
</div>
</div>
<div class="sect2">
<h3 id="tx_sync_enlist"><a class="anchor" href="#tx_sync_enlist"></a>8.6. Enlisting Synchronizations</h3>
<div class="paragraph">
<p>By default Infinispan registers itself as a first class participant in distributed transactions through <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a>.
There are situations where Infinispan is not required to be a participant in the transaction, but only to be notified by its lifecycle (prepare, complete): e.g. in the case Infinispan is used as a 2nd level cache in Hibernate.</p>
</div>
<div class="paragraph">
<p>Infinispan allows transaction enlistment through <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Synchronization.html">Synchronization</a>.
To enable it just use <code>NON_XA</code> transaction mode.</p>
</div>
<div class="paragraph">
<p><code>Synchronization</code>s have the advantage that they allow <code>TransactionManager</code> to optimize 2PC with a 1PC where only one other resource is enlisted with that transaction (<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html/development_guide/java_transaction_api_jta#about_the_lrco_optimization_for_single_phase_commit_1pc">last resource commit optimization</a>).
E.g. Hibernate second level cache: if Infinispan registers itself with the <code>TransactionManager</code> as a <code>XAResource</code> than at commit time, the <code>TransactionManager</code> sees two <code>XAResource</code> (cache and database) and does not make this optimization.
Having to coordinate between two resources it needs to write the tx log to disk.
On the other hand, registering Infinispan as a <code>Synchronisation</code> makes the <code>TransactionManager</code> skip writing the log to the disk (performance improvement).</p>
</div>
</div>
<div class="sect2">
<h3 id="tx_batching"><a class="anchor" href="#tx_batching"></a>8.7. Batching</h3>
<div class="paragraph">
<p>Batching allows atomicity and some characteristics of a transaction, but not full-blown JTA or XA capabilities.
Batching is often a lot lighter and cheaper than a full-blown transaction.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Generally speaking, one should use batching API whenever the only participant in the transaction is an Infinispan cluster.
On the other hand, JTA transactions (involving <code>TransactionManager</code>) should be used whenever the transactions involves multiple systems.
E.g. considering the "Hello world!" of transactions: transferring money from one bank account to the other.
If both accounts are stored within Infinispan, then batching can be used.
If one account is in a database and the other is Infinispan, then distributed transactions are required.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You <em>do not</em> have to have a transaction manager defined to use batching.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="api_2"><a class="anchor" href="#api_2"></a>8.7.1. API</h4>
<div class="paragraph">
<p>Once you have configured your cache to use batching, you use it by calling <code>startBatch()</code> and <code>endBatch()</code> on <code>Cache</code>. E.g.,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache cache = cacheManager.getCache();
<span class="comment">// not using a batch</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>); <span class="comment">// will replicate immediately</span>

<span class="comment">// using a batch</span>
cache.startBatch();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.endBatch(<span class="predefined-constant">true</span>); <span class="comment">// This will now replicate the modifications since the batch was started.</span>

<span class="comment">// a new batch</span>
cache.startBatch();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.endBatch(<span class="predefined-constant">false</span>); <span class="comment">// This will &quot;discard&quot; changes made in the batch</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="batching_and_jta"><a class="anchor" href="#batching_and_jta"></a>8.7.2. Batching and JTA</h4>
<div class="paragraph">
<p>Behind the scenes, the batching functionality starts a JTA transaction, and all the invocations in that scope are associated with it.
For this it uses a very simple (e.g. no recovery) internal <code>TransactionManager</code> implementation.
With batching, you get:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locks you acquire during an invocation are held until the batch completes</p>
</li>
<li>
<p>Changes are all replicated around the cluster in a batch as part of the batch completion process. Reduces replication chatter for each update in the batch.</p>
</li>
<li>
<p>If synchronous replication or invalidation are used, a failure in replication/invalidation will cause the batch to roll back.</p>
</li>
<li>
<p>All the transaction related configurations apply for batching as well.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tx_recovery"><a class="anchor" href="#tx_recovery"></a>8.8. Transaction recovery</h3>
<div class="paragraph">
<p>Recovery is a feature of XA transactions, which deal with the eventuality of a resource or possibly even the transaction manager failing, and recovering accordingly from such a situation.</p>
</div>
<div class="sect3">
<h4 id="when_to_use_recovery"><a class="anchor" href="#when_to_use_recovery"></a>8.8.1. When to use recovery</h4>
<div class="paragraph">
<p>Consider a distributed transaction in which money is transferred from an account stored in an external database to an account stored in Infinispan.
When <code>TransactionManager.commit()</code> is invoked, both resources prepare successfully (1st phase). During the commit (2nd) phase, the database successfully applies the changes whilst Infinispan fails before receiving the commit request from the transaction manager.
At this point the system is in an inconsistent state: money is taken from the account in the external database but not visible yet in Infinispan (since locks are only released during 2nd phase of a two-phase commit protocol).
Recovery deals with this situation to make sure data in both the database and Infinispan ends up in a consistent state.</p>
</div>
</div>
<div class="sect3">
<h4 id="how_does_it_work_2"><a class="anchor" href="#how_does_it_work_2"></a>8.8.2. How does it work</h4>
<div class="paragraph">
<p>Recovery is coordinated by the transaction manager.
The transaction manager works with Infinispan to determine the list of in-doubt transactions that require manual intervention and informs the system administrator (via email, log alerts, etc).
This process is transaction manager specific, but generally requires some configuration on the transaction manager.</p>
</div>
<div class="paragraph">
<p>Knowing the in-doubt transaction ids, the system administrator can now connect to the Infinispan cluster and replay the commit of transactions or force the rollback.
Infinispan provides JMX tooling for this - this is explained extensively in the <a href="#tx_recovery_reconciliation">Transaction recovery and reconciliation</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring_recovery"><a class="anchor" href="#configuring_recovery"></a>8.8.3. Configuring recovery</h4>
<div class="paragraph">
<p>Recovery is <em>not</em> enabled by default in Infinispan.
If disabled, the <code>TransactionManager</code> won&#8217;t be able to work with Infinispan to determine the in-doubt transactions.
The <a href="#tx_configuration">Transaction configuration</a> section shows how to enable it.</p>
</div>
<div class="paragraph">
<p>NOTE:<code>recovery-cache</code> attribute is not mandatory and it is configured per-cache.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For recovery to work, <code>mode</code> must be set to <code>FULL_XA</code>, since full-blown XA transactions are needed.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="enable_jmx_support"><a class="anchor" href="#enable_jmx_support"></a>Enable JMX support</h5>
<div class="paragraph">
<p>In order to be able to use JMX for managing recovery JMX support must be explicitly enabled.
More about enabling JMX in the <a href="#jmx_mgmt_tooling">Management</a> chapter.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="recovery_cache"><a class="anchor" href="#recovery_cache"></a>8.8.4. Recovery cache</h4>
<div class="paragraph">
<p>In order to track in-doubt transactions and be able to reply them, Infinispan caches all transaction state for future use.
This state is held only for in-doubt transaction, being removed for successfully completed transactions after when the commit/rollback phase completed.</p>
</div>
<div class="paragraph">
<p>This in-doubt transaction data is held within a local cache: this allows one to configure swapping this info to disk through cache loader in the case it gets too big.
This cache can be specified through the<code>recovery-cache</code> configuration attribute.
If not specified Infinispan will configure a local cache for you.</p>
</div>
<div class="paragraph">
<p>It is possible (though not mandated) to share same recovery cache between all the Infinispan caches that have recovery enabled.
If the default recovery cache is overridden, then the specified recovery cache must use a <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/transaction/lookup/TransactionManagerLookup.html">TransactionManagerLookup</a> that returns a different transaction manager than the one used by the cache itself.</p>
</div>
</div>
<div class="sect3">
<h4 id="integration_with_the_transaction_manager"><a class="anchor" href="#integration_with_the_transaction_manager"></a>8.8.5. Integration with the transaction manager</h4>
<div class="paragraph">
<p>Even though this is transaction manager specific, generally a transaction manager would need a reference to a <code>XAResource</code> implementation in order to invoke <code>XAResource.recover()</code> on it.
In order to obtain a reference to an Infinispan <code>XAResource</code> following API can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">XAResource</span> xar = cache.getAdvancedCache().getXAResource();</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is a common practice to run the recovery in a different process from the one running the transaction.</p>
</div>
</div>
<div class="sect3">
<h4 id="tx_recovery_reconciliation"><a class="anchor" href="#tx_recovery_reconciliation"></a>8.8.6. Reconciliation</h4>
<div class="paragraph">
<p>The transaction manager informs the system administrator on in-doubt transaction in a proprietary way.
At this stage it is assumed that the system administrator knows transaction&#8217;s XID (a byte array).</p>
</div>
<div class="paragraph">
<p>A normal recovery flow is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>STEP 1</strong>: The system administrator connects to an Infinispan server through JMX, and lists the in doubt transactions.
The image below demonstrates JConsole connecting to an Infinispan node that has an in doubt transaction.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/showInDoubtTx.png" alt="showInDoubtTx">
</div>
<div class="title">Figure 6. Show in-doubt transactions</div>
</div>
<div class="paragraph">
<p>The status of each in-doubt transaction is displayed(in this example " <em>PREPARED</em> ").
There might be multiple elements in the status field, e.g. "PREPARED" and "COMMITTED" in the case the transaction committed on certain nodes but not on all of them.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>STEP 2</strong>: The system administrator visually maps the XID received from the transaction manager to an Infinispan internal id, represented as a number.
This step is needed because the XID, a byte array, cannot conveniently be passed to the JMX tool (e.g. JConsole) and then re-assembled on Infinispan&#8217;s side.</p>
</li>
<li>
<p><strong>STEP 3</strong>: The system administrator forces the transaction&#8217;s commit/rollback through the corresponding jmx operation, based on the internal id.
The image below is obtained by forcing the commit of the transaction based on its internal id.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/forceCommit.png" alt="forceCommit">
</div>
<div class="title">Figure 7. Force commit</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All JMX operations described above can be executed on any node, regardless of where the transaction originated.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="force_commitrollback_based_on_xid"><a class="anchor" href="#force_commitrollback_based_on_xid"></a>Force commit/rollback based on XID</h5>
<div class="paragraph">
<p>XID-based JMX operations for forcing in-doubt transactions' commit/rollback are available as well: these methods receive byte[] arrays describing the XID instead of the number associated with the transactions (as previously described at step 2).
These can be useful e.g. if one wants to set up an automatic completion job for certain in-doubt transactions.
This process is plugged into transaction manager&#8217;s recovery and has access to the transaction manager&#8217;s XID objects.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="want_to_know_more"><a class="anchor" href="#want_to_know_more"></a>8.8.7. Want to know more?</h4>
<div class="paragraph">
<p>The <a href="https://community.jboss.org/wiki/TransactionRecoveryDesign">recovery design document</a> describes in more detail the insides of transaction recovery implementation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tx_total_order"><a class="anchor" href="#tx_total_order"></a>8.9. Total Order based commit protocol</h3>
<div class="paragraph">
<p>The Total Order based protocol is a multi-master scheme (in this context, multi-master scheme means that all nodes can update all the data) as the (optimistic/pessimist) locking mode implemented in Infinispan.
This commit protocol relies on the concept of totally ordered delivery of messages which, informally, implies that each node which delivers a set of messages, delivers them in the same order.</p>
</div>
<div class="paragraph">
<p>This protocol comes with this advantages.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>transactions can be committed in one phase, as they are delivered in the same order by the nodes that receive them.</p>
</li>
<li>
<p>it mitigates distributed deadlocks.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The weaknesses of this approach are the fact that its implementation relies on a single thread per node which delivers the transaction and its modification, and the slightly cost of total ordering the messages in <code>Transport</code>.</p>
</div>
<div class="paragraph">
<p>Thus, this protocol delivers best performance in scenarios of <em>high contention</em> , in which it can benefit from the single-phase commit and the deliver thread is not the bottleneck.</p>
</div>
<div class="paragraph">
<p>Currently, the Total Order based protocol is available only in <em>transactional</em> caches for <em>replicated</em> and <em>distributed</em> modes.</p>
</div>
<div class="sect3">
<h4 id="overview_2"><a class="anchor" href="#overview_2"></a>8.9.1. Overview</h4>
<div class="paragraph">
<p>The Total Order based commit protocol only affects how transactions are committed by Infinispan and the isolation level and write skew affects it behaviour.</p>
</div>
<div class="paragraph">
<p>When write skew is disabled, the transaction can be committed/rolled back in single phase.
The data consistency is guaranteed by the <code>Transport</code> that ensures that all owners of a key will deliver the same transactions set by the same order.</p>
</div>
<div class="paragraph">
<p>On other hand, when write skew is enabled, the protocol adapts and uses one phase commit when it is safe.
In <code>XaResource</code> enlistment, we can use one phase if the <code>TransactionManager</code> request a commit in one phase (last resource commit optimization) and the Infinispan cache is configured in replicated mode.
This optimization is not safe in distributed mode because each node performs the write skew check validation in different keys subset.
When in <code>Synchronization</code> enlistment, the <code>TransactionManager</code> does not provide any information if Infinispan is the only resource enlisted (last resource commit optimization), so it is not possible to commit in a single phase.</p>
</div>
<div class="sect4">
<h5 id="commit_in_one_phase"><a class="anchor" href="#commit_in_one_phase"></a>Commit in one phase</h5>
<div class="paragraph">
<p>When the transaction ends, Infinispan sends the transaction (and its modification) in total order.
This ensures all the transactions are deliver in the same order in all the involved Infinispan nodes.
As a result, when a transaction is delivered, it performs a deterministic write skew check over the same state (if enabled), leading to the same outcome (transaction commit or rollback).</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/total-order-1pc.png" alt="total order 1pc">
</div>
<div class="title">Figure 8. 1-phase commit</div>
</div>
<div class="paragraph">
<p>The figure above demonstrates a high level example with 3 nodes.
<code>Node1</code> and <code>Node3</code> are running one transaction each and lets assume that both transaction writes on the same key.
To make it more interesting, lets assume that both nodes tries to commit at the same time, represented by the first colored circle in the figure.
The <em>blue</em> circle represents the transaction <em>tx1</em> and the <em>green</em> the transaction <em>tx2</em> .
Both nodes do a remote invocation in total order (<em>to-send</em>) with the transaction&#8217;s modifications.
At this moment, all the nodes will agree in the same deliver order, for example, <em>tx1</em> followed by <em>tx2</em> .
Then, each node delivers <em>tx1</em> , perform the validation and commits the modifications.
The same steps are performed for <em>tx2</em> but, in this case, the validation will fail and the transaction is rollback in all the involved nodes.</p>
</div>
</div>
<div class="sect4">
<h5 id="commit_in_two_phases"><a class="anchor" href="#commit_in_two_phases"></a>Commit in two phases</h5>
<div class="paragraph">
<p>In the first phase, it sends the modification in total order and the write skew check is performed.
The result of the write skew check is sent back to the originator.
As soon as it has the confirmation that all keys are successfully validated, it give a positive response to the <code>TransactionManager</code>.
On other hand, if it receives a negative reply, it returns a negative response to the <code>TransactionManager</code>.
Finally, the transaction is committed or aborted in the second phase depending of the <code>TransactionManager</code> request.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/total-order-2pc.png" alt="total order 2pc">
</div>
<div class="title">Figure 9. 2-phase commit</div>
</div>
<div class="paragraph">
<p>The figure above shows the scenario described in the first figure but now committing the transactions using two phases.
When <em>tx1</em> is deliver, it performs the validation and it replies to the <code>TransactionManager</code>.
Next, lets assume that <em>tx2</em> is deliver before the <code>TransactionManager</code> request the second phase for <em>tx1</em>.
In this case, <em>tx2</em> will be enqueued and it will be validated only when <em>tx1</em> is completed.
Eventually, the <code>TransactionManager</code> for <em>tx1</em> will request the second phase (the commit) and all the nodes are free to perform the validation of <em>tx2</em> .</p>
</div>
</div>
<div class="sect4">
<h5 id="transaction_recovery"><a class="anchor" href="#transaction_recovery"></a>Transaction Recovery</h5>
<div class="paragraph">
<p><a href="#tx_recovery">Transaction recovery</a> is currently not available for Total Order based commit protocol.</p>
</div>
</div>
<div class="sect4">
<h5 id="state_transfer"><a class="anchor" href="#state_transfer"></a>State Transfer</h5>
<div class="paragraph">
<p>For simplicity reasons, the total order based commit protocol uses a blocking version of the current state transfer.
The main differences are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>enqueue the transaction deliver while the state transfer is in progress;</p>
</li>
<li>
<p>the state transfer control messages (<code>CacheTopologyControlCommand</code>) are sent in total order.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This way, it provides a synchronization between the state transfer and the transactions deliver that is the same all the nodes.
Although, the transactions caught in the middle of state transfer (i.e. sent before the state transfer start and deliver after it) needs to be re-sent to find a new total order involving the new joiners.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/total-order-joing-during-st.png" alt="total order joing during st">
</div>
<div class="title">Figure 10. Node joining during transaction</div>
</div>
<div class="paragraph">
<p>The figure above describes a node joining.
In the scenario, the <em>tx2</em> is sent in <em>topologyId=1</em> but when it is received, it is in <em>topologyId=2</em> .
So, the transaction is re-sent involving the new nodes.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration_7"><a class="anchor" href="#configuration_7"></a>8.9.2. Configuration</h4>
<div class="paragraph">
<p>To use total order in your cache, you need to add the <code>TOA</code> protocol in your <code>jgroups.xml</code> configuration file.</p>
</div>
<div class="listingblock">
<div class="title">jgroups.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;tom.TOA</span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Check the <a href="http://jgroups.org/manual-3.x/html/index.html">JGroups Manual</a> for more details.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are interested in detail how JGroups guarantees total order, check the link::http://jgroups.org/manual/index.html#TOA[TOA manual].
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also, you need to set the <code>protocol=TOTAL_ORDER</code> in the <code>&lt;transaction&gt;</code> element, as shown in <a href="#tx_configuration">Transaction configuration</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="when_to_use_it"><a class="anchor" href="#when_to_use_it"></a>8.9.3. When to use it?</h4>
<div class="paragraph">
<p>Total order shows benefits when used in write intensive and high contented workloads. It avoids contention in the lock keys.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="locking_concurrency"><a class="anchor" href="#locking_concurrency"></a>9. Locking and Concurrency</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan makes use of multi-versioned concurrency control (<a href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a>) - a concurrency scheme popular with relational databases and other data stores.
MVCC offers many advantages over coarse-grained Java synchronization and even JDK Locks for access to shared data, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>allowing concurrent readers and writers</p>
</li>
<li>
<p>readers and writers do not block one another</p>
</li>
<li>
<p>write skews can be detected and handled</p>
</li>
<li>
<p>internal locks can be striped</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="locking_implementation_details"><a class="anchor" href="#locking_implementation_details"></a>9.1. Locking implementation details</h3>
<div class="paragraph">
<p>Infinispan&#8217;s MVCC implementation makes use of minimal locks and synchronizations, leaning heavily towards lock-free techniques such as <a href="http://en.wikipedia.org/wiki/Compare-and-swap">compare-and-swap</a> and lock-free data structures wherever possible, which helps optimize for multi-CPU and multi-core environments.</p>
</div>
<div class="paragraph">
<p>In particular, Infinispan&#8217;s MVCC implementation is heavily optimized for readers.
Reader threads do not acquire explicit locks for entries, and instead directly read the entry in question.</p>
</div>
<div class="paragraph">
<p>Writers, on the other hand, need to acquire a write lock.
This ensures only one concurrent writer per entry, causing concurrent writers to queue up to change an entry.
To allow concurrent reads, writers make a copy of the entry they intend to modify, by wrapping the entry in an <code>MVCCEntry</code>.
This copy isolates concurrent readers from seeing partially modified state.
Once a write has completed, <code>MVCCEntry.commit()</code> will flush changes to the data container and subsequent readers will see the changes written.</p>
</div>
<div class="sect3">
<h4 id="how_does_it_work_in_clustered_caches"><a class="anchor" href="#how_does_it_work_in_clustered_caches"></a>9.1.1. How does it work in clustered caches?</h4>
<div class="paragraph">
<p>In clustered caches, each key has a node responsible to lock the key. This node is called primary owner.</p>
</div>
<div class="sect4">
<h5 id="non_transactional_caches"><a class="anchor" href="#non_transactional_caches"></a>Non Transactional caches</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The write operation is sent to the primary owner of the key.</p>
</li>
<li>
<p>The primary owner tries to lock the key.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If it succeeds, it forwards the operation to the other owners;</p>
</li>
<li>
<p>Otherwise, an exception is thrown.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the operation is conditional and it fails on the primary owner, it is not forwarded to the other owners.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the operation is executed locally in the primary owner, the first step is skipped.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="transactional_caches"><a class="anchor" href="#transactional_caches"></a>9.1.2. Transactional caches</h4>
<div class="paragraph">
<p>The transactional cache supports optimistic and pessimistic locking mode.
Check section <a href="#tx_locking">Transaction Locking</a> for more information about it.</p>
</div>
</div>
<div class="sect3">
<h4 id="isolation_levels"><a class="anchor" href="#isolation_levels"></a>9.1.3. Isolation levels</h4>
<div class="paragraph">
<p>Isolation level affects what transactions can read when running concurrently with other transaction.
Check section <a href="#tx_isolation_levels">Isolation Levels</a> for more details about it.</p>
</div>
</div>
<div class="sect3">
<h4 id="the_lockmanager"><a class="anchor" href="#the_lockmanager"></a>9.1.4. The LockManager</h4>
<div class="paragraph">
<p>The <code>LockManager</code> is a component that is responsible for locking an entry for writing.
The <code>LockManager</code> makes use of a <code>LockContainer</code> to locate/hold/create locks.
<code>LockContainers</code> come in two broad flavours, with support for lock striping and with support for one lock per entry.</p>
</div>
</div>
<div class="sect3">
<h4 id="lock_striping"><a class="anchor" href="#lock_striping"></a>9.1.5. Lock striping</h4>
<div class="paragraph">
<p>Lock striping entails the use of a fixed-size, shared collection of locks for the entire cache, with locks being allocated to entries based on the entry&#8217;s key&#8217;s hash code.
Similar to the way the JDK&#8217;s <code>ConcurrentHashMap</code> allocates locks, this allows for a highly scalable, fixed-overhead locking mechanism in exchange for potentially unrelated entries being blocked by the same lock.</p>
</div>
<div class="paragraph">
<p>The alternative is to disable lock striping - which would mean a <em>new</em> lock is created per entry.
This approach <em>may</em> give you greater concurrent throughput, but it will be at the cost of additional memory usage, garbage collection churn, etc.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Default lock striping settings</div>
lock striping is disabled by default, due to potential deadlocks that can happen if locks for different keys end up in the same lock stripe.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The size of the shared lock collection used by lock striping can be tuned using the <code>concurrencyLevel</code> attribute of the `&lt;locking /&gt; configuration element.</p>
</div>
<div class="paragraph">
<p><strong>Configuration example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;locking</span> <span class="attribute-name">striping</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false|true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> ConfigurationBuilder().locking().useLockStriping(<span class="predefined-constant">false</span>|<span class="predefined-constant">true</span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="concurrency_levels"><a class="anchor" href="#concurrency_levels"></a>9.1.6. Concurrency levels</h4>
<div class="paragraph">
<p>In addition to determining the size of the striped lock container, this concurrency level is also used to tune any JDK <code>ConcurrentHashMap</code> based collections where related, such as internal to <code>DataContainer</code>s.
Please refer to the JDK <code>ConcurrentHashMap</code> Javadocs for a detailed discussion of concurrency levels, as this parameter is used in exactly the same way in Infinispan.</p>
</div>
<div class="paragraph">
<p><strong>Configuration example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;locking</span> <span class="attribute-name">concurrency-level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">32</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> ConfigurationBuilder().locking().concurrencyLevel(<span class="integer">32</span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="lock_timeout"><a class="anchor" href="#lock_timeout"></a>9.1.7. Lock timeout</h4>
<div class="paragraph">
<p>The lock timeout specifies the amount of time, in milliseconds, to wait for a contented lock.</p>
</div>
<div class="paragraph">
<p><strong>Configuration example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;locking</span> <span class="attribute-name">acquire-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> ConfigurationBuilder().locking().lockAcquisitionTimeout(<span class="integer">10000</span>);
<span class="comment">//alternatively</span>
<span class="keyword">new</span> ConfigurationBuilder().locking().lockAcquisitionTimeout(<span class="integer">10</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="consistency"><a class="anchor" href="#consistency"></a>9.1.8. Consistency</h4>
<div class="paragraph">
<p>The fact that a single owner is locked (as opposed to all owners being locked) does not break the following consistency guarantee:
if key <code>K</code> is hashed to nodes <code>{A, B}</code> and transaction <code>TX1</code> acquires a lock for <code>K</code>, let&#8217;s say on <code>A</code>.
If another transaction, <code>TX2</code>, is started on <code>B</code> (or any other node) and <code>TX2</code> tries to lock <code>K</code> then it will fail with a timeout as the lock is already held by <code>TX1</code>.
The reason for this is the that the lock for a key <code>K</code> is always, deterministically, acquired on the same node of the cluster, regardless of where the transaction originates.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="data_versioning"><a class="anchor" href="#data_versioning"></a>9.2. Data Versioning</h3>
<div class="paragraph">
<p>Infinispan supports two forms of data versioning: simple and external.
The simple versioning is used in transactional caches for write skew check. See <a href="#tx_write_skew">Write Skews</a>.</p>
</div>
<div class="paragraph">
<p>The external versioning is used to encapsulate an external source of data versioning within Infinispan, such as when using Infinispan with Hibernate which in turn gets its data version information directly from a database.</p>
</div>
<div class="paragraph">
<p>In this scheme, a mechanism to pass in the version becomes necessary, and overloaded versions of <code>put()</code> and <code>putForExternalRead()</code> will be provided in <code>AdvancedCache</code> to take in an external data version.
This is then stored on the <code>InvocationContext</code> and applied to the entry at commit time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Write skew checks cannot and will not be performed in the case of external data versioning.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="execute_code_grid"><a class="anchor" href="#execute_code_grid"></a>10. Executing code in the Grid</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The main benefit of a Cache is the ability to very quickly lookup a value
by its key, even across machines. In fact this use alone is probably the reason
many users use Infinispan. However Infinispan can provide many more benefits
that aren&#8217;t immediately apparent. Since Infinispan is usually used in
a cluster of machines we also have features available that can help utilize
the entire cluster for performing the user&#8217;s desired workload.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section covers only executing code in the grid using an embedded cache,
if you are using a remote cache you should check out <a href="#execute_code_remote_grid">Executing code in the Remote Grid</a>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="cluster_executor"><a class="anchor" href="#cluster_executor"></a>10.1. Cluster Executor</h3>
<div class="paragraph">
<p>Since you have a group of machines, it makes sense to leverage their combined
computing power for executing code on all of them them.
The cache manager comes with a nice utility that allows you to
execute arbitrary code in the cluster. Note this feature requires no Cache to be used.  This
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/ClusterExecutor.html">Cluster Executor</a>
can be retrieved by calling executor() on the <code>EmbeddedCacheManager</code>. This executor is retrievable
in both clustered and non clustered configurations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The ClusterExecutor is specifically designed for executing code where the code is not reliant
upon the data in a cache and is used instead as a way to help users to execute code easily
in the cluster.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This manager was built specifically using Java 8 and such has functional APIs in mind, thus all methods take a functional
inteface as an argument. Also since these arguments will be sent to other nodes they need to be serializable.  We even
used a nice trick to ensure our lambdas are immediately Serializable.  That is by having the arguments implement both
Serializable and the real argument type (ie. Runnable or Function).  The JRE will pick the most specific class when
determining which method to invoke, so in that case your lambdas will always be serializable.
It is also possible to use an Externalizer to possibly reduce message size further.</p>
</div>
<div class="paragraph">
<p>The manager by default will submit a given command to all nodes in the cluster including the node
where it was submitted from. You can control on which nodes the task is executed on
by using the <code>filterTargets</code> methods as is explained in the section.</p>
</div>
<div class="sect3">
<h4 id="filtering_execution_nodes"><a class="anchor" href="#filtering_execution_nodes"></a>10.1.1. Filtering execution nodes</h4>
<div class="paragraph">
<p>It is possible to limit on which nodes the command will be ran. For example you may
want to only run a computation on machines in the same rack. Or you may want to perform an operation
once in the local site and again on a different site. A cluster executor can limit what nodes it sends
requests to at the scope of same or different machine, rack or site level.</p>
</div>
<div class="listingblock">
<div class="title">SameRack.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">   EmbeddedCacheManager manager = ...;
   manager.executor().filterTargets(ClusterExecutionPolicy.SAME_RACK).submit(...)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use this topology base filtering you must enable topology aware consistent hashing through <a href="#server_hinting">Server Hinting</a>.</p>
</div>
<div class="paragraph">
<p>You can also filter using a predicate based on the <code>Address</code> of the node. This can also
be optionally combined with topology based filtering in the previous code snippet.</p>
</div>
<div class="paragraph">
<p>We also allow the target node to be chosen by any means using a <code>Predicate</code> that
will filter out which nodes can be considered for execution. Note this can also be combined
with Topology filtering at the same time to allow even more fine control of where you code
is executed within the cluster.</p>
</div>
<div class="listingblock">
<div class="title">Predicate.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">   EmbeddedCacheManager manager = ...;
   <span class="comment">// Just filter</span>
   manager.executor().filterTargets(a -&gt; a.equals(..)).submit(...)
   <span class="comment">// Filter only those in the desired topology</span>
   manager.executor().filterTargets(ClusterExecutionPolicy.SAME_SITE, a -&gt; a.equals(..)).submit(...)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="timeout"><a class="anchor" href="#timeout"></a>10.1.2. Timeout</h4>
<div class="paragraph">
<p>Cluster Executor allows for a timeout to be set per invocation. This defaults to the distributed sync timeout
as configured on the Transport Configuration. This timeout works in both a clustered and non clustered
cache manager. The executor may or may not interrupt the threads executing a task when the timeout expires. However
when the timeout occurs any <code>Consumer</code> or <code>Future</code> will be completed passing back a <code>TimeoutException</code>.
This value can be overridden by ivoking the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/ClusterExecutor.html#timeout-long-java.util.concurrent.TimeUnit-">timeout</a>
method and supplying the desired duration.</p>
</div>
</div>
<div class="sect3">
<h4 id="single_node_submission"><a class="anchor" href="#single_node_submission"></a>10.1.3. Single Node Submission</h4>
<div class="paragraph">
<p>Cluster Executor can also run in single node submission mode instead of submitting the command
to all nodes it will instead pick one of the nodes that would have normally received the command
and instead submit it it to only one. Each submission will possibly use a different node to
execute the task on. This can be very useful to use the ClusterExecutor as a
<code>java.util.concurrent.Executor</code> which you may have noticed that ClusterExecutor implements.</p>
</div>
<div class="listingblock">
<div class="title">SingleNode.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">   EmbeddedCacheManager manager = ...;
   manager.executor().singleNodeSubmission().submit(...)</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="failover"><a class="anchor" href="#failover"></a>Failover</h5>
<div class="paragraph">
<p>When running in single node submission it may be desirable to also allow the Cluster Executor
handle cases where an exception occurred during the processing of a given command by retrying
the command again.
When this occurs the Cluster Executor will choose a single node again to resubmit the command to
up to the desired number of failover attempts. Note the chosen node could be any node that passes
the topology or predicate check. Failover is enabled by invoking the overridden
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/ClusterExecutor.html#singleNodeSubmission-int-">singleNodeSubmission</a>
method. The given command will be resubmitted again to a single node until either
the command completes without exception or the total submission amount is equal to the provided
failover count.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example_pi_approximation"><a class="anchor" href="#example_pi_approximation"></a>10.1.4. Example: PI Approximation</h4>
<div class="paragraph">
<p>This example shows how you can use the ClusterExecutor to estimate the value of PI.</p>
</div>
<div class="paragraph">
<p>Pi approximation can greatly benefit from parallel distributed execution via
Cluster Executor. Recall that area of the square is Sa = 4r2 and area of the
circle is Ca=pi*r2. Substituting r2 from the second equation into the first
one it turns out that pi = 4 * Ca/Sa. Now, image that we can shoot very large
number of darts into a square; if we take ratio of darts that land inside a
circle over a total number of darts shot we will approximate Ca/Sa value. Since
we know that pi = 4 * Ca/Sa we can easily derive approximate value of pi. The
more darts we shoot the better approximation we get. In the example below we
shoot 1 billion darts but instead of "shooting" them serially we parallelize
work of dart shooting across the entire Infinispan cluster. Note this will
work in a cluster of 1 was well, but will be slower.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PiAppx</span> {

   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main (<span class="predefined-type">String</span> <span class="type">[]</span> arg){
      EmbeddedCacheManager cacheManager = ..
      boolean isCluster = ..

      int numPoints = <span class="integer">1</span>_000_000_000;
      <span class="type">int</span> numServers = isCluster ? cacheManager.getMembers().size() : <span class="integer">1</span>;
      <span class="type">int</span> numberPerWorker = numPoints / numServers;

      ClusterExecutor clusterExecutor = cacheManager.executor();
      <span class="type">long</span> start = <span class="predefined-type">System</span>.currentTimeMillis();
      <span class="comment">// We receive results concurrently - need to handle that</span>
      <span class="predefined-type">AtomicLong</span> countCircle = <span class="keyword">new</span> <span class="predefined-type">AtomicLong</span>();
      CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; fut = clusterExecutor.submitConsumer(m -&gt; {
         <span class="type">int</span> insideCircleCount = <span class="integer">0</span>;
         <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; numberPerWorker; i++) {
            <span class="type">double</span> x = <span class="predefined-type">Math</span>.random();
            <span class="type">double</span> y = <span class="predefined-type">Math</span>.random();
            <span class="keyword">if</span> (insideCircle(x, y))
               insideCircleCount++;
         }
         <span class="keyword">return</span> insideCircleCount;
      }, (address, count, throwable) -&gt; {
         <span class="keyword">if</span> (throwable != <span class="predefined-constant">null</span>) {
            throwable.printStackTrace();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address: </span><span class="delimiter">&quot;</span></span> + address + <span class="string"><span class="delimiter">&quot;</span><span class="content"> encountered an error: </span><span class="delimiter">&quot;</span></span> + throwable);
         } <span class="keyword">else</span> {
            countCircle.getAndAdd(count);
         }
      });
      fut.whenComplete((v, t) -&gt; {
         <span class="comment">// This is invoked after all nodes have responded with a value or exception</span>
         <span class="keyword">if</span> (t != <span class="predefined-constant">null</span>) {
            t.printStackTrace();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception encountered while waiting:</span><span class="delimiter">&quot;</span></span> + t);
         } <span class="keyword">else</span> {
            <span class="type">double</span> appxPi = <span class="float">4.0</span> * countCircle.get() / numPoints;

            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Distributed PI appx is </span><span class="delimiter">&quot;</span></span> + appxPi +
                  <span class="string"><span class="delimiter">&quot;</span><span class="content"> using </span><span class="delimiter">&quot;</span></span> + numServers + <span class="string"><span class="delimiter">&quot;</span><span class="content"> node(s), completed in </span><span class="delimiter">&quot;</span></span> + (<span class="predefined-type">System</span>.currentTimeMillis() - start) + <span class="string"><span class="delimiter">&quot;</span><span class="content"> ms</span><span class="delimiter">&quot;</span></span>);
         }
      });

      <span class="comment">// May have to sleep here to keep alive if no user threads left</span>
   }

   <span class="directive">private</span> <span class="directive">static</span> <span class="type">boolean</span> insideCircle(<span class="type">double</span> x, <span class="type">double</span> y) {
      <span class="keyword">return</span> (<span class="predefined-type">Math</span>.pow(x - <span class="float">0.5</span>, <span class="integer">2</span>) + <span class="predefined-type">Math</span>.pow(y - <span class="float">0.5</span>, <span class="integer">2</span>))
            &lt;= <span class="predefined-type">Math</span>.pow(<span class="float">0.5</span>, <span class="integer">2</span>);
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="streams"><a class="anchor" href="#streams"></a>10.2. Streams</h3>
<div class="paragraph">
<p>You may want to process a subset or all data in the cache to produce a result.
This may bring thoughts of Map Reduce. Infinispan allows the user to do something
very similar but utilizes the standard JRE APIs to do so.
Java 8 introduced the concept of a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream</a>
which allows functional-style operations on collections rather than having to procedurally
iterate over the data yourself. Stream operations can be implemented in a fashion very
similar to MapReduce.  Streams, just like MapReduce allow you to perform processing
upon the entirety of your cache, possibly a very large data set, but in an efficient way.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Streams are the preferred method when dealing with data that exists in the cache because streams automatically adjust to cluster topology changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also since we can control how the entries are iterated upon we can more efficiently perform the operations in
a cache that is distributed if you want it to perform all of the operations across the cluster
concurrently.</p>
</div>
<div class="paragraph">
<p>A stream is retrieved from the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html#entrySet--">entrySet</a>,
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html#keySet--">keySet</a> or
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html#values--">values</a> collections returned from the
Cache by invoking the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#stream--">stream</a> or
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#parallelStream--">parallelStream</a> methods.</p>
</div>
<div class="sect3">
<h4 id="common_stream_operations"><a class="anchor" href="#common_stream_operations"></a>10.2.1. Common stream operations</h4>
<div class="paragraph">
<p>This section highlights various options that are present irrespective of what type of underlying cache
you are using.</p>
</div>
</div>
<div class="sect3">
<h4 id="key_filtering"><a class="anchor" href="#key_filtering"></a>10.2.2. Key filtering</h4>
<div class="paragraph">
<p>It is possible to filter the stream so that it only operates upon a given subset of keys.  This can be done
by invoking the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/CacheStream.html#filterKeys-java.util.Set-">filterKeys</a>
method on the <code>CacheStream</code>.  This should always be used over a Predicate
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html?is-external=true#filter-java.util.function.Predicate-">filter</a>
and will be faster if the predicate was holding all keys.</p>
</div>
<div class="paragraph">
<p>If you are familiar with the <code>AdvancedCache</code> interface you may be wondering why you even use
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/AdvancedCache.html#getAll-java.util.Set-">getAll</a>
over this keyFilter.  There are some small benefits (mostly smaller payloads) to using getAll
if you need the entries as is and need them all in memory in the local node.  However if you
need to do processing on these elements a stream is recommended since you will get both
distributed and threaded parallelism for free.</p>
</div>
</div>
<div class="sect3">
<h4 id="segment_based_filtering"><a class="anchor" href="#segment_based_filtering"></a>10.2.3. Segment based filtering</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is an advanced feature and should only be used with deep knowledge of Infinispan segment and hashing techniques.
These segments based filtering can be useful if you need to segment data into separate invocations.
This can be useful when integrating with other tools such as
<a href="http://spark.apache.org/">Apache Spark</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This option is only supported for replicated and distributed caches.  This allows the user to operate upon
a subset of data at a time as determined by the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/distribution/ch/KeyPartitioner.html">KeyPartitioner</a>.
The segments can be filtered by invoking
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/CacheStream.html#filterKeySegments-java.util.Set-">filterKeySegments</a>
method on the <code>CacheStream</code>.  This is applied after the key filter but before any intermediate operations are performed.</p>
</div>
</div>
<div class="sect3">
<h4 id="localinvalidation"><a class="anchor" href="#localinvalidation"></a>10.2.4. Local/Invalidation</h4>
<div class="paragraph">
<p>A stream used with a local or invalidation cache can be used just the same way you would use a stream on a
regular collection. Infinispan handles all of the translations if necessary behind the scenes and works with all
of the more interesting options (ie. storeAsBinary, compatibility mode, and a cache loader).  Only data local to
the node where the stream operation is performed will be used, for example invalidation only uses local entries.</p>
</div>
</div>
<div class="sect3">
<h4 id="example"><a class="anchor" href="#example"></a>10.2.5. Example</h4>
<div class="paragraph">
<p>The code below takes a cache and returns a map with all the cache entries whose values contain the string "JBoss"</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss</span><span class="delimiter">&quot;</span></span>))
              .collect(Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="distributionreplicationscattered"><a class="anchor" href="#distributionreplicationscattered"></a>10.3. Distribution/Replication/Scattered</h3>
<div class="paragraph">
<p>This is where streams come into their stride.  When a stream operation is performed it will
send the various intermediate and terminal operations to each node that has pertinent data.
This allows processing the intermediate values on the nodes owning the data, and only sending
the final results back to the originating nodes, improving performance.</p>
</div>
<div class="sect3">
<h4 id="rehash_aware"><a class="anchor" href="#rehash_aware"></a>10.3.1. Rehash Aware</h4>
<div class="paragraph">
<p>Internally the data is segmented and each node only performs the operations upon the data it owns as a primary owner.
This allows for data to be processed evenly, assuming segments are granular enough to provide for equal amounts of
data on each node.</p>
</div>
<div class="paragraph">
<p>When you are utilizing a distributed cache, the data can be reshuffled between nodes when a
new node joins or leaves. Distributed Streams handle this reshuffling of data automatically so you don&#8217;t
have to worry about monitoring when nodes leave or join the cluster.
Reshuffled entries may be processed a second time, and we keep track of the processed entries at the
key level or at the segment level (depending on the terminal operation) to limit the amount of
duplicate processing.</p>
</div>
<div class="paragraph">
<p>It is possible but highly discouraged to disable rehash awareness on the stream.  This should only be considered if
your request can handle only seeing a subset of data if a rehash occurs.  This can be done by invoking
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/CacheStream.html#disableRehashAware--">CacheStream.disableRehashAware()</a>
The performance gain for most operations when a rehash doesn&#8217;t occur is completely negligible.
The only exceptions are for iterator and forEach, which will use less memory, since they do not have
to keep track of processed keys.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Please rethink disabling rehash awareness unless you really know what you are doing.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="serialization"><a class="anchor" href="#serialization"></a>10.3.2. Serialization</h4>
<div class="paragraph">
<p>Since the operations are sent across to other nodes they must be serializable by Infinispan marshalling.  This allows the
operations to be sent to the other nodes.</p>
</div>
<div class="paragraph">
<p>The simplest way is to use a CacheStream instance and use a lambda just as you would normally.
Infinispan overrides all of the various Stream intermediate and terminal methods to take
Serializable versions of the arguments (ie. SerializableFunction, SerializablePredicate&#8230;&#8203;)
You can find these methods at
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/stream/CacheStream.html">CacheStream</a>.
This relies on the spec to pick the most specific method as defined <a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-15.html#jls-15.12.2.5">here</a>.</p>
</div>
<div class="paragraph">
<p>In our previous example we used a <code>Collector</code> to collect all the results into a <code>Map</code>.
Unfortunately the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collectors.html">Collectors</a>
class doesn&#8217;t produce Serializable instances.  Thus if you need to use these, there are two ways to do so:</p>
</div>
<div class="paragraph">
<p>One option would be to use the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/stream/CacheCollectors.html">CacheCollectors</a>
class which allows for a <code>Supplier&lt;Collector&gt;</code> to be provided.  This instance could then use the
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collectors.html">Collectors</a>
to supply a <code>Collector</code> which is not serialized. You can read more details about how the
collector peforms in a distributed fashion at <a href="user_guide.html#distributed_stream_execution">distributed execution</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(CacheCollectors.serializableCollector(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can avoid the use of
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/stream/CacheCollectors.html">CacheCollectors</a>
and instead use the overloaded <code>collect</code> methods that take <code>Supplier&lt;Collector&gt;</code>.
These overloaded <code>collect</code> methods are only available via <code>CacheStream</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue));</code></pre>
</div>
</div>
<div class="paragraph">
<p>If however you are not able to use the <code>Cache</code> and <code>CacheStream</code> interfaces you cannot utilize <code>Serializable</code>
arguments and you must instead cast the lambdas to be <code>Serializable</code> manually by casting the lambda to multiple
interfaces.  It is not a pretty sight but it gets the job done.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = map.entrySet().stream()
              .filter((<span class="predefined-type">Serializable</span> &amp; <span class="predefined-type">Predicate</span>&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt;&gt;) e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(CacheCollectors.serializableCollector(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The recommended and most performant way is to use an
<a href="user_guide.html#advanced_externalizers">AdvancedExternalizer</a>
as this provides the smallest payload.  Unfortunately this means you cannot
use lamdbas as advanced externalizers require defining the class before hand.</p>
</div>
<div class="paragraph">
<p>You can use an advanced externalizer as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">   <span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(<span class="keyword">new</span> ContainsFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue));

   <span class="type">class</span> <span class="class">ContainsFilter</span> <span class="directive">implements</span> <span class="predefined-type">Predicate</span>&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt;&gt; {
      <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> target;

      ContainsFilter(<span class="predefined-type">String</span> target) {
         <span class="local-variable">this</span>.target = target;
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="type">boolean</span> test(<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; e) {
         <span class="keyword">return</span> e.getValue().contains(target);
      }
   }

   <span class="type">class</span> <span class="class">JbossFilterExternalizer</span> <span class="directive">implements</span> AdvancedExternalizer&lt;ContainsFilter&gt; {

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> ContainsFilter&gt;&gt; getTypeClasses() {
         <span class="keyword">return</span> <span class="predefined-type">Util</span>.asSet(ContainsFilter.class);
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Integer</span> getId() {
         <span class="keyword">return</span> CUSTOM_ID;
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, ContainsFilter object) <span class="directive">throws</span> <span class="exception">IOException</span> {
         output.writeUTF(object.target);
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> ContainsFilter readObject(<span class="predefined-type">ObjectInput</span> input) <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
         <span class="keyword">return</span> <span class="keyword">new</span> ContainsFilter(input.readUTF());
      }
   }</code></pre>
</div>
</div>
<div class="paragraph">
<p>You could also use an advanced externalizer for the collector supplier to reduce the
payload size even further.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">   <span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(<span class="keyword">new</span> ContainsFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(ToMapCollectorSupplier.INSTANCE);

 <span class="type">class</span> <span class="class">ToMapCollectorSupplier</span>&lt;K, U&gt; <span class="directive">implements</span> Supplier&lt;Collector&lt;<span class="predefined-type">Map</span>.Entry&lt;K, U&gt;, ?, <span class="predefined-type">Map</span>&lt;K, U&gt;&gt;&gt; {
      <span class="directive">static</span> <span class="directive">final</span> ToMapCollectorSupplier INSTANCE = <span class="keyword">new</span> ToMapCollectorSupplier();

      <span class="directive">private</span> ToMapCollectorSupplier() { }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> Collector&lt;<span class="predefined-type">Map</span>.Entry&lt;K, U&gt;, ?, <span class="predefined-type">Map</span>&lt;K, U&gt;&gt; get() {
         <span class="keyword">return</span> Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue);
      }
   }

   <span class="type">class</span> <span class="class">ToMapCollectorSupplierExternalizer</span> <span class="directive">implements</span> AdvancedExternalizer&lt;ToMapCollectorSupplier&gt; {

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> ToMapCollectorSupplier&gt;&gt; getTypeClasses() {
         <span class="keyword">return</span> <span class="predefined-type">Util</span>.asSet(ToMapCollectorSupplier.class);
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Integer</span> getId() {
         <span class="keyword">return</span> CUSTOM_ID;
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, ToMapCollectorSupplier object) <span class="directive">throws</span> <span class="exception">IOException</span> {
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> ToMapCollectorSupplier readObject(<span class="predefined-type">ObjectInput</span> input) <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
         <span class="keyword">return</span> ToMapCollectorSupplier.INSTANCE;
      }
   }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="parallel_computation"><a class="anchor" href="#parallel_computation"></a>10.3.3. Parallel Computation</h4>
<div class="paragraph">
<p>Distributed streams by default try to parallelize as much as possible.  It is possible for the end user to control this and
actually they always have to control one of the options.  There are 2 ways these streams are parallelized.</p>
</div>
<div class="paragraph">
<p><strong>Local to each node</strong>
When a stream is created from the cache collection the end user can choose between invoking
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#stream--">stream</a> or
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#parallelStream--">parallelStream</a>
method.  Depending on if the parallel stream was picked will enable multiple threading for
each node locally.  Note that some operations like a rehash aware iterator and forEach operations
will always use a sequential stream locally.  This could be enhanced at some point to allow for
parallel streams locally.</p>
</div>
<div class="paragraph">
<p>Users should be careful when using local parallelism as it requires having a large number of entries or operations
that are computationally expensive to be faster. Also it should be noted that if a user uses a parallel
stream with <code>forEach</code> that the action should not block as this would be executed on the common pool, which
is normally reserved for computation operations.</p>
</div>
<div class="paragraph">
<p><strong>Remote requests</strong>
When there are multiple nodes it may be desirable to control whether the remote requests are all processed
at the same time concurrently or one at a time.  By default all terminal operations except the iterator
perform concurrent requests.  The iterator, method to reduce overall memory pressure on the local node,
only performs sequential requests which actually performs slightly better.</p>
</div>
<div class="paragraph">
<p>If a user wishes to change this default however they can do so by invoking the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/CacheStream.html#sequentialDistribution--">sequentialDistribution</a>
or <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/CacheStream.html#parallelDistribution--">parallelDistribution</a>
methods on the <code>CacheStream</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="task_timeout"><a class="anchor" href="#task_timeout"></a>10.3.4. Task timeout</h4>
<div class="paragraph">
<p>It is possible to set a timeout value for the operation requests. This timeout is used only for remote requests timing out and
it is on a per request basis. The former means the local execution will not timeout and the latter means if you have a failover
scenario as described above the subsequent requests each have a new timeout.  If no timeout is specified it uses the
replication timeout as a default timeout. You can set the timeout in your task by doing the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CacheStream&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; stream = cache.entrySet().stream();
stream.timeout(<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.MINUTES);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information about this, please check the java doc in
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/CacheStream.html#timeout-long-java.util.concurrent.TimeUnit-">timeout</a>
javadoc.</p>
</div>
</div>
<div class="sect3">
<h4 id="injection"><a class="anchor" href="#injection"></a>10.3.5. Injection</h4>
<div class="paragraph">
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream</a>
has a terminal operation called
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#forEach-java.util.function.Consumer-">forEach</a>
which allows for running some sort of side effect operation on the data.  In this case it may be desirable to get a reference to
the <code>Cache</code> that is backing this Stream.  If your <code>Consumer</code> implements the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/stream/CacheAware.html">CacheAware</a>
interface the <code>injectCache</code> method be invoked before the accept method from the <code>Consumer</code> interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="distributed_stream_execution"><a class="anchor" href="#distributed_stream_execution"></a>10.3.6. Distributed Stream execution</h4>
<div class="paragraph">
<p>Distributed streams execution works in a fashion very similiar to map reduce.  Except in this case we are sending zero to many intermediate operations
(map, filter etc.) and a single terminal operation to the various nodes.  The operation basically comes down to the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The desired segments are grouped by which node is the primary owner of the given segment</p>
</li>
<li>
<p>A request is generated to send to each remote node that contains the intermediate and terminal operations including which segments it should process</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The terminal operation will be performed locally if necessary</p>
</li>
<li>
<p>Each remote node will receive this request and run the operations and subsequently send the response back</p>
</li>
</ol>
</div>
</li>
<li>
<p>The local node will then gather the local response and remote responses together performing any kind of reduction required by the operations themselves.</p>
</li>
<li>
<p>Final reduced response is then returned to the user</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In most cases all operations are fully distributed, as in the operations are all fully applied on each remote node and usually only the last operation or something related may be
reapplied to reduce the results from multiple nodes.  One important note is that intermediate values do not actually have to be serializable, it is the last value
sent back that is the part desired (exceptions for various operations will be highlighted below).</p>
</div>
<div class="paragraph">
<p><strong>Terminal operator distributed result reductions</strong>
The following paragraphs describe how the distributed reductions work for the various terminal operators.  Some of these are special in that an intermediate value may
be required to be serializable instead of the final result.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">allMatch noneMatch anyMatch</dt>
<dd>
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#allMatch-java.util.function.Predicate-">allMatch</a>
operation is ran on each node and then all the results are logically anded together locally
to get the appropriate value.  The
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#noneMatch-java.util.function.Predicate-">noneMatch</a>
and
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#anyMatch-java.util.function.Predicate-">anyMatch</a>
operations use a logical or instead. These methods also have early termination support,
stopping remote and local operations once the final result is known.</p>
</dd>
<dt class="hdlist1">collect</dt>
<dd>
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">collect</a>
method is interesting in that it can do a few extra steps.  The remote node performs
everything as normal except it doesn&#8217;t perform the final
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#finisher--">finisher</a>
upon the result and instead sends back the fully combined results.  The local thread
then <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#combiner--">combines</a>
the remote and local result into a value which is then finally finished.  The key
here to remember is that the final value doesn&#8217;t have to be serializable but rather
the values produced from the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#supplier--">supplier</a>
and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#combiner--">combiner</a>
methods.</p>
</dd>
<dt class="hdlist1">count</dt>
<dd>
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#count--">count</a>
method just adds the numbers together from each node.</p>
</dd>
<dt class="hdlist1">findAny findFirst</dt>
<dd>
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#findAny--">findAny</a>
operation returns just the first value they find, whether it was from a remote node
or locally.  Note this supports early termination in that once a value is found it
will not process others.  Note the findFirst method is special since it requires a sorted
intermediate operation, which is detailed in the
<a href="user_guide.html#intermediate_operation_exceptions">exceptions</a> section.</p>
</dd>
<dt class="hdlist1">max min</dt>
<dd>
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#max-java.util.Comparator-">max</a> and
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#min-java.util.Comparator-">min</a> methods find the respective min or max value on each node then a final
reduction is performed locally to ensure only the min or max across all nodes is returned.</p>
</dd>
<dt class="hdlist1">reduce</dt>
<dd>
<p>The various reduce methods <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#reduce-java.util.function.BinaryOperator-">1</a> ,
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#reduce-T-java.util.function.BinaryOperator-">2</a> ,
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#reduce-U-java.util.function.BiFunction-java.util.function.BinaryOperator-">3</a> will end up serializing
the result as much as the accumulator can do.  Then it will accumulate the local and remote results together locally, before combining if you have provided that.  Note this means
a value coming from the combiner doesn&#8217;t have to be Serializable.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="key_based_rehash_aware_operators"><a class="anchor" href="#key_based_rehash_aware_operators"></a>10.3.7. Key based rehash aware operators</h4>
<div class="paragraph">
<p>The <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/CacheStream.html#iterator--">iterator</a>,
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/CacheStream.html#spliterator--">spliterator</a>
and <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/CacheStream.html#forEach-java.util.function.Consumer-">forEach</a>
are unlike the other terminal operators in that the rehash awareness has to keep
track of what keys per segment have been processed instead of just segments.  This is
to guarantee an exactly once (iterator &amp; spliterator) or at least once behavior (forEach)
even under cluster membership changes.</p>
</div>
<div class="paragraph">
<p>The <code>iterator</code> and <code>spliterator</code> operators when invoked on a remote node will return back batches
of entries, where the next batch is only sent back after the last has been fully consumed.  This
batching is done to limit how many entries are in memory at a given time.  The user node will hold
onto which keys it has processed and when a given segment is completed it will release those keys from
memory.  This is why sequential processing is preferred for the iterator method, so only a subset of segment
keys are held in memory at once, instead of from all nodes.</p>
</div>
<div class="paragraph">
<p>The <code>forEach()</code> method also returns batches, but it returns a batch of keys after it has finished processing
at least a batch worth of keys.  This way the originating node can know what keys have been processed
already to reduce chances of processing the same entry again.  Unfortunately this means it is possible
to have an at least once behavior when a node goes down unexpectedly.  In this case that node could have
been processing a batch and not yet completed one and those entries that were processed but not
in a completed batch will be ran again when the rehash failure operation occurs.  Note that adding a
node will not cause this issue as the rehash failover doesn&#8217;t occur until all responses are received.</p>
</div>
<div class="paragraph">
<p>These operations batch sizes are both controlled by the same value which can be configured by invoking
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/CacheStream.html#distributedBatchSize-int-">distributedBatchSize</a>
method on the <code>CacheStream</code>.  This value will default to the <code>chunkSize</code> configured in state transfer.
Unfortunately this value is a tradeoff with memory usage vs performance vs at least once and your
mileage may vary.</p>
</div>
<div class="paragraph">
<p><strong>Using <code>iterator</code> with replicated and distributed caches</strong></p>
</div>
<div class="paragraph">
<p>When a node is the primary or backup owner of all requested segments for a distributed stream, Infinispan performs the <code>iterator</code> or <code>spliterator</code> terminal operations locally, which optimizes performance as remote iterations are more resource intensive.</p>
</div>
<div class="paragraph">
<p>This optimization applies to both replicated and distributed caches. However, Infinispan performs iterations remotely when using cache stores that are both <code>shared</code> and have <code>write-behind</code> enabled. In this case performing the iterations remotely ensures consistency.</p>
</div>
</div>
<div class="sect3">
<h4 id="intermediate_operation_exceptions"><a class="anchor" href="#intermediate_operation_exceptions"></a>10.3.8. Intermediate operation exceptions</h4>
<div class="paragraph">
<p>There are some intermediate operations that have special exceptions, these are
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#skip-long-">skip</a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#peek-java.util.function.Consumer-">peek</a>,
sorted <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#sorted-java.util.Comparator-">1</a>
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#sorted--">2</a>.
&amp; <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#distinct--">distinct</a>.
All of these methods have some sort of artificial iterator implanted in the stream
processing to guarantee correctness, they are documented as below.  Note this means
these operations may cause possibly severe performance degradation.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Skip</dt>
<dd>
<p>An artificial iterator is implanted up to the intermediate skip operation.
Then results are brought locally so it can skip the appropriate amount of elements.</p>
</dd>
<dt class="hdlist1">Sorted</dt>
<dd>
<p>WARNING: This operation requires having all entries in memory on the local node.
An artificial iterator is implanted up to the intermediate sorted operation.
All results are sorted locally.  There are possible plans to have a distributed sort which
returns batches of elements, but this is not yet implemented.</p>
</dd>
<dt class="hdlist1">Distinct</dt>
<dd>
<p>WARNING: This operation requires having all or nearly all entries in memory on the local node.
Distinct is performed on each remote node and then an artificial iterator returns those distinct values.
Then finally all of those results have a distinct operation performed upon them.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The rest of the intermediate operations are fully distributed as one would expect.</p>
</div>
</div>
<div class="sect3">
<h4 id="examples_2"><a class="anchor" href="#examples_2"></a>10.3.9. Examples</h4>
<div class="paragraph">
<p><strong>Word Count</strong></p>
</div>
<div class="paragraph">
<p>Word count is a classic, if overused, example
of map/reduce paradigm. Assume we have a mapping of key &#8594; sentence stored on
Infinispan nodes. Key is a String, each sentence is also a String, and we have
to count occurrence of all words in all sentences available. The implementation
of such a distributed task could be defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordCountExample</span> {

   <span class="comment">/**
    * In this example replace c1 and c2 with
    * real Cache references
    *
    * @param args
    */</span>
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; c1 = ...;
      Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; c2 = ...;

      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world here I am</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan rules the world</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JUDCon is in Boston</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss World is in Boston as well</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">12</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss Application Server</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">15</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">14</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan community</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">15</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world</span><span class="delimiter">&quot;</span></span>);

      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">111</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan open source</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">112</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Boston is close to Toronto</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">113</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Toronto is a capital of Ontario</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">114</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JUDCon is cool</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">211</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss World is awesome</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">212</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss rules</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">213</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss division of RedHat </span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">214</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RedHat community</span><span class="delimiter">&quot;</span></span>);

      <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt; wordCountMap = c1.entrySet().parallelStream()
         .map(e -&gt; e.getValue().split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s</span><span class="delimiter">&quot;</span></span>))
         .flatMap(<span class="predefined-type">Arrays</span>::stream)
         .collect(() -&gt; Collectors.groupingBy(Function.identity(), Collectors.counting()));
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case it is pretty simple to do the word count from the previous example.</p>
</div>
<div class="paragraph">
<p>However what if we want to find the most frequent word in the example?  If you take a second
to think about this case you will realize you need to have all words counted  and available
locally first. Thus we actually have a few options.</p>
</div>
<div class="paragraph">
<p>We could use a finisher on the collector, which is invoked on the user thread
after all the results have been collected.
Some redundant lines have been removed from the previous example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordCountExample</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      <span class="comment">// Lines removed</span>

      <span class="predefined-type">String</span> mostFrequentWord = c1.entrySet().parallelStream()
         .map(e -&gt; e.getValue().split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s</span><span class="delimiter">&quot;</span></span>))
         .flatMap(<span class="predefined-type">Arrays</span>::stream)
         .collect(() -&gt; Collectors.collectingAndThen(
            Collectors.groupingBy(Function.identity(), Collectors.counting()),
               wordCountMap -&gt; {
                  <span class="predefined-type">String</span> mostFrequent = <span class="predefined-constant">null</span>;
                  <span class="type">long</span> maxCount = <span class="integer">0</span>;
                     <span class="keyword">for</span> (<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt; e : wordCountMap.entrySet()) {
                        <span class="type">int</span> count = e.getValue().intValue();
                        <span class="keyword">if</span> (count &gt; maxCount) {
                           maxCount = count;
                           mostFrequent = e.getKey();
                        }
                     }
                     <span class="keyword">return</span> mostFrequent;
               }));

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately the last step is only going to be ran in a single thread, which if we have a lot of
words could be quite slow.  Maybe there is another way to parallelize this with Streams.</p>
</div>
<div class="paragraph">
<p>We mentioned before we are in the local node after processing, so we could actually use
a stream on the map results.  We can therefore use a parallel stream on the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordFrequencyExample</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      <span class="comment">// Lines removed</span>

      <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt; wordCount = c1.entrySet().parallelStream()
              .map(e -&gt; e.getValue().split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s</span><span class="delimiter">&quot;</span></span>))
              .flatMap(<span class="predefined-type">Arrays</span>::stream)
              .collect(() -&gt; Collectors.groupingBy(Function.identity(), Collectors.counting()));
      Optional&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt;&gt; mostFrequent = wordCount.entrySet().parallelStream().reduce(
              (e1, e2) -&gt; e1.getValue() &gt; e2.getValue() ? e1 : e2);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way you can still utilize all of the cores locally when calculating the most frequent element.</p>
</div>
<div class="paragraph">
<p><strong>Remove specific entries</strong></p>
</div>
<div class="paragraph">
<p>Distributed streams can also be used as a way to modify data where it lives.
For example you may want to remove all entries in your cache that contain
a specific word.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">RemoveBadWords</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      <span class="comment">// Lines removed</span>
      <span class="predefined-type">String</span> word = ..

      c1.entrySet().parallelStream()
         .filter(e -&gt; e.getValue().contains(word))
         .forEach((c, e) -&gt; c.remove(e.getKey());</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we carefully note what is serialized and what is not, we notice that only the word along
with the operations are serialized across to other nods as it is captured by the lambda.
However the real saving piece is that the cache operation is performed on the primary
owner thus reducing the amount of network traffic required to remove these values from the
cache. The cache is not captured by the lambda as we provide a special BiConsumer method
override that when invoked on each node passes the cache to the BiConsumer</p>
</div>
<div class="paragraph">
<p>One thing to keep in mind using the <code>forEach</code> command in this manner is that the underlying
stream obtains no locks. The cache remove operation will still obtain locks naturally, but
the value could have changed from what the stream saw. That means that the entry could
have been changed after the stream read it but the remove actually removed it.</p>
</div>
<div class="paragraph">
<p>We have specifically added a new variant which is called <code>LockedStream</code>.</p>
</div>
<div class="paragraph">
<p><strong>Plenty of other examples</strong></p>
</div>
<div class="paragraph">
<p>The <code>Streams</code> API is a JRE tool and there are lots of examples for using it.
Just remember that your operations need to be Serializable in some way.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="distributed_execution"><a class="anchor" href="#distributed_execution"></a>10.4. Distributed Execution</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Distributed Executor has been deprecated as of Infinispan 9.1.
You should use either a Cluster Executor or Distributed Stream to
perform the operations they were doing before.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Infinispan provides distributed execution through a standard JDK <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ExecutorService.html">ExecutorService</a> interface. Tasks submitted for execution, instead of being executed in a local JVM, are executed on an entire cluster of Infinispan nodes. Every DistributedExecutorService is bound to one particular cache. Tasks submitted will have access to key/value pairs from that particular cache if and only if the task submitted is an instance of DistributedCallable. Also note that there is nothing preventing users from submitting a familiar Runnable or Callable just like to any other ExecutorService. However, DistributedExecutorService, as it name implies, will likely migrate submitted Callable or Runnable to another JVM in Infinispan cluster, execute it and return a result to task invoker. Due to a potential task migration to other nodes every Callable, Runnable and/or DistributedCallable submitted must be either Serializable or Externalizable. Also the value returned from a callable must be Serializable or Externalizable as well. If the value returned is not serializable a NotSerializableException will be thrown.</p>
</div>
<div class="paragraph">
<p>Infinispan&#8217;s distributed task executors use data from Infinispan cache nodes as input for execution tasks. Most other distributed frameworks do not have that leverage and users have to specify input for distributed tasks from some well known location. Furthermore, users of Infinispan distributed execution framework do not have to configure store for intermediate and final results thus removing another layer of complexity and maintenance.</p>
</div>
<div class="paragraph">
<p>Our distributed execution framework capitalizes on the fact input data in Infinispan data grid is already load balanced (in case of DIST mode). Since input data is already balanced execution tasks will be automatically balanced as well; users do not have to explicitly assign work tasks to specific Infinispan nodes. However, our framework accommodates users to specify arbitrary subset of cache keys as input for distributed execution tasks.</p>
</div>
<div class="sect3">
<h4 id="distributedcallable_api"><a class="anchor" href="#distributedcallable_api"></a>10.4.1. DistributedCallable API</h4>
<div class="paragraph">
<p>In case users needs access to Infinispan cache data for an execution of a task we recommend that you encapsulate task in <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/distexec/DistributedCallable.html">DistributedCallable</a> interface.
DistributedCallable is a subtype of the existing Callable from java.util.concurrent package; DistributedCallable can be executed in a remote JVM and receive input from Infinispan cache.
Task&#8217;s main algorithm could essentially remain unchanged, only the input source is changed.
Existing Callable implementations most likely get their input in a form of some Java object/primitive while DistributedCallable gets its input from an Infinispan cache.
Therefore, users who have already implemented Callable interface to describe their task units would simply extend DistributedCallable and use keys from Infinispan execution environment as input for the task. Implentation of DistributedCallable can in fact continue to support implementation of an already existing Callable while simultaneously be ready for distribited execution by extending DistributedCallable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">DistributedCallable</span>&lt;K, V, T&gt; <span class="directive">extends</span> <span class="predefined-type">Callable</span>&lt;T&gt; {

   <span class="comment">/**
    * Invoked by execution environment after DistributedCallable
    * has been migrated for execution to a specific node.
    *
    * @param cache
    *           cache whose keys are used as input data for this
    *           DistributedCallable task
    * @param inputKeys
    *           keys used as input for this DistributedCallable task
    */</span>
   <span class="directive">public</span> <span class="type">void</span> setEnvironment(Cache&lt;K, V&gt; cache, <span class="predefined-type">Set</span>&lt;K&gt; inputKeys);

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="callable_and_cdi"><a class="anchor" href="#callable_and_cdi"></a>10.4.2. Callable and CDI</h4>
<div class="paragraph">
<p>Users that do not want or can not implement DistributedCallable yet need a reference to input cache used in DistributedExecutorService have an option of the input cache being injected by CDI mechanism. Upon arrival of user&#8217;s Callable to an Infinispan executing node, Infinispan CDI mechanism will provide appropriate cache reference and inject it to executing Callable. All one has to do is to declare a Cache field in Callable and annotate it with org.infinispan.cdi.Input annotation along with mandatory @Inject annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"> <span class="directive">public</span> <span class="type">class</span> <span class="class">CallableWithInjectedCache</span> <span class="directive">implements</span> <span class="predefined-type">Callable</span>&lt;<span class="predefined-type">Integer</span>&gt;, <span class="predefined-type">Serializable</span> {
<span class="error"></span> <span class="error"></span> <span class="error"></span>
<span class="error"></span> <span class="error"></span> <span class="error"></span> <span class="annotation">@Inject</span>
      <span class="annotation">@Input</span>
<span class="error"></span> <span class="error"></span> <span class="error"></span> <span class="directive">private</span> Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;


<span class="error"></span> <span class="error"></span> <span class="error"></span> <span class="annotation">@Override</span>
<span class="error"></span> <span class="error"></span> <span class="error"></span> <span class="directive">public</span> <span class="predefined-type">Integer</span> call() <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">//use injected cache reference</span>
        <span class="keyword">return</span> <span class="integer">1</span>;
<span class="error"></span> <span class="error"></span> <span class="error"></span> }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="distributedexecutorservice_distributedtaskbuilder_and_distributedtask_api"><a class="anchor" href="#distributedexecutorservice_distributedtaskbuilder_and_distributedtask_api"></a>10.4.3. DistributedExecutorService, DistributedTaskBuilder and DistributedTask API</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/distexec/DistributedExecutorService.html">DistributedExecutorService</a> is a simple extension of a familiar <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ExecutorService.html">ExecutorService</a> from java.util.concurrent package. However, advantages of DistributedExecutorService are not to be overlooked. Existing Callable tasks, instead of being executed in JDK&#8217;s ExecutorService, are also eligible for execution on Infinispan cluster. Infinispan execution environment would migrate a task to execution node(s), run the task and return the result(s) to the calling node. Of course, not all Callable tasks would benefit from parallel distributed execution. Excellent candidates are long running and computationally intensive tasks that can run concurrently and/or tasks using input data that can be processed concurrently. For more details about good candidates for parallel execution and parallel algorithms in general refer to <a href="https://computing.llnl.gov/tutorials/parallel_comp/">Introduction to Parallel Computing</a> .</p>
</div>
<div class="paragraph">
<p>The second advantage of the DistributedExecutorService is that it allows a quick and simple implementation of tasks that take input from Infinispan cache nodes, execute certain computation and return results to the caller. Users would specify which keys to use as input for specified DistributedCallable and submit that callable for execution on Infinispan cluster. Infinispan runtime would locate the appriate keys, migrate DistributedCallable to target execution node(s) and finally return a list of results for each executed Callable. Of course, users can omit specifying input keys in which case Infinispan would execute DistributedCallable on all keys for a specified cache.</p>
</div>
<div class="paragraph">
<p>Lets see how we can use DistributedExecutorService If you already have Callable/Runnable tasks defined! Well, simply submit them to an instance of DefaultExecutorService for execution!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">ExecutorService</span> des = <span class="keyword">new</span> DefaultExecutorService(cache);
<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Boolean</span>&gt; future = des.submit(<span class="keyword">new</span> SomeCallable());
<span class="predefined-type">Boolean</span> r = future.get();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you need to specify more task parameters like task timeout, custom failover policy or execution policy use <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/distexec/DistributedTaskBuilder.html">DistributedTaskBuilder</a> and <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/distexec/DistributedTask.html">DistributedTask</a> API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">DistributedExecutorService des = <span class="keyword">new</span> DefaultExecutorService(cache);
DistributedTaskBuilder&lt;<span class="predefined-type">Boolean</span>&gt; taskBuilder = des.createDistributedTaskBuilder(<span class="keyword">new</span> SomeCallable());
taskBuilder.timeout(<span class="integer">10</span>,<span class="predefined-type">TimeUnit</span>.SECONDS);
...
...
DistributedTask&lt;<span class="predefined-type">Boolean</span>&gt; distributedTask = taskBuilder.build();
<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Boolean</span>&gt; future = des.submit(distributedTask);
<span class="predefined-type">Boolean</span> r = future.get();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="distributed_task_failover"><a class="anchor" href="#distributed_task_failover"></a>10.4.4. Distributed task failover</h4>
<div class="paragraph">
<p>Distributed execution framework supports task failover. By default no failover policy is installed and task&#8217;s Runnable/Callable/DistributedCallable will simply fail. Failover mechanism is invoked in the following cases:</p>
</div>
<div class="paragraph">
<p>a) Failover due to a node failure where task is executing</p>
</div>
<div class="paragraph">
<p>b) Failover due to a task failure (e.g. Callable task throws Exception).</p>
</div>
<div class="paragraph">
<p>Infinispan provides random node failover policy which will attempt execution of a part of distributed task on another random node, if such node is available.  However, users that have a need to implement a more sophisticated failover policy can implement <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/distexec/DistributedTaskFailoverPolicy.html">DistributedTaskFailoverPolicy</a> interface.  For example, users might want to use consistent hashing (CH) mechanism for failover of uncompleted tasks. CH based failover might for example migrate failed task T to cluster node(s) having a backup of input data that was executed on a failed node F.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * DistributedTaskFailoverPolicy allows pluggable fail over target selection for a failed remotely
 * executed distributed task.
 *
 */</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">DistributedTaskFailoverPolicy</span> {

   <span class="comment">/**
    * As parts of distributively executed task can fail due to the task itself throwing an exception
    * or it can be a system caused failure (e.g node failed or left cluster during task
    * execution etc).
    *
    * @param failoverContext
    *           the FailoverContext of the failed execution
    * @return result the Address of the node selected for fail over execution
    */</span>
   Address failover(FailoverContext context);

   <span class="comment">/**
    * Maximum number of fail over attempts permitted by this DistributedTaskFailoverPolicy
    *
    * @return max number of fail over attempts
    */</span>
   <span class="type">int</span> maxFailoverAttempts();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore one could for example specify random failover execution policy simply by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">DistributedExecutorService des = <span class="keyword">new</span> DefaultExecutorService(cache);
DistributedTaskBuilder&lt;<span class="predefined-type">Boolean</span>&gt; taskBuilder = des.createDistributedTaskBuilder(<span class="keyword">new</span> SomeCallable());
taskBuilder.failoverPolicy(DefaultExecutorService.RANDOM_NODE_FAILOVER);
DistributedTask&lt;<span class="predefined-type">Boolean</span>&gt; distributedTask = taskBuilder.build();
<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Boolean</span>&gt; future = des.submit(distributedTask);
<span class="predefined-type">Boolean</span> r = future.get();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="distributed_task_execution_policy"><a class="anchor" href="#distributed_task_execution_policy"></a>10.4.5. Distributed task execution policy</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/distexec/DistributedTaskExecutionPolicy.html">DistributedTaskExecutionPolicy</a> is an enum that allows tasks to specify its custom task execution policy across Infinispan cluster. DistributedTaskExecutionPolicy effectively scopes execution of tasks to a subset of nodes. For example, someone might want to exclusively execute tasks on a local network site instead of a backup remote network centre as well. Others might, for example, use only a dedicated subset of a certain Infinispan rack nodes for specific task execution. DistributedTaskExecutionPolicy is set per instance of DistributedTask.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">DistributedExecutorService des = <span class="keyword">new</span> DefaultExecutorService(cache);
DistributedTaskBuilder&lt;<span class="predefined-type">Boolean</span>&gt; taskBuilder = des.createDistributedTaskBuilder(<span class="keyword">new</span> SomeCallable());
taskBuilder.executionPolicy(DistributedTaskExecutionPolicy.SAME_RACK);
DistributedTask&lt;<span class="predefined-type">Boolean</span>&gt; distributedTask = taskBuilder.build();
<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Boolean</span>&gt; future = des.submit(distributedTask);
<span class="predefined-type">Boolean</span> r = future.get();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="examples_3"><a class="anchor" href="#examples_3"></a>10.4.6. Examples</h4>
<div class="paragraph">
<p>Pi approximation can greatly benefit from parallel distributed execution in DistributedExecutorService. Recall that area of the square is Sa = 4r2 and area of the circle is Ca=pi*r2. Substituting r2 from the second equation into the first one it turns out that pi = 4 * Ca/Sa. Now, image that we can shoot very large number of darts into a square; if we take ratio of darts that land inside a circle over a total number of darts shot we will approximate Ca/Sa value. Since we know that pi = 4 * Ca/Sa we can easily derive approximate value of pi. The more darts we shoot the better approximation we get. In the example below we shoot 10 million darts but instead of "shooting" them serially we parallelize work of dart shooting across entire Infinispan cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  <span class="directive">public</span> <span class="type">class</span> <span class="class">PiAppx</span> {

   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main (<span class="predefined-type">String</span> <span class="type">[]</span> arg){
      <span class="predefined-type">List</span>&lt;Cache&gt; caches = ...;
      Cache cache = ...;

      <span class="type">int</span> numPoints = <span class="integer">10000000</span>;
      <span class="type">int</span> numServers = caches.size();
      <span class="type">int</span> numberPerWorker = numPoints / numServers;

      DistributedExecutorService des = <span class="keyword">new</span> DefaultExecutorService(cache);
      <span class="type">long</span> start = <span class="predefined-type">System</span>.currentTimeMillis();
      CircleTest ct = <span class="keyword">new</span> CircleTest(numberPerWorker);
      <span class="predefined-type">List</span>&lt;<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Integer</span>&gt;&gt; results = des.submitEverywhere(ct);
      <span class="type">int</span> countCircle = <span class="integer">0</span>;
      <span class="keyword">for</span> (<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Integer</span>&gt; f : results) {
         countCircle += f.get();
      }
      <span class="type">double</span> appxPi = <span class="float">4.0</span> * countCircle / numPoints;

      <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Distributed PI appx is </span><span class="delimiter">&quot;</span></span> + appxPi +
      <span class="string"><span class="delimiter">&quot;</span><span class="content"> completed in </span><span class="delimiter">&quot;</span></span> + (<span class="predefined-type">System</span>.currentTimeMillis() - start) + <span class="string"><span class="delimiter">&quot;</span><span class="content"> ms</span><span class="delimiter">&quot;</span></span>);
   }

   <span class="directive">private</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">CircleTest</span> <span class="directive">implements</span> <span class="predefined-type">Callable</span>&lt;<span class="predefined-type">Integer</span>&gt;, <span class="predefined-type">Serializable</span> {

      <span class="comment">/** The serialVersionUID */</span>
      <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">long</span> serialVersionUID = <span class="integer">3496135215525904755L</span>;

      <span class="directive">private</span> <span class="directive">final</span> <span class="type">int</span> loopCount;

      <span class="directive">public</span> CircleTest(<span class="type">int</span> loopCount) {
         <span class="local-variable">this</span>.loopCount = loopCount;
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Integer</span> call() <span class="directive">throws</span> <span class="exception">Exception</span> {
         <span class="type">int</span> insideCircleCount = <span class="integer">0</span>;
         <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; loopCount; i++) {
            <span class="type">double</span> x = <span class="predefined-type">Math</span>.random();
            <span class="type">double</span> y = <span class="predefined-type">Math</span>.random();
            <span class="keyword">if</span> (insideCircle(x, y))
               insideCircleCount++;
         }
         <span class="keyword">return</span> insideCircleCount;
      }

      <span class="directive">private</span> <span class="type">boolean</span> insideCircle(<span class="type">double</span> x, <span class="type">double</span> y) {
         <span class="keyword">return</span> (<span class="predefined-type">Math</span>.pow(x - <span class="float">0.5</span>, <span class="integer">2</span>) + <span class="predefined-type">Math</span>.pow(y - <span class="float">0.5</span>, <span class="integer">2</span>))
         &lt;= <span class="predefined-type">Math</span>.pow(<span class="float">0.5</span>, <span class="integer">2</span>);
      }
   }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="indexing_querying"><a class="anchor" href="#indexing_querying"></a>11. Indexing and Querying</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="overview_3"><a class="anchor" href="#overview_3"></a>11.1. Overview</h3>
<div class="paragraph">
<p>Infinispan supports indexing and searching of Java Pojo(s) or objects encoded via <a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a>
stored in the grid using powerful search APIs which complement its main Map-like API.</p>
</div>
<div class="paragraph">
<p>Querying is possible both in <a href="#query_library">library</a> and <a href="#query_remote">client/server mode</a> (for Java, C#, Node.js and other clients), and Infinispan can index data
using <a href="http://lucene.apache.org/">Apache Lucene</a>, offering an efficient <a href="https://en.wikipedia.org/wiki/Full-text_search">full-text</a>
capable search engine in order to cover a wide range of data retrieval use cases.</p>
</div>
<div class="paragraph">
<p>Indexing configuration relies on a schema definition, and for that Infinispan can use annotated Java classes when in library mode,
and protobuf schemas for remote clients written in other languages. By standardizing on protobuf, Infinispan allows full interoperability
between Java and non-Java clients.</p>
</div>
<div class="paragraph">
<p>Apart from indexed queries, Infinispan can run queries over non-indexed data (<a href="#query_indexless">indexless queries</a>) and over partially indexed data (<a href="#query_hybrid">hybrid queries</a>).</p>
</div>
<div class="paragraph">
<p>In terms of Search APIs, Infinispan has its own query language called <em><a href="#query_ickle">Ickle</a></em>, which is string-based and adds support for full-text
querying. The <a href="#query_dsl">Query DSL</a> can be used for both embedded and remote java clients when full-text is not required; for Java embedded clients
Infinispan offers the <a href="#query_hibernatesearch">Hibernate Search Query API</a> which supports running Lucene queries in the grid, apart from advanced search capabilities
like Faceted and Spatial search.</p>
</div>
<div class="paragraph">
<p>Finally, Infinispan has support for <a href="#query_continuous">Continuous Queries</a>, which works in a reverse manner to the other APIs: instead of creating, executing a query
and obtain results, it allows a client to register queries that will be evaluated continuously as data in the cluster changes, generating notifications
whenever the changed data matches the queries.</p>
</div>
</div>
<div class="sect2">
<h3 id="query_library"><a class="anchor" href="#query_library"></a>11.2. Embedded Querying</h3>
<div class="paragraph">
<p>Embedded querying is available when Infinispan is used as a library. No protobuf mapping is required, and both indexing and searching
are done on top of Java objects. When in library mode, it is possible to run Lucene queries directly and use all the available <a href="#query_apis">Query APIs</a> and it also allows flexible indexing configurations to keep latency to a minimal.</p>
</div>
<div class="sect3">
<h4 id="quick_example"><a class="anchor" href="#quick_example"></a>11.2.1. Quick example</h4>
<div class="paragraph">
<p>We&#8217;re going to store <em>Book</em> instances in an Infinispan cache called "books". <em>Book</em> instances will be indexed, so we enable indexing for the cache,
letting Infinispan <a href="#query_autoconfig">configure the indexing automatically</a>:</p>
</div>
<div class="paragraph">
<p>Infinispan configuration:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
    <span class="tag">&lt;cache-container&gt;</span>
        <span class="tag">&lt;transport</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-cluster</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-config</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/distributed-cache&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Obtaining the cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.Cache</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.manager.DefaultCacheManager</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.manager.EmbeddedCacheManager</span>;

EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.xml</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Book</span>&gt; cache = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each <em>Book</em> will be defined as in the following example; we have to choose which properties are indexed, and for each property we can optionally choose advanced indexing options using the annotations defined in the Hibernate Search project.</p>
</div>
<div class="listingblock">
<div class="title">Book.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.hibernate.search.annotations</span>.*;
<span class="keyword">import</span> <span class="include">java.util.Date</span>;
<span class="keyword">import</span> <span class="include">java.util.HashSet</span>;
<span class="keyword">import</span> <span class="include">java.util.Set</span>;

<span class="comment">//Values you want to index need to be annotated with @Indexed, then you pick which fields and how they are to be indexed:</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> title;
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> description;
   <span class="annotation">@Field</span> <span class="annotation">@DateBridge</span>(resolution=Resolution.YEAR) <span class="predefined-type">Date</span> publicationYear;
   <span class="annotation">@IndexedEmbedded</span> <span class="predefined-type">Set</span>&lt;Author&gt; authors = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;Author&gt;();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Author.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> name;
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> surname;
   <span class="comment">// hashCode() and equals() omitted</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now assuming we stored several <em>Book</em> instances in our Infinispan <em>Cache</em> , we can search them for any matching field as in the following example.</p>
</div>
<div class="paragraph">
<p>Using a Lucene Query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// get the search manager from the cache:</span>
SearchManager searchManager = org.infinispan.query.Search.getSearchManager(cache);

<span class="comment">// create any standard Lucene query, via Lucene's QueryParser or any other means:</span>
org.apache.lucene.search.Query fullTextQuery = <span class="comment">//any Apache Lucene Query</span>

<span class="comment">// convert the Lucene query to a CacheQuery:</span>
CacheQuery cacheQuery = searchManager.getQuery( fullTextQuery );

<span class="comment">// get the results:</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Object</span>&gt; found = cacheQuery.list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>A Lucene Query is often created by parsing a query in text format such as "title:infinispan AND authors.name:sanne", or by using the query builder provided by Hibernate Search.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// get the search manager from the cache:</span>
SearchManager searchManager = org.infinispan.query.Search.getSearchManager( cache );

<span class="comment">// you could make the queries via Lucene APIs, or use some helpers:</span>
QueryBuilder queryBuilder = searchManager.buildQueryBuilderForClass(<span class="predefined-type">Book</span>.class).get();

<span class="comment">// the queryBuilder has a nice fluent API which guides you through all options.</span>
<span class="comment">// this has some knowledge about your object, for example which Analyzers</span>
<span class="comment">// need to be applied, but the output is a fairly standard Lucene Query.</span>
org.apache.lucene.search.Query luceneQuery = queryBuilder.phrase()
                  .onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>)
                  .andField(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>)
                  .sentence(<span class="string"><span class="delimiter">&quot;</span><span class="content">a book on highly scalable query engines</span><span class="delimiter">&quot;</span></span>)
                  .createQuery();

<span class="comment">// the query API itself accepts any Lucene Query, and on top of that</span>
<span class="comment">// you can restrict the result to selected class types:</span>
CacheQuery query = searchManager.getQuery(luceneQuery, <span class="predefined-type">Book</span>.class);

<span class="comment">// and there are your results!</span>
<span class="predefined-type">List</span> objectList = query.list();

<span class="keyword">for</span> (<span class="predefined-type">Object</span> book : objectList) {
      <span class="predefined-type">System</span>.out.println(book);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Apart from <em>list()</em> you have the option for streaming results, or use pagination.</p>
</div>
<div class="paragraph">
<p>For searches that do not require Lucene or full-text capabilities and are mostly about aggregation and exact matches, we can use the Infinispan Query DSL API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.QueryFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.Query</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;

<span class="comment">// get the query factory:</span>
QueryFactory queryFactory = Search.getQueryFactory(cache);

<span class="predefined-type">Query</span> q = queryFactory.from(<span class="predefined-type">Book</span>.class)
            .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.surname</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">King</span><span class="delimiter">&quot;</span></span>)
            .build();

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; list = q.list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we can use an <a href="#query_ickle">Ickle</a> query directly, allowing for Lucene syntax in one or more predicates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.QueryFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.Query</span>;

<span class="comment">// get the query factory:</span>
QueryFactory queryFactory = Search.getQueryFactory(cache);


<span class="predefined-type">Query</span> q = queryFactory.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from Book b where b.author.name = 'Stephen' and </span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content">b.description : (+'dark' -'tower')</span><span class="delimiter">&quot;</span></span>);

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; list = q.list();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="indexing"><a class="anchor" href="#indexing"></a>11.2.2. Indexing</h4>
<div class="paragraph">
<p>Indexing in Infinispan happens on a per-cache basis and by default a cache is not indexed. Enabling indexing is not mandatory but queries using an index will
have a vastly superior performance. On the other hand, enabling indexing can impact negatively the write throughput of a cluster, so make sure to check the <a href="#query_performance">query performance guide</a> for some strategies to minimize this impact depending on the cache type and use case.</p>
</div>
<div class="sect4">
<h5 id="configuration_8"><a class="anchor" href="#configuration_8"></a>Configuration</h5>
<div class="sect5">
<h6 id="general_format"><a class="anchor" href="#general_format"></a>General format</h6>
<div class="paragraph">
<p>To enable indexing via XML, you need to add the <code>&lt;indexing&gt;</code> element plus the <code>index</code> (<a href="#query_index_mode">index mode</a>)
to your cache configuration, and optionally pass additional properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">property.name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>some value<span class="tag">&lt;/property&gt;</span>
         <span class="tag">&lt;/indexing&gt;</span>
      <span class="tag">&lt;/replicated-cache&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Programmatic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache</span>.*;

ConfigurationBuilder cacheCfg = ...
cacheCfg.indexing().index(Index.ALL)
      .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">property name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">propery value</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="index_names"><a class="anchor" href="#index_names"></a>Index names</h6>
<div class="paragraph">
<p>Each property inside the <code>index</code> element is prefixed with the index name, for the index named <code>org.infinispan.sample.Car</code> the <code>directory_provider</code> is <code>local-heap</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    ...
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.sample.Car.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>local-heap<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
    ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cacheCfg.indexing()
   .index(Index.ALL)
      .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.sample.Car.directory_provider</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">local-heap</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan creates an index for each entity existent in a cache, and it allows to configure those indexes independently.
For a class annotated with <code>@Indexed</code>, the index name is the fully qualified class name, unless overridden with the
<code>name</code> argument in the annotation.</p>
</div>
<div class="paragraph">
<p>In the snippet below, the default storage for all entities is <code>infinispan</code>, but <code>Boat</code> instances will be stored on <code>local-heap</code> in an index named
<code>boatIndex</code>. <code>Airplane</code> entities will also be stored in <code>local-heap</code>. Any other entity&#8217;s index will be configured with the property prefixed by <code>default</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.infinispan.sample</span>;

<span class="annotation">@Indexed</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">boatIndex</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Boat</span> {

}

<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Airplane</span> {

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    ...
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>infinispan<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">boatIndex.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>local-heap<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.sample.Airplane.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ram
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
    ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="specifying_indexed_entities"><a class="anchor" href="#specifying_indexed_entities"></a>Specifying indexed Entities</h6>
<div class="paragraph">
<p>Infinispan can automatically recognize and manage indexes for different entity types in a cache. Future versions of Infinispan will remove this capability so it&#8217;s recommended to
declare upfront which types are going to be indexed (list them by their fully qualified class name). This can be done via xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;indexed-entities&gt;</span>
                <span class="tag">&lt;indexed-entity&gt;</span>com.acme.query.test.Car<span class="tag">&lt;/indexed-entity&gt;</span>
                <span class="tag">&lt;indexed-entity&gt;</span>com.acme.query.test.Truck<span class="tag">&lt;/indexed-entity&gt;</span>
            <span class="tag">&lt;/indexed-entities&gt;</span>
         <span class="tag">&lt;/indexing&gt;</span>
      <span class="tag">&lt;/replicated-cache&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"> cacheCfg.indexing()
      .index(Index.ALL)
       .addIndexedEntity(Car.class)
       .addIndexedEntity(Truck.class)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In server mode, the class names listed under the 'indexed-entities' element must use the 'extended' class name format
which is composed of a JBoss Modules module identifier, a slot name, and the fully qualified class name, these three
components being separated by the ':' character, (eg. "com.acme.my-module-with-entity-classes:my-slot:com.acme.query.test.Car").
The entity classes must be located in the referenced module, which can be either a user supplied module deployed in the
'modules' folder of your server or a plain jar deployed in the 'deployments' folder. The module in question will become
an automatic dependency of your Cache, so its eventual redeployment will cause the cache to be restarted.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only for server, if you fail to follow the requirement of using 'extended' class names and use a plain class name
its resolution will fail due to missing class because the wrong ClassLoader is being used (the Infinispan&#8217;s internal
class path is being used).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="query_index_mode"><a class="anchor" href="#query_index_mode"></a>Index mode</h5>
<div class="paragraph">
<p>An Infinispan node typically receives data from two sources: local and remote. Local translates to clients manipulating data using the map API in the same JVM;
remote data comes from other Infinispan nodes during replication or rebalancing.</p>
</div>
<div class="paragraph">
<p>The index mode configuration defines, from a node in the cluster point of view, which data gets indexed.</p>
</div>
<div class="paragraph">
<p>Possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ALL: all data is indexed, local and remote.</p>
</li>
<li>
<p>LOCAL: only local data is indexed.</p>
</li>
<li>
<p>PRIMARY_OWNER: Only entries containing keys that the node is primary owner will be indexed, regardless of local or remote origin.</p>
</li>
<li>
<p>NONE: no data is indexed. Equivalent to not configure indexing at all.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="query_index_manager"><a class="anchor" href="#query_index_manager"></a>Index Managers</h5>
<div class="paragraph">
<p>Index managers are central components in Infinispan Querying responsible for the indexing configuration, distribution and internal lifecycle of several query components such as Lucene&#8217;s
<em>IndexReader</em> and <em>IndexWriter</em>. Each Index Manager is associated with a <em>Directory Provider</em>, which defines the physical storage of the index.</p>
</div>
<div class="paragraph">
<p>Regarding index distribution, Infinispan can be configured with shared or non-shared indexes.</p>
</div>
</div>
<div class="sect4">
<h5 id="query_shared_index"><a class="anchor" href="#query_shared_index"></a>Shared indexes</h5>
<div class="paragraph">
<p>A shared index is a single, distributed, cluster-wide index for a certain cache. The main advantage is that the index is visible from every node and can be queried as if the index were local, there is no need to <a href="#query_clustered_query_api">broadcast</a>
queries to all members and aggregate the results. The downside is that Lucene does not allow more than a single process writing to the index at the same time, and the coordination of lock acquisitions needs to be done by a proper shared index capable index manager.
In any case, having a single write lock cluster-wise can lead to some degree of contention under heavy writing.</p>
</div>
<div class="paragraph">
<p>Infinispan supports shared indexes leveraging the <a href="#integrations_directory_provider">Infinispan Directory Provider</a>, which stores indexes in a separate set of caches. Two index managers are available
to use shared indexes: InfinispanIndexManager and AffinityIndexManager.</p>
</div>
<div class="sect5">
<h6 id="effect_of_the_index_mode"><a class="anchor" href="#effect_of_the_index_mode"></a>Effect of the index mode</h6>
<div class="paragraph">
<p>Shared indexes should not use the <code>ALL</code> index mode since it&#8217;d lead to redundant indexing: since there is a single index cluster wide, the entry would get indexed when inserted via Cache API, and another time
when Infinispan replicates it to another node. The <code>ALL</code> mode is usually associates with <a href="#query_non_shared_index">non-shared indexes</a> in order to create full index replicas on each node.</p>
</div>
</div>
<div class="sect5">
<h6 id="infinispanindexmanager"><a class="anchor" href="#infinispanindexmanager"></a>InfinispanIndexManager</h6>
<div class="paragraph">
<p>This index manager uses the <a href="#integrations_directory_provider">Infinispan Directory Provider</a>, and is suitable for creating shared indexes. Index mode should be set to <code>LOCAL</code> in this configuration.</p>
</div>
<div class="paragraph">
<p>Configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            org.infinispan.query.indexmanager.InfinispanIndexManager
        <span class="tag">&lt;/property&gt;</span>
        <span class="comment">&lt;!-- optional: tailor each index cache --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.locking_cachename</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>LuceneIndexesLocking_custom<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.data_cachename</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>LuceneIndexesData_custom<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.metadata_cachename</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>LuceneIndexesMetadata_custom<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span>

<span class="comment">&lt;!-- Optional --&gt;</span>
<span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesLocking_custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;--</span> <span class="attribute-name">extra</span> <span class="attribute-name">configuration</span> <span class="attribute-name">--</span><span class="tag">&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span>

<span class="comment">&lt;!-- Optional --&gt;</span>
<span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesMetadata_custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;--</span> <span class="attribute-name">extra</span> <span class="attribute-name">configuration</span> <span class="attribute-name">--</span><span class="tag">&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span>

<span class="comment">&lt;!-- Optional --&gt;</span>
<span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesData_custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;--</span> <span class="attribute-name">extra</span> <span class="attribute-name">configuration</span> <span class="attribute-name">--</span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Indexes are stored in a set of clustered caches, called by default <em>LuceneIndexesData</em>, <em>LuceneIndexesMetadata</em> and <em>LuceneIndexesLocking</em>.</p>
</div>
<div class="paragraph">
<p>The <em>LuceneIndexesLocking</em> cache is used to store Lucene locks, and it is a very small cache: it will contain one entry per entity (index).</p>
</div>
<div class="paragraph">
<p>The <em>LuceneIndexesMetadata</em> cache is used to store info about the logical files that are part of the index, such as names, chunks and sizes and it is also
small in size.</p>
</div>
<div class="paragraph">
<p>The <em>LuceneIndexesData</em> cache is where most of the index is located: it is much bigger then the other two but should be smaller than the data in the cache itself, thanks to Lucene&#8217;s
efficient storing techniques.</p>
</div>
<div class="paragraph">
<p>It&#8217;s not necessary to redefine the configuration of those 3 cases, Infinispan will pick sensible defaults.
Reasons re-define them would be performance tuning for a specific scenario, or for example to make them persistent by configuring a cache store.</p>
</div>
<div class="paragraph">
<p>In order to avoid index corruption when two or more nodes of the cluster try to write to the index at the same time, the <em>InfinispanIndexManager</em> internally
elects a master in the cluster (which is the JGroups coordinator) and forwards all indexing works to this master.</p>
</div>
</div>
<div class="sect5">
<h6 id="query_affinity_index_manager"><a class="anchor" href="#query_affinity_index_manager"></a>AffinityIndexManager</h6>
<div class="paragraph">
<p>The AffinityIndexManager is an <strong>experimental</strong> index manager used for shared indexes that also stores indexes using the <a href="#integrations_directory_provider">Infinispan Directory Provider</a>.
Unlike the InfinispanIndexManager, it does not have a single node (master) that handles all the indexing cluster wide, but rather splits the index using multiple shards, each shard being responsible for indexing data associated with one or more Infinispan segments.
For an in-depth description of the inner workings, please see the <a href="https://github.com/infinispan/infinispan/wiki/Index-affinity-proposal">design doc</a>.</p>
</div>
<div class="paragraph">
<p>The PRIMARY_OWNER index mode is required, together with a special kind of <code>KeyPartitioner</code>.</p>
</div>
<div class="paragraph">
<p>XML Configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">key-partitioner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.distribution.ch.impl.AffinityPartitioner</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PRIMARY_OWNER</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            org.infinispan.query.affinity.AffinityIndexManager
        <span class="tag">&lt;/property&gt;</span>
        <span class="comment">&lt;!-- optional: control the number of shards, the default is 4 --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.sharding_strategy.nbr_of_shards</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>10<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Programmatic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.distribution.ch.impl.AffinityPartitioner</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.affinity.AffinityIndexManager</span>;

ConfigurationBuilder cacheCfg = ...
cacheCfg.clustering().hash().keyPartitioner(<span class="keyword">new</span> AffinityPartitioner());
cacheCfg.indexing()
      .index(Index.PRIMARY_OWNER)
      .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span>, AffinityIndexManager.class.getName())
      .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">default.sharding_strategy.nbr_of_shards</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>AffinityIndexManager</code> by default will have as many shards as Infinispan segments, but this value is configurable as seen in the example above.</p>
</div>
<div class="paragraph">
<p>The number of shards affects directly the query performance and writing throughput: generally speaking, a high number of shards offers better write throughput but
has an adverse effect on query performance.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="query_non_shared_index"><a class="anchor" href="#query_non_shared_index"></a>Non-shared indexes</h5>
<div class="paragraph">
<p>Non-shared indexes are independent indexes at each node. This setup is particularly advantageous for replicated caches where each node has all the cluster data
and thus can hold all the indexes as well, offering optimal query performance with zero network latency when querying. Another advantage is, since the index
is local to each node, there is less contention during writes due to the fact that each node is subjected to its own index lock, not a cluster wide one.</p>
</div>
<div class="paragraph">
<p>Since each node might hold a partial index, it may be necessary to link#query_clustered_query_api[broadcast] queries in order to get correct search results, which
can add latency. If the cache is REPL, though, the broadcast is not necessary: each node can hold a full local copy of the index and queries runs at optimal speed
taking advantage of a local index.</p>
</div>
<div class="paragraph">
<p>Infinispan has two index managers suitable for non-shared indexes: <code>directory-based</code> and <code>near-real-time</code>. Storage wise, non-shared indexes can be located
in ram, filesystem, or Infinispan local caches.</p>
</div>
<div class="sect5">
<h6 id="effect_of_the_index_mode_2"><a class="anchor" href="#effect_of_the_index_mode_2"></a>Effect of the index mode</h6>
<div class="paragraph">
<p>The <code>directory-based</code> and <code>near-real-time</code> index managers can be associated with different <a href="#query_index_mode">index modes</a>, resulting in different index distributions.</p>
</div>
<div class="paragraph">
<p>REPL caches combined with the <code>ALL</code> index mode will result in a full copy of the cluster-wide index on each node. This mode allows queries to become effectively local without
network latency. This is the recommended mode to index any REPL cache, and that&#8217;s the choice picked by the <a href="#query_autoconfig">auto-config</a> when the a REPL cache is detected. The <code>ALL</code> mode should not be used with DIST caches.</p>
</div>
<div class="paragraph">
<p>REPL or DIST caches combined with <code>LOCAL</code> index mode will cause each node to index only data inserted from the same JVM, causing an uneven distribution of the index. In order
to obtain correct query results, it&#8217;s necessary to use <a href="#query_clustered_query_api">broadcast</a> queries.</p>
</div>
<div class="paragraph">
<p>REPL or DIST caches combined with <code>PRIMARY_OWNER</code> will also need broadcast queries. Differently from the <code>LOCAL</code> mode, each node&#8217;s index will contain indexed entries which key is primarily owned by the node according to the consistent hash, leading to a more evenly distributed indexes among the nodes.</p>
</div>
</div>
<div class="sect5">
<h6 id="query_directory_based"><a class="anchor" href="#query_directory_based"></a>directory-based index manager</h6>
<div class="paragraph">
<p>This is the default Index Manager used when no index manager is configured. The <code>directory-based</code> index manager is used to manage indexes backed by a local lucene directory. It supports <em>ram</em>, <em>filesystem</em> and non-clustered
<em>infinispan</em> storage.</p>
</div>
<div class="paragraph">
<p><strong class="small">Filesystem storage</strong></p>
</div>
<div class="paragraph">
<p>This is the default storage, and used when index manager configuration is omitted. The index is stored in the filesystem using a <a href="https://lucene.apache.org/core/6_0_0/core/org/apache/lucene/store/MMapDirectory.html">MMapDirectory</a>.
It is the recommended storage for local indexes. Although indexes are persistent on disk, they get memory mapped by Lucene and thus offer decent query performance.</p>
</div>
<div class="paragraph">
<p>Configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="comment">&lt;!-- Optional: define base folder for indexes --&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexBase</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${java.io.tmpdir}/baseDir<span class="tag">&lt;/property&gt;</span>
   <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan will create a different folder under <code>default.indexBase</code> for each entity (index) present in the cache.</p>
</div>
<div class="paragraph">
<p><strong class="small">Ram storage</strong></p>
</div>
<div class="paragraph">
<p>Index is stored in memory using a <a href="https://lucene.apache.org/core/6_0_0/core/org/apache/lucene/store/RAMDirectory.html">Lucene RAMDirectory</a>.
Not recommended for large indexes or highly concurrent situations. Indexes stored in Ram are not persistent, so after a cluster shutdown a <a href="#query_massindexer">re-index</a>
is needed. Configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>local-heap<span class="tag">&lt;/property&gt;</span>
   <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong class="small">Infinispan storage</strong></p>
</div>
<div class="paragraph">
<p>Infinispan storage makes use of the <a href="#integrations_lucene_directory">Infinispan Lucene directory</a> that saves the indexes to a set of caches; those caches can be configured like any other Infinispan cache, for example by adding a cache store to have indexes persisted elsewhere apart from memory.
In order to use Infinispan storage with a non-shared index, it&#8217;s necessary to use LOCAL caches for the indexes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.locking_cachename</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>LuceneIndexesLocking_custom<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.data_cachename</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>LuceneIndexesData_custom<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.metadata_cachename</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>LuceneIndexesMetadata_custom<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span>

<span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesLocking_custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span>

<span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesMetadata_custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span>

<span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesData_custom</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="near_real_time_index_manager"><a class="anchor" href="#near_real_time_index_manager"></a>near-real-time index manager</h6>
<div class="paragraph">
<p>Similar to the <code>directory-based</code> index manager but takes advantage of the Near-Real-Time features of Lucene. It has better write performance than
the <code>directory-based</code> because it flushes the index to the underlying store less often. The drawback is that unflushed index changes can be lost in case
of a non-clean shutdown. Can be used in conjunction with <code>local-heap</code>, <code>filesystem</code> and local infinispan storage. Configuration for each different storage
type is the same as the <a href="#query_directory_based">directory-based</a> index manager.</p>
</div>
<div class="paragraph">
<p>Example with ram:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>near-real-time<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>local-heap<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example with filesystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>near-real-time<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="external_indexes"><a class="anchor" href="#external_indexes"></a>External indexes</h5>
<div class="paragraph">
<p>Apart from having shared and non-shared indexes managed by Infinispan itself, it is possible to offload indexing to a third party search engine: currently
Infinispan supports Elasticsearch as a external index storage.</p>
</div>
<div class="sect5">
<h6 id="elasticsearch_indexmanager_experimental"><a class="anchor" href="#elasticsearch_indexmanager_experimental"></a>Elasticsearch IndexManager (experimental)</h6>
<div class="paragraph">
<p>This index manager forwards all indexes to an external Elasticsearch server. This is an experimental integration and some features may not be available,
for example <code>indexNullAs</code> for <code>@IndexedEmbedded</code> annotations is <a href="https://hibernate.atlassian.net/browse/HSEARCH-2389">not currently supported</a>.</p>
</div>
<div class="paragraph">
<p>Configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>elasticsearch<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.elasticsearch.host</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>link:http://elasticHost:9200<span class="tag">&lt;/property&gt;</span>
    <span class="comment">&lt;!-- other elasticsearch configurations --&gt;</span>
<span class="tag">&lt;/indexing&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The index mode should be set to <code>LOCAL</code>, since Infinispan considers Elasticsearch as a single shared index.
More information about Elasticsearch integration, including the full description of the configuration properties can be found at the <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#elasticsearch-integration">Hibernate Search manual</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="query_autoconfig"><a class="anchor" href="#query_autoconfig"></a>Automatic configuration</h5>
<div class="paragraph">
<p>The attribute auto-config provides a simple way of configuring indexing based on the cache type. For replicated and local caches, the indexing is configured to be persisted on disk and not shared
with any other processes. Also, it is configured so that minimum delay exists between the moment an object is indexed and the moment it is available for searches (near real time).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-config</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;/indexing&gt;</span>
      <span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
it is possible to redefine any property added via auto-config, and also add new properties, allowing for advanced tuning.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The auto config adds the following properties for replicated and local caches:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property name</th>
<th class="tableblock halign-left valign-top">value</th>
<th class="tableblock halign-left valign-top">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default.directory_provider</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">filesystem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Filesystem based index. More details at <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-configuration-directory">Hibernate Search documentation</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default.exclusive_index_use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">indexing operation in exclusive mode, allowing Hibernate Search to optimize writes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default.indexmanager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">near-real-time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">make use of Lucene near real time feature, meaning indexed objects are promptly available to searches</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default.reader.strategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shared</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reuse index reader across several queries, thus avoiding reopening it</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For distributed caches, the auto-config configure indexes in Infinispan itself, internally handled as a master-slave mechanism where indexing operations are sent to a single node which is responsible to
write to the index.</p>
</div>
<div class="paragraph">
<p>The auto config properties for distributed caches are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property name</th>
<th class="tableblock halign-left valign-top">value</th>
<th class="tableblock halign-left valign-top">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default.directory_provider</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">infinispan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indexes stored in Infinispan. More details at <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#infinispan-directories">Hibernate Search documentation</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default.exclusive_index_use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">indexing operation in exclusive mode, allowing Hibernate Search to optimize writes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default.indexmanager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.infinispan.query.indexmanager.InfinispanIndexManager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delegates index writing to a single node in the Infinispan cluster</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default.reader.strategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shared</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reuse index reader across several queries, avoiding reopening it</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="query_massindexer"><a class="anchor" href="#query_massindexer"></a>Re-indexing</h5>
<div class="paragraph">
<p>Occasionally you might need to rebuild the Lucene index by reconstructing it from the data stored in the Cache. You need to rebuild the index if you change the definition of what is indexed on your types, or if you change for example some <em>Analyzer</em> parameter, as Analyzers affect how the index is written. Also, you might need to rebuild the index if you had it destroyed by some system administration mistake. To rebuild the index just get a reference to the MassIndexer and start it; beware it might take some time as it needs to reprocess all data in the grid!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Blocking execution</span>
SearchManager searchManager = Search.getSearchManager(cache);
searchManager.getMassIndexer().start();

<span class="comment">// Non blocking execution</span>
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; future = searchManager.getMassIndexer().startAsyc();</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This is also available as a <code>start</code> JMX operation on the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/jmxComponents.html#MassIndexer">MassIndexer MBean</a>
registered under the name <code>org.infinispan:type=Query,manager="{name-of-cache-manager}",cache="{name-of-cache}",component=MassIndexer</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="mapping_entities"><a class="anchor" href="#mapping_entities"></a>Mapping Entities</h5>
<div class="paragraph">
<p>Infinispan relies on the rich API of <a href="http://hibernate.org/search/">Hibernate Search</a> in order to define fine grained configuration for indexing at entity level.
This configuration includes which fields are annotated, which analyzers should be used, how to map nested objects and so on.
Detailed documentation is available at <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-mapping">the Hibernate Search manual</a>.</p>
</div>
<div class="sect5">
<h6 id="documentid"><a class="anchor" href="#documentid"></a>@DocumentId</h6>
<div class="paragraph">
<p>Unlike Hibernate Search, using <em>@DocumentId</em> to mark a field as identifier does not apply to Infinispan values; in Infinispan the identifier for all <em>@Indexed</em> objects is the key used to store the value. You can still customize how the key is indexed using a combination of <em>@Transformable</em> , custom types and custom <em>FieldBridge</em> implementations.</p>
</div>
</div>
<div class="sect5">
<h6 id="transformable_keys"><a class="anchor" href="#transformable_keys"></a>@Transformable keys</h6>
<div class="paragraph">
<p>The key for each value needs to be indexed as well, and the key instance must be transformed in a <em>String</em>. Infinispan includes some default transformation routines to encode common primitives, but to use a custom key you must provide an implementation of <em>org.infinispan.query.Transformer</em> .</p>
</div>
<div class="paragraph">
<p><strong class="small">Registering a Transformer via annotations</strong></p>
</div>
<div class="paragraph">
<p>You can annotate your key type with <em>org.infinispan.query.Transformable</em> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transformable</span>(transformer = CustomTransformer.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomKey</span> {
   ...
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomTransformer</span> <span class="directive">implements</span> <span class="predefined-type">Transformer</span> {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Object</span> fromString(<span class="predefined-type">String</span> s) {
      ...
      return <span class="keyword">new</span> CustomKey(...);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> toString(<span class="predefined-type">Object</span> customType) {
      CustomKey ck = (CustomKey) customType;
      <span class="keyword">return</span> ...
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong class="small">Registering a Transformer programmatically</strong></p>
</div>
<div class="paragraph">
<p>Using this technique, you don&#8217;t have to annotate your custom key type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">org.infinispan.query.SearchManager.registerKeyTransformer(<span class="predefined-type">Class</span>&lt;?&gt;, <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Transformer</span>&gt;)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="query_configuration_api"><a class="anchor" href="#query_configuration_api"></a>Programmatic mapping</h6>
<div class="paragraph">
<p>Instead of using annotations to map an entity to the index, it&#8217;s also possible to configure it programmatically.</p>
</div>
<div class="paragraph">
<p>In the following example we map an object <em>Author</em> which is to be stored in the grid and made searchable on two properties but without annotating the class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.apache.lucene.search.Query</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.cfg.Environment</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.cfg.SearchMapping</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.query.dsl.QueryBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.Cache</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.Configuration</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.Index</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.manager.DefaultCacheManager</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.CacheQuery</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.SearchManager</span>;

<span class="keyword">import</span> <span class="include">java.io.IOException</span>;
<span class="keyword">import</span> <span class="include">java.lang.annotation.ElementType</span>;
<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

SearchMapping mapping = <span class="keyword">new</span> SearchMapping();
mapping.entity(Author.class).indexed()
       .property(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">ElementType</span>.METHOD).field()
       .property(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">ElementType</span>.METHOD).field();

<span class="predefined-type">Properties</span> properties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
properties.put(Environment.MODEL_MAPPING, mapping);
properties.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.search.[other options]</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">[...]</span><span class="delimiter">&quot;</span></span>);

<span class="predefined-type">Configuration</span> infinispanConfiguration = <span class="keyword">new</span> ConfigurationBuilder()
        .indexing().index(Index.LOCAL)
        .withProperties(properties)
        .build();

DefaultCacheManager cacheManager = <span class="keyword">new</span> DefaultCacheManager(infinispanConfiguration);

Cache&lt;<span class="predefined-type">Long</span>, Author&gt; cache = cacheManager.getCache();
SearchManager sm = Search.getSearchManager(cache);

Author author = <span class="keyword">new</span> Author(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Surtani</span><span class="delimiter">&quot;</span></span>);
cache.put(author.getId(), author);

QueryBuilder qb = sm.buildQueryBuilderForClass(Author.class).get();
<span class="predefined-type">Query</span> q = qb.keyword().onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>).matching(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>).createQuery();
CacheQuery cq = sm.getQuery(q, Author.class);
<span class="keyword">assert</span> cq.getResultSize() == <span class="integer">1</span>;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="query_apis"><a class="anchor" href="#query_apis"></a>11.2.3. Querying APIs</h4>
<div class="paragraph">
<p>You can query Infinispan using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lucene or Hibernate Search Queries. Infinispan exposes the Hibernate Search DSL, which produces Lucene queries. You can run Lucene queries on single nodes or broadcast queries to multiple nodes in an Infinispan cluster.</p>
</li>
<li>
<p>Ickle queries, a custom string-based query language with full-text extensions.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="query_hibernatesearch"><a class="anchor" href="#query_hibernatesearch"></a>Hibernate Search</h5>
<div class="paragraph">
<p>Apart from supporting Hibernate Search annotations to configure indexing, it&#8217;s also possible to query the cache using other Hibernate Search APIs</p>
</div>
<div class="sect5">
<h6 id="running_lucene_queries"><a class="anchor" href="#running_lucene_queries"></a>Running Lucene queries</h6>
<div class="paragraph">
<p>To run a Lucene query directly, simply create and wrap it in a <em>CacheQuery</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.SearchManager</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.Query</span>;


SearchManager searchManager = Search.getSearchManager(cache);
<span class="predefined-type">Query</span> query = searchManager.buildQueryBuilderForClass(<span class="predefined-type">Book</span>.class).get()
            .keyword().wildcard().onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).matching(<span class="string"><span class="delimiter">&quot;</span><span class="content">*test*</span><span class="delimiter">&quot;</span></span>).createQuery();
CacheQuery&lt;<span class="predefined-type">Book</span>&gt; cacheQuery = searchManager.getQuery(query);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="using_the_hibernate_search_dsl"><a class="anchor" href="#using_the_hibernate_search_dsl"></a>Using the Hibernate Search DSL</h6>
<div class="paragraph">
<p>The Hibernate Search DSL can be used to create the Lucene Query, example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.SearchManager</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.search.Query</span>;

Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Book</span>&gt; cache = ...

SearchManager searchManager = Search.getSearchManager(cache);

<span class="predefined-type">Query</span> luceneQuery = searchManager
                         .buildQueryBuilderForClass(<span class="predefined-type">Book</span>.class).get()
                         .range().onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">year</span><span class="delimiter">&quot;</span></span>).from(<span class="integer">2005</span>).to(<span class="integer">2010</span>)
                         .createQuery();

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Object</span>&gt; results = searchManager.getQuery(luceneQuery).list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a detailed description of the query capabilities of this DSL, see the relevant section of the <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#section-building-lucene-queries">Hibernate Search manual</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="faceted_search"><a class="anchor" href="#faceted_search"></a>Faceted Search</h6>
<div class="paragraph">
<p>Infinispan support <a href="https://en.wikipedia.org/wiki/Faceted_search">Faceted Searches</a> by using the Hibernate Search <code>FacetManager</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Cache is indexed</span>
Cache&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">Book</span>&gt; cache = ...

<span class="comment">// Obtain the Search Manager</span>
SearchManager searchManager = Search.getSearchManager(cache);

<span class="comment">// Create the query builder</span>
QueryBuilder queryBuilder = searchManager.buildQueryBuilderForClass(<span class="predefined-type">Book</span>.class).get();

<span class="comment">// Build any Lucene Query. Here it's using the DSL to do a Lucene term query on a book name</span>
<span class="predefined-type">Query</span> luceneQuery = queryBuilder.keyword().wildcard().onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>).matching(<span class="string"><span class="delimiter">&quot;</span><span class="content">bitcoin</span><span class="delimiter">&quot;</span></span>).createQuery();

<span class="comment">// Wrap into a cache Query</span>
CacheQuery&lt;<span class="predefined-type">Book</span>&gt; query = searchManager.getQuery(luceneQuery);

<span class="comment">// Define the Facet characteristics</span>
FacetingRequest request = queryBuilder.facet()
                .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">year_facet</span><span class="delimiter">&quot;</span></span>)
                .onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">year</span><span class="delimiter">&quot;</span></span>)
                .discrete()
                .orderedBy(FacetSortOrder.COUNT_ASC)
                .createFacetingRequest();

<span class="comment">// Associated the FacetRequest with the query</span>
FacetManager facetManager = query.getFacetManager().enableFaceting(request);

<span class="comment">// Obtain the facets</span>
<span class="predefined-type">List</span>&lt;Facet&gt; facetList = facetManager.getFacets(<span class="string"><span class="delimiter">&quot;</span><span class="content">year_facet</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>A Faceted search like above will return the number books that match 'bitcoin' released on a yearly basis, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AbstractFacet{facetingName='year_facet', fieldName='year', value='2008', count=1}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2009', count=1}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2010', count=1}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2011', count=1}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2012', count=1}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2016', count=1}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2015', count=2}
AbstractFacet{facetingName='year_facet', fieldName='year', value='2013', count=3}</pre>
</div>
</div>
<div class="paragraph">
<p>For more info about Faceted Search, see <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#query-faceting">Hibernate Search Faceting</a></p>
</div>
</div>
<div class="sect5">
<h6 id="query_spatial"><a class="anchor" href="#query_spatial"></a>Spatial Queries</h6>
<div class="paragraph">
<p>Infinispan also supports <a href="https://en.wikipedia.org/wiki/Spatial_query">Spatial Queries</a>, allowing to combining full-text with restrictions based on distances, geometries or geographic coordinates.</p>
</div>
<div class="paragraph">
<p>Example, we start by using the <code>@Spatial</code> annotation in our entity that will be searched, together with <code>@Latitude</code> and <code>@Longitude</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Indexed</span>
<span class="annotation">@Spatial</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Restaurant</span> {

      <span class="annotation">@Latitude</span>
      <span class="directive">private</span> <span class="predefined-type">Double</span> latitude;

      <span class="annotation">@Longitude</span>
      <span class="directive">private</span> <span class="predefined-type">Double</span> longitude;

      <span class="annotation">@Field</span>(store = Store.YES)
      <span class="predefined-type">String</span> name;

      <span class="comment">// Getters, Setters and other members omitted</span>

   }</code></pre>
</div>
</div>
<div class="paragraph">
<p>to run spatial queries, the Hibernate Search DSL can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Cache is configured as indexed</span>
Cache&lt;<span class="predefined-type">String</span>, Restaurant&gt; cache = ...

<span class="comment">// Obtain the SearchManager</span>
Searchmanager searchManager = Search.getSearchManager(cache);

<span class="comment">// Build the Lucene Spatial Query</span>
<span class="predefined-type">Query</span> query = Search.getSearchManager(cache).buildQueryBuilderForClass(Restaurant.class).get()
          .spatial()
            .within( <span class="integer">2</span>, Unit.KM )
              .ofLatitude( centerLatitude )
              .andLongitude( centerLongitude )
            .createQuery();

<span class="comment">// Wrap in a cache Query</span>
CacheQuery&lt;Restaurant&gt; cacheQuery = searchManager.getQuery(query);

<span class="predefined-type">List</span>&lt;Restaurant&gt; nearBy = cacheQuery.list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>More info on <a href="http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#spatial">Hibernate Search manual</a></p>
</div>
</div>
<div class="sect5">
<h6 id="query_clustered_query_api"><a class="anchor" href="#query_clustered_query_api"></a>IndexedQueryMode</h6>
<div class="paragraph">
<p>It&#8217;s possible to specify a query mode for indexed queries. IndexedQueryMode.BROADCAST allows to broadcast a query to each node of the cluster, retrieve the results and combine them before returning to the caller.
It is suitable for use in conjunction with <a href="#query_non_shared_index">non-shared indexes</a>, since each node&#8217;s local index will have only a subset of the data indexed.</p>
</div>
<div class="paragraph">
<p>IndexedQueryMode.FETCH will execute the query in the caller. If all the indexes for the cluster wide data are available locally, performance will be optimal, otherwise this query mode
may involve fetching indexes data from remote nodes.</p>
</div>
<div class="paragraph">
<p>The IndexedQueryMode is supported for Lucene Queries and Ickle String queries at the moment (no Infinispan Query DSL).</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CacheQuery&lt;Person&gt; broadcastQuery = Search.getSearchManager(cache).getQuery(<span class="keyword">new</span> MatchAllDocsQuery(), IndexedQueryMode.BROADCAST);

<span class="predefined-type">List</span>&lt;Person&gt; result = broadcastQuery.list();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="query_dsl"><a class="anchor" href="#query_dsl"></a>Infinispan Query DSL</h5>
<div class="paragraph">
<p>Infinispan provides its own query DSL, independent of Lucene and Hibernate Search.
Decoupling the query API from the underlying query and indexing mechanism makes it possible to introduce new alternative
engines in the future, besides Lucene, and still being able to use the same uniform query API.
The current implementation of indexing and searching is still based on
Hibernate Search and Lucene so all indexing related aspects presented in this chapter still apply.</p>
</div>
<div class="paragraph">
<p>The new API simplifies the writing of queries by not exposing the user to the low level details of constructing Lucene
query objects and also has the advantage of being available to remote Hot Rod clients. But before delving into further details, let&#8217;s examine first a simple example of writing a query for the <em>Book</em> entity
from the previous example.</p>
</div>
<div class="listingblock">
<div class="title">Query example using Infinispan's query DSL</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.dsl</span>.*;

<span class="comment">// get the DSL query factory from the cache, to be used for constructing the Query object:</span>
QueryFactory qf = org.infinispan.query.Search.getQueryFactory(cache);

<span class="comment">// create a query for all the books that have a title which contains &quot;engine&quot;:</span>
org.infinispan.query.dsl.Query query = qf.from(<span class="predefined-type">Book</span>.class)
      .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%engine%</span><span class="delimiter">&quot;</span></span>)
      .build();

<span class="comment">// get the results:</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; list = query.list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The API is located in the <em>org.infinispan.query.dsl</em> package. A query is created with the help of the <em>QueryFactory</em>
instance which is obtained from the per-cache <em>SearchManager</em>. Each <em>QueryFactory</em> instance is bound to the same <em>Cache</em>
instance as the <em>SearchManager</em>, but it is otherwise a stateless and thread-safe object that can be used for creating
multiple queries in parallel.</p>
</div>
<div class="paragraph">
<p>Query creation starts with the invocation of the <code>from(Class entityType)</code> method which returns a <em>QueryBuilder</em> object
that is further responsible for creating queries targeted to the specified entity class from the given cache.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A query will always target a single entity type and is evaluated over the contents of a single cache. Running a
query over multiple caches or creating queries that target several entity types (joins) is not supported.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <em>QueryBuilder</em> accumulates search criteria and configuration specified through the invocation of its DSL methods and is
ultimately used to build a <em>Query</em> object by the invocation of the <code>QueryBuilder.build()</code> method that completes the
construction. Being a stateful object, it cannot be used for constructing multiple queries at the same time
(except for <a href="#nested_conditions">nested queries</a>) but can be reused afterwards.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This <em>QueryBuilder</em> is different from the one from Hibernate Search but has a somewhat similar purpose, hence the
same name. We are considering renaming it in near future to prevent ambiguity.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Executing the query and fetching the results is as simple as invoking the <code>list()</code> method of the <em>Query</em> object. Once
executed the <em>Query</em> object is not reusable. If you need to re-execute it in order to obtain fresh results then a new
instance must be obtained by calling <code>QueryBuilder.build()</code>.</p>
</div>
<div class="sect5">
<h6 id="filtering_operators"><a class="anchor" href="#filtering_operators"></a>Filtering operators</h6>
<div class="paragraph">
<p>Constructing a query is a hierarchical process of composing multiple criteria and is best explained following this hierarchy.</p>
</div>
<div class="paragraph">
<p>The simplest possible form of a query criteria is a restriction on the values of an entity attribute according to a
filtering operator that accepts zero or more arguments. The entity attribute is specified by invoking the
<code>having(String attributePath)</code> method of the query builder which returns an intermediate context object
(<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/query/dsl/FilterConditionEndContext.html"><em>FilterConditionEndContext</em></a>)
that exposes all the available operators. Each of the methods defined by <em>FilterConditionEndContext</em> is an operator that
accepts an argument, except for <code>between</code> which has two arguments and <code>isNull</code> which has no arguments. The arguments are
statically evaluated at the time the query is constructed, so if you&#8217;re looking for a feature similar to SQL&#8217;s
correlated sub-queries, that is not currently available.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// a single query criterion</span>
QueryBuilder qb = ...
qb.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate Search in Action</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. <em>FilterConditionEndContext</em> exposes the following filtering operators:</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Filter</th>
<th class="tableblock halign-left valign-top">Arguments</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">in</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Collectionvalues</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left operand is equal to one of the elements from the Collection of values given as argument.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">in</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object&#8230;&#8203;values</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left operand is equal to one of the (fixed) list of values given as argument.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">contains</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains the given element.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">containsAll</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Collectionvalues</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains all the elements of the given collection, in any order.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">containsAll</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object&#8230;&#8203;values</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains all of the the given elements, in any order.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">containsAny</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Collectionvalues</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains any of the elements of the given collection.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">containsAny</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object&#8230;&#8203;values</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be an array or a Collection) contains any of the the given elements.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">isNull</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is null.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">like</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stringpattern</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be a String) matches a wildcard pattern that follows the JPA rules.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is equal to the given value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">equal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alias for eq.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is greater than the given value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is greater than or equal to the given value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is less than the given value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Objectvalue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is less than or equal to the given value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">between</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Objectfrom, Objectto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is between the given range limits.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It&#8217;s important to note that query construction requires a multi-step chaining of method invocation that must be done in
the proper sequence, must be properly completed exactly <em>once</em> and must not be done twice, or it will result in an error.
The following examples are invalid, and depending on each case they lead to criteria being ignored (in benign cases) or
an exception being thrown (in more serious ones).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Incomplete construction. This query does not have any filter on &quot;title&quot; attribute yet,</span>
<span class="comment">// although the author may have intended to add one.</span>
QueryBuilder qb1 = ...
qb1.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Query</span> q1 = qb1.build(); <span class="comment">// consequently, this query matches all Book instances regardless of title!</span>

<span class="comment">// Duplicated completion. This results in an exception at run-time.</span>
<span class="comment">// Maybe the author intended to connect two conditions with a boolean operator,</span>
<span class="comment">// but this does NOT actually happen here.</span>
QueryBuilder qb2 = ...
qb2.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>);
qb2.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%clustering%</span><span class="delimiter">&quot;</span></span>);   <span class="comment">// will throw java.lang.IllegalStateException: Sentence already started. Cannot use 'having(..)' again.</span>
<span class="predefined-type">Query</span> q2 = qb2.build();</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="filtering_based_on_attributes_of_embedded_entities"><a class="anchor" href="#filtering_based_on_attributes_of_embedded_entities"></a>Filtering based on attributes of embedded entities</h6>
<div class="paragraph">
<p>The <code>having</code> method also accepts dot separated attribute paths for referring to <em>embedded entity</em> attributes, so the following
is a valid query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have an author named &quot;Manik&quot;</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
      .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.name</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>)
      .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each part of the attribute path must refer to an existing indexed attribute in the corresponding entity or embedded
entity class respectively. It&#8217;s possible to have multiple levels of embedding.</p>
</div>
</div>
<div class="sect5">
<h6 id="boolean_conditions"><a class="anchor" href="#boolean_conditions"></a>Boolean conditions</h6>
<div class="paragraph">
<p>Combining multiple attribute conditions with logical conjunction (<code>and</code>) and disjunction (<code>or</code>) operators in order to
create more complex conditions is demonstrated in the following example. The well known operator precedence rule for
boolean operators applies here, so the order of DSL method invocations during construction is irrelevant. Here <code>and</code>
operator still has higher priority than <code>or</code> even though <code>or</code> was invoked first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have &quot;Data Grid&quot; in their title</span>
<span class="comment">// or have an author named &quot;Manik&quot; and their description contains &quot;clustering&quot;</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>)
  .or().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.name</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>)
  .and().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%clustering%</span><span class="delimiter">&quot;</span></span>)
  .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Boolean negation is achieved with the <code>not</code> operator, which has highest precedence among logical operators and applies
only to the next simple attribute condition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that do not have &quot;Data Grid&quot; in their title and are authored by &quot;Manik&quot;</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .not().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>)
  .and().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.name</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>)
  .build();</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="nested_conditions"><a class="anchor" href="#nested_conditions"></a>Nested conditions</h6>
<div class="paragraph">
<p>Changing the precedence of logical operators is achieved with nested filter conditions. Logical operators can be used to
connect two simple attribute conditions as presented before, but can also connect a simple attribute condition with the
subsequent complex condition created with the same query factory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have an author named &quot;Manik&quot; and their title contains</span>
<span class="comment">// &quot;Data Grid&quot; or their description contains &quot;clustering&quot;</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author.name</span><span class="delimiter">&quot;</span></span>).eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>)
  .and(queryFactory.having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>)
          .or().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%clustering%</span><span class="delimiter">&quot;</span></span>))
  .build();</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="projections"><a class="anchor" href="#projections"></a>Projections</h6>
<div class="paragraph">
<p>In some use cases returning the whole domain object is overkill if only a small subset of the attributes are actually
used by the application, especially if the domain entity has embedded entities. The query language allows you to specify
a subset of attributes (or attribute paths) to return - the projection. If projections are used then the <code>Query.list()</code>
will not return the whole domain entity but will return a <em>List</em> of <em>Object[]</em>, each slot in the array corresponding to
a projected attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have &quot;Data Grid&quot; in their title or description</span>
<span class="comment">// and return only their title and publication year</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>)
  .or().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>))
  .build();</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="sorting"><a class="anchor" href="#sorting"></a>Sorting</h6>
<div class="paragraph">
<p>Ordering the results based on one or more attributes or attribute paths is done with the <code>QueryBuilder.orderBy(  )</code>
method which accepts an attribute path and a sorting direction. If multiple sorting criteria are specified, then
the order of invocation of <code>orderBy</code> method will dictate their precedence. But you have to think of the multiple sorting
criteria as acting together on the tuple of specified attributes rather than in a sequence of individual sorting
operations on each attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have &quot;Data Grid&quot; in their title or description</span>
<span class="comment">// and return them sorted by the publication year and title</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .orderBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, SortOrder.DESC)
  .orderBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, SortOrder.ASC)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>)
  .or().having(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Data Grid%</span><span class="delimiter">&quot;</span></span>))
  .build();</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="pagination"><a class="anchor" href="#pagination"></a>Pagination</h6>
<div class="paragraph">
<p>You can limit the number of returned results by setting the <em>maxResults</em> property of <em>QueryBuilder</em>. This can be used in
conjunction with setting the <em>startOffset</em> in order to achieve pagination of the result set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// match all books that have &quot;clustering&quot; in their title</span>
<span class="comment">// sorted by publication year and title</span>
<span class="comment">// and return 3'rd page of 10 results</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
  .orderBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, SortOrder.DESC)
  .orderBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, SortOrder.ASC)
  .startOffset(<span class="integer">20</span>)
  .maxResults(<span class="integer">10</span>)
  .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%clustering%</span><span class="delimiter">&quot;</span></span>)
  .build();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even if the results being fetched are limited to <em>maxResults</em> you can still find the total number of matching
results by calling <code>Query.getResultSize()</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="grouping_and_aggregation"><a class="anchor" href="#grouping_and_aggregation"></a>Grouping and Aggregation</h6>
<div class="paragraph">
<p>Infinispan has the ability to group query results according to a set of grouping fields and construct aggregations of
the results from each group by applying an aggregation function to the set of values that fall into each group. Grouping
and aggregation can only be applied to projection queries. The supported aggregations are: avg, sum, count, max, min.
The set of grouping fields is specified with the <em>groupBy(field)</em> method, which can be invoked multiple times. The order
used for defining grouping fields is not relevant. All fields selected in the projection must either be grouping fields
or else they must be aggregated using one of the grouping functions described below. A projection field can be
aggregated and used for grouping at the same time. A query that selects only grouping fields but no aggregation fields
is legal.
</p>
</div>
<div class="paragraph">
<p>Example: Grouping Books by author and counting them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
    .select(<span class="predefined-type">Expression</span>.property(<span class="string"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>), <span class="predefined-type">Expression</span>.count(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>))
    .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%engine%</span><span class="delimiter">&quot;</span></span>)
    .groupBy(<span class="string"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>)
    .build();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A projection query in which all selected fields have an aggregation function applied and no fields are used for
grouping is allowed. In this case the aggregations will be computed globally as if there was a single global group.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="aggregations"><a class="anchor" href="#aggregations"></a>Aggregations</h6>
<div class="paragraph">
<p>The following aggregation functions may be applied to a field: avg, sum, count, max, min</p>
</div>
<div class="ulist">
<ul>
<li>
<p>avg() - Computes the average of a set of numbers. Accepted values are primitive numbers and instances of <em>java.lang.Number</em>. The result is represented as <em>java.lang.Double</em>. If there are no non-null values the result is <em>null</em> instead.</p>
</li>
<li>
<p>count() - Counts the number of non-null rows and returns a <em>java.lang.Long</em>. If there are no non-null values the result is <em>0</em> instead.</p>
</li>
<li>
<p>max() - Returns the greatest value found. Accepted values must be instances of <em>java.lang.Comparable</em>. If there are no non-null values the result is <em>null</em> instead.</p>
</li>
<li>
<p>min() - Returns the smallest value found. Accepted values must be instances of <em>java.lang.Comparable</em>. If there are no non-null values the result is <em>null</em> instead.</p>
</li>
<li>
<p>sum() - Computes the sum of a set of Numbers. If there are no non-null values the result is <em>null</em> instead. The following table indicates the return type based on the specified field.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Table sum return type</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Type</th>
<th class="tableblock halign-left valign-top">Return Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integral (other than BigInteger)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Float or Double</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Double</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigInteger</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigInteger</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="evaluation_of_queries_with_grouping_and_aggregation"><a class="anchor" href="#evaluation_of_queries_with_grouping_and_aggregation"></a>Evaluation of queries with grouping and aggregation</h6>
<div class="paragraph">
<p>Aggregation queries can include filtering conditions, like usual queries. Filtering can be performed in two stages: before
and after the grouping operation. All filter conditions defined before invoking the <em>groupBy</em> method will be applied
before the grouping operation is performed, directly to the cache entries (not to the final projection). These filter
conditions may reference any fields of the queried entity type, and are meant to restrict the data set that is going to
be the input for the grouping stage. All filter conditions defined after invoking the <em>groupBy</em> method will be applied to
the projection that results from the projection and grouping operation. These filter conditions can either reference any
of the <em>groupBy</em> fields or aggregated fields. Referencing aggregated fields that are not specified in the select clause
is allowed; however, referencing non-aggregated and non-grouping fields is forbidden. Filtering in this phase will
reduce the amount of groups based on their properties. Sorting may also be specified similar to usual queries. The
ordering operation is performed after the grouping operation and can reference any of the <em>groupBy</em> fields or aggregated
fields.</p>
</div>
</div>
<div class="sect5">
<h6 id="using_named_query_parameters"><a class="anchor" href="#using_named_query_parameters"></a>Using Named Query Parameters</h6>
<div class="paragraph">
<p>Instead of building a new Query object for every execution it is possible to include named parameters in the query which
can be substituted with actual values before execution. This allows a query to be defined once and be efficiently
executed many times. Parameters can only be used on the right-hand side of an operator and are defined when the query is
created by supplying an object produced by the <em>org.infinispan.query.dsl.Expression.param(String paramName)</em> method to
the operator instead of the usual constant value. Once the parameters have been defined they can be set by invoking either
<em>Query.setParameter(parameterName, value)</em> or <em>Query.setParameters(parameterMap)</em> as shown in the examples below.
</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl</span>.*;
[...]

QueryFactory queryFactory = Search.getQueryFactory(cache);
<span class="comment">// Defining a query to search for various authors and publication years</span>
<span class="predefined-type">Query</span> query = queryFactory.from(<span class="predefined-type">Book</span>.class)
    .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>)
    .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>).eq(<span class="predefined-type">Expression</span>.param(<span class="string"><span class="delimiter">&quot;</span><span class="content">authorName</span><span class="delimiter">&quot;</span></span>))
    .and()
    .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>).eq(<span class="predefined-type">Expression</span>.param(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>))
    .build();

<span class="comment">// Set actual parameter values</span>
query.setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">authorName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>);
query.setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, <span class="integer">2010</span>);

<span class="comment">// Execute the query</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; found = query.list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, multiple parameters may be set at once by supplying a map of actual parameter values:
</p>
</div>
<div class="listingblock">
<div class="title">Setting multiple named parameters at once</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util.Map</span>;
<span class="keyword">import</span> <span class="include">java.util.HashMap</span>;

[...]

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; parameterMap = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
parameterMap.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">authorName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>);
parameterMap.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, <span class="integer">2010</span>);

query.setParameters(parameterMap);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A significant portion of the query parsing, validation and execution planning effort is performed during the first
execution of a query with parameters. This effort is not repeated during subsequent executions leading to better
performance compared to a similar query using constant values instead of query parameters.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="more_query_dsl_samples"><a class="anchor" href="#more_query_dsl_samples"></a>More Query DSL samples</h6>
<div class="paragraph">
<p>Probably the best way to explore using the Query DSL API is to have a look at our tests suite.
<a href="https://github.com/infinispan/infinispan/blob/master/query/src/test/java/org/infinispan/query/dsl/embedded/QueryDslConditionsTest.java">QueryDslConditionsTest</a>
is a fine example.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="query_ickle"><a class="anchor" href="#query_ickle"></a>Ickle</h5>
<div class="paragraph">
<p>Create relational and full-text queries in both Library and Remote Client-Server mode with the Ickle query language.</p>
</div>
<div class="paragraph">
<p>Ickle is string-based and has the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Query Java classes and supports Protocol Buffers.</p>
</li>
<li>
<p>Queries can target a single entity type.</p>
</li>
<li>
<p>Queries can filter on properties of embedded objects, including collections.</p>
</li>
<li>
<p>Supports projections, aggregations, sorting, named parameters.</p>
</li>
<li>
<p>Supports indexed and non-indexed execution.</p>
</li>
<li>
<p>Supports complex boolean expressions.</p>
</li>
<li>
<p>Supports full-text queries.</p>
</li>
<li>
<p>Does not support computations in expressions, such as <code>user.age &gt; sqrt(user.shoeSize+3)</code>.</p>
</li>
<li>
<p>Does not support joins.</p>
</li>
<li>
<p>Does not support subqueries.</p>
</li>
<li>
<p>Is supported across various {Infinispan} APIs. Whenever a Query is produced by the QueryBuilder is accepted, including continuous queries or in event filters for listeners.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use the API, first obtain a QueryFactory to the cache and then call the .create() method, passing in the string to use in the query. For instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">QueryFactory qf = Search.getQueryFactory(remoteCache);
<span class="predefined-type">Query</span> q = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_bank_account.Transaction where amount &gt; 20</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using Ickle all fields used with full-text operators must be both <code>Indexed</code> and <code>Analysed</code>.</p>
</div>
<div class="sect5">
<h6 id="ickle_query_language_parser_syntax"><a class="anchor" href="#ickle_query_language_parser_syntax"></a>Ickle Query Language Parser Syntax</h6>
<div class="paragraph">
<p>The parser syntax for the Ickle query language has some notable rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Whitespace is not significant.</p>
</li>
<li>
<p>Wildcards are not supported in field names.</p>
</li>
<li>
<p>A field name or path must always be specified, as there is no default field.</p>
</li>
<li>
<p><code>&amp;&amp;</code> and <code>||</code> are accepted instead of <code>AND</code> or <code>OR</code> in both full-text and JPA predicates.</p>
</li>
<li>
<p><code>!</code> may be used instead of <code>NOT</code>.</p>
</li>
<li>
<p>A missing boolean operator is interpreted as <code>OR</code>.</p>
</li>
<li>
<p>String terms must be enclosed with either single or double quotes.</p>
</li>
<li>
<p>Fuzziness and boosting are not accepted in arbitrary order; fuzziness always comes first.</p>
</li>
<li>
<p><code>!=</code> is accepted instead of <code>&lt;&gt;</code>.</p>
</li>
<li>
<p>Boosting cannot be applied to <code>&gt;</code>,<code>&gt;=</code>,<code>&lt;</code>,<code></code> operators. Ranges may be used to achieve the same result.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="fuzzy_queries"><a class="anchor" href="#fuzzy_queries"></a>Fuzzy Queries</h6>
<div class="paragraph">
<p>To execute a fuzzy query add <code>~</code> along with an integer, representing the distance from the term used, after the term.
For instance</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> fuzzyQuery = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_bank_account.Transaction where description : 'cofee'~2</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="range_queries"><a class="anchor" href="#range_queries"></a>Range Queries</h6>
<div class="paragraph">
<p>To execute a range query define the given boundaries within a pair of braces, as seen in the following example:</p>
</div>
<div class="paragraph">
<p>Query rangeQuery = qf.create("from sample_bank_account.Transaction where amount : [20 to 50]");</p>
</div>
</div>
<div class="sect5">
<h6 id="phrase_queries"><a class="anchor" href="#phrase_queries"></a>Phrase Queries</h6>
<div class="paragraph">
<p>A group of words may be searched by surrounding them in quotation marks, as seen in the following example:</p>
</div>
<div class="paragraph">
<p>Query q = qf.create("from sample_bank_account.Transaction where description : 'bus fare'");</p>
</div>
</div>
<div class="sect5">
<h6 id="proximity_queries"><a class="anchor" href="#proximity_queries"></a>Proximity Queries</h6>
<div class="paragraph">
<p>To execute a proximity query, finding two terms within a specific distance, add a <code>~</code> along with the distance after the phrase.
For instance, the following example will find the words canceling and fee provided they are not more than 3 words apart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> proximityQuery = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_bank_account.Transaction where description : 'canceling fee'~3 </span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="wildcard_queries"><a class="anchor" href="#wildcard_queries"></a>Wildcard Queries</h6>
<div class="paragraph">
<p>Both single-character and multi-character wildcard searches may be performed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A single-character wildcard search may be used with the ? character.</p>
</li>
<li>
<p>A multi-character wildcard search may be used with the * character.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To search for text or test the following single-character wildcard search would be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> wildcardQuery = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_bank_account.Transaction where description : 'te?t'</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To search for test, tests, or tester the following multi-character wildcard search would be useD:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> wildcardQuery = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_bank_account.Transaction where description : 'test*'</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="regular_expression_queries"><a class="anchor" href="#regular_expression_queries"></a>Regular Expression Queries</h6>
<div class="paragraph">
<p>Regular expression queries may be performed by specifing a pattern between /. Ickle uses Lucenes regular expression syntax, so to search for the words moat or boat the following could be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> regExpQuery = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_library.Book  where title : /[mb]oat/</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="boosting_queries"><a class="anchor" href="#boosting_queries"></a>Boosting Queries</h6>
<div class="paragraph">
<p>Terms may be boosted by adding a ^ after the term to increase their relevance in a given query, the higher the boost factor the more relevant the term will be. For instance to search for titles containing beer and wine with a higher relevance on beer, by a factor of 3, the following could be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> boostedQuery = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_library.Book where title : beer^3 OR wine</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="query_continuous"><a class="anchor" href="#query_continuous"></a>Continuous Query</h5>
<div class="paragraph">
<p>Continuous Queries allow an application to register a listener which will receive the entries that currently match a
query filter, and will be continuously notified of any changes to the queried data set that result from further cache
operations. This includes incoming matches, for values that have joined the set, updated matches, for matching values
that were modified and continue to match, and outgoing matches, for values that have left the set. By using a Continuous
Query the application receives a steady stream of events instead of having to repeatedly execute the same query to
discover changes, resulting in a more efficient use of resources. For instance, all of the following use cases could
utilize Continuous Queries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Return all persons with an age between 18 and 25 (assuming the Person entity has an <em>age</em> property and is updated by
the user application).</p>
</li>
<li>
<p>Return all transactions higher than $2000.</p>
</li>
<li>
<p>Return all times where the lap speed of F1 racers were less than 1:45.00s (assuming the cache contains Lap entries and
that laps are entered live during the race).</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="continuous_query_execution"><a class="anchor" href="#continuous_query_execution"></a>Continuous Query Execution</h6>
<div class="paragraph">
<p>A continuous query uses a listener that is notified when:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An entry starts matching the specified query, represented by a <em>Join</em> event.</p>
</li>
<li>
<p>A matching entry is updated and continues to match the query, represented by an <em>Update</em> event.</p>
</li>
<li>
<p>An entry stops matching the query, represented by a <em>Leave</em> event.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a client registers a continuous query listener it immediately begins to receive the results currently matching the
query, received as <em>Join</em> events as described above. In addition, it will receive subsequent notifications when other
entries begin matching the query, as <em>Join</em> events, or stop matching the query, as <em>Leave</em> events, as a consequence of
any cache operations that would normally generate creation, modification, removal, or expiration events. Updated cache
entries will generate <em>Update</em> events if the entry matches the query filter before and after the operation. To
summarize, the logic used to determine if the listener receives a <em>Join</em>, <em>Update</em> or <em>Leave</em> event is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the query on both the old and new values evaluate false, then the event is suppressed.</p>
</li>
<li>
<p>If the query on the old value evaluates false and on the new value evaluates true, then a <em>Join</em> event is sent.</p>
</li>
<li>
<p>If the query on both the old and new values evaluate true, then an <em>Update</em> event is sent.</p>
</li>
<li>
<p>If the query on the old value evaluates true and on the new value evaluates false, then a <em>Leave</em> event is sent.</p>
</li>
<li>
<p>If the query on the old value evaluates true and the entry is removed or expired, then a <em>Leave</em> event is sent.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Continuous Queries can use the full power of the Query DSL except: grouping, aggregation, and sorting operations.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="running_continuous_queries"><a class="anchor" href="#running_continuous_queries"></a>Running Continuous Queries</h6>
<div class="paragraph">
<p>To create a continuous query you&#8217;ll start by creating a Query object first. This is described in
<a href="#query_dsl">the Query DSL section</a>. Then you&#8217;ll need to obtain the ContinuousQuery (<em>org.infinispan.query.api.continuous.ContinuousQuery</em>)
object of your cache and register the query and a continuous query listener (<em>org.infinispan.query.api.continuous.ContinuousQueryListener</em>)
with it. A ContinuousQuery object associated to a cache can be obtained by calling the static method <em>org.infinispan.client.hotrod.Search.getContinuousQuery(RemoteCache&lt;K, V&gt; cache)</em>
if running in remote mode or <em>org.infinispan.query.Search.getContinuousQuery(Cache&lt;K, V&gt; cache)</em> when running in embedded mode.
Once the listener has been created it may be registered by using the addContinuousQueryListener method of ContinuousQuery:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">continuousQuery.addContinuousQueryListener(query, listener);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example demonstrates a simple continuous query use case in embedded mode:
</p>
</div>
<div class="listingblock">
<div class="title">Registering a Continuous Query</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.api.continuous.ContinuousQuery</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.api.continuous.ContinuousQueryListener</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.QueryFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.Query</span>;

<span class="keyword">import</span> <span class="include">java.util.Map</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.ConcurrentHashMap</span>;

[...]

<span class="comment">// We have a cache of Persons</span>
Cache&lt;<span class="predefined-type">Integer</span>, Person&gt; cache = ...

<span class="comment">// We begin by creating a ContinuousQuery instance on the cache</span>
ContinuousQuery&lt;<span class="predefined-type">Integer</span>, Person&gt; continuousQuery = Search.getContinuousQuery(cache);

<span class="comment">// Define our query. In this case we will be looking for any Person instances under 21 years of age.</span>
QueryFactory queryFactory = Search.getQueryFactory(cache);
<span class="predefined-type">Query</span> query = queryFactory.from(Person.class)
    .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span>).lt(<span class="integer">21</span>)
    .build();

<span class="directive">final</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">Integer</span>, Person&gt; matches = <span class="keyword">new</span> <span class="predefined-type">ConcurrentHashMap</span>&lt;<span class="predefined-type">Integer</span>, Person&gt;();

<span class="comment">// Define the ContinuousQueryListener</span>
ContinuousQueryListener&lt;<span class="predefined-type">Integer</span>, Person&gt; listener = <span class="keyword">new</span> ContinuousQueryListener&lt;<span class="predefined-type">Integer</span>, Person&gt;() {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> resultJoining(<span class="predefined-type">Integer</span> key, Person value) {
        matches.put(key, value);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> resultUpdated(<span class="predefined-type">Integer</span> key, Person value) {
        <span class="comment">// we do not process this event</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> resultLeaving(<span class="predefined-type">Integer</span> key) {
        matches.remove(key);
    }
};

<span class="comment">// Add the listener and the query</span>
continuousQuery.addContinuousQueryListener(query, listener);

[...]

<span class="comment">// Remove the listener to stop receiving notifications</span>
continuousQuery.removeContinuousQueryListener(listener);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As Person instances having an age less than 21 are added to the cache they will be received by the listener and will be
placed into the <em>matches</em> map, and when these entries are removed from the cache or their age is modified to be greater
or equal than 21 they will be removed from <em>matches</em>.</p>
</div>
</div>
<div class="sect5">
<h6 id="removing_continuous_queries"><a class="anchor" href="#removing_continuous_queries"></a>Removing Continuous Queries</h6>
<div class="paragraph">
<p>To stop the query from further execution just remove the listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">continuousQuery.removeContinuousQueryListener(listener);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="notes_on_performance_of_continuous_queries"><a class="anchor" href="#notes_on_performance_of_continuous_queries"></a>Notes on performance of Continuous Queries</h6>
<div class="paragraph">
<p>Continuous queries are designed to provide a constant stream of updates to the application, potentially resulting in a
very large number of events being generated for particularly broad queries. A new temporary memory allocation is made
for each event. This behavior may result in memory pressure, potentially leading to <em>OutOfMemoryErrors</em> (especially in
remote mode) if queries are not carefully designed. To prevent such issues it is strongly recommended to ensure that
each query captures the minimal information needed both in terms of number of matched entries and size of each match
(projections can be used to capture the interesting properties), and that each <em>ContinuousQueryListener</em> is designed
to quickly process all received events without blocking and to avoid performing actions that will lead to the generation
of new matching events from the cache it listens to.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="query_remote"><a class="anchor" href="#query_remote"></a>11.3. Remote Querying</h3>
<div class="paragraph">
<p>Apart from supporting indexing and searching of Java entities to embedded clients, Infinispan introduced support for remote,
language neutral, querying.</p>
</div>
<div class="paragraph">
<p>This leap required two major changes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Since non-JVM clients cannot benefit from directly using <a href="http://lucene.apache.org/">Apache Lucene</a>'s Java
API, Infinispan defines its own new <a href="#query_dsl">query language</a>, based on an internal DSL that is easily
implementable in all languages for which we currently have an implementation of the Hot Rod client.</p>
</li>
<li>
<p>In order to enable indexing, the entities put in the cache by clients can no longer be opaque binary blobs understood
solely by the client. Their structure has to be known to both server and client, so a common way of
encoding structured data had to be adopted. Furthermore, allowing multi-language clients to access the data requires a
language and platform-neutral encoding. Google&#8217;s <a href="http://code.google.com/p/protobuf/">Protocol Buffers</a> was
elected as an encoding format for both over-the-wire and storage due to its efficiency, robustness, good multi-language
support and support for schema evolution.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="storing_protobuf"><a class="anchor" href="#storing_protobuf"></a>11.3.1. Storing Protobuf encoded entities</h4>
<div class="paragraph">
<p>Remote clients that want to be able to index and query their stored entities must do so using the Protobuf encoding
format. This is <em>key</em> for the search capability to work. But it&#8217;s also possible to store Protobuf entities just for
gaining the benefit of platform independence and not enable indexing if you do not need it.</p>
</div>
<div class="paragraph">
<p>Protobuf is all about structured data, so first thing you do to use it is define the structure of your data. This is
accomplished by declaring protocol buffer message types in .proto files, like in the following example. Protobuf is a
broad subject, we will not detail it here, so please consult the Protobuf
<a href="https://developers.google.com/protocol-buffers/docs/overview">Developer Guide</a> for an in-depth
explanation. It suffices to say for now that our example defines an entity (message type in protobuf speak) named <em>Book</em>,
placed in a package named <em>book_sample</em>. Our entity declares several fields of primitive types and a repeatable field (an
array basically) named <em>authors</em>. The <em>Author</em> message instances are embedded in the <em>Book</em> message instance.</p>
</div>
<div class="listingblock">
<div class="title">library.proto</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="proto">package book_sample;

message Book {
  required string title = 1;
  required string description = 2;
  required int32 publicationYear = 3; // no native Date type available in Protobuf

  repeated Author authors = 4;
}

message Author {
  required string name = 1;
  required string surname = 2;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a few important notes we need to make about Protobuf messages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>nesting of messages is possible, but the resulting structure is strictly a tree, never a graph</p>
</li>
<li>
<p>there is no concept of type inheritance</p>
</li>
<li>
<p>collections are not supported but arrays can be easily emulated using repeated fields</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using Protobuf with the Java Hot Rod client is a two step process. First, the client must be configured to use a
dedicated marshaller, <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/marshall/ProtoStreamMarshaller.html"><em>ProtoStreamMarshaller</em></a>.
This marshaller uses the <a href="https://github.com/infinispan/protostream"><em>ProtoStream</em></a> library to assist you in
encoding your objects. The second step is instructing <em>ProtoStream</em> library on how to marshall your message types. The
following example highlights this process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
  <td class="code"><pre><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.marshall.ProtoStreamMarshaller</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.protostream.SerializationContext</span>;
...

ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder.addServer()
    .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">10.1.2.3</span><span class="delimiter">&quot;</span></span>).port(<span class="integer">11234</span>)
    .marshaller(<span class="keyword">new</span> ProtoStreamMarshaller());

RemoteCacheManager remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());

SerializationContext serCtx = ProtoStreamMarshaller.getSerializationContext(remoteCacheManager);

FileDescriptorSource fds = <span class="keyword">new</span> FileDescriptorSource();
fds.addProtoFiles(<span class="string"><span class="delimiter">&quot;</span><span class="content">/library.proto</span><span class="delimiter">&quot;</span></span>);
serCtx.registerProtoFiles(fds);
serCtx.registerMarshaller(<span class="keyword">new</span> BookMarshaller());
serCtx.registerMarshaller(<span class="keyword">new</span> AuthorMarshaller());

<span class="comment">// Book and Author classes omitted for brevity</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The interesting part in this sample is obtaining the <em>SerializationContext</em> associated to the <em>RemoteCacheManager</em> and
then instructing ProtoStream about the protobuf types we want to marshall. The <em>SerializationContext</em> is provided by the
library for this purpose. The <code>SerializationContext.registerProtoFiles</code> method receives the name of one or more
classpath resources that is expected to be a protobuf definition containing our type declarations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A <em>RemoteCacheManager</em> has no <em>SerializationContext</em> associated with it unless it was configured to use
a <em>ProtoStreamMarshaller</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next relevant part is the registration of per entity marshallers for our domain model types. They must be
provided by the user for each type or marshalling will fail. Writing marshallers is a simple process. The
<em>BookMarshaller</em> example should get you started. The most important thing you need to consider is they need to be
stateless and threadsafe as a single instance of them is being used.</p>
</div>
<div class="listingblock">
<div class="title">BookMarshaller.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.protostream.MessageMarshaller</span>;
...

public <span class="type">class</span> <span class="class">BookMarshaller</span> <span class="directive">implements</span> MessageMarshaller&lt;<span class="predefined-type">Book</span>&gt; {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> getTypeName() {
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">book_sample.Book</span><span class="delimiter">&quot;</span></span>;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Book</span>&gt; getJavaClass() {
      <span class="keyword">return</span> <span class="predefined-type">Book</span>.class;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> writeTo(ProtoStreamWriter writer, <span class="predefined-type">Book</span> book) <span class="directive">throws</span> <span class="exception">IOException</span> {
      writer.writeString(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, book.getTitle());
      writer.writeString(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>, book.getDescription());
      writer.writeInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, book.getPublicationYear());
      writer.writeCollection(<span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>, book.getAuthors(), Author.class);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Book</span> readFrom(ProtoStreamReader reader) <span class="directive">throws</span> <span class="exception">IOException</span> {
      <span class="predefined-type">String</span> title = reader.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">String</span> description = reader.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>);
      <span class="type">int</span> publicationYear = reader.readInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">Set</span>&lt;Author&gt; authors = reader.readCollection(<span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;(), Author.class);
      <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">Book</span>(title, description, publicationYear, authors);
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you&#8217;ve followed these steps to setup your client you can start reading and writing Java objects to the remote cache
and the actual data stored in the cache will be protobuf encoded provided that marshallers were registered with the
remote client for all involved types (<em>Book</em> and <em>Author</em> in our example). Keeping your objects stored in protobuf
format has the benefit of being able to consume them with compatible clients written in different languages.</p>
</div>
</div>
<div class="sect3">
<h4 id="indexing_of_protobuf_encoded_entries"><a class="anchor" href="#indexing_of_protobuf_encoded_entries"></a>11.3.2. Indexing of Protobuf encoded entries</h4>
<div class="paragraph">
<p>After configuring the client as described in the previous section you can start configuring indexing for your caches on
the server side. Activating indexing and the various indexing specific configurations is identical to embedded mode and
is detailed in the <a href="#query_configuration_api">Querying Infinispan</a> chapter.</p>
</div>
<div class="paragraph">
<p>There is however an extra configuration step involved. While in embedded mode the indexing metadata is obtained via Java
reflection by analyzing the presence of various Hibernate Search annotations on the entry&#8217;s class, this is obviously not
possible if the entry is protobuf encoded.
The server needs to obtain the relevant metadata from the same descriptor (.proto file) as the client.
The descriptors are stored in a dedicated cache on the server named <em>'___protobuf_metadata'</em>. Both keys and values in
this cache are plain strings. Registering a new schema is therefore as simple as performing a <em>put</em> operation on this
cache using the schema&#8217;s name as key and the schema file itself as the value.
Alternatively you can use the CLI (via the cache-container=*:register-proto-schemas() operation), the Management Console
or the <em>ProtobufMetadataManager</em> MBean via JMX.
Be aware that, when security is enabled, access to the schema cache via the remote protocols requires
that the user belongs to the '___schema_manager' role.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Once indexing is enabled for a cache all fields of Protobuf encoded entries will be fully indexed unless you use
the <em>@Indexed</em> and <em>@Field</em> protobuf schema pseudo-annotations in order to control precisely what fields need to get
indexed. The default behaviour can be very inefficient when dealing with types having many or very larger fields so we
encourage you to always specify what fields should be indexed instead of relying on the default indexing behaviour.
The indexing behaviour for protobuf message types that are not annotated can also be modified per each schema file by
setting the protobuf schema option <em>'indexed_by_default'</em> to <em>false</em> (its default value is considered <em>true</em>) at
the beginning of your schema file.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="protobuf">option indexed_by_default = false;  // This disables indexing of types that are not annotated for indexing</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="a_remote_query_example"><a class="anchor" href="#a_remote_query_example"></a>11.3.3. A remote query example</h4>
<div class="paragraph">
<p>You&#8217;ve managed to configure both client and server to talk protobuf and you&#8217;ve enabled indexing. Let&#8217;s put some data in
the cache and try to search for it then!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl</span>.*;
...

RemoteCacheManager remoteCacheManager = ...;
RemoteCache&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">Book</span>&gt; remoteCache = remoteCacheManager.getCache();

<span class="predefined-type">Book</span> book1 = <span class="keyword">new</span> <span class="predefined-type">Book</span>();
book1.setTitle(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate in Action</span><span class="delimiter">&quot;</span></span>);
remoteCache.put(<span class="integer">1</span>, book1);

<span class="predefined-type">Book</span> book2 = <span class="keyword">new</span> <span class="predefined-type">Book</span>();
book2.setTile(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate Search in Action</span><span class="delimiter">&quot;</span></span>);
remoteCache.put(<span class="integer">2</span>, book2);

QueryFactory qf = Search.getQueryFactory(remoteCache);
<span class="predefined-type">Query</span> query = qf.from(<span class="predefined-type">Book</span>.class)
            .having(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).like(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Hibernate Search%</span><span class="delimiter">&quot;</span></span>)
            .build();

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; list = query.list(); <span class="comment">// Voila! We have our book back from the cache!</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The key part of creating a query is obtaining the <em>QueryFactory</em> for the remote cache using the
<em>org.infinispan.client.hotrod.Search.getQueryFactory()</em> method. Once you have this creating the query is similar to
embedded mode which is covered in <a href="#query_dsl">this</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="analysis"><a class="anchor" href="#analysis"></a>11.3.4. Analysis</h4>
<div class="paragraph">
<p>Analysis is a process that converts input data into one or more terms that you can index and query.</p>
</div>
<div class="sect4">
<h5 id="default_analyzers"><a class="anchor" href="#default_analyzers"></a>Default Analyzers</h5>
<div class="paragraph">
<p>Infinispan provides a set of default analyzers as follows:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Definition</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>standard</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Splits text fields into tokens, treating whitespace and punctuation as delimiters.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>simple</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tokenizes input streams by delimiting at non-letters and then converting all letters to lowercase characters. Whitespace and non-letters are discarded.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>whitespace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Splits text streams on whitespace and returns sequences of non-whitespace characters as tokens.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keyword</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Treats entire text fields as single tokens.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stemmer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stems English words using the Snowball Porter filter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ngram</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generates n-gram tokens that are 3 grams in size by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>filename</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Splits text fields into larger size tokens than the <code>standard</code> analyzer, treating whitespace as a delimiter and converts all letters to lowercase characters.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These analyzer definitions are based on Apache Lucene and are provided "as-is".
For more information about tokenizers, filters, and CharFilters, see the
appropriate Lucene documentation.</p>
</div>
</div>
<div class="sect4">
<h5 id="using_analyzer_definitions"><a class="anchor" href="#using_analyzer_definitions"></a>Using Analyzer Definitions</h5>
<div class="paragraph">
<p>To use analyzer definitions, reference them by name in the <em>.proto</em> schema file.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Include the <code>Analyze.YES</code> attribute to indicate that the property is analyzed.</p>
</li>
<li>
<p>Specify the analyzer definition with the <code>@Analyzer</code> annotation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following example shows referenced analyzer definitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="protobuf">/* @Indexed */
message TestEntity {

    /* @Field(store = Store.YES, analyze = Analyze.YES, analyzer = @Analyzer(definition = &quot;keyword&quot;)) */
    optional string id = 1;

    /* @Field(store = Store.YES, analyze = Analyze.YES, analyzer = @Analyzer(definition = &quot;simple&quot;)) */
    optional string name = 2;
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="creating_custom_analyzer_definitions"><a class="anchor" href="#creating_custom_analyzer_definitions"></a>Creating Custom Analyzer Definitions</h5>
<div class="paragraph">
<p>If you require custom analyzer definitions, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create an implementation of the
<code>ProgrammaticSearchMappingProvider</code> interface packaged in a <code>JAR</code> file.</p>
</li>
<li>
<p>Provide a file named <code>org.infinispan.query.spi.ProgrammaticSearchMappingProvider</code> in the
<code>META-INF/services/</code> directory of your <code>JAR</code>. This file should contain the fully qualified class name of your implementation.</p>
</li>
<li>
<p>Copy the <code>JAR</code> to the <code>standalone/deployments</code> directory of your Infinispan installation.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Your deployment must be available to the Infinispan server during startup. You cannot add the deployment if the server is already running.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following is an example implementation of the
<code>ProgrammaticSearchMappingProvider</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.core.LowerCaseFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.core.StopFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.standard.StandardFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.standard.StandardTokenizerFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.cfg.SearchMapping</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.Cache</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.spi.ProgrammaticSearchMappingProvider</span>;

<span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">MyAnalyzerProvider</span> <span class="directive">implements</span> ProgrammaticSearchMappingProvider {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> defineMappings(Cache cache, SearchMapping searchMapping) {
      searchMapping
            .analyzerDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-with-stop</span><span class="delimiter">&quot;</span></span>, StandardTokenizerFactory.class)
               .filter(StandardFilterFactory.class)
               .filter(LowerCaseFilterFactory.class)
               .filter(StopFilterFactory.class);
   }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Specify the <code>JAR</code> in the cache container configuration, for
example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;modules&gt;</span>
     <span class="tag">&lt;module</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">deployment.analyzers.jar</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/modules&gt;</span>
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="statistics"><a class="anchor" href="#statistics"></a>11.4. Statistics</h3>
<div class="paragraph">
<p>Query <a href="http://docs.jboss.org/hibernate/search/5.7/api/org/hibernate/search/stat/Statistics.html"><em>Statistics</em></a>
can be obtained from the <em>SearchManager</em>, as demonstrated in the following code snippet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SearchManager searchManager = Search.getSearchManager(cache);
org.hibernate.search.stat.Statistics statistics = searchManager.getStatistics();</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This data is also available via JMX through the <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#_statisticsinfombean">Hibernate Search StatisticsInfoMBean</a>
registered under the name <code>org.infinispan:type=Query,manager="{name-of-cache-manager}",cache="{name-of-cache}",component=Statistics</code>.
Please note this MBean is always registered by Infinispan but the statistics are collected only if
<a href="#enabling_jmx_statistics">statistics collection is enabled</a> at cache level.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Hibernate Search has its own configuration properties <code>hibernate.search.jmx_enabled</code> and <code>hibernate.search.generate_statistics</code>
for JMX statistics as explained <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-monitoring">here</a>.
Using them with Infinispan Query is forbidden as it will only lead to duplicated MBeans and unpredictable results.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="query_performance"><a class="anchor" href="#query_performance"></a>11.5. Performance Tuning</h3>
<div class="sect3">
<h4 id="batch_writing_in_sync_mode"><a class="anchor" href="#batch_writing_in_sync_mode"></a>11.5.1. Batch writing in SYNC mode</h4>
<div class="paragraph">
<p>By default, the <a href="#query_index_manager">Index Managers</a> work in sync mode, meaning when data is written to Infinispan, it will perform the indexing operations synchronously.
This synchronicity guarantees indexes are always consistent with the data (and thus visible in searches), but can slowdown write operations since it will also perform a commit to the index.
Committing is an extremely expensive operation in Lucene, and for that reason, multiple writes from different nodes can be automatically batched into a single commit to reduce
the impact.</p>
</div>
<div class="paragraph">
<p>So, when doing data loads to Infinispan with index enabled, try to use multiple threads to take advantage of this batching.</p>
</div>
<div class="paragraph">
<p>If using multiple threads does not result in the required performance, an alternative is to load data with indexing temporarily disabled and run
 a <a href="#query_massindexer">re-indexing</a> operation afterwards. This can be done writing data with the <code>SKIP_INDEXING</code> flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cache.getAdvancedCache().withFlags(Flag.SKIP_INDEXING).put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="writing_using_async_mode"><a class="anchor" href="#writing_using_async_mode"></a>11.5.2. Writing using async mode</h4>
<div class="paragraph">
<p>If it&#8217;s acceptable a small delay between data writes and when that data is visible in queries, an index manager can be configured to work in <strong>async mode</strong>.
The async mode offers much better writing performance, since in this mode commits happen at a configurable interval.</p>
</div>
<div class="paragraph">
<p>Configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              org.infinispan.query.indexmanager.InfinispanIndexManager
        <span class="tag">&lt;/property&gt;</span>
        <span class="comment">&lt;!-- Index data in async mode --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.worker.execution</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>async<span class="tag">&lt;/property&gt;</span>
        <span class="comment">&lt;!-- Optional: configure the commit interval, default is 1000ms --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.index_flush_interval</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>500<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="index_reader_async_strategy"><a class="anchor" href="#index_reader_async_strategy"></a>11.5.3. Index reader async strategy</h4>
<div class="paragraph">
<p>Lucene internally works with snapshots of the index: once an <em>IndexReader</em> is opened, it will only see the index changes up to the point it was opened;
further index changes will not be visible until the <em>IndexReader</em> is refreshed. The Index Managers used in Infinispan by default will check the
freshness of the index readers before every query and refresh them if necessary.</p>
</div>
<div class="paragraph">
<p>It is possible to tune this strategy to relax this freshness checking to a pre-configured interval by using the <code>reader.strategy</code> configuration set as <code>async</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">key-partitioner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.distribution.ch.impl.AffinityPartitioner</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PRIMARY_OWNER</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              org.infinispan.query.affinity.AffinityIndexManager
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.reader.strategy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>async<span class="tag">&lt;/property&gt;</span>
        <span class="comment">&lt;!-- refresh reader every 1s, default is 5s --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.reader.async_refresh_period_ms</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>1000<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The async reader strategy is particularly useful for Index Managers that rely on shards, such as the AffinityIndexManager.</p>
</div>
</div>
<div class="sect3">
<h4 id="lucene_options"><a class="anchor" href="#lucene_options"></a>11.5.4. Lucene Options</h4>
<div class="paragraph">
<p>It is possible to apply tuning options in Lucene directly. For more details, see the <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#_lucene_configuration">Hibernate Search manual</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clustered_counters"><a class="anchor" href="#clustered_counters"></a>12. Clustered Counters</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Clustered counters</em> are counters which are distributed and shared among all nodes in the Infinispan cluster.
Counters can have different consistency levels: strong and weak.</p>
</div>
<div class="paragraph">
<p>Although a strong/weak consistent counter has separate interfaces, both support updating its value,
return the current value and they provide events when its value is updated.
Details are provided below in this document to help you choose which one fits best your uses-case.</p>
</div>
<div class="sect2">
<h3 id="installation_and_configuration"><a class="anchor" href="#installation_and_configuration"></a>12.1. Installation and Configuration</h3>
<div class="paragraph">
<p>In order to start using the counters, you needs to add the dependency in your Maven <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-clustered-counter<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
<div class="paragraph">
<p>The counters can be configured Infinispan configuration file or on-demand via the <code>CounterManager</code> interface detailed
later in this document.
A counters configured in Infinispan configuration file is created at boot time when the <code>EmbeddedCacheManager</code> is starting.
Theses counters are started eagerly and they are available in all the cluster&#8217;s nodes.</p>
</div>
<div class="listingblock">
<div class="title">configuration.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;infinispan&gt;</span>
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">...</span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- if needed to persist counter, global state needs to be configured --&gt;</span>
        <span class="tag">&lt;global-state&gt;</span>
            ...
        <span class="tag">&lt;/global-state&gt;</span>
        <span class="comment">&lt;!-- your caches configuration goes here --&gt;</span>
         <span class="tag">&lt;counters</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:counters:9.2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">num-owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">reliability</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CONSISTENT</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
             <span class="tag">&lt;strong-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;strong-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VOLATILE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                 <span class="tag">&lt;lower-bound</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;/strong-counter&gt;</span>
             <span class="tag">&lt;strong-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENT</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                 <span class="tag">&lt;upper-bound</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;/strong-counter&gt;</span>
             <span class="tag">&lt;strong-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VOLATILE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                 <span class="tag">&lt;lower-bound</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                 <span class="tag">&lt;upper-bound</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;/strong-counter&gt;</span>
             <span class="tag">&lt;weak-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENT</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">concurrency-level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/counters&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or programmatically, in the <code>GlobalConfigurationBuilder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder globalConfigurationBuilder = ...;
CounterManagerConfigurationBuilder builder = globalConfigurationBuilder.addModule(CounterManagerConfigurationBuilder.class);
builder.numOwner(<span class="integer">3</span>).reliability(Reliability.CONSISTENT);
builder.addStrongCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c1</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">1</span>).storage(Storage.PERSISTENT);
builder.addStrongCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c2</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">2</span>).lowerBound(<span class="integer">0</span>).storage(Storage.VOLATILE);
builder.addStrongCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c3</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">3</span>).upperBound(<span class="integer">5</span>).storage(Storage.PERSISTENT);
builder.addStrongCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c4</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">4</span>).lowerBound(<span class="integer">0</span>).upperBound(<span class="integer">10</span>).storage(Storage.VOLATILE);
builder.addWeakCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c5</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">5</span>).concurrencyLevel(<span class="integer">1</span>).storage(Storage.PERSISTENT);</code></pre>
</div>
</div>
<div class="paragraph">
<p>On other hand, the counters can be configured on-demand, at any time after the <code>EmbeddedCacheManager</code> is initialized.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CounterManager manager = ...;
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c1</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.UNBOUNDED_STRONG).initialValue(<span class="integer">1</span>).storage(Storage.PERSISTENT)build());
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c2</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(<span class="integer">2</span>).lowerBound(<span class="integer">0</span>).storage(Storage.VOLATILE).build());
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c3</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(<span class="integer">3</span>).upperBound(<span class="integer">5</span>).storage(Storage.PERSISTENT).build());
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c4</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(<span class="integer">4</span>).lowerBound(<span class="integer">0</span>).upperBound(<span class="integer">10</span>).storage(Storage.VOLATILE).build());
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c2</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.WEAK).initialValue(<span class="integer">5</span>).concurrencyLevel(<span class="integer">1</span>).storage(Storage.PERSISTENT).build());</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>CounterConfiguration</code> is immutable and can be reused.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The method <code>defineCounter()</code> will return <code>true</code> if the counter is successful configured or <code>false</code> otherwise.
However, if the configuration is invalid, the method will throw a <code>CounterConfigurationException</code>.
To find out if a counter is already defined, use the method <code>isDefined()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CounterManager manager = ...
if (!manager.isDefined(<span class="string"><span class="delimiter">&quot;</span><span class="content">someCounter</span><span class="delimiter">&quot;</span></span>)) {
    manager.define(<span class="string"><span class="delimiter">&quot;</span><span class="content">someCounter</span><span class="delimiter">&quot;</span></span>, ...);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Per cluster attributes:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>num-owners</code>: Sets the number of counter&#8217;s copies to keep cluster-wide.
A smaller number will make update operations faster but will support a lower number of server crashes.
It <strong>must be positive</strong> and its default value is <code>2</code>.</p>
</li>
<li>
<p><code>reliability</code>: Sets the counter&#8217;s update behavior in a network partition.
Default value is <code>AVAILABLE</code> and valid values are:</p>
<div class="ulist">
<ul>
<li>
<p><code>AVAILABLE</code>: all partitions are able to read and update the counter&#8217;s value.</p>
</li>
<li>
<p><code>CONSISTENT</code>: only the primary partition (majority of nodes) will be able to read and update the counter&#8217;s value.
The remaining partitions can only read its value.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Per counter attributes:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initial-value</code> [common]: Sets the counter&#8217;s initial value.
Default is <code>0</code> (zero).</p>
</li>
<li>
<p><code>storage</code> [common]: Sets the counter&#8217;s behavior when the cluster is shutdown and restarted.
Default value is <code>VOLATILE</code> and valid values are:</p>
<div class="ulist">
<ul>
<li>
<p><code>VOLATILE</code>: the counter&#8217;s value is only available in memory.
The value will be lost when a cluster is shutdown.</p>
</li>
<li>
<p><code>PERSISTENT</code>: the counter&#8217;s value is stored in a private and local persistent store.
The value is kept when the cluster is shutdown and restored after a restart.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
On-demand and <code>VOLATILE</code> counters will lose its value and configuration after a cluster shutdown.
They must be defined again after the restart.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><code>lower-bound</code> [strong]: Sets the strong consistent counter&#8217;s lower bound.
Default value is <code>Long.MIN_VALUE</code>.</p>
</li>
<li>
<p><code>upper-bound</code> [strong]: Sets the strong consistent counter&#8217;s upper bound.
Default value is <code>Long.MAX_VALUE</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If neither the <code>lower-bound</code> or <code>upper-bound</code> are configured, the strong counter is set as unbounded.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The <code>initial-value</code> must be between <code>lower-bound</code> and <code>upper-bound</code> inclusive.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><code>concurrency-level</code> [weak]: Sets the number of concurrent updates.
Its value <strong>must be positive</strong> and the default value is <code>16</code>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="list_counter_names"><a class="anchor" href="#list_counter_names"></a>12.1.1. List counter names</h4>
<div class="paragraph">
<p>To list all the counters defined, the method <code>CounterManager.getCounterNames()</code> returns a collection of all counter
names created cluster-wide.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the_countermanager_interface"><a class="anchor" href="#the_countermanager_interface"></a>12.2. The <code>CounterManager</code> interface.</h3>
<div class="paragraph">
<p>The <code>CounterManager</code> interface is the entry point to define, retrieve and remove a counter.
It automatically listen to the creation of <code>EmbeddedCacheManager</code> and proceeds with the registration  of an
instance of it per <code>EmbeddedCacheManager</code>.
It starts the caches needed to store the counter state and configures the default counters.</p>
</div>
<div class="paragraph">
<p>Retrieving the <code>CounterManager</code> is as simple as invoke the
<code>EmbeddedCounterManagerFactory.asCounterManager(EmbeddedCacheManager)</code>
as shown in the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// create or obtain your EmbeddedCacheManager</span>
EmbeddedCacheManager manager = ...;

<span class="comment">// retrieve the CounterManager</span>
CounterManager counterManager = EmbeddedCounterManagerFactory.asCounterManager(manager);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Hot Rod client, the <code>CounterManager</code> is registered in the RemoteCacheManager and it can be retrieved like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// create or obtain your RemoteCacheManager</span>
RemoteCacheManager manager = ...;

<span class="comment">// retrieve the CounterManager</span>
CounterManager counterManager = RemoteCounterManagerFactory.asCounterManager(manager);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Hot Rod messages format can be found in <a href="#hot_rod_protocol_2_7">Hot Rod Protocol 2.7</a>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="remove_a_counter_via_countermanager"><a class="anchor" href="#remove_a_counter_via_countermanager"></a>12.2.1. Remove a counter via CounterManager</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
use with caution.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There is a difference between remove a counter via the <code>Strong/WeakCounter</code> interfaces and the <code>CounterManager</code>.
The <code>CounterManager.remove(String)</code> removes the counter value from the cluster and removes all the listeners registered
in the counter in the local counter instance.
In addition, the counter instance is no longer reusable and it may return an invalid results.</p>
</div>
<div class="paragraph">
<p>On the other side, the <code>Strong/WeakCounter</code> removal only removes the counter value.
The instance can still be reused and the listeners still works.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The counter is re-created if it is accessed after a removal.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the_counter"><a class="anchor" href="#the_counter"></a>12.3. The Counter</h3>
<div class="paragraph">
<p>A counter can be strong (<code>StrongCounter</code>) or weakly consistent (<code>WeakCounter</code>) and both is identified by a name.
They have a specific interface but they share some logic, namely, both of them are asynchronous
( a <code>CompletableFuture</code> is returned by each operation), provide an update event and can be reset to its initial value.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t want to use the async API, it is possible to return a synchronous counter via <code>sync()</code> method.
The API is the same but without the <code>CompletableFuture</code> return value.</p>
</div>
<div class="paragraph">
<p>The following methods are common to both interfaces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> getName();
CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; getValue();
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; reset();
&lt;T <span class="directive">extends</span> CounterListener&gt; Handle&lt;T&gt; addListener(T listener);
CounterConfiguration getConfiguration();
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; remove();
SyncStrongCounter sync(); <span class="comment">//SyncWeakCounter for WeakCounter</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getName()</code> returns the counter name (identifier).</p>
</li>
<li>
<p><code>getValue()</code> returns the current counter&#8217;s value.</p>
</li>
<li>
<p><code>reset()</code> allows to reset the counter&#8217;s value to its initial value.</p>
</li>
<li>
<p><code>addListener()</code> register a listener to receive update events.
More details about it in the <a href="#clustered_counters_notify_events">Notification and Events</a> section.</p>
</li>
<li>
<p><code>getConfiguration()</code> returns the configuration used by the counter.</p>
</li>
<li>
<p><code>remove()</code> removes the counter value from the cluster. The instance can still be used and the listeners are kept.</p>
</li>
<li>
<p><code>sync()</code> creates a synchronous counter.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The counter is re-created if it is accessed after a removal.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="the_strongcounter_interface_when_the_consistency_or_bounds_matters"><a class="anchor" href="#the_strongcounter_interface_when_the_consistency_or_bounds_matters"></a>12.3.1. The <code>StrongCounter</code> interface: when the consistency or bounds matters.</h4>
<div class="paragraph">
<p>The strong counter provides uses a single key stored in Infinispan cache to provide the consistency needed.
All the updates are performed under the key lock to updates its values.
On other hand, the reads don&#8217;t acquire any locks and reads the current value.
Also, with this scheme, it allows to bound the counter value and provide atomic operations like compare-and-set/swap.</p>
</div>
<div class="paragraph">
<p>A <code>StrongCounter</code> can be retrieved from the <code>CounterManager</code> by using the <code>getStrongCounter()</code> method.
As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CounterManager counterManager = ...
StrongCounter aCounter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-counter);</span></span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Since every operation will hit a single key, the <code>StrongCounter</code> has a higher contention rate.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>StrongCounter</code> interface adds the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">default</span> CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; incrementAndGet() {
   <span class="keyword">return</span> addAndGet(<span class="integer">1L</span>);
}

<span class="keyword">default</span> CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; decrementAndGet() {
   <span class="keyword">return</span> addAndGet(-<span class="integer">1L</span>);
}

CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; addAndGet(<span class="type">long</span> delta);

CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; compareAndSet(<span class="type">long</span> expect, <span class="type">long</span> update);

CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; compareAndSwap(<span class="type">long</span> expect, <span class="type">long</span> update);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>incrementAndGet()</code> increments the counter by one and returns the new value.</p>
</li>
<li>
<p><code>decrementAndGet()</code> decrements the counter by one and returns the new value.</p>
</li>
<li>
<p><code>addAndGet()</code> adds a delta to the counter&#8217;s value and returns the new value.</p>
</li>
<li>
<p><code>compareAndSet()</code> and <code>compareAndSwap()</code> atomically set the counter&#8217;s value if the current value is the expected.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A operation is considered completed when the <code>CompletableFuture</code> is completed.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The difference between compare-and-set and compare-and-swap is that the former returns true if the operation succeeds
while the later returns the previous value.
The compare-and-swap is successful if the return value is the same as the expected.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="bounded_strongcounter"><a class="anchor" href="#bounded_strongcounter"></a>Bounded <code>StrongCounter</code></h5>
<div class="paragraph">
<p>When bounded, all the update method above will throw a <code>CounterOutOfBoundsException</code> when they reached the
lower or upper bound.
The exception has the following methods to check which side bound has been reached:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">boolean</span> isUpperBoundReached();
<span class="directive">public</span> <span class="type">boolean</span> isLowerBoundReached();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="uses_cases"><a class="anchor" href="#uses_cases"></a>Uses cases</h5>
<div class="paragraph">
<p>The strong counter fits better in the following uses cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When counter&#8217;s value is needed after each update (example, cluster-wise ids generator or sequences)</p>
</li>
<li>
<p>When a bounded counter is needed (example, rate limiter)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="usage_examples"><a class="anchor" href="#usage_examples"></a>Usage Examples</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">StrongCounter counter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded_coutner</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// incrementing the counter</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + counter.incrementAndGet().get());

<span class="comment">// decrement the counter's value by 100 using the functional API</span>
counter.addAndGet(-<span class="integer">100</span>).thenApply(v -&gt; {
   <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + v);
   <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}).get

<span class="comment">// alternative, you can do some work while the counter is updated</span>
CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; f = counter.addAndGet(<span class="integer">10</span>);
<span class="comment">// ... do some work ...</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + f.get());

<span class="comment">// and then, check the current value</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());

<span class="comment">// finally, reset to initial value</span>
counter.reset().get();
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());

<span class="comment">// or set to a new value if zero</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">compare and set succeeded? </span><span class="delimiter">&quot;</span></span> + counter.compareAndSet(<span class="integer">0</span>, <span class="integer">1</span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>And below, there is another example using a bounded counter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">StrongCounter counter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">bounded_counter</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// incrementing the counter</span>
<span class="keyword">try</span> {
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + counter.addAndGet(<span class="integer">100</span>).get());
} <span class="keyword">catch</span> (<span class="exception">ExecutionException</span> e) {
    <span class="predefined-type">Throwable</span> cause = e.getCause();
    <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> CounterOutOfBoundsException) {
       <span class="keyword">if</span> (((CounterOutOfBoundsException) cause).isUpperBoundReached()) {
          <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ops, upper bound reached.</span><span class="delimiter">&quot;</span></span>);
       } <span class="keyword">else</span> <span class="keyword">if</span> (((CounterOutOfBoundsException) cause).isLowerBoundReached()) {
          <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ops, lower bound reached.</span><span class="delimiter">&quot;</span></span>);
       }
    }
}

<span class="comment">// now using the functional API</span>
counter.addAndGet(-<span class="integer">100</span>).handle((v, throwable) -&gt; {
   <span class="keyword">if</span> (throwable != <span class="predefined-constant">null</span>) {
      <span class="predefined-type">Throwable</span> cause = throwable.getCause();
      <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> CounterOutOfBoundsException) {
         <span class="keyword">if</span> (((CounterOutOfBoundsException) cause).isUpperBoundReached()) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ops, upper bound reached.</span><span class="delimiter">&quot;</span></span>);
         } <span class="keyword">else</span> <span class="keyword">if</span> (((CounterOutOfBoundsException) cause).isLowerBoundReached()) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ops, lower bound reached.</span><span class="delimiter">&quot;</span></span>);
         }
      }
      <span class="keyword">return</span> <span class="predefined-constant">null</span>;
   }
   <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + v);
   <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}).get();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compare-and-set vs Compare-and-swap examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">StrongCounter counter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-counter</span><span class="delimiter">&quot;</span></span>);
<span class="type">long</span> oldValue, newValue;
<span class="keyword">do</span> {
   oldValue = counter.getValue().get();
   newValue = someLogic(oldValue);
} <span class="keyword">while</span> (!counter.compareAndSet(oldValue, newValue).get());</code></pre>
</div>
</div>
<div class="paragraph">
<p>With compare-and-swap, it saves one invocation counter invocation (<code>counter.getValue()</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">StrongCounter counter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-counter</span><span class="delimiter">&quot;</span></span>);
<span class="type">long</span> oldValue = counter.getValue().get();
<span class="type">long</span> currentValue, newValue;
<span class="keyword">do</span> {
   currentValue = oldValue;
   newValue = someLogic(oldValue);
} <span class="keyword">while</span> ((oldValue = counter.compareAndSwap(oldValue, newValue).get()) != currentValue);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="the_weakcounter_interface_when_speed_is_needed"><a class="anchor" href="#the_weakcounter_interface_when_speed_is_needed"></a>12.3.2. The <code>WeakCounter</code> interface: when speed is needed</h4>
<div class="paragraph">
<p>The <code>WeakCounter</code> stores the counter&#8217;s value in multiple keys in Infinispan cache.
The number of keys created is configured by the <code>concurrency-level</code> attribute.
Each key stores a partial state of the counter&#8217;s value and it can be updated concurrently.
It main advantage over the <code>StrongCounter</code> is the lower contention in the cache.
On other hand, the read of its value is more expensive and bounds are not allowed.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The reset operation should be handled with caution.
It is <strong>not</strong> atomic and it produces intermediates values.
These value may be seen by a read operation and by any listener registered.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <code>WeakCounter</code> can be retrieved from the <code>CounterManager</code> by using the <code>getWeakCounter()</code> method.
As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CounterManager counterManager = ...
StrongCounter aCounter = counterManager.getWeakCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-counter);</span></span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="weak_counter_interface"><a class="anchor" href="#weak_counter_interface"></a>Weak Counter Interface</h5>
<div class="paragraph">
<p>The <code>WeakCounter</code> adds the following methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">default</span> CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; increment() {
   <span class="keyword">return</span> add(<span class="integer">1L</span>);
}

<span class="keyword">default</span> CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; decrement() {
   <span class="keyword">return</span> add(-<span class="integer">1L</span>);
}

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; add(<span class="type">long</span> delta);</code></pre>
</div>
</div>
<div class="paragraph">
<p>They are similar to the `StrongCounter&#8217;s methods but they don&#8217;t return the new value.</p>
</div>
</div>
<div class="sect4">
<h5 id="uses_cases_2"><a class="anchor" href="#uses_cases_2"></a>Uses cases</h5>
<div class="paragraph">
<p>The weak counter fits best in uses cases where the result of the update operation is not needed or the counter&#8217;s value
is not required too often.
Collecting statistics is a good example of such an use case.</p>
</div>
</div>
<div class="sect4">
<h5 id="examples_4"><a class="anchor" href="#examples_4"></a>Examples</h5>
<div class="paragraph">
<p>Below, there is an example of the weak counter usage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">WeakCounter counter = counterManager.getWeakCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my_counter</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// increment the counter and check its result</span>
counter.increment().get();
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; f = counter.add(-<span class="integer">100</span>);
<span class="comment">//do some work</span>
f.get(); <span class="comment">//wait until finished</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());

<span class="comment">//using the functional API</span>
counter.reset().whenComplete((aVoid, throwable) -&gt; <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Reset done </span><span class="delimiter">&quot;</span></span> + (throwable == <span class="predefined-constant">null</span> ? <span class="string"><span class="delimiter">&quot;</span><span class="content">successfully</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">unsuccessfully</span><span class="delimiter">&quot;</span></span>))).get();
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clustered_counters_notify_events"><a class="anchor" href="#clustered_counters_notify_events"></a>12.4. Notifications and Events</h3>
<div class="paragraph">
<p>Both strong and weak counter supports a listener to receive its updates events.
The listener must implement <code>CounterListener</code> and it can be registerer by the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;T <span class="directive">extends</span> CounterListener&gt; Handle&lt;T&gt; addListener(T listener);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>CounterLister</code> has the following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CounterListener</span> {
   <span class="type">void</span> onUpdate(CounterEvent entry);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Handle</code> object returned has the main goal to remove the <code>CounterListener</code> when it is not longer needed.
Also, it allows to have access to the <code>CounterListener</code> instance that is it handling.
It has the following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Handle</span>&lt;T <span class="directive">extends</span> CounterListener&gt; {
   T getCounterListener();
   <span class="type">void</span> remove();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, the <code>CounterEvent</code> has the previous and current value and state.
It has the following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CounterEvent</span> {
   <span class="type">long</span> getOldValue();
   State getOldState();
   <span class="type">long</span> getNewValue();
   State getNewState();
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The state is always <code>State.VALID</code> for unbounded strong counter and weak counter.
<code>State.LOWER_BOUND_REACHED</code> and <code>State.UPPER_BOUND_REACHED</code> are only valid for bounded strong counters.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The weak counter <code>reset()</code> operation will trigger multiple notification with intermediate values.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clustered_lock"><a class="anchor" href="#clustered_lock"></a>13. Clustered Lock</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <em>clustered lock</em> is a lock which is distributed and shared among all nodes in the Infinispan cluster and currently provides a way to execute
code that will be synchronized between the nodes in a given cluster.</p>
</div>
<div class="sect2">
<h3 id="installation"><a class="anchor" href="#installation"></a>13.1. Installation</h3>
<div class="paragraph">
<p>In order to start using the clustered locks, you needs to add the dependency in your Maven <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-clustered-lock<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
</div>
<div class="sect2">
<h3 id="clusteredlock_configuration"><a class="anchor" href="#clusteredlock_configuration"></a>13.2. ClusteredLock Configuration</h3>
<div class="paragraph">
<p>Currently there is a single type of <code>ClusteredLock</code> supported : non reentrant, NODE ownership lock.</p>
</div>
<div class="sect3">
<h4 id="clustered_lock_ownership"><a class="anchor" href="#clustered_lock_ownership"></a>13.2.1. Ownership</h4>
<div class="ulist">
<ul>
<li>
<p><code>NODE</code>
When a <code>ClusteredLock</code> is defined, this lock can be used from all the nodes in the Infinispan cluster.
When the ownership is NODE type, this means that the owner of the lock is the Infinispan node that acquired the lock
at a given time.
This means that each time we get a <code>ClusteredLock</code> instance with the <code>ClusteredCacheManager</code>, this instance will be the
same instance for each Infinispan node.
This lock can be used to synchronize code between Infinispan nodes. The advantage of this lock is that any thread in the
node can release the lock at a given time.</p>
</li>
<li>
<p><code>INSTANCE</code> - not yet supported</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a <code>ClusteredLock</code> is defined, this lock can be used from all the nodes in the Infinispan cluster.
When the ownership is INSTANCE type, this means that the owner of the lock is the actual instance we acquired when
<code>ClusteredLockManager.get("lockName")</code> is called.</p>
</div>
<div class="paragraph">
<p>This means that each time we get a <code>ClusteredLock</code> instance with the <code>ClusteredCacheManager</code>, this instance will be
a new instance.
This lock can be used to synchronize code between Infinispan nodes and inside each Infinispan node.
The advantage of this lock is that only the instance that called 'lock' can release the lock.</p>
</div>
</div>
<div class="sect3">
<h4 id="reentrancy"><a class="anchor" href="#reentrancy"></a>13.2.2. Reentrancy</h4>
<div class="paragraph">
<p>When a <code>ClusteredLock</code> is configured reentrant, the owner of the lock can reacquire the lock as many consecutive
times as it wants while holding the lock.</p>
</div>
<div class="paragraph">
<p>Currently, only non reentrant locks are supported. This means that when two consecutive <code>lock</code> calls are sent for the same
owner, the first call will acquire the lock if it&#8217;s available, and the second call will block.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clusteredlockmanager_interface"><a class="anchor" href="#clusteredlockmanager_interface"></a>13.3. ClusteredLockManager Interface</h3>
<div class="paragraph">
<p>The <code>ClusteredLockManager</code> interface, <strong>marked as experimental</strong>, is the entry point to define, retrieve and remove a lock.
It automatically listen to the creation of <code>EmbeddedCacheManager</code> and proceeds with the registration  of an
instance of it per <code>EmbeddedCacheManager</code>.
It starts the internal caches needed to store the lock state.</p>
</div>
<div class="paragraph">
<p>Retrieving the <code>ClusteredLockManager</code> is as simple as invoking the <code>EmbeddedClusteredLockManagerFactory.from(EmbeddedCacheManager)</code>
as shown in the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// create or obtain your EmbeddedCacheManager</span>
EmbeddedCacheManager manager = ...;

<span class="comment">// retrieve the ClusteredLockManager</span>
ClusteredLockManager clusteredLockManager = EmbeddedClusteredLockManagerFactory.from(manager);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Experimental</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ClusteredLockManager</span> {

   <span class="type">boolean</span> defineLock(<span class="predefined-type">String</span> name);

   <span class="type">boolean</span> defineLock(<span class="predefined-type">String</span> name, ClusteredLockConfiguration configuration);

   ClusteredLock get(<span class="predefined-type">String</span> name);

   ClusteredLockConfiguration getConfiguration(<span class="predefined-type">String</span> name);

   <span class="type">boolean</span> isDefined(<span class="predefined-type">String</span> name);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; remove(<span class="predefined-type">String</span> name);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; forceRelease(<span class="predefined-type">String</span> name);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>defineLock</code> :
Defines a lock with the specified name and the default <code>ClusteredLockConfiguration</code>. It does not overwrite
existing configurations.</p>
</li>
<li>
<p><code>defineLock(String name, ClusteredLockConfiguration configuration)</code> :
Defines a lock with the specified name and <code>ClusteredLockConfiguration</code>. It does not overwrite existing
configurations.</p>
</li>
<li>
<p><code>ClusteredLock get(String name)</code> :
Gets a <code>ClusteredLock</code> by its name. A call of <code>defineLock</code> must be done at least once in the cluster.
See <a href="#clustered_lock_ownership">ownership</a> level section to understand the implications of <code>get</code> method call.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Currently, the only ownership level supported is <strong>NODE</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ClusteredLockConfiguration getConfiguration(String name)</code> :</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Returns the configuration of a <code>ClusteredLock</code>, if such exists.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>boolean isDefined(String name)</code> :
Checks if a lock is already defined.</p>
</li>
<li>
<p><code>CompletableFuture&lt;Boolean&gt; remove(String name)</code> :
Removes a <code>ClusteredLock</code> if such exists.</p>
</li>
<li>
<p><code>CompletableFuture&lt;Boolean&gt; forceRelease(String name)</code> :
Releases - or unlocks - a <code>ClusteredLock</code>, if such exists, no matter who is holding it at a given time.
Calling this method may cause concurrency issues and has to be used in <strong>exceptional situations</strong>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="clustered_lock_interface"><a class="anchor" href="#clustered_lock_interface"></a>13.4. ClusteredLock Interface</h3>
<div class="paragraph">
<p><code>ClusteredLock</code> interface, <strong>marked as experimental</strong>, is the interface that implements the clustered locks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Experimental</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ClusteredLock</span> {

   CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; lock();

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; tryLock();

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; tryLock(<span class="type">long</span> time, <span class="predefined-type">TimeUnit</span> unit);

   CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; unlock();

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; isLocked();

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; isLockedByMe();
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>lock</code> :
Acquires the lock. If the lock is not available then call blocks until the lock is acquired.
Currently, <strong>there is no maximum time specified for a lock request to fail</strong>, so this could cause thread starvation.</p>
</li>
<li>
<p><code>tryLock</code>
Acquires the lock only if it is free at the time of invocation, and returns <code>true</code> in that case. This method does not
block (or wait) for any lock acquisition.</p>
</li>
<li>
<p><code>tryLock(long time, TimeUnit unit)</code>
If the lock is available this method returns immediately with <code>true</code>.
If the lock is not available then the call waits until :</p>
<div class="ulist">
<ul>
<li>
<p>The lock is acquired</p>
</li>
<li>
<p>The specified waiting time elapses</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the time is less than or equal to zero, the method will not wait at all.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>unlock</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Releases the lock. Only the holder of the lock may release the lock.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>isLocked</code>
Returns <code>true</code> when the lock is locked and <code>false</code> when the lock is released.</p>
</li>
<li>
<p><code>isLockedByMe</code>
Returns <code>true</code> when the lock is owned by the caller and <code>false</code> when the lock is owned by someone else or it&#8217;s released.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="clustered_lock_usage"><a class="anchor" href="#clustered_lock_usage"></a>13.4.1. Usage Examples</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  EmbeddedCache cm = ...;
  ClusteredLockManager cclm = EmbeddedClusteredLockManagerFactory.from(cm);

  lock.tryLock()
    .thenCompose(result -&gt; {
       <span class="keyword">if</span> (result) {
        <span class="keyword">try</span> {
            <span class="comment">// manipulate protected state</span>
            } <span class="keyword">finally</span> {
               <span class="keyword">return</span> lock.unlock();
            }
       } <span class="keyword">else</span> {
          <span class="comment">// Do something else</span>
       }
    });
 }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clusteredlockmanager_configuration"><a class="anchor" href="#clusteredlockmanager_configuration"></a>13.5. ClusteredLockManager Configuration</h3>
<div class="paragraph">
<p>You can configure <code>ClusteredLockManager</code> to use different strategies for locks, either declaratively or programmatically, with the following attributes:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>num-owners</code></dt>
<dd>
<p>Defines the total number of nodes in each cluster that store the states of clustered locks. The default value is <code>-1</code>, which replicates the value to all nodes.</p>
</dd>
<dt class="hdlist1"><code>reliability</code></dt>
<dd>
<p>Controls how clustered locks behave when clusters split into partitions or multiple nodes leave a cluster. You can set the following values:</p>
<div class="ulist">
<ul>
<li>
<p><code>AVAILABLE</code>: Nodes in any partition can concurrently operate on locks.</p>
</li>
<li>
<p><code>CONSISTENT</code>: Only nodes that belong to the majority partition can operate on locks. This is the default value.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The following is an example declarative configuration for <code>ClusteredLockManager</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;infinispan</span>
        <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:${infinispan.core.schema.version} http://www.infinispan.org/schemas/infinispan-config-9.4.xsd</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:9.4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;transport</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;locking</span> <span class="attribute-name">concurrency-level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">acquire-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>

        <span class="tag">&lt;clustered-locks</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:clustered-locks:9.4</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">num-owners</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">reliability</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AVAILABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;clustered-lock</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lock1</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;clustered-lock</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lock2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/clustered-locks&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span>
    ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multimap_cache"><a class="anchor" href="#multimap_cache"></a>14. Multimap Cache</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MutimapCache is a type of Infinispan Cache that maps keys to values in which each key can contain multiple values.</p>
</div>
<div class="sect2">
<h3 id="installation_and_configuration_2"><a class="anchor" href="#installation_and_configuration_2"></a>14.1. Installation and configuration</h3>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-multimap<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
</div>
<div class="sect2">
<h3 id="multimapcache_api"><a class="anchor" href="#multimapcache_api"></a>14.2. MultimapCache API</h3>
<div class="paragraph">
<p>MultimapCache API exposes several methods to interact with the Multimap Cache.
All these methods are non-blocking in most of the cases. See [limitations]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">MultimapCache</span>&lt;K, V&gt; {

   CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; put(K key, V value);

   CompletableFuture&lt;<span class="predefined-type">Collection</span>&lt;V&gt;&gt; get(K key);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; remove(K key);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; remove(K key, V value);

   CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; remove(<span class="predefined-type">Predicate</span>&lt;? <span class="local-variable">super</span> V&gt; p);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; containsKey(K key);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; containsValue(V value);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; containsEntry(K key, V value);

   CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; size();

   <span class="type">boolean</span> supportsDuplicates();

}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="completablefuturevoid_putk_key_v_value"><a class="anchor" href="#completablefuturevoid_putk_key_v_value"></a>14.2.1. CompletableFuture&lt;Void&gt; put(K key, V value)</h4>
<div class="paragraph">
<p>Puts a key-value pair in the multimap cache.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">MultimapCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; multimapCache = ...;

multimapCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">girlNames</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">marie</span><span class="delimiter">&quot;</span></span>)
             .thenCompose(r1 -&gt; multimapCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">girlNames</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">oihana</span><span class="delimiter">&quot;</span></span>))
             .thenCompose(r3 -&gt; multimapCache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">girlNames</span><span class="delimiter">&quot;</span></span>))
             .thenAccept(names -&gt; {
                          <span class="keyword">if</span>(names.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">marie</span><span class="delimiter">&quot;</span></span>))
                              <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Marie is a girl name</span><span class="delimiter">&quot;</span></span>);

                           <span class="keyword">if</span>(names.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">oihana</span><span class="delimiter">&quot;</span></span>))
                              <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Oihana is a girl name</span><span class="delimiter">&quot;</span></span>);
                        });</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of this code is :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt">Marie is a girl name
Oihana is a girl name</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="completablefuturecollectionv_getk_key"><a class="anchor" href="#completablefuturecollectionv_getk_key"></a>14.2.2. CompletableFuture&lt;Collection&lt;V&gt;&gt; get(K key)</h4>
<div class="paragraph">
<p>Asynchronous that returns a view collection of the values associated with key in this multimap cache, if any. Any changes to the retrieved collection won&#8217;t change the values in this multimap cache.
When this method returns an empty collection, it means the key was not found.</p>
</div>
</div>
<div class="sect3">
<h4 id="completablefutureboolean_removek_key"><a class="anchor" href="#completablefutureboolean_removek_key"></a>14.2.3. CompletableFuture&lt;Boolean&gt; remove(K key)</h4>
<div class="paragraph">
<p>Asynchronous that removes the entry associated with the key from the multimap cache, if such exists.</p>
</div>
</div>
<div class="sect3">
<h4 id="completablefutureboolean_removek_key_v_value"><a class="anchor" href="#completablefutureboolean_removek_key_v_value"></a>14.2.4. CompletableFuture&lt;Boolean&gt; remove(K key, V value)</h4>
<div class="paragraph">
<p>Asynchronous that removes a key-value pair from the multimap cache, if such exists.</p>
</div>
</div>
<div class="sect3">
<h4 id="completablefuturevoid_removepredicate_super_v_p"><a class="anchor" href="#completablefuturevoid_removepredicate_super_v_p"></a>14.2.5. CompletableFuture&lt;Void&gt; remove(Predicate&lt;? super V&gt; p)</h4>
<div class="paragraph">
<p>Asynchronous method. Removes every value that match the given predicate.</p>
</div>
</div>
<div class="sect3">
<h4 id="completablefutureboolean_containskeyk_key"><a class="anchor" href="#completablefutureboolean_containskeyk_key"></a>14.2.6. CompletableFuture&lt;Boolean&gt; containsKey(K key)</h4>
<div class="paragraph">
<p>Asynchronous that returns true if this multimap contains the key.</p>
</div>
</div>
<div class="sect3">
<h4 id="completablefutureboolean_containsvaluev_value"><a class="anchor" href="#completablefutureboolean_containsvaluev_value"></a>14.2.7. CompletableFuture&lt;Boolean&gt; containsValue(V value)</h4>
<div class="paragraph">
<p>Asynchronous that returns true if this multimap contains the value in at least one key.</p>
</div>
</div>
<div class="sect3">
<h4 id="completablefutureboolean_containsentryk_key_v_value"><a class="anchor" href="#completablefutureboolean_containsentryk_key_v_value"></a>14.2.8. CompletableFuture&lt;Boolean&gt; containsEntry(K key, V value)</h4>
<div class="paragraph">
<p>Asynchronous that returns true if this multimap contains at least one key-value pair with the value.</p>
</div>
</div>
<div class="sect3">
<h4 id="completablefuturelong_size"><a class="anchor" href="#completablefuturelong_size"></a>14.2.9. CompletableFuture&lt;Long&gt; size()</h4>
<div class="paragraph">
<p>Asynchronous that returns the number of key-value pairs in the multimap cache. It doesn&#8217;t return the distinct number of keys.</p>
</div>
</div>
<div class="sect3">
<h4 id="boolean_supportsduplicates"><a class="anchor" href="#boolean_supportsduplicates"></a>14.2.10. boolean supportsDuplicates()</h4>
<div class="paragraph">
<p>Asynchronous that returns true if the multimap cache supports duplicates. This means that the content of the multimap can be
'a' &#8594; ['1', '1', '2']. For now this method will always return false, as duplicates are not yet supported.
The existence of a given value is determined by 'equals' and `hashcode' method&#8217;s contract.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating_a_multimap_cache"><a class="anchor" href="#creating_a_multimap_cache"></a>14.3. Creating a Multimap Cache</h3>
<div class="paragraph">
<p>Currently the MultimapCache is configured as a regular cache. This can be done either by code or XML configuration.
See how to configure a regular Cache in the section link to [configure a cache].</p>
</div>
<div class="sect3">
<h4 id="embedded_mode"><a class="anchor" href="#embedded_mode"></a>14.3.1. Embedded mode</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// create or obtain your EmbeddedCacheManager</span>
EmbeddedCacheManager cm = ... ;

<span class="comment">// create or obtain a MultimapCacheManager passing the EmbeddedCacheManager</span>
MultimapCacheManager multimapCacheManager = EmbeddedMultimapCacheManagerFactory.from(cm);

<span class="comment">// define the configuration for the multimap cache</span>
multimapCacheManager.defineConfiguration(multimapCacheName, c.build());

<span class="comment">// get the multimap cache</span>
multimapCache = multimapCacheManager.get(multimapCacheName);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="limitations_2"><a class="anchor" href="#limitations_2"></a>14.4. Limitations</h3>
<div class="paragraph">
<p>In almost every case the Multimap Cache will behave as a regular Cache, but some limitations exist in the current version.</p>
</div>
<div class="sect3">
<h4 id="support_for_duplicates"><a class="anchor" href="#support_for_duplicates"></a>14.4.1. Support for duplicates</h4>
<div class="paragraph">
<p>Duplicates are not supported yet. This means that the multimap won&#8217;t contain any duplicate key-value pair.
Whenever put method is called, if the key-value pair already exist, this key-value par won&#8217;t be added.
Methods used to check if a key-value pair is already present in the Multimap are the <code>equals</code> and <code>hashcode</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="eviction"><a class="anchor" href="#eviction"></a>14.4.2. Eviction</h4>
<div class="paragraph">
<p>For now, the eviction works per key, and not per key-value pair.
This means that whenever a key is evicted, all the values associated with the key will be evicted too.
Eviction per key-value could be supported in the future.</p>
</div>
</div>
<div class="sect3">
<h4 id="transactions_2"><a class="anchor" href="#transactions_2"></a>14.4.3. Transactions</h4>
<div class="paragraph">
<p>Implicit transactions are supported through the auto-commit and all the methods are non blocking.
Explicit transactions work without blocking in most of the cases.
Methods that will block are <code>size</code>, <code>containsEntry</code> and <code>remove(Predicate&lt;? super V&gt; p)</code></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cdi_support"><a class="anchor" href="#cdi_support"></a>15. CDI Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan includes integration with <a href="http://www.cdi-spec.org">Contexts and Dependency Injection (better known as CDI)</a> via Infinispan&#8217;s <code>infinispan-cdi-embedded</code> or <code>infinispan-cdi-remote</code> module.
CDI is part of <a href="http://www.oracle.com/technetwork/java/javaee/tech/index-jsp-142185.html">Java EE specification</a> and aims for managing beans' lifecycle inside the container.
The integration allows to inject Cache interface and bridge Cache and CacheManager events. JCache annotations (JSR-107) are supported by <code>infinispan-jcache</code> and <code>infinispan-jcache-remote</code> artifacts. For more information have a look at <a href="http://download.oracle.com/otndocs/jcp/jcache-1_0-fr-spec/index.html">Chapter 11</a> of the JCACHE specification.</p>
</div>
<div class="sect2">
<h3 id="maven_dependencies"><a class="anchor" href="#maven_dependencies"></a>15.1. Maven Dependencies</h3>
<div class="paragraph">
<p>To include CDI support for Infinispan in your project, use one of the following dependencies:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml for Embedded mode</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-cdi-embedded<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml for Remote mode</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-cdi-remote<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Which version of Infinispan should I use?</div>
We recommend using the latest final version Infinispan.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="embedded_cache_integration"><a class="anchor" href="#embedded_cache_integration"></a>15.2. Embedded cache integration</h3>
<div class="sect3">
<h4 id="inject_an_embedded_cache"><a class="anchor" href="#inject_an_embedded_cache"></a>15.2.1. Inject an embedded cache</h4>
<div class="paragraph">
<p>By default you can inject the default Infinispan cache. Let&#8217;s look at the following example:</p>
</div>
<div class="listingblock">
<div class="title">Default cache injection</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
import javax.inject.Inject;

<span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="annotation">@Inject</span>
    <span class="directive">private</span> Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;

    <span class="directive">public</span> <span class="predefined-type">String</span> greet(<span class="predefined-type">String</span> user) {
        <span class="predefined-type">String</span> cachedValue = cache.get(user);
        <span class="keyword">if</span> (cachedValue == <span class="predefined-constant">null</span>) {
            cachedValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + user;
            cache.put(user, cachedValue);
        }
        <span class="keyword">return</span> cachedValue;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to use a specific cache rather than the default one, you just have to provide your own cache configuration and cache qualifier. See example below:</p>
</div>
<div class="listingblock">
<div class="title">Qualifier example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
import javax.inject.Qualifier;

<span class="annotation">@Qualifier</span>
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.FIELD, <span class="predefined-type">ElementType</span>.PARAMETER, <span class="predefined-type">ElementType</span>.METHOD})
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Documented</span>
<span class="directive">public</span> <span class="annotation">@interface</span> GreetingCache {
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Injecting Cache with qualifier</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
import org.infinispan.configuration.cache.Configuration;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.cdi.ConfigureCache</span>;
<span class="keyword">import</span> <span class="include">javax.enterprise.inject.Produces</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

    <span class="annotation">@ConfigureCache</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>) <span class="comment">// This is the cache name.</span>
    <span class="annotation">@GreetingCache</span> <span class="comment">// This is the cache qualifier.</span>
    <span class="annotation">@Produces</span>
    <span class="directive">public</span> <span class="predefined-type">Configuration</span> greetingCacheConfiguration() {
        <span class="keyword">return</span> <span class="keyword">new</span> ConfigurationBuilder()
                    .memory()
                        .size(<span class="integer">1000</span>)
                    .build();
    }

    <span class="comment">// The same example without providing a custom configuration.</span>
    <span class="comment">// In this case the default cache configuration will be used.</span>
    <span class="annotation">@ConfigureCache</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GreetingCache</span>
    <span class="annotation">@Produces</span>
    <span class="directive">public</span> <span class="predefined-type">Configuration</span> greetingCacheConfiguration;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use this cache in the GreetingService add the <code>@GeetingCache</code> qualifier on your cache injection point.</p>
</div>
</div>
<div class="sect3">
<h4 id="override_the_default_embedded_cache_manager_and_configuration"><a class="anchor" href="#override_the_default_embedded_cache_manager_and_configuration"></a>15.2.2. Override the default embedded cache manager and configuration</h4>
<div class="paragraph">
<p>You can override the default cache configuration used by the default <code>EmbeddedCacheManager</code>. For that, you just have to create a <code>Configuration</code> producer with default qualifiers as illustrated in the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Overriding Configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

    <span class="comment">// By default CDI adds the @Default qualifier if no other qualifier is provided.</span>
    <span class="annotation">@Produces</span>
    <span class="directive">public</span> <span class="predefined-type">Configuration</span> defaultEmbeddedCacheConfiguration() {
        <span class="keyword">return</span> <span class="keyword">new</span> ConfigurationBuilder()
                    .memory()
                        .size(<span class="integer">100</span>)
                    .build();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s also possible to override the default <code>EmbeddedCacheManager</code>.
The newly created manager must have default qualifiers and Application scope.</p>
</div>
<div class="listingblock">
<div class="title">Overriding EmbeddedCacheManager</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
import javax.enterprise.context.ApplicationScoped;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

    <span class="annotation">@Produces</span>
    <span class="annotation">@ApplicationScoped</span>
    <span class="directive">public</span> EmbeddedCacheManager defaultEmbeddedCacheManager() {
      <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager(<span class="keyword">new</span> ConfigurationBuilder()
                                          .memory()
                                              .size(<span class="integer">100</span>)
                                          .build());
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configure_the_transport_for_clustered_use"><a class="anchor" href="#configure_the_transport_for_clustered_use"></a>15.2.3. Configure the transport for clustered use</h4>
<div class="paragraph">
<p>To use Infinispan in a clustered mode you have to configure the transport with the <code>GlobalConfiguration</code>.
To achieve that override the default cache manager as explained in the previous section. Look at the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Overriding default EmbeddedCacheManager</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
package org.infinispan.configuration.global.GlobalConfigurationBuilder;

<span class="annotation">@Produces</span>
<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> EmbeddedCacheManager defaultClusteredCacheManager() {
    <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager(
        <span class="keyword">new</span> GlobalConfigurationBuilder().transport().defaultTransport().build(),
        <span class="keyword">new</span> ConfigurationBuilder().memory().size(<span class="integer">7</span>).build()
    );
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="remote_cache_integration"><a class="anchor" href="#remote_cache_integration"></a>15.3. Remote cache integration</h3>
<div class="sect3">
<h4 id="inject_a_remote_cache"><a class="anchor" href="#inject_a_remote_cache"></a>15.3.1. Inject a remote cache</h4>
<div class="paragraph">
<p>With the CDI integration it&#8217;s also possible to use a <code>RemoteCache</code> as illustrated in the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Injecting RemoteCache</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="annotation">@Inject</span>
    <span class="directive">private</span> RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;

    <span class="directive">public</span> <span class="predefined-type">String</span> greet(<span class="predefined-type">String</span> user) {
        <span class="predefined-type">String</span> cachedValue = cache.get(user);
        <span class="keyword">if</span> (cachedValue == <span class="predefined-constant">null</span>) {
            cachedValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + user;
            cache.put(user, cachedValue);
        }
        <span class="keyword">return</span> cachedValue;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to use another cache, for example the greeting-cache, add the <code>@Remote</code> qualifier on the cache injection point which contains the cache name.</p>
</div>
<div class="listingblock">
<div class="title">Injecting RemoteCache with qualifier</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="annotation">@Inject</span>
    <span class="annotation">@Remote</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Adding the <code>@Remote</code> cache qualifier on each injection point might be error prone.
That&#8217;s why the remote cache integration provides another way to achieve the same goal. For that you have to create your own qualifier annotated with <code>@Remote</code>:</p>
</div>
<div class="listingblock">
<div class="title">RemoteCache qualifier</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Remote</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Qualifier</span>
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.FIELD, <span class="predefined-type">ElementType</span>.PARAMETER, <span class="predefined-type">ElementType</span>.METHOD})
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Documented</span>
<span class="directive">public</span> <span class="annotation">@interface</span> RemoteGreetingCache {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use this cache in the GreetingService add the qualifier <code>@RemoteGreetingCache</code> qualifier on your cache injection.</p>
</div>
</div>
<div class="sect3">
<h4 id="override_the_default_remote_cache_manager"><a class="anchor" href="#override_the_default_remote_cache_manager"></a>15.3.2. Override the default remote cache manager</h4>
<div class="paragraph">
<p>Like the embedded cache integration, the remote cache integration comes with a default remote cache manager producer. This default <code>RemoteCacheManager</code> can be overridden as illustrated in the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Overriding default RemoteCacheManager</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

    <span class="annotation">@Produces</span>
    <span class="annotation">@ApplicationScoped</span>
    <span class="directive">public</span> RemoteCacheManager defaultRemoteCacheManager() {
        <span class="keyword">return</span> <span class="keyword">new</span> RemoteCacheManager(localhost, <span class="integer">1544</span>);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="use_a_custom_remoteembedded_cache_manager_for_one_or_more_cache"><a class="anchor" href="#use_a_custom_remoteembedded_cache_manager_for_one_or_more_cache"></a>15.4. Use a custom remote/embedded cache manager for one or more cache</h3>
<div class="paragraph">
<p>It&#8217;s possible to use a custom cache manager for one or more cache. You just need to annotate the cache manager producer with the cache qualifiers. Look at the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

   <span class="annotation">@GreetingCache</span>
   <span class="annotation">@Produces</span>
   <span class="annotation">@ApplicationScoped</span>
   <span class="directive">public</span> EmbeddedCacheManager specificEmbeddedCacheManager() {
      <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager(<span class="keyword">new</span> ConfigurationBuilder()
                                          .expiration()
                                              .lifespan(<span class="integer">60000l</span>)
                                          .build());
   }

   <span class="annotation">@RemoteGreetingCache</span>
   <span class="annotation">@Produces</span>
   <span class="annotation">@ApplicationScoped</span>
   <span class="directive">public</span> RemoteCacheManager specificRemoteCacheManager() {
       <span class="keyword">return</span> <span class="keyword">new</span> RemoteCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>, <span class="integer">1544</span>);
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the above code the GreetingCache or the RemoteGreetingCache will be associated with the produced cache manager.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Producer method scope</div>
To work properly the producers must have the scope @ApplicationScoped . Otherwise each injection of cache will be associated to a new instance of cache manager.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="use_jcache_caching_annotations"><a class="anchor" href="#use_jcache_caching_annotations"></a>15.5. Use JCache caching annotations</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
There is now a separate module for JSR 107 (JCACHE) integration, including API. See <a href="#jcache_jsr_107">this chapter</a> for details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When CDI integration and JCache artifacts are present on the classpath, it is possible to use JCache annotations with CDI managed beans.
These annotations provide a simple way to handle common use cases.
The following caching annotations are defined in this specification:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@CacheResult</code> - caches the result of a method call</p>
</li>
<li>
<p><code>@CachePut</code> - caches a method parameter</p>
</li>
<li>
<p><code>@CacheRemoveEntry</code> - removes an entry from a cache</p>
</li>
<li>
<p><code>@CacheRemoveAll</code> - removes all entries from a cache</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Annotations target type</div>
These annotations must only be used on methods.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use these annotations, proper interceptors need to be declared in <code>beans.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">Interceptors for managed environments such as Application Servers</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/beans_1_1.xsd</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">bean-discovery-mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">annotated</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;interceptors&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCacheResultInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCachePutInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCacheRemoveEntryInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCacheRemoveAllInterceptor<span class="tag">&lt;/class&gt;</span>
  <span class="tag">&lt;/interceptors&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Interceptors for unmanaged environments such as standalone applications</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/beans_1_1.xsd</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">bean-discovery-mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">annotated</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;interceptors&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.CacheResultInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.CachePutInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.CacheRemoveEntryInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.CacheRemoveAllInterceptor<span class="tag">&lt;/class&gt;</span>
  <span class="tag">&lt;/interceptors&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following snippet of code illustrates the use of <code>@CacheResult</code> annotation. As you can see it simplifies the caching of the <code>Greetingservice#greet</code> method results.</p>
</div>
<div class="listingblock">
<div class="title">Using JCache annotations</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache.interceptor.CacheResult</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="annotation">@CacheResult</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> greet(<span class="predefined-type">String</span> user) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello</span><span class="delimiter">&quot;</span></span> + user;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first version of the <code>GreetingService</code> and the above version have exactly the same behavior. The only difference is the cache used. By default it&#8217;s the fully qualified name of the annotated method with its parameter types (e.g. <code>org.infinispan.example.GreetingService.greet(java.lang.String)</code>).</p>
</div>
<div class="paragraph">
<p>Using other cache than default is rather simple. All you need to do is to specify its name with the <code>cacheName</code> attribute of the cache annotation. For example:</p>
</div>
<div class="listingblock">
<div class="title">Specifying cache name for JCache</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@CacheResult</span>(cacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="use_cache_events_and_cdi"><a class="anchor" href="#use_cache_events_and_cdi"></a>15.6. Use Cache events and CDI</h3>
<div class="paragraph">
<p>It is possible to receive Cache and Cache Manager level events using CDI Events. You can achieve it using <code>@Observes</code> annotation as shown in the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">Event listeners based on CDI</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.enterprise.event.Observes</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachemanagerlistener.event.CacheStartedEvent</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.event</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="comment">// Cache level events</span>
    <span class="directive">private</span> <span class="type">void</span> entryRemovedFromCache(<span class="annotation">@Observes</span> CacheEntryCreatedEvent event) {
        ...
    }

    <span class="comment">// Cache Manager level events</span>
    <span class="directive">private</span> <span class="type">void</span> cacheStarted(<span class="annotation">@Observes</span> CacheStartedEvent event) {
        ...
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Check <a href="#listeners_and_notifications">Listeners and Notifications</a> for more information about event types.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jcache_jsr_107"><a class="anchor" href="#jcache_jsr_107"></a>16. JCache (JSR-107) provider</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan provides an implementation of
JCache 1.0 API ( <a href="http://www.jcp.org/en/jsr/detail?id=107">JSR-107</a> ).
JCache specifies a standard Java API for caching temporary Java objects in
memory. Caching java objects can help get around bottlenecks arising from
using data that is expensive to retrieve (i.e. DB or web service), or data
that is hard to calculate. Caching these type of objects in memory can help
speed up application performance by retrieving the data directly from memory
instead of doing an expensive roundtrip or recalculation. This document
specifies how to use JCache with Infinispan&#8217;s implementation of the
specification, and explains key aspects of the API.</p>
</div>
<div class="sect2">
<h3 id="dependencies_2"><a class="anchor" href="#dependencies_2"></a>16.1. Dependencies</h3>
<div class="paragraph">
<p>In order to start using Infinispan JCache implementation, a single dependency
needs to be added to the Maven pom.xml file:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-jcache<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
</div>
<div class="sect2">
<h3 id="create_a_local_cache"><a class="anchor" href="#create_a_local_cache"></a>16.2. Create a local cache</h3>
<div class="paragraph">
<p>Creating a local cache, using default configuration options as defined by the
JCache API specification, is as simple as doing the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

<span class="comment">// Retrieve the system wide cache manager</span>
CacheManager cacheManager = Caching.getCachingProvider().getCacheManager();
<span class="comment">// Define a named cache with default JCache configuration</span>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;());</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
By default, the JCache API specifies that data should be stored as
<code>storeByValue</code>, so that object state mutations outside of operations to the
cache, won&#8217;t have an impact in the objects stored in the cache. Infinispan
has so far implemented this using serialization/marshalling to make copies to
store in the cache, and that way adhere to the spec. Hence, if using default
JCache configuration with Infinispan, data stored must be marshallable.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, JCache can be configured to store data by reference
(just like Infinispan or JDK Collections work). To do that, simply call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;().setStoreByValue(<span class="predefined-constant">false</span>));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create_a_remote_cache"><a class="anchor" href="#create_a_remote_cache"></a>16.3. Create a remote cache</h3>
<div class="paragraph">
<p>Creating a remote cache (client-server mode), using default configuration options
as defined by the JCache API specification, is as simple as doing the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

<span class="comment">// Retrieve the system wide cache manager via org.infinispan.jcache.remote.JCachingProvider</span>
CacheManager cacheManager = Caching.getCachingProvider(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.jcache.remote.JCachingProvider</span><span class="delimiter">&quot;</span></span>).getCacheManager();
<span class="comment">// Define a named cache with default JCache configuration</span>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">remoteNamedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;());</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In order to use the org.infinispan.jcache.remote.JCachingProvider, infinispan-jcache-remote-&lt;version&gt;.jar
and all its transitive dependencies need to be on put your classpath.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="store_and_retrieve_data"><a class="anchor" href="#store_and_retrieve_data"></a>16.4. Store and retrieve data</h3>
<div class="paragraph">
<p>Even though JCache API does not extend neither
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">java.util.Map</a>
not <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">java.util.concurrent.ConcurrentMap</a>,
it providers a key/value API to store and retrieve data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

CacheManager cacheManager = Caching.getCacheManager();
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;());
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>); <span class="comment">// Notice that javax.cache.Cache.put(K) returns void!</span>
<span class="predefined-type">String</span> value = cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>); <span class="comment">// Returns &quot;world&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Contrary to standard <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">java.util.Map</a>,
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java">javax.cache.Cache</a>
comes with two basic put methods called put and getAndPut. The former returns
<code>void</code> whereas the latter returns the previous value associated with the key.
So, the equivalent of <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">java.util.Map.put(K)</a>
in JCache is <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java#L230">javax.cache.Cache.getAndPut(K)</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Even though JCache API only covers standalone caching, it can be plugged
with a persistence store, and has been designed with clustering or
distribution in mind. The reason why javax.cache.Cache offers two put methods
is because standard java.util.Map put call forces implementors to calculate
the previous value. When a persistent store is in use, or the cache is
distributed, returning the previous value could be an expensive operation, and
often users call standard <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">java.util.Map.put(K)</a>
without using the return value. Hence, JCache users need to think about
whether the return value is relevant to them, in which case they need to call
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java#L230">javax.cache.Cache.getAndPut(K)</a> ,
otherwise they can call <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">java.util.Map.put(K, V)</a>
which avoids returning the potentially expensive operation of returning the
previous value.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="comparing_java_util_concurrent_concurrentmap_and_javax_cache_cache_apis"><a class="anchor" href="#comparing_java_util_concurrent_concurrentmap_and_javax_cache_cache_apis"></a>16.5. Comparing java.util.concurrent.ConcurrentMap and javax.cache.Cache APIs</h3>
<div class="paragraph">
<p>Here&#8217;s a brief comparison of the data manipulation APIs provided by
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">java.util.concurrent.ConcurrentMap</a>
and <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java">javax.cache.Cache</a> APIs.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operation</th>
<th class="tableblock halign-left valign-top"><code>java.util.concurrent.ConcurrentMap&lt;K, V&gt;</code></th>
<th class="tableblock halign-left valign-top"><code>javax.cache.Cache&lt;K, V&gt;</code></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">store and no return</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void put(K key)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">store and return previous value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V put(K key)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V getAndPut(K key)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">store if not present</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V putIfAbsent(K key, V value)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean putIfAbsent(K key, V value)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retrieve</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V get(Object key)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V get(K key)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete if present</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V remove(Object key)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(K key)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete and return previous value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V remove(Object key)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V getAndRemove(K key)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete conditional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(Object key, Object value)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(K key, V oldValue)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">replace if present</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V replace(K key, V value)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean replace(K key, V value)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">replace and return previous value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V replace(K key, V value)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V getAndReplace(K key, V value)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">replace conditional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean replace(K key, V oldValue, V newValue)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean replace(K key, V oldValue, V newValue)</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Comparing the two APIs, it&#8217;s obvious to see that, where possible, JCache
avoids returning the previous value to avoid operations doing expensive
network or IO operations. This is an overriding principle in the design of
JCache API. In fact, there&#8217;s a set of operations that are present in
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">java.util.concurrent.ConcurrentMap</a> ,
but are not present in the <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java">javax.cache.Cache</a>
because they could be expensive to compute in a distributed cache.
The only exception is iterating over the contents of the cache:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operation</th>
<th class="tableblock halign-left valign-top"><code>java.util.concurrent.ConcurrentMap&lt;K, V&gt;</code></th>
<th class="tableblock halign-left valign-top"><code>javax.cache.Cache&lt;K, V&gt;</code></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">calculate size of cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int size()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">return all keys in the cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Set&lt;K&gt; keySet()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">return all values in the cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Collection&lt;V&gt; values()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">return all entries in the cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">iterate over the cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">use <code>iterator()</code> method on keySet, values or entrySet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Iterator&lt;Cache.Entry&lt;K, V&gt;&gt; iterator()</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="clustering_jcache_instances"><a class="anchor" href="#clustering_jcache_instances"></a>16.6. Clustering JCache instances</h3>
<div class="paragraph">
<p>Infinispan JCache implementation goes beyond the specification in order to
provide the possibility to cluster caches using the standard API. Given a
Infinispan configuration file configured to replicate caches like this:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;transport</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jcache-cluster</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can create a cluster of caches using this code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">java.net.URI</span>;

<span class="comment">// For multiple cache managers to be constructed with the standard JCache API</span>
<span class="comment">// and live in the same JVM, either their names, or their classloaders, must</span>
<span class="comment">// be different.</span>
<span class="comment">// This example shows how to force their classloaders to be different.</span>
<span class="comment">// An alternative method would have been to duplicate the XML file and give</span>
<span class="comment">// it a different name, but this results in unnecessary file duplication.</span>
<span class="predefined-type">ClassLoader</span> tccl = <span class="predefined-type">Thread</span>.currentThread().getContextClassLoader();
CacheManager cacheManager1 = Caching.getCachingProvider().getCacheManager(
      <span class="predefined-type">URI</span>.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-jcache-cluster.xml</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> TestClassLoader(tccl));
CacheManager cacheManager2 = Caching.getCachingProvider().getCacheManager(
      <span class="predefined-type">URI</span>.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-jcache-cluster.xml</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> TestClassLoader(tccl));

Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache1 = cacheManager1.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache2 = cacheManager2.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>);

cache1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">String</span> value = cache2.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>); <span class="comment">// Returns &quot;world&quot; if clustering is working</span>

<span class="comment">// --</span>

<span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">TestClassLoader</span> <span class="directive">extends</span> <span class="predefined-type">ClassLoader</span> {
  <span class="directive">public</span> TestClassLoader(<span class="predefined-type">ClassLoader</span> parent) {
     <span class="local-variable">super</span>(parent);
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jmx_mgmt_tooling"><a class="anchor" href="#jmx_mgmt_tooling"></a>17. Management Tooling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Management of Infinispan instances is all about exposing as much relevant statistical information that allows administrators to get a view of the state of each Infinispan instance. Taking in account that a single installation could be made up of several tens or hundreds Infinispan instances, providing clear and concise information in an efficient manner is imperative. The following sections dive into the range of management tooling that Infinispan provides.</p>
</div>
<div class="sect2">
<h3 id="jmx"><a class="anchor" href="#jmx"></a>17.1. JMX</h3>
<div class="paragraph">
<p>Over the years, <a href="http://www.oracle.com/technetwork/java/javase/tech/javamanagement-140525.html">JMX</a> has become the de facto standard for management and administration of middleware and as a result, the Infinispan team has decided to standardize on this technology for the exposure of management and statistical information.</p>
</div>
<div class="sect3">
<h4 id="understanding_the_exposed_mbeans"><a class="anchor" href="#understanding_the_exposed_mbeans"></a>17.1.1. Understanding The Exposed MBeans</h4>
<div class="paragraph">
<p>By connecting to the VM(s) where Infinispan is running with a standard JMX GUI such as <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/management/jconsole.html">JConsole</a> or <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/visualvm/">VisualVM</a> you should find the following MBeans:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For CacheManager level JMX statistics, without further configuration, you should see an MBean called <em>org.infinispan:type=CacheManager,name="DefaultCacheManager"</em> with <a href="https://docs.jboss.org/infinispan/9.4/apidocs/jmxComponents.html#CacheManager">properties specified by the CacheManager MBean</a> .</p>
</li>
<li>
<p>Using the cacheManagerName attribute in globalJmxStatistics XML element, or using the corresponding GlobalJmxStatisticsConfigurationBuilder.cacheManagerName(String cacheManagerName) call, you can name the cache manager in such way that the name is used as part of the JMX object name. So, if the name had been "Hibernate2LC", the JMX name for the cache manager would have been: <em>org.infinispan:type=CacheManager,name="Hibernate2LC"</em> . This offers a nice and clean way to manage environments where multiple cache managers are deployed, which follows <a href="http://www.oracle.com/technetwork/java/javase/tech/best-practices-jsp-136021.html">JMX best practices</a> .</p>
</li>
<li>
<p>For Cache level JMX statistics, you should see several different MBeans depending on which configuration options have been enabled. For example, if you have configured a write behind cache store, you should see an MBean exposing properties belonging to the cache store component. All Cache level MBeans follow the same format though which is the following: <code>org.infinispan:type=Cache,name="${name-of-cache}(${cache-mode})",manager="${name-of-cache-manager}",component=${component-name}</code> where:</p>
</li>
<li>
<p>${name-of-cache} has been substituted by the actual cache name. If this cache represents the default cache, its name will be <code>___defaultCache</code>.</p>
</li>
<li>
<p>${cache-mode} has been substituted by the cache mode of the cache. The cache mode is represented by the lower case version of the possible enumeration values shown <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/configuration/cache/CacheMode">here</a>.</p>
</li>
<li>
<p>${name-of-cache-manager} has been substituted by the name of the cache manager to which this cache belongs. The name is derived from the <em>cacheManagerName</em> attribute value in <code>globalJmxStatistics</code> element.</p>
</li>
<li>
<p>${component-name} has been substituted by one of the JMX component names in the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/jmxComponents.html">JMX reference documentation</a> .</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the cache store JMX component MBean for a default cache configured with synchronous distribution would have the following name: <code>org.infinispan:type=Cache,name="___defaultcache(dist_sync)",manager="DefaultCacheManager",component=CacheStore</code></p>
</div>
<div class="paragraph">
<p>Please note that cache and cache manager names are quoted to protect against illegal characters being used in these user-defined names.</p>
</div>
</div>
<div class="sect3">
<h4 id="enabling_jmx_statistics"><a class="anchor" href="#enabling_jmx_statistics"></a>17.1.2. Enabling JMX Statistics</h4>
<div class="paragraph">
<p>The MBeans mentioned in the previous section are always created and registered in the MBeanServer allowing you to manage
your caches but some of their attributes do not expose meaningful values unless you take the extra step of enabling
collection of statistics. Gathering and reporting statistics via JMX can be enabled at 2 different levels:</p>
</div>
<div class="paragraph">
<div class="title">CacheManager level</div>
<p>The CacheManager is the entity that governs all the cache instances that have been created from it.
Enabling CacheManager statistics collections differs depending on the configuration style:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If configuring the CacheManager via XML, make sure you add the following XML under the <code>&lt;cache-container /&gt;</code> element:</p>
<div class="literalblock">
<div class="content">
<pre>&lt;cache-container statistics="true"/&gt;</pre>
</div>
</div>
</li>
<li>
<p>If configuring the CacheManager programmatically, simply add the following code:</p>
<div class="literalblock">
<div class="content">
<pre>GlobalConfigurationBuilder globalConfigurationBuilder = ...
globalConfigurationBuilder.globalJmxStatistics().enable();</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Cache level</div>
<p>At this level, you will receive management information generated by individual cache instances.
Enabling Cache statistics collections differs depending on the configuration style:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If configuring the Cache via XML, make sure you add the following XML under the one of the top level cache elements, such as <code>&lt;local-cache /&gt;</code>:</p>
<div class="literalblock">
<div class="content">
<pre>&lt;local-cache statistics="true"/&gt;</pre>
</div>
</div>
</li>
<li>
<p>If configuring the Cache programmatically, simply add the following code:</p>
<div class="literalblock">
<div class="content">
<pre>ConfigurationBuilder configurationBuilder = ...
configurationBuilder.jmxStatistics().enable();</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="monitoring_cluster_health"><a class="anchor" href="#monitoring_cluster_health"></a>17.1.3. Monitoring cluster health</h4>
<div class="paragraph">
<p>It is also possible to monitor Infinispan cluster health using JMX. On CacheManager there&#8217;s an additional object called <code>CacheContainerHealth</code>. It contains the following attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cacheHealth - a list of caches and corresponding statuses (HEALTHY, UNHEALTHY or REBALANCING)</p>
</li>
<li>
<p>clusterHealth - overall cluster health</p>
</li>
<li>
<p>clusterName - cluster name</p>
</li>
<li>
<p>freeMemoryKb - Free memory obtained from JVM runtime measured in KB</p>
</li>
<li>
<p>numberOfCpus - The number of CPUs obtained from JVM runtime</p>
</li>
<li>
<p>numberOfNodes - The number of nodes in the cluster</p>
</li>
<li>
<p>totalMemoryKb - Total memory obtained from JVM runtime measured in KB</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="multiple_jmx_domains"><a class="anchor" href="#multiple_jmx_domains"></a>17.1.4. Multiple JMX Domains</h4>
<div class="paragraph">
<p>There can be situations where several CacheManager instances are created in a single VM, or Cache names belonging to different CacheManagers under the same VM clash.</p>
</div>
<div class="paragraph">
<p>Using different JMX domains for multi cache manager environments should be last resort.
Instead, it&#8217;s possible to name a cache manager in such way that it can easily be identified and used by monitoring tools. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Via XML:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate2LC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Programmatically:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder globalConfigurationBuilder = ...
globalConfigurationBuilder.globalJmxStatistics()
    .enable()
    .cacheManagerName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate2LC</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using either of these options should result on the CacheManager MBean name being: <code>org.infinispan:type=CacheManager,name="Hibernate2LC"</code></p>
</div>
<div class="paragraph">
<p>For the time being, you can still set your own jmxDomain if you need to and we also allow duplicate domains, or rather duplicate JMX names, but these should be limited to very special cases where different cache managers within the same JVM are named equally.</p>
</div>
</div>
<div class="sect3">
<h4 id="registering_mbeans_in_non_default_mbean_servers"><a class="anchor" href="#registering_mbeans_in_non_default_mbean_servers"></a>17.1.5. Registering MBeans In Non-Default MBean Servers</h4>
<div class="paragraph">
<p>Let&#8217;s discuss where Infinispan registers all these MBeans. By default, Infinispan registers them in the <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/management/ManagementFactory.html#getPlatformMBeanServer--">standard JVM MBeanServer platform</a> . However, users might want to register these MBeans in a different MBeanServer instance. For example, an application server might work with a different MBeanServer instance to the default platform one. In such cases, users should implement the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/jmx/MBeanServerLookup.html">MBeanServerLookup interface</a> provided by Infinispan so that the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/jmx/MBeanServerLookup.html#getMBeanServer--">getMBeanServer() method</a> returns the MBeanServer under which Infinispan should register the management MBeans. Once you have your implementation ready, simply configure Infinispan with the fully qualified name of this class. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Via XML:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;jmx</span> <span class="attribute-name">mbean-server-lookup</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.MyMBeanServerLookup</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Programmatically:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder globalConfigurationBuilder = ...
globalConfigurationBuilder.globalJmxStatistics()
    .enable()
    .mBeanServerLookup(<span class="keyword">new</span> com.acme.MyMBeanServerLookup());</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="available_mbeans"><a class="anchor" href="#available_mbeans"></a>17.1.6. Available MBeans</h4>
<div class="paragraph">
<p>For a complete list of available MBeans, refer to the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/jmxComponents.html">JMX reference documentation</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="command_line_interface"><a class="anchor" href="#command_line_interface"></a>17.2. Command-Line Interface (CLI)</h3>
<div class="paragraph">
<p>Infinispan offers a simple Command-Line Interface (CLI) with which it is possible to interact with the data within the caches and with most of the internal components (e.g. transactions, cross-site backups, rolling upgrades).</p>
</div>
<div class="paragraph">
<p>The CLI is built out of two elements: a server-side module and the  client command tool. The server-side module (<code>infinispan-cli-server-$VERSION.jar</code>) provides  the actual interpreter for the commands and needs to be included alongside your application. Infinispan Server includes CLI support out of the box.</p>
</div>
<div class="paragraph">
<p>Currently the server (and the  client) use the JMX protocol to communicate, but in a future release we  plan to support other communication protocols (in particular our own Hot Rod).</p>
</div>
<div class="paragraph">
<p>The CLI offers both an interactive and a batch mode. To invoke the client, run the
<em>bin/ispn-cli.[sh|bat]</em> script.</p>
</div>
<div class="paragraph">
<p>The following is a list of command-line switches which affect how the CLI can be started:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-c, --connect=URL connects to a running instance of Infinispan.
  JMX over RMI jmx://[username[:password]]@host:port[/container[/cache]]
                        JMX over JBoss remoting remoting://[username[:password]]@host:port[/container[/cache]]
-f, --file=FILE reads input from the specified file instead of using 
                        interactive mode. If FILE is '-', then commands will be read
                        from stdin
-h, --help shows this help page
-v, --version shows version information</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>JMX over RMI is the traditional way in which JMX clients connect to MBeanServers. Please refer to the <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/management/agent.html">JDK Monitoring and Management</a> documentation for details on how to configure the process to be monitored</p>
</li>
<li>
<p>JMX over JBoss Remoting is the protocol of choice when your Infinispan application is running inside WildFly.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The connection to the application can also be initiated from within the CLI using the connect command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[disconnected//]&gt; connect jmx://localhost:12000
[jmx://localhost:12000/MyCacheManager/&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The CLI prompt will show the active connection information, including the currently selected CacheManager. Initially no cache is selected so, before performing any cache operations, one must be selected. For this the <em>cache</em> command is used. The CLI supports tab-completion for all commands and options and for most parameters where it makes sense to do so. Therefore typing <em>cache</em> and pressing TAB will show a list of active caches:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/&gt; cache
___defaultcache namedCache
[jmx://localhost:12000/MyCacheManager/]&gt; cache ___defaultcache
[jmx://localhost:12000/MyCacheManager/___defaultcache]&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Pressing TAB at an empty prompt will show the list of all available commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>alias cache container encoding get locate remove site upgrade 
abort clearcache create end help put replace start version 
begin commit disconnect evict info quit rollback stats</pre>
</div>
</div>
<div class="paragraph">
<p>The CLI is based on <a href="https://github.com/aeshell/aesh">sh</a> and therefore offers many keyboard shortcuts to navigate and search the history of commands, to manipulate the cursor at the prompt, including both Emacs and VI modes of operation.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan CLI sessions expire if they remain idle for more than six minutes. Running commands after the session expires results in the following message:</p>
</div>
<div class="paragraph">
<p><code>ISPN019015: Invalid session id '&lt;session_id&gt;'</code></p>
</div>
<div class="paragraph">
<p>You must restart the CLI to start a new session.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="commands"><a class="anchor" href="#commands"></a>17.2.1. Commands</h4>
<div class="sect4">
<h5 id="abort"><a class="anchor" href="#abort"></a>abort</h5>
<div class="paragraph">
<p>The <em>abort</em> command is used to abort a running batch initiated by the <em>start</em> command</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; start
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; abort
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
null</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="begin"><a class="anchor" href="#begin"></a>begin</h5>
<div class="paragraph">
<p>The <em>begin</em> command starts a transaction. In order for this command to work, the cache(s) on which the subsequent operations are invoked must have transactions enabled.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; begin
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put b b
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; commit</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cache"><a class="anchor" href="#cache"></a>cache</h5>
<div class="paragraph">
<p>The <em>cache</em> command selects the cache to use as default for all subsequent operations. If it is invoked without parameters it shows the currently selected cache.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; cache ___defaultcache
[jmx://localhost:12000/MyCacheManager/___defaultcache]&gt; cache
___defaultcache
[jmx://localhost:12000/MyCacheManager/___defaultcache]&gt;</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="clearcache"><a class="anchor" href="#clearcache"></a>clearcache</h5>
<div class="paragraph">
<p>The <em>clearcache</em> command clears a cache from all content.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; clearcache
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
null</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="commit"><a class="anchor" href="#commit"></a>commit</h5>
<div class="paragraph">
<p>The <em>commit</em> command commits an ongoing transaction</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; begin
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put b b
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; commit</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="container"><a class="anchor" href="#container"></a>container</h5>
<div class="paragraph">
<p>The <em>container</em> command selects the default container (cache manager). Invoked without parameters it lists all available containers</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; container
MyCacheManager OtherCacheManager
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; container OtherCacheManager
[jmx://localhost:12000/OtherCacheManager/]&gt;</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="create"><a class="anchor" href="#create"></a>create</h5>
<div class="paragraph">
<p>The <em>create</em> command creates a new cache based on the configuration of an existing cache definition</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; create newCache like namedCache
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; cache newCache
[jmx://localhost:12000/MyCacheManager/newCache]&gt;</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="deny"><a class="anchor" href="#deny"></a>deny</h5>
<div class="paragraph">
<p>When authorization is enabled and the role mapper has been configured to be the ClusterRoleMapper, principal to role mappings are stored within the cluster registry (a replicated cache available to all nodes).
The <em>deny</em> command can be used to deny roles previously assigned to a principal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[remoting://localhost:9999]&gt; deny supervisor to user1</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="disconnect"><a class="anchor" href="#disconnect"></a>disconnect</h5>
<div class="paragraph">
<p>The <em>disconnect</em> command disconnects the currently active connection allowing the CLI to connect to another instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; disconnect
[disconnected//]</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="encoding"><a class="anchor" href="#encoding"></a>encoding</h5>
<div class="paragraph">
<p>The <em>encoding</em> command is used to set a default codec to use when reading/writing entries from/to a cache. When invoked without arguments it shows the currently selected codec. This command is useful since currently remote protocols such as HotRod and Memcached wrap keys and values in specialized structures.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; encoding
none
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; encoding --list
memcached
hotrod
none
rest
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; encoding hotrod</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="end"><a class="anchor" href="#end"></a>end</h5>
<div class="paragraph">
<p>The <em>end</em> command is used to successfully end a running batch initiated by the <em>start</em> command</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; start
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; end
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
a</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="evict"><a class="anchor" href="#evict"></a>evict</h5>
<div class="paragraph">
<p>The <em>evict</em> command is used to evict from the cache the entry associated with a specific key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; evict a</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="get"><a class="anchor" href="#get"></a>get</h5>
<div class="paragraph">
<p>The <em>get</em> command is used to show the value associated to a specified key. For primitive types and Strings, the <em>get</em> command will simply print the default representation. For other objects, a JSON representation of the object will be printed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
a</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="grant"><a class="anchor" href="#grant"></a>grant</h5>
<div class="paragraph">
<p>When authorization is enabled and the role mapper has been configured to be the ClusterRoleMapper, principal to role mappings are stored within the cluster registry (a replicated cache available to all nodes).
The <em>grant</em> command can be used to grant new roles to a principal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[remoting://localhost:9999]&gt; grant supervisor to user1</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="info"><a class="anchor" href="#info"></a>info</h5>
<div class="paragraph">
<p>The <em>info</em> command is used to show the configuration of the currently selected cache or container.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; info
GlobalConfiguration{asyncListenerExecutor=ExecutorFactoryConfiguration{factory=org.infinispan.executors.DefaultExecutorFactory@98add58}, asyncTransportExecutor=ExecutorFactoryConfiguration{factory=org.infinispan.executors.DefaultExecutorFactory@7bc9c14c}, evictionScheduledExecutor=ScheduledExecutorFactoryConfiguration{factory=org.infinispan.executors.DefaultScheduledExecutorFactory@7ab1a411}, replicationQueueScheduledExecutor=ScheduledExecutorFactoryConfiguration{factory=org.infinispan.executors.DefaultScheduledExecutorFactory@248a9705}, globalJmxStatistics=GlobalJmxStatisticsConfiguration{allowDuplicateDomains=true, enabled=true, jmxDomain='jboss.infinispan', mBeanServerLookup=org.jboss.as.clustering.infinispan.MBeanServerProvider@6c0dc01, cacheManagerName='local', properties={}}, transport=TransportConfiguration{clusterName='ISPN', machineId='null', rackId='null', siteId='null', strictPeerToPeer=false, distributedSyncTimeout=240000, transport=null, nodeName='null', properties={}}, serialization=SerializationConfiguration{advancedExternalizers={1100=org.infinispan.server.core.CacheValue$Externalizer@5fabc91d, 1101=org.infinispan.server.memcached.MemcachedValue$Externalizer@720bffd, 1104=org.infinispan.server.hotrod.ServerAddress$Externalizer@771c7eb2}, marshaller=org.infinispan.marshall.VersionAwareMarshaller@6fc21535, version=52, classResolver=org.jboss.marshalling.ModularClassResolver@2efe83e5}, shutdown=ShutdownConfiguration{hookBehavior=DONT_REGISTER}, modules={}, site=SiteConfiguration{localSite='null'}}</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="locate"><a class="anchor" href="#locate"></a>locate</h5>
<div class="paragraph">
<p>The <em>locate</em> command shows the physical location of a specified entry in a distributed cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; locate a
[host/node1,host/node2]</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="put"><a class="anchor" href="#put"></a>put</h5>
<div class="paragraph">
<p>The <em>put</em> command inserts an entry in the cache. If the cache previously contained a mapping for the key, the old value is replaced by the specified value. The user can control the type of data that the CLI will use to store the key and value. See the <a href="#data_types">Data Types</a> section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put b 100
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put c 4139l
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put d true
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put e { "package.MyClass": {"i": 5, "x": null, "b": true } }</pre>
</div>
</div>
<div class="paragraph">
<p>The put command can optionally specify a lifespan and a maximum idle time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a expires 10s
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a expires 10m maxidle 1m</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="replace"><a class="anchor" href="#replace"></a>replace</h5>
<div class="paragraph">
<p>The <em>replace</em> command replaces an existing entry in the cache. If an old value is specified, then the replacement happens only if the value in the cache coincides.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; replace a b
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
b
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; replace a b c
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
c
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; replace a b d
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; get a
c</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="roles"><a class="anchor" href="#roles"></a>roles</h5>
<div class="paragraph">
<p>When authorization is enabled and the role mapper has been configured to be the ClusterRoleMapper, principal to role mappings are stored within the cluster registry (a replicated cache available to all nodes).
The <em>roles</em> command can be used to list the roles associated to a specific user, or to all users if one is not given:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[remoting://localhost:9999]&gt; roles user1
[supervisor, reader]</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="rollback"><a class="anchor" href="#rollback"></a>rollback</h5>
<div class="paragraph">
<p>The <em>rollback</em> command rolls back an ongoing transaction</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; begin
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put b b
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; rollback</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="site"><a class="anchor" href="#site"></a>site</h5>
<div class="paragraph">
<p>The <em>site</em> command performs operations related to the administration of cross-site replication. It can be used to obtain information related to the status of a site and to change the status (online/offline)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; site --status NYC
online
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; site --offline NYC
ok
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; site --status NYC
offline
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; site --online NYC</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="start"><a class="anchor" href="#start"></a>start</h5>
<div class="paragraph">
<p>The <em>start</em> command initiates a batch of operations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; start
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put a a
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; put b b
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; end</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="stats"><a class="anchor" href="#stats"></a>stats</h5>
<div class="paragraph">
<p>The <em>stats</em> command displays statistics about a cache</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; stats
Statistics: {
  averageWriteTime: 143
  evictions: 10
  misses: 5
  hitRatio: 1.0
  readWriteRatio: 10.0
  removeMisses: 0
  timeSinceReset: 2123
  statisticsEnabled: true
  stores: 100
  elapsedTime: 93
  averageReadTime: 14
  removeHits: 0
  numberOfEntries: 100
  hits: 1000
}
LockManager: {
  concurrencyLevel: 1000
  numberOfLocksAvailable: 0
  numberOfLocksHeld: 0
}</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="upgrade"><a class="anchor" href="#upgrade"></a>17.2.2. upgrade</h4>
<div class="paragraph">
<p>The <em>upgrade</em> command performs operations used during the rolling upgrade procedure. For a detailed description of this procedure please see <a href="#rolling_upgrades">Rolling Upgrades</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; upgrade --synchronize=hotrod --all
[jmx://localhost:12000/MyCacheManager/namedCache]&gt; upgrade --disconnectsource=hotrod --all</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="version"><a class="anchor" href="#version"></a>17.2.3. version</h4>
<div class="paragraph">
<p>The <em>version</em> command displays version information about both the CLI client and the server</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[jmx://localhost:12000/MyCacheManager/namedCache]&gt; version
Client Version 5.2.1.Final
Server Version 5.2.1.Final</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="data_types"><a class="anchor" href="#data_types"></a>17.2.4. Data Types</h4>
<div class="paragraph">
<p>The CLI understands the following types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>string strings can either be quoted between single (') or double (") quotes, or left unquoted. In this case it must not contain spaces, punctuation and cannot begin with a number  e.g. 'a string', key001</p>
</li>
<li>
<p>int an integer is identified by a sequence of decimal digits, e.g. 256</p>
</li>
<li>
<p>long a long is identified by a sequence of decimal digits suffixed by 'l', e.g. 1000l</p>
</li>
<li>
<p>double</p>
<div class="ulist">
<ul>
<li>
<p>a double precision number is identified by a floating point number(with optional exponent part) and an optional 'd' suffix, e.g.3.14</p>
</li>
</ul>
</div>
</li>
<li>
<p>float</p>
<div class="ulist">
<ul>
<li>
<p>a single precision number is identified by a floating point number(with optional exponent part) and an 'f' suffix, e.g. 10.3f</p>
</li>
</ul>
</div>
</li>
<li>
<p>boolean a boolean is represented either by the keywords true and false</p>
</li>
<li>
<p>UUID a UUID is represented by its canonical form XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</p>
</li>
<li>
<p>JSON serialized Java classes can be represented using JSON notation, e.g. {"package.MyClass":{"i":5,"x":null,"b":true}}. Please note that the specified class must be available to the CacheManager&#8217;s class loader.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="time_values"><a class="anchor" href="#time_values"></a>17.2.5. Time Values</h4>
<div class="paragraph">
<p>A time value is an integer number followed by time unit suffix: days (d), hours (h), minutes (m), seconds (s), milliseconds (ms).</p>
</div>
</div>
<div class="sect3">
<h4 id="starting_stopping_endpoints"><a class="anchor" href="#starting_stopping_endpoints"></a>17.2.6. Starting and Stopping Infinispan Endpoints</h4>
<div class="paragraph">
<p>Use the Command-Line Interface (CLI) to start and stop Infinispan endpoint connectors.</p>
</div>
<div class="paragraph">
<p>Commands to start and stop endpoint connectors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Apply to individual endpoints. To stop or start all endpoint connectors, you must run the command on each endpoint connector.</p>
</li>
<li>
<p>Take effect on single nodes only (not cluster-wide).</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Start the CLI and connect to Infinispan.</p>
</li>
<li>
<p>List the endpoint connectors in the <code>datagrid-infinispan-endpoint</code>
subsystem, as follows:</p>
<div class="listingblock">
<div class="content">
<pre>[standalone@localhost:9990 /] ls subsystem=datagrid-infinispan-endpoint
hotrod-connector     memcached-connector  rest-connector       router-connector</pre>
</div>
</div>
</li>
<li>
<p>Navigate to the endpoint connector you want to start or stop, for example:</p>
<div class="listingblock">
<div class="content">
<pre>[standalone@localhost:9990 /] cd subsystem=datagrid-infinispan-endpoint

[standalone@localhost:9990 subsystem=datagrid-infinispan-endpoint] cd rest-connector=rest-connector</pre>
</div>
</div>
</li>
<li>
<p>Use the <code>:stop-connector</code> and <code>:start-connector</code> commands as appropriate.</p>
<div class="listingblock">
<div class="content">
<pre>[standalone@localhost:9990 rest-connector=rest-connector] :stop-connector
{"outcome" =&gt; "success"}

[standalone@localhost:9990 rest-connector=rest-connector] :start-connector
{"outcome" =&gt; "success"}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="hawt_io"><a class="anchor" href="#hawt_io"></a>17.3. Hawt.io</h3>
<div class="paragraph">
<p><a href="http://hawt.io">Hawt.io</a>, a slick, fast, HTML5-based open source management console, also has support for Infinispan.
Refer to <a href="http://hawt.io/plugins/infinispan/">Hawt.io&#8217;s documentation</a> for information regarding this plugin.</p>
</div>
</div>
<div class="sect2">
<h3 id="writing_plugins_for_other_management_tools"><a class="anchor" href="#writing_plugins_for_other_management_tools"></a>17.4. Writing plugins for other management tools</h3>
<div class="paragraph">
<p>Any management tool that supports JMX already has basic support for Infinispan. However, custom plugins could be written to adapt the JMX information for easier consumption.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="custom_interceptors_chapter"><a class="anchor" href="#custom_interceptors_chapter"></a>18. Custom Interceptors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is possible to add custom interceptors to Infinispan, both declaratively and programatically. Custom interceptors are a way of extending Infinispan by being able to influence or respond to any modifications to cache. Example of such modifications are: elements are added/removed/updated or transactions are committed. For a detailed list refer to <a href="{javadoc.root}/org/infinispan/interceptors/base/CommandInterceptor.html">CommandInterceptor</a> API.</p>
</div>
<div class="sect2">
<h3 id="adding_custom_interceptors_declaratively"><a class="anchor" href="#adding_custom_interceptors_declaratively"></a>18.1. Adding custom interceptors declaratively</h3>
<div class="paragraph">
<p>Custom interceptors can be added on a per named cache basis. This is because each named cache have its own interceptor stack. Following xml snippet depicts the ways in which a custom interceptor can be added.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"> <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheWithCustomInterceptors</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="comment">&lt;!--
 Define custom interceptors. All custom interceptors need to extend org.jboss.cache.interceptors.base.CommandInterceptor
 --&gt;</span>
 <span class="tag">&lt;custom-interceptors&gt;</span>
 <span class="tag">&lt;interceptor</span> <span class="attribute-name">position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FIRST</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">attributeOne</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>value1<span class="tag">&lt;/property&gt;</span>
 <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">attributeTwo</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>value2<span class="tag">&lt;/property&gt;</span>
 <span class="tag">&lt;/interceptor&gt;</span>
 <span class="tag">&lt;interceptor</span> <span class="attribute-name">position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LAST</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;interceptor</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;interceptor</span> <span class="attribute-name">before</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispanpan.interceptors.CallInterceptor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;interceptor</span> <span class="attribute-name">after</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispanpan.interceptors.CallInterceptor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;/custom-interceptors&gt;</span>
 <span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding_custom_interceptors_programatically"><a class="anchor" href="#adding_custom_interceptors_programatically"></a>18.2. Adding custom interceptors programatically</h3>
<div class="paragraph">
<p>In order to do that one needs to obtain a reference to the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> . This can be done ass follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CacheManager cm = getCacheManager();<span class="comment">//magic</span>
Cache aCache = cm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">aName</span><span class="delimiter">&quot;</span></span>);
AdvancedCache advCache = aCache.getAdvancedCache();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then one of the <em>addInterceptor()</em> methods should be used to add the actual interceptor. For further documentation refer to <a href="{javadocJroot}/org/infinispan/AdvancedCache.html">AdvancedCache</a> javadoc.</p>
</div>
</div>
<div class="sect2">
<h3 id="custom_interceptor_design"><a class="anchor" href="#custom_interceptor_design"></a>18.3. Custom interceptor design</h3>
<div class="paragraph">
<p>When writing a custom interceptor, you need to abide by the following rules.</p>
</div>
<div class="paragraph">
<p>+
*  Custom interceptors must extend <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/interceptors/base/BaseCustomInterceptor.html">BaseCustomInterceptor</a>
* Custom interceptors must declare a public, empty constructor to enable construction.
* Custom interceptors will have setters for any property defined through property tags used in the XML configuration.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloud_services"><a class="anchor" href="#cloud_services"></a>19. Running on Cloud Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to turn on Cloud support for Infinispan library mode, one needs to add a new dependency to the classpath:</p>
</div>
<div class="listingblock">
<div class="title">Cloud support in library mode</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-cloud<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
<div class="paragraph">
<p>The above dependency adds <code>infinispan-core</code> to the classpath as well as some default configurations.</p>
</div>
<div class="sect2">
<h3 id="generic_discovery_protocols"><a class="anchor" href="#generic_discovery_protocols"></a>19.1. Generic Discovery protocols</h3>
<div class="paragraph">
<p>The main difference between running Infinispan in a private environment and a cloud provider is
that in the latter node discovery becomes a bit trickier because things like multicast don&#8217;t work.
To circumvent this you can use alternate JGroups PING protocols. Before delving into the cloud-specific,
lets look at some generic discovery protocols.</p>
</div>
<div class="sect3">
<h4 id="tcpping"><a class="anchor" href="#tcpping"></a>19.1.1. TCPPing</h4>
<div class="paragraph">
<p>The TCPPing approach contains a static list of the IP address of each member of the cluster in the JGroups configuration file.
While this works it doesn&#8217;t really help when cluster nodes are dynamically added to the cluster.</p>
</div>
<div class="listingblock">
<div class="title">Sample TCPPing configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
 <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;TCPPING</span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3000</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">initial_hosts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jgroups.tcpping.initial_hosts:localhost[7800],localhost[7801]}</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">port_range</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">num_initial_members</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
...
...
<span class="tag">&lt;/config&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="http://community.jboss.org/wiki/JGroupsTCPPING">JGroups TCPPING</a> for more information about TCPPing.</p>
</div>
</div>
<div class="sect3">
<h4 id="gossiprouter"><a class="anchor" href="#gossiprouter"></a>19.1.2. GossipRouter</h4>
<div class="paragraph">
<p>Another approach is to have a central server (Gossip, which each node will be configured to contact.
This central server will tell each node in the cluster about each other node.</p>
</div>
<div class="paragraph">
<p>The address (ip:port) that the Gossip router is listening on can be injected into the JGroups configuration used by Infinispan.
To do this pass the gossip routers address as a system property to the JVM e.g. <code>-DGossipRouterAddress="10.10.2.4[12001]"</code>
and reference this property in the JGroups configuration that Infinispan is using e.g.</p>
</div>
<div class="listingblock">
<div class="title">Sample TCPGOSSIP configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
 <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;TCPGOSSIP</span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial_hosts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${GossipRouterAddress}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">num_initial_members</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
...
...
<span class="tag">&lt;/config&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>More on Gossip Router @ <a href="http://community.jboss.org/docs/DOC-10890">http://www.jboss.org/community/wiki/JGroupsGossipRouter</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="amazon_web_services"><a class="anchor" href="#amazon_web_services"></a>19.2. Amazon Web Services</h3>
<div class="paragraph">
<p>When running on Amazon Web Service (AWS) platform and similar cloud based environment you can use the S3_PING protocol for discovery.</p>
</div>
</div>
<div class="sect2">
<h3 id="native_s3_ping"><a class="anchor" href="#native_s3_ping"></a>19.3. NATIVE_S3_PING</h3>
<div class="paragraph">
<p>You can configure your JGroups instances to use a shared storage to exchange the details of the cluster nodes.
NATIVE_S3_PING allows Amazon S3 to be used as the shared storage. Be sure that you have signed up for Amazon S3 as well as EC2 to use this method.</p>
</div>
<div class="listingblock">
<div class="title">Sample NATIVE_S3_PING configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
    <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;org.jgroups.aws.s3.NATIVE_S3_PING</span>
            <span class="attribute-name">region_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your region (e.g. eu-west-1)</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">bucket_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your bucket name</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">bucket_prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with a prefix to use for entries in the bucket (optional)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/config&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="jdbc_ping"><a class="anchor" href="#jdbc_ping"></a>19.3.1. JDBC_PING</h4>
<div class="paragraph">
<p>A similar approach to S3_PING, but using a JDBC connection to a shared database. On EC2 that is quite easy using Amazon RDS. See the <a href="http://community.jboss.org/wiki/JDBCPING">JDBC_PING Wiki page</a> for details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="microsoft_azure"><a class="anchor" href="#microsoft_azure"></a>19.4. Microsoft Azure</h3>
<div class="paragraph">
<p>Infinispan can be used on the Azure platform. Aside from using TCP_PING or GossipRouter, there is an Azure-specific
discovery protocol:</p>
</div>
<div class="sect3">
<h4 id="azure_ping"><a class="anchor" href="#azure_ping"></a>19.4.1. AZURE_PING</h4>
<div class="paragraph">
<p>AZURE_PING uses a shared Azure Blob Storage to store discovery information. Configuration is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;azure.AZURE_PING</span>
        <span class="attribute-name">storage_account_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your account name</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">storage_access_key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your access key</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your container name</span><span class="delimiter">&quot;</span></span>
<span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="google_compute_engine"><a class="anchor" href="#google_compute_engine"></a>19.5. Google Compute Engine</h3>
<div class="paragraph">
<p>Infinispan can be used on the Google Compute Engine (GCE) platform. Aside from using TCP_PING or GossipRouter, there is a GCE-specific
discovery protocol:</p>
</div>
<div class="sect3">
<h4 id="google_ping"><a class="anchor" href="#google_ping"></a>19.5.1. GOOGLE_PING</h4>
<div class="paragraph">
<p>GOOGLE_PING uses Google Cloud Storage (GCS) to store information about the cluster members.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">GOOGLE_PING</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">location</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>The name of the bucket<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">access_key</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>The access key<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secret_access_key</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>The secret access key<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/protocol&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cloud_services_k8s"><a class="anchor" href="#cloud_services_k8s"></a>19.6. Kubernetes</h3>
<div class="paragraph">
<p>Infinispan in Kubernetes environments, such as OKD or OpenShift, can use <a href="#cloud_services_kube_ping">Kube_PING</a> or [DNS_PING] for cluster discovery.</p>
</div>
<div class="sect3">
<h4 id="cloud_services_kube_ping"><a class="anchor" href="#cloud_services_kube_ping"></a>19.6.1. Kube_PING</h4>
<div class="paragraph">
<p>The JGroups <a href="http://www.jgroups.org/manual4/index.html#_kube_ping">Kube_PING</a> protocol uses the following configuration:</p>
</div>
<div class="listingblock">
<div class="title">Example KUBE_PING configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
 <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_addr</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${match-interface:eth.*}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;kubernetes.KUBE_PING</span> <span class="tag">/&gt;</span>
...
...
<span class="tag">&lt;/config&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The most important thing is to bind JGroups to <code>eth0</code> interface, which is <a href="https://docs.docker.com/engine/userguide/networking/dockernetworks/">used by Docker containers for network communication</a>.</p>
</div>
<div class="paragraph">
<p>KUBE_PING protocol is configured by environmental variables (which should be available inside a container). The most important thing is to set <code>KUBERNETES_NAMESPACE</code> to proper namespace. It might be either hardcoded or populated via <a href="https://github.com/kubernetes/kubernetes/tree/release-1.0/docs/user-guide/downward-api">Kubernetes' Downward API</a>.</p>
</div>
<div class="paragraph">
<p>Since KUBE_PING uses Kubernetes API for obtaining available Pods, OpenShift requires adding additional privileges. Assuming that <code>oc project -q</code> returns current namespace and <code>default</code> is the service account name, one needs to run:</p>
</div>
<div class="listingblock">
<div class="title">Adding additional OpenShift privileges</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">oc policy add-role-to-user view system:serviceaccount:$(oc project -q):default -n $(oc project -q)</code></pre>
</div>
</div>
<div class="paragraph">
<p>After performing all above steps, the clustering should be enabled and all Pods should automatically form a cluster within a single namespace.</p>
</div>
</div>
<div class="sect3">
<h4 id="cloud_services_dns_ping"><a class="anchor" href="#cloud_services_dns_ping"></a>19.6.2. DNS_PING</h4>
<div class="paragraph">
<p>The JGroups <a href="http://www.jgroups.org/manual4/index.html#_dns_ping">DNS_PING</a> protocol uses the following configuration:</p>
</div>
<div class="listingblock">
<div class="title">Example DNS_PING configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dns-ping</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
...
    <span class="tag">&lt;dns.DNS_PING</span>
      <span class="attribute-name">dns_query</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myservice.myproject.svc.cluster.local</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
...
<span class="tag">&lt;/stack&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>DNS_PING runs the specified query against the DNS server to get the list of cluster members.</p>
</div>
<div class="paragraph">
<p>For information about creating DNS entries for nodes in a cluster, see <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/">DNS for Services and Pods</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="using_kubernetes_and_openshift_rolling_updates"><a class="anchor" href="#using_kubernetes_and_openshift_rolling_updates"></a>19.6.3. Using Kubernetes and OpenShift Rolling Updates</h4>
<div class="paragraph">
<p>Since Pods in Kubernetes and OpenShift are immutable, the only way to alter the configuration is to roll out a new deployment. There are several
different strategies to do that but we suggest using <a href="https://docs.openshift.org/latest/dev_guide/deployments/deployment_strategies.html#when-to-use-a-rolling-deployment">Rolling Updates</a>.</p>
</div>
<div class="paragraph">
<p>An example Deployment Configuration (Kubernetes uses very similar concept called <code>Deployment</code>) looks like the following:</p>
</div>
<div class="listingblock">
<div class="title">DeploymentConfiguration for Rolling Updates</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">apiVersion: v1</span></span>
  <span class="key">kind</span>: <span class="string"><span class="content">DeploymentConfig</span></span>
  <span class="key">metadata</span>:
    <span class="key">name</span>: <span class="string"><span class="content">infinispan-cluster</span></span>
  <span class="key">spec</span>:
    <span class="key">replicas</span>: <span class="string"><span class="content">3</span></span>
    <span class="key">strategy</span>:
      <span class="key">type</span>: <span class="string"><span class="content">Rolling</span></span>
      <span class="key">rollingParams</span>:
        <span class="key">updatePeriodSeconds</span>: <span class="string"><span class="content">10</span></span>
        <span class="key">intervalSeconds</span>: <span class="string"><span class="content">20</span></span>
        <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">600</span></span>
        <span class="key">maxUnavailable</span>: <span class="string"><span class="content">1</span></span>
        <span class="key">maxSurge</span>: <span class="string"><span class="content">1</span></span>
    <span class="key">template</span>:
      <span class="key">spec</span>:
        <span class="key">containers</span>:
        - <span class="string"><span class="content">args:</span></span>
          - <span class="string"><span class="content">-Djboss.default.jgroups.stack=kubernetes</span></span>
          <span class="key">image</span>: <span class="string"><span class="content">jboss/infinispan-server:latest</span></span>
          <span class="key">name</span>: <span class="string"><span class="content">infinispan-server</span></span>
          <span class="key">ports</span>:
          - <span class="string"><span class="content">containerPort: 8181</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 9990</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 11211</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 11222</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 57600</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 7600</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 8080</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          <span class="key">env</span>:
          - <span class="string"><span class="content">name: KUBERNETES_NAMESPACE</span></span>
            <span class="key">valueFrom</span>: <span class="string"><span class="content">{fieldRef: {apiVersion: v1, fieldPath: metadata.namespace}}</span></span>
          <span class="key">terminationMessagePath</span>: <span class="string"><span class="content">/dev/termination-log</span></span>
          <span class="key">terminationGracePeriodSeconds</span>: <span class="string"><span class="content">90</span></span>
          <span class="key">livenessProbe</span>:
            <span class="key">exec</span>:
              <span class="key">command</span>:
              - <span class="string"><span class="content">/usr/local/bin/is_running.sh</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">10</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">80</span></span>
            <span class="key">periodSeconds</span>: <span class="string"><span class="content">60</span></span>
            <span class="key">successThreshold</span>: <span class="string"><span class="content">1</span></span>
            <span class="key">failureThreshold</span>: <span class="string"><span class="content">5</span></span>
          <span class="key">readinessProbe</span>:
             <span class="key">exec</span>:
                <span class="key">command</span>:
                - <span class="string"><span class="content">/usr/local/bin/is_healthy.sh</span></span>
             <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">10</span></span>
             <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">40</span></span>
             <span class="key">periodSeconds</span>: <span class="string"><span class="content">30</span></span>
             <span class="key">successThreshold</span>: <span class="string"><span class="content">2</span></span>
             <span class="key">failureThreshold</span>: <span class="string"><span class="content">5</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also highly recommended to adjust the JGroups stack to discover new nodes (or leaves) more quickly. One should at least
adjust the value of <code>FD_ALL</code> timeout and adjust it to the longest GC Pause.</p>
</div>
<div class="ulist">
<div class="title">Other hints for tuning configuration parameters are:</div>
<ul>
<li>
<p>OpenShift should replace running nodes one by one. This can be achieved by adjusting <code>rollingParams</code> (<code>maxUnavailable: 1</code> and <code>maxSurge: 1</code>).</p>
</li>
<li>
<p>Depending on the cluster size, one needs to adjust <code>updatePeriodSeconds</code> and <code>intervalSeconds</code>. The bigger cluster size is, the bigger those values should be used.</p>
</li>
<li>
<p>When using Initial State Transfer, the <code>initialDelaySeconds</code> value for both probes should be set to higher value.</p>
</li>
<li>
<p>During Initial State Transfer nodes might not respond to probes. The best results are achieved with higher values of <code>failureThreshold</code> and <code>successThreshold</code> values.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="rolling_upgrades_with_kubernetes_and_openshift"><a class="anchor" href="#rolling_upgrades_with_kubernetes_and_openshift"></a>19.6.4. Rolling upgrades with Kubernetes and OpenShift</h4>
<div class="paragraph">
<p>Even though Rolling Upgrades and Rolling Update may sound similarly, they mean different things. The <a href="https://docs.openshift.org/latest/dev_guide/deployments/deployment_strategies.html#rolling-strategy">Rolling Update</a>
is a process of replacing old Pods with new ones. In other words it is a process of rolling out new version of an application. A typical example is a configuration change. Since Pods are immutable, Kubernetes/OpenShift needs to replace them one by one
in order to use the updated configuration bits. On the other hand the <a href="#rolling_upgrades">Rolling Upgrade</a> is a process of migrating data from one Infinispan cluster to another one.
A typical example is migrating from one version to another.</p>
</div>
<div class="paragraph">
<p>For both Kubernetes and OpenShift, the Rolling Upgrade procedure is almost the same. It is based on a standard <a href="#rolling_upgrades">Rolling Upgrade procedure</a> with small changes.</p>
</div>
<div class="ulist">
<div class="title">Key differences when upgrading using OpenShift/Kubernetes are:</div>
<ul>
<li>
<p>Depending on configuration, it is a good practice to use <a href="https://docs.openshift.org/latest/architecture/core_concepts/routes.html">OpenShift Routes</a> or <a href="http://kubernetes.io/docs/user-guide/ingress">Kubernetes Ingress API</a> to expose services to the clients. During the upgrade the Route (or Ingress) used by the clients can be altered to point to the new cluster.</p>
</li>
<li>
<p>Invoking CLI commands can be done by using Kubernetes (<code>kubectl exec</code>) or OpenShift clients (<code>oc exec</code>). Here is an example: <code>oc exec &lt;POD_NAME&gt;&#8201;&#8212;&#8201;'/opt/jboss/infinispan-server/bin/ispn-cli.sh' '-c' '--controller=$(hostname -i):9990' '/subsystem=datagrid-infinispan/cache-container=clustered/distributed-cache=default:disconnect-source(migrator-name=hotrod)'</code></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Key differences when upgrading using the library mode:</div>
<ul>
<li>
<p>Client application needs to expose JMX. It usually depends on application and environment type but the easiest way to do it is to add the following switches into the Java boostrap script <code>-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=&lt;PORT&gt;</code>.</p>
</li>
<li>
<p>Connecting to the JMX can be done by forwarding ports. With OpenShift this might be achieved by using <code>oc port-forward</code> command whereas in Kubernetes by <code>kubectl port-forward</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The last step in the Rolling Upgrade (removing a Remote Cache Store) needs to be performed differently. We need to use <a href="http://kubernetes.io/docs/user-guide/rolling-updates/">Kubernetes/OpenShift Rolling update</a> command and replace Pods configuration with the one which does not contain Remote Cache Store.</p>
</div>
<div class="paragraph">
<p>A detailed instruction might be found in <a href="https://issues.jboss.org/browse/ISPN-6673">ISPN-6673</a> ticket.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="client_server"><a class="anchor" href="#client_server"></a>20. Client/Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan offers two alternative access methods: embedded mode and client-server mode.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In Embedded mode the Infinispan libraries co-exist with the user application in the same JVM as shown in the following diagram</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/server_modules_1.png" alt="server modules 1">
</div>
<div class="title">Figure 11. Peer-to-peer access</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Client-server mode is when applications access the data stored in a remote Infinispan server using some kind of network protocol</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="why_clientserver"><a class="anchor" href="#why_clientserver"></a>20.1. Why Client/Server?</h3>
<div class="paragraph">
<p>There are situations when accessing Infinispan in a client-server mode might make more sense than embedding it within your application, for example, when trying to access Infinispan from a non-JVM environment.
Since Infinispan is written in Java, if someone had a C\\ application that wanted to access it, it couldn&#8217;t just do it in a p2p way.
On the other hand, client-server would be perfectly suited here assuming that a language neutral protocol was used and the corresponding client and server implementations were available.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/server_modules_2.png" alt="server modules 2">
</div>
<div class="title">Figure 12. Non-JVM access</div>
</div>
<div class="paragraph">
<p>In other situations, Infinispan users want to have an elastic application tier where you start/stop business processing servers very regularly. Now, if users deployed Infinispan configured with distribution or state transfer, startup time could be greatly influenced by the shuffling around of data that happens in these situations. So in the following diagram, assuming Infinispan was deployed in p2p mode, the app in the second server could not access Infinispan until state transfer had completed.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/server_modules_3.png" alt="server modules 3">
</div>
<div class="title">Figure 13. Elasticity issue with P2P</div>
</div>
<div class="paragraph">
<p>This effectively means that bringing up new application-tier servers is impacted by things like state transfer because applications cannot access Infinispan until these processes have finished and if the state being shifted around is large, this could take some time. This is undesirable in an elastic environment where you want quick application-tier server turnaround and predictable startup times. Problems like this can be solved by accessing Infinispan in a client-server mode because starting a new application-tier server is just a matter of starting a lightweight client that can connect to the backing data grid server. No need for rehashing or state transfer to occur and as a result server startup times can be more predictable which is very important for modern cloud-based deployments where elasticity in your application tier is important.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/AchievingElasticity.png" alt="AchievingElasticity">
</div>
<div class="title">Figure 14. Achieving elasticity</div>
</div>
<div class="paragraph">
<p>Other times, it&#8217;s common to find multiple applications needing access to data storage. In this cases, you could in theory deploy an Infinispan instance per each of those applications but this could be wasteful and difficult to maintain. Think about databases here, you don&#8217;t deploy a database alongside each of your applications, do you? So, alternatively you could deploy Infinispan in client-server mode keeping a pool of Infinispan data grid nodes acting as a shared storage tier for your applications.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/server_modules_4.png" alt="server modules 4">
</div>
<div class="title">Figure 15. Shared data storage</div>
</div>
<div class="paragraph">
<p>Deploying Infinispan in this way also allows you to manage each tier independently, for example, you can upgrade you application or app server without bringing down your Infinispan data grid nodes.</p>
</div>
</div>
<div class="sect2">
<h3 id="why_use_embedded_mode"><a class="anchor" href="#why_use_embedded_mode"></a>20.2. Why use embedded mode?</h3>
<div class="paragraph">
<p>Before talking about individual Infinispan server modules, it&#8217;s worth mentioning that in spite of all the benefits, client-server Infinispan still has disadvantages over p2p. Firstly, p2p deployments are simpler than client-server ones because in p2p, all peers are equals to each other and hence this simplifies deployment. So, if this is the first time you&#8217;re using Infinispan, p2p is likely to be easier for you to get going compared to client-server.</p>
</div>
<div class="paragraph">
<p>Client-server Infinispan requests are likely to take longer compared to p2p requests, due to the serialization and network cost in remote calls. So, this is an important factor to take in account when designing your application. For example, with replicated Infinispan caches, it might be more performant to have lightweight HTTP clients connecting to a server side application that accesses Infinispan in p2p mode, rather than having more heavyweight client side apps talking to Infinispan in client-server mode, particularly if data size handled is rather large. With distributed caches, the difference might not be so big because even in p2p deployments, you&#8217;re not guaranteed to have all data available locally.</p>
</div>
<div class="paragraph">
<p>Environments where application tier elasticity is not so important, or where server side applications access state-transfer-disabled, replicated Infinispan cache instances are amongst scenarios where Infinispan p2p deployments can be more suited than client-server ones.</p>
</div>
</div>
<div class="sect2">
<h3 id="server_modules"><a class="anchor" href="#server_modules"></a>20.3. Server Modules</h3>
<div class="paragraph">
<p>So, now that it&#8217;s clear when it makes sense to deploy Infinispan in client-server mode, what are available solutions? All Infinispan server modules are based on the same pattern where the server backend creates an embedded Infinispan instance and if you start multiple backends, they can form a cluster and share/distribute state if configured to do so. The server types below primarily differ in the type of listener endpoint used to handle incoming connections.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a brief summary of the available server endpoints.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Hot Rod Server Module</strong> - This module is an implementation of the <a href="#hot_rod_protocol">Hot Rod binary protocol</a> backed by Infinispan which allows clients to do dynamic load balancing and failover and smart routing.</p>
<div class="ulist">
<ul>
<li>
<p>A <a href="http://www.infinispan.org/hotrod-clients">variety of clients</a> exist for this protocol.</p>
</li>
<li>
<p>If you&#8217;re clients are running Java, this should be your defacto server module choice because it allows for dynamic load balancing and failover. This means that Hot Rod clients can dynamically detect changes in the topology of Hot Rod servers as long as these are clustered, so when new nodes join or leave, clients update their Hot Rod server topology view. On top of that, when Hot Rod servers are configured with distribution, clients can detect where a particular key resides and so they can route requests smartly.</p>
</li>
<li>
<p>Load balancing and failover is dynamically provided by Hot Rod client implementations using information provided by the server.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>REST Server Module</strong> - The REST server, which is distributed as a WAR file, can be deployed in any servlet container to allow Infinispan to be accessed via a RESTful HTTP interface.</p>
<div class="ulist">
<ul>
<li>
<p>To connect to it, you can use any HTTP client out there and there&#8217;re tons of different client implementations available out there for pretty much any language or system.</p>
</li>
<li>
<p>This module is particularly recommended for those environments where HTTP port is the only access method allowed between clients and servers.</p>
</li>
<li>
<p>Clients wanting to load balance or failover between different Infinispan REST servers can do so using any standard HTTP load balancer such as <a href="http://www.jboss.org/mod_cluster">mod_cluster</a> . It&#8217;s worth noting though these load balancers maintain a static view of the servers in the backend and if a new one was to be added, it would require manual update of the load balancer.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Memcached Server Module</strong> - This module is an implementation of the <a href="http://github.com/memcached/memcached/blob/master/doc/protocol.txt">Memcached text protocol</a> backed by Infinispan.</p>
<div class="ulist">
<ul>
<li>
<p>To connect to it, you can use any of the <a href="http://code.google.com/p/memcached/wiki/Clients">existing Memcached clients</a> which are pretty diverse.</p>
</li>
<li>
<p>As opposed to Memcached servers, Infinispan based Memcached servers can actually be clustered and hence they can replicate or distribute data using consistent hash algorithms around the cluster. So, this module is particularly of interest to those users that want to provide failover capabilities to the data stored in Memcached servers.</p>
</li>
<li>
<p>In terms of load balancing and failover, there&#8217;re a few clients that can load balance or failover given a static list of server addresses (perl&#8217;s Cache::Memcached for example) but any server addition or removal would require manual intervention.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="which_protocol_should_i_use"><a class="anchor" href="#which_protocol_should_i_use"></a>20.4. Which protocol should I use?</h3>
<div class="paragraph">
<p>Choosing the right protocol depends on a number of factors.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-center valign-top">Hot Rod</th>
<th class="tableblock halign-center valign-top">HTTP / REST</th>
<th class="tableblock halign-center valign-top">Memcached</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology-aware</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash-aware</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encryption</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentication</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditional ops</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bulk ops</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transactions</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listeners</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Query</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execution</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cross-site failover</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="hot_rod_server_usage"><a class="anchor" href="#hot_rod_server_usage"></a>20.5. Using Hot Rod Server</h3>
<div class="paragraph">
<p>The Infinispan Server distribution contains a server module that implements Infinispan&#8217;s custom binary protocol called Hot Rod. The protocol was designed to enable faster client/server interactions compared to other existing text based protocols and to allow clients to make more intelligent decisions with regards to load balancing, failover and even data location operations.
Please refer to Infinispan Server&#8217;s <a href="../server_guide/server_guide.html">documentation</a> for instructions on how to configure and run a HotRod server.</p>
</div>
<div class="paragraph">
<p>To connect to Infinispan over this highly efficient Hot Rod protocol you can
either use one of the clients described in this chapter, or use higher level
tools such as <a href="#integrations_hibernate_ogm">Hibernate OGM</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="hot_rod_protocol"><a class="anchor" href="#hot_rod_protocol"></a>20.6. Hot Rod Protocol</h3>
<div class="paragraph">
<p>The following articles provides detailed information about each version of
the custom TCP client/server Hot Rod protocol.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#hot_rod_protocol_1_0">Hot Rod Protocol 1.0</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_1_1">Hot Rod Protocol 1.1</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_1_2">Hot Rod Protocol 1.2</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_1_3">Hot Rod Protocol 1.3</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_2_0">Hot Rod Protocol 2.0</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_2_1">Hot Rod Protocol 2.1</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_2_2">Hot Rod Protocol 2.2</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_2_3">Hot Rod Protocol 2.3</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_2_4">Hot Rod Protocol 2.4</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_2_5">Hot Rod Protocol 2.5</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_2_6">Hot Rod Protocol 2.6</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_2_7">Hot Rod Protocol 2.7</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_2_8">Hot Rod Protocol 2.8</a></p>
</li>
<li>
<p><a href="#hot_rod_protocol_2_9">Hot Rod Protocol 2.9</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_1_0"><a class="anchor" href="#hot_rod_protocol_1_0"></a>20.6.1. Hot Rod Protocol 1.0</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 4.1.0.Final
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
All key and values are sent and stored as byte arrays. Hot Rod
makes no assumptions about their types.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Some clarifications about the other types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>vInt : Variable-length integers are defined defined as compressed,
positive integers  where the high-order bit of each byte indicates whether
more bytes need to be  read. The low-order seven bits are appended as
increasingly more significant bits in the resulting integer value making it
efficient to decode. Hence, values from zero to 127 are  stored in a single
byte, values from 128 to 16,383 are stored in two bytes, and so on:</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><code>Value</code></th>
<th class="tableblock halign-left valign-top"><code>First byte</code></th>
<th class="tableblock halign-left valign-top"><code>Second byte</code></th>
<th class="tableblock halign-left valign-top"><code>Third byte</code></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000000</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000001</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000010</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>127</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>01111111</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>128</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000000</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000001</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>129</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000001</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000001</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>130</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000010</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000001</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>16,383</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>11111111</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>01111111</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>16,384</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000000</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000000</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000001</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>16,385</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000001</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10000000</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>00000001</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&#8230;&#8203;</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>signed vInt: The vInt above is also able to encode negative values, but will
always use the maximum size (5 bytes) no matter how small the endoded value is.
In order to have a small payload for negative values too, signed vInts uses ZigZag
encoding on top of the vInt encoding.
More details <a href="http://developers.google.com/protocol-buffers/docs/encoding#types">here</a></p>
</li>
<li>
<p>vLong : Refers to unsigned variable length long values similar to vInt but
applied to longer values. They&#8217;re between 1 and 9 bytes long.</p>
</li>
<li>
<p>String : Strings are always represented using UTF-8 encoding.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="request_header"><a class="anchor" href="#request_header"></a>Request Header</h5>
<div class="paragraph">
<p>The header for a request is composed of:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Request header</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Magic</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xA0 = request</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID of the message that will be copied
back in the response. This allows for Hot Rod clients to implement the
protocol in an asynchronous way.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hot Rod server version.
In this particular case, this is 10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Opcode</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request operation code:<br>
0x01 = put (since 1.0)<br>
0x03 = get (since 1.0)<br>
0x05 = putIfAbsent (since 1.0)<br>
0x07 = replace (since 1.0)<br>
0x09 = replaceIfUnmodified (since 1.0)<br>
0x0B = remove (since 1.0)<br>
0x0D = removeIfUnmodified (since 1.0)<br>
0x0F = containsKey (since 1.0)<br>
0x11 = getWithVersion (since 1.0)<br>
0x13 = clear (since 1.0)<br>
0x15 = stats (since 1.0)<br>
0x17 = ping (since 1.0)<br>
0x19 = bulkGet (since 1.2)<br>
0x1B = getWithMetadata (since 1.2)<br>
0x1D = bulkGetKeys (since 1.2)<br>
0x1F = query (since 1.3)<br>
0x21 = authMechList (since 2.0)<br>
0x23 = auth (since 2.0)<br>
0x25 = addClientListener (since 2.0)<br>
0x27 = removeClientListener (since 2.0)<br>
0x29 = size (since 2.0)<br>
0x2B = exec (since 2.1)<br>
0x2D = putAll (since 2.1)<br>
0x2F = getAll (since 2.1)<br>
0x31 = iterationStart (since 2.3)<br>
0x33 = iterationNext (since 2.3)<br>
0x35 = iterationEnd (since 2.3)<br>
0x37 = getStream (since 2.6)<br>
0x39 = putStream (since 2.6)<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cache Name Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of cache name. If the passed
length is 0 (followed by no cache name), the operation will interact with
the default cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cache Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of cache on which to operate.
This name must match the name of predefined cache in the Infinispan
configuration file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flags</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A variable length number representing
flags passed to the system. Each flags is represented by a bit. Note that
since this field is sent as variable length, the most significant bit in a
byte is used to determine whether more bytes need to be read, hence this bit
does not represent any flag. Using this model allows for flags to be combined
in a short space. Here are the current values for each flag:<br>
0x0001 = force return previous value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client Intelligence</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This byte hints the server on the client capabilities:<br>
0x01 = basic client, interested in neither cluster nor hash information<br>
0x02 = topology-aware client, interested in cluster information<br>
0x03 = hash-distribution-aware client, that is interested in both cluster and hash information<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology Id</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This field represents the last known
view in the client. Basic clients will only send 0 in this field.
When topology-aware or hash-distribution-aware clients will send 0 until they
have received a reply from the server with the current view id.
Afterwards, they should send that view id until they receive a new view id
in a response.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Type</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is a 1 byte field, containing one
of the following well-known supported transaction types (For this version of
the protocol, the only supported transaction type is 0):<br>
0 = Non-transactional call, or client does not support transactions.
The subsequent TX_ID field will be omitted.<br>
1 = X/Open XA transaction ID (XID). This is a well-known, fixed-size format.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Id</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The byte array uniquely identifying the
transaction associated to this call. Its length is determined by the
transaction type. If transaction type is 0, no transaction id will be present.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="hot_rod_response_header"><a class="anchor" href="#hot_rod_response_header"></a>Response Header</h5>
<div class="paragraph">
<p>The header for a response is composed of:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Response header</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Magic</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xA1 = response</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID of the message, matching the request
for which the response is sent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Opcode</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response operation code:<br>
0x02 = put (since 1.0)<br>
0x04 = get (since 1.0)<br>
0x06 = putIfAbsent (since 1.0)<br>
0x08 = replace (since 1.0)<br>
0x0A = replaceIfUnmodified (since 1.0)<br>
0x0C = remove (since 1.0)<br>
0x0E = removeIfUnmodified (since 1.0)<br>
0x10 = containsKey (since 1.0)<br>
0x12 = getWithVersion (since 1.0)<br>
0x14 = clear (since 1.0)<br>
0x16 = stats (since 1.0)<br>
0x18 = ping (since 1.0)<br>
0x1A = bulkGet (since 1.0)<br>
0x1C = getWithMetadata (since 1.2)<br>
0x1E = bulkGetKeys (since 1.2)<br>
0x20 = query (since 1.3)<br>
0x22 = authMechList (since 2.0)<br>
0x24 = auth (since 2.0)<br>
0x26 = addClientListener (since 2.0)<br>
0x28 = removeClientListener (since 2.0)<br>
0x2A = size (since 2.0)<br>
0x2C = exec (since 2.1)<br>
0x2E = putAll (since 2.1)<br>
0x30 = getAll (since 2.1)<br>
0x32 = iterationStart (since 2.3)<br>
0x34 = iterationNext (since 2.3)<br>
0x36 = iterationEnd (since 2.3)<br>
0x38 = getStream (since 2.6)<br>
0x3A = putStream (since 2.6)<br>
0x50 = error (since 1.0)<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Status of the response, possible values:<br>
0x00 = No error<br>
0x01 = Not put/removed/replaced<br>
0x02 = Key does not exist<br>
0x81 = Invalid magic or message id<br>
0x82 = Unknown command<br>
0x83 = Unknown version<br>
0x84 = Request parsing error<br>
0x85 = Server Error<br>
0x86 = Command timed out<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology Change Marker</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is a marker byte that indicates
whether the response is prepended with topology change information.
When no topology change follows, the content of this byte is 0.
If a topology change follows, its contents are 1.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Exceptional error status responses, those that start with 0x8 &#8230;&#8203;,
are followed by the length of the error message (as a vInt ) and
error message itself as String.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="topology_change_headers"><a class="anchor" href="#topology_change_headers"></a>Topology Change Headers</h5>
<div class="paragraph">
<p>The following section discusses how the response headers look for
topology-aware or hash-distribution-aware clients when there&#8217;s been a cluster
or view formation change. Note that it&#8217;s the server that makes the decision on
whether it sends back the new topology based on the current topology id and
the one the client sent. If they&#8217;re different, it will send back the new topology.</p>
</div>
</div>
<div class="sect4">
<h5 id="topology_aware_client_topology_change_header"><a class="anchor" href="#topology_aware_client_topology_change_header"></a>Topology-Aware Client Topology Change Header</h5>
<div class="paragraph">
<p>This is what topology-aware clients receive as response header when a
topology change is sent back:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header with topology change marker</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See previous section.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology Id</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Num servers in topology</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of Hot Rod servers running within the cluster.
This could be a subset of the entire cluster if only a fraction of those
nodes are running Hot Rod servers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of hostname or IP address of individual cluster member that Hot Rod
client can use to access it. Using variable length here allows for covering
for hostnames, IPv4 and IPv6 addresses.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP address</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String containing hostname or IP address of individual cluster member
that Hot Rod client can use to access it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Port</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port that Hot Rod clients can use to communicate with this cluster member.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP address</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Port</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;etc</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="distribution_aware_client_topology_change_header"><a class="anchor" href="#distribution_aware_client_topology_change_header"></a>Distribution-Aware Client Topology Change Header</h5>
<div class="paragraph">
<p>This is what hash-distribution-aware clients receive as response header
when a topology change is sent back:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header with topology change marker</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See previous section.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology Id</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Num Key Owners</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Globally configured number of copies for each Infinispan distributed key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash Function Version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash function version, pointing to a specific hash function in use.
See <a href="#hot_rod_hash_functions">Hot Rod hash functions</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash space size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modulus used by Infinispan for for all module arithmetic related to hash
code generation. Clients will likely require this information in order to
apply the correct hash calculation to the keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Num servers in topology</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of Infinispan Hot Rod servers running within the cluster.
This could be a subset of the entire cluster if only a fraction of those
nodes are running Hot Rod servers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of hostname or IP address of individual cluster member that Hot Rod
client can use to access it. Using variable length here allows for covering
for hostnames, IPv4 and IPv6 addresses.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP address</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String containing hostname or IP address of individual cluster member
that Hot Rod client can use to access it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Port</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port that Hot Rod clients can use to communicat with this cluster member.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Hashcode</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">4 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32 bit integer representing the hashcode of a cluster member that a Hot Rod
client can use indentify in which cluster member a key is located having
applied the CSA to it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP address</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Port</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Hashcode</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">4 bytes</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;etc</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It&#8217;s important to note that since hash headers rely on the consistent hash
algorithm used by the server and this is a factor of the cache interacted with,
hash-distribution-aware headers can only be returned to operations that target
a particular cache. Currently ping command does not target any cache
(this is to change as per <a href="https://jira.jboss.org/jira/browse/ISPN-424">ISPN-424</a>)
, hence calls to ping command with hash-topology-aware client settings will
return a hash-distribution-aware header with "Num Key Owners",
"Hash Function Version", "Hash space size" and each individual host&#8217;s hash
code all set to 0. This type of header will also be returned as response to
operations with hash-topology-aware client settings that are targeting caches
that are not configured with distribution.</p>
</div>
</div>
<div class="sect4">
<h5 id="operations"><a class="anchor" href="#operations"></a>Operations</h5>
<div class="paragraph">
<div class="title">Get (0x03)/Remove (0x0B)/ContainsKey (0x0F)/GetWithVersion (0x11)</div>
<p>Common request format:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key. Note that the size of a
vint can be up to 5 bytes which in theory can produce bigger numbers than
Integer.MAX_VALUE. However, Java cannot create a single array thats bigger
than Integer.MAX_VALUE, hence the protocol is limiting vint array lengths to
Integer.MAX_VALUE.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key whose value is being requested.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Get response (0x04):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if key retrieved<br>
0x02 = if key does not exist<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If success, length of value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If success, the requested value</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Remove response (0x0C):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if key removed<br>
0x02 = if key does not exist<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Previous value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was
sent in the request and the key was removed, the length of the previous value
will be returned. If the key does not exist, value length would be 0.
If no flag was sent, no value length would be present.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Previous value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was
sent in the request and the key was removed, previous value.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>ContainsKey response (0x10):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if key exists<br>
0x02 = if key does not exist<br></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>GetWithVersion response (0x12):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if key retrieved<br>
0x02 = if key does not exist<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique value of an existing entry&#8217;s modification.
The protocol does not mandate that entry_version values are sequential.
They just need to be unique per update at the key level.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If success, length of value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If success, the requested value</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">BulkGet</div>
<p>Request (0x19):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of Infinispan entries to
be returned by the server (entry == key + associated value).
Needed to support CacheLoader.load(int). If 0 then all entries are returned
(needed for CacheLoader.loadAll()).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x20):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, data follows<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">More</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One byte representing whether more
entries need to be read from the stream. So, when it&#8217;s set to 1, it means
that an entry follows, whereas when it&#8217;s set to 0, it&#8217;s the end of stream and
no more entries are left to read. For more information on BulkGet look
<a href="http://community.jboss.org/docs/DOC-15592">here</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">More</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 2 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; etc</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Put (0x01)/PutIfAbsent (0x05)/Replace (0x07)</div>
<p>Common request format:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key. Note that the size of a
vint can be up to 5 bytes which in theory can produce bigger numbers than
Integer.MAX_VALUE. However, Java cannot create a single array thats bigger
than Integer.MAX_VALUE, hence the protocol is limiting vint array lengths to
Integer.MAX_VALUE.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key whose value is being requested.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that a entry during
which the entry is allowed to life. If number of seconds is bigger than 30 days,
this number of seconds is treated as UNIX time and so, represents the number
of seconds since 1/1/1970. If set to 0, lifespan is unlimited.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max Idle</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that a entry can be
idle before it&#8217;s evicted from the cache. If 0, no max idle time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte-array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value to be stored</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Put response (0x02):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if stored<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Previous value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was
sent in the request and the key was put, the length of the previous value
will be returned. If the key does not exist, value length would be 0.
If no flag was sent, no value length would be present.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Previous value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was
sent in the request and the key was put, previous value.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Replace response (0x08):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if stored<br>
0x01 = if store did not happen because key does not exist<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Previous value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was
sent in the request, the length of the previous value will be returned.
If the key does not exist, value length would be 0.
If no flag was sent, no value length would be present.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Previous value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was
sent in the request and the key was replaced, previous value.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>PutIfAbsent response (0x06):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if stored<br>
0x01 = if store did not happen because key was present<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Previous value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was
sent in the request, the length of the previous value will be returned.
If the key does not exist, value length would be 0.
If no flag was sent, no value length would be present.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Previous value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was
sent in the request and the key was replaced, previous value.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">ReplaceIfUnmodified</div>
<p>Request (0x09):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key. Note that the size of a
vint can be up to 5 bytes which in theory can produce bigger numbers than
Integer.MAX_VALUE. However, Java cannot create a single array thats bigger
than Integer.MAX_VALUE, hence the protocol is limiting vint array lengths to
Integer.MAX_VALUE.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key whose value is being requested.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that a entry during
which the entry is allowed to life. If number of seconds is bigger than 30 days,
this number of seconds is treated as UNIX time and so, represents the number
of seconds since 1/1/1970. If set to 0, lifespan is unlimited.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max Idle</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that a entry can be
idle before it&#8217;s evicted from the cache. If 0, no max idle time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the value returned by GetWithVersion operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte-array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value to be stored</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x0A):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if replaced<br>
0x01 = if replace did not happen because key had been modified<br>
0x02 = if not replaced because if key does not exist</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Previous value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was
sent in the request, the length of the previous value will be returned.
If the key does not exist, value length would be 0.
If no flag was sent, no value length would be present.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Previous value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was
sent in the request and the key was replaced, previous value.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">RemoveIfUnmodified</div>
<p>Request (0x0D):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key. Note that the size of a
vint can be up to 5 bytes which in theory can produce bigger numbers than
Integer.MAX_VALUE. However, Java cannot create a single array thats bigger
than Integer.MAX_VALUE, hence the protocol is limiting vint array lengths to
Integer.MAX_VALUE.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key whose value is being requested.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the value returned by GetWithMetadata operation.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x0E):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if removed<br>
0x01 = if remove did not happen because key had been modified<br>
0x02 = if not removed because key does not exist<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Previous value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was
sent in the request, the length of the previous value will be returned.
If the key does not exist, value length would be 0.
If no flag was sent, no value length would be present.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Previous value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If force return previous value flag was
sent in the request and the key was removed, previous value.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Clear</div>
<p>Request (0x13):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x14):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if cleared<br></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">PutAll</div>
<p>Bulk operation to put all key value entries into the cache at the same time.</p>
</div>
<div class="paragraph">
<p>Request (0x2D):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that provided entries
are allowed to live. If number of seconds is bigger than 30 days,
this number of seconds is treated as UNIX time and so, represents the number
of seconds since 1/1/1970. If set to 0, lifespan is unlimited.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max Idle</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds that each entry can be
idle before it&#8217;s evicted from the cache. If 0, no max idle time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">How many entries are being inserted</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 2 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; continues until entry count is reached</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x2E):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if all put<br></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">GetAll</div>
<p>Bulk operation to get all entries that map to a given set of keys.</p>
</div>
<div class="paragraph">
<p>Request (0x2F):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">How many keys to find entries for</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; continues until key count is reached</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x30):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">How many entries are being returned</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 2 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; continues until entry count is reached</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if the get returned sucessfully<br></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Stats</div>
<p>Returns a summary of all available statistics. For each statistic returned,
a name and a value is returned both in String UTF-8 format.
The supported stats are the following:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timeSinceStart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds since Hot Rod started.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">currentNumberOfEntries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of entries currently in the Hot Rod server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">totalNumberOfEntries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of entries stored in Hot Rod server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">stores</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of put operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retrievals</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of get operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of get hits.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">misses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of get misses.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">removeHits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of removal hits.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">removeMisses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of removal misses.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Request (0x15):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x16):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if stats retrieved<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of stats</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of individual stats returned.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name 1 length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of named statistic.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String containing statistic name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 1 length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of value field.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String containing statistic value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name 2 length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 2 length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;etc</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Ping</div>
<p>Application level request to see if the server is available.</p>
</div>
<div class="paragraph">
<p>Request (0x17):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x18):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if no errors<br></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Error Handling</div>
<p>Error response (0x50)</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x8x = error response code<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error Message Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of error message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error Message</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error message. In the case of 0x84 ,
this error field contains the latest version supported by the Hot Rod server.
Length is defined by total body length.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Multi-Get Operations</div>
<p>A multi-get operation is a form of get operation that instead of requesting a
single key, requests a set of keys. The Hot Rod protocol does not include such
operation but remote Hot Rod clients could easily implement this type of
operations by either parallelizing/pipelining individual get requests.
Another possibility would be for remote clients to use async or non-blocking
get requests. For example, if a client wants N keys, it could send send N
async get requests and then wait for all the replies. Finally, multi-get is
not to be confused with bulk-get operations. In bulk-gets, either all or a
number of keys are retrieved, but the client does not know which keys to
retrieve, whereas in multi-get, the client defines which keys to retrieve.</p>
</div>
</div>
<div class="sect4">
<h5 id="example_put_request"><a class="anchor" href="#example_put_request"></a>Example - Put request</h5>
<div class="ulist">
<ul>
<li>
<p>Coded request</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1112%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Byte</th>
<th class="tableblock halign-left valign-top">0</th>
<th class="tableblock halign-left valign-top">1</th>
<th class="tableblock halign-left valign-top">2</th>
<th class="tableblock halign-left valign-top">3</th>
<th class="tableblock halign-left valign-top">4</th>
<th class="tableblock halign-left valign-top">5</th>
<th class="tableblock halign-left valign-top">6</th>
<th class="tableblock halign-left valign-top">7</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xA0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x09</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x41</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x07</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x4D ('M')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x79 ('y')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x43 ('C')</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x61 ('a')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x63 ('c')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x68 ('h')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x65 ('e')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x05</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x48 ('H')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x65 ('e')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x6C ('l')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x6C ('l')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x6F ('o')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x05</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x57 ('W')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x6F ('o')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x72 ('r')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x6C ('l')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x64 ('d')</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Field explanation</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Magic (0)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xA0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Id (1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x09</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version (2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x41</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Opcode (3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x01</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cache name length (4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x07</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cache name(5-11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'MyCache'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flag (12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client Intelligence (13)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x03</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology Id (14)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Type (15)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Id (16)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key field length (17)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key (18 - 22)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'Hello'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan (23)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max idle (24)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value field length (25)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value (26-30)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'World'</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Coded response</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1112%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Byte</th>
<th class="tableblock halign-left valign-top">0</th>
<th class="tableblock halign-left valign-top">1</th>
<th class="tableblock halign-left valign-top">2</th>
<th class="tableblock halign-left valign-top">3</th>
<th class="tableblock halign-left valign-top">4</th>
<th class="tableblock halign-left valign-top">5</th>
<th class="tableblock halign-left valign-top">6</th>
<th class="tableblock halign-left valign-top">7</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xA1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x09</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>Field Explanation</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Magic (0)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xA1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Id (1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x09</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Opcode (2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Status (3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology change marker (4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_1_1"><a class="anchor" href="#hot_rod_protocol_1_1"></a>20.6.2. Hot Rod Protocol 1.1</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 5.1.0.FINAL
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="request_header_2"><a class="anchor" href="#request_header_2"></a>Request Header</h5>
<div class="paragraph">
<p>The <code>version</code> field in the header is updated to <code>11</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="distribution_aware_client_topology_change_header_2"><a class="anchor" href="#distribution_aware_client_topology_change_header_2"></a>Distribution-Aware Client Topology Change Header</h5>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Updated for 1.1</div>
This section has been modified to be more efficient when talking
to distributed caches with virtual nodes enabled.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is what hash-distribution-aware clients receive as response header when
a topology change is sent back:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header with topology change marker</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See previous section.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology Id</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Num Key Owners</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Globally configured number of copies for each Infinispan distributed key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash Function Version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash function version, pointing to a specific hash function in use.
See <a href="#hot_rod_hash_functions">Hot Rod hash functions</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash space size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modulus used by Infinispan for for all module arithmetic related to hash
code generation. Clients will likely require this information in order to
apply the correct hash calculation to the keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Num servers in topology</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of Hot Rod servers running within the cluster.
This could be a subset of the entire cluster if only a fraction of those
nodes are running Hot Rod servers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Num Virtual Nodes Owners</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field added in version 1.1 of the protocol that represents the number of
configured virtual nodes. If no virtual nodes are configured or the cache
is not configured with distribution, this field will contain 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of hostname or IP address of individual cluster member that Hot Rod
client can use to access it. Using variable length here allows for covering
for hostnames, IPv4 and IPv6 addresses.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP address</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String containing hostname or IP address of individual cluster member
that Hot Rod client can use to access it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Port</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port that Hot Rod clients can use to communicat with this cluster member.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Hashcode</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">4 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32 bit integer representing the hashcode of a cluster member that a Hot Rod
client can use indentify in which cluster member a key is located having
applied the CSA to it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP address</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Port</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Hashcode</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">4 bytes</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;etc</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="server_node_hash_code_calculation"><a class="anchor" href="#server_node_hash_code_calculation"></a>Server node hash code calculation</h5>
<div class="paragraph">
<p>Adding support for virtual nodes has made version 1.0 of the Hot Rod protocol
impractical due to bandwidth it would have taken to return hash codes for all
virtual nodes in the clusters (this number could easily be in the millions).
So, as of version 1.1 of the Hot Rod protocol, clients are given the base
hash id or hash code of each server, and then they have to calculate the real
hash position of each server both with and without virtual nodes configured.
Here are the rules clients should follow when trying to calculate a node&#8217;s
hash code:</p>
</div>
<div class="paragraph">
<p>1\.  With <em>virtual nodes disabled</em> : Once clients have received the base
hash code of the server, they need to normalize it in order to find the exact
position of the hash wheel. The process of normalization involves passing the
base hash code to the hash function, and then do a small calculation to avoid
negative values. The resulting number is the node&#8217;s position in the hash wheel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> getNormalizedHash(<span class="type">int</span> nodeBaseHashCode, Hash hashFct) {
   <span class="keyword">return</span> hashFct.hash(nodeBaseHashCode) &amp; <span class="predefined-type">Integer</span>.MAX_VALUE; <span class="comment">// make sure no negative numbers are involved.</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>2\.  With <em>virtual nodes enabled</em> : In this case, each node represents N
different virtual nodes, and to calculate each virtual node&#8217;s hash code, we
need to take the the range of numbers between 0 and N-1 and apply the
following logic:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For virtual node with 0 as id, use the technique used to retrieve a node&#8217;s
hash code, as shown in the previous section.</p>
</li>
<li>
<p>For virtual nodes from 1 to N-1 ids, execute the following logic:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> virtualNodeHashCode(<span class="type">int</span> nodeBaseHashCode, <span class="type">int</span> id, Hash hashFct) {
   <span class="type">int</span> virtualNodeBaseHashCode = id;
   virtualNodeBaseHashCode = <span class="integer">31</span> * virtualNodeBaseHashCode + nodeBaseHashCode;
   <span class="keyword">return</span> getNormalizedHash(virtualNodeBaseHashCode, hashFct);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_1_2"><a class="anchor" href="#hot_rod_protocol_1_2"></a>20.6.3. Hot Rod Protocol 1.2</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 5.2.0.Final. Since Infinispan 5.3.0, HotRod supports encryption via SSL. However, since this only affects the transport, the version number of the protocol has not been incremented.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="request_header_3"><a class="anchor" href="#request_header_3"></a>Request Header</h5>
<div class="paragraph">
<p>The <code>version</code> field in the header is updated to <code>12</code>.</p>
</div>
<div class="paragraph">
<p>Two new request operation codes have been added:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0x1B = getWithMetadata request</p>
</li>
<li>
<p>0x1D = bulkKeysGet request</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Two new flags have been added too:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0x0002	= use cache-level configured default lifespan</p>
</li>
<li>
<p>0x0004	= use cache-level configured default max idle</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="response_header"><a class="anchor" href="#response_header"></a>Response Header</h5>
<div class="paragraph">
<p>Two new response operation codes have been added:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0x1C = getWithMetadata response</p>
</li>
<li>
<p>0x1E = bulkKeysGet response</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="operations_2"><a class="anchor" href="#operations_2"></a>Operations</h5>
<div class="paragraph">
<div class="title">GetWithMetadata</div>
<p>Request (0x1B):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key. Note that the size of a
vint can be up to 5 bytes which in theory can produce bigger numbers than
Integer.MAX_VALUE. However, Java cannot create a single array thats bigger
than Integer.MAX_VALUE, hence the protocol is limiting vint array lengths to
Integer.MAX_VALUE.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key whose value is being requested.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x1C):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if key retrieved<br>
0x02 = if key does not exist<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flag</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A flag indicating whether the response
contains expiration information. The value of the flag is obtained as a
bitwise OR operation between INFINITE_LIFESPAN (0x01) and
<code>INFINITE_MAXIDLE (0x02)</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Created</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a Long representing the
timestamp when the entry was created on the server. This value is returned
only if the flag&#8217;s INFINITE_LIFESPAN bit is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a vInt representing the
lifespan of the entry in seconds. This value is returned only if the flag&#8217;s
INFINITE_LIFESPAN bit is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LastUsed</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a Long representing the
timestamp when the entry was last accessed on the server. This value is
returned only if the flag&#8217;s <code>INFINITE_MAXIDLE</code> bit is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxIdle</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a vInt representing the
maxIdle of the entry in seconds. This value is returned only if the flag&#8217;s
<code>INFINITE_MAXIDLE</code> bit is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique value of an existing entry&#8217;s modification.
The protocol does not mandate that entry_version values are sequential.
They just need to be unique per update at the key level.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If success, length of value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If success, the requested value</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">BulkKeysGet</div>
<p>Request (0x1D):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scope</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 = Default Scope - This scope is used by RemoteCache.keySet() method.
If the remote cache is a distributed cache, the server launch a stream
operation to retrieve all keys from all of the nodes. (Remember, a
topology-aware Hot Rod Client could be load balancing the request to any
one node in the cluster). Otherwise, it&#8217;ll get keys from the cache instance
local to the server receiving the request (that is because the keys should
be the same across all nodes in a replicated cache).<br>
1 = Global Scope - This scope behaves the same to Default Scope.<br>
2 = Local Scope - In case when remote cache is a distributed cache,
the server will not launch a stream operation to retrieve keys from
all nodes. Instead, it&#8217;ll only get keys local from the cache instance local
to the server receiving the request.<br></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x1E):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, data follows<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">More</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One byte representing whether more
keys need to be read from the stream. So, when it&#8217;s set to 1, it means
that an entry follows, whereas when it&#8217;s set to 0, it&#8217;s the end of stream and
no more entries are left to read. For more information on BulkGet look
<a href="http://community.jboss.org/docs/DOC-15592">here</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">More</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; etc</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_1_3"><a class="anchor" href="#hot_rod_protocol_1_3"></a>20.6.4. Hot Rod Protocol 1.3</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 6.0.0.Final.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="request_header_4"><a class="anchor" href="#request_header_4"></a>Request Header</h5>
<div class="paragraph">
<p>The <code>version</code> field in the header is updated to <code>13</code>.</p>
</div>
<div class="paragraph">
<p>A new request operation code has been added:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0x1F = query request</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="response_header_2"><a class="anchor" href="#response_header_2"></a>Response Header</h5>
<div class="paragraph">
<p>A new response operation code has been added:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0x20 = query response</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="operations_3"><a class="anchor" href="#operations_3"></a>Operations</h5>
<div class="paragraph">
<div class="title">Query</div>
<p>Request (0x1F):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Query Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The length of the protobuf encoded query object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Query</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the protobuf encoded query object, having a length specified by previous field.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x20):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response payload Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The length of the protobuf encoded response object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response payload</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the protobuf encoded response object, having a length specified by previous field.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As of Infinispan 6.0, the query and response objects are specified by the protobuf message types 'org.infinispan.client.hotrod.impl.query.QueryRequest' and 'org.infinispan.client.hotrod.impl.query.QueryResponse'
defined in <a href="https://github.com/infinispan/infinispan/blob/master/remote-query/remote-query-client/src/main/resources/org/infinispan/query/remote/client/query.proto">remote-query/remote-query-client/src/main/resources/org/infinispan/query/remote/client/query.proto</a>.
These definitions could change in future Infinispan versions, but as long as these evolutions will be kept backward
compatible (according to the rules defined <a href="https://developers.google.com/protocol-buffers/docs/proto#updating">here</a>) no new Hot Rod
protocol version will be introduced to accommodate this.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_2_0"><a class="anchor" href="#hot_rod_protocol_2_0"></a>20.6.5. Hot Rod Protocol 2.0</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 7.0.0.Final.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="request_header_5"><a class="anchor" href="#request_header_5"></a>Request Header</h5>
<div class="paragraph">
<p>The request header no longer contains <code>Transaction Type</code> and <code>Transaction ID</code>
elements since they&#8217;re not in use, and even if they were in use, there are
several operations for which they would not make sense, such as <code>ping</code> or
<code>stats</code> commands. Once transactions are implemented, the protocol version will
be upped, with the necessary changes in the request header.</p>
</div>
<div class="paragraph">
<p>The <code>version</code> field in the header is updated to <code>20</code>.</p>
</div>
<div class="paragraph">
<p>Two new flags have been added:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0x0008  = operation skips loading from configured cache loader.</p>
</li>
<li>
<p>0x0010  = operation skips indexing. Only relevant when the query module is enabled for the cache</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following new request operation codes have been added:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0x21 = auth mech list request</p>
</li>
<li>
<p>0x23 = auth request</p>
</li>
<li>
<p>0x25 = add client remote event listener request</p>
</li>
<li>
<p>0x27 = remove client remote event listener request</p>
</li>
<li>
<p>0x29 = size request</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="response_header_3"><a class="anchor" href="#response_header_3"></a>Response Header</h5>
<div class="paragraph">
<p>The following new response operation codes have been added:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0x22 = auth mech list response</p>
</li>
<li>
<p>0x24 = auth mech response</p>
</li>
<li>
<p>0x26 = add client remote event listener response</p>
</li>
<li>
<p>0x28 = remove client remote event listener response</p>
</li>
<li>
<p>0x2A = size response</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Two new error codes have also been added to enable clients more intelligent
decisions, particularly when it comes to fail-over logic:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0x87 = Node suspected. When a client receives this error as response,
it means that the node that responded had an issue sending an operation to a
third node, which was suspected. Generally, requests that return this error
should be failed-over to other nodes.</p>
</li>
<li>
<p>0x88 = Illegal lifecycle state. When a client receives this error as response,
it means that the server-side cache or cache manager are not available
for requests because either stopped, they&#8217;re stopping or similar situation.
Generally, requests that return this error should be failed-over to other nodes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some adjustments have been made to the responses for the following commands in
order to better handle response decoding without the need to keep track of the
information sent. More precisely, the way previous values are parsed has changed
so that the status of the command response provides clues on whether the previous
value follows or not. More precisely:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Put response returns <code>0x03</code> status code when put was successful
and previous value follows.</p>
</li>
<li>
<p>PutIfAbsent response returns <code>0x04</code> status code only when the putIfAbsent
operation failed because the key was present and its value follows in the
response. If the putIfAbsent worked, there would have not been a previous value,
and hence it does not make sense returning anything extra.</p>
</li>
<li>
<p>Replace response returns <code>0x03</code> status code only when replace happened and the
previous or replaced value follows in the response. If the replace did not happen,
it means that the cache entry was not present, and hence there&#8217;s no previous value
that can be returned.</p>
</li>
<li>
<p>ReplaceIfUnmodified returns <code>0x03</code> status code only when replace happened and
the previous or replaced value follows in the response.</p>
</li>
<li>
<p>ReplaceIfUnmodified returns <code>0x04</code> status code only when replace did not happen
as a result of the key being modified, and the modified value follows in the response.</p>
</li>
<li>
<p>Remove returns <code>0x03</code> status code when the remove happened and the previous or
removed value follows in the response. If the remove did not occur as a result
of the key not being present, it does not make sense sending any previous value
information.</p>
</li>
<li>
<p>RemoveIfUnmodified returns <code>0x03</code> status code only when remove happened and
the previous or replaced value follows in the response.</p>
</li>
<li>
<p>RemoveIfUnmodified returns <code>0x04</code> status code only when remove did not happen
as a result of the key being modified, and the modified value follows in the response.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="distribution_aware_client_topology_change_header_3"><a class="anchor" href="#distribution_aware_client_topology_change_header_3"></a>Distribution-Aware Client Topology Change Header</h5>
<div class="paragraph">
<p>In Infinispan 5.2, virtual nodes based consistent hashing was abandoned and
instead segment based consistent hash was implemented. In order to satisfy
the ability for Hot Rod clients to find data as reliably as possible,
Infinispan has been transforming the segment based consistent hash to fit
Hot Rod 1.x protocol.  Starting with version 2.0, a brand new
distribution-aware topology change header has been implemented which suppors
 segment based consistent hashing suitably and provides 100% data location
 guarantees.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header with topology change marker</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology Id</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Num servers in topology</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of Infinispan Hot Rod servers running within the cluster.
This could be a subset of the entire cluster if only a fraction of those
nodes are running Hot Rod servers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of hostname or IP address of individual cluster member that Hot Rod
client can use to access it. Using variable length here allows for covering
for hostnames, IPv4 and IPv6 addresses.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Host/IP address</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String containing hostname or IP address of individual cluster member
that Hot Rod client can use to access it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m1: Port</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port that Hot Rod clients can use to communicat with this cluster member.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Host/IP address</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m2: Port</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2 bytes (Unsigned Short)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash Function Version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hash function version, pointing to a specific hash function in use.
See <a href="#hot_rod_hash_functions">Hot Rod hash functions</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Num segments in topology</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total number of segments in the topology</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of owners in segment</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This can be either 0, 1 or 2 owners.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">First owner&#8217;s index</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given the list of all nodes, the position of this owner in this list.
This is only present if number of owners for this segment is 1 or 2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second owner&#8217;s index</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given the list of all nodes, the position of this owner in this list.
This is only present if number of owners for this segment is 2.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Given this information, Hot Rod clients should be able to recalculate all
the hash segments and be able to find out which nodes are owners for each
segment. Even though there could be more than 2 owners per segment, Hot Rod
protocol limits the number of owners to send for efficiency reasons.</p>
</div>
</div>
<div class="sect4">
<h5 id="operations_4"><a class="anchor" href="#operations_4"></a>Operations</h5>
<div class="paragraph">
<div class="title">Auth Mech List</div>
<p>Request (0x21):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x22):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mech count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of mechs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mech 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String containing the name of the SASL mech in its IANA-registered form (e.g. GSSAPI, CRAM-MD5, etc)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mech 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;etc</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The purpose of this operation is to obtain the list of valid SASL authentication mechs supported by the server. The client
will then need to issue an Authenticate request with the preferred mech.</p>
</div>
<div class="paragraph">
<div class="title">Authenticate</div>
<p>Request (0x23):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mech</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String containing the name of the mech chosen by the client for authentication. Empty on the successive invocations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of the SASL client response</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response data</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The SASL client response</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x24):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Completed</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 if further processing is needed, 1 if authentication is complete</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Challenge length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of the SASL server challenge</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Challenge data</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The SASL server challenge</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The purpose of this operation is to authenticate a client against a server using SASL. The authentication process, depending
on the chosen mech, might be a multi-step operation. Once complete the connection becomes authenticated</p>
</div>
<div class="paragraph">
<div class="title">Add client listener for remote events</div>
<p>Request (0x25):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener identifier</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Include state</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When this byte is set to <code>1</code>, cached state is
sent back to remote clients when either adding a cache listener for the first
time, or when the node where a remote listener is registered changes in a clustered
environment. When enabled, state is sent back as cache entry created events to
the clients. If set to <code>0</code>, no state is sent back to the client when adding a listener,
nor it gets state when the node where the listener is registered changes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional name of the key/value filter
factory to be used with this listener. The factory is used to create key/value
filter instances which allow events to be filtered directly in the Hot Rod
server, avoiding sending events that the client is not interested in. If no
factory is to be used, the length of the string is <code>0</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The key/value filter
factory, when creating a filter instance, can take an arbitrary number of
parameters, enabling the factory to be used to create different filter
instances dynamically. This count field indicates how many parameters will be
passed to the factory. If no factory name was provided, this field is not
present in the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">First key/value filter
factory parameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second key/value filter
factory parameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional name of the converter
factory to be used with this listener. The factory is used to transform the
contents of the events sent to clients. By default, when no converter is in use,
events are well defined, according to the type of event generated. However,
there might be situations where users want to add extra information to the event,
or they want to reduce the size of the events. In these cases, a converter can
be used to transform the event contents. The given converter factory name
produces converter instances to do this job. If no factory is to be used, the
length of the string is <code>0</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The converter
factory, when creating a converter instance, can take an arbitrary number of
parameters, enabling the factory to be used to create different converter
instances dynamically. This count field indicates how many parameters will be
passed to the factory. If no factory name was provided, this field is not
present in the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">First converter factory parameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second converter factory parameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x26):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Remove client listener for remote events</div>
<p>Request (0x27):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener identifier</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x28):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Size</div>
<p>Request (0x29):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x2A):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of the remote cache, which is calculated globally in the
clustered set ups, and if present, takes cache store contents into account as
well.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Exec</div>
<p>Request (0x2B):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the task to execute</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter Count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of parameters</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter 1 Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the first parameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The length of the first parameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter 1 Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the first parameter</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x2C):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if execution completed successfully<br>
0x85 = server error<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If success, length of return value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If success, the result of the execution</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="remote_events"><a class="anchor" href="#remote_events"></a>Remote Events</h5>
<div class="paragraph">
<p>Starting with Hot Rod 2.0, clients can register listeners for remote events
happening in the server. Sending these events commences the moment a client
adds a client listener for remote events.</p>
</div>
<div class="paragraph">
<p>Event Header:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Magic</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xA1 = response</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID of event</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Opcode</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event type:<br>
0x60 = cache entry created event<br>
0x61 = cache entry modified event<br>
0x62 = cache entry removed event<br>
0x66 = counter event<br>
0x50 = error<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Status of the response, possible values:<br>
0x00 = No error<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Topology Change Marker</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Since events are not associated with a
particular incoming topology ID to be able to decide whether a new topology is
required to be sent or not, new topologies will never be sent with events. Hence,
this marker will always have <code>0</code> value for events.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Cache entry created event</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event header with <code>0x60</code> operation code</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener for which this event is directed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom marker</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom event marker. For created events, this is <code>0</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Command retried</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Marker for events that are result of retried commands.
If command is retried, it returns <code>1</code>, otherwise <code>0</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Created key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version of the created entry. This version information can
be used to make conditional operations on this cache entry.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Cache entry modified event</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event header with <code>0x61</code> operation code</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener for which this event is directed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom marker</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom event marker. For created events, this is <code>0</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Command retried</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Marker for events that are result of retried commands.
If command is retried, it returns <code>1</code>, otherwise <code>0</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modified key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version of the modified entry. This version information can
be used to make conditional operations on this cache entry.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Cache entry removed event</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event header with <code>0x62</code> operation code</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener for which this event is directed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom marker</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom event marker. For created events, this is <code>0</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Command retried</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Marker for events that are result of retried commands.
If command is retried, it returns <code>1</code>, otherwise <code>0</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removed key</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Custom event</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event header with event specific operation code</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener for which this event is directed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom marker</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom event marker. For custom  events, this is <code>1</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event data</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom event data, formatted according to the
converter implementation logic.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_2_1"><a class="anchor" href="#hot_rod_protocol_2_1"></a>20.6.6. Hot Rod Protocol 2.1</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 7.1.0.Final.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="request_header_6"><a class="anchor" href="#request_header_6"></a>Request Header</h5>
<div class="paragraph">
<p>The <code>version</code> field in the header is updated to <code>21</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="operations_5"><a class="anchor" href="#operations_5"></a>Operations</h5>
<div class="paragraph">
<div class="title">Add client listener for remote events</div>
<p>An extra byte parameter is added at the end which indicates whether the client
prefers client listener to work with raw binary data for filter/converter
callbacks. If using raw data, its value is <code>1</code> otherwise <code>0</code>.</p>
</div>
<div class="paragraph">
<p>Request format:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Include state</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use raw data</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If filter/converter parameters should be raw binary,
then <code>1</code>, otherwise <code>0</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Custom event</div>
<p>Starting with Hot Rod 2.1, custom events can return raw data that the Hot Rod
client should not try to unmarshall before passing it on to the user. The way
this is transmitted to the Hot Rod client is by sending <code>2</code> as the custom
event marker. So, the format of the custom event remains like this:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event header with event specific operation code</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener for which this event is directed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom marker</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom event marker. For custom events whose event
data needs to be unmarshalled before returning to user the value is <code>1</code>. For
custom events that need to return the event data as-is to the user, the value
is <code>2</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event data</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom event data. If the custom marker is <code>1</code>,
the bytes represent the marshalled version of the instance returned by the
converter. If custom marker is <code>2</code>, it represents the byte array, as returned
by the converter.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_2_2"><a class="anchor" href="#hot_rod_protocol_2_2"></a>20.6.7. Hot Rod Protocol 2.2</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 8.0
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Added support for different time units.</p>
</div>
<div class="sect4">
<h5 id="operations_6"><a class="anchor" href="#operations_6"></a>Operations</h5>
<div class="paragraph">
<div class="title">Put/PutAll/PutIfAbsent/Replace/ReplaceIfUnmodified</div>
<p>Common request format:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TimeUnits</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time units of lifespan (first 4 bits) and maxIdle (last 4 bits). Special units
DEFAULT and INFINITE can be used for default server expiration and no expiration respectively. Possible values:<br>
0x00 = SECONDS<br>
0x01 = MILLISECONDS<br>
0x02 = NANOSECONDS<br>
0x03 = MICROSECONDS<br>
0x04 = MINUTES<br>
0x05 = HOURS<br>
0x06 = DAYS<br>
0x07 = DEFAULT<br>
0x08 = INFINITE<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration which the entry is allowed to life. Only sent when time unit is not DEFAULT or INFINITE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max Idle</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration that each entry can be idle before it&#8217;s evicted from the cache. Only sent when time unit is not DEFAULT or INFINITE</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_2_3"><a class="anchor" href="#hot_rod_protocol_2_3"></a>20.6.8. Hot Rod Protocol 2.3</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 8.0
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="operations_7"><a class="anchor" href="#operations_7"></a>Operations</h5>
<div class="paragraph">
<div class="title">Iteration Start</div>
<p>Request (0x31):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Segments size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of the bitset encoding of the segments ids to iterate on. The size is the maximum segment id rounded to nearest multiple of 8.<br>
A value -1 indicates no segment filtering is to be done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Segments</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) Contains the segments ids bitset encoded, where each bit with value 1 represents a segment in the set. Byte order is little-endian.<br>
Example: segments [1,3,12,13] would result in the following encoding:<br>
00001010 00110000<br>
size: 16 bits<br>
first byte: represents segments from 0 to 7, from which 1 and 3 are set<br>
second byte: represents segments from 8 to 15, from which 12 and 13 are set<br>
More details in the java.util.BitSet implementation. Segments will be sent if the previous field is not negative</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FilterConverter size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The size of the String representing a KeyValueFilterConverter factory name deployed on the server, or -1 if no filter will be used</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FilterConverter</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">UTF-8 byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) KeyValueFilterConverter factory name deployed on the server. Present if previous field is not negative</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BatchSize</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number of entries to transfers from the server at one go</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x32):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IterationId</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique id of the iteration</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Iteration Next</div>
<p>Request (0x33):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IterationId</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique id of the iteration</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x34):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finished segments size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">size of the bitset representing segments that were finished iterating</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finished segments</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bitset encoding of the segments that were finished iterating</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">How many entries are being returned</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieved value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 2 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; continues until entry count is reached</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Iteration End</div>
<p>Request (0x35):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IterationId</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The unique id of the iteration</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x36):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Header</th>
<th class="tableblock halign-center valign-top">variable</th>
<th class="tableblock halign-left valign-top">Response header</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if execution completed successfully<br>
0x05 = for non existent IterationId <br></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_2_4"><a class="anchor" href="#hot_rod_protocol_2_4"></a>20.6.9. Hot Rod Protocol 2.4</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 8.1
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This Hot Rod protocol version adds three new status code that gives the client
hints on whether the server has compatibility mode enabled or not:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x06</code>: Success status and compatibility mode is enabled.</p>
</li>
<li>
<p><code>0x07</code>: Success status and return previous value, with compatibility mode is enabled.</p>
</li>
<li>
<p><code>0x08</code>: Not executed and return previous value, with compatibility mode is enabled.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Iteration Start operation can optionally send parameters if a custom filter is provided and
it&#8217;s parametrised:</p>
</div>
<div class="sect4">
<h5 id="operations_8"><a class="anchor" href="#operations_8"></a>Operations</h5>
<div class="paragraph">
<div class="title">Iteration Start</div>
<p>Request (0x31):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Segments size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Segments</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FilterConverter size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FilterConverter</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">UTF-8 byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameters size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the number of params of the filter. Only present when FilterConverter is provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameters</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte[][]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">an array of parameters, each parameter is a byte array. Only present if Parameters size is greater than 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BatchSize</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The Iteration Next operation can optionally return projections in the value,
meaning more than one value is contained in the same entry.</p>
</div>
<div class="paragraph">
<div class="title">Iteration Next</div>
<p>Response (0x34):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finished segments size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finished segments</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of value projections</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of projections for the values. If 1, behaves like version protocol version 2.3.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value1 projection1 length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">length of value1 first projection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value1 projection1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">retrieved value1 first projection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value1 projection2 length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">length of value2 second projection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value1 projection2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">retrieved value2 second projection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; continues until all projections for the value retrieved</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Key2 Length</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">vInt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Key2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">byte array</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.3.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Value2 projection1 length</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">vInt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">length of value 2 first projection</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Value2 projection1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">byte array</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retrieved value 2 first projection</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Value2 projection2 length</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">vInt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">length of value 2 second projection</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Value2 projection2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">byte array</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retrieved value 2 second projection</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8230;&#8203; continues until entry count is reached</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Stats:</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Statistics returned by previous Hot Rod protocol versions were local to the node
where the Hot Rod operation had been called. Starting with 2.4, new statistics
have been added which provide global counts for the statistics returned
previously. If the Hot Rod is running in local mode, these statistics are not
returned:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">globalCurrentNumberOfEntries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of entries currently across the Hot Rod cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">globalStores</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total number of put operations across the Hot Rod cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">globalRetrievals</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total number of get operations across the Hot Rod cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">globalHits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total number of get hits across the Hot Rod cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">globalMisses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total number of get misses across the Hot Rod cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">globalRemoveHits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total number of removal hits across the Hot Rod cluster.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">globalRemoveMisses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total number of removal misses across the Hot Rod cluster.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_2_5"><a class="anchor" href="#hot_rod_protocol_2_5"></a>20.6.10. Hot Rod Protocol 2.5</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 8.2
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This Hot Rod protocol version adds support for metadata retrieval along with entries in the iterator.
It includes two changes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Iteration Start request includes an optional flag</p>
</li>
<li>
<p>IterationNext operation may include metadata info for each entry if the flag above is set</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Iteration Start</div>
<p>Request (0x31):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Segments size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Segments</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FilterConverter size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FilterConverter</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">UTF-8 byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameters size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameters</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte[][]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BatchSize</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metadata</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 if metadata is to be returned for each entry, 0 otherwise</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Iteration Next</div>
<p>Response (0x34):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finished segments size</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finished segments</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of value projections</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metadata  (entry 1)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set, entry has metadata associated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expiration (entry 1)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A flag indicating whether the response
contains expiration information. The value of the flag is obtained as a
bitwise OR operation between INFINITE_LIFESPAN (0x01) and
<code>INFINITE_MAXIDLE (0x02)</code>. Only present if the metadata flag above is set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Created (entry 1)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a Long representing the
timestamp when the entry was created on the server. This value is returned
only if the flag&#8217;s INFINITE_LIFESPAN bit is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan (entry 1)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a vInt representing the
lifespan of the entry in seconds. This value is returned only if the flag&#8217;s
INFINITE_LIFESPAN bit is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LastUsed (entry 1)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a Long representing the
timestamp when the entry was last accessed on the server. This value is
returned only if the flag&#8217;s <code>INFINITE_MAXIDLE</code> bit is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxIdle (entry 1)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a vInt representing the
maxIdle of the entry in seconds. This value is returned only if the flag&#8217;s
<code>INFINITE_MAXIDLE</code> bit is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version (entry 1)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique value of an existing entry&#8217;s modification. Only present if Metadata flag is set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as protocol version 2.4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metadata (entry 2)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expiration (entry 2)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Created (entry 2)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan (entry 2)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LastUsed (entry 2)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxIdle (entry 2)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version (entry 2)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as for entry 1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 2 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203; continues until entry count is reached</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_2_6"><a class="anchor" href="#hot_rod_protocol_2_6"></a>20.6.11. Hot Rod Protocol 2.6</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 9.0
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This Hot Rod protocol version adds support for streaming get and put operations.
It includes two new operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GetStream for retrieving data as a stream, with an optional initial offset</p>
</li>
<li>
<p>PutStream for writing data as a stream, optionally by specifying a version</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">GetStream</div>
<p>Request (0x37):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offset</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The offset in bytes from which to start retrieving. Set to 0 to retrieve from the
beginning</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key. Note that the size of a
vint can be up to 5 bytes which in theory can produce bigger numbers than
Integer.MAX_VALUE. However, Java cannot create a single array thats bigger
than Integer.MAX_VALUE, hence the protocol is limiting vint array lengths to
Integer.MAX_VALUE.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key whose value is being requested.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">GetStream</div>
<p>Response (0x38):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = success, if key retrieved<br>
0x02 = if key does not exist<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flag</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A flag indicating whether the response
contains expiration information. The value of the flag is obtained as a
bitwise OR operation between INFINITE_LIFESPAN (0x01) and
<code>INFINITE_MAXIDLE (0x02)</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Created</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a Long representing the
timestamp when the entry was created on the server. This value is returned
only if the flag&#8217;s INFINITE_LIFESPAN bit is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a vInt representing the
lifespan of the entry in seconds. This value is returned only if the flag&#8217;s
INFINITE_LIFESPAN bit is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LastUsed</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a Long representing the
timestamp when the entry was last accessed on the server. This value is
returned only if the flag&#8217;s <code>INFINITE_MAXIDLE</code> bit is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxIdle</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(optional) a vInt representing the
maxIdle of the entry in seconds. This value is returned only if the flag&#8217;s
<code>INFINITE_MAXIDLE</code> bit is not set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique value of an existing entry&#8217;s modification.
The protocol does not mandate that entry_version values are sequential.
They just need to be unique per update at the key level.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If success, length of value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If success, the requested value</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">PutStream</div>
<p>Request (0x39)</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entry Version</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possible values<br>
0 = Unconditional put<br>
-1 = Put If Absent<br>
Other values =  pass a version obtained by <code>GetWithMetadata</code> operation to perform a conditional replace.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key. Note that the size of a
vint can be up to 5 bytes which in theory can produce bigger numbers than
Integer.MAX_VALUE. However, Java cannot create a single array thats bigger
than Integer.MAX_VALUE, hence the protocol is limiting vint array lengths to
Integer.MAX_VALUE.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key whose value is being requested.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Chunk 1 Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The size of the first chunk of data. If this value is 0 it means the client has
 completed transferring the value and the operation should be performed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Chunk 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of bytes forming the fist chunk of data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;continues until the value is complete</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x3A):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>On top of these additions, this Hot Rod protocol version improves remote listener registration by adding a byte that indicates at a global level, which type of events the client is interested in.
For example, a client can indicate that only created events, or only expiration and removal events&#8230;&#8203;etc.
More fine grained event interests, e.g. per key, can be defined using the key/value filter parameter.</p>
</div>
<div class="paragraph">
<p>So, the new add listener request looks like this:</p>
</div>
<div class="paragraph">
<div class="title">Add client listener for remote events</div>
<p>Request (0x25):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener identifier</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Include state</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When this byte is set to <code>1</code>, cached state is
sent back to remote clients when either adding a cache listener for the first
time, or when the node where a remote listener is registered changes in a clustered
environment. When enabled, state is sent back as cache entry created events to
the clients. If set to <code>0</code>, no state is sent back to the client when adding a listener,
nor it gets state when the node where the listener is registered changes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional name of the key/value filter
factory to be used with this listener. The factory is used to create key/value
filter instances which allow events to be filtered directly in the Hot Rod
server, avoiding sending events that the client is not interested in. If no
factory is to be used, the length of the string is <code>0</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The key/value filter
factory, when creating a filter instance, can take an arbitrary number of
parameters, enabling the factory to be used to create different filter
instances dynamically. This count field indicates how many parameters will be
passed to the factory. If no factory name was provided, this field is not
present in the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">First key/value filter
factory parameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key/value filter factory parameter 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second key/value filter
factory parameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional name of the converter
factory to be used with this listener. The factory is used to transform the
contents of the events sent to clients. By default, when no converter is in use,
events are well defined, according to the type of event generated. However,
there might be situations where users want to add extra information to the event,
or they want to reduce the size of the events. In these cases, a converter can
be used to transform the event contents. The given converter factory name
produces converter instances to do this job. If no factory is to be used, the
length of the string is <code>0</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter count</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The converter
factory, when creating a converter instance, can take an arbitrary number of
parameters, enabling the factory to be used to create different converter
instances dynamically. This count field indicates how many parameters will be
passed to the factory. If no factory name was provided, this field is not
present in the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter 1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">First converter factory parameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converter factory parameter 2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second converter factory parameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-center valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener even type interests</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A variable length number representing listener event type interests.
Each event type is represented by a bit.
Each flags is represented by a bit.
Note that since this field is sent as variable length, the most significant bit in a byte is used to determine whether more bytes need to be read, hence this bit does not represent any flag.
Using this model allows for flags to be combined in a short space.
Here are the current values for each flag:<br>
0x01 = cache entry created events
0x02 = cache entry modified events
0x04 = cache entry removed events
0x08 = cache entry expired events</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_2_7"><a class="anchor" href="#hot_rod_protocol_2_7"></a>20.6.12. Hot Rod Protocol 2.7</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 9.2
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This Hot Rod protocol version adds support for transaction operations.
It includes 3 new operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Prepare, with the transaction write set (i.e. modified keys), it tries to prepare and validate the transaction in the server.</p>
</li>
<li>
<p>Commit, commits a prepared transaction.</p>
</li>
<li>
<p>Rollback, rollbacks a prepared transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Prepare Request</div>
<p>Request (0x3B):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Xid</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">XID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction ID (XID)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OnePhaseCommit</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When it is set to <code>1</code>, the server will use one-phase-commit if available (XA only)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of keys</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of keys</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock">For each key (keys must be distinct)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key.
Note that the size of a vInt can be up to 5 bytes which in theory can produce bigger numbers than <code>Integer.MAX_VALUE</code>.
However, Java cannot create a single array thats bigger than <code>Integer.MAX_VALUE</code>, hence the protocol is limiting vInt array lengths to <code>Integer.MAX_VALUE</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Control Byte</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A bit set with the following meaning:<br>
0x01 = <code>NOT_READ</code><br>
0x02 = <code>NON_EXISTING</code><br>
0x04 = <code>REMOVE_OPERATION</code><br>
Note that <code>NOT_READ</code> and <code>NON_EXISTING</code> can&#8217;t be set at the same time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version Read</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The version read. Only sent when <code>NOT_READ</code> and <code>NON_EXISTING</code> aren&#8217;t present.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TimeUnits</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time units of lifespan (first 4 bits) and maxIdle (last 4 bits).
Special units <code>DEFAULT</code> and <code>INFINITE</code> can be used for default server expiration and no expiration respectively.
Possible values:<br>
0x00 = <code>SECONDS</code><br>
0x01 = <code>MILLISECONDS</code><br>
0x02 = <code>NANOSECONDS</code><br>
0x03 = <code>MICROSECONDS</code><br>
0x04 = <code>MINUTES</code><br>
0x05 = <code>HOURS</code><br>
0x06 = <code>DAYS</code><br>
0x07 = <code>DEFAULT</code><br>
0x08 = <code>INFINITE</code><br>
Only sent when <code>REMOVE_OPERATION</code> isn&#8217;t set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration which the entry is allowed to life.
Only sent when time unit is not <code>DEFAULT</code> or <code>INFINITE</code> and <code>REMOVE_OPERATION</code> isn&#8217;t set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max Idle</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration that each entry can be idle before it&#8217;s evicted from the cache.
Only sent when time unit is not <code>DEFAULT</code> or <code>INFINITE</code> and <code>REMOVE_OPERATION</code> isn&#8217;t set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of value.
Only sent if <code>REMOVE_OPERATION</code> isn&#8217;t set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte-array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value to be stored.
Only sent if <code>REMOVE_OPERATION</code> isn&#8217;t set.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Commit and Rollback Request</div>
<p>Request. Commit (0x3D) and Rollback (0x3F):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Xid</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">XID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction ID (XID)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Response from prepare, commit and rollback request.</div>
<p>Response. Prepare (0x3C), Commit (0x3E) and Rollback (0x40)</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XA return code</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The XA code representing the prepare response.<br>
Can be <code>XA_OK(0)</code>, <code>XA_RDONLY(3)</code> or any of the error codes (see <code>XaException</code>).<br>
This field isn&#8217;t present if the response state is different from <code>Successful</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">XID Format</div>
<p>The XID in the requests has the following format:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Format ID</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">signed vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The XID format.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of Global Transaction id</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The length of global transaction id byte array. It max value is <code>64</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Global Transaction Id</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The global transaction id.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of Branch Qualifier</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The length of branch qualifier byte array. It max value is <code>64</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Branch Qualifier</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The branch qualifier.</p></td>
</tr>
</tbody>
</table>
<div id="counter_config_encode" class="paragraph">
<div class="title">Counter Configuration encoding format</div>
<p>The <code>CounterConfiguration</code> class encoding format is the following:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In counter related operation, the <code>Cache Name</code> field in Request Header can be empty.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Summary of <code>Status</code> value in the Response Header:<br>
* <code>0x00</code>: Operation successful.<br>
* <code>0x01</code>: Operation failed.<br>
* <code>0x02</code>: The counter isn&#8217;t defined.<br>
* <code>0x04</code>: The counter reached a boundary. Only possible for <code>STRONG</code> counters.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flags</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>CounterType</code> and <code>Storage</code> encoded. Only the less significant bits are used as following:<br>
1st bit: <code>1</code> for <code>WEAK</code> counter and <code>0</code> for <code>STRONG</code> counter.<br>
2nd bit: <code>1</code> for <code>BOUNDED</code> counter and <code>0</code> for <code>UNBOUNDED</code> counter<br>
3rd bit: <code>1</code> for <code>PERSISTENT</code> storage and <code>0</code> for <code>VOLATILE</code> storage.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Concurrency Level</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) the counter&#8217;s concurrency-level.
Only present if the counter is <code>WEAK</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lower bound</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) the lower bound of a bounded counter.
Only present if the counter is <code>BOUNDED</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Upper bound</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) the upper bound of a bounded counter.
Only present if the counter is <code>BOUNDED</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initial value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s initial value.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Counter create operation</div>
<p>Creates a counter if it doesn&#8217;t exist.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Request (0x4B)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter Configuration</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s configuration.
See <a href="#counter_config_encode">CounterConfiguration encode</a>.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Response (0x4C)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response Header <code>Status</code> possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x00</code>: Operation successful.</p>
</li>
<li>
<p><code>0x01</code>: Operation failed. Counter is already defined.</p>
</li>
<li>
<p>See the <a href="#hot_rod_response_header">Reponse Header</a> for error codes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Counter get configuration operation</div>
<p>Returns the counter&#8217;s configuration.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Request (0x4D)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s name.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Response (0x4E)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter Configuration</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) The counter&#8217;s configuration.
Only present if <code>Status==0x00</code>.
See <a href="#counter_config_encode">CounterConfiguration encode</a>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response Header <code>Status</code> possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x00</code>: Operation successful.</p>
</li>
<li>
<p><code>0x02</code>: Counter doesn&#8217;t exist.</p>
</li>
<li>
<p>See the <a href="#hot_rod_response_header">Reponse Header</a> for error codes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Counter is defined operation</div>
<p>Checks if the counter is defined.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 17. Request (0x4F)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s name</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 18. Response (0x51)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response Header <code>Status</code> possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x00</code>: Counter is defined.</p>
</li>
<li>
<p><code>0x01</code>: Counter isn&#8217;t defined.</p>
</li>
<li>
<p>See the <a href="#hot_rod_response_header">Reponse Header</a> for error codes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Counter add-and-get operation</div>
<p>Adds a value to the counter and returns the new value.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 19. Request (0x52)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value to add</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 20. Response (0x53)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) the counter&#8217;s new value.
Only present if <code>Status==0x00</code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Since the <code>WeakCounter</code> doesn&#8217;t have access to the new value, the <code>value</code> is zero.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Response Header <code>Status</code> possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x00</code>: Operation successful.</p>
</li>
<li>
<p><code>0x02</code>: The counter isn&#8217;t defined.</p>
</li>
<li>
<p><code>0x04</code>: The counter reached its boundary. Only possible for <code>STRONG</code> counters.</p>
</li>
<li>
<p>See the <a href="#hot_rod_response_header">Reponse Header</a> for error codes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Counter reset operation</div>
<p>Resets the counter&#8217;s value.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 21. Request (0x54)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s name</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 22. Response (0x55)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response Header <code>Status</code> possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x00</code>: Operation successful.</p>
</li>
<li>
<p><code>0x02</code>: Counter isn&#8217;t defined.</p>
</li>
<li>
<p>See the <a href="#hot_rod_response_header">Reponse Header</a> for error codes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Counter get operation</div>
<p>Returns the counter&#8217;s value.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 23. Request (0x56)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s name</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 24. Response (0x57)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) the counter&#8217;s value.
Only present if <code>Status==0x00</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response Header <code>Status</code> possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x00</code>: Operation successful.</p>
</li>
<li>
<p><code>0x02</code>: Counter isn&#8217;t defined.</p>
</li>
<li>
<p>See the <a href="#hot_rod_response_header">Reponse Header</a> for error codes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Counter compare-and-swap operation</div>
<p>Compares and only updates the counter value if the current value is the expected.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 25. Request (0x58)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expect</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s expected value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s value to set.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 26. Response (0x59)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) the counter&#8217;s value.
Only present if <code>Status==0x00</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response Header <code>Status</code> possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x00</code>: Operation successful.</p>
</li>
<li>
<p><code>0x02</code>: The counter isn&#8217;t defined.</p>
</li>
<li>
<p><code>0x04</code>: The counter reached its boundary. Only possible for <code>STRONG</code> counters.</p>
</li>
<li>
<p>See the <a href="#hot_rod_response_header">Reponse Header</a> for error codes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Counter add and remove listener</div>
<p>Adds/Removes a listener for a counter</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 27. Request ADD (0x5A) / REMOVE (0x5C)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener-id</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The listener&#8217;s id</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 28. Response: ADD (0x5B) / REMOVE (0x5D)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response Header <code>Status</code> possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x00</code>: Operation successful and the connection used in the request will be used to send event (add) or the connection can be removed (remove).</p>
</li>
<li>
<p><code>0x01</code>: Operation successful and the current connection is still in use.</p>
</li>
<li>
<p><code>0x02</code>: The counter isn&#8217;t defined.</p>
</li>
<li>
<p>See the <a href="#hot_rod_response_header">Reponse Header</a> for error codes.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 29. Counter Event (0x66)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event header with operation code <code>0x66</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listener-id</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The listener&#8217;s id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encoded Counter State</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encoded old and new counter state. Bit set:<br>
<code>------00</code>: Valid old state<br>
<code>------01</code>: Lower bound reached old state<br>
<code>------10</code>: Upper bound reached old state<br>
<code>----00--</code>: Valid new state<br>
<code>----01--</code>: Lower bound reached new state<br>
<code>----10--</code>: Upper bound reached new state<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Old value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter&#8217;s old value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">New value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter&#8217;s new value</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All counters under a <code>CounterManager</code> implementation can use the same <code>listener-id</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A connection is dedicated to a single <code>listener-id</code> and can receive events from different counters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Counter remove operation</div>
<p>Removes the counter from the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The counter is re-created if it is accessed again.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 30. Request (0x5E)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The counter&#8217;s name</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 31. Response (0x5F)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response Header <code>Status</code> possible values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x00</code>: Operation successful.</p>
</li>
<li>
<p><code>0x02</code>: The counter isn&#8217;t defined.</p>
</li>
<li>
<p>See the <a href="#hot_rod_response_header">Reponse Header</a> for error codes.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_2_8"><a class="anchor" href="#hot_rod_protocol_2_8"></a>20.6.13. Hot Rod Protocol 2.8</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 9.3
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Events</div>
<p>The protocol allows clients to send requests on the same connection that was previously used for Add Client Listener
operation, and in protocol &lt; 2.8 is reserved for sending events to the client. This includes registering additional
listeners, therefore receiving events for multiple listeners.</p>
</div>
<div class="paragraph">
<p>The binary format of requests/responses/events does not change but the previously meaningless <code>messageId</code> in events
must be set to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>messageId</code> of the Add Client Listener operation for the include-current-state events</p>
</li>
<li>
<p><code>0</code> for the events sent after the Add Client Listener operation has been finished (response sent).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The same holds for counter events: client can send further requests after Counter Add Listener.
Previously meaningless <code>messageId</code> in counter event is always set to <code>0</code>.</p>
</div>
<div class="paragraph">
<p>These modifications of the protocol do not require any changes on the client side (as the client simply
won&#8217;t send additional operations if it does not support that; the changes are more permissive to the clients)
but the server has to handle load on the connection correctly.</p>
</div>
<div class="paragraph">
<div class="title">MediaType</div>
<p>This Hot Rod protocol version also adds support for specifying the MediaType of Keys and Values, allowing data
to be read (and written) in different formats. This information is part of the Header.</p>
</div>
<div class="paragraph">
<p>The data formats are described using a <em>MediaType</em> object, that is represented as follows:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00 = No MediaType supplied<br>
0x01 = Pre-defined MediaType supplied<br>
0x02 = Custom MediaType supplied<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) For a pre-defined MediaType (type=0x01), the Id of the MediaType. The currently supported Ids can be found at <a href="https://github.com/infinispan/infinispan/blob/master/commons/src/main/java/org/infinispan/commons/dataconversion/MediaTypeIds.java">MediaTypeIds</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">customString</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) If a custom MediaType is supplied (type=0x02), the custom MediaType of the key, including type and subtype. E.g.: <em>text/plain</em>, <em>application/json</em>, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paramSize</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The size of the parameters for the MediaType</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paramKey1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) The first parameter&#8217;s key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paramValue1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) The first parameter&#8217;s value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paramKeyN</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) The nth parameter&#8217;s key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paramValueN</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) The nth parameter&#8217;s value</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="request_header_7"><a class="anchor" href="#request_header_7"></a>Request Header</h5>
<div class="paragraph">
<p>The request header has the following extra fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Type</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Format</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MediaType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The MediaType to be used for keys during the operation. It applies to both the keys sent and received.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Format</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MediaType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Analogous to Key Format, but applied for the values.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_protocol_2_9"><a class="anchor" href="#hot_rod_protocol_2_9"></a>20.6.14. Hot Rod Protocol 2.9</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Infinispan versions</div>
This version of the protocol is implemented since Infinispan 9.4
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Compatibility Mode removal</div>
<p>The compatibility mode hint from the <em>Response status</em> fields from the operations is not sent anymore. Consequently, the following statuses are removed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x06</code>: Success status with compatibility mode.</p>
</li>
<li>
<p><code>0x07</code>: Success status with return previous value and compatibility mode.</p>
</li>
<li>
<p><code>0x08</code>: Not executed with return previous value and compatibility mode.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To figure out what is the server&#8217;s storage, the configured MediaType of keys and values are returned on the ping operation:</p>
</div>
<div class="paragraph">
<p>Ping Response (0x18):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as before</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response status</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">same as before</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Type</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MediaType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Media Type of the key stored in the server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Type</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">MediaType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Media Type of the value stored in the server</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">New query format</div>
<p>This version supports query requests and responses in JSON format. The format of the operations <strong>0x1F</strong> (Query Request) and <strong>0x20</strong> (Query Response) are not changed.</p>
</div>
<div class="paragraph">
<p>To send JSON payloads, the "Value Format" field in the header should be <em>application/json</em>.</p>
</div>
<div class="paragraph">
<p>Query Request (0x1F):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Request header</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Query Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The length of the UTF-8 encoded query object.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Query</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Byte array containing the JSON (UTF-8) encoded query object, having a length specified by the previous field. Example of payload:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{
 "query":"From Entity where field1:'value1'",
 "offset": 12,
 "max-results": 1000,
 "query-mode": "FETCH"
}</pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>query: the Ickle query String.
offset: the index of the first result to return.
max_results: the maximum number of results to return.
query_mode: the indexed query mode. Either FETCH or BROADCAST. FECTH is the default.</pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Query Response (0x20):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Response header</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response payload Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The length of the UTF-8 encoded response object</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response payload</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Byte array containing the JSON encoded response object, having a length specified by previous field. Example payload:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{
  "total_results":801,
  "hits":[
     {
        "hit":{
           "field1":565,
           "field2":"value2"
        }
     },
     {
        "hit":{
           "field1":34,
           "field2":"value22"
        }
     }
  ]
}</pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>total_results: the total number of results of the query.
hits: an ARRAY of OBJECT representing the results.
hit: each OBJECT above contain another OBJECT in the "hit" field, containing the result of the query, in JSON format.</pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Also, this version introduces 3 new operations for Hot Rod transactions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Prepare Request V2:
It adds new parameters to the request.
The response stays the same.</p>
</li>
<li>
<p>Forget Transaction Request:
Removes transaction information in the server.</p>
</li>
<li>
<p>Fetch In-Doubt Transactions Request:
Fetches all in-doubt transactions&#8217;s Xid.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Prepare Request V2</div>
<p>Request (0x7D):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Xid</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">XID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction ID (XID)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OnePhaseCommit</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When it is set to <code>1</code>, the server will use one-phase-commit if available (XA only)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recoverable</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set to <code>1</code> to allow recovery in this transactions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The idle timeout in milliseconds.
If the transaction isn&#8217;t recoverable (<code>Recoverable=0</code>), the server rollbacks the transaction if it has
been idle for this amount of time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of keys</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of keys</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock">For each key (keys must be distinct)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of key.
Note that the size of a vInt can be up to 5 bytes which in theory can produce bigger numbers than <code>Integer.MAX_VALUE</code>.
However, Java cannot create a single array thats bigger than <code>Integer.MAX_VALUE</code>, hence the protocol is limiting vInt array lengths to <code>Integer.MAX_VALUE</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte array containing the key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Control Byte</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A bit set with the following meaning:<br>
0x01 = <code>NOT_READ</code><br>
0x02 = <code>NON_EXISTING</code><br>
0x04 = <code>REMOVE_OPERATION</code><br>
Note that <code>NOT_READ</code> and <code>NON_EXISTING</code> can&#8217;t be set at the same time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version Read</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The version read. Only sent when <code>NOT_READ</code> and <code>NON_EXISTING</code> aren&#8217;t present.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TimeUnits</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time units of lifespan (first 4 bits) and maxIdle (last 4 bits).
Special units <code>DEFAULT</code> and <code>INFINITE</code> can be used for default server expiration and no expiration respectively.
Possible values:<br>
0x00 = <code>SECONDS</code><br>
0x01 = <code>MILLISECONDS</code><br>
0x02 = <code>NANOSECONDS</code><br>
0x03 = <code>MICROSECONDS</code><br>
0x04 = <code>MINUTES</code><br>
0x05 = <code>HOURS</code><br>
0x06 = <code>DAYS</code><br>
0x07 = <code>DEFAULT</code><br>
0x08 = <code>INFINITE</code><br>
Only sent when <code>REMOVE_OPERATION</code> isn&#8217;t set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifespan</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration which the entry is allowed to life.
Only sent when time unit is not <code>DEFAULT</code> or <code>INFINITE</code> and <code>REMOVE_OPERATION</code> isn&#8217;t set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max Idle</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vLong</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration that each entry can be idle before it&#8217;s evicted from the cache.
Only sent when time unit is not <code>DEFAULT</code> or <code>INFINITE</code> and <code>REMOVE_OPERATION</code> isn&#8217;t set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value Length</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Length of value.
Only sent if <code>REMOVE_OPERATION</code> isn&#8217;t set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">byte-array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value to be stored.
Only sent if <code>REMOVE_OPERATION</code> isn&#8217;t set.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x7E)</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XA return code</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The XA code representing the prepare response.<br>
Can be <code>XA_OK(0)</code>, <code>XA_RDONLY(3)</code> or any of the error codes (see <code>XaException</code>).<br>
This field isn&#8217;t present if the response state is different from <code>Successful</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Forget Transaction</div>
<p>Request (0x79)</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Xid</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">XID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction ID (XID)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x7A)</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Fetch in-doubt transactions</div>
<p>Request (0x7B)</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request header</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Response (0x7C)</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-center valign-top">Size</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of Xid</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">vInt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of Xid in response</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock">For each entry:</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Xid</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">XID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction ID (XID)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="hot_rod_hash_functions"><a class="anchor" href="#hot_rod_hash_functions"></a>20.6.15. Hot Rod Hash Functions</h4>
<div class="paragraph">
<p>Infinispan makes use of a consistent hash function to place nodes on a hash
wheel, and to place keys of entries on the same wheel to determine where
entries live.</p>
</div>
<div class="paragraph">
<p>In Infinispan 4.2 and earlier, the hash space was hardcoded to 10240, but
since 5.0, the hash space is
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Integer.html#MAX_VALUE">Integer.MAX_INT</a> .
Please note that since Hot Rod clients should not assume a particular hash
space by default, every time a hash-topology change is detected, this value is
sent back to the client via the Hot Rod protocol.</p>
</div>
<div class="paragraph">
<p>When interacting with Infinispan via the Hot Rod protocol, it is mandated
that keys (and values) are byte arrays, to ensure platform neutral behavior.
As such, smart-clients which are aware of hash distribution on the backend
would need to be able to calculate the hash codes of such byte array keys,
again in a platform-neutral manner. To this end, the hash functions used by
Infinispan are versioned and documented, so that it can be re-implemented by
non-Java clients if needed.</p>
</div>
<div class="paragraph">
<p>The version of the hash function in use is provided in the Hot Rod protocol,
as the hash function version parameter.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Version 1 (single byte, 0x01) The initial version of the hash function in
use is based on
<a href="https://github.com/infinispan/infinispan/blob/master/commons/src/main/java/org/infinispan/commons/hash/MurmurHash2.java">Austin Appleby&#8217;s MurmurHash 2.0 algorithm</a> , a fast, non-cryptographic hash that exhibits excellent distribution, collision resistance and avalanche behavior.  The specific version of the algorithm used is the slightly slower, endian-neutral version that allows consistent behavior across both big- and little-endian CPU architectures.  Infinispan&#8217;s version also hard-codes the hash seed as -1. For details of the algorithm, please visit <a href="http://sites.google.com/site/murmurhash/">Austin Appleby&#8217;s MurmurHash 2.0 page</a>.
Other implementations are detailed on
<a href="http://en.wikipedia.org/wiki/MurmurHash">Wikipedia</a> .
This hash function was the default one used by the Hot Rod server until Infinispan 4.2.1.
Since Infinispan 5.0, the server never uses hash version 1.
Since Infinispan 9.0, the client ignores hash version 1.</p>
</li>
<li>
<p>Version 2 (single byte, 0x02) Since Infinispan 5.0, a new hash function is
used by default which is based on
<a href="https://github.com/infinispan/infinispan/blob/master/commons/src/main/java/org/infinispan/commons/hash/MurmurHash3.java">Austin Appleby&#8217;s MurmurHash 3.0 algorithm</a>.
Detailed information about the hash function can be found in this
<a href="http://code.google.com/p/smhasher/wiki/MurmurHash3">wiki</a>.
Compared to 2.0, it provides better performance and spread.
Since Infinispan 7.0, the server only uses version 2 for HotRod 1.x clients.</p>
</li>
<li>
<p>Version 3 (single byte, 0x03) Since Infinispan 7.0, a new hash function is used by default.
The function is still based on
<a href="http://code.google.com/p/smhasher/wiki/MurmurHash3">wiki</a>,
but is also aware of the hash segments used in the server&#8217;s
<a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/distribution/ch/ConsistentHash.java">ConsistentHash</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_admin_tasks"><a class="anchor" href="#hot_rod_admin_tasks"></a>20.6.16. Hot Rod Admin Tasks</h4>
<div class="paragraph">
<p>Admin operations are handled by the Exec operation with a set of well known tasks. Admin tasks are named according to the following rules:</p>
</div>
<div class="paragraph">
<p><code>@@context@name</code></p>
</div>
<div class="paragraph">
<p>All parameters are UTF-8 encoded strings.
Parameters are specific to each task, with the exception of the <strong>flags</strong> parameter which is common to all commands.
The <strong>flags</strong> parameter contains zero or more space-separated values which may affect the behaviour of the command.
The following table lists all currently available flags.</p>
</div>
<div class="paragraph">
<p>Admin tasks return the result of the operation represented as a JSON string.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 32. FLAGS</caption>
<colgroup>
<col style="width: 23.0769%;">
<col style="width: 76.9231%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flag</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">permanent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requests that the command&#8217;s effect be made permanent into the server&#8217;s configuration. If the server cannot comply with the request, the entire operation will fail with an error</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="admin_tasks"><a class="anchor" href="#admin_tasks"></a>Admin tasks</h5>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 33. @@cache@create</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 66.6666%;">
<col style="width: 13.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the cache to create.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">template</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the cache configuration template to use for the new cache.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the XML declaration of a cache configuration to use.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">flags</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See the flags table above.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 34. @@cache@remove</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 66.6666%;">
<col style="width: 13.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the cache to remove.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">flags</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See the flags table above.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">@@cache@names</div>
<p>Returns the cache names as a JSON array of strings, e.g. ["cache1", "cache2"]</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 35. @@cache@reindex</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 66.6666%;">
<col style="width: 13.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the cache to reindex.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">flags</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See the flags table above.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No, all flags will be ignored</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="hotrod_java_client"><a class="anchor" href="#hotrod_java_client"></a>20.7. Java Hot Rod client</h3>
<div class="paragraph">
<p>Hot Rod is a binary, language neutral protocol. This article explains how a Java client can interact with a server via the Hot Rod protocol. A reference implementation of the protocol written in Java can be found in all Infinispan distributions, and this article focuses on the capabilities of this java client.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Looking for more clients?  Visit <a href="http://infinispan.org/hotrod-clients">this website</a> for clients written in a variety of different languages.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="configuration_9"><a class="anchor" href="#configuration_9"></a>20.7.1. Configuration</h4>
<div class="paragraph">
<p>The Java Hot Rod client can be configured both programmatically and externally, through a configuration file.</p>
</div>
<div class="paragraph">
<p>The code snippet below illustrates the creation of a client instance using the available Java fluent API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb
      = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.tcpNoDelay(<span class="predefined-constant">true</span>)
  .statistics()
      .enable()
      .jmxDomain(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan</span><span class="delimiter">&quot;</span></span>)
  .addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
      .port(<span class="integer">11222</span>);
RemoteCacheManager rmc = <span class="keyword">new</span> RemoteCacheManager(cb.build());</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete reference to the available configuration option please refer to the
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/configuration/ConfigurationBuilder.html">ConfigurationBuilder</a>'s javadoc.</p>
</div>
<div class="paragraph">
<p>It is also possible to configure the Java Hot Rod client using a properties file, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code># Hot Rod client configuration
infinispan.client.hotrod.server_list = 127.0.0.1:11222
infinispan.client.hotrod.marshaller = org.infinispan.commons.marshall.jboss.GenericJBossMarshaller
infinispan.client.hotrod.async_executor_factory = org.infinispan.client.hotrod.impl.async.DefaultAsyncExecutorFactory
infinispan.client.hotrod.default_executor_factory.pool_size = 1
infinispan.client.hotrod.hash_function_impl.2 = org.infinispan.client.hotrod.impl.consistenthash.ConsistentHashV2
infinispan.client.hotrod.tcp_no_delay = true
infinispan.client.hotrod.tcp_keep_alive = false
infinispan.client.hotrod.request_balancing_strategy = org.infinispan.client.hotrod.impl.transport.tcp.RoundRobinBalancingStrategy
infinispan.client.hotrod.key_size_estimate = 64
infinispan.client.hotrod.value_size_estimate = 512
infinispan.client.hotrod.force_return_values = false

## Connection pooling configuration
maxActive=-1
maxIdle = -1
whenExhaustedAction = 1
minEvictableIdleTimeMillis=300000
minIdle = 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The properties file is then passed to one of constructors of <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html#RemoteCacheManager-java.net.URL-">RemoteCacheManager</a>.
You can use property substitution to replace values at runtime with <a href="https://docs.oracle.com/javase/tutorial/essential/environment/sysprop.html">Java system properties</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>infinispan.client.hotrod.server_list = ${server_list}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the value of the <em>infinispan.client.hotrod.server_list</em> property will be expanded to the value of the <em>server_list</em> Java system property, which means that the value should be taken from a system property named <code>jboss.bind.address.management</code> and if it is not defined use 127.0.0.1.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To use <code>hotrod-client.properties</code> somewhere other than your classpath, do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
<span class="predefined-type">Properties</span> p = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
<span class="keyword">try</span>(<span class="predefined-type">Reader</span> r = <span class="keyword">new</span> <span class="predefined-type">FileReader</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/hotrod-client.properties</span><span class="delimiter">&quot;</span></span>)) {
   p.load(r);
   b.withProperties(p);
}
RemoteCacheManager rcm = <span class="keyword">new</span> RemoteCacheManager(b.build());</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For a complete reference of the available configuration options for the properties file please refer to <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/configuration/package-summary.html#package.description">remote client configuration</a> javadoc.</p>
</div>
</div>
<div class="sect3">
<h4 id="authentication"><a class="anchor" href="#authentication"></a>20.7.2. Authentication</h4>
<div class="paragraph">
<p>If the server has set up authentication, you need to configure your client accordingly. Depending on the mechs enabled on the server,
the client must provide the required information.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section is about client configuration. If you want to set up the server to require authentication, read the
<a href="../server_guide/server_guide.html#security:hotrod_auth">Hot Rod server authentication</a> section.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="digest_md5"><a class="anchor" href="#digest_md5"></a>DIGEST-MD5</h5>
<div class="paragraph">
<p>DIGEST-MD5 is the recommended approach for simple username/password authentication scenarios. If you are using the default
realm on the server (<em>"ApplicationRealm"</em>), all you need to do is provide your credentials as follows:</p>
</div>
<div class="listingblock">
<div class="title">Hot Rod client configuration with DIGEST-MD5 authentication</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">myuser</span><span class="delimiter">&quot;</span></span>)
            .password(<span class="string"><span class="delimiter">&quot;</span><span class="content">qwer1234!</span><span class="delimiter">&quot;</span></span>);
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="plain"><a class="anchor" href="#plain"></a>PLAIN</h5>
<div class="paragraph">
<p>The PLAIN mechanism is not really recommended unless the connection is also encrypted, as anyone can sniff the clear-text
password being sent along the wire.</p>
</div>
<div class="listingblock">
<div class="title">Hot Rod client configuration with DIGEST-MD5 authentication</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .authentication()
            .saslMechanism(<span class="string"><span class="delimiter">&quot;</span><span class="content">PLAIN</span><span class="delimiter">&quot;</span></span>)
            .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">myuser</span><span class="delimiter">&quot;</span></span>)
            .password(<span class="string"><span class="delimiter">&quot;</span><span class="content">qwer1234!</span><span class="delimiter">&quot;</span></span>);
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="external"><a class="anchor" href="#external"></a>EXTERNAL</h5>
<div class="paragraph">
<p>The EXTERNAL mechanism is special in that it doesn&#8217;t explicitly provide credentials but uses the client certificate as
identity. In order for this to work, in addition to the <em>TrustStore</em> (to validate the server certificate) you need to
provide a <em>KeyStore</em> (to supply the client certificate).</p>
</div>
<div class="listingblock">
<div class="title">Hot Rod client configuration with EXTERNAL authentication (client cert)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            <span class="comment">// TrustStore is a KeyStore which contains part of the server certificate chain (e.g. the CA Root public cert)</span>
            .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/truststore</span><span class="delimiter">&quot;</span></span>)
            .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray())
            <span class="comment">// KeyStore containing this client's own certificate</span>
            .keyStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/keystore</span><span class="delimiter">&quot;</span></span>)
            .keyStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">keystorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray())
        .authentication()
            .saslMechanism(<span class="string"><span class="delimiter">&quot;</span><span class="content">EXTERNAL</span><span class="delimiter">&quot;</span></span>);
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details, read the <a href="#hr_encryption">Encryption</a> section below.</p>
</div>
</div>
<div class="sect4">
<h5 id="gssapi_kerberos"><a class="anchor" href="#gssapi_kerberos"></a>GSSAPI (Kerberos)</h5>
<div class="paragraph">
<p>GSSAPI/Kerberos requires a much more complex setup, but it is used heavily in enterprises with centralized authentication
servers. To successfully authenticate with Kerberos, you need to create a <em>LoginContext</em>. This will obtain
a Ticket Granting Ticket (TGT) which will be used as a token to authenticate with the service.</p>
</div>
<div class="paragraph">
<p>You will need to define a login module in a login configuration file:</p>
</div>
<div class="listingblock">
<div class="title">gss.conf</div>
<div class="content">
<pre class="CodeRay highlight"><code>GssExample {
    com.sun.security.auth.module.Krb5LoginModule required client=TRUE;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using the IBM JDK, the above becomes:</p>
</div>
<div class="listingblock">
<div class="title">gss-ibm.conf</div>
<div class="content">
<pre class="CodeRay highlight"><code>GssExample {
    com.ibm.security.auth.module.Krb5LoginModule required client=TRUE;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will also need to set the following system properties:</p>
</div>
<div class="paragraph">
<p>java.security.auth.login.config=gss.conf</p>
</div>
<div class="paragraph">
<p>java.security.krb5.conf=/etc/krb5.conf</p>
</div>
<div class="paragraph">
<p>The krb5.conf file is dependent on your environment and needs to point to your KDC. Ensure that you can authenticate
via Kerberos using <em>kinit</em>.</p>
</div>
<div class="paragraph">
<p>Next up, configure your client as follows:</p>
</div>
<div class="listingblock">
<div class="title">Hot Rod client GSSAPI configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">LoginContext</span> lc = <span class="keyword">new</span> <span class="predefined-type">LoginContext</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">GssExample</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> BasicCallbackHandler(<span class="string"><span class="delimiter">&quot;</span><span class="content">krb_user</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">krb_password</span><span class="delimiter">&quot;</span></span>.toCharArray()));
lc.login();
<span class="predefined-type">Subject</span> clientSubject = lc.getSubject();

ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .authentication()
            .enable()
            .serverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-server</span><span class="delimiter">&quot;</span></span>)
            .saslMechanism(<span class="string"><span class="delimiter">&quot;</span><span class="content">GSSAPI</span><span class="delimiter">&quot;</span></span>)
            .clientSubject(clientSubject)
            .callbackHandler(<span class="keyword">new</span> BasicCallbackHandler());
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For brevity we used the same callback handler both for obtaining the client subject and for handling authentication in the SASL GSSAPI mech, however different callbacks will actually be invoked: NameCallback and PasswordCallback are needed to construct the client subject, while the AuthorizeCallback will be called during the SASL authentication.</p>
</div>
</div>
<div class="sect4">
<h5 id="custom_callbackhandlers"><a class="anchor" href="#custom_callbackhandlers"></a>Custom CallbackHandlers</h5>
<div class="paragraph">
<p>In all of the above examples, the Hot Rod client is setting up a default <em>CallbackHandler</em> for you that supplies the
provided credentials to the SASL mechanism. For advanced scenarios it may be necessary to provide your own custom
<em>CallbackHandler</em>:</p>
</div>
<div class="listingblock">
<div class="title">Hot Rod client configuration with authentication via callback</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyCallbackHandler</span> <span class="directive">implements</span> <span class="predefined-type">CallbackHandler</span> {
   <span class="directive">final</span> <span class="directive">private</span> <span class="predefined-type">String</span> username;
   <span class="directive">final</span> <span class="directive">private</span> <span class="type">char</span><span class="type">[]</span> password;
   <span class="directive">final</span> <span class="directive">private</span> <span class="predefined-type">String</span> realm;

   <span class="directive">public</span> MyCallbackHandler(<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> realm, <span class="type">char</span><span class="type">[]</span> password) {
      <span class="local-variable">this</span>.username = username;
      <span class="local-variable">this</span>.password = password;
      <span class="local-variable">this</span>.realm = realm;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> handle(<span class="predefined-type">Callback</span><span class="type">[]</span> callbacks) <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">UnsupportedCallbackException</span> {
      <span class="keyword">for</span> (<span class="predefined-type">Callback</span> callback : callbacks) {
         <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> <span class="predefined-type">NameCallback</span>) {
            <span class="predefined-type">NameCallback</span> nameCallback = (<span class="predefined-type">NameCallback</span>) callback;
            nameCallback.setName(username);
         } <span class="keyword">else</span> <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> <span class="predefined-type">PasswordCallback</span>) {
            <span class="predefined-type">PasswordCallback</span> passwordCallback = (<span class="predefined-type">PasswordCallback</span>) callback;
            passwordCallback.setPassword(password);
         } <span class="keyword">else</span> <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> <span class="predefined-type">AuthorizeCallback</span>) {
            <span class="predefined-type">AuthorizeCallback</span> authorizeCallback = (<span class="predefined-type">AuthorizeCallback</span>) callback;
            authorizeCallback.setAuthorized(authorizeCallback.getAuthenticationID().equals(
                  authorizeCallback.getAuthorizationID()));
         } <span class="keyword">else</span> <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> <span class="predefined-type">RealmCallback</span>) {
            <span class="predefined-type">RealmCallback</span> realmCallback = (<span class="predefined-type">RealmCallback</span>) callback;
            realmCallback.setText(realm);
         } <span class="keyword">else</span> {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedCallbackException</span>(callback);
         }
      }
   }
}

ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .authentication()
            .enable()
            .serverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">myhotrodserver</span><span class="delimiter">&quot;</span></span>)
            .saslMechanism(<span class="string"><span class="delimiter">&quot;</span><span class="content">DIGEST-MD5</span><span class="delimiter">&quot;</span></span>)
            .callbackHandler(<span class="keyword">new</span> MyCallbackHandler(<span class="string"><span class="delimiter">&quot;</span><span class="content">myuser</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ApplicationRealm</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">qwer1234!</span><span class="delimiter">&quot;</span></span>.toCharArray()));
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actual type of callbacks that your CallbackHandler will need to be able to handle are mech-specific, so the above is just a simple example.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="hr_encryption"><a class="anchor" href="#hr_encryption"></a>20.7.3. Encryption</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section is about client configuration. If you want to set up the server to require encryption, read the
<a href="../server_guide/server_guide.html#security:hotrod_rest_encryption">Hot Rod server encryption</a> section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Encryption uses TLS/SSL, so it requires setting up an appropriate server certificate chain. Generally, a certificate chain looks like the following:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/cert_chain.png" alt="cert chain">
</div>
<div class="title">Figure 16. Certificate chain</div>
</div>
<div class="paragraph">
<p>In the above example there is one certificate authority <em>"CA"</em> which has issued a certificate for <em>"HotRodServer"</em>.
In order for a client to trust the server, it needs at least a portion of the above chain (usually, just the public certificate for <em>"CA"</em>).
This certificate needs to placed in a keystore and used as a <em>TrustStore</em> on the client and used as shown below:</p>
</div>
<div class="listingblock">
<div class="title">Hot Rod client configuration with TLS (server cert)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            <span class="comment">// TrustStore is a KeyStore which contains part of the server certificate chain (e.g. the CA Root public cert)</span>
            .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/truststore</span><span class="delimiter">&quot;</span></span>)
            .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="sni"><a class="anchor" href="#sni"></a>SNI</h5>
<div class="paragraph">
<p>The server may have been configured with TLS/SNI support (<a href="https://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication</a>).
This means that the server is presenting multiple identities (probably bound to separate cache containers). The client
can specify which identity to connect to by specifying its name:</p>
</div>
<div class="listingblock">
<div class="title">Hot Rod client configuration with SNI (server cert)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            .sniHostName(<span class="string"><span class="delimiter">&quot;</span><span class="content">myservername</span><span class="delimiter">&quot;</span></span>)
            <span class="comment">// TrustStore is a KeyStore which contains part of the server certificate chain (e.g. the CA Root public cert)</span>
            .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/truststore</span><span class="delimiter">&quot;</span></span>)
            .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="client_certificates"><a class="anchor" href="#client_certificates"></a>Client certificates</h5>
<div class="paragraph">
<p>With the above configurations the client trusts the server. For increased security, a server administrator may have
set up the server to require the client to offer a valid certificate for mutual trust. This kind of configuration
requires the client to present its own certificate, usually issued by the same certificate authority as the server.
This certificate must be stored in a keystore and used as follows:</p>
</div>
<div class="listingblock">
<div class="title">Hot Rod client configuration with TLS (server and client cert)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            <span class="comment">// TrustStore is a KeyStore which contains part of the server certificate chain (e.g. the CA Root public cert)</span>
            .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/truststore</span><span class="delimiter">&quot;</span></span>)
            .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray())
            <span class="comment">// KeyStore containing this client's own certificate</span>
            .keyStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/keystore</span><span class="delimiter">&quot;</span></span>)
            .keyStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">keystorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray())
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please read the <a href="{jdkroot}/technotes/tools/unix/keytool.html">KeyTool</a> documentation for more details on KeyStores.
Additionally, the <a href="http://keystore-explorer.org/">KeyStore Explorer</a> is a great GUI tool for easily managing KeyStores.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="hr_basic_api"><a class="anchor" href="#hr_basic_api"></a>20.7.4. Basic API</h4>
<div class="paragraph">
<p>Below is a sample code snippet on how the client API can be used to store or retrieve information from a Hot Rod server using the Java Hot Rod client. It assumes that a Hot Rod server has been started bound to the default location (localhost:11222)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//API entry point, by default it connects to localhost:11222</span>
CacheContainer cacheContainer = <span class="keyword">new</span> RemoteCacheManager();

<span class="comment">//obtain a handle to the remote default cache</span>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheContainer.getCache();

<span class="comment">//now add something to the cache and make sure it is there</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>).equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);

<span class="comment">//remove the data</span>
cache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> !cache.containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>) : <span class="string"><span class="delimiter">&quot;</span><span class="content">Value must have been removed!</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client API maps the local API: <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> corresponds to <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/DefaultCacheManager.html">DefaultCacheManager</a> (both implement <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/CacheContainer.html">CacheContainer</a> ). This common API facilitates an easy migration from local calls to remote calls through Hot Rod: all one needs to do is switch between <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/DefaultCacheManager.html">DefaultCacheManager</a> and <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> - which is further simplified by the common <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/manager/CacheContainer.html">CacheContainer</a> interface that both inherit.</p>
</div>
</div>
<div class="sect3">
<h4 id="remotecache_keyset_entryset_values"><a class="anchor" href="#remotecache_keyset_entryset_values"></a>20.7.5. RemoteCache(.keySet|.entrySet|.values)</h4>
<div class="paragraph">
<p>The collection methods <code>keySet</code>, <code>entrySet</code> and <code>values</code> are backed by the remote cache.
That is that every method is called back into the <code>RemoteCache</code>. This is useful as
it allows for the various keys, entries or values to be retrieved lazily, and not
requiring them all be stored in the client memory at once if the user does not want.
These collections adhere to the <code>Map</code> specification being that <code>add</code> and <code>addAll</code>
are not supported but all other methods are supported.</p>
</div>
<div class="paragraph">
<p>One thing to note is the <code>Iterator.remove</code> and <code>Set.remove</code> or <code>Collection.remove</code>
methods require more than 1 round trip to the server to operate. You can check
out the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a>
Javadoc to see more details about these and the other methods.</p>
</div>
<div class="paragraph">
<p><strong>Iterator Usage</strong></p>
</div>
<div class="paragraph">
<p>The iterator method of these collections uses <code>retrieveEntries</code> internally, which
is described below. If you notice <code>retrieveEntries</code> takes an argument for the batch
size. There is no way to provide this to the iterator. As such the batch size can be
configured via system property <code>infinispan.client.hotrod.batch_size</code> or through
the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/configuraion/ConfigurationBuilder.html#batchSize-int-">ConfigurationBuilder</a>
when configuring the <code>RemoteCacheManager</code>.</p>
</div>
<div class="paragraph">
<p>Also the <code>retrieveEntries</code> iterator returned is <code>Closeable</code> as such the iterators
from <code>keySet</code>, <code>entrySet</code> and <code>values</code> return an <code>AutoCloseable</code> variant. Therefore
you should always close these `Iterator`s when you are done with them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (CloseableIterator&lt;Entry&lt;K, V&gt;&gt; iterator = remoteCache.entrySet().iterator) {
 ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>What if I want a deep copy and not a backing collection?</strong></p>
</div>
<div class="paragraph">
<p>Previous version of <code>RemoteCache</code> allowed for the retrieval of a deep copy
of the <code>keySet</code>. This is still possible with the new backing map, you just
have to copy the contents yourself. Also you can do this with <code>entrySet</code> and
<code>values</code>, which we didn&#8217;t support before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;K&gt; keysCopy = remoteCache.keySet().stream().collect(Collectors.toSet());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please use extreme cautiong with this as a large number of keys can and will cause
OutOfMemoryError in the client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span> keys = remoteCache.keySet();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="remote_iterator"><a class="anchor" href="#remote_iterator"></a>20.7.6. Remote Iterator</h4>
<div class="paragraph">
<p>Alternatively, if memory is a concern (different batch size) or you wish to do server side
filtering or conversion), use the remote iterator api to retrieve entries from the server.
With this method you can limit the entries that are retrieved or even returned a converted
value if you dont' need all properties of your entry.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Retrieve all entries in batches of 1000</span>
<span class="type">int</span> batchSize = <span class="integer">1000</span>;
<span class="keyword">try</span> (CloseableIterator&lt;Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt;&gt; iterator = remoteCache.retrieveEntries(<span class="predefined-constant">null</span>, batchSize)) {
     <span class="keyword">while</span>(iterator.hasNext()) {
        <span class="comment">// Do something</span>
     }
}

<span class="comment">// Filter by segment</span>
<span class="predefined-type">Set</span>&lt;<span class="predefined-type">Integer</span>&gt; segments = ...
try (CloseableIterator&lt;Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt;&gt; iterator = remoteCache.retrieveEntries(<span class="predefined-constant">null</span>, segments, batchSize)) {
     <span class="keyword">while</span>(iterator.hasNext()) {
        <span class="comment">// Do something</span>
     }
}

<span class="comment">// Filter by custom filter</span>
<span class="keyword">try</span> (CloseableIterator&lt;Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt;&gt; iterator = remoteCache.retrieveEntries(<span class="string"><span class="delimiter">&quot;</span><span class="content">myFilterConverterFactory</span><span class="delimiter">&quot;</span></span>, segments, batchSize)) {
     <span class="keyword">while</span>(iterator.hasNext()) {
        <span class="comment">// Do something</span>
     }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to use custom filters, it&#8217;s necessary to deploy them first in the server. Follow the steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a factory for the filter extending <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/filter/KeyValueFilterConverterFactory.html">KeyValueFilterConverterFactory</a>, annotated with @NamedFactory containing the name of the factory, example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.io.Serializable</span>;

<span class="keyword">import</span> <span class="include">org.infinispan.filter.AbstractKeyValueFilterConverter</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.KeyValueFilterConverter</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.KeyValueFilterConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.NamedFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.metadata.Metadata</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">myFilterConverterFactory</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyKeyValueFilterConverterFactory</span> <span class="directive">implements</span> KeyValueFilterConverterFactory {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> KeyValueFilterConverter&lt;<span class="predefined-type">String</span>, SampleEntity1, SampleEntity2&gt; getFilterConverter() {
      <span class="keyword">return</span> <span class="keyword">new</span> MyKeyValueFilterConverter();
   }
   <span class="comment">// Filter implementation. Should be serializable or externalizable for DIST caches</span>
   <span class="directive">static</span> <span class="type">class</span> <span class="class">MyKeyValueFilterConverter</span> <span class="directive">extends</span> AbstractKeyValueFilterConverter&lt;<span class="predefined-type">String</span>, SampleEntity1, SampleEntity2&gt; <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
      <span class="annotation">@Override</span>
      <span class="directive">public</span> SampleEntity2 filterAndConvert(<span class="predefined-type">String</span> key, SampleEntity1 entity, Metadata metadata) {
         <span class="comment">// returning null will case the entry to be filtered out</span>
         <span class="comment">// return SampleEntity2 will convert from the cache type SampleEntity1</span>
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> MediaType format() {
         <span class="comment">// returns the MediaType that data should be presented to this converter.</span>
         <span class="comment">// When ommitted, the server will use &quot;application/x-java-object&quot;.</span>
         <span class="comment">// Returning null will cause the filter/converter to be done in the storage format.</span>
      }
   }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a jar with a <code>META-INF/services/org.infinispan.filter.KeyValueFilterConverterFactory</code> file and within it, write the fully qualified class name of the filter factory class implementation.</p>
</li>
<li>
<p>Optional: If the filter uses custom key/value classes, these must be included in the JAR so that the filter can correctly unmarshall key and/or value instances.</p>
</li>
<li>
<p>Deploy the JAR file in the Infinispan Server.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="hr_versioned_api"><a class="anchor" href="#hr_versioned_api"></a>20.7.7. Versioned API</h4>
<div class="paragraph">
<p>A RemoteCacheManager provides instances of <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interface that represents a handle to the named or default cache on the remote cluster.
API wise, it extends the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html">Cache</a> interface to which it also adds some new methods, including the so called versioned API.
Please find below some examples of this API link:#server_hotrod_failover[but to understand the motivation behind it, make sure you read this section.</p>
</div>
<div class="paragraph">
<p>The code snippet bellow depicts the usage of these versioned methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// To use the versioned API, remote classes are specifically needed</span>
RemoteCacheManager remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager();
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache();

remoteCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);
RemoteCache.VersionedValue valueBinary = remoteCache.getVersioned(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// removal only takes place only if the version has not been changed</span>
<span class="comment">// in between. (a new version is associated with 'car' key on each change)</span>
<span class="keyword">assert</span> remoteCache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, valueBinary.getVersion());
<span class="keyword">assert</span> !cache.containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a similar way, for replace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">remoteCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);
RemoteCache.VersionedValue valueBinary = remoteCache.getVersioned(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> remoteCache.replace(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">lamborghini</span><span class="delimiter">&quot;</span></span>, valueBinary.getVersion());</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details on versioned operations refer to <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> 's javadoc.</p>
</div>
</div>
<div class="sect3">
<h4 id="async_api"><a class="anchor" href="#async_api"></a>20.7.8. Async API</h4>
<div class="paragraph">
<p>This is "borrowed" from the Infinispan core and it is largely discussed <a href="#cache_asynchronous_api">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="streaming_api"><a class="anchor" href="#streaming_api"></a>20.7.9. Streaming API</h4>
<div class="paragraph">
<p>When sending / receiving large objects, it might make sense to stream them between the client and the server. The
Streaming API implements methods similar to the <a href="#hr_basic_api">Hot Rod Basic API</a> and <a href="#hr_versioned_api">Hot Rod Versioned API</a> described above but, instead of taking the value as a parameter,
they return instances of InputStream and OutputStream. The following example shows how one would write a potentially large
object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteStreamingCache&lt;<span class="predefined-type">String</span>&gt; streamingCache = remoteCache.streaming();
<span class="predefined-type">OutputStream</span> os = streamingCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">a_large_object</span><span class="delimiter">&quot;</span></span>);
os.write(...);
os.close();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reading such an object through streaming:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteStreamingCache&lt;<span class="predefined-type">String</span>&gt; streamingCache = remoteCache.streaming();
<span class="predefined-type">InputStream</span> is = streamingCache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">a_large_object</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">for</span>(<span class="type">int</span> b = is.read(); b &gt;= <span class="integer">0</span>; b = is.read()) {
   ...
}
is.close();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The streaming API does <strong>not</strong> apply marshalling/unmarshalling to the values. For this reason you cannot access
the same entries using both the streaming and non-streaming API at the same time, unless you provide your own
marshaller to detect this situation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The InputStream returned by the <code>RemoteStreamingCache.get(K key)</code> method implements the <code>VersionedMetadata</code> interface, so
you can retrieve version and expiration information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteStreamingCache&lt;<span class="predefined-type">String</span>&gt; streamingCache = remoteCache.streaming();
<span class="predefined-type">InputStream</span> is = streamingCache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">a_large_object</span><span class="delimiter">&quot;</span></span>);
<span class="type">int</span> version = ((VersionedMetadata) is).getVersion();
<span class="keyword">for</span>(<span class="type">int</span> b = is.read(); b &gt;= <span class="integer">0</span>; b = is.read()) {
   ...
}
is.close();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Conditional write methods (<code>putIfAbsent</code>, <code>replace</code>) only perform the actual condition check once the value has
been completely sent to the server (i.e. when the <code>close()</code> method has been invoked on the <code>OutputStream</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="creating_event_listeners"><a class="anchor" href="#creating_event_listeners"></a>20.7.10. Creating Event Listeners</h4>
<div class="paragraph">
<p>Java Hot Rod clients can register listeners to receive cache-entry level events.
Cache entry created, modified and removed events are supported.</p>
</div>
<div class="paragraph">
<p>Creating a client listener is very similar to embedded listeners, except that
different annotations and event classes are used. Here&#8217;s an example of a
client listener that prints out each event received:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.annotation</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.event</span>.*;

<span class="annotation">@ClientListener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">EventPrintListener</span> {

   <span class="annotation">@ClientCacheEntryCreated</span>
   <span class="directive">public</span> <span class="type">void</span> handleCreatedEvent(ClientCacheEntryCreatedEvent e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

   <span class="annotation">@ClientCacheEntryModified</span>
   <span class="directive">public</span> <span class="type">void</span> handleModifiedEvent(ClientCacheEntryModifiedEvent e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

   <span class="annotation">@ClientCacheEntryRemoved</span>
   <span class="directive">public</span> <span class="type">void</span> handleRemovedEvent(ClientCacheEntryRemovedEvent e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ClientCacheEntryCreatedEvent</code> and <code>ClientCacheEntryModifiedEvent</code> instances
provide information on the affected key, and the version of the entry. This
version can be used to invoke conditional operations on the server, such as
<code>replaceWithVersion</code> or <code>removeWithVersion</code>.</p>
</div>
<div class="paragraph">
<p><code>ClientCacheEntryRemovedEvent</code> events are only sent when the remove operation
succeeds. In other words, if a remove operation is invoked but no entry is
found or no entry should be removed, no event is generated. Users interested
in removed events, even when no entry was removed, can develop event
customization logic to generate such events. More information can be found
in the <a href="#customizing_events">customizing client events section</a>.</p>
</div>
<div class="paragraph">
<p>All <code>ClientCacheEntryCreatedEvent</code>, <code>ClientCacheEntryModifiedEvent</code> and
<code>ClientCacheEntryRemovedEvent</code> event instances also provide a <code>boolean isCommandRetried()</code>
method that will return true if the write command that caused this had to be retried
again due to a topology change.  This could be a sign that this event
has been duplicated or another event was dropped and replaced
(eg: ClientCacheEntryModifiedEvent replaced ClientCacheEntryCreatedEvent).</p>
</div>
<div class="paragraph">
<p>Once the client listener implementation has been created, it needs to be
registered with the server. To do so, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener());</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="removing_event_listeners"><a class="anchor" href="#removing_event_listeners"></a>20.7.11. Removing Event Listeners</h4>
<div class="paragraph">
<p>When an client event listener is not needed any more, it can be removed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EventPrintListener listener = ...
cache.removeClientListener(listener);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="filtering_events"><a class="anchor" href="#filtering_events"></a>20.7.12. Filtering Events</h4>
<div class="paragraph">
<p>In order to avoid inundating clients with events, users can provide filtering
functionality to limit the number of events fired by the server for a
particular client listener. To enable filtering, a cache event filter factory
needs to be created that produces filter instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.NamedFactory</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-filter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">StaticCacheEventFilterFactory</span> <span class="directive">implements</span> CacheEventFilterFactory {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> CacheEventFilterFactory&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; getFilter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> StaticCacheEventFilter();
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// needed when running in a cluster</span>
<span class="type">class</span> <span class="class">StaticCacheEventFilter</span> <span class="directive">implements</span> CacheEventFilter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;, <span class="predefined-type">Serializable</span> {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> accept(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="keyword">if</span> (key.equals(<span class="integer">1</span>)) <span class="comment">// static key</span>
         <span class="keyword">return</span> <span class="predefined-constant">true</span>;

      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cache event filter factory instance defined above creates filter instances
which statically filter out all entries except the one whose key is <code>1</code>.</p>
</div>
<div class="paragraph">
<p>To be able to register a listener with this cache event filter factory,
the factory has to be given a unique name, and the Hot Rod server needs to be
plugged with the name and the cache event filter factory instance. Plugging the
Infinispan Server with a custom filter involves the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a JAR file with the filter implementation within it.</p>
</li>
<li>
<p>Optional: If the cache uses custom key/value classes, these must be
included in the JAR so that the callbacks can be executed with the correctly
unmarshalled key and/or value instances. If the client listener has <code>useRawData</code>
enabled, this is not necessary since the callback key/value instances will be
provided in binary format.</p>
</li>
<li>
<p>Create a <code>META-INF/services/org.infinispan.notifications.cachelistener.filter.CacheEventFilterFactory</code> file
within the JAR file and within it, write the fully qualified class name of the
filter class implementation.</p>
</li>
<li>
<p>Deploy the JAR file in the Infinispan Server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On top of that, the client listener needs to be linked with this cache event
filter factory by adding the factory&#8217;s name to the @ClientListener annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientListener</span>(filterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-filter</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">EventPrintListener</span> { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>And, register the listener with the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dynamic filter instances that filter based on parameters provided when the
listener is registered are also possible. Filters use the parameters received
by the filter factories to enable this option. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventFilter</span>;

<span class="type">class</span> <span class="class">DynamicCacheEventFilterFactory</span> <span class="directive">implements</span> CacheEventFilterFactory {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> CacheEventFilter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; getFilter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> DynamicCacheEventFilter(params);
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// needed when running in a cluster</span>
<span class="type">class</span> <span class="class">DynamicCacheEventFilter</span> <span class="directive">implements</span> CacheEventFilter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params;

   DynamicCacheEventFilter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="local-variable">this</span>.params = params;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> accept(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="keyword">if</span> (key.equals(params[<span class="integer">0</span>])) <span class="comment">// dynamic key</span>
         <span class="keyword">return</span> <span class="predefined-constant">true</span>;

      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The dynamic parameters required to do the filtering are provided when the
listener is registered:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener(), <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1</span>}, <span class="predefined-constant">null</span>);</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Filter instances have to marshallable when they are deployed in a
cluster so that the filtering can happen right where the event is generated,
even if the even is generated in a different node to where the listener is
registered. To make them marshallable, either make them extend <code>Serializable</code>,
<code>Externalizable</code>, or provide a custom <code>Externalizer</code> for them.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="skipping_notifications"><a class="anchor" href="#skipping_notifications"></a>20.7.13. Skipping Notifications</h4>
<div class="paragraph">
<p>Include the <code>SKIP_LISTENER_NOTIFICATION</code> flag when calling remote API methods to
perform operations without getting event notifications from the server.
For example, to prevent listener notifications when creating or modifying
values, set the flag as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">remoteCache.withFlags(Flag.SKIP_LISTENER_NOTIFICATION).put(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>SKIP_LISTENER_NOTIFICATION</code> flag is available from Infinispan version
9.4.15.
You must upgrade both the Infinispan and Hot Rod client to this version or later before you can set the flag.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="customizing_events"><a class="anchor" href="#customizing_events"></a>20.7.14. Customizing Events</h4>
<div class="paragraph">
<p>The events generated by default contain just enough information to make the
event relevant but they avoid cramming too much information in order to reduce
the cost of sending them. Optionally, the information shipped in the events
can be customised in order to contain more information, such as values, or to
contain even less information. This customization is done with <code>CacheEventConverter</code>
instances generated by a <code>CacheEventConverterFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverter</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.NamedFactory</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-converter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">StaticConverterFactory</span> <span class="directive">implements</span> CacheEventConverterFactory {
   <span class="directive">final</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; staticConverter = <span class="keyword">new</span> StaticCacheEventConverter();
   <span class="directive">public</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; getConverter(<span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> staticConverter;
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// needed when running in a cluster</span>
<span class="type">class</span> <span class="class">StaticCacheEventConverter</span> <span class="directive">implements</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">public</span> CustomEvent convert(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata, <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, newValue);
   }
}

<span class="comment">// Needs to be Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// regardless of cluster or local caches</span>
<span class="directive">static</span> <span class="type">class</span> <span class="class">CustomEvent</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Integer</span> key;
   <span class="directive">final</span> <span class="predefined-type">String</span> value;
   CustomEvent(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> value) {
      <span class="local-variable">this</span>.key = key;
      <span class="local-variable">this</span>.value = value;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, the converter generates a new custom event which
includes the value as well as the key in the event. This will result in bigger
event payloads compared with default events, but if combined with filtering,
it can reduce its network bandwidth cost.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The target type of the converter must be either <code>Serializable</code> or
<code>Externalizable</code>. In this particular case of converters, providing an
Externalizer will not work by default since the default Hot Rod client
marshaller does not support them.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Handling custom events requires a slightly different client listener
implementation to the one demonstrated previously. To be more precise, it
needs to handle <code>ClientCacheEntryCustomEvent</code> instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.annotation</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.event</span>.*;

<span class="annotation">@ClientListener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomEventPrintListener</span> {

   <span class="annotation">@ClientCacheEntryCreated</span>
   <span class="annotation">@ClientCacheEntryModified</span>
   <span class="annotation">@ClientCacheEntryRemoved</span>
   <span class="directive">public</span> <span class="type">void</span> handleCustomEvent(ClientCacheEntryCustomEvent&lt;CustomEvent&gt; e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ClientCacheEntryCustomEvent</code> received in the callback exposes the custom
event via <code>getEventData</code> method, and the <code>getType</code> method provides information
on whether the event generated was as a result of cache entry creation,
modification or removal.</p>
</div>
<div class="paragraph">
<p>Similar to filtering, to be able to register a listener with this converter factory,
the factory has to be given a unique name, and the Hot Rod server needs to be
plugged with the name and the cache event converter factory instance. Plugging the
Infinispan Server with an event converter involves the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a JAR file with the converter implementation within it.</p>
</li>
<li>
<p>Optional: If the cache uses custom key/value classes, these must be
included in the JAR so that the callbacks can be executed with the correctly
unmarshalled key and/or value instances. If the client listener has <code>useRawData</code>
enabled, this is not necessary since the callback key/value instances will be
provided in binary format.</p>
</li>
<li>
<p>Create a <code>META-INF/services/org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</code> file
within the JAR file and within it, write the fully qualified class name of the
converter class implementation.</p>
</li>
<li>
<p>Deploy the JAR file in the Infinispan Server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On top of that, the client listener needs to be linked with this converter
factory by adding the factory&#8217;s name to the @ClientListener annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientListener</span>(converterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-converter</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomEventPrintListener</span> { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>And, register the listener with the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> CustomEventPrintListener());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dynamic converter instances that convert based on parameters provided when the
listener is registered are also possible. Converters use the parameters received
by the converter factories to enable this option. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverter</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-converter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">DynamicCacheEventConverterFactory</span> <span class="directive">implements</span> CacheEventConverterFactory {
   <span class="directive">public</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; getConverter(<span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> DynamicCacheEventConverter(params);
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers needed when running in a cluster</span>
<span class="type">class</span> <span class="class">DynamicCacheEventConverter</span> <span class="directive">implements</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params;

   DynamicCacheEventConverter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="local-variable">this</span>.params = params;
   }

   <span class="directive">public</span> CustomEvent convert(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="comment">// If the key matches a key given via parameter, only send the key information</span>
      <span class="keyword">if</span> (params[<span class="integer">0</span>].equals(key))
         <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, <span class="predefined-constant">null</span>);

      <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, newValue);
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The dynamic parameters required to do the conversion are provided when the
listener is registered:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener(), <span class="predefined-constant">null</span>, <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1</span>});</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Converter instances have to marshallable when they are deployed in a
cluster, so that the conversion can happen right where the event is generated,
even if the even is generated in a different node to where the listener is
registered. To make them marshallable, either make them extend <code>Serializable</code>,
<code>Externalizable</code>, or provide a custom <code>Externalizer</code> for them.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="filter_and_custom_events"><a class="anchor" href="#filter_and_custom_events"></a>20.7.15. Filter and Custom Events</h4>
<div class="paragraph">
<p>If you want to do both event filtering and customization, it&#8217;s easier to
implement <code>org.infinispan.notifications.cachelistener.filter.CacheEventFilterConverter</code>
which allows both filter and customization to happen in a single step.
For convenience, it&#8217;s recommended to extend
<code>org.infinispan.notifications.cachelistener.filter.AbstractCacheEventFilterConverter</code>
instead of implementing <code>org.infinispan.notifications.cachelistener.filter.CacheEventFilterConverter</code>
directly. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverter</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-filter-converter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">DynamicCacheEventFilterConverterFactory</span> <span class="directive">implements</span> CacheEventFilterConverterFactory {
   <span class="directive">public</span> CacheEventFilterConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; getFilterConverter(<span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> DynamicCacheEventFilterConverter(params);
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers needed when running in a cluster</span>
<span class="comment">//</span>
<span class="type">class</span> <span class="class">DynamicCacheEventFilterConverter</span> <span class="directive">extends</span> AbstractCacheEventFilterConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params;

   DynamicCacheEventFilterConverter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="local-variable">this</span>.params = params;
   }

   <span class="directive">public</span> CustomEvent filterAndConvert(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="comment">// If the key matches a key given via parameter, only send the key information</span>
      <span class="keyword">if</span> (params[<span class="integer">0</span>].equals(key))
         <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, <span class="predefined-constant">null</span>);

      <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, newValue);
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to filters and converters, to be able to register a listener with this
combined filter/converter factory, the factory has to be given a unique name via the
<code>@NamedFactory</code> annotation, and the Hot Rod server needs to be plugged with the
name and the cache event converter factory instance. Plugging the Infinispan
Server with an event converter involves the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a JAR file with the converter implementation within it.</p>
</li>
<li>
<p>Optional: If the cache uses custom key/value classes, these must be
included in the JAR so that the callbacks can be executed with the correctly
unmarshalled key and/or value instances. If the client listener has <code>useRawData</code>
enabled, this is not necessary since the callback key/value instances will be
provided in binary format.</p>
</li>
<li>
<p>Create a <code>META-INF/services/org.infinispan.notifications.cachelistener.filter.CacheEventFilterConverterFactory</code> file
within the JAR file and within it, write the fully qualified class name of the
converter class implementation.</p>
</li>
<li>
<p>Deploy the JAR file in the Infinispan Server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>From a client perspective, to be able to use the combined filter and
converter class, the client listener must define the same filter factory and
converter factory names, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientListener</span>(filterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-filter-converter</span><span class="delimiter">&quot;</span></span>, converterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-filter-converter</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomEventPrintListener</span> { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The dynamic parameters required in the example above are provided when the
listener is registered via either filter or converter parameters. If filter
parameters are non-empty, those are used, otherwise, the converter parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> CustomEventPrintListener(), <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1</span>}, <span class="predefined-constant">null</span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="event_marshalling"><a class="anchor" href="#event_marshalling"></a>20.7.16. Event Marshalling</h4>
<div class="paragraph">
<p>Hot Rod servers can store data in different formats, but in spite of that,
Java Hot Rod client users can still develop <code>CacheEventConverter</code> or <code>CacheEventFilter</code>
instances that work on typed objects. By default, filters and converter will use data as POJO
(application/x-java-object) but it is possible to override the desired format by overriding the
method <code>format()</code> from the filter/converter. If the format returns <code>null</code>, the filter/converter will receive
data as it&#8217;s stored.</p>
</div>
<div class="paragraph">
<p>As indicated in the <a href="#hot_rod_marshalling_data">Marshalling Data</a> section, Hot Rod
Java clients can be configured to use a different <code>org.infinispan.commons.marshall.Marshaller</code>
instance. If doing this and deploying <code>CacheEventConverter</code> or <code>CacheEventFilter</code> instances,
to be able to present filters/converter with Java Objects rather than marshalled content,
the server needs to be able to convert between objects and the binary format produced
by the marshaller.</p>
</div>
<div class="paragraph">
<p>To deploy a Marshaller instance server-side, follow a similar method to the one
used to deploy <code>CacheEventConverter</code> or <code>CacheEventFilter</code> instances:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a JAR file with the converter implementation within it.</p>
</li>
<li>
<p>Create a <code>META-INF/services/org.infinispan.commons.marshall.Marshaller</code> file
within the JAR file and within it, write the fully qualified class name of the
marshaller class implementation.</p>
</li>
<li>
<p>Deploy the JAR file in the Infinispan Server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that the Marshaller could be deployed in either a separate jar, or in the
same jar as the <code>CacheEventConverter</code> and/or <code>CacheEventFilter</code> instances.</p>
</div>
<div class="sect4">
<h5 id="protostream_deployment"><a class="anchor" href="#protostream_deployment"></a>Deploying Protostream Marshallers</h5>
<div class="paragraph">
<p>If a cache stores protobuf content, as it happens when using protostream marshaller in the Hot Rod client,
it&#8217;s not necessary to deploy a custom marshaller since the format is already support by the server: there are
transcoders from protobuf format to most common formats like JSON and POJO.</p>
</div>
<div class="paragraph">
<p>When using filters/converters with those caches, and it&#8217;s desirable to use filter/converters with Java Objects rather binary prototobuf data, it&#8217;s necessary to deploy the extra protostream marshallers so that the server can unmarshall the data before filtering/converting. To do so, follow these steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a JAR file that includes an implementation of the following interface:</p>
<div class="listingblock">
<div class="content">
<pre>org.infinispan.query.remote.client.ProtostreamSerializationContextInitializer</pre>
</div>
</div>
<div class="paragraph">
<p>Your implementation should add extra marshallers and optional Protobuf (<code>.proto</code>) files to the <code>Serialization</code> context for the Cache Manager.</p>
</div>
</li>
<li>
<p>Create the following file inside your JAR file:</p>
<div class="listingblock">
<div class="content">
<pre>META-INF/services/org.infinispan.query.remote.client.ProtostreamSerializationContextInitializer</pre>
</div>
</div>
<div class="paragraph">
<p>This file should contain the fully qualified class name of your <code>ProtostreamSerializationContextInitializer</code> implementation.</p>
</div>
</li>
<li>
<p>Create a <code>META-INF/MANIFEST.MF</code> file inside your JAR file that contains the following:</p>
<div class="listingblock">
<div class="content">
<pre>Dependencies: org.infinispan.protostream, org.infinispan.remote-query.client</pre>
</div>
</div>
</li>
<li>
<p>Update your JBoss deployment structure file, <code>jboss-deployment-structure.xml</code>, to include the following content so that Infinispan Server can access your custom classes:</p>
<div class="listingblock">
<div class="content">
<pre>&lt;jboss-deployment-structure xmlns="urn:jboss:deployment-structure:1.2"&gt;
     &lt;deployment&gt;
      &lt;dependencies&gt;
         &lt;module name="org.infinispan.protostream" /&gt;
         &lt;module name="org.infinispan.remote-query.client" services="import"/&gt;
      &lt;/dependencies&gt;
   &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;</pre>
</div>
</div>
</li>
<li>
<p>Deploy the JAR file to Infinispan Server by adding it to the <code>standalone/deployments</code> folder.</p>
</li>
<li>
<p>Configure the deployment in the appropriate Cache Manager as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;modules&gt;</span>
     <span class="tag">&lt;module</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">deployment.my-file.jar</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/modules&gt;</span>
   ...
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>JAR files that deploy custom classes to Infinispan Server must be available at
startup. You cannot deploy JARs to running server instances.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="listener_state_handling"><a class="anchor" href="#listener_state_handling"></a>20.7.17. Listener State Handling</h4>
<div class="paragraph">
<p>Client listener annotation has an optional <code>includeCurrentState</code> attribute
that specifies whether state will be sent to the client when the listener is
added or when there&#8217;s a failover of the listener.</p>
</div>
<div class="paragraph">
<p>By default, <code>includeCurrentState</code> is false, but if set to true and a client
listener is added in a cache already containing data, the server iterates over
the cache contents and sends an event for each entry to the client as a
<code>ClientCacheEntryCreated</code> (or custom event if configured). This allows clients
to build some local data structures based on the existing content. Once the
content has been iterated over, events are received as normal, as cache
updates are received.  If the cache is clustered, the entire cluster wide
contents are iterated over.</p>
</div>
<div class="paragraph">
<p><code>includeCurrentState</code> also controls whether state is received when the node
where the client event listener is registered fails and it&#8217;s moved to a
different node. The next section discusses this topic in depth.</p>
</div>
</div>
<div class="sect3">
<h4 id="listener_failure_handling"><a class="anchor" href="#listener_failure_handling"></a>20.7.18. Listener Failure Handling</h4>
<div class="paragraph">
<p>When a Hot Rod client registers a client listener, it does so in a single
node in a cluster. If that node fails, the Java Hot Rod client detects that
transparently and fails over all listeners registered in the node that failed
to another node.</p>
</div>
<div class="paragraph">
<p>During this fail over the client might miss some events. To avoid missing
these events, the client listener annotation contains an optional parameter
called <code>includeCurrentState</code> which if set to true, when the failover happens,
the cache contents can iterated over and <code>ClientCacheEntryCreated</code> events
(or custom events if configured) are generated. By default,
<code>includeCurrentState</code> is set to false.</p>
</div>
<div class="paragraph">
<p>Java Hot Rod clients can be made aware of such fail over event by adding a
callback to handle it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientCacheFailover</span>
<span class="directive">public</span> <span class="type">void</span> handleFailover(ClientCacheFailoverEvent e) {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is very useful in use cases where the client has cached some data, and
as a result of the fail over, taking in account that some events could be
missed, it could decide to clear any locally cached data when the fail over
event is received, with the knowledge that after the fail over event, it will
receive events for the contents of the entire cache.</p>
</div>
</div>
<div class="sect3">
<h4 id="near_caching"><a class="anchor" href="#near_caching"></a>20.7.19. Near Caching</h4>
<div class="paragraph">
<p>The Java Hot Rod client can be optionally configured with a near cache, which
means that the Hot Rod client can keep a local cache that stores recently used
data. Enabling near caching can significantly improve the performance of read
operations <code>get</code> and <code>getVersioned</code> since data can potentially be located
locally within the Hot Rod client instead of having to go remote.</p>
</div>
<div class="paragraph">
<p>To enable near caching, the user must set the near cache mode to <code>INVALIDATED</code>.
By doing that near cache is populated upon retrievals from the server via
calls to <code>get</code> or <code>getVersioned</code> operations. When near cached entries are
updated or removed server-side, the cached near cache entries are invalidated.
If a key is requested after it&#8217;s been invalidated, it&#8217;ll have to be re-fetched
from the server.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
You should not use <code>maxIdle</code> expiration with near caches, as near-cache
reads will not propagate the last access change to the server and to the other
clients.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When near cache is enabled, its size must be configured by defining
the maximum number of entries to keep in the near cache. When the maximum is
reached, near cached entries are evicted.
If providing 0 or a negative value, it is assumed that the near
cache is unbounded.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Users should be careful when configuring near cache to be
unbounded since it shifts the responsibility to keep the near cache&#8217;s size
within the boundaries of the client JVM to the user.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Hot Rod client&#8217;s near cache mode is configured using the <code>NearCacheMode</code>
enumeration and calling:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.NearCacheMode</span>;
...

<span class="comment">// Unbounded invalidated near cache</span>
ConfigurationBuilder unbounded = <span class="keyword">new</span> ConfigurationBuilder();
unbounded.nearCache().mode(NearCacheMode.INVALIDATED).maxEntries(-<span class="integer">1</span>);

<span class="comment">// Bounded invalidated near cache</span>
ConfigurationBuilder bounded = <span class="keyword">new</span> ConfigurationBuilder();
bounded.nearCache().mode(NearCacheMode.INVALIDATED).maxEntries(<span class="integer">100</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the configuration is shared by all caches obtained from a single
<code>RemoteCacheManager</code>, you may not want to enable near-caching for all of them.
You can use the <code>cacheNamePattern</code> configuration attribute to define a regular
expression which matches the names of the caches for which you want near-caching.
Caches whose name don&#8217;t match the regular expression, will not have near-caching
enabled.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Bounded invalidated near cache with pattern matching</span>
ConfigurationBuilder bounded = <span class="keyword">new</span> ConfigurationBuilder();
bounded.nearCache()
  .mode(NearCacheMode.INVALIDATED)
  .maxEntries(<span class="integer">100</span>)
  .cacheNamePattern(<span class="string"><span class="delimiter">&quot;</span><span class="content">near.*</span><span class="delimiter">&quot;</span></span>); <span class="comment">// enable near-cache only for caches whose name starts with 'near'</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Near caches work the same way for local caches as they do for clustered
caches, but in a clustered cache scenario, if the server node sending the near
cache notifications to the Hot Rod client goes down, the Hot Rod client
transparently fails over to another node in the cluster, clearing the near
cache along the way.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="unsupported_methods"><a class="anchor" href="#unsupported_methods"></a>20.7.20. Unsupported methods</h4>
<div class="paragraph">
<p>Some of the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html">Cache</a> methods are not being supported by the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> . Calling one of these methods results in an <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/UnsupportedOperationException.html">UnsupportedOperationException</a> being thrown. Most of these methods do not make sense on the remote cache (e.g. listener management operations), or correspond to methods that are not supported by local cache as well (e.g. containsValue). Another set of unsupported operations are some of the atomic operations inherited from <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">ConcurrentMap</a> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> remove(<span class="predefined-type">Object</span> key, <span class="predefined-type">Object</span> value);
<span class="type">boolean</span> replace(<span class="predefined-type">Object</span> key, <span class="predefined-type">Object</span> value);
<span class="type">boolean</span> replace(<span class="predefined-type">Object</span> key, <span class="predefined-type">Object</span> oldValue, <span class="predefined-type">Object</span> value);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> offers alternative versioned methods for these atomic operations, that are also network friendly, by not sending the whole value object over the network, but a version identifier. See the section on versioned API.</p>
</div>
<div class="paragraph">
<p>Each one of these unsupported operation is documented in the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> javadoc.</p>
</div>
</div>
<div class="sect3">
<h4 id="return_values_2"><a class="anchor" href="#return_values_2"></a>20.7.21. Return values</h4>
<div class="paragraph">
<p>There is a set of methods that alter a cached entry and return the previous existing value, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">V remove(<span class="predefined-type">Object</span> key);
V put(K key, V value);</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default on RemoteCache, these operations return null even if such a previous value exists. This approach reduces the amount of data sent over the network. However, if these return values are needed they can be enforced on a per invocation basis using flags:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">initialValue</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> <span class="predefined-constant">null</span> == cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>.equals(cache.withFlags(Flag.FORCE_RETURN_VALUE).put(<span class="string"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span>,
<span class="error"></span><span class="error"></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">newValue</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>This default behavior can can be changed through force-return-value=true configuration parameter (see configuration section bellow).</p>
</div>
</div>
<div class="sect3">
<h4 id="hr_transactions"><a class="anchor" href="#hr_transactions"></a>20.7.22. Hot Rod Transactions</h4>
<div class="paragraph">
<p>You can configure and use Hot Rod clients in JTA <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Transaction.html">Transaction</a>s.</p>
</div>
<div class="paragraph">
<p>To participate in a transaction, the Hot Rod client requires the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> with which it interacts and whether it participates in the transaction through the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Synchronization.html">Synchronization</a> or <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a> interface.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Transactions are optimistic in that clients acquire write locks on entries during the prepare phase. To avoid data inconsistency, be sure to read about <a href="#hr_transactions_force_return_value">Detecting Conflicts with Transactions</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="hr_transactions_config_server"><a class="anchor" href="#hr_transactions_config_server"></a>Configuring the Server</h5>
<div class="paragraph">
<p>Caches in the server must also be transactional for clients to participate in JTA <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Transaction.html">Transaction</a>s.</p>
</div>
<div class="paragraph">
<p>The following server configuration is required, otherwise transactions rollback only:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Isolation level must be <code>REPEATABLE_READ</code>.</p>
</li>
<li>
<p>Locking mode must be <code>PESSIMISTIC</code>. In a future release, <code>OPTIMISTIC</code> locking mode will be supported.</p>
</li>
<li>
<p>Transaction mode should be <code>NON_XA</code> or <code>NON_DURABLE_XA</code>. Hot Rod transactions cannot use <code>FULL_XA</code> because it degrades performance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hot Rod transactions have their own recovery mechanism.</p>
</div>
</div>
<div class="sect4">
<h5 id="hr_transactions_config_client"><a class="anchor" href="#hr_transactions_config_client"></a>Configuring Hot Rod Clients</h5>
<div class="paragraph">
<p>When you create the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a>, you can set the default <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> and <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/configuration/TransactionMode.html">TransactionMode</a> that the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> uses.</p>
</div>
<div class="paragraph">
<p>The <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> lets you create only one configuration for transactional caches, as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
<span class="comment">//other client configuration parameters</span>
cb.transaction().transactionManagerLookup(GenericTransactionManagerLookup.getInstance());
cb.transaction().transactionMode(TransactionMode.NON_XA);
cb.transaction().timeout(<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.MINUTES)
RemoteCacheManager rmc = <span class="keyword">new</span> RemoteCacheManager(cb.build());</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding configuration applies to all instances of a remote cache. If you need to apply different configurations to remote cache instances, you can override the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> configuration. See <a href="#hr_transactions_override_rcm">Overriding RemoteCacheManager Configuration</a>.</p>
</div>
<div class="paragraph">
<p>See <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/configuration/ConfigurationBuilder.html">ConfigurationBuilder</a> Javadoc for documentation on configuration parameters.</p>
</div>
<div class="paragraph">
<p>You can also configure the Java Hot Rod client with a properties file, as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>infinispan.client.hotrod.transaction.transaction_manager_lookup = org.infinispan.client.hotrod.transaction.lookup.GenericTransactionManagerLookup
infinispan.client.hotrod.transaction.transaction_mode = NON_XA
infinispan.client.hotrod.transaction.timeout = 60000</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="hr_transactions_tmlookup"><a class="anchor" href="#hr_transactions_tmlookup"></a>TransactionManagerLookup Interface</h6>
<div class="paragraph">
<p><code>TransactionManagerLookup</code> provides an entry point to fetch a <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p>
</div>
<div class="paragraph">
<p>Available implementations of <code>TransactionManagerLookup</code>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/transaction/lookup/GenericTransactionManagerLookup.html">GenericTransactionManagerLookup</a></dt>
<dd>
<p>A lookup class that locates <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>s running in Java EE application servers. Defaults to the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/transaction/manager/RemoteTransactionManager.html">RemoteTransactionManager</a> if it cannot find a <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In most cases, <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/transaction/lookup/GenericTransactionManagerLookup.html">GenericTransactionManagerLookup</a> is suitable. However, you can implement the <code>TransactionManagerLookup</code> interface if you need to integrate a custom <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/transaction/lookup/RemoteTransactionManagerLookup.html">RemoteTransactionManagerLookup</a></dt>
<dd>
<p>A basic, and volatile, <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> if no other implementation is available. Note that this implementation has significant limitations when handling concurrent transactions and recovery.</p>
</dd>
</dl>
</div>
</div>
<div class="sect5">
<h6 id="hr_transactions_modes"><a class="anchor" href="#hr_transactions_modes"></a>Transaction Modes</h6>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/configuration/TransactionMode.html">TransactionMode</a> controls how a <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interacts with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Configure transaction modes on both the Infinispan server and your client application. If clients attempt to perform transactional operations on non-transactional caches, runtime exceptions can occur.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Transaction modes are the same in both the Infinispan configuration and client settings. Use the following modes with your client, see the Infinispan configuration schema for the server:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>NONE</code></dt>
<dd>
<p>The <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> does not interact with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>. This is the default mode and is non-transactional.</p>
</dd>
<dt class="hdlist1"><code>NON_XA</code></dt>
<dd>
<p>The <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interacts with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> via <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Synchronization.html">Synchronization</a>.</p>
</dd>
<dt class="hdlist1"><code>NON_DURABLE_XA</code></dt>
<dd>
<p>The <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interacts with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> via <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a>. Recovery capabilities are disabled.</p>
</dd>
<dt class="hdlist1"><code>FULL_XA</code></dt>
<dd>
<p>The <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interacts with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> via <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a>. Recovery capabilities are enabled. Invoke the <code>XaResource.recover()</code> method to retrieve transactions to recover.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect4">
<h5 id="hr_transactions_override_rcm"><a class="anchor" href="#hr_transactions_override_rcm"></a>Overriding Configuration for Cache Instances</h5>
<div class="paragraph">
<p>Because <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> does not support different configurations for each cache instance. However, <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> includes the <code>getCache(String)</code> method that returns the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> instances and lets you override some configuration parameters, as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>getCache(String cacheName, TransactionMode transactionMode)</code></dt>
<dd>
<p>Returns a <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> and overrides the configured <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/configuration/TransactionMode.html">TransactionMode</a>.</p>
</dd>
<dt class="hdlist1"><code>getCache(String cacheName, boolean forceReturnValue, TransactionMode transactionMode)</code></dt>
<dd>
<p>Same as previous, but can also force return values for write operations.</p>
</dd>
<dt class="hdlist1"><code>getCache(String cacheName, TransactionManager transactionManager)</code></dt>
<dd>
<p>Returns a <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> and overrides the configured <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p>
</dd>
<dt class="hdlist1"><code>getCache(String cacheName, boolean forceReturnValue, TransactionManager transactionManager)</code></dt>
<dd>
<p>Same as previous, but can also force return values for write operations.</p>
</dd>
<dt class="hdlist1"><code>getCache(String cacheName, TransactionMode transactionMode, TransactionManager transactionManager)</code></dt>
<dd>
<p>Returns a <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> and overrides the configured <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> and <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/configuration/TransactionMode.html">TransactionMode</a>. Uses the configured values, if <code>transactionManager</code> or <code>transactionMode</code> is null.</p>
</dd>
<dt class="hdlist1"><code>getCache(String cacheName, boolean forceReturnValue, TransactionMode transactionMode, TransactionManager transactionManager)</code></dt>
<dd>
<p>Same as previous, but can also force return values for write operations.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>getCache(String)</code> method returns <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> instances regardless of whether they are transaction or not. <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> includes a <code>getTransactionManager()</code> method that returns the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> that the cache uses. If the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> is not transactional, the method returns <code>null</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="hr_transactions_force_return_value"><a class="anchor" href="#hr_transactions_force_return_value"></a>Detecting Conflicts with Transactions</h5>
<div class="paragraph">
<p>Transactions use the initial values of keys to detect conflicts. For example, "k" has a value of "v" when a transaction begins. During the prepare phase, the transaction fetches "k" from the server to read the value. If the value has changed, the transaction rolls back to avoid a conflict.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Transactions use versions to detect changes instead of checking value equality.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>forceReturnValue</code> parameter controls write operations to the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> and helps avoid conflicts. It has the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If <code>true</code>, the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> fetches the most recent value from the server before performing write operations. However, the <code>forceReturnValue</code> parameter applies only to write operations that access the key for the first time.</p>
</li>
<li>
<p>If <code>false</code>, the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> does not fetch the most recent value from the server before performing write operations. Because this setting</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This parameter does not affect <em>conditional</em> write operations such as <code>replace</code> or <code>putIfAbsent</code> because they require the most recent value.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following transactions provide an example where the <code>forceReturnValue</code> parameter can prevent conflicting write operations:</p>
</div>
<div class="listingblock">
<div class="title">Transaction 1 (TX1)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...
TransactionManager tm = ...

tm.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
tm.commit();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Transaction 2 (TX2)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...
TransactionManager tm = ...

tm.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v2</span><span class="delimiter">&quot;</span></span>);
tm.commit();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, TX1 and TX2 are executed in parallel. The initial value of "k" is "v".</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If <code>forceReturnValue = true</code>, the <code>cache.put()</code> operation fetches the value for "k" from the server in both TX1 and TX2. The transaction that acquires the lock for "k" first then commits. The other transaction rolls back during the commit phase because the transaction can detect that "k" has a value other than "v".</p>
</li>
<li>
<p>If <code>forceReturnValue = false</code>, the <code>cache.put()</code> operation does not fetch the value for "k" from the server and returns null. Both TX1 and TX2 can successfully commit, which results in a conflict. This occurs because neither transaction can detect that the initial value of "k" changed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following transactions include <code>cache.get()</code> operations to read the value for "k" before doing the <code>cache.put()</code> operations:</p>
</div>
<div class="listingblock">
<div class="title">Transaction 1 (TX1)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...
TransactionManager tm = ...

tm.begin();
cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
tm.commit();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Transaction 2 (TX2)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...
TransactionManager tm = ...

tm.begin();
cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v2</span><span class="delimiter">&quot;</span></span>);
tm.commit();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding examples, TX1 and TX2 both read the key so the <code>forceReturnValue</code> parameter does not take effect. One transaction commits, the other rolls back. However, the <code>cache.get()</code> operation requires an additional server request. If you do not need the return value for the <code>cache.put()</code> operation that server request is inefficient.</p>
</div>
</div>
<div class="sect4">
<h5 id="hr_transactions_ex_use_config"><a class="anchor" href="#hr_transactions_ex_use_config"></a>Using the Configured Transaction Manager and Transaction Mode</h5>
<div class="paragraph">
<p>The following example shows how to use the <code>TransactionManager</code> and <code>TransactionMode</code> that you configure in the <code>RemoteCacheManager</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//Configure the transaction manager and transaction mode.</span>
org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.transaction().transactionManagerLookup(RemoteTransactionManagerLookup.getInstance());
cb.transaction().transactionMode(TransactionMode.NON_XA);

RemoteCacheManager rcm = <span class="keyword">new</span> RemoteCacheManager(cb.build());

<span class="comment">//The my-cache instance uses the RemoteCacheManager configuration.</span>
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = rcm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span>);

<span class="comment">//Return the transaction manager that the cache uses.</span>
TransactionManager tm = cache.getTransactionManager();

<span class="comment">//Perform a simple transaction.</span>
tm.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">K1 value is </span><span class="delimiter">&quot;</span></span> + cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>));
tm.commit();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="hr_transactions_ex_override_tm"><a class="anchor" href="#hr_transactions_ex_override_tm"></a>Overriding the Transaction Manager</h5>
<div class="paragraph">
<p>The following example shows how to override <code>TransactionManager</code> with the <code>getCache</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//Configure the transaction manager and transaction mode.</span>
org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.transaction().transactionManagerLookup(RemoteTransactionManagerLookup.getInstance());
cb.transaction().transactionMode(TransactionMode.NON_XA);

RemoteCacheManager rcm = <span class="keyword">new</span> RemoteCacheManager(cb.build());

<span class="comment">//Define a custom TransactionManager.</span>
TransactionManager myCustomTM = ...

<span class="comment">//Override the TransactionManager for the my-cache instance. Use the default configuration if null is returned.</span>
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = rcm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>, myCustomTM);

<span class="comment">//Perform a simple transaction.</span>
myCustomTM.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">K1 value is </span><span class="delimiter">&quot;</span></span> + cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>));
myCustomTM.commit();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="hr_transactions_ex_override_mode"><a class="anchor" href="#hr_transactions_ex_override_mode"></a>Overriding the Transaction Mode</h5>
<div class="paragraph">
<p>The following example shows how to override <code>TransactionMode</code> with the <code>getCache</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//Configure the transaction manager and transaction mode.</span>
org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.transaction().transactionManagerLookup(RemoteTransactionManagerLookup.getInstance());
cb.transaction().transactionMode(TransactionMode.NON_XA);

RemoteCacheManager rcm = <span class="keyword">new</span> RemoteCacheManager(cb.build());

<span class="comment">//Override the transaction mode for the my-cache instance.</span>
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = rcm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span>, TransactionMode.NON_DURABLE_XA, <span class="predefined-constant">null</span>);

<span class="comment">//Return the transaction manager that the cache uses.</span>
TransactionManager tm = cache.getTransactionManager();

<span class="comment">//Perform a simple transaction.</span>
tm.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">K1 value is </span><span class="delimiter">&quot;</span></span> + cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>));
tm.commit();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="client_intelligence"><a class="anchor" href="#client_intelligence"></a>20.7.23. Client Intelligence</h4>
<div class="paragraph">
<p>Client intelligence refers to mechanisms the <code>HotRod</code> protocol provides
for clients to locate and send requests to Infinispan servers.</p>
</div>
<div class="paragraph">
<div class="title">Basic intelligence</div>
<p>Clients do not store any information about Infinispan clusters or key hash
values.</p>
</div>
<div class="paragraph">
<div class="title">Topology-aware</div>
<p>Clients receive and store information about Infinispan clusters. Clients
maintain an internal mapping of the cluster topology that changes whenever
servers join or leave clusters.</p>
</div>
<div class="paragraph">
<p>To receive a cluster topology, clients need the address (<code>IP:HOST</code>) of at least
one Hot Rod server at startup. After the client connects to the server,
Infinispan transmits the topology to the client. When servers join or leave the
cluster, Infinispan transmits an updated topology to the client.</p>
</div>
<div class="paragraph">
<div class="title">Distribution-aware</div>
<p>Clients are topology-aware and store consistent hash values for keys.</p>
</div>
<div class="paragraph">
<p>For example, take a <code>put(k,v)</code> operation. The client calculates the hash value
for the key so it can locate the exact server on which the data resides. Clients
can then connect directly to the owner to dispatch the operation.</p>
</div>
<div class="paragraph">
<p>The benefit of distribution-aware intelligence is that Infinispan servers do
not need to look up values based on key hashes, which uses less resources on
the server side. Another benefit is that servers respond to client requests
more quickly because it skips additional network roundtrips.</p>
</div>
<div class="sect4">
<h5 id="request_balancing"><a class="anchor" href="#request_balancing"></a>Request Balancing</h5>
<div class="paragraph">
<p>Clients that use topology-aware intelligence use request balancing for all
requests. The default balancing strategy is round-robin, so topology-aware
clients always send requests to servers in round-robin order.</p>
</div>
<div class="paragraph">
<p>For example, <code>s1</code>, <code>s2</code>, <code>s3</code> are servers in a Infinispan cluster. Clients
perform request balancing as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CacheContainer cacheContainer = <span class="keyword">new</span> RemoteCacheManager();
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheContainer.getCache();

<span class="comment">//client sends put request to s1</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>);
<span class="comment">//client sends put request to s2</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>);
<span class="comment">//client sends get request to s3</span>
<span class="predefined-type">String</span> value = cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>);
<span class="comment">//client dispatches to s1 again</span>
cache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>);
<span class="comment">//and so on...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Clients that use distribution-aware intelligence use request balancing only
for failed requests. When requests fail, distribution-aware clients retry the
request on the next available server.</p>
</div>
<div class="paragraph">
<div class="title">Custom balancing policies</div>
<p>You can implement <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/FailoverRequestBalancingStrategy.html">FailoverRequestBalancingStrategy</a> and specify your class in your
<code>hotrod-client.properties</code> configuration.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="persistent_connections"><a class="anchor" href="#persistent_connections"></a>20.7.24. Persistent connections</h4>
<div class="paragraph">
<p>In order to avoid creating a TCP connection on each request (which is a costly operation), the client keeps a pool of persistent connections to all the available servers and it reuses these connections whenever it is possible. The validity of the connections is checked using an async thread that iterates over the connections in the pool and sends a HotRod ping command to the server. By using this connection validation process the client is being proactive: there&#8217;s a hight chance for broken connections to be found while being idle in the pool and no on actual request from the application.</p>
</div>
<div class="paragraph">
<p>The number of connections per server, total number of connections, how long should a connection be kept idle in the pool before being closed - all these (and more) can be configured. Please refer to the javadoc of <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> for a list of all possible configuration elements.</p>
</div>
</div>
<div class="sect3">
<h4 id="hot_rod_marshalling_data"><a class="anchor" href="#hot_rod_marshalling_data"></a>20.7.25. Marshalling data</h4>
<div class="paragraph">
<p>The Hot Rod client allows one to plug in a custom marshaller for transforming user objects into byte arrays and the other way around. This transformation is needed because of Hot Rod&#8217;s binary nature - it doesn&#8217;t know about objects.</p>
</div>
<div class="paragraph">
<p>The marshaller can be plugged through the "marshaller" configuration element (see Configuration section): the value should be the fully qualified name of a class implementing the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/marshall/Marshaller.html">Marshaller</a> interface. This is a optional parameter, if not specified it defaults to the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/marshall/jboss/GenericJBossMarshaller.html">GenericJBossMarshaller</a> - a highly optimized implementation based on the <a href="http://www.jboss.org/jbossmarshalling">JBoss Marshalling</a> library.</p>
</div>
<div class="paragraph">
<p>Since version 6.0, there&#8217;s a new marshaller available to Java Hot Rod clients based on Protostream which generates portable payloads. You can find more information about it <a href="#query_remote">here</a>.</p>
</div>
<div class="paragraph">
<div class="title">WARNING: If developing your own custom marshaller, take care of potential injection attacks.</div>
<p>To avoid such attacks, make the marshaller verify that any class names read, before instantiating it, is amongst the expected/allowed class names.</p>
</div>
<div class="paragraph">
<p>The client configuration can be enhanced with a list of regular expressions for classes that are allowed to be read.</p>
</div>
<div class="paragraph">
<div class="title">WARNING: These checks are opt-in, so if not configured, any class can be read.</div>
<p>In the example below, only classes with fully qualified names containing <code>Person</code> or <code>Employee</code> would be allowed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</span>;

...
ConfigurationBuilder configBuilder = ...
configBuilder.addJavaSerialWhiteList(<span class="string"><span class="delimiter">&quot;</span><span class="content">.*Person.*</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">.*Employee.*</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="reading_data_in_different_data_formats"><a class="anchor" href="#reading_data_in_different_data_formats"></a>20.7.26. Reading data in different data formats</h4>
<div class="paragraph">
<p>By default, every Hot Rod client operation will use the configured marshaller when reading and writing from the server for both keys and values. See <a href="#hot_rod_marshalling_data">Marshalling Data</a>.
Using the DataFormat API, it&#8217;s possible to decorate remote caches so that all operations can happen with a custom data format.</p>
</div>
<div class="sect4">
<h5 id="using_different_marshallers_for_key_and_values"><a class="anchor" href="#using_different_marshallers_for_key_and_values"></a>Using different marshallers for Key and Values</h5>
<div class="paragraph">
<p>Marshallers for Keys and Values can be overridden at run time. For example, to bypass all serialization in the Hot Rod client and read the byte[] as they are stored in the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Existing Remote cache instance</span>
RemoteCache&lt;<span class="predefined-type">String</span>, Pojo&gt; remoteCache = ...

<span class="comment">// IdentityMarshaller is a no-op marshaller</span>
DataFormat rawKeyAndValues = DataFormat.builder().keyMarshaller(IdentityMarshaller.INSTANCE).valueMarshaller(IdentityMarshaller.INSTANCE).build();

<span class="comment">// Will create a new instance of RemoteCache with the supplied DataFormat</span>
RemoteCache&lt;<span class="type">byte</span><span class="type">[]</span>, <span class="type">byte</span><span class="type">[]</span>&gt; rawResultsCache = remoteCache.withDataFormat(rawKeyAndValues);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="reading_data_in_different_formats"><a class="anchor" href="#reading_data_in_different_formats"></a>Reading data in different formats</h5>
<div class="paragraph">
<p>Apart from defining custom key and value marshallers, it&#8217;s also possible to request/send data in different formats specified by a <code>org.infinispan.commons.dataconversion.MediaType</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Existing remote cache using ProtostreamMarshaller</span>
RemoteCache&lt;<span class="predefined-type">String</span>, Pojo&gt; protobufCache = ...

<span class="comment">// Request values returned as JSON, using the UTF8StringMarshaller that converts between UTF-8 to String:</span>
DataFormat jsonString = DataFormat.builder().valueType(MediaType.APPLICATION_JSON).valueMarshaller(<span class="keyword">new</span> UTF8StringMarshaller().build();

RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; jsonStrCache = remoteCache.withDataFormat(jsonString);

<span class="comment">// Alternativelly, it's possible to request JSON values but marshalled/unmarshalled with a custom value marshaller that returns `org.codehaus.jackson.JsonNode` objects:</span>
DataFormat jsonNode = DataFormat.builder().valueType(MediaType.APPLICATION_JSON).valueMarshaller(<span class="keyword">new</span> CustomJacksonMarshaller().build();

RemoteCache&lt;<span class="predefined-type">String</span>, JsonNode&gt; jsonNodeCache = remoteCache.withDataFormat(jsonNode);</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The data conversions happen in the server, and if it doesn&#8217;t support converting from the storage format to the request format and vice versa, an error will be returned.
For more details on server data format configuration and supported conversions, see <a href="#encoding_media_type">here</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Using different marshallers and formats for the key, with <code>.keyMarshaller()</code> and <code>.keyType()</code> may interfere with the client intelligence routing mechanism, causing it
contact the server that is not the owner of the key during Hot Rod operations. This will not result in errors but can result in extra hops inside the cluster to execute the operation.
If performance is critical, make sure to use the keys in the format stored by the server.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="statistics_2"><a class="anchor" href="#statistics_2"></a>20.7.27. Statistics</h4>
<div class="paragraph">
<p>Various server usage statistics can be obtained through the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> .stats() method. This returns a <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/ServerStatistics.html">ServerStatistics</a> object - please refer to javadoc for details on the available statistics.</p>
</div>
</div>
<div class="sect3">
<h4 id="multi_get_operations"><a class="anchor" href="#multi_get_operations"></a>20.7.28. Multi-Get Operations</h4>
<div class="paragraph">
<p>The Java Hot Rod client does not provide multi-get functionality out of the box but clients can build it themselves with the given APIs.</p>
</div>
</div>
<div class="sect3">
<h4 id="server_hotrod_failover"><a class="anchor" href="#server_hotrod_failover"></a>20.7.29. Failover capabilities</h4>
<div class="paragraph">
<p>Hot Rod clients' capabilities to keep up with topology changes helps with request
balancing and more importantly, with the ability to failover operations
if one or several of the servers fail.</p>
</div>
<div class="paragraph">
<p>Some of the conditional operations mentioned above, including <code>putIfAbsent</code>,
<code>replace</code> with and without version, and conditional <code>remove</code> have strict method
return guarantees, as well as those operations where returning the previous
value is forced.</p>
</div>
<div class="paragraph">
<p>In spite of failures, these methods return values need to be guaranteed, and
in order to do so, it&#8217;s necessary that these methods are not applied partially
in the cluster in the event of failure. For example, imagine a <code>replace()</code>
operation called in a server for key=k1 with <code>Flag.FORCE_RETURN_VALUE</code>, whose
current value is <code>A</code> and the replace wants to set it to <code>B</code>. If the replace
fails, it could happen that some servers contain <code>B</code> and others contain <code>A</code>,
and during the failover, the original <code>replace()</code> could end up returning <code>B</code>,
if the replace failovers to a node where <code>B</code> is set, or could end up returning
<code>A</code>.</p>
</div>
<div class="paragraph">
<p>To avoid this kind of situations, whenever Java Hot Rod client users want to
use conditional operations, or operations whose previous value is required,
it&#8217;s important that the cache is configured to be transactional in order to
avoid incorrect conditional operations or return values.</p>
</div>
</div>
<div class="sect3">
<h4 id="site_cluster_failover"><a class="anchor" href="#site_cluster_failover"></a>20.7.30. Site Cluster Failover</h4>
<div class="paragraph">
<p>On top of the in-cluster failover, Hot Rod clients are also able to failover
to different clusters, which could be represented as an independent site.</p>
</div>
<div class="paragraph">
<p>The way site cluster failover works is that if all the main cluster nodes
are not available, the client checks to see if any other clusters have been
defined in which cases it tries to failover to the alternative cluster.
If the failover succeeds, the client will remain connected to the alternative
cluster until this becomes unavailable, in which case it&#8217;ll try any other
clusters defined, and ultimately, it&#8217;ll try the original server settings.</p>
</div>
<div class="paragraph">
<p>To configure a cluster in the Hot Rod client, one host/port pair details
must be provided for each of the clusters configured. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb
      = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.addCluster().addClusterNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cluster-host</span><span class="delimiter">&quot;</span></span>, <span class="integer">11222</span>);
RemoteCacheManager rmc = <span class="keyword">new</span> RemoteCacheManager(cb.build());</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Remember that regardless of the cluster definitions, the initial
server(s) configuration must be provided unless the initial servers can
be resolved using the default server host and port details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="manual_site_cluster_switch"><a class="anchor" href="#manual_site_cluster_switch"></a>20.7.31. Manual Site Cluster Switch</h4>
<div class="paragraph">
<p>As well as supporting automatic site cluster failover, Java Hot Rod clients
can also switch between site clusters manually by calling RemoteCacheManager&#8217;s
<code>switchToCluster(clusterName)</code> and <code>switchToDefaultCluster()</code>.</p>
</div>
<div class="paragraph">
<p>Using <code>switchToCluster(clusterName)</code>, users can force a client to switch
to one of the clusters pre-defined in the Hot Rod client configuration.
To switch to the initial servers defined in the client configuration, call
<code>switchToDefaultCluster()</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="hotrod_java_client_monitoring"><a class="anchor" href="#hotrod_java_client_monitoring"></a>20.7.32. Monitoring the Hot Rod client</h4>
<div class="paragraph">
<p>The Hot Rod client can be monitored and managed via JMX similarly to what is described in the <a href="#jmx_mgmt_tooling">Management</a> chapter.
By enabling statistics, an MBean will be registered for the <code>RemoteCacheManager</code> as well as for each <code>RemoteCache</code> obtained
through it.
Through these MBeans it is possible to obtain statistics about remote and near-cache hits/misses and connection pool usage.</p>
</div>
</div>
<div class="sect3">
<h4 id="concurrent_updates"><a class="anchor" href="#concurrent_updates"></a>20.7.33. Concurrent Updates</h4>
<div class="paragraph">
<p>Data structures, such as Infinispan <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/Cache.html">Cache</a> , that are accessed and modified concurrently can suffer from data consistency issues unless there&#8217;re mechanisms to guarantee data correctness. Infinispan Cache, since it implements <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">ConcurrentMap</a> , provides operations such as <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#replace-K-V-V-">conditional replace</a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#putIfAbsent-K-V-">putIfAbsent</a> , and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#remove-java.lang.Object-java.lang.Object-">conditional remove</a> to its clients in order to guarantee data correctness. It even allows clients to operate against cache instances within JTA transactions, hence providing the necessary data consistency guarantees.</p>
</div>
<div class="paragraph">
<p>However, when it comes to <a href="http://community.jboss.org/wiki/HotRodProtocol">Hot Rod protocol</a> backed servers, clients do not yet have the ability to start remote transactions but they can call instead versioned operations to mimic the conditional methods provided by the embedded Infinispan cache instanceAPI.  Let&#8217;s look at a real example to understand how it works.</p>
</div>
<div class="sect4">
<h5 id="data_consistency_problem"><a class="anchor" href="#data_consistency_problem"></a>Data Consistency Problem</h5>
<div class="paragraph">
<p>Imagine you have two ATMs that connect using Hot Rod to a bank where an account&#8217;s balance is stored.  Two closely followed operations to retrieve the latest balance could return 500 CHF (swiss francs) as shown below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/server_modules_6.png" alt="server modules 6">
</div>
<div class="title">Figure 17. Concurrent readers</div>
</div>
<div class="paragraph">
<p>Next a customer connects to the first ATM and requests 400 CHF to be retrieved.  Based on the last value read, the ATM could calculate what the new balance is, which is 100 CHF, and request a put with this new value. Let&#8217;s imagine now that around the same time another customer connects to the ATM and requests 200 CHF to be retrieved.  Let&#8217;s assume that the ATM thinks it has the latest balance and based on its calculations it sets the new balance to 300 CHF:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/server_modules_7.png" alt="Concurrent updates">
</div>
</div>
<div class="paragraph">
<p>Obviously, this would be wrong.  Two concurrent updates have resulted in an incorrect account balance.  The second update should not have been allowed since the balance the second ATM had was incorrect. Even if the ATM would have retrieved the balance before calculating the new balance, someone could have updated between the new balance being retrieved and the update. Before finding out how to solve this issue in a client-server scenario with Hot Rod, let&#8217;s look at how this is solved when Infinispan clients run in peer-to-peer mode where clients and Infinispan live within the same JVM.</p>
</div>
</div>
<div class="sect4">
<h5 id="embedded_mode_solution"><a class="anchor" href="#embedded_mode_solution"></a>Embedded-mode Solution</h5>
<div class="paragraph">
<p>If the ATM and the Infinispan instance storing the bank account lived in the same JVM, the ATM could use the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#replace-K-V-V-">conditional replace API</a> referred at the beginning of this article.  So, it could send the previous known value to verify whether it has changed since it was last read.  By doing so, the first operation could double check that the balance is still 500 CHF when it was to update to 100 CHF.  Now, when the second operation comes, the current balance would not be 500 CHF any more and hence the conditional replace call would fail, hence avoiding data consistency issues:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/server_modules_8.png" alt="server modules 8">
</div>
<div class="title">Figure 18. P2P solution</div>
</div>
</div>
<div class="sect4">
<h5 id="client_server_solution"><a class="anchor" href="#client_server_solution"></a>Client-Server Solution</h5>
<div class="paragraph">
<p>In theory, Hot Rod could use the same p2p solution but sending the previous value would be not practical.  In this example, the previous value is just an integer but the value could be a lot bigger and hence forcing clients to send it to the server would be rather wasteful.  Instead, Hot Rod offers versioned operations to deal with this situation.</p>
</div>
<div class="paragraph">
<p>Basically, together with each key/value pair, Hot Rod stores a version number which uniquely identifies each modification. So, using an operation called <a href="http://community.jboss.org/wiki/HotRodProtocol#getWithVersion_response">getVersioned or getWithVersion</a> , clients can retrieve not only the value associated with a key, but also the current version. So, if we look at the previous example once again, the ATMs could call getVersioned and get the balance&#8217;s version:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/server_modules_9.png" alt="server modules 9">
</div>
<div class="title">Figure 19. Get versioned</div>
</div>
<div class="paragraph">
<p>When the ATMs wanted to modify the balance, instead of just calling put, they could call <a href="http://community.jboss.org/wiki/HotRodProtocol#removeIfUnmodified_request">replaceIfUnmodified</a> operation passing the latest version number of which the clients are aware of.  The operation will only succeed if the version passed matches the version in the server.  So, the first modification by the ATM would be allowed since the client passes 1 as version and the server side version for the balance is also 1.  On the other hand, the second ATM would not be able to make the modification because after the first ATMs modification the version would have been incremented to 2, and now the passed version (1) and the server side version (2) would not match:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/server_modules_10.png" alt="server modules 10">
</div>
<div class="title">Figure 20. Replace if versions match</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="javadocs"><a class="anchor" href="#javadocs"></a>20.7.34. Javadocs</h4>
<div class="paragraph">
<p>It is highly recommended to read the following Javadocs (this is pretty much all the public API of the client):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rest_server"><a class="anchor" href="#rest_server"></a>20.8. REST Server</h3>
<div class="paragraph">
<p>The Infinispan Server distribution contains a module that implements <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer">RESTful</a> HTTP access to the Infinispan data grid, built on <a href="https://github.com/netty/netty">Netty</a>.</p>
</div>
<div class="sect3">
<h4 id="rest_run_server"><a class="anchor" href="#rest_run_server"></a>20.8.1. Running the REST server</h4>
<div class="paragraph">
<p>The REST server endpoint is part of the Infinispan Server and by default listens on port 8080. To run the server locally,
<a href="http://infinispan.org/download/">download</a> the zip distribution and execute in the extracted directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/standalone.sh -b 0.0.0.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>or alternatively, run via docker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>docker run -it -p 8080:8080 -e "APP_USER=user" -e "APP_PASS=changeme" jboss/infinispan-server</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="rest_security"><a class="anchor" href="#rest_security"></a>Security</h5>
<div class="paragraph">
<p>The REST server is protected by authentication, so before usage it is necessary to create an application login.
When running via docker, this is achieved by the APP_USER and APP_PASS command line arguments, but when running
locally, this can be done with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/add-user.sh -u user -p changeme -a</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rest_supported_protocols"><a class="anchor" href="#rest_supported_protocols"></a>20.8.2. Supported protocols</h4>
<div class="paragraph">
<p>The REST Server supports HTTP/1.1 as well as HTTP/2 protocols. It is possible to switch to HTTP/2 by either performing a <a href="https://http2.github.io/http2-spec/#discover-http">HTTP/1.1 Upgrade procedure</a> or
by negotiating communication protocol using <a href="https://http2.github.io/http2-spec/#versioning">TLS/ALPN extension</a>.</p>
</div>
<div class="paragraph">
<p>Note: TLS/ALPN with JDK8 requires additional steps from the client perspective. Please refer to your client documentation but it is very likely
that you will need Jetty ALPN Agent or OpenSSL bindings.</p>
</div>
</div>
<div class="sect3">
<h4 id="rest_api"><a class="anchor" href="#rest_api"></a>20.8.3. REST API</h4>
<div class="paragraph">
<p>HTTP PUT and POST methods are used to place data in the cache, with URLs to address the cache name and key(s) - the data being the body of the request (the data can be anything you like). Other headers are used to control the cache settings and behaviour.</p>
</div>
<div class="sect4">
<h5 id="rest_server_data_format"><a class="anchor" href="#rest_server_data_format"></a>Data formats</h5>
<div class="sect5">
<h6 id="rest_server_data_format_config"><a class="anchor" href="#rest_server_data_format_config"></a>Configuration</h6>
<div class="paragraph">
<p>Each cache exposed via REST stores data in a configurable data format defined by a <a href="https://en.wikipedia.org/wiki/Media_type">MediaType</a>. More details in the configuration <a href="#encoding_media_type">here</a>.</p>
</div>
<div class="paragraph">
<p>An example of storage configuration is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;cache&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object; type=java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xml; charset=UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When no MediaType is configured, Infinispan assumes "application/octet-stream" for both keys and values, with the following exceptions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the cache is indexed, it assumes "application/x-protostream"</p>
</li>
<li>
<p>If the cache is configured with compatibility mode, it assumes "application/x-java-object"</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="rest_server_data_format_support"><a class="anchor" href="#rest_server_data_format_support"></a>Supported formats</h6>
<div class="paragraph">
<p>Data can be written and read in different formats than the storage format; Infinispan can convert between those formats when required.</p>
</div>
<div class="paragraph">
<p>The following "standard" formats can be converted interchangeably:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>application/x-java-object</em></p>
</li>
<li>
<p><em>application/octet-stream</em></p>
</li>
<li>
<p><em>application/x-www-form-urlencoded</em></p>
</li>
<li>
<p><em>text/plain</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following formats can be converted to/from the formats above:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>application/xml</em></p>
</li>
<li>
<p><em>application/json</em></p>
</li>
<li>
<p><em>application/x-jboss-marshalling</em></p>
</li>
<li>
<p><em>application/x-protostream</em></p>
</li>
<li>
<p><em>application/x-java-serialized</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, the following conversion is also supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Between <em>application/x-protostream</em> and <em>application/json</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All the REST API calls can provide headers describing the content written or the required format of the content
when reading. Infinispan supports the standard HTTP/1.1 headers "Content-Type" and "Accept" that are applied for values,
plus the "Key-Content-Type" with similar effect for keys.</p>
</div>
</div>
<div class="sect5">
<h6 id="rest_accept"><a class="anchor" href="#rest_accept"></a>Accept header</h6>
<div class="paragraph">
<p>The REST server is compliant with the <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">RFC-2616</a> Accept header,
and will negotiate the correct MediaType based on the conversions supported. Example, sending the following header when reading data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>Accept: text/plain;q=0.7, application/json;q=0.8, */*;q=0.6</code></pre>
</div>
</div>
<div class="paragraph">
<p>will cause Infinispan to try first to return content in JSON format (higher priority 0.8). If it&#8217;s not possible to convert the storage format
to JSON, next format tried will be <em>text/plain</em> (second highest priority 0.7), and finally it falls back to <em>*/*</em>, that will pick a format
suitable for displaying automatically based on the cache configuration.</p>
</div>
</div>
<div class="sect5">
<h6 id="rest_key_content_type"><a class="anchor" href="#rest_key_content_type"></a>Key-Content-Type header</h6>
<div class="paragraph">
<p>Most REST API calls have the Key included in the URL. Infinispan will assume the Key is a <em>java.lang.String</em> when handling those calls, but
it&#8217;s possible to use a specific header <em>Key-Content-Type</em> for keys in different formats.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specifying a byte[] Key as a Base64 string:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>API call:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>`PUT /my-cache/AQIDBDM=`</pre>
</div>
</div>
<div class="paragraph">
<p>Headers:</p>
</div>
<div class="paragraph">
<p><code>Key-Content-Type: application/octet-stream</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specifying a byte[] Key as a hexadecimal string:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>API call:</p>
</div>
<div class="paragraph">
<p><code>GET /my-cache/0x01CA03042F</code></p>
</div>
<div class="paragraph">
<p>Headers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>Key-Content-Type: application/octet-stream; encoding=hex</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Specifying a double Key:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>API call:</p>
</div>
<div class="paragraph">
<p><code>POST /my-cache/3.141456</code></p>
</div>
<div class="paragraph">
<p>Headers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>Key-Content-Type: application/x-java-object;type=java.lang.Double</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>type</em> parameter for <em>application/x-java-object</em> is restricted to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Primitive wrapper types</p>
</li>
<li>
<p>java.lang.String</p>
</li>
<li>
<p>Bytes, making <em>application/x-java-object;type=Bytes</em> equivalent to <em>application/octet-stream;encoding=hex</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="rest_server_put_data"><a class="anchor" href="#rest_server_put_data"></a>Putting data in</h5>
<div class="sect5">
<h6 id="rest_server_put_request"><a class="anchor" href="#rest_server_put_request"></a><code>PUT /{cacheName}/{cacheKey}</code></h6>
<div class="paragraph">
<p>A PUT request of the above URL form will place the payload (body) in the given cache, with the given key (the named cache must exist on the server). For example <code><a href="http://someserver/hr/payRoll-3" class="bare">http://someserver/hr/payRoll-3</a></code> (in which case <code>hr</code> is the cache name, and <code>payRoll-3</code> is the key). Any existing data will be replaced, and Time-To-Live and Last-Modified values etc will updated (if applicable).</p>
</div>
</div>
<div class="sect5">
<h6 id="rest_server_post_request"><a class="anchor" href="#rest_server_post_request"></a><code>POST /{cacheName}/{cacheKey}</code></h6>
<div class="paragraph">
<p>Exactly the same as PUT, only if a value in a cache/key already exists, it will return a Http CONFLICT status (and the content will not be updated).</p>
</div>
<div class="ulist">
<div class="title">Headers</div>
<ul>
<li>
<p><a href="#rest_key_content_type">Key-Content-Type</a>: OPTIONAL The content type for the Key present in the URL.</p>
</li>
<li>
<p>Content-Type : OPTIONAL The <a href="https://en.wikipedia.org/wiki/Media_type">MediaType</a> of the Value being sent.</p>
</li>
<li>
<p>performAsync : OPTIONAL true/false (if true, this will return immediately, and then replicate data to the cluster on its own. Can help with bulk data inserts/large clusters.)</p>
</li>
<li>
<p>timeToLiveSeconds : OPTIONAL number (the number of seconds before this entry will automatically be deleted). If no parameter is sent, Infinispan assumes configuration default value. Passing any negative value will create an entry which will live forever.</p>
</li>
<li>
<p>maxIdleTimeSeconds : OPTIONAL number (the number of seconds after last usage of this entry when it will automatically be deleted). If no  parameter is sent, Infinispan configuration default value. Passing any negative value will create an entry which will live forever.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Passing 0 as parameter for timeToLiveSeconds and/or maxIdleTimeSeconds</div>
<ul>
<li>
<p>If both <code>timeToLiveSeconds</code> and <code>maxIdleTimeSeconds</code> are 0, the cache will use the default <code>lifespan</code> and <code>maxIdle</code> values configured in XML/programmatically</p>
</li>
<li>
<p>If <em>only</em> <code>maxIdleTimeSeconds</code> is 0, it uses the <code>timeToLiveSeconds</code> value passed as parameter (or -1 if not present), and default <code>maxIdle</code> configured in XML/programmatically</p>
</li>
<li>
<p>If <em>only</em> <code>timeToLiveSeconds</code> is 0, it uses default <code>lifespan</code> configured in XML/programmatically, and <code>maxIdle</code> is set to whatever came as parameter (or -1 if not present)</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">JSON/Protostream conversion</div>
<p>When caches are indexed, or specifically configured to store <em>application/x-protostream</em>, it&#8217;s possible to send and receive
JSON documents that are automatically converted to/from protostream. In order for the conversion to work, a protobuf schema must be registered.</p>
</div>
<div class="paragraph">
<p>The registration can be done via REST, by doing a POST/PUT in the <em>___protobuf_metadata</em> cache. Example using cURL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -u user:password -X POST --data-binary @./schema.proto http://127.0.0.1:8080/rest/___protobuf_metadata/schema.proto</code></pre>
</div>
</div>
<div class="paragraph">
<p>When writing a JSON document, a special field <strong><em>_type</em></strong> must be present in the document to identity the protobuf <em>Message</em>
corresponding to the document.</p>
</div>
<div class="paragraph">
<p>For example, consider the following schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="protobuf">message Person  {
  required string name = 1;
  required int32 age = 2;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A conformant JSON document would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">_type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Person</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">user1</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span>: <span class="integer">32</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="rest_server_get_data"><a class="anchor" href="#rest_server_get_data"></a>Getting data back out</h5>
<div class="paragraph">
<p>HTTP GET and HEAD are used to retrieve data from entries.</p>
</div>
<div class="sect5">
<h6 id="rest_server_get_request"><a class="anchor" href="#rest_server_get_request"></a><code>GET /{cacheName}/{cacheKey}</code></h6>
<div class="paragraph">
<p>This will return the data found in the given cacheName, under the given key - as the body of the response. A Content-Type header will be present in the response according to the Media Type negotiation. Browsers can use the cache directly of course (eg as a CDN). An <a href="http://en.wikipedia.org/wiki/HTTP_ETag">ETag</a> will be returned unique for each entry, as will the Last-Modified and Expires headers field indicating the state of the data at the given URL. ETags allow browsers (and other clients) to ask for data only in the case where it has changed (to save on bandwidth) - this is standard HTTP and is honoured by Infinispan.</p>
</div>
<div class="ulist">
<div class="title">Headers</div>
<ul>
<li>
<p><a href="#rest_key_content_type">Key-Content-Type</a>: OPTIONAL The content type for the Key present in the URL. When omitted, <em>application/x-java-object; type=java.lang.String</em> is assumed</p>
</li>
<li>
<p><a href="#rest_accept">Accept</a>: OPTIONAL The required format to return the content</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is possible to obtain additional information by appending the "extended" parameter on the query string, as follows:</p>
</div>
<div class="paragraph">
<p><code>GET /cacheName/cacheKey?extended</code></p>
</div>
<div class="paragraph">
<p>This will return the following custom headers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cluster-Primary-Owner: the node name of the primary owner for this key</p>
</li>
<li>
<p>Cluster-Node-Name: the JGroups node name of the server that has handled the request</p>
</li>
<li>
<p>Cluster-Physical-Address: the physical JGroups address of the server that has handled the request.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="rest_server_head_request"><a class="anchor" href="#rest_server_head_request"></a><code>HEAD /{cacheName}/{cacheKey}</code></h6>
<div class="paragraph">
<p>The same as GET, only no content is returned (only the header fields). You will receive the same content that you stored. E.g., if you stored a String, this is what you get back. If you stored some XML or JSON, this is what you will receive. If you stored a binary (base 64 encoded) blob, perhaps a serialized; Java; object - you will need to; deserialize this yourself.</p>
</div>
<div class="paragraph">
<p>Similarly to the GET method, the HEAD method also supports returning extended information via headers. See above.</p>
</div>
<div class="ulist">
<div class="title">Headers</div>
<ul>
<li>
<p><a href="#rest_key_content_type">Key-Content-Type</a>: OPTIONAL The content type for the Key present in the URL. When omitted, <em>application/x-java-object; type=java.lang.String</em> is assumed</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="rest_server_list_keys"><a class="anchor" href="#rest_server_list_keys"></a>Listing keys</h5>
<div class="sect5">
<h6 id="rest_server_list_get"><a class="anchor" href="#rest_server_list_get"></a><code>GET /{cacheName}</code></h6>
<div class="paragraph">
<p>This will return a list of keys present in the given cacheName as the body of the response. The format of the response can be controlled via the Accept header as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>application/xml</em> - the list of keys will be returned in XML format.</p>
</li>
<li>
<p><em>application/json</em> - the list of keys will be return in JSON format.</p>
</li>
<li>
<p><em>text/plain</em> - the list of keys will be returned in plain text format, one key per line</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the cache identified by cacheName is distributed, only the keys owned by the node handling the request will be returned. To return all keys, append the "global" parameter to the query, as follows:</p>
</div>
<div class="paragraph">
<p><code>GET /cacheName?global</code></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="rest_server_remove_data"><a class="anchor" href="#rest_server_remove_data"></a>Removing data</h5>
<div class="paragraph">
<p>Data can be removed at the cache key/element level, or via a whole cache name using the HTTP delete method.</p>
</div>
<div class="sect5">
<h6 id="rest_server_delete_keys"><a class="anchor" href="#rest_server_delete_keys"></a><code>DELETE /{cacheName}/{cacheKey}</code></h6>
<div class="paragraph">
<p>Removes the given key name from the cache.</p>
</div>
<div class="ulist">
<div class="title">Headers</div>
<ul>
<li>
<p><a href="#rest_key_content_type">Key-Content-Type</a>: OPTIONAL The content type for the Key present in the URL. When omitted, <em>application/x-java-object; type=java.lang.String</em> is assumed</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="rest_server_delete_cache"><a class="anchor" href="#rest_server_delete_cache"></a><code>DELETE /{cacheName}</code></h6>
<div class="paragraph">
<p>Removes ALL the entries in the given cache name (i.e., everything from that path down). If the operation is successful, it returns 200 code.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Make it quicker!</div>
Set the header performAsync to true to return immediately and let the removal happen in the background.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="rest_server_query"><a class="anchor" href="#rest_server_query"></a>Querying</h5>
<div class="paragraph">
<p>The REST server supports Ickle Queries in JSON format. It&#8217;s important that the cache is configured with
<em>application/x-protostream</em> for both Keys and Values. If the cache is indexed, no configuration is needed.</p>
</div>
<div class="sect5">
<h6 id="rest_server_query_get"><a class="anchor" href="#rest_server_query_get"></a><code>GET /{cacheName}?action=search&amp;query={ickle query}</code></h6>
<div class="paragraph">
<p>Will execute an Ickle query in the given cache name.</p>
</div>
<div class="ulist">
<div class="title">Request parameters</div>
<ul>
<li>
<p><em>query</em>: REQUIRED the query string</p>
</li>
<li>
<p><em>max_results</em>: OPTIONAL the number of results to return, default is <em>10</em></p>
</li>
<li>
<p><em>offset</em>: OPTIONAL the index of the first result to return, default is <em>0</em></p>
</li>
<li>
<p><em>query_mode</em>: OPTIONAL the <a href="#query_clustered_query_api">execution mode</a> of the query once it&#8217;s received by server. Valid values are <em>FETCH</em> and <em>BROADCAST</em>. Default is <em>FETCH</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Query Result</div>
<p>Results are JSON documents containing one or more hits. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">total_results</span><span class="delimiter">&quot;</span></span> : <span class="integer">150</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">hits</span><span class="delimiter">&quot;</span></span> : [ {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">hit</span><span class="delimiter">&quot;</span></span> : {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">user1</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span> : <span class="integer">35</span>
    }
  }, {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">hit</span><span class="delimiter">&quot;</span></span> : {
       <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">user2</span><span class="delimiter">&quot;</span></span>,
       <span class="key"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span> : <span class="integer">42</span>
    }
  }, {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">hit</span><span class="delimiter">&quot;</span></span> : {
       <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">user3</span><span class="delimiter">&quot;</span></span>,
       <span class="key"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span> : <span class="integer">12</span>
    }
  } ]
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><em>total_results</em>: NUMBER, the total number of results from the query.</p>
</li>
<li>
<p><em>hits</em>: ARRAY, list of matches from the query</p>
</li>
<li>
<p><em>hit</em>: OBJECT, each result from the query. Can contain all fields or just a subset of fields in case a <em>Select</em> clause is used.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="rest_server_query_post"><a class="anchor" href="#rest_server_query_post"></a><code>POST /{cacheName}?action=search</code></h6>
<div class="paragraph">
<p>Similar to que query using GET, but the body of the request is used instead to specify the query parameters.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
 <span class="key"><span class="delimiter">&quot;</span><span class="content">query</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">from Entity where name:</span><span class="char">\&quot;</span><span class="content">user1</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>,
 <span class="key"><span class="delimiter">&quot;</span><span class="content">max_results</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span>,
 <span class="key"><span class="delimiter">&quot;</span><span class="content">offset</span><span class="delimiter">&quot;</span></span>:<span class="integer">10</span>
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rest_server_cors"><a class="anchor" href="#rest_server_cors"></a>20.8.4. CORS</h4>
<div class="paragraph">
<p>The REST server supports <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a> including preflight and rules based on the request origin.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;rest-connector</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;cors-rules&gt;</span>
      <span class="tag">&lt;cors-rule</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">restrict host1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">allow-credentials</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;allowed-origins&gt;</span>http://host1,https://host1<span class="tag">&lt;/allowed-origins&gt;</span>
         <span class="tag">&lt;allowed-methods&gt;</span>GET<span class="tag">&lt;/allowed-methods&gt;</span>
      <span class="tag">&lt;/cors-rule&gt;</span>
      <span class="tag">&lt;cors-rule</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">allow ALL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">allow-credentials</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-age-seconds</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;allowed-origins&gt;</span>*<span class="tag">&lt;/allowed-origins&gt;</span>
         <span class="tag">&lt;allowed-methods&gt;</span>GET,OPTIONS,POST,PUT,DELETE<span class="tag">&lt;/allowed-methods&gt;</span>
         <span class="tag">&lt;allowed-headers&gt;</span>Key-Content-Type<span class="tag">&lt;/allowed-headers&gt;</span>
      <span class="tag">&lt;/cors-rule&gt;</span>
   <span class="tag">&lt;/cors-rules&gt;</span>
<span class="tag">&lt;/rest-connector&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The rules are evaluated sequentially based on the "Origin" header set by the browser; in the example above if the origin is either "http://host1" or "https://host1" the rule "restrict host1" will apply,
otherwise the next rule will be tested. Since the rule "allow ALL" permits all origins, any script coming from a different origin will be able to perform the methods specified and use the headers supplied.</p>
</div>
<div class="paragraph">
<p>The &lt;cors-rule&gt; element can be configured as follows:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Config</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Mandatory</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the rule</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allow-credentials</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable CORS requests to use credentials</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed-origins</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A comma separated list used to set the CORS 'Access-Control-Allow-Origin' header to indicate the response can be shared with the origins</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed-methods</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A comma separated list used to set the CORS 'Access-Control-Allow-Methods' header in the preflight response to specify the methods allowed for the configured origin(s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">max-age-seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount of time CORS preflight request headers can be cached</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">expose-headers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A comma separated list used to set the CORS 'Access-Control-Expose-Headers' in the preflight response to specify which headers can be exposed to the configured origin(s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="rest_server_client"><a class="anchor" href="#rest_server_client"></a>20.8.5. Client side code</h4>
<div class="paragraph">
<p>Part of the point of a RESTful service is that you don&#8217;t need to have tightly coupled client libraries/bindings. All you need is a HTTP client library. For Java, Apache HTTP Commons Client works just fine (and is used in the integration tests), or you can use java.net API.</p>
</div>
<div class="sect4">
<h5 id="rest_server_client_ruby"><a class="anchor" href="#rest_server_client_ruby"></a>Ruby example</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ruby"><span class="comment"># Shows how to interact with the REST api from ruby.</span>
<span class="comment"># No special libraries, just standard net/http</span>
<span class="comment">#</span>
<span class="comment"># Author: Michael Neale</span>
<span class="comment">#</span>
require <span class="string"><span class="delimiter">'</span><span class="content">net/http</span><span class="delimiter">'</span></span>

uri = <span class="constant">URI</span>.parse(<span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080/rest/default/MyKey</span><span class="delimiter">'</span></span>)
http = <span class="constant">Net</span>::<span class="constant">HTTP</span>.new(uri.host, uri.port)

<span class="comment">#Create new entry</span>

post = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Post</span>.new(uri.path, {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>})
post.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)
post.body = <span class="string"><span class="delimiter">&quot;</span><span class="content">DATA HERE</span><span class="delimiter">&quot;</span></span>

resp = http.request(post)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">POST response code : </span><span class="delimiter">&quot;</span></span> + resp.code

<span class="comment">#get it back</span>

get = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Get</span>.new(uri.path)
get.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)
resp = http.request(get)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">GET response code: </span><span class="delimiter">&quot;</span></span> + resp.code
puts <span class="string"><span class="delimiter">&quot;</span><span class="content">GET Body: </span><span class="delimiter">&quot;</span></span> + resp.body

<span class="comment">#use PUT to overwrite</span>

put = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Put</span>.new(uri.path, {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>})
put.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)
put.body = <span class="string"><span class="delimiter">&quot;</span><span class="content">ANOTHER DATA HERE</span><span class="delimiter">&quot;</span></span>

resp = http.request(put)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">PUT response code : </span><span class="delimiter">&quot;</span></span> + resp.code

<span class="comment">#and remove...</span>
delete = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Delete</span>.new(uri.path)
delete.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)

resp = http.request(delete)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">DELETE response code : </span><span class="delimiter">&quot;</span></span> + resp.code

<span class="comment">#Create binary data like this... just the same...</span>

uri = <span class="constant">URI</span>.parse(<span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080/rest/default/MyLogo</span><span class="delimiter">'</span></span>)
put = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Put</span>.new(uri.path, {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">application/octet-stream</span><span class="delimiter">&quot;</span></span>})
put.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)
put.body = <span class="constant">File</span>.read(<span class="string"><span class="delimiter">'</span><span class="content">./logo.png</span><span class="delimiter">'</span></span>)

resp = http.request(put)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">PUT response code : </span><span class="delimiter">&quot;</span></span> + resp.code

<span class="comment">#and if you want to do json...</span>
require <span class="string"><span class="delimiter">'</span><span class="content">rubygems</span><span class="delimiter">'</span></span>
require <span class="string"><span class="delimiter">'</span><span class="content">json</span><span class="delimiter">'</span></span>

<span class="comment">#now for fun, lets do some JSON !</span>
uri = <span class="constant">URI</span>.parse(<span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080/rest/jsonCache/user</span><span class="delimiter">'</span></span>)
put = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Put</span>.new(uri.path, {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>})
put.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)

data = {<span class="symbol">:name</span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">michael</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:age</span> =&gt; <span class="integer">42</span> }
put.body = data.to_json

resp = http.request(put)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">PUT response code : </span><span class="delimiter">&quot;</span></span> + resp.code

get = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Get</span>.new(uri.path)
get.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)
resp = http.request(get)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">GET Body: </span><span class="delimiter">&quot;</span></span> + resp.body</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="rest_server_client_python"><a class="anchor" href="#rest_server_client_python"></a>Python 3 example</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">urllib.request</span>

<span class="comment"># Setup basic auth</span>
base_uri = <span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080/rest/default</span><span class="delimiter">'</span></span>
auth_handler = urllib.request.HTTPBasicAuthHandler()
auth_handler.add_password(user=<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>, passwd=<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>, realm=<span class="string"><span class="delimiter">'</span><span class="content">ApplicationRealm</span><span class="delimiter">'</span></span>, uri=base_uri)
opener = urllib.request.build_opener(auth_handler)
urllib.request.install_opener(opener)

<span class="comment"># putting data in</span>
data = <span class="string"><span class="delimiter">&quot;</span><span class="content">SOME DATA HERE </span><span class="content">\!</span><span class="delimiter">&quot;</span></span>

req = urllib.request.Request(url=base_uri + <span class="string"><span class="delimiter">'</span><span class="content">/Key</span><span class="delimiter">'</span></span>, data=data.encode(<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>), method=<span class="string"><span class="delimiter">'</span><span class="content">PUT</span><span class="delimiter">'</span></span>,
                             headers={<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>})
<span class="keyword">with</span> urllib.request.urlopen(req) <span class="keyword">as</span> f:
    <span class="keyword">pass</span>

print(f.status)
print(f.reason)

<span class="comment"># getting data out</span>
resp = urllib.request.urlopen(base_uri + <span class="string"><span class="delimiter">'</span><span class="content">/Key</span><span class="delimiter">'</span></span>)
print(resp.read().decode(<span class="string"><span class="delimiter">'</span><span class="content">utf-8</span><span class="delimiter">'</span></span>))</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="rest_server_client_java"><a class="anchor" href="#rest_server_client_java"></a>Java example</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.infinispan</span>;

<span class="keyword">import</span> <span class="include">java.io.BufferedReader</span>;
<span class="keyword">import</span> <span class="include">java.io.IOException</span>;
<span class="keyword">import</span> <span class="include">java.io.InputStreamReader</span>;
<span class="keyword">import</span> <span class="include">java.io.OutputStreamWriter</span>;
<span class="keyword">import</span> <span class="include">java.net.HttpURLConnection</span>;
<span class="keyword">import</span> <span class="include">java.net.URL</span>;
<span class="keyword">import</span> <span class="include">java.util.Base64</span>;

<span class="comment">/**
 * Rest example accessing a cache.
 *
 * @author Samuel Tauil (samuel@redhat.com)
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RestExample</span> {

    <span class="comment">/**
     * Method that puts a String value in cache.
     *
     * @param urlServerAddress URL containing the cache and the key to insert
     * @param value            Text to insert
     * @param user             Used for basic auth
     * @param password         Used for basic auth
     */</span>
    <span class="directive">public</span> <span class="type">void</span> putMethod(<span class="predefined-type">String</span> urlServerAddress, <span class="predefined-type">String</span> value, <span class="predefined-type">String</span> user, <span class="predefined-type">String</span> password) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Executing PUT</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">URL</span> address = <span class="keyword">new</span> <span class="predefined-type">URL</span>(urlServerAddress);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">executing request </span><span class="delimiter">&quot;</span></span> + urlServerAddress);
        <span class="predefined-type">HttpURLConnection</span> connection = (<span class="predefined-type">HttpURLConnection</span>) address.openConnection();
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Executing put method of value: </span><span class="delimiter">&quot;</span></span> + value);
        connection.setRequestMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">PUT</span><span class="delimiter">&quot;</span></span>);
        connection.setRequestProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>);
        addAuthorization(connection, user, password);
        connection.setDoOutput(<span class="predefined-constant">true</span>);

        <span class="predefined-type">OutputStreamWriter</span> outputStreamWriter = <span class="keyword">new</span> <span class="predefined-type">OutputStreamWriter</span>(connection.getOutputStream());
        outputStreamWriter.write(value);

        connection.connect();
        outputStreamWriter.flush();
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(connection.getResponseCode() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> + connection.getResponseMessage());
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
        connection.disconnect();
    }

    <span class="comment">/**
     * Method that gets a value by a key in url as param value.
     *
     * @param urlServerAddress URL containing the cache and the key to read
     * @param user             Used for basic auth
     * @param password         Used for basic auth
     * @return String value
     */</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getMethod(<span class="predefined-type">String</span> urlServerAddress, <span class="predefined-type">String</span> user, <span class="predefined-type">String</span> password) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="predefined-type">String</span> line;
        <span class="predefined-type">StringBuilder</span> stringBuilder = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>();

        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Executing GET</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);

        <span class="predefined-type">URL</span> address = <span class="keyword">new</span> <span class="predefined-type">URL</span>(urlServerAddress);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">executing request </span><span class="delimiter">&quot;</span></span> + urlServerAddress);

        <span class="predefined-type">HttpURLConnection</span> connection = (<span class="predefined-type">HttpURLConnection</span>) address.openConnection();
        connection.setRequestMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">GET</span><span class="delimiter">&quot;</span></span>);
        connection.setRequestProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>);
        addAuthorization(connection, user, password);
        connection.setDoOutput(<span class="predefined-constant">true</span>);

        <span class="predefined-type">BufferedReader</span> bufferedReader = <span class="keyword">new</span> <span class="predefined-type">BufferedReader</span>(<span class="keyword">new</span> <span class="predefined-type">InputStreamReader</span>(connection.getInputStream()));

        connection.connect();

        <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="predefined-constant">null</span>) {
            stringBuilder.append(line).append(<span class="string"><span class="delimiter">'</span><span class="content">\n</span><span class="delimiter">'</span></span>);
        }

        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Executing get method of value: </span><span class="delimiter">&quot;</span></span> + stringBuilder.toString());

        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(connection.getResponseCode() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> + connection.getResponseMessage());
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);

        connection.disconnect();

        <span class="keyword">return</span> stringBuilder.toString();
    }

    <span class="directive">private</span> <span class="type">void</span> addAuthorization(<span class="predefined-type">HttpURLConnection</span> connection, <span class="predefined-type">String</span> user, <span class="predefined-type">String</span> pass) {
        <span class="predefined-type">String</span> credentials = user + <span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span> + pass;
        <span class="predefined-type">String</span> basic = Base64.getEncoder().encodeToString(credentials.getBytes());
        connection.setRequestProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Authorization</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Basic </span><span class="delimiter">&quot;</span></span> + basic);
    }

    <span class="comment">/**
     * Main method example.
     */</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> <span class="exception">IOException</span> {
        RestExample restExample = <span class="keyword">new</span> RestExample();
        <span class="predefined-type">String</span> user = <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>;
        <span class="predefined-type">String</span> pass = <span class="string"><span class="delimiter">&quot;</span><span class="content">pass</span><span class="delimiter">&quot;</span></span>;
        restExample.putMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/rest/default/1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan REST Test</span><span class="delimiter">&quot;</span></span>, user, pass);
        restExample.getMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/rest/default/1</span><span class="delimiter">&quot;</span></span>, user, pass);
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="memcached_server"><a class="anchor" href="#memcached_server"></a>20.9. Memcached Server</h3>
<div class="paragraph">
<p>The Infinispan Server distribution contains a server module that implements the <a href="http://github.com/memcached/memcached/blob/master/doc/protocol.txt">Memcached text protocol</a>. This allows Memcached clients to talk to one or several Infinispan backed Memcached servers. These servers could either be working standalone just like Memcached does where each server acts independently and does not communicate with the rest, or they could be clustered where servers replicate or distribute their contents to other Infinispan backed Memcached servers, thus providing clients with failover capabilities.
Please refer to Infinispan Server&#8217;s <a href="../server_guide/server_guide.html#memcached">memcached server guide</a> for instructions on how to configure and run a Memcached server.</p>
</div>
<div class="sect3">
<h4 id="memcached_client_encoding"><a class="anchor" href="#memcached_client_encoding"></a>20.9.1. Client Encoding</h4>
<div class="paragraph">
<p>The memcached text protocol assumes data values read and written by clients are raw bytes. The support for type negotiation will come
with <a href="https://github.com/memcached/memcached/wiki/BinaryProtocolRevamped#data-types">the memcached binary protocol</a> implementation, as part
of <a href="https://issues.jboss.org/browse/ISPN-8726">ISPN-8726</a>.</p>
</div>
<div class="paragraph">
<p>Although it&#8217;s not possible for a memcached client to negotiate the data type to obtain data from the server or send data in different formats, the server can optionally be configured to handle values encoded with a certain Media Type. By setting the <code>client-encoding</code> attribute in the <code>memcached-connector</code> element, the server will return content in this configured format, and clients also send data in this format.</p>
</div>
<div class="paragraph">
<p>The <code>client-encoding</code> is useful when a single cache is accessed from multiple remote endpoints (Rest, HotRod, Memcached) and it allows to tailor the responses/requests to memcached text clients. For more infomarmation on interoperability between endpoints, consult <a href="#endpoint_interop">Endpoint Interop guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="command_clarifications"><a class="anchor" href="#command_clarifications"></a>20.9.2. Command Clarifications</h4>
<div class="sect4">
<h5 id="flush_all"><a class="anchor" href="#flush_all"></a>Flush All</h5>
<div class="paragraph">
<p>Even in a clustered environment, flush_all command leads to the clearing of the Infinispan Memcached server where the call lands. There&#8217;s no attempt to propagate this flush to other nodes in the cluster. This is done so that flush_all with delay use case can be reproduced with the Infinispan Memcached server. The aim of passing a delay to flush_all is so that different Memcached servers in a full can be flushed at different times, and hence avoid overloading the database with requests as a result of all Memcached servers being empty. For more info, check the <a href="http://github.com/memcached/memcached/blob/master/doc/protocol.txt">Memcached text protocol section on flush_all</a> .</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="unsupported_features"><a class="anchor" href="#unsupported_features"></a>20.9.3. Unsupported Features</h4>
<div class="paragraph">
<p>This section explains those parts of the memcached text protocol that for one reason or the other, are not currently supported by the Infinispan based memcached implementation.</p>
</div>
<div class="sect4">
<h5 id="individual_stats"><a class="anchor" href="#individual_stats"></a>Individual Stats</h5>
<div class="paragraph">
<p>Due to difference in nature between the original memcached implementation which is C/C\\ based and the Infinispan implementation which is Java based, there&#8217;re some general purpose stats that are not supported. For these unsupported stats, Infinispan memcached server always returns 0.</p>
</div>
<div class="ulist">
<div class="title">Unsupported statistics</div>
<ul>
<li>
<p>pid</p>
</li>
<li>
<p>pointer_size</p>
</li>
<li>
<p>rusage_user</p>
</li>
<li>
<p>rusage_system</p>
</li>
<li>
<p>bytes</p>
</li>
<li>
<p>curr_connections</p>
</li>
<li>
<p>total_connections</p>
</li>
<li>
<p>connection_structures</p>
</li>
<li>
<p>auth_cmds</p>
</li>
<li>
<p>auth_errors</p>
</li>
<li>
<p>limit_maxbytes</p>
</li>
<li>
<p>threads</p>
</li>
<li>
<p>conn_yields</p>
</li>
<li>
<p>reclaimed</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="statistic_settings"><a class="anchor" href="#statistic_settings"></a>Statistic Settings</h5>
<div class="paragraph">
<p>The settings statistics section of the text protocol has not been implemented due to its volatility.</p>
</div>
</div>
<div class="sect4">
<h5 id="settings_with_arguments_parameter"><a class="anchor" href="#settings_with_arguments_parameter"></a>Settings with Arguments Parameter</h5>
<div class="paragraph">
<p>Since the arguments that can be send to the Memcached server are not documented, Infinispan Memcached server does not support passing any arguments to stats command. If any parameters are passed, the Infinispan Memcached server will respond with a CLIENT_ERROR .</p>
</div>
</div>
<div class="sect4">
<h5 id="delete_hold_time_parameter"><a class="anchor" href="#delete_hold_time_parameter"></a>Delete Hold Time Parameter</h5>
<div class="paragraph">
<p>Memcached does no longer honor the optional hold time parameter to delete command and so the Infinispan based memcached server does not implement such feature either.</p>
</div>
</div>
<div class="sect4">
<h5 id="verbosity_command"><a class="anchor" href="#verbosity_command"></a>Verbosity Command</h5>
<div class="paragraph">
<p>Verbosity command is not supported since Infinispan logging cannot be simplified to defining the logging level alone.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="talking_to_infinispan_memcached_servers_from_non_java_clients"><a class="anchor" href="#talking_to_infinispan_memcached_servers_from_non_java_clients"></a>20.9.4. Talking To Infinispan Memcached Servers From Non-Java Clients</h4>
<div class="paragraph">
<p>This section shows how to talk to Infinispan memcached server via non-java client, such as a python script.</p>
</div>
<div class="sect4">
<h5 id="multi_clustered_server_tutorial"><a class="anchor" href="#multi_clustered_server_tutorial"></a>Multi Clustered Server Tutorial</h5>
<div class="paragraph">
<p>The example showcases the distribution capabilities of Infinispan memcached severs that are not available in the original memcached implementation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Start two clustered nodes:
This configuration is the same one used for the GUI demo:</p>
<div class="literalblock">
<div class="content">
<pre>$ ./bin/standalone.sh -c clustered.xml -Djboss.node.name=nodeA
$ ./bin/standalone.sh -c clustered.xml -Djboss.node.name=nodeB -Djboss.socket.binding.port-offset=100</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Alternatively use</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./bin/domain.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Which automatically starts two nodes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute <a href="https://github.com/infinispan/infinispan/tree/master/server/memcached/src/test/resources/test_memcached_write.py">test_memcached_write.py</a> script which basically executes several write operations against the Infinispan memcached server bound to port 11211. If the script is executed successfully, you should see an output similar to this:</p>
<div class="literalblock">
<div class="content">
<pre>Connecting to 127.0.0.1:11211
Testing set ['Simple_Key': Simple value] ... OK
Testing set ['Expiring_Key' : 999 : 3] ... OK
Testing increment 3 times ['Incr_Key' : starting at 1 ]
Initialise at 1 ... OK
Increment by one ... OK
Increment again ... OK
Increment yet again ... OK
Testing decrement 1 time ['Decr_Key' : starting at 4 ]
Initialise at 4 ... OK
Decrement by one ... OK
Testing decrement 2 times in one call ['Multi_Decr_Key' : 3 ]
Initialise at 3 ... OK
Decrement by 2 ... OK</pre>
</div>
</div>
</li>
<li>
<p>Execute <a href="https://github.com/infinispan/infinispan/tree/master/server/memcached/src/test/resources/test_memcached_read.py">test_memcached_read.py</a> script which connects to server bound to 127.0.0.1:11311 and verifies that it can read the data that was written by the writer script to the first server. If the script is executed successfully, you should see an output similar to this:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code> Connecting to 127.0.0.1:11311
 Testing get ['Simple_Key'] should return Simple value ... OK
 Testing get ['Expiring_Key'] should return nothing... OK
 Testing get ['Incr_Key'] should return 4 ... OK
 Testing get ['Decr_Key'] should return 3 ... OK
 Testing get ['Multi_Decr_Key'] should return 1 ... OK</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="execute_code_remote_grid"><a class="anchor" href="#execute_code_remote_grid"></a>20.10. Executing code in the Remote Grid</h3>
<div class="paragraph">
<p>In an earlier section we described executing code in the grid. Unfortunately
these methods are designed to be used in an embedded scenario with direct
access to the grid. This section will detail how you can perform similar
functions but while using a remote client connected to the grid.</p>
</div>
</div>
<div class="sect2">
<h3 id="scripting"><a class="anchor" href="#scripting"></a>20.11. Scripting</h3>
<div class="paragraph">
<p>Scripting is a feature of Infinispan Server which allows invoking server-side scripts from remote clients.
Scripting leverages the JDK&#8217;s javax.script ScriptEngines, therefore allowing the use of any JVM languages which offer one.
By default, the JDK comes with Nashorn, a ScriptEngine capable of running JavaScript.</p>
</div>
<div class="sect3">
<h4 id="installing_scripts"><a class="anchor" href="#installing_scripts"></a>20.11.1. Installing scripts</h4>
<div class="paragraph">
<p>Scripts are stored in a special script cache, named '___script_cache'.
Adding a script is therefore as simple as put+ting it into the cache itself.
If the name of the script contains a filename extension, e.g. +myscript.js, then that extension determines the engine that
will be used to execute it.
Alternatively the script engine can be selected using script metadata (see below).
Be aware that, when security is enabled, access to the script cache via the remote protocols requires
that the user belongs to the '___script_manager' role.</p>
</div>
</div>
<div class="sect3">
<h4 id="script_metadata"><a class="anchor" href="#script_metadata"></a>20.11.2. Script metadata</h4>
<div class="paragraph">
<p>Script metadata is additional information about the script that the user can provide to the server to affect how a
script is executed.
It is contained in a specially-formatted comment on the first lines of the script.</p>
</div>
<div class="paragraph">
<p>Properties are specified as key=value pairs, separated by commas.
You can use several different comment styles: The <code>//</code>, <code>;;</code>, <code>#</code> depending on the scripting language you use.
You can split metadata over multiple lines if necessary, and you can use single (') or double (") quotes to delimit your values.</p>
</div>
<div class="paragraph">
<p>The following are examples of valid metadata comments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// name=test, language=javascript</span>
<span class="comment">// mode=local, parameters=[a,b,c]</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="metadata_properties"><a class="anchor" href="#metadata_properties"></a>Metadata properties</h5>
<div class="paragraph">
<p>The following metadata property keys are available</p>
</div>
<div class="ulist">
<ul>
<li>
<p>mode: defines the mode of execution of a script. Can be one of the following values:</p>
<div class="ulist">
<ul>
<li>
<p>local: the script will be executed only by the node handling the request. The script itself however can invoke clustered operations</p>
</li>
<li>
<p>distributed: runs the script using the Distributed Executor Service</p>
</li>
</ul>
</div>
</li>
<li>
<p>language: defines the script engine that will be used to execute the script, e.g. Javascript</p>
</li>
<li>
<p>extension: an alternative method of specifying the script engine that will be used to execute the script, e.g. js</p>
</li>
<li>
<p>role: a specific role which is required to execute the script</p>
</li>
<li>
<p>parameters: an array of valid parameter names for this script. Invocations which specify parameter names not included in this list will cause an exception.</p>
</li>
<li>
<p>datatype: optional property providing information, in the form of
Media Types (also known as MIME) about the type of the data stored in the
caches, as well as parameter and return values. Currently it only accepts a
single value which is <code>text/plain; charset=utf-8</code>, indicating that data is
String UTF-8 format. This metadata parameter is designed for remote clients
that only support a particular type of data, making it easy for them to
retrieve, store and work with parameters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since the execution mode is a characteristic of the script, nothing special needs to be done on the client to invoke scripts in different modes.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="script_bindings"><a class="anchor" href="#script_bindings"></a>20.11.3. Script bindings</h4>
<div class="paragraph">
<p>The script engine within Infinispan exposes several internal objects as bindings in the scope of the script execution.
These are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cache: the cache against which the script is being executed</p>
</li>
<li>
<p>marshaller: the marshaller to use for marshalling/unmarshalling data to the cache</p>
</li>
<li>
<p>cacheManager: the cacheManager for the cache</p>
</li>
<li>
<p>scriptingManager: the instance of the script manager which is being used to run the script. This can be used to run other scripts from a script.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="script_parameters"><a class="anchor" href="#script_parameters"></a>20.11.4. Script parameters</h4>
<div class="paragraph">
<p>Aside from the standard bindings described above, when a script is executed it can be passed a set of named parameters which also appear as bindings.
Parameters are passed as name,value pairs where name is a string and value can be any value that is understood by the marshaller in use.</p>
</div>
<div class="paragraph">
<p>The following is an example of a JavaScript script which takes two parameters, multiplicand and multiplier and multiplies them.
Because the last operation is an expression evaluation, its result is returned to the invoker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// mode=local,language=javascript</span>
multiplicand * multiplier</code></pre>
</div>
</div>
<div class="paragraph">
<p>To store the script in the script cache, use the following Hot Rod code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; scriptCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">___script_cache</span><span class="delimiter">&quot;</span></span>);
scriptCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">multiplication.js</span><span class="delimiter">&quot;</span></span>,
  <span class="string"><span class="delimiter">&quot;</span><span class="content">// mode=local,language=javascript</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> +
  <span class="string"><span class="delimiter">&quot;</span><span class="content">multiplicand * multiplier</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="running_scripts_using_the_hot_rod_java_client"><a class="anchor" href="#running_scripts_using_the_hot_rod_java_client"></a>20.11.5. Running Scripts using the Hot Rod Java client</h4>
<div class="paragraph">
<p>The following example shows how to invoke the above script by passing two named parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; cache = cacheManager.getCache();
<span class="comment">// Create the parameters for script execution</span>
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
params.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">multiplicand</span><span class="delimiter">&quot;</span></span>, <span class="integer">10</span>);
params.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">multiplier</span><span class="delimiter">&quot;</span></span>, <span class="integer">20</span>);
<span class="comment">// Run the script on the server, passing in the parameters</span>
<span class="predefined-type">Object</span> result = cache.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">multiplication.js</span><span class="delimiter">&quot;</span></span>, params);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="distributed_execution_2"><a class="anchor" href="#distributed_execution_2"></a>20.11.6. Distributed execution</h4>
<div class="paragraph">
<p>The following is a script which runs on all nodes.
Each node will return its address, and the results from all nodes will be collected in a List and returned to the client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// mode:distributed,language=javascript</span>
cacheManager.getAddress().toString();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="server_tasks"><a class="anchor" href="#server_tasks"></a>20.12. Server Tasks</h3>
<div class="paragraph">
<p>Server tasks are server-side scripts defined in Java language.
To develop a server task, you should define a class that extends
<a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tasks/ServerTask.html"><code>org.infinispan.tasks.ServerTask</code></a>
interface, defined in <code>infinispan-tasks-api</code> module.</p>
</div>
<div class="paragraph">
<p>A typical server task implementation would implement these methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tasks/ServerTask.html#setTaskContext-org.infinispan.tasks.TaskContext-"><code>setTaskContext</code></a>
allows server tasks implementors to access execution context information.
This includes task parameters, cache reference on which the task is executed&#8230;&#8203;etc.
Normally, implementors would store this information locally and use it when the task is actually executed.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tasks/Task.html#getName--"><code>getName</code></a>
should return a unique name for the task.
The client will use this name to to invoke the task.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/tasks/Task.html#getExecutionMode--"><code>getExecutionMode</code></a>
is used to decide whether to invoke the task in 1 node in a cluster of N nodes or invoke it in N nodes.
For example, server tasks that invoke stream processing are only required to be executed in 1 node in the cluster.
This is because stream processing itself makes sure processing is distributed to all nodes in cluster.</p>
</li>
<li>
<p><a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Callable.html?is-external=true#call--"><code>call</code></a>
is the method that&#8217;s invoked when the user invokes the server task.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of a hello greet task that takes as parameter the name of the person to greet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example</span>;

<span class="keyword">import</span> <span class="include">org.infinispan.tasks.ServerTask</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.tasks.TaskContext</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">HelloTask</span> <span class="directive">implements</span> ServerTask&lt;<span class="predefined-type">String</span>&gt; {

   <span class="directive">private</span> TaskContext ctx;

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> setTaskContext(TaskContext ctx) {
      <span class="local-variable">this</span>.ctx = ctx;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> call() <span class="directive">throws</span> <span class="exception">Exception</span> {
      <span class="predefined-type">String</span> name = (<span class="predefined-type">String</span>) ctx.getParameters().get().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>);
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + name;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello-task</span><span class="delimiter">&quot;</span></span>;
   }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the task has been implemented, it needs to be wrapped inside a jar.
The jar is then deployed to the Infinispan Server and from them on it can be invoked.
The Infinispan Server uses
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/ServiceLoader.html">service loader pattern</a>
to load the task, so implementations need to adhere to these requirements.
For example, server task implementations must have a zero-argument constructor.</p>
</div>
<div class="paragraph">
<p>Moreover, the jar must contain a
<code>META-INF/services/org.infinispan.tasks.ServerTask</code>
file containing the fully qualified name(s) of the server tasks included in the jar.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>example.HelloTask</code></pre>
</div>
</div>
<div class="paragraph">
<p>With jar packaged, the next step is to push the jar to the Infinispan Server.
The server is powered by WildFly Application Server, so if using Maven
<a href="https://docs.jboss.org/wildfly/plugins/maven/latest/index.html">Wildfly&#8217;s Maven plugin</a>
can be used for this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.wildfly.plugins<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>wildfly-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>1.2.0.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then call the following from command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ mvn package wildfly:deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternative ways of deployment jar files to Wildfly Application Server are explained
<a href="https://docs.jboss.org/author/display/WFLY10/Application+deployment">here</a>.</p>
</div>
<div class="paragraph">
<p>Executing the task can be done using the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Create a configuration for a locally-running server</span>
ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.addServer().host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>).port(<span class="integer">11222</span>);

<span class="comment">// Connect to the server</span>
RemoteCacheManager cacheManager = <span class="keyword">new</span> RemoteCacheManager(builder.build());

<span class="comment">// Obtain the remote cache</span>
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.getCache();

<span class="comment">// Create task parameters</span>
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; parameters = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
parameters.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">developer</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Execute task</span>
<span class="predefined-type">String</span> greet = cache.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello-task</span><span class="delimiter">&quot;</span></span>, parameters);
<span class="predefined-type">System</span>.out.println(greet);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="compat_mode"><a class="anchor" href="#compat_mode"></a>21. Compatibility Mode</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Compatibility mode is deprecated and will be removed from Infinispan. To achieve interoperability between remote endpoints, you should use protocol interoperability capabilities. See <a href="#endpoint_interop">Protocol Interoperability</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Compatibility mode configures Infinispan caches so that you can access Infinispan in multiple ways. Achieving such compatibility requires extra work from Infinispan in order to make sure that contents are converted back and forth between the different formats of each endpoint and this is the reason why compatibility mode is disabled by default.</p>
</div>
<div class="sect2">
<h3 id="enable_compatibility_mode"><a class="anchor" href="#enable_compatibility_mode"></a>21.1. Enable Compatibility Mode</h3>
<div class="paragraph">
<p>For compatibility mode to work as expected, all endpoints need to be configured with the same cache manager, and need to talk to the same cache. If you&#8217;re using the brand new <a href="http://www.jboss.org/infinispan/downloads">Infinispan Server distribution</a> , this is all done for you. If you&#8217;re in the mood to experiment with this in a standalone unit test, <a href="https://github.com/infinispan/infinispan/blob/master/integrationtests/compatibility-mode-it/src/test/java/org/infinispan/it/compatibility/CompatibilityCacheFactory.java">this class</a> shows you how you can start multiple endpoints from a single class.</p>
</div>
<div class="paragraph">
<p>So, to get started using Infinispan&#8217;s compatibility mode, it needs to be enabled, either via XML:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache&gt;</span>
   <span class="tag">&lt;compatibility</span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = ...
builder.compatibility().enable();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The key thing to remember about Infinispan&#8217;s compatibility mode is that where possible, it tries to store data unmarshalling or deserializing it. It does so because the most common use case is for it to store Java objects and having Java objects stored in deserialized form means that they&#8217;re very easy to use from an embedded cache. With this in mind, it makes some assumptions. For example, if something is stored via Hot Rod, it&#8217;s most likely coming from the reference Hot Rod client, which is written in Java, and which uses a marshaller that keeps binary payloads very compact. So, when the Hot Rod operation reaches the compatibility layer, it will try to unmarshall it, by default using the same default marshaller used by the Java Hot Rod client, hence providing good out-of-the-box support for the majority of cases.</p>
</div>
<div class="sect3">
<h4 id="optional_configuring_compatibility_marshaller"><a class="anchor" href="#optional_configuring_compatibility_marshaller"></a>21.1.1. Optional: Configuring Compatibility Marshaller</h4>
<div class="paragraph">
<p>It could happen though the client might be using a Hot Rod client written for another language other than Java, say <a href="https://github.com/infinispan/ruby-client">Ruby</a> or <a href="https://github.com/infinispan/python-client">Python</a> . In this case, some kind of custom marshaller needs to be configured that either translates that serialized payload into a Java object to be stored in the cache, or keeps it in serialized form. Both options are valid, but of course it will have an impact on what kind of objects are retrieved from Infinispan if using the embedded cache. The marshaller is expected to implement <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/commons/marshall/Marshaller.html">this interface</a>. Configuring the compatibility marshaller is optional and can be done via XML:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;local-cache&gt;</span>
   <span class="tag">&lt;compatibility</span> <span class="attribute-name">marshaller</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.CustomMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = ...
builder.compatibility().enable().marshaller(<span class="keyword">new</span> com.acme.CustomMarshaller());</code></pre>
</div>
</div>
<div class="paragraph">
<p>One concrete example of this marshaller logic can be found in the <a href="https://github.com/infinispan/infinispan/blob/master/integrationtests/compatibility-mode-it/src/test/java/org/infinispan/it/compatibility/EmbeddedRestMemcachedHotRodTest.java#L161">SpyMemcachedCompatibleMarshaller</a> . <a href="https://code.google.com/p/spymemcached/">Spy Memcached</a> uses their own transcoders in order to marshall objects, so the compatibility marshaller created is in charge of marshalling/unmarshalling data stored via Spy Memcached client. If you want to retrieve data stored via Spy Memcached via say Hot Rod, you can configure the Java Hot Rod client to use this same marshaller, and this is precisely what the test where the Spy Memcached marshaller is located is demonstrating.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="code_examples"><a class="anchor" href="#code_examples"></a>21.2. Code examples</h3>
<div class="paragraph">
<p>The best code examples available showing compatibility in action can be found in the <a href="https://github.com/infinispan/infinispan/tree/master/integrationtests/compatibility-mode-it/src/test/java/org/infinispan/it/compatibility">Infinispan Compatibility Mode testsuite</a>, but more will be developed in the near future.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="endpoint_interop"><a class="anchor" href="#endpoint_interop"></a>22. Protocol Interoperability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clients exchange data with Infinispan through endpoints such as REST or Hot Rod.</p>
</div>
<div class="paragraph">
<p>Each endpoint uses a different protocol so that clients can read and write data in a suitable format. Because Infinispan can interoperate with multiple clients at the same time, it must convert data between client formats and the storage formats.</p>
</div>
<div class="paragraph">
<p>To configure Infinispan endpoint interoperability, you should define the <a href="#encoding_media_type">MediaType</a> that sets the format for data stored in the cache.</p>
</div>
<div class="sect2">
<h3 id="considerations_with_media_types_and_endpoint_interoperability"><a class="anchor" href="#considerations_with_media_types_and_endpoint_interoperability"></a>22.1. Considerations with Media Types and Endpoint Interoperability</h3>
<div class="paragraph">
<p>Configuring Infinispan to store data with a specific media type affects client interoperability.</p>
</div>
<div class="paragraph">
<p>Although REST clients do support sending and receiving <a href="#rest_key_content_type">encoded binary data</a>, they are better at handling text formats such as JSON, XML, or plain text.</p>
</div>
<div class="paragraph">
<p>Memcached text clients can handle String-based keys and byte[] values but cannot negotiate data types with the server. These clients do not offer much flexibility when handling data formats because of the protocol definition.</p>
</div>
<div class="paragraph">
<p>Java Hot Rod clients are suitable for handling Java objects that represent entities that reside in the cache. Java Hot Rod clients use marshalling operations to serialize and deserialize those objects into byte arrays.</p>
</div>
<div class="paragraph">
<p>Similarly, non-Java Hot Rod clients, such as the C++, C#, and Javascript clients, are suitable for handling objects in the respective languages. However, non-Java Hot Rod clients can interoperate with Java Hot Rod clients using platform independent data formats.</p>
</div>
</div>
<div class="sect2">
<h3 id="rest_hot_rod_and_memcached_interoperability_with_text_based_storage"><a class="anchor" href="#rest_hot_rod_and_memcached_interoperability_with_text_based_storage"></a>22.2. REST, Hot Rod, and Memcached Interoperability with Text-Based Storage</h3>
<div class="paragraph">
<p>You can configure key and values with a text-based storage format.</p>
</div>
<div class="paragraph">
<p>For example, specify <code>text/plain; charset=UTF-8</code>, or any other character set, to set plain text as the media type. You can also specify a media type for other text-based formats such as JSON (<code>application/json</code>) or XML (<code>application/xml</code>) with an optional character set.</p>
</div>
<div class="paragraph">
<p>The following example configures the cache to store entries with the <code>text/plain; charset=UTF-8</code> media type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain; charset=UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain; charset=UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To handle the exchange of data in a text-based format, you must configure Hot Rod clients with the <code>org.infinispan.commons.marshall.StringMarshaller</code> marshaller.</p>
</div>
<div class="paragraph">
<p>REST clients must also send the correct headers when writing and reading from the cache, as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Write: <code>Content-Type: text/plain; charset=UTF-8</code></p>
</li>
<li>
<p>Read: <code>Accept: text/plain; charset=UTF-8</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Memcached clients do not require any configuration to handle text-based formats.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">This configuration is compatible with&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REST clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Memcached clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Querying and Indexing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Java objects</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="rest_hot_rod_and_memcached_interoperability_with_custom_java_objects"><a class="anchor" href="#rest_hot_rod_and_memcached_interoperability_with_custom_java_objects"></a>22.3. REST, Hot Rod, and Memcached Interoperability with Custom Java Objects</h3>
<div class="paragraph">
<p>If you store entries in the cache as marshalled, custom Java objects, you should configure the cache with the MediaType of the marshalled storage.</p>
</div>
<div class="paragraph">
<p>Java Hot Rod clients use the JBoss marshalling storage format as the default to store entries in the cache as custom Java objects.</p>
</div>
<div class="paragraph">
<p>The following example configures the cache to store entries with the <code>application/x-jboss-marshalling</code> media type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-jboss-marshalling</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-jboss-marshalling</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you use the Protostream marshaller, configure the MediaType as <code>application/x-protostream</code>. For UTF8Marshaller, configure the MediaType as <code>text/plain</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If only Hot Rod clients interact with the cache, you do not need to configure the MediaType.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Because REST clients are most suitable for handling text formats, you should use primitives such as <code>java.lang.String</code> for keys. Otherwise, REST clients must handle keys as <code>bytes[]</code> using a <a href="#rest_key_content_type">supported binary encoding</a>.</p>
</div>
<div class="paragraph">
<p>REST clients can read values for cache entries in XML or JSON format. However, the classes must be available in the server.</p>
</div>
<div class="paragraph">
<p>To read and write data from Memcached clients, you must use <code>java.lang.String</code> for keys. Values are stored and returned as marshalled objects.</p>
</div>
<div class="paragraph">
<p>Some Java Memcached clients allow data transformers that marshall and unmarshall objects. You can also configure the Memcached server module to encode responses in different formats, such as 'JSON' which is language neutral. This allows non-Java clients to interact with the data even if the storage format for the cache is Java-specific. See <a href="#memcached_client_encoding">Client Encoding</a> details for the Infinispan Memcached server module.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Storing Java objects in the cache requires you to deploy entity classes to {ProductName}. See <a href="#entities_deploy">Deploying Entity Classes</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">This configuration is compatible with&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REST clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Memcached clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Querying and Indexing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Java objects</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="java_and_non_java_client_interoperability_with_protobuf"><a class="anchor" href="#java_and_non_java_client_interoperability_with_protobuf"></a>22.4. Java and Non-Java Client Interoperability with Protobuf</h3>
<div class="paragraph">
<p>Storing data in the cache as Protobuf encoded entries provides a platform independent configuration that enables Java and Non-Java clients to access and query the cache from any endpoint.</p>
</div>
<div class="paragraph">
<p>If indexing is configured for the cache, Infinispan automatically stores keys and values with the <code>application/x-protostream</code> media type.</p>
</div>
<div class="paragraph">
<p>If indexing is not configured for the cache, you can configure it to store entries with the <code>application/x-protostream</code> media type as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan converts between <code>application/x-protostream</code> and <code>application/json</code>, which allows REST clients to read and write JSON formatted data. However REST clients must send the correct headers, as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Read Header</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="http">Read: Accept: application/json</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Write Header</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="http">Write: Content-Type: application/json</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>application/x-protostream</code> media type uses Protobuf encoding, which requires you to register a Protocol Buffers schema definition that describes the entities and marshallers that the clients use. See <a href="#storing_protobuf">Storing Protobuf Entities</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">This configuration is compatible with&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REST clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Querying and Indexing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Java objects</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="embedded_remote_interop"><a class="anchor" href="#embedded_remote_interop"></a>22.5. Custom Code Interoperability</h3>
<div class="paragraph">
<p>You can deploy custom code with Infinispan. For example, you can deploy scripts, tasks, listeners, converters, and merge policies. Because your custom code can access data directly in the cache, it must interoperate with clients that access data in the cache through different endpoints.</p>
</div>
<div class="paragraph">
<p>For example, you might create a remote task to handle custom objects stored in the cache while other clients store data in binary format.</p>
</div>
<div class="paragraph">
<p>To handle interoperability with custom code you can either convert data on demand or store data as Plain Old Java Objects (POJOs).</p>
</div>
<div class="sect3">
<h4 id="converting_data_on_demand"><a class="anchor" href="#converting_data_on_demand"></a>22.5.1. Converting Data On Demand</h4>
<div class="paragraph">
<p>If the cache is configured to store data in a binary format such as <code>application/x-protostream</code> or <code>application/x-jboss-marshalling</code>, you can configure your deployed code to perform cache operations using Java objects as the media type. See <a href="#mediatype_override">Overriding the MediaType Programmatically</a>.</p>
</div>
<div class="paragraph">
<p>This approach allows remote clients to use a binary format for storing cache entries, which is optimal. However, you must make entity classes available to the server so that it can convert between binary format and Java objects.</p>
</div>
<div class="paragraph">
<p>Additionally, if the cache uses Protobuf (<code>application/x-protostream</code>) as the binary format, you must deploy protostream marshallers so that {ProductName} can unmarshall data from your custom code. See <a href="#protostream_deployment">Deploying Protostream Marshallers</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="storing_data_as_pojos"><a class="anchor" href="#storing_data_as_pojos"></a>22.5.2. Storing Data as POJOs</h4>
<div class="paragraph">
<p>Storing unmarshalled Java objects in the server is not recommended. Doing so requires Infinispan to serialize data when remote clients read from the cache and then deserialize data when remote clients write to the cache.</p>
</div>
<div class="paragraph">
<p>The following example configures the cache to store entries with the <code>application/x-java-object</code> media type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hot Rod clients must use a supported marshaller when data is stored as POJOs in the cache, either the JBoss marshaller or the default Java serialization mechanism. You must also deploy the classes must be deployed in the server.</p>
</div>
<div class="paragraph">
<p>REST clients must use a storage format that Infinispan can convert to and from Java objects, currently JSON or XML.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Storing Java objects in the cache requires you to deploy entity classes to Infinispan. See <a href="#entities_deploy">Deploying Entity Classes</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Memcached clients must send and receive a serialized version of the stored POJO, which is a JBoss marshalled payload by default. However if you configure the <a href="#memcached_client_encoding">Client Encoding</a> in the appropriate Memcached connector, you change the storage format so that Memcached clients use a platform neutral format such as <code>JSON</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">This configuration is compatible with&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REST clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Querying and Indexing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes. However, querying and indexing works with POJOs only if the entities are <a href="#query_library">annotated</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Java objects</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="entities_deploy"><a class="anchor" href="#entities_deploy"></a>22.6. Deploying Entity Classes</h3>
<div class="paragraph">
<p>If you plan to store entries in the cache as custom Java objects or POJOs, you must deploy entity classes to Infinispan. Clients always exchange objects as <code>bytes[]</code>. The entity classes represent those custom objects so that Infinispan can serialize and deserialize them.</p>
</div>
<div class="paragraph">
<p>To make entity classes available to the server, do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a <code>JAR</code> file that contains the entities and dependencies.</p>
</li>
<li>
<p>Stop Infinispan if it is running.</p>
<div class="paragraph">
<p>Infinispan loads entity classes during boot. You cannot make entity classes available to Infinispan if the server is running.</p>
</div>
</li>
<li>
<p>Copy the <code>JAR</code> file to the <strong><em>$INFINISPAN_HOME/standalone/deployments/</em></strong> directory.</p>
</li>
<li>
<p>Specify the <code>JAR</code> file as a module in the cache manager configuration, as in the following example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;modules&gt;</span>
     <span class="tag">&lt;module</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">deployment.my-entities.jar</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/modules&gt;</span>
   ...
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trying_the_interoperability_demo"><a class="anchor" href="#trying_the_interoperability_demo"></a>22.7. Trying the Interoperability Demo</h3>
<div class="paragraph">
<p>Try the demo for protocol interoperability using the Infinispan Docker image at: <a href="https://github.com/infinispan-demos/endpoint-interop" class="bare">https://github.com/infinispan-demos/endpoint-interop</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="security"><a class="anchor" href="#security"></a>23. Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Security within Infinispan is implemented at several layers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>within the core library, to provide coarse-grained access control to CacheManagers, Caches and data</p>
</li>
<li>
<p>over remote protocols, to obtain credentials from remote clients and to secure the transport using encryption</p>
</li>
<li>
<p>between nodes in a cluster, so that only authorized nodes can join and to secure the transport using encryption</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to maximize compatibility and integration, Infinispan uses widespread security standards where possible and appropriate, such as X.509 certificates, SSL/TLS encryption and Kerberos/GSSAPI.
Also, to avoid pulling in any external dependencies and to increase the ease of integration with third party libraries and containers, the implementation makes use of any facilities provided by the
standard Java security libraries (JAAS, JSSE, JCA, JCE, SASL, etc).
For this reason, the Infinispan core library only provides interfaces and a set of basic implementations.</p>
</div>
<div class="sect2">
<h3 id="security_embedded"><a class="anchor" href="#security_embedded"></a>23.1. Embedded Security</h3>
<div class="paragraph">
<p>Applications interact with Infinispan using its API within the same JVM. The two main components which are exposed by the Infinispan API are CacheManagers and Caches. If an application wants to interact with a secured CacheManager and Cache, it should provide an identity which Infinispans security layer will validate against a set of required roles and permissions. If the identity provided by the user application has sufficient permissions, then access will be granted, otherwise an exception indicating a security violation will be thrown. The identity is represented by the javax.security.auth.Subject class which is a wrapper around multiple Principals, e.g. a user and all the groups it belongs to. Since the Principal name is dependent on the owning system (e.g. a Distinguished Name in LDAP), Infinispan needs to be able to map Principal names to roles.
Roles, in turn, represent one or more permissions. The following diagram shows the relationship between the various elements:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/SecurityRolesPermissions.png" alt="Roles/Permissions mapping">
</div>
<div class="title">Figure 21. Roles/Permissions mapping</div>
</div>
<div class="sect3">
<h4 id="security_embedded_permissions"><a class="anchor" href="#security_embedded_permissions"></a>23.1.1. Embedded Permissions</h4>
<div class="paragraph">
<p>Access to a cache manager or a cache is controlled by using a list of required permissions. Permissions are concerned with the type of action that is performed on one of the above entities and not with the type of data being manipulated. Some of these permissions can be narrowed to specifically named entities, where applicable (e.g. a named cache). Depending on the type of entity, there are different types of permission available:</p>
</div>
<div class="sect4">
<h5 id="security_embedded_cache_mgr_permissions"><a class="anchor" href="#security_embedded_cache_mgr_permissions"></a>Cache Manager permissions</h5>
<div class="ulist">
<ul>
<li>
<p>CONFIGURATION (defineConfiguration): whether a new cache configuration can be defined</p>
</li>
<li>
<p>LISTEN (addListener): whether listeners can be registered against a cache manager</p>
</li>
<li>
<p>LIFECYCLE (stop): whether the cache manager can be stopped</p>
</li>
<li>
<p>ALL: a convenience permission which includes all of the above</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="security_embedded_cache_permissions"><a class="anchor" href="#security_embedded_cache_permissions"></a>Cache permissions</h5>
<div class="ulist">
<ul>
<li>
<p>READ (get, contains): whether entries can be retrieved from the cache</p>
</li>
<li>
<p>WRITE (put, putIfAbsent, replace, remove, evict): whether data can be written/replaced/removed/evicted from the cache</p>
</li>
<li>
<p>EXEC (distexec, streams): whether code execution can be run against the cache</p>
</li>
<li>
<p>LISTEN (addListener): whether listeners can be registered against a cache</p>
</li>
<li>
<p>BULK_READ (keySet, values, entrySet, query): whether bulk retrieve operations can be executed</p>
</li>
<li>
<p>BULK_WRITE (clear, putAll): whether bulk write operations can be executed</p>
</li>
<li>
<p>LIFECYCLE (start, stop): whether a cache can be started / stopped</p>
</li>
<li>
<p>ADMIN (getVersion, addInterceptor*, removeInterceptor, getInterceptorChain, getEvictionManager, getComponentRegistry, getDistributionManager, getAuthorizationManager, evict, getRpcManager, getCacheConfiguration, getCacheManager, getInvocationContextContainer, setAvailability, getDataContainer, getStats, getXAResource): whether access to the underlying components/internal structures is allowed</p>
</li>
<li>
<p>ALL: a convenience permission which includes all of the above</p>
</li>
<li>
<p>ALL_READ: combines READ and BULK_READ</p>
</li>
<li>
<p>ALL_WRITE: combines WRITE and BULK_WRITE</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some permissions might need to be combined with others in order to be useful.
For example, suppose you want to allow only "supervisors" to be able to run
stream operations, while "standard" users can only perform puts and gets, you would define the following mappings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permission</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">READ WRITE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">supervisors</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permission</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">READ WRITE EXEC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="security_embedded_api"><a class="anchor" href="#security_embedded_api"></a>23.1.2. Embedded API</h4>
<div class="paragraph">
<p>When a DefaultCacheManager has been constructed with security enabled using either the programmatic or declarative configuration, it returns a SecureCache which will check the security context before invoking any operations on the underlying caches. A SecureCache also makes sure that applications cannot retrieve lower-level insecure objects (such as DataContainer).
In Java, executing code with a specific identity usually means wrapping the code to be executed within a PrivilegedAction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.security.Security</span>;

<span class="predefined-type">Security</span>.doAs(subject, <span class="keyword">new</span> <span class="predefined-type">PrivilegedExceptionAction</span>&lt;<span class="predefined-type">Void</span>&gt;() {
<span class="directive">public</span> <span class="predefined-type">Void</span> run() <span class="directive">throws</span> <span class="exception">Exception</span> {
    cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
}
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using Java 8, the above call can be simplified to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Security</span>.doAs(mySubject, <span class="predefined-type">PrivilegedAction</span>&lt;<span class="predefined-type">String</span>&gt;() -&gt; cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the use of Security.doAs() in place of the typical Subject.doAs(). While in Infinispan you can use either, unless you really need to modify the AccessControlContext for reasons specific to your application&#8217;s security model, using Security.doAs() provides much better performance. If you need the current Subject, use the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Security</span>.getSubject();</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will automatically retrieve the Subject either from the Infinispan&#8217;s context or from the AccessControlContext.</p>
</div>
<div class="paragraph">
<p>Infinispan also fully supports running under a full-blown SecurityManager. The Infinispan distribution contains an example security.policy file which you should customize with the appropriate paths before supplying it to your JVM.</p>
</div>
</div>
<div class="sect3">
<h4 id="security_embedded_config"><a class="anchor" href="#security_embedded_config"></a>23.1.3. Embedded Configuration</h4>
<div class="paragraph">
<p>There are two levels of configuration: global and per-cache. The global configuration defines the set of roles/permissions mappings while each cache can decide whether to enable authorization checks and the required roles.</p>
</div>
<div class="listingblock">
<div class="title">Programmatic</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  GlobalConfigurationBuilder global = <span class="keyword">new</span> GlobalConfigurationBuilder();
  global
     .security()
        .authorization().enable()
           .principalRoleMapper(<span class="keyword">new</span> IdentityRoleMapper())
           .role(<span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>)
              .permission(AuthorizationPermission.ALL)
           .role(<span class="string"><span class="delimiter">&quot;</span><span class="content">supervisor</span><span class="delimiter">&quot;</span></span>)
              .permission(AuthorizationPermission.EXEC)
              .permission(AuthorizationPermission.READ)
              .permission(AuthorizationPermission.WRITE)
           .role(<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>)
              .permission(AuthorizationPermission.READ);
  ConfigurationBuilder config = <span class="keyword">new</span> ConfigurationBuilder();
  config
     .security()
        .authorization()
           .enable()
           .role(<span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>)
           .role(<span class="string"><span class="delimiter">&quot;</span><span class="content">supervisor</span><span class="delimiter">&quot;</span></span>)
           .role(<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Declarative</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;security&gt;</span>
         <span class="tag">&lt;authorization&gt;</span>
            <span class="tag">&lt;identity-role-mapper</span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permissions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permissions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">READ</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permissions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WRITE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;role</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">supervisor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">permissions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">READ WRITE EXEC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/authorization&gt;</span>
      <span class="tag">&lt;/security&gt;</span>
      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;security&gt;</span>
            <span class="tag">&lt;authorization</span> <span class="attribute-name">roles</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">admin reader writer supervisor</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;/security&gt;</span>
      <span class="tag">&lt;/local-cache&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>

<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="security_role_mappers"><a class="anchor" href="#security_role_mappers"></a>Role Mappers</h5>
<div class="paragraph">
<p>In order to convert the Principals in a Subject into a set of roles to be used when authorizing, a suitable PrincipalRoleMapper must be specified in the global configuration. Infinispan comes with 3 mappers and also allows you to provide a custom one:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>IdentityRoleMapper (Java: org.infinispan.security.impl.IdentityRoleMapper, XML: &lt;identity-role-mapper /&gt;): this mapper just uses the Principal name as the role name</p>
</li>
<li>
<p>CommonNameRoleMapper (Java: org.infinispan.security.impl.CommonRoleMapper, XML: &lt;common-name-role-mapper /&gt;): if the Principal name is a Distinguished Name (DN), this mapper extracts the Common Name (CN) and uses it as a role name. For example
the DN cn=managers,ou=people,dc=example,dc=com will be mapped to the role managers</p>
</li>
<li>
<p>ClusterRoleMapper (Java: org.infinispan.security.impl.ClusterRoleMapper XML: &lt;cluster-role-mapper /&gt;): a mapper which uses the ClusterRegistry to store principal to role mappings. This allows the use of the CLI&#8217;s GRANT and DENY commands to add/remove roles to a principal.</p>
</li>
<li>
<p>Custom role mappers (XML: &lt;custom-role-mapper class="a.b.c" /&gt;): just supply the fully-qualified class name of an implementation of org.infinispan.security.PrincipalRoleMapper</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security_cluster"><a class="anchor" href="#security_cluster"></a>23.2. Cluster security</h3>
<div class="paragraph">
<p>JGroups can be configured so that nodes need to authenticate each other when joining / merging. The authentication uses SASL and is setup by adding the SASL protocol to your JGroups XML configuration above the GMS protocol, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SASL</span> <span class="attribute-name">mech</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DIGEST-MD5</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">client_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node_user</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">client_password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node_password</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">server_callback_handler_class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.example.infinispan.security.JGroupsSaslServerCallbackHandler</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">client_callback_handler_class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.example.infinispan.security.JGroupsSaslClientCallbackHandler</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">sasl_props</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.sun.security.sasl.digest.realm=test_realm</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, the SASL mech will be DIGEST-MD5. Each node will need to declare the user and password it will use when joining the cluster. The behaviour of a node differs depending on whether it is the coordinator or any other node. The coordinator acts as the SASL server, whereas joining/merging nodes act as SASL clients. Therefore two different CallbackHandlers are required, the server_callback_handler_class will be used by the coordinator, and the client_callback_handler_class will be used by the other nodes.
The SASL protocol in JGroups is only concerned with the authentication process. If you wish to implement node authorization, you can do so within the server callback handler, by throwing an Exception. The following example shows how this can be done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">AuthorizingServerCallbackHandler</span> <span class="directive">implements</span> <span class="predefined-type">CallbackHandler</span> {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> handle(<span class="predefined-type">Callback</span><span class="type">[]</span> callbacks) <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">UnsupportedCallbackException</span> {
        <span class="keyword">for</span> (<span class="predefined-type">Callback</span> callback : callbacks) {
            ...
            if (callback <span class="keyword">instanceof</span> <span class="predefined-type">AuthorizeCallback</span>) {
                <span class="predefined-type">AuthorizeCallback</span> acb = (<span class="predefined-type">AuthorizeCallback</span>) callback;
                UserProfile user = UserManager.loadUser(acb.getAuthenticationID());
                <span class="keyword">if</span> (!user.hasRole(<span class="string"><span class="delimiter">&quot;</span><span class="content">myclusterrole</span><span class="delimiter">&quot;</span></span>)) {
                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">SecurityException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unauthorized node </span><span class="delimiter">&quot;</span></span> +user);
                }
            }
            ...
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integrations"><a class="anchor" href="#integrations"></a>24. Integrations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan can be integrated with a number of other projects, as detailed below.</p>
</div>
<div class="sect2">
<h3 id="apache_spark"><a class="anchor" href="#apache_spark"></a>24.1. Apache Spark</h3>
<div class="paragraph">
<p>Infinispan provides an <a href="http://spark.apache.org">Apache Spark</a> connector capable of exposing caches as an RDD, allowing batch and stream jobs to be run against data stored in Infinispan. For further details, see the <a href="https://github.com/infinispan/infinispan-spark/blob/master/README.md">Infinispan Spark connector documentation</a>.
Also check the <a href="https://github.com/infinispan/infinispan-spark/tree/master/examples/twitter/README.md">Docker based Twitter demo</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="apache_hadoop"><a class="anchor" href="#apache_hadoop"></a>24.2. Apache Hadoop</h3>
<div class="paragraph">
<p>The Infinispan Hadoop connector can be used to expose Infinispan as a Hadoop compliant data source and sink that implements <a href="https://hadoop.apache.org/docs/stable/api/org/apache/hadoop/mapreduce/InputFormat.html">InputFormat</a>/<a href="https://hadoop.apache.org/docs/stable/api/org/apache/hadoop/mapreduce/OutputFormat.html">OutputFormat</a>.
For further details, refer to the full <a href="https://github.com/infinispan/infinispan-hadoop/blob/master/README.md">documentation</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="integrations_lucene_directory"><a class="anchor" href="#integrations_lucene_directory"></a>24.3. Apache Lucene</h3>
<div class="paragraph">
<p>Infinispan includes a highly scalable distributed <a href="http://lucene.apache.org">Apache Lucene Directory</a> implementation.</p>
</div>
<div class="paragraph">
<p>This directory closely mimics the same semantics of the traditional filesystem and RAM-based directories, being able to work as a drop-in replacement for existing applications using Lucene and providing reliable index sharing and other features of Infinispan like node auto-discovery, automatic failover and rebalancing, optionally transactions, and can be backed by traditional storage solutions as filesystem, databases or cloud store engines.</p>
</div>
<div class="paragraph">
<p>The implementation extends Lucene&#8217;s <em>org.apache.lucene.store.Directory</em> so it can be used to <em>store</em> the index in a cluster-wide shared memory, making it easy to distribute the index. Compared to rsync-based replication this solution is suited for use cases in which your application makes frequent changes to the index and you need them to be quickly distributed to all nodes. Consistency levels, synchronicity and guarantees, total elasticity and auto-discovery are all configurable; also changes applied to the index can optionally participate in a JTA transaction, optionally supporting XA transactions with recovery.</p>
</div>
<div class="paragraph">
<p>Two different <em>LockFactory</em> implementations are provided to guarantee only one <em>IndexWriter</em> at a time will make changes to the index, again implementing the same semantics as when opening an index on a local filesystem. As with other Lucene Directories, you can override the <em>LockFactory</em> if you prefer to use an alternative implementation.</p>
</div>
<div class="sect3">
<h4 id="lucene_compatibility"><a class="anchor" href="#lucene_compatibility"></a>24.3.1. Lucene compatibility</h4>
<div class="paragraph">
<p>Apache Lucene versions 5.5.x</p>
</div>
</div>
<div class="sect3">
<h4 id="maven_dependencies_2"><a class="anchor" href="#maven_dependencies_2"></a>24.3.2. Maven dependencies</h4>
<div class="paragraph">
<p>All you need is the following:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
<span class="tag">&lt;artifactId&gt;</span>infinispan-lucene-directory<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
</div>
<div class="sect3">
<h4 id="how_to_use_it"><a class="anchor" href="#how_to_use_it"></a>24.3.3. How to use it</h4>
<div class="paragraph">
<p>See the below example of using the Infinispan Lucene Directory in order to index and query a single Document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.io.IOException</span>;

<span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.standard.StandardAnalyzer</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.document.Document</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.document.Field</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.document.StringField</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.index.DirectoryReader</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.index.IndexWriter</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.index.IndexWriterConfig</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.index.Term</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.search.IndexSearcher</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.search.TermQuery</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.search.TopDocs</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.store.Directory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.lucene.directory.DirectoryBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.manager.DefaultCacheManager</span>;

<span class="comment">// Create caches that will store the index. Here the programmatic configuration is used</span>
DefaultCacheManager defaultCacheManager = <span class="keyword">new</span> DefaultCacheManager();
Cache metadataCache = defaultCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">metadataCache</span><span class="delimiter">&quot;</span></span>);
Cache dataCache = defaultCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">dataCache</span><span class="delimiter">&quot;</span></span>);
Cache lockCache = defaultCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">lockCache</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Create the directory</span>
Directory directory = DirectoryBuilder.newDirectoryInstance(metadataCache, dataCache, lockCache, indexName).create();

<span class="comment">// Use the directory in Lucene</span>
IndexWriterConfig indexWriterConfig = <span class="keyword">new</span> IndexWriterConfig(<span class="keyword">new</span> StandardAnalyzer()).setOpenMode(IndexWriterConfig.OpenMode.CREATE_OR_APPEND);

IndexWriter indexWriter = <span class="keyword">new</span> IndexWriter(directory, indexWriterConfig);

<span class="comment">// Index a single document</span>
<span class="predefined-type">Document</span> doc = <span class="keyword">new</span> <span class="predefined-type">Document</span>();
doc.add(<span class="keyword">new</span> StringField(<span class="string"><span class="delimiter">&quot;</span><span class="content">field</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Field</span>.Store.NO));
indexWriter.addDocument(doc);
indexWriter.close();

<span class="comment">// Querying the inserted document</span>
DirectoryReader directoryReader = DirectoryReader.open(directory);
IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(directoryReader);
TermQuery query = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string"><span class="delimiter">&quot;</span><span class="content">field</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>));
TopDocs topDocs = searcher.search(query, <span class="integer">10</span>);
<span class="predefined-type">System</span>.out.println(topDocs.totalHits);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>indexName</em> in the <em>DirectoryBuilder</em> is a unique key to identify your index. It takes the same role as the path did on filesystem based indexes: you can create several different indexes giving them different names. When you use the same <em>indexName</em> in another instance connected to the same network (or instantiated on the same machine, useful for testing) they will join, form a cluster and share all content. Using a different <em>indexName</em> allows you to store different indexes in the same set of Caches.</p>
</div>
<div class="paragraph">
<p>The <em>metadataCache</em>, <em>dataCache</em> and <em>lockCache</em> are the caches that will store the indexes. More details provided below.</p>
</div>
<div class="paragraph">
<p>New nodes can be added or removed dynamically, making the service administration very easy and also suited for cloud environments: it&#8217;s simple to react to load spikes, as adding more memory and CPU power to the search system is done by just starting more nodes.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuration_10"><a class="anchor" href="#configuration_10"></a>24.3.4. Configuration</h4>
<div class="paragraph">
<p>Infinispan can be configured as LOCAL clustering mode, in which case it will disable clustering features and serve as a cache for the index, or any clustering mode. A transaction manager is not mandatory, but when enabled the changes to the index can participate in transactions.</p>
</div>
<div class="paragraph">
<p>Batching was required in previous versions, it&#8217;s not strictly needed anymore.</p>
</div>
<div class="paragraph">
<p>As pointed out in the javadocs of <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/lucene/directory/DirectoryBuilder.html">DirectoryBuilder</a>, it&#8217;s possible for it to use more than a single cache, using specific configurations for different purposes. Each cache is explained below:</p>
</div>
<div class="sect4">
<h5 id="lock_cache"><a class="anchor" href="#lock_cache"></a>Lock Cache</h5>
<div class="paragraph">
<p>The lock cache is used to store a single entry per index that will function as the directory lock. Given the small storage requirement this cache is usually configured as REPL_SYNC. Example of declarative configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesLocking</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">25000</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;memory&gt;</span>
       <span class="tag">&lt;object</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/memory&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="metadata_cache"><a class="anchor" href="#metadata_cache"></a>Metadata Cache</h5>
<div class="paragraph">
<p>The metadata cache is used to store information about the files of the directory, such as buffer sizes and number of chunks. It uses more space than the Lock Cache, but not as much as the Data Cache, so using a REPL_SYNC cache should be fine for most cases.
Example of configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesMetadaData</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">25000</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;memory&gt;</span>
       <span class="tag">&lt;object</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/memory&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="data_cache"><a class="anchor" href="#data_cache"></a>Data Cache</h5>
<div class="paragraph">
<p>The Infinispan Lucene directory splits large (bigger than the chunkSize configuration) files into chunks and stores them in the Data cache.
This is the largest of the 3 index caches, and both DIST_SYNC/REPL_SYNC cache modes can be used.
Usage of REPL_SYNC offers lower latencies for queries since each node holds the whole index locally; DIST_SYNC, on the other hand, will affect query latency due to remote calls to fetch for chunks, but offers better scalability.</p>
</div>
<div class="paragraph">
<p>Example of configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LuceneIndexesData</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">25000</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;memory&gt;</span>
       <span class="tag">&lt;object</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/memory&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using_a_cacheloader"><a class="anchor" href="#using_a_cacheloader"></a>24.3.5. Using a CacheLoader</h4>
<div class="paragraph">
<p>Using a CacheLoader you can have the index content backed up to a permanent storage; you can use a shared store for all nodes or one per node, see <a href="#cache_passivation">cache passivation</a> for more details.</p>
</div>
<div class="paragraph">
<p>When using a CacheLoader to store a Lucene index, to get best write performance you would need to configure the CacheLoader with <em>async=true</em> .</p>
</div>
</div>
<div class="sect3">
<h4 id="storing_the_index_in_a_database"><a class="anchor" href="#storing_the_index_in_a_database"></a>24.3.6. Storing the index in a database</h4>
<div class="paragraph">
<p>It might be useful to store the Lucene index in a relational database; this would be very slow but Infinispan can act as a cache between the application and the JDBC interface, making this configuration useful in both clustered and non-clustered configurations. When storing indexes in a JDBC database, it&#8217;s suggested to use the <em>JdbcStringBasedCacheStore</em> , which will need the <code>key-to-string-mapper</code> attribute to be set to <code>org.infinispan.lucene.LuceneKey2StringMapper</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;jdbc:string-keyed-jdbc-store</span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">key-to-string-mapper</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.lucene.LuceneKey2StringMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="loading_an_existing_lucene_index"><a class="anchor" href="#loading_an_existing_lucene_index"></a>24.3.7. Loading an existing Lucene Index</h4>
<div class="paragraph">
<p>The <em>org.infinispan.lucene.cachestore.LuceneCacheLoader</em> is an Infinispan CacheLoader able to have Infinispan directly load data from an existing Lucene index into the grid. Currently this supports reading only.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>location</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path where the indexes are stored. Subdirectories (of first level only) should contain the indexes to be loaded, each directory matching the index name attribute of the Infinispan Directory constructor.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none (mandatory)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>autoChunkSize</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A threshold in bytes: if any segment is larger than this, it will be transparently chunked in smaller cache entries up to this size.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32MB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It&#8217;s worth noting that the IO operations are delegated to Lucene&#8217;s standard <em>org.apache.lucene.store.FSDirectory</em> , which will select an optimal approach for the running platform.</p>
</div>
<div class="paragraph">
<p>Implementing write-through should not be hard: you&#8217;re welcome to try implementing it.</p>
</div>
</div>
<div class="sect3">
<h4 id="architectural_limitations"><a class="anchor" href="#architectural_limitations"></a>24.3.8. Architectural limitations</h4>
<div class="paragraph">
<p>This Directory implementation makes it possible to have almost real-time reads across multiple nodes. A fundamental limitation of the Lucene design is that only a single IndexWriter is allowed to make changes on the index: a pessimistic lock is acquired by the writer; this is generally ok as a single IndexWriter <em>instance</em> is very fast and accepts update requests from multiple threads. When sharing the Directory across Infinispan nodes the IndexWriter limitation is not lifted: since you can have only one instance, that reflects in your application as having to apply all changes on the same node. There are several strategies to write from multiple nodes on the same index:</p>
</div>
<div class="ulist">
<div class="title">Index write strategies</div>
<ul>
<li>
<p>One node writes, the other delegate to it sending messages</p>
</li>
<li>
<p>Each node writes on turns</p>
</li>
<li>
<p>You application makes sure it will only ever apply index writes on one node</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <em>Infinispan Lucene Directory</em> protects its content by implementing a distributed locking strategy, though this is designed as a last line of defense and is not to be considered an efficient mechanism to coordinate multiple writes: if you don&#8217;t apply one of the above suggestions and get high write contention from multiple nodes you will likely get timeout exception.</p>
</div>
</div>
<div class="sect3">
<h4 id="suggestions_for_optimal_performance"><a class="anchor" href="#suggestions_for_optimal_performance"></a>24.3.9. Suggestions for optimal performance</h4>
<div class="sect4">
<h5 id="jgroups_and_networking_stack"><a class="anchor" href="#jgroups_and_networking_stack"></a>JGroups and networking stack</h5>
<div class="paragraph">
<p>JGroups manages all network IO and as such it is a critical component to tune for your specific environment. Make sure to read the <a href="http://jgroups.org/manual-3.x/html/index.html">JGroups reference documentation</a>, and play with the performance tests included in JGroups to make sure your network stack is setup appropriately. Don&#8217;t forget to check also operating system level parameters, for example buffer sizes dedicated for networking. JGroups will log warning when it detects something wrong, but there is much more you can look into.</p>
</div>
</div>
<div class="sect4">
<h5 id="using_a_cachestore"><a class="anchor" href="#using_a_cachestore"></a>Using a CacheStore</h5>
<div class="paragraph">
<p>Currently all CacheStore implementations provided by Infinispan have a significant slowdown; we hope to resolve that soon but for the time being if you need high performance on writes with the Lucene Directory the best option is to disable any CacheStore; the second best option is to configure the CacheStore as <em>async</em> . If you only need to load a Lucene index from read-only storage, see the above description for <em>org.infinispan.lucene.cachestore.LuceneCacheLoader</em> .</p>
</div>
</div>
<div class="sect4">
<h5 id="apply_standard_lucene_tuning"><a class="anchor" href="#apply_standard_lucene_tuning"></a>Apply standard Lucene tuning</h5>
<div class="paragraph">
<p>All known options of Lucene apply to the Infinispan Lucene Directory as well; of course the effect might be less significant in some cases, but you should definitely read the <a href="http://lucene.apache.org/core/index.html">Apache Lucene documentation</a> .</p>
</div>
</div>
<div class="sect4">
<h5 id="disable_batching_and_transactions"><a class="anchor" href="#disable_batching_and_transactions"></a>Disable batching and transactions</h5>
<div class="paragraph">
<p>Early versions required Infinispan to have batching or transactions enabled. This is no longer a requirement, and in fact disabling them should provide little improvement in performance.</p>
</div>
</div>
<div class="sect4">
<h5 id="set_the_right_chunk_size"><a class="anchor" href="#set_the_right_chunk_size"></a>Set the right chunk size</h5>
<div class="paragraph">
<p>The chunk size can be specified using the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/lucene/directory/DirectoryBuilder.html">DirectoryBuilder</a> fluent API. To correctly set this variable you need to estimate what the expected size of your segments is; generally this is trivial by looking at the file size of the index segments generated by your application when it&#8217;s using the standard FSDirectory. You then have to consider:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The chunk size affects the size of internally created buffers, and large chunk sizes will cause memory usage to grow. Also consider that during index writing such arrays are frequently allocated.</p>
</li>
<li>
<p>If a segment doesn&#8217;t fit in the chunk size, it&#8217;s going to be fragmented. When searching on a fragmented segment performance can&#8217;t peak.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using the <em>org.apache.lucene.index.IndexWriterConfig</em> you can tune your index writing to <em>approximately</em> keep your segment size to a reasonable level, from there then tune the chunksize, after having defined the chunksize you might want to revisit your network configuration settings.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="demo"><a class="anchor" href="#demo"></a>24.3.10. Demo</h4>
<div class="paragraph">
<p>There is a simple command-line demo of its capabilities distributed with Infinispan under demos/lucene-directory; make sure you grab the "Binaries, server and demos" package from download page, which contains all demos.</p>
</div>
<div class="paragraph">
<p>Start several instances, then try adding text in one instance and searching for it on the other. The configuration is not tuned at all, but should work out-of-the box without any changes. If your network interface has multicast enabled, it will cluster across the local network with other instances of the demo.</p>
</div>
</div>
<div class="sect3">
<h4 id="additional_links"><a class="anchor" href="#additional_links"></a>24.3.11. Additional Links</h4>
<div class="ulist">
<ul>
<li>
<p>Issue tracker: <a href="https://jira.jboss.org/browse/ISPN/component/12312732" class="bare">https://jira.jboss.org/browse/ISPN/component/12312732</a></p>
</li>
<li>
<p>Source code: <a href="https://github.com/infinispan/infinispan/tree/master/lucene/lucene-directory/src/main/java/org/infinispan/lucene" class="bare">https://github.com/infinispan/infinispan/tree/master/lucene/lucene-directory/src/main/java/org/infinispan/lucene</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrations_directory_provider"><a class="anchor" href="#integrations_directory_provider"></a>24.4. Directory Provider for Hibernate Search</h3>
<div class="paragraph">
<p>Hibernate Search applications can use Infinispan as a directory provider, taking advantage of Infinispan&#8217;s distribution and low latency capabilities to store the Lucene indexes.</p>
</div>
<div class="sect3">
<h4 id="maven_dependencies_3"><a class="anchor" href="#maven_dependencies_3"></a>24.4.1. Maven dependencies</h4>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
 <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
 <span class="tag">&lt;artifactId&gt;</span>infinispan-directory-provider<span class="tag">&lt;/artifactId&gt;</span>
 <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
</div>
<div class="sect3">
<h4 id="how_to_use_it_2"><a class="anchor" href="#how_to_use_it_2"></a>24.4.2. How to use it</h4>
<div class="paragraph">
<p>The directory provider alias is <em>"infinispan"</em>, and to enable it for an index, the following property should be in the <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#configuration">Hibernate Search configuration</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>hibernate.search.MyIndex.directory_provider = infinispan</pre>
</div>
</div>
<div class="paragraph">
<p>to enable it by default for all indexes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>hibernate.search.default.directory_provider = infinispan</pre>
</div>
</div>
<div class="paragraph">
<p>The Infinispan cluster will start with a <a href="https://github.com/infinispan/infinispan/blob/master/lucene/directory-provider/src/main/resources/default-hibernatesearch-infinispan.xml">default configuration</a>, see below how to override it.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuration_11"><a class="anchor" href="#configuration_11"></a>24.4.3. Configuration</h4>
<div class="paragraph">
<p>Optional properties allow for a custom Infinispan configuration or to use an existent <em>EmbeddedCacheManager</em>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.search.infinispan.configuration_resourcename</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom configuration for Infinispan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">config/infinispan.xml</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.search.infinispan.configuration.transport_override_resourcename</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overrides the JGroups stack in the Infinispan configuration file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jgroups-ec2.xml</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.search.infinispan.cachemanager_jndiname</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the JNDI name under which the <em>EmbeddedCacheManager</em> to use is bound. Will cause the properties above to be ignored when present</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java:jboss/infinispan/container/hibernate-search</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="architecture_considerations"><a class="anchor" href="#architecture_considerations"></a>24.4.4. Architecture considerations</h4>
<div class="paragraph">
<p>The same limitations presented in the Lucene Directory apply here, meaning the index will be shared across several nodes and only one <em>IndexWriter</em> can have the lock.</p>
</div>
<div class="paragraph">
<p>One common strategy is to use Hibernate Search&#8217;s JMS Master/Slave or JGroups backend together with the Infinispan directory provider: instead of sending updates directly to the index, they are sent to a JMS queue or JGroups channel and a single node applies all the changes on behalf of all other nodes.</p>
</div>
<div class="paragraph">
<p>Refer to the <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/">Hibernate Search documentation</a> for instructions on how to setup JMS or JGroups backends.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrations_jpa_hibernate"><a class="anchor" href="#integrations_jpa_hibernate"></a>24.5. JPA/Hibernate 2L Cache</h3>
<div class="paragraph">
<p>Hibernate manages a second-level cache where it moves data into and out as a result of operations performed by <code>Session</code> or <code>EntityManager</code> (JPA).
The second-level cache is pluggable via an SPI which Infinispan implements.
This enables Infinispan to be used as second-level cache for Hibernate.</p>
</div>
<div class="paragraph">
<p><a href="https://docs.jboss.org/hibernate/orm/5.2/userguide/html_single/Hibernate_User_Guide.html#caching">Hibernate documentation</a>
contains a lot of information about second-level cache, types of caches&#8230;&#8203;etc.
This chapter focuses on what you need to know to use Infinispan as second-level cache provider with Hibernate.</p>
</div>
<div class="paragraph">
<p>Applications running in environments where Infinispan is not default cache provider for Hibernate will need to depend on the correct cache provider version.</p>
</div>
<div class="paragraph">
<p>The Infinispan cache provider version suitable for your application depends on the Hibernate version in use:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Hibernate 5.3</dt>
<dd>
<p>Use the following Maven coordinates:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-hibernate-cache-v53<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Hibernate 5.2</dt>
<dd>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate 5.2 is supported in Infinispan 9.2.x only.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use the following Maven coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-hibernate-cache<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span> <span class="comment">&lt;!-- 9.2.x.Final --&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan 9.2.x.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Hibernate 5.1</dt>
<dd>
<p>Use the following Maven coordinates:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-hibernate-cache-v51<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate version 5.0 and earlier: the Infinispan cache provider is shipped by Hibernate.
Documentation and Maven coordinates are located in the
<a href="https://docs.jboss.org/hibernate/orm/5.0/userguide/html_single/Hibernate_User_Guide.html#caching-provider-infinispan">Hibernate documentation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Apart from Infinispan specific configuration, it&#8217;s worth noting that enabling second cache requires some changes to the descriptor file
(<code>persistence.xml</code> for JPA or <code>application.properties</code> for Spring).
To use second level cache, you first need to enable the second level cache so that entities and/or collections can be cached:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 36. Enable second-level cache</caption>
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 90.9091%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JPA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.jpa.properties.hibernate.cache.use_second_level_cache=true</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To select which entities/collections to cache, first annotate them with <code>javax.persistence.Cacheable</code>.
Then make sure shared cache mode is set to <code>ENABLE_SELECTIVE</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 37. Enable selective shared cached mode</caption>
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 90.9091%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JPA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;shared-cache-mode&gt;ENABLE_SELECTIVE&lt;/shared-cache-mode&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.jpa.properties.javax.persistence.sharedCache.mode=ENABLE_SELECTIVE</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is the most common way of selecting which entities/collections to cache.
However, there are alternative ways to which are explained in the
<a href="https://docs.jboss.org/hibernate/orm/5.2/userguide/html_single/Hibernate_User_Guide.html#caching-mappings">Hibernate documentation</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Optionally, queries can also be cached but for that query cache needs to be enabled:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 38. Enable query cache</caption>
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 90.9091%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JPA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;property name="hibernate.cache.use_query_cache" value="true"/&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.jpa.properties.hibernate.cache.use_query_cache=true</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As well as enabling query cache, forcing a query to be cached requires the query to be made cacheable.
For example, for JPA queries: <code>query.setHint("org.hibernate.cacheable", Boolean.TRUE)</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The best way to find out whether second level cache is working or not is to inspect the statistics.
By inspecting the statistics you can verify if the cache is being hit, if any new data is stored in cache&#8230;&#8203;etc.
Statistics are disabled by default, so it is recommended that you enable statistics:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 39. Enable statistics</caption>
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 90.9091%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JPA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;property name="hibernate.generate_statistics" value="true" /&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.jpa.properties.hibernate.generate_statistics=true</code></p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="deployment_scenarios"><a class="anchor" href="#deployment_scenarios"></a>24.5.1. Deployment Scenarios</h4>
<div class="paragraph">
<p>How to configure Infinispan to be the second level cache provider varies slightly depending on the deployment scenario:</p>
</div>
<div class="sect4">
<h5 id="single_node_standalone_hibernate_application"><a class="anchor" href="#single_node_standalone_hibernate_application"></a>Single-Node Standalone Hibernate Application</h5>
<div class="paragraph">
<p>In standalone library mode, a JPA/Hibernate application runs inside a Java SE application or inside containers that dont offer Infinispan integration.</p>
</div>
<div class="paragraph">
<p>Enabling Infinispan second level cache provider inside a JPA/Hibernate application that runs in single node is very straightforward.
First, make sure the Hibernate Infinispan cache provider is available in the classpath.
Then, modify the persistence.xml to include these properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="comment">&lt;!-- Use Infinispan second level cache provider --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!--
   Force using local configuration when only using a single node.
   Otherwise a clustered configuration is loaded.
--&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.cfg</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org/infinispan/hibernate/cache/commons/builder/infinispan-configs-local.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default when running standalone, the Infinispan second-level cache provider uses an Infinispan configuration thats designed for clustered environments.
However, Infinispan also provides a configuration designed for local, single node, environments.
To enable that configuration, set <code>hibernate.cache.infinispan.cfg</code> to <code>org/infinispan/hibernate/cache/commons/builder/infinispan-configs-local.xml</code> value.
You can find more about the configuration check the <a href="#default_local_configuration_second_level">Default Local Configuration</a> section.</p>
</div>
<div class="paragraph">
<p>A simple tutorial showing how to use Infinispan as Hibernate cache provider in a standalone application can be found
<a href="https://github.com/infinispan/infinispan-simple-tutorials/tree/master/hibernate-cache/local">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="single_node_standalone_spring_application"><a class="anchor" href="#single_node_standalone_spring_application"></a>Single-Node Standalone Spring Application</h5>
<div class="paragraph">
<p>Using Hibernate within Spring applications is a very common use case.
In this section you will learn what you need to do configure Hibernate within Spring to use Infinispan as second-level cache provider.</p>
</div>
<div class="paragraph">
<p>As in the previous case, start by making sure that Hibernate Infinispan Cache provider is available in the classpath.
Then, modify <code>application.properties</code> file to contain:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># Use Infinispan second level cache provider
spring.jpa.properties.hibernate.cache.region.factory_class=infinispan
#
# Force using local configuration when only using a single node.
# Otherwise a clustered configuration is loaded.
spring.jpa.properties.hibernate.cache.infinispan.cfg=org/infinispan/hibernate/cache/commons/builder/infinispan-configs-local.xml</pre>
</div>
</div>
<div class="paragraph">
<p>By default when running standalone, the Infinispan second-level cache provider uses an Infinispan configuration thats designed for clustered environments.
However, Infinispan also provides a configuration designed for local, single node, environments.
To enable that configuration, set <code>spring.jpa.properties.hibernate.cache.infinispan.cfg</code> to <code>org/infinispan/hibernate/cache/commons/builder/infinispan-configs-local.xml</code> value.
You can find more about the configuration check the <a href="#default_local_configuration_second_level">Default Local Configuration</a> section.</p>
</div>
<div class="paragraph">
<p>A simple tutorial showing how to use Infinispan as Hibernate cache provider in a Spring application can be found
<a href="https://github.com/infinispan/infinispan-simple-tutorials/tree/master/hibernate-cache/spring-local">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="single_node_wildfly_application"><a class="anchor" href="#single_node_wildfly_application"></a>Single-Node WildFly Application</h5>
<div class="paragraph">
<p>In WildFly, Infinispan is the default second level cache provider for JPA/Hibernate.
This means that when using JPA in WildFly, region factory is already set to <code>infinispan</code>.
Infinispan&#8217;s configuration is located in WildFly&#8217;s <code>standalone.xml</code> file.
It follows the same settings explained in <a href="#default_local_configuration_second_level">Default Local Configuration</a> section.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
When running in Wildfly, do not set <code>hibernate.cache.infinispan.cfg</code>.
The configuration of the caches comes from WildFly&#8217;s configuration file.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Several aspects of the Infinispan second level cache provider can be configured directly in <code>persistence.xml</code>.
This means that some of those tweaks do not require changing WildFly&#8217;s <code>standalone.xml</code> file.
You can find out more about these changes in the <a href="#configuration_properties">Configuration Properties</a> section.</p>
</div>
<div class="paragraph">
<p>So, to enable Hibernate to use Infinispan as second-level cache, all you need to do is enable second-level cache.
This is explained in detail in the introduction of this chapter.</p>
</div>
<div class="paragraph">
<p>A simple tutorial showing how to use Infinispan as Hibernate cache provider in a WildFly application can be found
<a href="https://github.com/infinispan/infinispan-simple-tutorials/tree/master/hibernate-cache/wildfly-local">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="multi_node_standalone_hibernate_application"><a class="anchor" href="#multi_node_standalone_hibernate_application"></a>Multi-Node Standalone Hibernate Application</h5>
<div class="paragraph">
<p>When running a JPA/Hibernate in a multi-node environment and enabling Infinispan second-level cache, it is necessary to cluster the second-level cache so that cache consistency can be guaranteed.
Clustering the Infinispan second-level cache provider is as simple as adding the following property to the <code>persistence.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="comment">&lt;!-- Use Infinispan second level cache provider --&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.region.factory_class</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The default Infinispan configuration used by the second-level cache provider is already configured to work in a cluster environment, so no need to add any extra properties.
You can find more about the configuration check the <a href="#default_cluster_configuration_second_level">Default Cluster Configuration</a> section.</p>
</div>
</div>
<div class="sect4">
<h5 id="multi_node_standalone_spring_application"><a class="anchor" href="#multi_node_standalone_spring_application"></a>Multi-Node Standalone Spring Application</h5>
<div class="paragraph">
<p>If interested in running a Spring application that uses Hibernate and Infinispan as second level cache, the cache needs to be clustered.
Clustering the Infinispan second-level cache provider is as simple as adding the following property to the <code>application.properties</code> file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># Use Infinispan second level cache provider
spring.jpa.properties.hibernate.cache.region.factory_class=infinispan</pre>
</div>
</div>
<div class="paragraph">
<p>The default Infinispan configuration used by the second-level cache provider is already configured to work in a cluster environment, so no need to add any extra properties.
You can find more about the configuration check the <a href="#default_cluster_configuration_second_level">Default Cluster Configuration</a> section.</p>
</div>
</div>
<div class="sect4">
<h5 id="multi_node_wildfly_application"><a class="anchor" href="#multi_node_wildfly_application"></a>Multi-Node Wildfly Application</h5>
<div class="paragraph">
<p>As mentioned in the single node Wildfly case, Infinispan is the default second level cache provider for JPA/Hibernate when running inside Wildfly.
This means that when using JPA in WildFly, region factory is already set to <code>infinispan</code>.</p>
</div>
<div class="paragraph">
<p>When running Wildfly multi-node clusters, it is recommended that you start off by using <code>clustered.xml</code> configuration file.
Within this file you can find Hibernate Infinispan caches configured with the correct settings to work in a clustered environment.
You can find more about the configuration check the <a href="#default_cluster_configuration_second_level">Default Cluster Configuration</a> section.</p>
</div>
<div class="paragraph">
<p>Several aspects of the Infinispan second level cache provider can be configured directly in <code>persistence.xml</code>.
This means that some of those tweaks do not require changing WildFly&#8217;s <code>clustered.xml</code> file.
You can find out more about these changes in the <a href="#configuration_properties">Configuration Properties</a> section.</p>
</div>
<div class="paragraph">
<p>So, to enable Hibernate to use Infinispan as second-level cache, all you need to do is enable second-level cache.
Enabling second-level cache is explained in detail in the introduction of this chapter.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration_reference"><a class="anchor" href="#configuration_reference"></a>24.5.2. Configuration Reference</h4>
<div class="paragraph">
<p>This section is dedicated at explaining configuration in detail as well as some extra configuration options.</p>
</div>
<div class="sect4">
<h5 id="default_local_configuration_second_level"><a class="anchor" href="#default_local_configuration_second_level"></a>Default Local Configuration</h5>
<div class="paragraph">
<p>Infinispan second-level cache provider comes with a configuration designed for local, single node, environments.
These are the characteristics of such configuration:</p>
</div>
<div class="paragraph">
<p>Entities, collections, queries and timestamps are stored in non-transactional local caches.</p>
</div>
<div class="paragraph">
<p>Entities and collections query caches are configured with the following eviction settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Eviction wake up interval is 5 seconds.</p>
</li>
<li>
<p>Max number of entries are 10,000.</p>
</li>
<li>
<p>Max idle time before expiration is 100 seconds.</p>
</li>
<li>
<p>Default eviction algorithm is LRU, least recently used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can change these settings on a per entity or collection basis or per individual entity or collection type.
More information in the <a href="#configuration_properties">Configuration Properties</a> section below.</p>
</div>
<div class="paragraph">
<p><em>No eviction/expiration is configured for timestamp caches</em>, nor it&#8217;s allowed.</p>
</div>
</div>
<div class="sect4">
<h5 id="default_cluster_configuration_second_level"><a class="anchor" href="#default_cluster_configuration_second_level"></a>Default Cluster Configuration</h5>
<div class="paragraph">
<p>Infinispan second-level cache provider default configuration is designed for multi-node clustered environments.
The aim of this section is to explain the default settings for each of the different global data type caches (entity, collection, query and timestamps), why these were chosen and what are the available alternatives.
These are the characteristics of such configuration:</p>
</div>
<div class="paragraph">
<div class="title">Entities and Collections</div>
<p>By default all <em>entities and collections are configured to use a synchronous invalidation</em> as clustering mode.
Whenever a new <em>entity or collection is read from database</em> and needs to be cached, <em>it&#8217;s only cached locally</em> in order to reduce intra-cluster traffic.
This option can be changed so that entities/collections are cached cluster wide, by switching the entity/collection cache to be replicated or distributed.
How to change this option is explained in the <a href="#configuration_properties">Configuration Properties</a> section.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
When data read from the database is put in the cache, with replicated or distributed caches,
the data is propagated to other nodes using asynchronous communication.
In the presence of concurrent database loads, one operation will succeed while others might fail (silently).
This is fine because they&#8217;d all be trying to put the same data loaded from the database.
This has the side effect that under these circumstances, the cache might not be up to date right after making the JPA call that leads to the database load.
However, the cache will eventually contain the data loaded, even if it happens after a short delay.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All <em>entities and collections are configured to use a synchronous invalidation</em> as clustering mode.
This means that when an entity is updated, the updated cache will send a message to the other members of the cluster telling them that the entity has been modified.
Upon receipt of this message, the other nodes will remove this data from their local cache, if it was stored there.
This option can be changed so that both local and remote nodes contain the updates by configuring entities or collections to use a replicated or distributed cache.
With replicated caches all nodes would contain the update, whereas with distributed caches only a subset of the nodes.
How to change this option is explained in the <a href="#configuration_properties">Configuration Properties</a> section.</p>
</div>
<div class="paragraph">
<p>All <em>entities and collections have initial state transfer disabled</em> since there&#8217;s no need for it.</p>
</div>
<div class="paragraph">
<p>Entities and collections are configured with the following eviction settings.
You can change these settings on a per entity or collection basis or per individual entity or collection type.
More information in the <a href="#configuration_properties">Configuration Properties</a> section below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Eviction wake up interval is 5 seconds.</p>
</li>
<li>
<p>Max number of entries are 10,000.</p>
</li>
<li>
<p>Max idle time before expiration is 100 seconds.</p>
</li>
<li>
<p>Default eviction algorithm is LRU, least recently used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Queries</div>
<p>Assuming that query caching has been enabled for the persistence unit (see chapter introduction), the query cache is configured so that <em>queries are only cached locally</em>.
Alternatively, you can configure query caching to use replication by selecting the <code>replicated-query</code> as query cache name.
However, replication for query cache only makes sense if, and only if, all of this conditions are true:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Performing the query is quite expensive.</p>
</li>
<li>
<p>The same query is very likely to be repeatedly executed on different cluster nodes.</p>
</li>
<li>
<p>The query is unlikely to be invalidated out of the cache</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Hibernate must aggressively invalidate query results from the cache any time any instance of one of the entity types targeted by the query.
All such query results are invalidated, even if the change made to the specific entity instance would not have affected the query result.
For example: the cached result of <code>SELECT id FROM cars where color = 'red'</code> is thrown away when you call <code>INSERT INTO cars VALUES &#8230;&#8203;, color = 'blue'</code>.
Also, the result of an update within a transaction is not visible to the result obtained from the query cache.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>query cache</em> uses the <em>same eviction/expiration settings as for entities/collections</em>.</p>
</div>
<div class="paragraph">
<p><em>query cache has initial state transfer disabled</em>. It is not recommended that this is enabled.</p>
</div>
<div class="paragraph">
<p>Up to Hibernate 5.2 both transactional and non-transactional query caches have been supported, though non-transactional variant is recommended. Hibernate 5.3 drops support for transactional caches, only non-transactional variant is supported. If the cache is configured with transactions this setting is ignored and warning is logged.</p>
</div>
<div class="paragraph">
<div class="title">Timestamps</div>
<p>The <em>timestamps cache is configured with asynchronous replication</em> as clustering mode.
Local or invalidated cluster modes are not allowed, since all cluster nodes must store all timestamps.
As a result, <em>no eviction/expiration is allowed for timestamp caches either</em>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Asynchronous replication was selected as default for timestamps cache for performance reasons.
A side effect of this choice is that when an entity/collection is updated, for a very brief period of time stale queries might be returned.
It&#8217;s important to note that due to how Infinispan deals with asynchronous replication, stale queries might be found even query is done right after an entity/collection update on same node.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Hibernate must aggressively invalidate query results from the cache any time any instance of one of the entity types is modified.
All cached query results referencing given entity type are invalidated, even if the change made to the specific entity instance would not have affected the query result.
The timestamps cache plays here an important role - it contains last modification timestamp for each entity type.
After a cached query results is loaded, its timestamp is compared to all timestamps of the entity types that are referenced in the query.
If any of these is higher, the cached query result is discarded and the query is executed against DB.
This requires synchronization of the wall clock across the cluster to work as expected.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="configuration_properties"><a class="anchor" href="#configuration_properties"></a>Configuration Properties</h5>
<div class="paragraph">
<p>As explained above, Infinispan second-level cache provider comes with default configuration in <code>infinispan-config.xml</code> that is suited for clustered use.
If there&#8217;s only single JVM accessing the DB, you can use more performant <code>infinispan-config-local.xml</code> by setting the <code>hibernate.cache.infinispan.cfg</code> property.
If you require further tuning of the cache, you can provide your own configuration.
Caches that are not specified in the provided configuration will default to <code>infinispan-config.xml</code> (if the provided configuration uses clustering) or <code>infinispan-config-local.xml</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It is not possible to specify the configuration this way in WildFly.
Cache configuration changes in Wildfly should be done either modifying the cache configurations inside the application server configuration, or creating new caches with the desired tweaks and plugging them accordingly.
See examples below on how entity/collection specific configurations can be applied.
</td>
</tr>
</table>
</div>
<div id="caching_provider_infinispan_config_example" class="exampleblock">
<div class="title">Example 1. Use custom Infinispan configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.cfg</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-infinispan-configuration.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the cache is configured as transactional, Infinispan cache provider automatically sets transaction manager so that the TM used by Infinispan is the same as TM used by Hibernate.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Cache configuration can differ for each type of data stored in the cache.
In order to override the cache configuration template, use property <code>hibernate.cache.infinispan.<em>data-type</em>.cfg</code> where <code><em>data-type</em></code> can be one of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>entity</code>:
Entities indexed by <code>@Id</code> or <code>@EmbeddedId</code> attribute.</p>
</li>
<li>
<p><code>immutable-entity</code>:
Entities tagged with <code>@Immutable</code> annotation or set as <code>mutable=false</code> in mapping file.</p>
</li>
<li>
<p><code>naturalid</code>:
Entities indexed by their <code>@NaturalId</code> attribute.</p>
</li>
<li>
<p><code>collection</code>:
All collections.</p>
</li>
<li>
<p><code>timestamps</code>:
Mapping <em>entity type</em> &#8594; <em>last modification timestamp</em>.
Used for query caching.</p>
</li>
<li>
<p><code>query</code>:
Mapping <em>query</em> &#8594; <em>query result</em>.</p>
</li>
<li>
<p><code>pending-puts</code>:
Auxiliary caches for regions using invalidation mode caches.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For specifying cache template for specific region, use region name instead of the <code><em>data-type</em></code>:</p>
</div>
<div id="caching_provider_infinispan_config_cache_example" class="exampleblock">
<div class="title">Example 2. Use custom cache template</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entities.cfg</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-entities</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.query.cfg</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-query-cache</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.example.MyEntity.cfg</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-entities</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.example.MyEntity.someCollection.cfg</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-entities-some-collection</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<div class="title">Use custom cache template in Wildfly</div>
<p>When applying entity/collection level changes inside JPA applications deployed in Wildfly, it is necessary to specify deployment name and persistence unit name (separated by <code>#</code> character):</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan._war_or_ear_name_#_unit_name_.com.example.MyEntity.cfg</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-entities</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;property</span>
    <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan._war_or_ear_name_#_unit_name_.com.example.MyEntity.someCollection.cfg</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-entities-some-collection</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Cache configurations are used only as a template for the cache created for given region.
Usually each entity hierarchy or collection has its own region
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Except for eviction/expiration settings, it is highly recommended not to deviate from the template configuration settings.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Some options in the cache configuration can also be overridden directly through properties.
These are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hibernate.cache.infinispan.<em>something</em>.eviction.strategy</code>:
Available options are <code>NONE</code>, <code>LRU</code> and <code>LIRS</code>.</p>
</li>
<li>
<p><code>hibernate.cache.infinispan.<em>something</em>.eviction.max_entries</code>:
Maximum number of entries in the cache.</p>
</li>
<li>
<p><code>hibernate.cache.infinispan.<em>something</em>.expiration.lifespan</code>:
Lifespan of entry from insert into cache (in milliseconds).</p>
</li>
<li>
<p><code>hibernate.cache.infinispan.<em>something</em>.expiration.max_idle</code>:
Lifespan of entry from last read/modification (in milliseconds).</p>
</li>
<li>
<p><code>hibernate.cache.infinispan.<em>something</em>.expiration.wake_up_interval</code>:
Period of thread checking expired entries.</p>
</li>
<li>
<p><code>hibernate.cache.infinispan.statistics</code>:
Globally enables/disable Infinispan statistics collection, and their exposure via JMX.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.strategy</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">LRU</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.wake_up_interval</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.eviction.max_entries</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.expiration.lifespan</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.entity.expiration.max_idle</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>With the above configuration, you&#8217;re overriding whatever eviction/expiration settings were defined for the default entity cache name in the Infinispan cache configuration used.
This happens regardless of whether it&#8217;s the default one or user defined.
More specifically, we&#8217;re defining the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All entities to use LRU eviction strategy</p>
</li>
<li>
<p>The eviction thread to wake up every 2 seconds (2000 milliseconds)</p>
</li>
<li>
<p>The maximum number of entities for each entity type to be 5000 entries</p>
</li>
<li>
<p>The lifespan of each entity instance to be 1 minute (60000 milliseconds).</p>
</li>
<li>
<p>The maximum idle time for each entity instance to be 30 seconds (30000 milliseconds).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also override eviction/expiration settings on a per entity/collection type basis.
This allows overrides that only affects a particular entity (i.e. <code>com.acme.Person</code>) or collection type (i.e. <code>com.acme.Person.addresses</code>).
Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan.com.acme.Person.eviction.strategy</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">LIRS</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Inside of Wildfly, same as with the entity/collection configuration override, eviction/expiration settings would also require deployment name and persistence unit information
(a working example can be found
<a href="https://github.com/infinispan/infinispan-simple-tutorials/tree/master/hibernate-cache/wildfly-local">here</a>
):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan._war_or_ear_name_#_unit_name_.com.acme.Person.eviction.strategy</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">LIRS</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.cache.infinispan._war_or_ear_name_#_unit_name_.com.acme.Person.expiration.lifespan</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span> <span class="attribute-name">value</span>= <span class="string"><span class="delimiter">&quot;</span><span class="content">65000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cache_strategies"><a class="anchor" href="#cache_strategies"></a>24.5.3. Cache Strategies</h4>
<div class="paragraph">
<p>Infinispan cache provider supports all Hibernate cache strategies:
<code>transactional</code>, <code>read-write</code>, <code>nonstrict-read-write</code> and <code>read-only</code>.</p>
</div>
<div class="paragraph">
<p>Integrations with Hibernate 4.x required <em>transactional invalidation caches</em> and in integrations with Hibernate &le; 5.2 <em>transactional invalidation caches</em> are supported (in JTA environment). However for all 5.x versions <em>non-transactional caches</em> are preferred. With Hibernate 5.3 the support for transactional caches has been dropped completely, and both <code>read-write</code> and <code>transactional</code> use the same implementation. Infinispan provides the same consistency guarantees for both <code>transactional</code> and <code>read-write</code> strategies, use of transactions is considered an implementation detail.</p>
</div>
<div class="paragraph">
<p>In integrations with Hibernate 5.2 or lower the actual setting of cache concurrency mode (<code>read-write</code> vs. <code>transactional</code>) is not honored on invalidation caches, the appropriate strategy is selected based on the cache configuration (<em>non-transactional</em> vs. <em>transactional</em>).</p>
</div>
<div class="paragraph">
<p>Support for <em>replicated/distributed</em> caches for <code>read-write</code> and <code>read-only</code> strategies has been added during 5.x development and this requires exclusively <em>non-transactional configuration</em>.
Also eviction should not be used in this configuration as it can lead to consistency issues. Expiration (with reasonably long max-idle times) can be used.</p>
</div>
<div class="paragraph">
<p><code>Nonstrict-read-write</code> strategy is supported on <em>non-transactional distributed/replicated</em> caches, but the eviction should be turned off as well. In addition to that, the entities must use versioning. This means that this strategy cannot be used for caching natural IDs (which are never versioned). This mode mildly relaxes the consistency - between DB commit and end of transaction commit a stale read may occur in another transaction.
However this strategy uses less RPCs and can be more performant than the other ones.</p>
</div>
<div class="paragraph">
<p><code>Read-only</code> mode is supported in all configurations mentioned above but use of this mode currently does not bring any performance gains.</p>
</div>
<div class="paragraph">
<p>The available combinations are summarized in table below:</p>
</div>
<table id="caching_provider_infinispan_compatibility_table" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 40. Cache concurrency strategy/cache mode compatibility table</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Concurrency strategy</th>
<th class="tableblock halign-left valign-top">Cache transactions</th>
<th class="tableblock halign-left valign-top">Cache mode</th>
<th class="tableblock halign-left valign-top">Eviction</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&le; 5.2 transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">invalidation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&ge; 5.3 non-transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">invalidation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">read-write</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">non-transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">invalidation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">read-write</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">non-transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">distributed/replicated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nonstrict-read-write</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">non-transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">distributed/replicated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Changing caches to behave different to the default behaviour explained in previous section is explained in the <a href="#configuration_properties">Configuration Properties</a> section.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Use of transactional caches is possible only in JTA environment. Hibernate supports JDBC-only transactions but Infinispan transactional caches do not integrate with these. Therefore, in non-JTA environment the only option is to use <code>read-write</code>, <code>nonstrict-read-write</code> or <code>read-only</code> on non-transactional cache. Configuring the cache as transactional in non-JTA can lead to undefined behaviour.
</td>
</tr>
</table>
</div>
<div id="caching_provider_infinispan_stale_read_example" class="exampleblock">
<div class="title">Example 3. Stale read with <code>nonstrict-read-write</code> strategy</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>A=0 (non-cached), B=0 (cached in 2LC)
TX1: write A = 1, write B = 1
TX1: start commit
TX1: commit A, B in DB
TX2: read A = 1 (from DB), read B = 0 (from 2LC) // breaks transactional atomicity
TX1: update A, B in 2LC
TX1: end commit
Tx3: read A = 1, B = 1 // reads after TX1 commit completes are consistent again</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using_minimal_puts"><a class="anchor" href="#using_minimal_puts"></a>24.5.4. Using minimal puts</h4>
<div class="paragraph">
<p>Hibernate offers a configuration option <code>hibernate.cache.use_minimal_puts</code> which is off by default in Infinispan implementation. This option checks if the cache contains given key before updating the value from database (put-from-load) and omits the update if the cached value is already present.
When using invalidation caches it makes sense to keep this off as the put-from-load is local node-only and silently fails if the entry is locked. With replicated/distributed caches the update is applied to remote nodes, even if the local node already contains the entry, and this has higher performance impact, so it might make sense to turn this option on and avoid updating the cache.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integrations_hibernate_ogm"><a class="anchor" href="#integrations_hibernate_ogm"></a>24.6. JPA / Hibernate OGM</h3>
<div class="paragraph">
<p>Hibernate can perform CRUD operations directly on an Infinispan cluster.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM is an extension of the popular Hibernate ORM project which makes
the Hibernate API suited to interact with NoSQL databases such as Infinispan.</p>
</div>
<div class="paragraph">
<p>When some of your object graphs need high scalability and elasticity, you can
use Hibernate OGM to store these specific entities into Infinispan instead of
your traditional RDBMS.
The drawback is that Infinispan - not being a relational database - can not run
complex relational queries.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM allows you to get started with Infinispan in minutes, as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the JPA API and its annotations are simple and well known</p>
</li>
<li>
<p>you don&#8217;t need to learn Protobuf or Externalizer encoding formats</p>
</li>
<li>
<p>no need to learn the Infinispan API</p>
</li>
<li>
<p>the Hot Rod client is also setup and managed for you</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It will still be beneficial to eventually learn how to configure Infinispan for
top performance and learn about all capabilities it has, but you can get a proof
of concept application done quickly with the example configuration.</p>
</div>
<div class="paragraph">
<p>Hibernate OGM also gives you several more benefits; being designed and
implemented in collaboration with the Infinispan team it incorporates experience
and deep understanding of how to best perform some common operations.</p>
</div>
<div class="paragraph">
<p>For example a common mistake for people new to Infinispan is to "serialize"
Java POJOs for long term storage of important information; the Infinispan API
allows this as it&#8217;s useful for short lived caching of metadata, but you wouldn&#8217;t
be able to de-serialize your data when you make any changes to your model.
You wouldn&#8217;t want to wipe your database after any and each update of your
application, would you?</p>
</div>
<div class="paragraph">
<p>In the best of cases such an encoding wouldn&#8217;t be very efficient; in some worse
scenarios your team might not have thought such details though and you get stuck
into a complex migration on your live data.</p>
</div>
<div class="paragraph">
<p>Just like when using Hibernate ORM with a relational database, data stored over
Hibernate OGM is easy to recover even using other tools as it&#8217;s encoded using a
well defined Protobuf schema.</p>
</div>
<div class="paragraph">
<p>Being able to "map" new domain objects by simply adding a couple of annotations
is going to make you more productive than re-inventing such error-prone encoding
techniques, or figuring out how to best store object graphs and relations
into Infinispan.</p>
</div>
<div class="paragraph">
<p>Finally, using Hibernate OGM allows you to use all existing framework
integration points, such as injecting an <code>EntityManager</code> as usual: it&#8217;s not
yet another tool but it&#8217;s the real Hibernate, so inheriting all well known
integrations: this will work in Java EE, Spring, Grails, Jhipster, &#8230;&#8203; and all
other technologies integrating with Hibernate.</p>
</div>
<div class="paragraph">
<p>It&#8217;s booted like any Hibernate instance: compared to using it with an RDBMS
you just have to change some configuration properties, and of course omit the
<code>DataSource</code> as Infinispan won&#8217;t use one.</p>
</div>
<div class="paragraph">
<p>For more details, check the <a href="http://hibernate.org/ogm/">Hibernate OGM project</a>
and the <a href="https://docs.jboss.org/hibernate/stable/ogm/reference/en-US/html_single/#ogm-infinispan">Hibernate OGM / Infinispan</a>
section of the documentation.</p>
</div>
</div>
<div class="sect2">
<h3 id="spring_integration"><a class="anchor" href="#spring_integration"></a>24.7. Using Infinispan with Spring</h3>
<div class="paragraph">
<p>Infinispan integrates with the Spring Framework to make it easy to add caching capabilities to your applications.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan supports Spring 4 and Spring 5 with different sets of dependencies.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="spring_boot_starter"><a class="anchor" href="#spring_boot_starter"></a>24.7.1. Spring Boot Starter</h4>
<div class="paragraph">
<p>Check out the Infinispan <a href="https://github.com/infinispan/infinispan-spring-boot">Spring Boot Starter on GitHub</a> to quickly get up and running.</p>
</div>
</div>
<div class="sect3">
<h4 id="spring_cache_provider"><a class="anchor" href="#spring_cache_provider"></a>24.7.2. Setting Up Infinispan as a Spring Cache Provider</h4>
<div class="paragraph">
<p>Infinispan implements the Spring SPI to offer high-performance, in-memory caching capabilities.</p>
</div>
<div class="sect4">
<h5 id="spring_add_support"><a class="anchor" href="#spring_add_support"></a>Adding Spring Cache Support</h5>
<div class="paragraph">
<p>The <a href="http://spring.io/">Spring Framework</a> offers a <a href="https://docs.spring.io/spring/docs/5.1.3.RELEASE/spring-framework-reference/integration.html#cache">cache abstraction</a> with two simple annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Cacheable</code> adds entries to the cache.</p>
</li>
<li>
<p><code>@CacheEvict</code> removes entries from the cache.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To add caching support to your application, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Enable cache annotations in your application context either declaratively or programmatically.</p>
<div class="ulist">
<ul>
<li>
<p><strong>Declaratively:</strong> Add <code>&lt;cache:annotation-driven/&gt;</code> to your application context.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/cache</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/cache http://www.springframework.org/schema/cache/spring-cache.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

        <span class="tag">&lt;cache:annotation-driven</span> <span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Programmatically:</strong> Enable cache support as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@EnableCaching</span> <span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Add Infinispan and the Spring integration module to your <code>pom.xml</code>.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Spring 4</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Embedded mode: <code>infinispan-spring4-embedded</code></p>
</li>
<li>
<p>Remote client-server mode: <code>infinispan-spring4-remote</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Spring 5</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Embedded mode: <code>infinispan-spring5-embedded</code></p>
</li>
<li>
<p>Remote client-server mode: <code>infinispan-spring5-remote</code></p>
<div class="paragraph">
<p>The following is an example with Spring 5 in embedded mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>infinispan-spring5-embedded<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="comment">&lt;!-- Tip: Use the Spring Boot starter
    instead of the spring-boot artifact. --&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>spring-context<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>${version.spring}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Replace:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</li>
<li>
<p><code>${version.spring}</code> with the appropriate version of Spring.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="spring_configure_cache_provider"><a class="anchor" href="#spring_configure_cache_provider"></a>Configuring Infinispan as the Spring Cache Provider</h5>
<div class="paragraph">
<p>The Spring cache provider SPI has two interfaces through which it interacts with Infinispan: <code>org.springframework.cache.CacheManager</code> and <code>org.springframework.cache.Cache</code>. The <code>CacheManager</code> interface acts as a factory for named <code>Cache</code> instances.</p>
</div>
<div class="paragraph">
<p>At runtime Spring looks for a <code>CacheManager</code> implementation that has a bean named <code>cacheManager</code> in the application context.</p>
</div>
<div class="paragraph">
<p>You can configure your application context either declaratively or programmatically.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Declaratively:</strong></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="comment">&lt;!-- Infinispan cache manager --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheManager</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.spring.embedded.provider.SpringEmbeddedCacheManagerFactoryBean</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">p:configurationFileLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:/org/infinispan/spring/embedded/provider/sample/books-infinispan-config.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Programmatically:</strong></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml">@EnableCaching
@Configuration
public class Config {

   @Bean
   public CacheManager cacheManager() {
      return new SpringEmbeddedCacheManager(infinispanCacheManager());
   }

   private EmbeddedCacheManager infinispanCacheManager() {
      return new DefaultCacheManager();
   }

}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="spring_add_caching"><a class="anchor" href="#spring_add_caching"></a>24.7.3. Adding Caching to Your Application</h4>
<div class="paragraph">
<p>Add the <code>@Cacheable</code> and <code>@CacheEvict</code> annotations to your application code.</p>
</div>
<div class="sect4">
<h5 id="spring_add_entries"><a class="anchor" href="#spring_add_entries"></a>Adding Cache Entries</h5>
<div class="paragraph">
<p>The <code>@Cacheable</code> annotation adds returned values to a defined cache.</p>
</div>
<div class="paragraph">
<p>For instance, you have a data access object (DAO) for books. You want book instances to be cached after they have been loaded from the underlying database using <code>BookDao#findBook(Integer bookId)</code>.</p>
</div>
<div class="paragraph">
<p>Annotate the <code>findBook(Integer bookId)</code> method with <code>@Cacheable</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Transactional</span>
<span class="annotation">@Cacheable</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>, key = <span class="string"><span class="delimiter">&quot;</span><span class="content">#bookId</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="predefined-type">Book</span> findBook(<span class="predefined-type">Integer</span> bookId) {...}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any <code>Book</code> instances returned from <code>findBook(Integer bookId)</code> are stored in a cache named <code>books</code>, using <code>bookId</code> as the key.</p>
</div>
<div class="paragraph">
<p>Note that "#bookId" is an expression in the <a href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/expressions.html">Spring Expression Language</a> that evaluates the <code>bookId</code> argument.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If your application needs to reference entries in the cache directly, you should include the <code>key</code> attribute. Without this attribute, Spring generates a hash from the supplied method arguments to use as the cache key.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="spring_remove_entries"><a class="anchor" href="#spring_remove_entries"></a>Deleting Cache Entries</h5>
<div class="paragraph">
<p>The <code>@CacheEvict</code> annotation deletes entries from a defined cache.</p>
</div>
<div class="paragraph">
<p>Annotate the <code>deleteBook(Integer bookId)</code> method with <code>@CacheEvict</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="comment">// Evict all entries in the &quot;books&quot; cache</span>
<span class="annotation">@Transactional</span>
<span class="annotation">@CacheEvict</span> (value=<span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>, key = <span class="string"><span class="delimiter">&quot;</span><span class="content">#bookId</span><span class="delimiter">&quot;</span></span>, allEntries = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">void</span> deleteBookAllEntries() {...}

<span class="comment">// Evict entries in the &quot;books&quot; cache that match #bookId</span>
<span class="annotation">@Transactional</span>
<span class="annotation">@CacheEvict</span> (value=<span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>, key = <span class="string"><span class="delimiter">&quot;</span><span class="content">#bookId</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">void</span> deleteBook(<span class="predefined-type">Integer</span> bookId) {...]}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="spring_configure_timeouts"><a class="anchor" href="#spring_configure_timeouts"></a>24.7.4. Configuring Timeouts for Cache Operations</h4>
<div class="paragraph">
<p>The Infinispan Spring cache provider defaults to blocking behaviour when performing read and write operations. By default operations are synchronous and do not time out. However, you might want to set a maximum time to wait for operations before timing out in some situations. For example, timeouts are useful if you need to ensure that an operation completes within a certain time and you can ignore the cached value.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>infinispan.spring.operation.read.timeout</code></dt>
<dd>
<p>Specifies the time, in milliseconds, to wait for read operations to complete. The default is <code>0</code> which means unlimited wait time.</p>
</dd>
<dt class="hdlist1"><code>infinispan.spring.operation.write.timeout</code></dt>
<dd>
<p>Specifies the time, in milliseconds, to wait for write operations to complete. The default is <code>0</code> which means unlimited wait time.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To configure timeouts for cache operations, set the properties in the context XML for your application on either <code>SpringEmbeddedCacheManagerFactoryBean</code> or <code>SpringRemoteCacheManagerFactoryBean</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In remote client-server mode, you can also add these properties to <code>hotrod-client.properties</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows the timeout properties in the context XML for <code>SpringRemoteCacheManagerFactoryBean</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">springRemoteCacheManagerConfiguredUsingConfigurationProperties</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.spring.remote.provider.SpringRemoteCacheManagerFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">configurationProperties</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;props&gt;</span>
           <span class="tag">&lt;prop</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.spring.operation.read.timeout</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>500<span class="tag">&lt;/prop&gt;</span>
           <span class="tag">&lt;prop</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.spring.operation.write.timeout</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>700<span class="tag">&lt;/prop&gt;</span>
        <span class="tag">&lt;/props&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="spring_externalize_sessions"><a class="anchor" href="#spring_externalize_sessions"></a>24.7.5. Externalizing Sessions Using Spring Session</h4>
<div class="paragraph">
<p><a href="http://docs.spring.io/spring-session/docs/current/reference/html5">Spring Session</a> lets you externalize user session information into Infinispan.</p>
</div>
<div class="paragraph">
<p>To configure Spring Session integration in your application, do the following:</p>
</div>
<div class="paragraph">
<p>Add dependencies to your <code>pom.xml</code> as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Spring 4</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Embedded mode: <code>infinispan-spring4-embedded</code></p>
</li>
<li>
<p>Remote client-server mode: <code>infinispan-spring4-remote</code></p>
</li>
<li>
<p>Spring Framework: <code>spring-session</code></p>
<div class="paragraph">
<p>The following is an example with Spring 4 in embedded mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>infinispan-core<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>infinispan-spring4-embedded<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>spring-context<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>${version.spring}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
       <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
       <span class="tag">&lt;artifactId&gt;</span>spring-session<span class="tag">&lt;/artifactId&gt;</span>
       <span class="tag">&lt;version&gt;</span>${version.spring}<span class="tag">&lt;/version&gt;</span>
   <span class="tag">&lt;/dependency&gt;</span>
   <span class="tag">&lt;dependency&gt;</span>
       <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
       <span class="tag">&lt;artifactId&gt;</span>spring-web<span class="tag">&lt;/artifactId&gt;</span>
       <span class="tag">&lt;version&gt;</span>${version.spring}<span class="tag">&lt;/version&gt;</span>
   <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Replace:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</li>
<li>
<p><code>${version.spring}</code> with the appropriate version of Spring.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Spring 5</dt>
</dl>
</div>
</li>
<li>
<p>Embedded mode: <code>infinispan-spring5-embedded</code></p>
</li>
<li>
<p>Remote client-server mode: <code>infinispan-spring5-remote</code></p>
</li>
<li>
<p>Spring Framework: <code>spring-session-core</code></p>
<div class="paragraph">
<p>The following is an example with Spring 5 in remote client-server mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>infinispan-core<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>infinispan-spring5-remote<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>spring-context<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>${version.spring}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
       <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
       <span class="tag">&lt;artifactId&gt;</span>spring-session-core<span class="tag">&lt;/artifactId&gt;</span>
       <span class="tag">&lt;version&gt;</span>${version.spring}<span class="tag">&lt;/version&gt;</span>
   <span class="tag">&lt;/dependency&gt;</span>
   <span class="tag">&lt;dependency&gt;</span>
       <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
       <span class="tag">&lt;artifactId&gt;</span>spring-web<span class="tag">&lt;/artifactId&gt;</span>
       <span class="tag">&lt;version&gt;</span>${version.spring}<span class="tag">&lt;/version&gt;</span>
   <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Replace:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</li>
<li>
<p><code>${version.spring}</code> with the appropriate version of Spring.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After you add dependencies, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Specify the appropriate FactoryBean to expose a <code>CacheManager</code> instance.</p>
<div class="ulist">
<ul>
<li>
<p>Embedded mode: <code>SpringEmbeddedCacheManagerFactoryBean</code></p>
</li>
<li>
<p>Remote client-server mode: <code>SpringRemoteCacheManagerFactoryBean</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Enable Spring Session with the appropriate annotation.</p>
<div class="ulist">
<ul>
<li>
<p>Embedded mode: <code>@EnableInfinispanEmbeddedHttpSession</code></p>
</li>
<li>
<p>Remote client-server mode: <code>@EnableInfinispanRemoteHttpSession</code></p>
<div class="paragraph">
<p>These annotations have optional parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>maxInactiveIntervalInSeconds</code> sets session expiration time in seconds. The default is <code>1800</code>.</p>
</li>
<li>
<p><code>cacheName</code> specifies the name of the cache that stores sessions. The default is <code>sessions</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following example shows a complete, annotation-based configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@EnableInfinispanEmbeddedHttpSession</span>
<span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

   <span class="annotation">@Bean</span>
   <span class="directive">public</span> SpringEmbeddedCacheManagerFactoryBean springCacheManager() {
      <span class="keyword">return</span> <span class="keyword">new</span> SpringEmbeddedCacheManagerFactoryBean();
   }

   <span class="comment">//An optional configuration bean responsible for replacing the default</span>
   <span class="comment">//cookie that obtains configuration.</span>
   <span class="comment">//For more information refer to the Spring Session documentation.</span>
   <span class="annotation">@Bean</span>
   <span class="directive">public</span> HttpSessionStrategy httpSessionStrategy() {
      <span class="keyword">return</span> <span class="keyword">new</span> HeaderHttpSessionStrategy();
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="infinispan_modules_for_wildfly_eap"><a class="anchor" href="#infinispan_modules_for_wildfly_eap"></a>24.8. Infinispan modules for WildFly / EAP</h3>
<div class="paragraph">
<p>As the Infinispan modules shipped with <a href="http://wildfly.org/">WildFly</a> / <a href="https://www.redhat.com/en/technologies/jboss-middleware/application-platform">EAP</a> are tailored to its internal usage, it is recommend to install separate modules
if you want to use Infinispan in your application that is deployed to WildFly / EAP. By installing these modules, it is possible to deploy user applications without packaging the Infinispan JARs within the deployments (WARs, EARs, etc), thus minimizing their size.
Also, there will be no conflict with WildFly / EAP&#8217;s internal modules since the slot will be different.</p>
</div>
<div class="sect3">
<h4 id="modules_installation_section"><a class="anchor" href="#modules_installation_section"></a>24.8.1. Installation</h4>
<div class="paragraph">
<p>The modules for WildFly / EAP are available in the <a href="http://infinispan.org/download/">downloads</a> section of our site.
After extracting the zip, copy the contents of the <code>modules</code> directory to the <code>WILDFLY_HOME/modules</code> directory, so that
for example the Infinispan core module would be under <code>WILDFLY_HOME/modules/system/add-ons/ispn/org/infinispan/core</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="application_dependencies"><a class="anchor" href="#application_dependencies"></a>24.8.2. Application Dependencies</h4>
<div class="paragraph">
<p>If you are using Maven to build your application, mark the Infinispan dependencies as <em>provided</em> and configure your artifact archiver to generate the appropriate MANIFEST.MF file:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>infinispan-core<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;scope&gt;</span>provided<span class="tag">&lt;/scope&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>
  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>infinispan-cachestore-jdbc<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;scope&gt;</span>provided<span class="tag">&lt;/scope&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;build&gt;</span>
  <span class="tag">&lt;plugins&gt;</span>
     <span class="tag">&lt;plugin&gt;</span>
       <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
       <span class="tag">&lt;artifactId&gt;</span>maven-war-plugin<span class="tag">&lt;/artifactId&gt;</span>
       <span class="tag">&lt;configuration&gt;</span>
         <span class="tag">&lt;archive&gt;</span>
           <span class="tag">&lt;manifestEntries&gt;</span>
             <span class="tag">&lt;Dependencies&gt;</span>org.infinispan.core:${version.slot} services, org.infinispan.cachestore.jdbc:${version.slot} services<span class="tag">&lt;/Dependencies&gt;</span>
           <span class="tag">&lt;/manifestEntries&gt;</span>
         <span class="tag">&lt;/archive&gt;</span>
      <span class="tag">&lt;/configuration&gt;</span>
    <span class="tag">&lt;/plugin&gt;</span>
  <span class="tag">&lt;/plugins&gt;</span>
<span class="tag">&lt;/build&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>${version.infinispan}</code> with the appropriate version of Infinispan.</p>
</li>
<li>
<p><code>${version.slot}</code> with the slot version, ispn-9.4.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next section illustrates the manifest entries for different types of Infinispan&#8217;s dependencies.</p>
</div>
<div class="sect4">
<h5 id="infinispan_core"><a class="anchor" href="#infinispan_core"></a>Infinispan core</h5>
<div class="paragraph">
<p>In order expose only Infinispan core dependencies to your application, add the follow to the manifest:</p>
</div>
<div class="listingblock">
<div class="title">MANIFEST.MF</div>
<div class="content">
<pre class="CodeRay highlight"><code>Manifest-Version: 1.0
Dependencies: org.infinispan:ispn-9.4 services</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="remote"><a class="anchor" href="#remote"></a>Remote</h5>
<div class="paragraph">
<p>If you need to connect to remote Infinispan servers via Hot Rod, including execution of remote queries, use the module <code>org.infinispan.remote</code> that exposes the needed dependencies conveniently:</p>
</div>
<div class="listingblock">
<div class="title">MANIFEST.MF</div>
<div class="content">
<pre class="CodeRay highlight"><code>Manifest-Version: 1.0
Dependencies: org.infinispan.remote:ispn-9.4 services</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="embedded_query"><a class="anchor" href="#embedded_query"></a>Embedded Query</h5>
<div class="paragraph">
<p>For embedded querying, including the Infinispan Query DSL, Lucene and Hibernate Search Queries, add the following:</p>
</div>
<div class="listingblock">
<div class="title">MANIFEST.MF</div>
<div class="content">
<pre class="CodeRay highlight"><code>Manifest-Version: 1.0
Dependencies: org.infinispan:ispn-9.4 services, org.infinispan.query:ispn-9.4 services</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="lucene_directory"><a class="anchor" href="#lucene_directory"></a>Lucene Directory</h5>
<div class="paragraph">
<p>Lucene users who wants to simple use Infinispan as a <em>org.apache.lucene.store.Directory</em> don&#8217;t need to add the query module, the entry below is sufficient:</p>
</div>
<div class="listingblock">
<div class="title">MANIFEST.MF</div>
<div class="content">
<pre class="CodeRay highlight"><code>Manifest-Version: 1.0
Dependencies: org.infinispan.lucene-directory:ispn-9.4</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="hibernate_search_directory_provider_for_infinispan"><a class="anchor" href="#hibernate_search_directory_provider_for_infinispan"></a>Hibernate Search directory provider for Infinispan</h5>
<div class="paragraph">
<p>The Hibernate Search directory provider for Infinispan is also contained within the Infinispan modules zip. It is not necessary to add an entry to the manifest file since the Hibernate Search module already has an optional dependency to it.
When choosing the Infinispan module zip to use, start by checking which Hibernate Search is in use, more details below.</p>
</div>
<div class="sect5">
<h6 id="usage_with_wildfly_internal_hibernate_search_modules"><a class="anchor" href="#usage_with_wildfly_internal_hibernate_search_modules"></a>Usage with WildFly Internal Hibernate Search Modules</h6>
<div class="paragraph">
<p>The Hibernate Search module present in WildFly
10.x
has slot "5.5", which in turn has an optional dependency to <code>org.infinispan.hibernate-search.directory-provider:for-hibernatesearch-5.5</code>.
This dependency will be available once the Infinispan modules are <a href="#modules_installation_section">installed</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="usage_with_other_hibernate_search_modules"><a class="anchor" href="#usage_with_other_hibernate_search_modules"></a>Usage with other Hibernate Search modules</h6>
<div class="paragraph">
<p>The module <code>org.hibernate.search:ispn-9.4</code> distributed with Infinispan is to be used together with Infinispan Query only (querying data from caches), and should not be used by Hibernate ORM applications.
To use a Hibernate Search with a different version that is present in WildFly, please consult the <a href="https://docs.jboss.org/hibernate/search/5.6/reference/en-US/html_single/#search-configuration-deploy-on-wildfly">Hibernate Search documentation</a>.</p>
</div>
<div class="paragraph">
<p>Make sure that the chosen Hibernate Search optional slot for <code>org.infinispan.hibernate-search.directory-provider</code> matches the one distributed with Infinispan.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="usage"><a class="anchor" href="#usage"></a>24.8.3. Usage</h4>
<div class="paragraph">
<p>There are two possible ways for your application to utilize Infinispan within WildFly, embedded mode and server mode.</p>
</div>
<div class="sect4">
<h5 id="embedded_mode_2"><a class="anchor" href="#embedded_mode_2"></a>Embedded Mode</h5>
<div class="paragraph">
<p>All CacheManagers and cache instances are created in your application logic.  The lifecycle of your EmbeddedCacheManager
is tightly coupled with your application&#8217;s lifecycle, resulting in any manager instances created by your application being destroyed with your application.</p>
</div>
</div>
<div class="sect4">
<h5 id="server_mode"><a class="anchor" href="#server_mode"></a>Server Mode</h5>
<div class="paragraph">
<p>In server mode, it is possible for cache containers and caches to be created before runtime as part of WildFly&#8217;s
standalone/domain.xml configuration. This allows cache instances to be shared across multiple applications, with the
lifecycle of the underlying cache container being independent of the deployed application.</p>
</div>
<div class="sect5">
<h6 id="configuration_12"><a class="anchor" href="#configuration_12"></a>Configuration</h6>
<div class="paragraph">
<p>To enable server mode, make the following additions to your WildFly configuration in <code>standalone/domain.xml</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the Infinispan extensions to your <code>&lt;extensions&gt;</code> section.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;extensions&gt;</span>
  <span class="tag">&lt;extension</span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.extension:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;extension</span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.server.endpoint:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;extension</span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups.extension:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

  <span class="comment">&lt;!--Other wildfly extensions--&gt;</span>
<span class="tag">&lt;/extensions&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Infinispan subsystem and your required containers and caches in the server profile that requires Infinispan.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Be sure that you define the <code>module</code> attribute to load the correct Infinispan classes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:server:core:9.4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="tag">&lt;cache-container</span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.extension:ispn-9.4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan_container</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;transport</span><span class="tag">/&gt;</span>
   <span class="tag">&lt;global-state</span><span class="tag">/&gt;</span>
   <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">memcachedCache</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Define the WildFly <a href="https://docs.jboss.org/author/display/WFLY10/Interfaces+and+ports">socket-bindings</a> required by the endpoint and/or JGroup subsystems</p>
</li>
<li>
<p>Configure any endpoints that you require via the endpoint subsystem:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:server:endpoint:9.4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;hotrod-connector</span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan_container</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;topology-state-transfer</span> <span class="attribute-name">lazy-retrieval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lock-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">replication-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/hotrod-connector&gt;</span>
  <span class="tag">&lt;rest-connector</span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan_container</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;authentication</span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ApplicationRealm</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auth-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BASIC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/rest-connector&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Define the JGroups transport, ensuring that you define the <code>model</code> attribute for each protocol.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You do not neet to define a JGroups transport for local cache configurations. The JGroups transport is required for clustered cache configurations only.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:server:jgroups:9.4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="tag">&lt;channels</span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cluster</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;channel</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cluster</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">udp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;/channels&gt;</span>
 <span class="tag">&lt;stacks&gt;</span>
   <span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">udp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;transport</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UDP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-udp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PING</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FD_SOCK</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-udp-fd</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FD_ALL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VERIFY_SUSPECT</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.NAKACK2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UNICAST3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.STABLE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.GMS</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UFC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MFC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FRAG2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jgroups:ispn-9.4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/stack&gt;</span>
 <span class="tag">&lt;/stacks&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="accessing_containers_and_caches"><a class="anchor" href="#accessing_containers_and_caches"></a>Accessing Containers and Caches</h6>
<div class="paragraph">
<p>Once a container has been defined in your server&#8217;s configuration, it is possible to inject an instance of a CacheContainer
or Cache into your application using the <code>@Resource</code> JNDI lookup. A container is accessed using the following string
<code>java:jboss/datagrid-infinispan/container/&lt;container_name&gt;</code> and similarly a cache is
accessed via <code>java:jboss/datagrid-infinispan/container/&lt;container_name&gt;/cache/&lt;cache_name&gt;</code>.</p>
</div>
<div class="paragraph">
<p>The example below shows how to inject the CacheContainer
called "infinispan_container" and the distributed cache "namedCache" into an application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ExampleApplication</span> {
    <span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/datagrid-infinispan/container/infinispan_container</span><span class="delimiter">&quot;</span></span>)
    CacheContainer container;

    <span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/datagrid-infinispan/container/infinispan_container/cache/namedCache</span><span class="delimiter">&quot;</span></span>)
    Cache cache;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting_2"><a class="anchor" href="#troubleshooting_2"></a>24.8.4. Troubleshooting</h4>
<div class="sect4">
<h5 id="enable_logging"><a class="anchor" href="#enable_logging"></a>Enable logging</h5>
<div class="paragraph">
<p>Enabling trace on <code>org.jboss.modules</code> can be useful to debug issues like <code>LinkageError</code> and <code>ClassNotFoundException</code>.
To enable it at runtime using the WildFly CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bin/jboss-cli.sh -c '/subsystem=logging/logger=org.jboss.modules:add'
bin/jboss-cli.sh -c '/subsystem=logging/logger=org.jboss.modules:write-attribute(name=level,value=TRACE)'</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="print_dependency_tree"><a class="anchor" href="#print_dependency_tree"></a>Print dependency tree</h5>
<div class="paragraph">
<p>The following command can be used to print all dependencies for a certain module. For example, to obtain the tree for the module <code>org.infinispan:ispn-9.4</code>, execute from <code>WILDFLY_HOME</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar jboss-modules.jar -deptree -mp modules/ "org.infinispan:ispn-9.4"</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="grid_file"><a class="anchor" href="#grid_file"></a>25. Grid File System</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan&#8217;s GridFileSystem is an experimental API that exposes an Infinispan-backed data grid as a file system.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This is an <em>experimental</em> API.  Use at your own risk.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Specifically, the API works as an extension to the JDK&#8217;s <a href="https://docs.oracle.com/javase/8/docs/api/java/io/File.html">File</a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/io/InputStream.html">InputStream</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/io/OutputStream.html">OutputStream</a> classes: specifically, <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/io/GridFile.html">GridFile</a>, <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/io/GridInputStream.html">GridInputStream</a> and <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/io/GridOutputStream.html">GridOutputStream</a>.
A helper class, <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/io/GridFilesystem.html">GridFilesystem</a>, is also included.</p>
</div>
<div class="paragraph">
<p>Essentially, the <a href="https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/io/GridFilesystem.html">GridFilesystem</a> is backed by 2 Infinispan caches - one for metadata (typically replicated) and one for the actual data (typically distributed).
The former is replicated so that each node has metadata information locally and would not need to make RPC calls to list files, etc.
The latter is distributed since this is where the bulk of storage space is used up, and a scalable mechanism is needed here.
Files themselves are chunked and each chunk is stored as a cache entry, as a byte array.</p>
</div>
<div class="paragraph">
<p>Here is a quick code snippet demonstrating usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>,<span class="type">byte</span><span class="type">[]</span>&gt; data = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">distributed</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">String</span>,GridFile.Metadata&gt; metadata = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">replicated</span><span class="delimiter">&quot;</span></span>);
GridFilesystem fs = <span class="keyword">new</span> GridFilesystem(data, metadata);

<span class="comment">// Create directories</span>
<span class="predefined-type">File</span> file=fs.getFile(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/testfile/stuff</span><span class="delimiter">&quot;</span></span>);
fs.mkdirs(); <span class="comment">// creates directories /tmp/testfile/stuff</span>

<span class="comment">// List all files and directories under &quot;/usr/local&quot;</span>
file=fs.getFile(<span class="string"><span class="delimiter">&quot;</span><span class="content">/usr/local</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">File</span><span class="type">[]</span> files=file.listFiles();

<span class="comment">// Create a new file</span>
file=fs.getFile(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/testfile/stuff/README.txt</span><span class="delimiter">&quot;</span></span>);
file.createNewFile();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copying stuff to the grid file system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">InputStream</span> in=<span class="keyword">new</span> <span class="predefined-type">FileInputStream</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/my-movies/dvd-image.iso</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">OutputStream</span> out=fs.getOutput(<span class="string"><span class="delimiter">&quot;</span><span class="content">/grid-movies/dvd-image.iso</span><span class="delimiter">&quot;</span></span>);
<span class="type">byte</span><span class="type">[]</span> buffer=<span class="keyword">new</span> <span class="type">byte</span>[<span class="integer">20000</span>];
<span class="type">int</span> len;
<span class="keyword">while</span>((len=in.read(buffer, <span class="integer">0</span>, buffer.length)) != -<span class="integer">1</span>) out.write(buffer, <span class="integer">0</span>, len);
in.close();
out.close();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reading stuff from the grid:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">InputStream</span> in=in.getInput(<span class="string"><span class="delimiter">&quot;</span><span class="content">/grid-movies/dvd-image.iso</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">OutputStream</span> out=<span class="keyword">new</span> <span class="predefined-type">FileOutputStream</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/my-movies/dvd-image.iso</span><span class="delimiter">&quot;</span></span>);
<span class="type">byte</span><span class="type">[]</span> buffer=<span class="keyword">new</span> <span class="type">byte</span>[<span class="integer">200000</span>];
<span class="type">int</span> len;
<span class="keyword">while</span>((len=in.read(buffer, <span class="integer">0</span>, buffer.length)) != -<span class="integer">1</span>) out.write(buffer, <span class="integer">0</span>, len);
in.close();
out.close();</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="webdav_demo"><a class="anchor" href="#webdav_demo"></a>25.1. WebDAV demo</h3>
<div class="paragraph">
<p>Infinispan ships with a demo <a href="http://en.wikipedia.org/wiki/WebDAV">WebDAV</a> application that makes use of the grid file system APIs.
This demo app is packaged as a <a href="http://en.wikipedia.org/wiki/WAR_(Sun_file_format)">WAR</a> file which can be deployed in a servlet container, such as JBoss AS or Tomcat, and exposes the grid as a file system over WebDAV.
This could then be mounted as a remote drive on your operating system.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="x_site_replication"><a class="anchor" href="#x_site_replication"></a>26. Cross site replication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cross site (x-site) replication allows backing up the data from one cluster to other clusters, potentially situated in different geographical location. The cross-site replication is built on top of JGroups' <a href="http://www.jgroups.org/manual-3.x/html/user-advanced.html#Relay2Advanced">RELAY2 protocol</a> . <a href="https://community.jboss.org/wiki/DesignForCrossSiteReplication">This document</a> describes the technical design of cross site replication in more detail.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cross site replication needs the backup cache running in the site master node(s) (i.e. node which receives the backup and applies it). The backup cache starts automatically when it receives the first backup request.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="sample_deployment"><a class="anchor" href="#sample_deployment"></a>26.1. Sample deployment</h3>
<div class="paragraph">
<p>The diagram below depicts a possible setup of replicated sites, followed by a description of individual elements present in the deployment. Options are then explained at large in future paragraphs. Comments on the diagram above:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/xdc.png" alt="Cross-site datacenters">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>there are 3 sites: LON, NYC and SFO.</p>
</li>
<li>
<p>in each site there is a running Infinispan cluster with a (potentially) different number of physical nodes: 3 nodes in LON, 4 nodes in NYC and 3 nodes in SFO</p>
</li>
<li>
<p>the "users" cache is active in LON, NYC and SFO. Updates on the "users" cache in any of these sites gets replicated to the other sites as well</p>
</li>
<li>
<p>it is possible to use different replication mechanisms between sites. E.g. One can configure SFO to backup data synchronously to NYC and asynchronously to LON</p>
</li>
<li>
<p>the "users" cache can have a different configuration from one site to the other. E.g. it might be configured as distributed with numOwners=2 in the LON site, REPL in the NYC site and distributed with numOwners=1 in the SFO site</p>
</li>
<li>
<p>JGroups is used for both inter-site and intra-site communication. <a href="http://www.jgroups.org/manual-3.x/html/user-advanced.html#Relay2Advanced">RELAY2</a> is used for inter-site communication</p>
</li>
<li>
<p>"orders" is a site local to LON, i.e. updates to the data in "orders" don&#8217;t get replicated to the remote sites The following sections discuss specific aspects of cross site replication into more detail. The foundation of the cross-site replication functionality is RELAY2 so it highly recommended to read JGroups' <a href="http://www.jgroups.org/manual-3.x/html/user-advanced.html#Relay2Advanced">RELAY2</a> documentation before moving on into cross-site. Configuration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The cross-site replication configuration spreads over the following files:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the backup policy for each individual cache is defined in the Infinispan .xml configuration file (<a href="https://gist.github.com/maniksurtani/cdd5420af764c907e342">infinispan.xml</a>)</p>
</li>
<li>
<p>cluster&#8217;s JGroups xml configuration file: <a href="http://www.jgroups.org/manual-3.x/html/user-advanced.html#Relay2Advanced">RELAY2</a> protocol needs to be added to the JGroups protocol stack (<a href="https://gist.github.com/maniksurtani/409fe5ece5fe4bcf679f">jgroups.xml</a>)</p>
</li>
<li>
<p>RELAY2 configuration file: RELAY2 has an own configuration file ( <a href="https://gist.github.com/maniksurtani/8c7238dae7921d2c883e">relay2.xml</a> )</p>
</li>
<li>
<p>the JGroups channel that is used by RELAY2 has its own configuration file (<a href="https://gist.github.com/maniksurtani/cbc1a297a367b1176feb">jgroups-relay2.xml</a>) Infinispan XML configuration file</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The local site is defined in the the global configuration section. The local is the site where the node using this configuration file resides (in the example above local site is "LON").</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;transport</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LON</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same setup can be achieved programatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder lonGc = GlobalConfigurationBuilder.defaultClusteredBuilder();
lonGc.site().localSite(<span class="string"><span class="delimiter">&quot;</span><span class="content">LON</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The names of the site (case sensitive) should match the name of a site as defined within JGroups' RELAY2 protocol configuration file. Besides the global configuration, each cache specifies its backup policy in the "site" element:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;backups&gt;</span>
    <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">failure-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WARN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">12000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SFO</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">failure-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">IGNORE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ASYNC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LON</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/backups&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The "users" cache backups its data to the "NYC" and "SFO" sites. Even though the "LON" appears as a backup site, it has the "enabled" attribute set to <em>false</em> so it will be ignored . For each site backup, the following configuration attributes can be specified:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>strategy</em> - the strategy used for backing up data, either "SYNC" or "ASYNC". Defaults to "ASYNC".</p>
</li>
<li>
<p><em>failure-policy</em> - Decides what the system would do in case of failure during backup. Possible values are:</p>
<div class="ulist">
<ul>
<li>
<p><em>IGNORE</em> - allow the local operation/transaction to succeed</p>
</li>
<li>
<p><em>WARN</em> - same as IGNORE but also logs a warning message. Default.</p>
</li>
<li>
<p><em>FAIL</em> - only in effect if "strategy" is "SYNC" - fails local cluster operation/transaction by throwing an exception to the user</p>
</li>
<li>
<p><em>CUSTOM</em> - user provided, see "failurePolicyClass" below</p>
</li>
</ul>
</div>
</li>
<li>
<p>failurePolicyClass - If the 'failure-policy' is set to 'CUSTOM' then this attribute is required and should contain the fully qualified name of a class implementing org.infinispan.xsite.CustomFailurePolicy</p>
</li>
<li>
<p>timeout - The timeout(milliseconds) to be used when backing up data remotely. Defaults to 10000 (10 seconds)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The same setup can be achieved programatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder lon = <span class="keyword">new</span> ConfigurationBuilder();
lon.sites().addBackup()
      .site(<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span>)
      .backupFailurePolicy(BackupFailurePolicy.WARN)
      .strategy(BackupConfiguration.BackupStrategy.SYNC)
      .replicationTimeout(<span class="integer">12000</span>)
      .sites().addInUseBackupSite(<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span>)
    .sites().addBackup()
      .site(<span class="string"><span class="delimiter">&quot;</span><span class="content">SFO</span><span class="delimiter">&quot;</span></span>)
      .backupFailurePolicy(BackupFailurePolicy.IGNORE)
      .strategy(BackupConfiguration.BackupStrategy.ASYNC)
      .sites().addInUseBackupSite(<span class="string"><span class="delimiter">&quot;</span><span class="content">SFO</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The "users" cache above doesn&#8217;t know on which cache on the remote sites its data is being replicated. By default the remote site writes the backup data to a cache having the same name as the originator, i.e. "users". This behaviour can be overridden with an "backupFor" element. For example the following configuration in SFO makes the "usersLONBackup" cache act as the backup cache for the "users" cache defined above in the LON site:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">usersLONBackup</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;backup-for</span> <span class="attribute-name">remote-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LON</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;/distributed-cache&gt;</span>
  <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same setup can be achieved programatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder cb = <span class="keyword">new</span> ConfigurationBuilder();
cb.sites().backupFor().remoteCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>).remoteSite(<span class="string"><span class="delimiter">&quot;</span><span class="content">LON</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="local_clusters_jgroups_xml_configuration"><a class="anchor" href="#local_clusters_jgroups_xml_configuration"></a>26.1.1. Local cluster&#8217;s jgroups .xml configuration</h4>
<div class="paragraph">
<p>This is the configuration file for the local (intra-site) Infinispan cluster. It is referred from the Infinispan configuration file, see "configurationFile" below:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;jgroups&gt;</span>
     <span class="tag">&lt;stack-file</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">external-file</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/jgroups&gt;</span>
 <span class="tag">&lt;cache-container&gt;</span>
 <span class="tag">&lt;transport</span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">external-file</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;/cache-container&gt;</span>

 ...

<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to allow inter-site calls, the RELAY2 protocol needs to be added to the protocol stack defined in the jgroups configuration (see attached <a href="https://gist.github.com/maniksurtani/409fe5ece5fe4bcf679f">jgroups.xml</a> for an example).</p>
</div>
</div>
<div class="sect3">
<h4 id="relay2_configuration_file"><a class="anchor" href="#relay2_configuration_file"></a>26.1.2. RELAY2 configuration file</h4>
<div class="paragraph">
<p>The RELAY2 configuration file is linked from the jgroups.xml (see attached <a href="https://gist.github.com/maniksurtani/8c7238dae7921d2c883e">relay2.xml</a>). It defines the sites seen by this cluster and also the JGroups configuration file that is used by RELAY2 in order to communicate with the remote sites.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="data_replication"><a class="anchor" href="#data_replication"></a>26.2. Data replication</h3>
<div class="paragraph">
<p>For both transactional and non-transactional caches, the backup calls are performed in parallel with local cluster calls, e.g. if we write data to node N1 in LON then replication to the local nodes N2 and N3 and remote backup sites SFO and NYC happen in parallel.</p>
</div>
<div class="sect3">
<h4 id="non_transactional_caches_2"><a class="anchor" href="#non_transactional_caches_2"></a>26.2.1. Non transactional caches</h4>
<div class="paragraph">
<p>In the case of non-transactional caches the replication happens during each operation. Given that data is sent in parallel to backups and local caches, it is possible for the operations to succeed locally and fail remotely, or the other way, causing inconsistencies</p>
</div>
</div>
<div class="sect3">
<h4 id="transactional_caches_2"><a class="anchor" href="#transactional_caches_2"></a>26.2.2. Transactional caches</h4>
<div class="paragraph">
<p>For synchronous transactional caches, Infinispan internally uses a two phase commit protocol: lock acquisition during the 1st phase (prepare) and apply changes during the 2nd phase (commit). For asynchronous caches the two phases are merged, the "apply changes" message being sent asynchronously to the owners of data. This 2PC protocol maps to 2PC received from the JTA transaction manager. For transactional caches, both optimistic and pessimistic, the backup to remote sites happens during the prepare and commit phase only.</p>
</div>
<div class="sect4">
<h5 id="synchronous_local_cluster_with_async_backup"><a class="anchor" href="#synchronous_local_cluster_with_async_backup"></a>Synchronous local cluster with async backup</h5>
<div class="paragraph">
<p>In this scenario the backup call happens during local commit phase(2nd phase). That means that if the local prepare fails, no remote data is being sent to the remote backup.</p>
</div>
</div>
<div class="sect4">
<h5 id="synchronous_local_cluster_with_sync_backup"><a class="anchor" href="#synchronous_local_cluster_with_sync_backup"></a>Synchronous local cluster with sync backup</h5>
<div class="paragraph">
<p>In this case there are two backup calls:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>during prepare a message is sent across containing all the modifications that happened within this transaction</p>
</li>
<li>
<p>if the remote backup cache is transactional then a transaction is started remotely and all these modifications are being written within this transaction&#8217;s scope. The transaction is not committed yet (see below)</p>
</li>
<li>
<p>if the remote backup cache is not transactional, then the changes are applied remotely</p>
</li>
<li>
<p>during the commit/rollback, a commit/rollback message is sent across</p>
</li>
<li>
<p>if the remote backups cache is transactional then the transaction started at the previous phase is committed/rolled back</p>
</li>
<li>
<p>if the remote backup is not transactional then this call is ignored</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both the local and the backup call(if the "backupFailurePolicy" is set to "FAIL") can veto transaction&#8217;s prepare outcome</p>
</div>
</div>
<div class="sect4">
<h5 id="asynchronous_local_cluster"><a class="anchor" href="#asynchronous_local_cluster"></a>Asynchronous local cluster</h5>
<div class="paragraph">
<p>In the case of asynchronous local clusters, the backup data is sent during the commit phase. If the backup call fails and the "backupFailurePolicy" is set to "FAIL" then the user is notified through an exception.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="replication_of_expired_cache_entries_across_sites"><a class="anchor" href="#replication_of_expired_cache_entries_across_sites"></a>26.2.3. Replication of expired cache entries across sites</h4>
<div class="paragraph">
<p>You can configure Infinispan to expire entries, which controls the amount of
time entries remain in the cache.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>lifespan</code> expiration is suitable for cross-site replication because entries
expire without the need for Infinispan to determine if the entries have
expired in clusters on other sites.</p>
</li>
<li>
<p><code>max-idle</code> expiration does not work with cross-site replication because
Infinispan cannot determine if cache entries have reached the idle timeout in
clusters on other sites.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="xsite_concurrent_writes"><a class="anchor" href="#xsite_concurrent_writes"></a>26.2.4. Deadlocks and Conflicting Entries</h4>
<div class="paragraph">
<p>In active/active configurations, concurrent writes to the same key results in
deadlocks or conflicts.</p>
</div>
<div class="paragraph">
<p>Active/active configurations are those in which both the local and the backup
sites replicate data to each other. For example, "SiteA" backs up to "SiteB"
and "SiteB" also backs up to "SiteA".</p>
</div>
<div class="paragraph">
<p>In synchronous mode (<code>SYNC</code>), concurrent writes result in deadlocks because
both sites lock the same key in different orders. To resolve deadlocks,
client applications must wait until the locks time out.</p>
</div>
<div class="paragraph">
<p>In asynchronous mode (<code>ASYNC</code>), concurrent writes result in conflicting values because sites replicate after entries are modified locally. There is no guaranteed order for asynchronous replication operations so the following outcomes are possible:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keys have different values each site. For example, <code>k=1</code> on "SiteA" and <code>k=2</code> on "SiteB". Asynchronous replication occurs at some point after the client writes to <code>k</code> with the result that <code>x=2</code> is replicated to "SiteA" and <code>x=1</code> is replicated to "SiteB".</p>
</li>
<li>
<p>One of the conflicting values is overwritten if sites do not replicate values at the same time. In this case, one of the values is lost and there is no guarantee which value is saved.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In all cases, inconsistencies in key values are resolved after the next
non-conflicting <code>PUT</code> operation updates the value.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There currently is no conflict resolution policy that client applications can
use to handle conflicts in asynchronous mode. However, conflict resolution
techniques are planned for a future Infinispan version.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="taking_a_site_offline"><a class="anchor" href="#taking_a_site_offline"></a>26.3. Taking a site offline</h3>
<div class="paragraph">
<p>If backing up to a site fails for a certain number of times during a time interval, then it is possible to automatically mark that site as offline. When a site is marked as offline the local site won&#8217;t try to backup data to it anymore. In order to be taken online a system administrator intervention being required.</p>
</div>
<div class="sect3">
<h4 id="configuration_13"><a class="anchor" href="#configuration_13"></a>26.3.1. Configuration</h4>
<div class="paragraph">
<p>The following configuration provides an example for taking sites offline:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bestEffortBackup</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   ...
   <span class="tag">&lt;backups&gt;</span>
     <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">failure-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAIL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;take-offline</span> <span class="attribute-name">after-failures</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">min-wait</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;/backup&gt;</span>
   <span class="tag">&lt;/backups&gt;</span>
    ...
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>take-offline</em> element under the <em>backup</em> configures the taking offline of a site:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>after-failures</em> - the number of failed backup operations after which this site should be taken offline. Defaults to 0 (never). A negative value would mean that the site will be taken offline after <em>minTimeToWait</em></p>
</li>
<li>
<p><em>min-wait</em> - the number of milliseconds in which a site is not marked offline even if it is unreachable for 'afterFailures' number of times. If smaller or equal to 0, then only <em>afterFailures</em> is considered.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The equivalent programmatic configuration is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">lon.sites().addBackup()
      .site(<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span>)
      .backupFailurePolicy(BackupFailurePolicy.FAIL)
      .strategy(BackupConfiguration.BackupStrategy.SYNC)
      .takeOffline()
         .afterFailures(<span class="integer">500</span>)
         .minTimeToWait(<span class="integer">10000</span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bringing_sites_back_online"><a class="anchor" href="#bringing_sites_back_online"></a>26.3.2. Bringing Sites Back Online</h4>
<div class="paragraph">
<p>After taking sites offline, invoke the <code>bringSiteOnline(siteName)</code> operation via the following JMX MBeans to bring sites back online:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>XSiteAdmin</code> enables replication on caches across clusters in a remote site.</p>
</li>
<li>
<p><code>GlobalXSiteAdminOperations</code> enables replication on cache containers across clusters in a remote site.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>bringSiteOnline(siteName)</code> operation enables replication only and does not do a full update. For this reason, when you bring sites back online, they only contain new entries. You should push transfer to sites after you bring them online to synchronize the most recent data.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Pushing state transfer brings sites back online. You can do that instead of invoking <code>bringSiteOnline(siteName)</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pushing_state_transfer_to_sites"><a class="anchor" href="#pushing_state_transfer_to_sites"></a>26.4. Pushing State Transfer to Sites</h3>
<div class="paragraph">
<p>Transferring state from one site to another synchronizes the data between the two sites.</p>
</div>
<div class="paragraph">
<p>You should always transfer state from the currently active site, which contains the most up-to-date data, to another site. The site to which you push state transfer can be online or offline. If you push state transfer to an offline site, it brings that site back online.</p>
</div>
<div class="paragraph">
<p>Caches on sites to which you transfer state from another site do not need to be empty. However, state transfer only overwrites existing keys on receiving sites and does not delete keys.</p>
</div>
<div class="paragraph">
<p>For example, key K exists on site A and site B. You transfer state from site A to site B. In this case, Infinispan overwrites key K. However, key Y exists on site B but not site A. After you transfer state from site A to site B, key Y still exists on site B.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can receive state transfer from only one site at a time. Likewise, if you invoke a state transfer operation on a site, Infinispan ignores subsequent invocations on that site.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Invoke the <code>pushState(String)</code> operation via the following JMX MBeans to bring sites back online:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>XSiteAdminOperations</code> synchronizes state for caches between the site on which you invoke the operation and a remote site. Brings the site online if it is offline.</p>
</li>
<li>
<p><code>GlobalXSiteAdminOperations</code> synchronizes state for cache containers between the site on which you invoke the operation and a remote site. Brings the site online if it is offline.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you invoke the <code>pushState(String)</code> operation on the site that transfers state, you specify the name of the site that receives the state.</p>
</div>
<div class="paragraph">
<p>The following figure shows the pushState(String) operation in JConsole:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/xsite-state-transfer.png" alt="xsite state transfer">
</div>
<div class="title">Figure 22. Pushing state via JConsole</div>
</div>
<div class="sect3">
<h4 id="handling_joinleave_nodes"><a class="anchor" href="#handling_joinleave_nodes"></a>26.4.1. Handling join/leave nodes</h4>
<div class="paragraph">
<p>The current implementation automatically handles the topology changes in producer or consumer site. Also, the cross-site
state transfer can run in parallel with a local site state transfer.</p>
</div>
</div>
<div class="sect3">
<h4 id="handling_broken_link_between_sites"><a class="anchor" href="#handling_broken_link_between_sites"></a>26.4.2. Handling broken link between sites</h4>
<div class="paragraph">
<p>A System Administrator action is needed if the link between the producer and consumer site is broken during the
cross-site state transfer (data consistency is not ensured in consumer site). The producer site retries for a while
before giving up. Then, it gets back to normal state. However, the consumer site is not able to get back to normal state
and, here, an action from System Administrator is need. The System Administrator should use the operation
cancelReceiveState(String siteName) to bring the consumer site to normal state.</p>
</div>
</div>
<div class="sect3">
<h4 id="system_administrator_operations"><a class="anchor" href="#system_administrator_operations"></a>26.4.3. System Administrator Operations</h4>
<div class="paragraph">
<p>A set of operations can be performed to control the cross-site state transfer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>pushState(String siteName) - It starts the cross-site state transfer to the site name specified;</p>
</li>
<li>
<p>cancelPushState(String siteName) - It cancels the cross-site state transfer to the site name specified;</p>
</li>
<li>
<p>getRunningStateTransfer() - It returns a list of site name to which this site is pushing the state;</p>
</li>
<li>
<p>getSendingSiteName() - It returns the site name that is pushing state to this site;</p>
</li>
<li>
<p>cancelReceiveState(String siteName) - It restores the site to normal state. Should be used when the link between
the sites is broken during the state transfer (as described above);</p>
</li>
<li>
<p>getPushStateStatus() - It returns the status of completed cross-site state transfer;</p>
</li>
<li>
<p>clearPushStateStatus() - It clears the status of completed cross-site state transfer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more technical information, you can check the Cross Site design document. See <a href="#x_site_reference">Reference</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="x_site_st_configuration"><a class="anchor" href="#x_site_st_configuration"></a>26.4.4. Configuration</h4>
<div class="paragraph">
<p>State transfer between sites cannot be enabled or disabled but it allows to tune some parameters. The values shown
below are the default values:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xSiteStateTransfer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   ...
   <span class="tag">&lt;backups&gt;</span>
      <span class="tag">&lt;backup</span> <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">failure-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAIL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;state-transfer</span> <span class="attribute-name">chunk-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">512</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1200000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-retries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">wait-time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/backup&gt;</span>
   <span class="tag">&lt;/backups&gt;</span>
    ...
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The equivalent programmatic configuration is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">lon.sites().addBackup()
      .site(<span class="string"><span class="delimiter">&quot;</span><span class="content">NYC</span><span class="delimiter">&quot;</span></span>)
      .backupFailurePolicy(BackupFailurePolicy.FAIL)
      .strategy(BackupConfiguration.BackupStrategy.SYNC)
      .stateTransfer()
         .chunkSize(<span class="integer">512</span>)
         .timeout(<span class="integer">1200000</span>)
         .maxRetries(<span class="integer">30</span>)
         .waitingTimeBetweenRetries(<span class="integer">2000</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below, it is the parameters description:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>chunk-size</em> - The number of keys to batch before sending them to the consumer site. A negative or a zero value is
<strong>not</strong> a valid value. Default value is 512 keys.</p>
</li>
<li>
<p><em>timeout</em> - The time (in milliseconds) to wait for the consumer site acknowledge the reception and appliance of a
state chunk. A negative or zero value is <strong>not</strong> a valid value. Default value is 20 minutes.</p>
</li>
<li>
<p><em>max-retries</em> - The maximum number of retries when a push state command fails. A negative or a zero value means that
the command will not retry in case of failure. Default value is 30.</p>
</li>
<li>
<p><em>wait-time</em> - The waiting time (in milliseconds) between each retry. A negative or a zero value is <strong>not</strong> a valid
value. Default value is 2 seconds.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="x_site_reference"><a class="anchor" href="#x_site_reference"></a>26.5. Reference</h3>
<div class="paragraph">
<p><a href="https://community.jboss.org/wiki/DesignForCrossSiteReplication">This document</a> describes the technical design of cross site replication in more detail.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rolling_upgrades"><a class="anchor" href="#rolling_upgrades"></a>27. Performing Rolling Upgrades</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Upgrade Infinispan without downtime or data loss. You can perform rolling upgrades in Remote Client/Server Mode to start using a more recent version of Infinispan.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This section explains how to upgrade Infinispan servers, see the appropriate documentation for your Hot Rod client for upgrade procedures.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>From a high-level, you do the following to perform rolling upgrades:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set up a target cluster. The target cluster is the Infinispan version to which you want to migrate data. The source cluster is the Infinispan deployment that is currently in use. After the target cluster is running, you configure all clients to point to it instead of the source cluster.</p>
</li>
<li>
<p>Synchronize data from the source cluster to the target cluster.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="setting_up_a_target_cluster"><a class="anchor" href="#setting_up_a_target_cluster"></a>27.1. Setting Up a Target Cluster</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start the target cluster with unique network properties or a different JGroups cluster name to keep it separate from the source cluster.</p>
</li>
<li>
<p>Configure a <code>RemoteCacheStore</code> on the target cluster for each cache you want to migrate from the source cluster.</p>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>RemoteCacheStore</code> settings</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>remote-server</code> must point to the source cluster via the <code>outbound-socket-binding</code> property.</p>
</li>
<li>
<p><code>remoteCacheName</code> must match the cache name on the source cluster.</p>
</li>
<li>
<p><code>hotrod-wrapping</code> must be <code>true</code> (enabled).</p>
</li>
<li>
<p><code>shared</code> must be <code>true</code> (enabled).</p>
</li>
<li>
<p><code>purge</code> must be <code>false</code> (disabled).</p>
</li>
<li>
<p><code>passivation</code> must be <code>false</code> (disabled).</p>
</li>
<li>
<p><code>protocol-version</code> matches the Hot Rod protocol version of the source cluster.</p>
<div class="listingblock">
<div class="title">Example <code>RemoteCacheStore</code> Configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache&gt;</span>
   <span class="tag">&lt;remote-store</span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MyCache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">tcp-no-delay</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">protocol-version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2.5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">hotrod-wrapping</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;remote-server</span> <span class="attribute-name">outbound-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-store-hotrod-server</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span>
...
<span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.socket.binding.port-offset:0}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
  <span class="tag">&lt;outbound-socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-store-hotrod-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;remote-destination</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">198.51.100.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">11222</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/outbound-socket-binding&gt;</span>
  ...
<span class="tag">&lt;/socket-binding-group&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>Configure the target cluster to handle all client requests instead of the source cluster:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Configure all clients to point to the target cluster instead of the source cluster.</p>
</li>
<li>
<p>Restart each client node.</p>
<div class="paragraph">
<p>The target cluster lazily loads data from the source cluster on demand via <code>RemoteCacheStore</code>.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="synchronizing_data_from_the_source_cluster"><a class="anchor" href="#synchronizing_data_from_the_source_cluster"></a>27.2. Synchronizing Data from the Source Cluster</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Call the <code>synchronizeData()</code> method in the <code>TargetMigrator</code> interface. Do one of the following on the target cluster for each cache that you want to migrate:</p>
<div class="dlist">
<dl>
<dt class="hdlist1">JMX</dt>
<dd>
<div class="paragraph">
<p>Invoke the <code>synchronizeData</code> operation and specify the <code>hotrod</code> parameter on the <code>RollingUpgradeManager</code> MBean.</p>
</div>
</dd>
<dt class="hdlist1">CLI</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>$ bin/ispn-cli.sh --connect controller=127.0.0.1:9990 -c "/subsystem=datagrid-infinispan/cache-container=clustered/distributed-cache=MyCache:synchronize-data(migrator-name=hotrod)"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Data migrates to all nodes in the target cluster in parallel, with each node
receiving a subset of the data.</p>
</div>
<div class="paragraph">
<p>Use the following parameters to tune the operation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>read-batch</code> configures the number of entries to read from the source cluster at a time. The default value is <code>10000</code>.</p>
</li>
<li>
<p><code>write-threads</code> configures the number of threads used to write data. The default value is the number of processors available.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="paragraph">
<p><code>synchronize-data(migrator-name=hotrod, read-batch=100000, write-threads=3)</code></p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>Disable the <code>RemoteCacheStore</code> on the target cluster. Do one of the following:</p>
<div class="dlist">
<dl>
<dt class="hdlist1">JMX</dt>
<dd>
<div class="paragraph">
<p>Invoke the <code>disconnectSource</code> operation and specify the <code>hotrod</code> parameter on the <code>RollingUpgradeManager</code> MBean.</p>
</div>
</dd>
<dt class="hdlist1">CLI</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>$ bin/ispn-cli.sh --connect controller=127.0.0.1:9990 -c "/subsystem=datagrid-infinispan/cache-container=clustered/distributed-cache=MyCache:disconnect-source(migrator-name=hotrod)"</code></pre>
</div>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>Decommission the source cluster.
== Extending Infinispan
Infinispan can be extended to provide the ability for an end user to add
additional configurations, operations and components outside of the scope of the ones normally provided
by Infinispan.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="custom_commands"><a class="anchor" href="#custom_commands"></a>27.3. Custom Commands</h3>
<div class="paragraph">
<p>Infinispan makes use of a <a href="http://en.wikipedia.org/wiki/Command_pattern">command/visitor pattern</a> to
implement the various top-level methods you see on the public-facing API.
This is explained in further detail in the <a href="#arch_overview">Architectural Overview</a> section.
While the core commands - and their corresponding visitors - are hard-coded as
a part of Infinispan&#8217;s core module, module authors can extend and enhance Infinispan
by creating new custom commands.</p>
</div>
<div class="paragraph">
<p>As a module author (such as <a href="https://github.com/infinispan/infinispan/tree/master/query">infinispan-query</a>, etc.) you can define your own commands.</p>
</div>
<div class="paragraph">
<p>You do so by:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code> file and ensure this is packaged in your jar.</p>
</li>
<li>
<p>Implementing <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandFactory.java"><code>ModuleCommandFactory</code></a>,
<a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandInitializer.java"><code>ModuleCommandInitializer</code></a> and
<a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandExtensions.java"><code>ModuleCommandExtensions</code></a></p>
</li>
<li>
<p>Specifying the fully-qualified class name of the  <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandExtensions.java"><code>ModuleCommandExtensions</code></a>
implementation in <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code>.</p>
</li>
<li>
<p>Implement your custom commands and visitors for these commands</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="an_example"><a class="anchor" href="#an_example"></a>27.3.1. An Example</h4>
<div class="paragraph">
<p>Here is an example of an <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code> file, configured accordingly:</p>
</div>
<div class="listingblock">
<div class="title">org.infinispan.commands.module.ModuleCommandExtensions</div>
<div class="content">
<pre>org.infinispan.query.QueryModuleCommandExtensions</pre>
</div>
</div>
<div class="paragraph">
<p>For a full, working example of a sample module that makes use of custom commands and visitors, check out <a href="https://github.com/infinispan/infinispan-sample-module">Infinispan Sample Module</a> .</p>
</div>
</div>
<div class="sect3">
<h4 id="preassigned_custom_command_id_ranges"><a class="anchor" href="#preassigned_custom_command_id_ranges"></a>27.3.2. Preassigned Custom Command Id Ranges</h4>
<div class="paragraph">
<p>This is the list of <code>Command</code> identifiers that are used by Infinispan based modules or frameworks.
Infinispan users should avoid using ids within these ranges. (RANGES to be finalised yet!)
Being this a single byte, ranges can&#8217;t be too large.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Query:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 - 119</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Search:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">120 - 139</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hot Rod Server:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">140 - 141</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="extending_the_configuration_builders_and_parsers"><a class="anchor" href="#extending_the_configuration_builders_and_parsers"></a>27.4. Extending the configuration builders and parsers</h3>
<div class="paragraph">
<p>If your custom module requires configuration, it is possible to enhance Infinispan&#8217;s configuration builders and
parsers. Look at the <a href="https://github.com/infinispan/infinispan/blob/master/core/src/test/java/org/infinispan/configuration/module">custom module tests</a>
for a detail example on how to implement this.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="arch_overview"><a class="anchor" href="#arch_overview"></a>28. Architectural Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section contains a high level overview of Infinispan&#8217;s internal
architecture.  This document is geared towards people with an interest in
extending or enhancing Infinispan, or just curious about Infinispans internals.</p>
</div>
<div class="sect2">
<h3 id="cache_hierarchy"><a class="anchor" href="#cache_hierarchy"></a>28.1. Cache hierarchy</h3>
<div class="paragraph">
<p>Infinispan&#8217;s Cache interface extends the JRE&#8217;s ConcurrentMap interface
which provides for a familiar and easy-to-use API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">---
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Cache</span>&lt;K, V&gt; <span class="directive">extends</span> BasicCache&lt;K, V&gt; {
 ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>public interface BasicCache&lt;K, V&gt; extends ConcurrentMap&lt;K, V&gt; {
 &#8230;&#8203;
}
---</p>
</div>
<div class="paragraph">
<p>Caches are created by using a CacheContainer instance - either the
EmbeddedCacheManager or a RemoteCacheManager.  In addition to their capabilities
as a factory for Caches, CacheContainers also act as a registry for looking
up Caches.</p>
</div>
<div class="paragraph">
<p>EmbeddedCacheManagers create either clustered or standalone Caches that reside
in the same JVM.  RemoteCacheManagers, on the other hand, create RemoteCaches
that connect to a remote cache tier via the Hot Rod protocol.</p>
</div>
</div>
<div class="sect2">
<h3 id="arch_commands"><a class="anchor" href="#arch_commands"></a>28.2. Commands</h3>
<div class="paragraph">
<p>Internally, each and every cache operation is encapsulated by a command.  These
command objects represent the type of operation being performed, and also hold
references to necessary parameters.  The actual logic of a given command, for
example a ReplaceCommand, is encapsulated in the commands perform() method.
Very object-oriented and easy to test.</p>
</div>
<div class="paragraph">
<p>All of these commands implement the VisitableCommand inteface which allow a
Visitor (described in next section) to process them accordingly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">---
<span class="directive">public</span> <span class="type">class</span> <span class="class">PutKeyValueCommand</span> <span class="directive">extends</span> VisitableCommand {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>public class GetKeyValueCommand extends VisitableCommand {
  &#8230;&#8203;
}</p>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>etc &#8230;&#8203;
---</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="visitors"><a class="anchor" href="#visitors"></a>28.3. Visitors</h3>
<div class="paragraph">
<p>Commands are processed by the various Visitors.  The visitor interface,
displayed below, exposes methods to visit each of the different types of
commands in the system.  This gives us a type-safe mechanism for adding
behaviour to a call.Commands are processed by `Visitor`s.  The visitor
interface, displayed below, exposes methods to visit each of the different
types of commands in the system.  This gives us a type-safe mechanism for
adding behaviour to a call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">---
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Vistor</span> {
   <span class="predefined-type">Object</span> visitPutKeyValueCommand(InvocationContext ctx, PutKeyValueCommand command) <span class="directive">throws</span> <span class="predefined-type">Throwable</span>;</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Object visitRemoveCommand(InvocationContext ctx, RemoveCommand command) throws Throwable;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Object visitReplaceCommand(InvocationContext ctx, ReplaceCommand command) throws Throwable;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Object visitClearCommand(InvocationContext ctx, ClearCommand command) throws Throwable;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Object visitPutMapCommand(InvocationContext ctx, PutMapCommand command) throws Throwable;</pre>
</div>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>etc &#8230;&#8203;
}
---</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>An <code>AbstractVisitor</code> class in the <code>org.infinispan.commands</code> package is provided with
no-op implementations of each of these methods.  Real implementations then only
need override the visitor methods for the commands that interest them, allowing
for very concise, readable and testable visitor implementations.</p>
</div>
</div>
<div class="sect2">
<h3 id="interceptors"><a class="anchor" href="#interceptors"></a>28.4. Interceptors</h3>
<div class="paragraph">
<p>Interceptors are special types of Visitors, which are capable of visiting
commands, but also acts in a chain.  A chain of interceptors all visit the
command, one in turn, until all registered interceptors visit the command.</p>
</div>
<div class="paragraph">
<p>The class to note is the
<a href="//https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/interceptors/base/CommandInterceptor.html">CommandInterceptor</a>.
This abstract class implements the interceptor pattern, and also implements
Visitor.  Infinispan&#8217;s interceptors extend CommandInterceptor, and these add
specific behaviour to specific commands, such as distribution across a network
or writing through to disk.</p>
</div>
<div class="paragraph">
<p>There is also an experimental asynchronous interceptor which can be used.
The interface used for asynchronous interceptors is
<a href="//https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/interceptors/AsyncInterceptor.html">AsyncInterceptor</a>
and a base implementation which should be used when a custom implementation is desired
<a href="//https://docs.jboss.org/infinispan/9.4/apidocs/org/infinispan/interceptors/BaseCustomAsyncInterceptor.html">BaseCustomAsyncInterceptor</a>.
Note this class also implements the <code>Visitor</code> interface.</p>
</div>
</div>
<div class="sect2">
<h3 id="putting_it_all_together"><a class="anchor" href="#putting_it_all_together"></a>28.5. Putting it all together</h3>
<div class="paragraph">
<p>So how does this all come together?  Invocations on the cache cause the cache
to first create an invocation context for the call.  Invocation contexts
contain, among other things, transactional characteristics of the call.  The
cache then creates a command for the call, making use of a command factory which
initialises the command instance with parameters and references to other subsystems.</p>
</div>
<div class="paragraph">
<p>The cache then passes the invocation context and command to the InterceptorChain,
which calls each and every registered interceptor in turn to visit the command,
adding behaviour to the call.  Finally, the commands perform() method is invoked
and the return value, if any, is propagated back to the caller.</p>
</div>
</div>
<div class="sect2">
<h3 id="subsystem_managers"><a class="anchor" href="#subsystem_managers"></a>28.6. Subsystem Managers</h3>
<div class="paragraph">
<p>The interceptors act as simple interception points and dont contain a lot of
logic themselves.  Most behavioural logic is encapsulated as managers in various
subsystems, a small subset of which are:</p>
</div>
<div class="sect3">
<h4 id="distributionmanager"><a class="anchor" href="#distributionmanager"></a>28.6.1. DistributionManager</h4>
<div class="paragraph">
<p>Manager that controls how entries are distributed across the cluster.</p>
</div>
</div>
<div class="sect3">
<h4 id="transactionmanager"><a class="anchor" href="#transactionmanager"></a>28.6.2. TransactionManager</h4>
<div class="paragraph">
<p>Manager than handles transactions, usually supplied by a third party.</p>
</div>
</div>
<div class="sect3">
<h4 id="rpcmanager"><a class="anchor" href="#rpcmanager"></a>28.6.3. RpcManager</h4>
<div class="paragraph">
<p>Manager that handles replicating commands between nodes in the cluster.</p>
</div>
</div>
<div class="sect3">
<h4 id="lockmanager"><a class="anchor" href="#lockmanager"></a>28.6.4. LockManager</h4>
<div class="paragraph">
<p>Manager that handles locking keys when operations require them.</p>
</div>
</div>
<div class="sect3">
<h4 id="persistencemanager"><a class="anchor" href="#persistencemanager"></a>28.6.5. PersistenceManager</h4>
<div class="paragraph">
<p>Manager that handles persisting data to any configured cache stores.</p>
</div>
</div>
<div class="sect3">
<h4 id="datacontainer"><a class="anchor" href="#datacontainer"></a>28.6.6. DataContainer</h4>
<div class="paragraph">
<p>Container that holds the actual in memory entries.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuration_14"><a class="anchor" href="#configuration_14"></a>28.6.7. Configuration</h4>
<div class="paragraph">
<p>A component detailing all of the configuration in this cache.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="componentregistry"><a class="anchor" href="#componentregistry"></a>28.7. ComponentRegistry</h3>
<div class="paragraph">
<p>A registry where the various managers above and components are created and
stored for use in the cache.  All of the other managers and crucial componanets
are accesible through the registry.</p>
</div>
<div class="paragraph">
<p>The registry itself is a lightweight dependency injection framework, allowing
components and managers to reference and initialise one another.  Here is an
example of a component declaring a dependency on a DataContainer and a
Configuration, and a DataContainerFactory declaring its ability to construct
DataContainers on the fly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">---
   <span class="annotation">@Inject</span>
   <span class="directive">public</span> <span class="type">void</span> injectDependencies(DataContainer container, <span class="predefined-type">Configuration</span> configuration) {
      <span class="local-variable">this</span>.container = container;
      <span class="local-variable">this</span>.configuration = configuration;
   }</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>   @DefaultFactoryFor
   public class DataContainerFactory extends AbstractNamedCacheComponentFactory {
---</pre>
</div>
</div>
<div class="paragraph">
<p>Components registered with the ComponentRegistry may also have a lifecycle, and
methods annotated with @Start or @Stop will be invoked before and after they
are used by the component registry.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">---
   <span class="annotation">@Start</span>
   <span class="directive">public</span> <span class="type">void</span> init() {
      useWriteSkewCheck = configuration.locking().writeSkewCheck();
   }</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>   @Stop(priority=20)
   public void stop() {
      notifier.removeListener(listener);
      executor.shutdownNow();
   }
---</pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, the optional priority parameter to @Stop is used to
indicate the order in which the component is stopped, in relation to other
components.  This follows a Unix Sys-V style ordering, where smaller priority
methods are called before higher priority ones.  The default priority, if not
specified, is 10.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-08-05 04:02:26 -0400
</div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>