<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="generator" content="Asciidoctor 1.5.8"> <title>Embedding Infinispan 10.0</title> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"> <style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> <style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style> <link rel="canonical" href="http://infinispan.org/docs/stable/user_guide/user_guide.html"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css"> <link rel="stylesheet" href="../../css/css.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script> <script src="../../js/js.js"></script> </head> <body class="book toc2 toc-left"> <div id="header"> <h1>Embedding Infinispan 10.0</h1> <div id="toc" class="toc2"> <div id="toctitle">Table of Contents</div> <ul class="sectlevel1"> <li><a href="#using_infinispan_as_an_embedded_cache_in_java_se">1. Using Infinispan as an embedded cache in Java SE</a> <ul class="sectlevel2"> <li><a href="#creating_a_new_infinispan_project">1.1. Creating a new Infinispan project</a> <ul class="sectlevel3"> <li><a href="#maven_users">1.1.1. Maven users</a></li> <li><a href="#ant_users">1.1.2. Ant users</a></li> </ul> </li> <li><a href="#running_infinispan_on_a_single_node">1.2. Running Infinispan on a single node</a></li> <li><a href="#use_the_default_cache">1.3. Use the default cache</a></li> <li><a href="#use_a_custom_cache">1.4. Use a custom cache</a></li> </ul> </li> <li><a href="#using_infinispan_as_an_embedded_data_grid_in_java_se">2. Using Infinispan as an embedded data grid in Java SE</a> <ul class="sectlevel2"> <li><a href="#sharing_jgroups_channels">2.1. Sharing JGroups channels</a></li> <li><a href="#running_infinispan_in_a_cluster">2.2. Running Infinispan in a cluster</a> <ul class="sectlevel3"> <li><a href="#replicated_mode">2.2.1. Replicated mode</a></li> <li><a href="#distributed_mode">2.2.2. Distributed mode</a></li> </ul> </li> <li><a href="#clustered_cache_quickstart_architecture">2.3. clustered-cache quickstart architecture</a> <ul class="sectlevel3"> <li><a href="#logging_changes_to_the_cache">2.3.1. Logging changes to the cache</a></li> <li><a href="#whats_going_on">2.3.2. What&#8217;s going on?</a></li> </ul> </li> <li><a href="#configuring_the_cluster">2.4. Configuring the cluster</a> <ul class="sectlevel3"> <li><a href="#tweaking_the_cluster_configuration_for_your_network">2.4.1. Tweaking the cluster configuration for your network</a></li> </ul> </li> <li><a href="#configuring_a_replicated_data_grid">2.5. Configuring a replicated data-grid</a></li> <li><a href="#configuring_a_distributed_data_grid">2.6. Configuring a distributed data-grid</a></li> </ul> </li> <li><a href="#execute_code_grid">3. Executing code in the Grid</a> <ul class="sectlevel2"> <li><a href="#cluster_executor">3.1. Cluster Executor</a> <ul class="sectlevel3"> <li><a href="#filtering_execution_nodes">3.1.1. Filtering execution nodes</a></li> <li><a href="#timeout">3.1.2. Timeout</a></li> <li><a href="#single_node_submission">3.1.3. Single Node Submission</a> <ul class="sectlevel4"> <li><a href="#failover">Failover</a></li> </ul> </li> <li><a href="#example_pi_approximation">3.1.4. Example: PI Approximation</a></li> </ul> </li> </ul> </li> <li><a href="#streams">4. Streams</a> <ul class="sectlevel2"> <li><a href="#common_stream_operations">4.1. Common stream operations</a></li> <li><a href="#key_filtering">4.2. Key filtering</a></li> <li><a href="#segment_based_filtering">4.3. Segment based filtering</a></li> <li><a href="#localinvalidation">4.4. Local/Invalidation</a></li> <li><a href="#example">4.5. Example</a></li> <li><a href="#distributionreplicationscattered">4.6. Distribution/Replication/Scattered</a> <ul class="sectlevel3"> <li><a href="#rehash_aware">4.6.1. Rehash Aware</a></li> <li><a href="#serialization">4.6.2. Serialization</a></li> </ul> </li> <li><a href="#parallel_computation">4.7. Parallel Computation</a></li> <li><a href="#task_timeout">4.8. Task timeout</a></li> <li><a href="#injection">4.9. Injection</a></li> <li><a href="#distributed_stream_execution">4.10. Distributed Stream execution</a></li> <li><a href="#key_based_rehash_aware_operators">4.11. Key based rehash aware operators</a></li> <li><a href="#intermediate_operation_exceptions">4.12. Intermediate operation exceptions</a></li> <li><a href="#examples">4.13. Examples</a></li> </ul> </li> <li><a href="#locked_streams">5. Locked Streams</a> <ul class="sectlevel2"> <li><a href="#locked_streams_2">5.1. Locked Streams</a></li> </ul> </li> <li><a href="#cloud_services">6. Running on Cloud Services</a> <ul class="sectlevel2"> <li><a href="#generic_discovery_protocols">6.1. Generic Discovery protocols</a> <ul class="sectlevel3"> <li><a href="#tcpping">6.1.1. TCPPing</a></li> <li><a href="#gossiprouter">6.1.2. GossipRouter</a></li> </ul> </li> <li><a href="#amazon_web_services">6.2. Amazon Web Services</a> <ul class="sectlevel3"> <li><a href="#native_s3_ping">6.2.1. NATIVE_S3_PING</a></li> <li><a href="#jdbc_ping">6.2.2. JDBC_PING</a></li> </ul> </li> <li><a href="#microsoft_azure">6.3. Microsoft Azure</a> <ul class="sectlevel3"> <li><a href="#azure_ping">6.3.1. AZURE_PING</a></li> </ul> </li> <li><a href="#google_compute_engine">6.4. Google Compute Engine</a> <ul class="sectlevel3"> <li><a href="#google2_ping">6.4.1. GOOGLE2_PING</a></li> </ul> </li> <li><a href="#cloud_services_k8s">6.5. Kubernetes</a> <ul class="sectlevel3"> <li><a href="#cloud_services_kube_ping">6.5.1. Kube_PING</a></li> <li><a href="#cloud_services_dns_ping">6.5.2. DNS_PING</a></li> <li><a href="#using_kubernetes_and_openshift_rolling_updates">6.5.3. Using Kubernetes and OpenShift Rolling Updates</a></li> <li><a href="#rolling_upgrades_with_kubernetes_and_openshift">6.5.4. Rolling upgrades with Kubernetes and OpenShift</a></li> </ul> </li> </ul> </li> </ul> </div> </div> <div id="content"> <div class="sect1"> <h2 id="using_infinispan_as_an_embedded_cache_in_java_se"><a class="anchor" href="#using_infinispan_as_an_embedded_cache_in_java_se"></a>1. Using Infinispan as an embedded cache in Java SE</h2> <div class="sectionbody"> <div class="paragraph"> <p>Running Infinispan in embedded mode is very easy. First, we&#8217;ll set up a project, and then we&#8217;ll run Infinispan, and start adding data.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">embedded-cache quickstart</div> All the code discussed in this tutorial is available in the <a href="https://github.com/infinispan/infinispan-quickstart/tree/master/embedded-cache">embedded-cache quickstart</a>. </td> </tr> </table> </div> <div class="sect2"> <h3 id="creating_a_new_infinispan_project"><a class="anchor" href="#creating_a_new_infinispan_project"></a>1.1. Creating a new Infinispan project</h3> <div class="paragraph"> <p>The only thing you need to set up Infinispan is add it&#8217;s dependencies to your project.</p> </div> <div class="sect3"> <h4 id="maven_users"><a class="anchor" href="#maven_users"></a>1.1.1. Maven users</h4> <div class="paragraph"> <p>If you are using Maven (or another build system like Gradle or Ivy which can use Maven dependencies), then this is easy. Just add the following to the <code>&lt;dependencies&gt;</code> section of your <code>pom.xml</code>:</p> </div> <div class="listingblock"> <div class="title">pom.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-embedded<span class="tag">&lt;/artifactId&gt;</span>
  <span class="comment">&lt;!-- Replace ${version.infinispan} with the
  version of Infinispan that you're using. --&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Which version of Infinispan should I use?</div> We recommend using the latest stable version of Infinispan. All releases are displayed on the <a href="http://www.infinispan.org/download">downloads page</a>. </td> </tr> </table> </div> <div class="paragraph"> <p>Alternatively, you can <a href="https://raw.github.com/infinispan/infinispan-quickstart/master/embedded-cache/pom.xml">use the POM</a> from the quickstart that accompanies this tutorial.</p> </div> </div> <div class="sect3"> <h4 id="ant_users"><a class="anchor" href="#ant_users"></a>1.1.2. Ant users</h4> <div class="paragraph"> <p>If you are using Ant, or another build system which doesn&#8217;t provide declarative dependency management, then the Infinispan distribution zip contains a lib/ directory. Add the contents of this to the build classpath.</p> </div> </div> </div> <div class="sect2"> <h3 id="running_infinispan_on_a_single_node"><a class="anchor" href="#running_infinispan_on_a_single_node"></a>1.2. Running Infinispan on a single node</h3> <div class="paragraph"> <p>In order to run Infinispan, we&#8217;re going to create a <code>main()</code> method in the <code>Quickstart</code> class. Infinispan comes configured to run out of the box; once you have set up your dependencies, all you need to do to start using Infinispan is to create a new cache manager and get a handle on the default cache.</p> </div> <div class="listingblock"> <div class="title">Quickstart.java</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Quickstart</span> {

   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span> args<span class="type">[]</span>) <span class="directive">throws</span> <span class="exception">Exception</span> {
      Cache&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; c = <span class="keyword">new</span> DefaultCacheManager().getCache();
   }

}</code></pre> </div> </div> <div class="paragraph"> <p>We now need a way to run the main method! To run the Quickstart main class: If you are using Maven:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="bash">$ mvn compile exec:java -Dexec.mainClass=&quot;org.infinispan.quickstart.embeddedcache.Quickstart&quot;</code></pre> </div> </div> <div class="paragraph"> <p>You should see Infinispan start up, and the version in use logged to the console.</p> </div> <div class="paragraph"> <p>Congratulations, you now have Infinispan running as a local cache!</p> </div> </div> <div class="sect2"> <h3 id="use_the_default_cache"><a class="anchor" href="#use_the_default_cache"></a>1.3. Use the default cache</h3> <div class="paragraph"> <p>Infinispan exposes a Map-like, JSR-107-esque interface for accessing and mutating the data stored in the cache. For example:</p> </div> <div class="listingblock"> <div class="title">DefaultCacheQuickstart.java</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="comment">// Add a entry</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// Validate the entry is now in the cache</span>
assertEqual(<span class="integer">1</span>, cache.size());
assertTrue(cache.containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>));
<span class="comment">// Remove the entry from the cache</span>
<span class="predefined-type">Object</span> v = cache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// Validate the entry is no longer in the cache</span>
assertEqual(<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>, v);</code></pre> </div> </div> <div class="paragraph"> <p>Infinispan offers a thread-safe data-structure:</p> </div> <div class="listingblock"> <div class="title">DefaultCacheQuickstart.java</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="comment">// Add an entry with the key &quot;key&quot;</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// And replace it if missing</span>
cache.putIfAbsent(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">newValue</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// Validate that the new value was not added</span></code></pre> </div> </div> <div class="paragraph"> <p>By default entries are immortal but you can override this on a per-key basis and provide lifespans.</p> </div> <div class="listingblock"> <div class="title">DefaultCacheQuickstart.java</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="comment">//By default entries are immortal but we can override this on a per-key basis and provide lifespans.</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>, <span class="integer">5</span>, SECONDS);
assertTrue(cache.containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>));
<span class="predefined-type">Thread</span>.sleep(<span class="integer">10000</span>);</code></pre> </div> </div> <div class="paragraph"> <p>to run using maven:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="bash">$ mvn compile exec:java -Dexec.mainClass=&quot;org.infinispan.quickstart.embeddedcache.DefaultCacheQuickstart&quot;</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="use_a_custom_cache"><a class="anchor" href="#use_a_custom_cache"></a>1.4. Use a custom cache</h3> <div class="paragraph"> <p>Each cache in Infinispan can offer a different set of features (for example transaction support, different replication modes or support for eviction), and you may want to use different caches for different classes of data in your application. To get a custom cache, you need to register it with the manager first:</p> </div> <div class="listingblock"> <div class="title">CustomCacheQuickstart.java</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span> args<span class="type">[]</span>) <span class="directive">throws</span> <span class="exception">Exception</span> {
   EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager();
   manager.defineConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-cache</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ConfigurationBuilder()
             .eviction().strategy(LIRS).maxEntries(<span class="integer">10</span>)
             .build());
   Cache&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; c = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-cache</span><span class="delimiter">&quot;</span></span>);
}</code></pre> </div> </div> <div class="paragraph"> <p>The example above uses Infinispan&#8217;s fluent configuration, which offers the ability to configure your cache programmatically. However, should you prefer to use XML, then you may. We can create an identical cache to the one created with a programmatic configuration:</p> </div> <div class="paragraph"> <p>To run using maven:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="bash">$ mvn compile exec:java -Dexec.mainClass=&quot;org.infinispan.quickstart.embeddedcache.CustomCacheQuickstart&quot;</code></pre> </div> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan</span>
        <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:10.0 http://www.infinispan.org/schemas/infinispan-config-10.0.xsd</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:10.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xml-configured-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;memory&gt;</span>
            <span class="tag">&lt;object</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/memory&gt;</span>
       <span class="tag">&lt;/local-cache&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>

<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>We then need to load the configuration file, and use the programmatically defined cache:</p> </div> <div class="listingblock"> <div class="title">XmlConfiguredCacheQuickstart.java</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span> args<span class="type">[]</span>) <span class="directive">throws</span> <span class="exception">Exception</span> {
        Cache&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; c = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.xml</span><span class="delimiter">&quot;</span></span>).getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">xml-configured-cache</span><span class="delimiter">&quot;</span></span>);
}</code></pre> </div> </div> <div class="paragraph"> <p>To run using maven:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="bash">$ mvn compile exec:java -Dexec.mainClass=&quot;org.infinispan.quickstart.embeddedcache.XmlConfiguredCacheQuickstart&quot;</code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="using_infinispan_as_an_embedded_data_grid_in_java_se"><a class="anchor" href="#using_infinispan_as_an_embedded_data_grid_in_java_se"></a>2. Using Infinispan as an embedded data grid in Java SE</h2> <div class="sectionbody"> <div class="paragraph"> <p>Clustering Infinispan is simple. Under the covers, Infinispan uses <a href="http://www.jgroups.org">JGroups</a> as a network transport, and JGroups handles all the hard work of forming a cluster.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">clustered-cache quickstart</div> All the code discussed in this tutorial is available in the <a href="https://github.com/infinispan/infinispan-quickstart/tree/master/clustered-cache">clustered-cache quickstart</a>. </td> </tr> </table> </div> <div class="sect2"> <h3 id="sharing_jgroups_channels"><a class="anchor" href="#sharing_jgroups_channels"></a>2.1. Sharing JGroups channels</h3> <div class="paragraph"> <p>By default all caches created from a single CacheManager share the same JGroups channel and multiplex RPC messages over it. In this example caches 1, 2 and 3 all use the same JGroups channel.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager cm = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.xml</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; replSyncCache = cm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">replSyncCache</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; replAsyncCache = cm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">replAsyncCache</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; invalidationSyncCache = cm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">invalidationSyncCache</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="running_infinispan_in_a_cluster"><a class="anchor" href="#running_infinispan_in_a_cluster"></a>2.2. Running Infinispan in a cluster</h3> <div class="paragraph"> <p>It is easy set up a clustered cache. This tutorial will show you how to create two nodes in different processes on the same local machine. The quickstart follows the same structure as the embedded-cache quickstart, using Maven to compile the project, and a main method to launch the node.</p> </div> <div class="paragraph"> <p>If you are following along with the quickstarts, you can try the examples out.</p> </div> <div class="paragraph"> <p>The quickstart defines two clustered caches, one in <em>replication mode</em> and one <em>distribution mode</em>.</p> </div> <div class="sect3"> <h4 id="replicated_mode"><a class="anchor" href="#replicated_mode"></a>2.2.1. Replicated mode</h4> <div class="paragraph"> <p>To run the example in replication mode, we need to launch two nodes from different consoles. For the first node:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="bash">$ mvn exec:java -Djava.net.preferIPv4Stack=true -Djgroups.bind_addr=127.0.0.1 -Dexec.mainClass=&quot;org.infinispan.quickstart.clusteredcache.Node&quot; -Dexec.args=&quot;A&quot;</code></pre> </div> </div> <div class="paragraph"> <p>And for the second node:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="bash">$ mvn exec:java -Djava.net.preferIPv4Stack=true -Djgroups.bind_addr=127.0.0.1 -Dexec.mainClass=&quot;org.infinispan.quickstart.clusteredcache.Node&quot; -Dexec.args=&quot;B&quot;</code></pre> </div> </div> <div class="paragraph"> <p>Note: You need to set <code>-Djava.net.preferIPv4Stack=true</code> because the JGroups configuration uses IPv4 multicast address. Normally you should not need <code>-Djgroups.bind_addr=127.0.0.1</code>, but many wireless routers do not relay IP multicast by default.</p> </div> <div class="paragraph"> <p>Each node will insert or update an entry every second, and it will log any changes.</p> </div> </div> <div class="sect3"> <h4 id="distributed_mode"><a class="anchor" href="#distributed_mode"></a>2.2.2. Distributed mode</h4> <div class="paragraph"> <p>To run the example in distribution mode and see how entries are replicated to only two nodes, we need to launch three nodes from different consoles. For the first node:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="bash">$ mvn compile exec:java -Djava.net.preferIPv4Stack=true  -Dexec.mainClass=&quot;org.infinispan.quickstart.clusteredcache.Node&quot; -Dexec.args=&quot;-d A&quot;</code></pre> </div> </div> <div class="paragraph"> <p>For the second node:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="bash">$ mvn compile exec:java -Djava.net.preferIPv4Stack=true  -Dexec.mainClass=&quot;org.infinispan.quickstart.clusteredcache.Node&quot; -Dexec.args=&quot;-d B&quot;</code></pre> </div> </div> <div class="paragraph"> <p>And for the third node:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="bash">$ mvn compile exec:java -Djava.net.preferIPv4Stack=true  -Dexec.mainClass=&quot;org.infinispan.quickstart.clusteredcache.Node&quot; -Dexec.args=&quot;-d C&quot;</code></pre> </div> </div> <div class="paragraph"> <p>The same as in replication mode, each node will insert or update an entry every second, and it will log any changes. But unlike in replication mode, not every node will see every modification.</p> </div> <div class="paragraph"> <p>You can also see that each node holds a different set of entries by pressing Enter.</p> </div> </div> </div> <div class="sect2"> <h3 id="clustered_cache_quickstart_architecture"><a class="anchor" href="#clustered_cache_quickstart_architecture"></a>2.3. clustered-cache quickstart architecture</h3> <div class="sect3"> <h4 id="logging_changes_to_the_cache"><a class="anchor" href="#logging_changes_to_the_cache"></a>2.3.1. Logging changes to the cache</h4> <div class="paragraph"> <p>An easy way to see what is going on with your cache is to log mutated entries. An Infinispan listener is notified of any mutations:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.Listener</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.annotation</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.event</span>.*;
<span class="keyword">import</span> <span class="include">org.jboss.logging.Logger</span>;

<span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoggingListener</span> {

   <span class="directive">private</span> BasicLogger log = BasicLogFactory.getLog(LoggingListener.class);

   <span class="annotation">@CacheEntryCreated</span>
   <span class="directive">public</span> <span class="type">void</span> observeAdd(CacheEntryCreatedEvent&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; event) {
      <span class="keyword">if</span> (event.isPre())
         <span class="keyword">return</span>;
      log.infof(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cache entry %s = %s added in cache %s</span><span class="delimiter">&quot;</span></span>, event.getKey(), event.getValue(), event.getCache());
   }

   <span class="annotation">@CacheEntryModified</span>
   <span class="directive">public</span> <span class="type">void</span> observeUpdate(CacheEntryModifiedEvent&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; event) {
      <span class="keyword">if</span> (event.isPre())
         <span class="keyword">return</span>;
      log.infof(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cache entry %s = %s modified in cache %s</span><span class="delimiter">&quot;</span></span>, event.getKey(), event.getValue(), event.getCache());
   }

   <span class="annotation">@CacheEntryRemoved</span>
   <span class="directive">public</span> <span class="type">void</span> observeRemove(CacheEntryRemovedEvent&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; event) {
      <span class="keyword">if</span> (event.isPre())
         <span class="keyword">return</span>;
      log.infof(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cache entry %s removed in cache %s</span><span class="delimiter">&quot;</span></span>, event.getKey(), event.getCache());
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>Listeners methods are declared using annotations, and receive a payload which contains metadata about the notification. Listeners are notified of any changes. Here, the listeners simply log any entries added, modified, or removed.</p> </div> </div> <div class="sect3"> <h4 id="whats_going_on"><a class="anchor" href="#whats_going_on"></a>2.3.2. What&#8217;s going on?</h4> <div class="paragraph"> <p>The example allows you to start two or more nodes, each of which are started in a separate process. The node code is very simple, each node starts up, prints the local cache contents, registers a listener that logs any changes, and starts storing entries of the form <code>key-&lt;counter&gt; = &lt;local address&gt;-counter</code>.</p> </div> <div class="paragraph"> <div class="title">State transfer</div> <p>Infinispan automatically replicates the cache contents from the existing members to joining members. This can be controlled in two ways:</p> </div> <div class="ulist"> <ul> <li> <p>If you don&#8217;t want the <code>getCache()</code> call to block until the entire cache is transferred, you can configure <code>clustering.stateTransfer.awaitInitialTransfer = false</code>. Note that <code>cache.get(key)</code> will still return the correct value, even before the state transfer is finished.</p> </li> <li> <p>If it&#8217;s fast enough to re-create the cache entries from another source, you can disable state transfer completely, by configuring <code>clustering.stateTransfer.fetchInMemoryState = false</code>.</p> </li> </ul> </div> </div> </div> <div class="sect2"> <h3 id="configuring_the_cluster"><a class="anchor" href="#configuring_the_cluster"></a>2.4. Configuring the cluster</h3> <div class="paragraph"> <p>First, we need to ensure that the cache manager is cluster aware. Infinispan provides a default configuration for a clustered cache manager:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder.getClusteredDefault().build()</code></pre> </div> </div> <div class="sect3"> <h4 id="tweaking_the_cluster_configuration_for_your_network"><a class="anchor" href="#tweaking_the_cluster_configuration_for_your_network"></a>2.4.1. Tweaking the cluster configuration for your network</h4> <div class="paragraph"> <p>Depending on your network setup, you may need to tweak your JGroups set up. JGroups is configured via an XML file; the file to use can be specified via the GlobalConfiguration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">DefaultCacheManager cacheManager = <span class="keyword">new</span> DefaultCacheManager(
      GlobalConfigurationBuilder.defaultClusteredBuilder()
            .transport().nodeName(nodeName).addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">configurationFile</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups.xml</span><span class="delimiter">&quot;</span></span>)
            .build()
);</code></pre> </div> </div> <div class="paragraph"> <p>The <a href="http://www.jgroups.org/manual/html/index.html">JGroups documentation</a> provides extensive advice on getting JGroups working on your network. If you are new to configuring JGroups, you may get a little lost, so you might want to try tweaking these configuration parameters:</p> </div> <div class="ulist"> <ul> <li> <p>Using the system property <code>-Djgroups.bind_addr=127.0.0.1</code> causes JGroups to bind only to your loopback interface, meaning any firewall you may have configured won&#8217;t get in the way. Very useful for testing a cluster where all nodes are on one machine.</p> </li> </ul> </div> <div class="paragraph"> <p><strong>TODO - add more tips!</strong></p> </div> <div class="paragraph"> <p>You can also configure the JGroups configuration to use in Infinispan&#8217;s XML configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;jgroups&gt;</span>
     <span class="tag">&lt;stack-file</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">external-file</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/jgroups&gt;</span>
 <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="tag">&lt;transport</span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">external-file</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;/cache-container&gt;</span>

 ...

<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="configuring_a_replicated_data_grid"><a class="anchor" href="#configuring_a_replicated_data_grid"></a>2.5. Configuring a replicated data-grid</h3> <div class="paragraph"> <p>In replicated mode, Infinispan will store every entry on every node in the grid. This offers high durability and availability of data, but means the storage capacity is limited by the available heap space on the node with least memory. The cache should be configured to work in replication mode (either synchronous or asynchronous), and can otherwise be configured as normal. For example, if you want to configure the cache programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">cacheManager.defineConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">repl</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ConfigurationBuilder()
      .clustering()
      .cacheMode(CacheMode.REPL_SYNC)
      .build()
);</code></pre> </div> </div> <div class="paragraph"> <p>You can configure an identical cache using XML:</p> </div> <div class="listingblock"> <div class="title">infinispan-replication.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;jgroups</span><span class="tag">/&gt;</span>
 <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">repl</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;transport</span><span class="tag">/&gt;</span>
     <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">repl</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>along with</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> EmbeddedCacheManager createCacheManagerFromXml() <span class="directive">throws</span> <span class="exception">IOException</span> {
   <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-replication.xml</span><span class="delimiter">&quot;</span></span>);
}</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="configuring_a_distributed_data_grid"><a class="anchor" href="#configuring_a_distributed_data_grid"></a>2.6. Configuring a distributed data-grid</h3> <div class="paragraph"> <p>In distributed mode, Infinispan will store every entry on a subset of the nodes in the grid (the parameter numOwners controls how many owners each entry will have). Compared to replication, distribution offers increased storage capacity, but with increased latency to access data from non-owner nodes, and durability (data may be lost if all the owners are stopped in a short time interval). Adjusting the number of owners allows you to obtain the trade off between space, durability, and latency.</p> </div> <div class="paragraph"> <p>Infinispan also offers a <em>topology aware consistent hash</em> which will ensure that the owners of entries are located in different data centers, racks, or physical machines, to offer improved durability in case of node crashes or network outages.</p> </div> <div class="paragraph"> <p>The cache should be configured to work in distributed mode (either synchronous or asynchronous), and can otherwise be configured as normal. For example, if you want to configure the cache programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">cacheManager.defineConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">dist</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ConfigurationBuilder()
      .clustering()
      .cacheMode(CacheMode.DIST_SYNC)
      .hash().numOwners(<span class="integer">2</span>)
      .build()
);</code></pre> </div> </div> <div class="paragraph"> <p>You can configure an identical cache using XML:</p> </div> <div class="listingblock"> <div class="title">infinispan-distribution.xml:</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;jgroups</span><span class="tag">/&gt;</span>
 <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">repl</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;transport</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>along with</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> EmbeddedCacheManager createCacheManagerFromXml() <span class="directive">throws</span> <span class="exception">IOException</span> {
   <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-distribution.xml</span><span class="delimiter">&quot;</span></span>);
}</code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="execute_code_grid"><a class="anchor" href="#execute_code_grid"></a>3. Executing code in the Grid</h2> <div class="sectionbody"> <div class="paragraph"> <p>The main benefit of a Cache is the ability to very quickly lookup a value by its key, even across machines. In fact this use alone is probably the reason many users use Infinispan. However Infinispan can provide many more benefits that aren&#8217;t immediately apparent. Since Infinispan is usually used in a cluster of machines we also have features available that can help utilize the entire cluster for performing the user&#8217;s desired workload.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This section covers only executing code in the grid using an embedded cache, if you are using a remote cache you should review details about executing code in the remote grid. </td> </tr> </table> </div> <div class="sect2"> <h3 id="cluster_executor"><a class="anchor" href="#cluster_executor"></a>3.1. Cluster Executor</h3> <div class="paragraph"> <p>Since you have a group of machines, it makes sense to leverage their combined computing power for executing code on all of them them. The cache manager comes with a nice utility that allows you to execute arbitrary code in the cluster. Note this feature requires no Cache to be used. This <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/ClusterExecutor.html">Cluster Executor</a> can be retrieved by calling executor() on the <code>EmbeddedCacheManager</code>. This executor is retrievable in both clustered and non clustered configurations.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The ClusterExecutor is specifically designed for executing code where the code is not reliant upon the data in a cache and is used instead as a way to help users to execute code easily in the cluster. </td> </tr> </table> </div> <div class="paragraph"> <p>This manager was built specifically using Java 8 and such has functional APIs in mind, thus all methods take a functional inteface as an argument. Also since these arguments will be sent to other nodes they need to be serializable. We even used a nice trick to ensure our lambdas are immediately Serializable. That is by having the arguments implement both Serializable and the real argument type (ie. Runnable or Function). The JRE will pick the most specific class when determining which method to invoke, so in that case your lambdas will always be serializable. It is also possible to use an Externalizer to possibly reduce message size further.</p> </div> <div class="paragraph"> <p>The manager by default will submit a given command to all nodes in the cluster including the node where it was submitted from. You can control on which nodes the task is executed on by using the <code>filterTargets</code> methods as is explained in the section.</p> </div> <div class="sect3"> <h4 id="filtering_execution_nodes"><a class="anchor" href="#filtering_execution_nodes"></a>3.1.1. Filtering execution nodes</h4> <div class="paragraph"> <p>It is possible to limit on which nodes the command will be ran. For example you may want to only run a computation on machines in the same rack. Or you may want to perform an operation once in the local site and again on a different site. A cluster executor can limit what nodes it sends requests to at the scope of same or different machine, rack or site level.</p> </div> <div class="listingblock"> <div class="title">SameRack.java</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = ...;
manager.executor().filterTargets(ClusterExecutionPolicy.SAME_RACK).submit(...)</code></pre> </div> </div> <div class="paragraph"> <p>To use this topology base filtering you must enable topology aware consistent hashing through Server Hinting.</p> </div> <div class="paragraph"> <p>You can also filter using a predicate based on the <code>Address</code> of the node. This can also be optionally combined with topology based filtering in the previous code snippet.</p> </div> <div class="paragraph"> <p>We also allow the target node to be chosen by any means using a <code>Predicate</code> that will filter out which nodes can be considered for execution. Note this can also be combined with Topology filtering at the same time to allow even more fine control of where you code is executed within the cluster.</p> </div> <div class="listingblock"> <div class="title">Predicate.java</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = ...;
<span class="comment">// Just filter</span>
manager.executor().filterTargets(a -&gt; a.equals(..)).submit(...)
<span class="comment">// Filter only those in the desired topology</span>
manager.executor().filterTargets(ClusterExecutionPolicy.SAME_SITE, a -&gt; a.equals(..)).submit(...)</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="timeout"><a class="anchor" href="#timeout"></a>3.1.2. Timeout</h4> <div class="paragraph"> <p>Cluster Executor allows for a timeout to be set per invocation. This defaults to the distributed sync timeout as configured on the Transport Configuration. This timeout works in both a clustered and non clustered cache manager. The executor may or may not interrupt the threads executing a task when the timeout expires. However when the timeout occurs any <code>Consumer</code> or <code>Future</code> will be completed passing back a <code>TimeoutException</code>. This value can be overridden by ivoking the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/ClusterExecutor.html#timeout-long-java.util.concurrent.TimeUnit-">timeout</a> method and supplying the desired duration.</p> </div> </div> <div class="sect3"> <h4 id="single_node_submission"><a class="anchor" href="#single_node_submission"></a>3.1.3. Single Node Submission</h4> <div class="paragraph"> <p>Cluster Executor can also run in single node submission mode instead of submitting the command to all nodes it will instead pick one of the nodes that would have normally received the command and instead submit it it to only one. Each submission will possibly use a different node to execute the task on. This can be very useful to use the ClusterExecutor as a <code>java.util.concurrent.Executor</code> which you may have noticed that ClusterExecutor implements.</p> </div> <div class="listingblock"> <div class="title">SingleNode.java</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = ...;
manager.executor().singleNodeSubmission().submit(...)</code></pre> </div> </div> <div class="sect4"> <h5 id="failover"><a class="anchor" href="#failover"></a>Failover</h5> <div class="paragraph"> <p>When running in single node submission it may be desirable to also allow the Cluster Executor handle cases where an exception occurred during the processing of a given command by retrying the command again. When this occurs the Cluster Executor will choose a single node again to resubmit the command to up to the desired number of failover attempts. Note the chosen node could be any node that passes the topology or predicate check. Failover is enabled by invoking the overridden <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/ClusterExecutor.html#singleNodeSubmission-int-">singleNodeSubmission</a> method. The given command will be resubmitted again to a single node until either the command completes without exception or the total submission amount is equal to the provided failover count.</p> </div> </div> </div> <div class="sect3"> <h4 id="example_pi_approximation"><a class="anchor" href="#example_pi_approximation"></a>3.1.4. Example: PI Approximation</h4> <div class="paragraph"> <p>This example shows how you can use the ClusterExecutor to estimate the value of PI.</p> </div> <div class="paragraph"> <p>Pi approximation can greatly benefit from parallel distributed execution via Cluster Executor. Recall that area of the square is Sa = 4r2 and area of the circle is Ca=pi*r2. Substituting r2 from the second equation into the first one it turns out that pi = 4 * Ca/Sa. Now, image that we can shoot very large number of darts into a square; if we take ratio of darts that land inside a circle over a total number of darts shot we will approximate Ca/Sa value. Since we know that pi = 4 * Ca/Sa we can easily derive approximate value of pi. The more darts we shoot the better approximation we get. In the example below we shoot 1 billion darts but instead of "shooting" them serially we parallelize work of dart shooting across the entire Infinispan cluster. Note this will work in a cluster of 1 was well, but will be slower.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PiAppx</span> {

   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main (<span class="predefined-type">String</span> <span class="type">[]</span> arg){
      EmbeddedCacheManager cacheManager = ..
      boolean isCluster = ..

      int numPoints = <span class="integer">1</span>_000_000_000;
      <span class="type">int</span> numServers = isCluster ? cacheManager.getMembers().size() : <span class="integer">1</span>;
      <span class="type">int</span> numberPerWorker = numPoints / numServers;

      ClusterExecutor clusterExecutor = cacheManager.executor();
      <span class="type">long</span> start = <span class="predefined-type">System</span>.currentTimeMillis();
      <span class="comment">// We receive results concurrently - need to handle that</span>
      <span class="predefined-type">AtomicLong</span> countCircle = <span class="keyword">new</span> <span class="predefined-type">AtomicLong</span>();
      CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; fut = clusterExecutor.submitConsumer(m -&gt; {
         <span class="type">int</span> insideCircleCount = <span class="integer">0</span>;
         <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; numberPerWorker; i++) {
            <span class="type">double</span> x = <span class="predefined-type">Math</span>.random();
            <span class="type">double</span> y = <span class="predefined-type">Math</span>.random();
            <span class="keyword">if</span> (insideCircle(x, y))
               insideCircleCount++;
         }
         <span class="keyword">return</span> insideCircleCount;
      }, (address, count, throwable) -&gt; {
         <span class="keyword">if</span> (throwable != <span class="predefined-constant">null</span>) {
            throwable.printStackTrace();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address: </span><span class="delimiter">&quot;</span></span> + address + <span class="string"><span class="delimiter">&quot;</span><span class="content"> encountered an error: </span><span class="delimiter">&quot;</span></span> + throwable);
         } <span class="keyword">else</span> {
            countCircle.getAndAdd(count);
         }
      });
      fut.whenComplete((v, t) -&gt; {
         <span class="comment">// This is invoked after all nodes have responded with a value or exception</span>
         <span class="keyword">if</span> (t != <span class="predefined-constant">null</span>) {
            t.printStackTrace();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception encountered while waiting:</span><span class="delimiter">&quot;</span></span> + t);
         } <span class="keyword">else</span> {
            <span class="type">double</span> appxPi = <span class="float">4.0</span> * countCircle.get() / numPoints;

            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Distributed PI appx is </span><span class="delimiter">&quot;</span></span> + appxPi +
                  <span class="string"><span class="delimiter">&quot;</span><span class="content"> using </span><span class="delimiter">&quot;</span></span> + numServers + <span class="string"><span class="delimiter">&quot;</span><span class="content"> node(s), completed in </span><span class="delimiter">&quot;</span></span> + (<span class="predefined-type">System</span>.currentTimeMillis() - start) + <span class="string"><span class="delimiter">&quot;</span><span class="content"> ms</span><span class="delimiter">&quot;</span></span>);
         }
      });

      <span class="comment">// May have to sleep here to keep alive if no user threads left</span>
   }

   <span class="directive">private</span> <span class="directive">static</span> <span class="type">boolean</span> insideCircle(<span class="type">double</span> x, <span class="type">double</span> y) {
      <span class="keyword">return</span> (<span class="predefined-type">Math</span>.pow(x - <span class="float">0.5</span>, <span class="integer">2</span>) + <span class="predefined-type">Math</span>.pow(y - <span class="float">0.5</span>, <span class="integer">2</span>))
            &lt;= <span class="predefined-type">Math</span>.pow(<span class="float">0.5</span>, <span class="integer">2</span>);
   }
}</code></pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="streams"><a class="anchor" href="#streams"></a>4. Streams</h2> <div class="sectionbody"> <div class="paragraph"> <p>You may want to process a subset or all data in the cache to produce a result. This may bring thoughts of Map Reduce. Infinispan allows the user to do something very similar but utilizes the standard JRE APIs to do so. Java 8 introduced the concept of a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream</a> which allows functional-style operations on collections rather than having to procedurally iterate over the data yourself. Stream operations can be implemented in a fashion very similar to MapReduce. Streams, just like MapReduce allow you to perform processing upon the entirety of your cache, possibly a very large data set, but in an efficient way.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>Streams are the preferred method when dealing with data that exists in the cache because streams automatically adjust to cluster topology changes.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Also since we can control how the entries are iterated upon we can more efficiently perform the operations in a cache that is distributed if you want it to perform all of the operations across the cluster concurrently.</p> </div> <div class="paragraph"> <p>A stream is retrieved from the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html#entrySet--">entrySet</a>, <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html#keySet--">keySet</a> or <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html#values--">values</a> collections returned from the Cache by invoking the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#stream--">stream</a> or <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#parallelStream--">parallelStream</a> methods.</p> </div> <div class="sect2"> <h3 id="common_stream_operations"><a class="anchor" href="#common_stream_operations"></a>4.1. Common stream operations</h3> <div class="paragraph"> <p>This section highlights various options that are present irrespective of what type of underlying cache you are using.</p> </div> </div> <div class="sect2"> <h3 id="key_filtering"><a class="anchor" href="#key_filtering"></a>4.2. Key filtering</h3> <div class="paragraph"> <p>It is possible to filter the stream so that it only operates upon a given subset of keys. This can be done by invoking the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/CacheStream.html#filterKeys-java.util.Set-">filterKeys</a> method on the <code>CacheStream</code>. This should always be used over a Predicate <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html?is-external=true#filter-java.util.function.Predicate-">filter</a> and will be faster if the predicate was holding all keys.</p> </div> <div class="paragraph"> <p>If you are familiar with the <code>AdvancedCache</code> interface you may be wondering why you even use <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/AdvancedCache.html#getAll-java.util.Set-">getAll</a> over this keyFilter. There are some small benefits (mostly smaller payloads) to using getAll if you need the entries as is and need them all in memory in the local node. However if you need to do processing on these elements a stream is recommended since you will get both distributed and threaded parallelism for free.</p> </div> </div> <div class="sect2"> <h3 id="segment_based_filtering"><a class="anchor" href="#segment_based_filtering"></a>4.3. Segment based filtering</h3> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This is an advanced feature and should only be used with deep knowledge of Infinispan segment and hashing techniques. These segments based filtering can be useful if you need to segment data into separate invocations. This can be useful when integrating with other tools such as <a href="http://spark.apache.org/">Apache Spark</a>. </td> </tr> </table> </div> <div class="paragraph"> <p>This option is only supported for replicated and distributed caches. This allows the user to operate upon a subset of data at a time as determined by the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/distribution/ch/KeyPartitioner.html">KeyPartitioner</a>. The segments can be filtered by invoking <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/CacheStream.html#filterKeySegments-java.util.Set-">filterKeySegments</a> method on the <code>CacheStream</code>. This is applied after the key filter but before any intermediate operations are performed.</p> </div> </div> <div class="sect2"> <h3 id="localinvalidation"><a class="anchor" href="#localinvalidation"></a>4.4. Local/Invalidation</h3> <div class="paragraph"> <p>A stream used with a local or invalidation cache can be used just the same way you would use a stream on a regular collection. Infinispan handles all of the translations if necessary behind the scenes and works with all of the more interesting options (ie. storeAsBinary and a cache loader). Only data local to the node where the stream operation is performed will be used, for example invalidation only uses local entries.</p> </div> </div> <div class="sect2"> <h3 id="example"><a class="anchor" href="#example"></a>4.5. Example</h3> <div class="paragraph"> <p>The code below takes a cache and returns a map with all the cache entries whose values contain the string "JBoss"</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss</span><span class="delimiter">&quot;</span></span>))
              .collect(Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue));</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="distributionreplicationscattered"><a class="anchor" href="#distributionreplicationscattered"></a>4.6. Distribution/Replication/Scattered</h3> <div class="paragraph"> <p>This is where streams come into their stride. When a stream operation is performed it will send the various intermediate and terminal operations to each node that has pertinent data. This allows processing the intermediate values on the nodes owning the data, and only sending the final results back to the originating nodes, improving performance.</p> </div> <div class="sect3"> <h4 id="rehash_aware"><a class="anchor" href="#rehash_aware"></a>4.6.1. Rehash Aware</h4> <div class="paragraph"> <p>Internally the data is segmented and each node only performs the operations upon the data it owns as a primary owner. This allows for data to be processed evenly, assuming segments are granular enough to provide for equal amounts of data on each node.</p> </div> <div class="paragraph"> <p>When you are utilizing a distributed cache, the data can be reshuffled between nodes when a new node joins or leaves. Distributed Streams handle this reshuffling of data automatically so you don&#8217;t have to worry about monitoring when nodes leave or join the cluster. Reshuffled entries may be processed a second time, and we keep track of the processed entries at the key level or at the segment level (depending on the terminal operation) to limit the amount of duplicate processing.</p> </div> <div class="paragraph"> <p>It is possible but highly discouraged to disable rehash awareness on the stream. This should only be considered if your request can handle only seeing a subset of data if a rehash occurs. This can be done by invoking <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/CacheStream.html#disableRehashAware--">CacheStream.disableRehashAware()</a> The performance gain for most operations when a rehash doesn&#8217;t occur is completely negligible. The only exceptions are for iterator and forEach, which will use less memory, since they do not have to keep track of processed keys.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Please rethink disabling rehash awareness unless you really know what you are doing. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="serialization"><a class="anchor" href="#serialization"></a>4.6.2. Serialization</h4> <div class="paragraph"> <p>Since the operations are sent across to other nodes they must be serializable by Infinispan marshalling. This allows the operations to be sent to the other nodes.</p> </div> <div class="paragraph"> <p>The simplest way is to use a CacheStream instance and use a lambda just as you would normally. Infinispan overrides all of the various Stream intermediate and terminal methods to take Serializable versions of the arguments (ie. SerializableFunction, SerializablePredicate&#8230;&#8203;) You can find these methods at <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/stream/CacheStream.html">CacheStream</a>. This relies on the spec to pick the most specific method as defined <a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-15.html#jls-15.12.2.5">here</a>.</p> </div> <div class="paragraph"> <p>In our previous example we used a <code>Collector</code> to collect all the results into a <code>Map</code>. Unfortunately the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collectors.html">Collectors</a> class doesn&#8217;t produce Serializable instances. Thus if you need to use these, there are two ways to do so:</p> </div> <div class="paragraph"> <p>One option would be to use the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/stream/CacheCollectors.html">CacheCollectors</a> class which allows for a <code>Supplier&lt;Collector&gt;</code> to be provided. This instance could then use the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collectors.html">Collectors</a> to supply a <code>Collector</code> which is not serialized. You can read more details about how the collector peforms in a distributed fashion at <a href="user_guide.html#distributed_stream_execution">distributed execution</a>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(CacheCollectors.serializableCollector(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue)));</code></pre> </div> </div> <div class="paragraph"> <p>Alternatively, you can avoid the use of <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/stream/CacheCollectors.html">CacheCollectors</a> and instead use the overloaded <code>collect</code> methods that take <code>Supplier&lt;Collector&gt;</code>. These overloaded <code>collect</code> methods are only available via <code>CacheStream</code> interface.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue));</code></pre> </div> </div> <div class="paragraph"> <p>If however you are not able to use the <code>Cache</code> and <code>CacheStream</code> interfaces you cannot utilize <code>Serializable</code> arguments and you must instead cast the lambdas to be <code>Serializable</code> manually by casting the lambda to multiple interfaces. It is not a pretty sight but it gets the job done.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = map.entrySet().stream()
              .filter((<span class="predefined-type">Serializable</span> &amp; <span class="predefined-type">Predicate</span>&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt;&gt;) e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(CacheCollectors.serializableCollector(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue)));</code></pre> </div> </div> <div class="paragraph"> <p>The recommended and most performant way is to use an <a href="user_guide.html#advanced_externalizers">AdvancedExternalizer</a> as this provides the smallest payload. Unfortunately this means you cannot use lamdbas as advanced externalizers require defining the class before hand.</p> </div> <div class="paragraph"> <p>You can use an advanced externalizer as shown below:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">   <span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(<span class="keyword">new</span> ContainsFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue));

   <span class="type">class</span> <span class="class">ContainsFilter</span> <span class="directive">implements</span> <span class="predefined-type">Predicate</span>&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt;&gt; {
      <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> target;

      ContainsFilter(<span class="predefined-type">String</span> target) {
         <span class="local-variable">this</span>.target = target;
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="type">boolean</span> test(<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; e) {
         <span class="keyword">return</span> e.getValue().contains(target);
      }
   }

   <span class="type">class</span> <span class="class">JbossFilterExternalizer</span> <span class="directive">implements</span> AdvancedExternalizer&lt;ContainsFilter&gt; {

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> ContainsFilter&gt;&gt; getTypeClasses() {
         <span class="keyword">return</span> <span class="predefined-type">Util</span>.asSet(ContainsFilter.class);
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Integer</span> getId() {
         <span class="keyword">return</span> CUSTOM_ID;
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, ContainsFilter object) <span class="directive">throws</span> <span class="exception">IOException</span> {
         output.writeUTF(object.target);
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> ContainsFilter readObject(<span class="predefined-type">ObjectInput</span> input) <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
         <span class="keyword">return</span> <span class="keyword">new</span> ContainsFilter(input.readUTF());
      }
   }</code></pre> </div> </div> <div class="paragraph"> <p>You could also use an advanced externalizer for the collector supplier to reduce the payload size even further.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">   <span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(<span class="keyword">new</span> ContainsFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(ToMapCollectorSupplier.INSTANCE);

 <span class="type">class</span> <span class="class">ToMapCollectorSupplier</span>&lt;K, U&gt; <span class="directive">implements</span> Supplier&lt;Collector&lt;<span class="predefined-type">Map</span>.Entry&lt;K, U&gt;, ?, <span class="predefined-type">Map</span>&lt;K, U&gt;&gt;&gt; {
      <span class="directive">static</span> <span class="directive">final</span> ToMapCollectorSupplier INSTANCE = <span class="keyword">new</span> ToMapCollectorSupplier();

      <span class="directive">private</span> ToMapCollectorSupplier() { }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> Collector&lt;<span class="predefined-type">Map</span>.Entry&lt;K, U&gt;, ?, <span class="predefined-type">Map</span>&lt;K, U&gt;&gt; get() {
         <span class="keyword">return</span> Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue);
      }
   }

   <span class="type">class</span> <span class="class">ToMapCollectorSupplierExternalizer</span> <span class="directive">implements</span> AdvancedExternalizer&lt;ToMapCollectorSupplier&gt; {

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> ToMapCollectorSupplier&gt;&gt; getTypeClasses() {
         <span class="keyword">return</span> <span class="predefined-type">Util</span>.asSet(ToMapCollectorSupplier.class);
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Integer</span> getId() {
         <span class="keyword">return</span> CUSTOM_ID;
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, ToMapCollectorSupplier object) <span class="directive">throws</span> <span class="exception">IOException</span> {
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> ToMapCollectorSupplier readObject(<span class="predefined-type">ObjectInput</span> input) <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
         <span class="keyword">return</span> ToMapCollectorSupplier.INSTANCE;
      }
   }</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="parallel_computation"><a class="anchor" href="#parallel_computation"></a>4.7. Parallel Computation</h3> <div class="paragraph"> <p>Distributed streams by default try to parallelize as much as possible. It is possible for the end user to control this and actually they always have to control one of the options. There are 2 ways these streams are parallelized.</p> </div> <div class="paragraph"> <p><strong>Local to each node</strong> When a stream is created from the cache collection the end user can choose between invoking <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#stream--">stream</a> or <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#parallelStream--">parallelStream</a> method. Depending on if the parallel stream was picked will enable multiple threading for each node locally. Note that some operations like a rehash aware iterator and forEach operations will always use a sequential stream locally. This could be enhanced at some point to allow for parallel streams locally.</p> </div> <div class="paragraph"> <p>Users should be careful when using local parallelism as it requires having a large number of entries or operations that are computationally expensive to be faster. Also it should be noted that if a user uses a parallel stream with <code>forEach</code> that the action should not block as this would be executed on the common pool, which is normally reserved for computation operations.</p> </div> <div class="paragraph"> <p><strong>Remote requests</strong> When there are multiple nodes it may be desirable to control whether the remote requests are all processed at the same time concurrently or one at a time. By default all terminal operations except the iterator perform concurrent requests. The iterator, method to reduce overall memory pressure on the local node, only performs sequential requests which actually performs slightly better.</p> </div> <div class="paragraph"> <p>If a user wishes to change this default however they can do so by invoking the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/CacheStream.html#sequentialDistribution--">sequentialDistribution</a> or <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/CacheStream.html#parallelDistribution--">parallelDistribution</a> methods on the <code>CacheStream</code>.</p> </div> </div> <div class="sect2"> <h3 id="task_timeout"><a class="anchor" href="#task_timeout"></a>4.8. Task timeout</h3> <div class="paragraph"> <p>It is possible to set a timeout value for the operation requests. This timeout is used only for remote requests timing out and it is on a per request basis. The former means the local execution will not timeout and the latter means if you have a failover scenario as described above the subsequent requests each have a new timeout. If no timeout is specified it uses the replication timeout as a default timeout. You can set the timeout in your task by doing the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CacheStream&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; stream = cache.entrySet().stream();
stream.timeout(<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.MINUTES);</code></pre> </div> </div> <div class="paragraph"> <p>For more information about this, please check the java doc in <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/CacheStream.html#timeout-long-java.util.concurrent.TimeUnit-">timeout</a> javadoc.</p> </div> </div> <div class="sect2"> <h3 id="injection"><a class="anchor" href="#injection"></a>4.9. Injection</h3> <div class="paragraph"> <p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream</a> has a terminal operation called <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#forEach-java.util.function.Consumer-">forEach</a> which allows for running some sort of side effect operation on the data. In this case it may be desirable to get a reference to the <code>Cache</code> that is backing this Stream. If your <code>Consumer</code> implements the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/stream/CacheAware.html">CacheAware</a> interface the <code>injectCache</code> method be invoked before the accept method from the <code>Consumer</code> interface.</p> </div> </div> <div class="sect2"> <h3 id="distributed_stream_execution"><a class="anchor" href="#distributed_stream_execution"></a>4.10. Distributed Stream execution</h3> <div class="paragraph"> <p>Distributed streams execution works in a fashion very similiar to map reduce. Except in this case we are sending zero to many intermediate operations (map, filter etc.) and a single terminal operation to the various nodes. The operation basically comes down to the following:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>The desired segments are grouped by which node is the primary owner of the given segment</p> </li> <li> <p>A request is generated to send to each remote node that contains the intermediate and terminal operations including which segments it should process</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>The terminal operation will be performed locally if necessary</p> </li> <li> <p>Each remote node will receive this request and run the operations and subsequently send the response back</p> </li> </ol> </div> </li> <li> <p>The local node will then gather the local response and remote responses together performing any kind of reduction required by the operations themselves.</p> </li> <li> <p>Final reduced response is then returned to the user</p> </li> </ol> </div> <div class="paragraph"> <p>In most cases all operations are fully distributed, as in the operations are all fully applied on each remote node and usually only the last operation or something related may be reapplied to reduce the results from multiple nodes. One important note is that intermediate values do not actually have to be serializable, it is the last value sent back that is the part desired (exceptions for various operations will be highlighted below).</p> </div> <div class="paragraph"> <p><strong>Terminal operator distributed result reductions</strong> The following paragraphs describe how the distributed reductions work for the various terminal operators. Some of these are special in that an intermediate value may be required to be serializable instead of the final result.</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">allMatch noneMatch anyMatch</dt> <dd> <p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#allMatch-java.util.function.Predicate-">allMatch</a> operation is ran on each node and then all the results are logically anded together locally to get the appropriate value. The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#noneMatch-java.util.function.Predicate-">noneMatch</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#anyMatch-java.util.function.Predicate-">anyMatch</a> operations use a logical or instead. These methods also have early termination support, stopping remote and local operations once the final result is known.</p> </dd> <dt class="hdlist1">collect</dt> <dd> <p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">collect</a> method is interesting in that it can do a few extra steps. The remote node performs everything as normal except it doesn&#8217;t perform the final <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#finisher--">finisher</a> upon the result and instead sends back the fully combined results. The local thread then <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#combiner--">combines</a> the remote and local result into a value which is then finally finished. The key here to remember is that the final value doesn&#8217;t have to be serializable but rather the values produced from the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#supplier--">supplier</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#combiner--">combiner</a> methods.</p> </dd> <dt class="hdlist1">count</dt> <dd> <p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#count--">count</a> method just adds the numbers together from each node.</p> </dd> <dt class="hdlist1">findAny findFirst</dt> <dd> <p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#findAny--">findAny</a> operation returns just the first value they find, whether it was from a remote node or locally. Note this supports early termination in that once a value is found it will not process others. Note the findFirst method is special since it requires a sorted intermediate operation, which is detailed in the <a href="user_guide.html#intermediate_operation_exceptions">exceptions</a> section.</p> </dd> <dt class="hdlist1">max min</dt> <dd> <p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#max-java.util.Comparator-">max</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#min-java.util.Comparator-">min</a> methods find the respective min or max value on each node then a final reduction is performed locally to ensure only the min or max across all nodes is returned.</p> </dd> <dt class="hdlist1">reduce</dt> <dd> <p>The various reduce methods <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#reduce-java.util.function.BinaryOperator-">1</a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#reduce-T-java.util.function.BinaryOperator-">2</a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#reduce-U-java.util.function.BiFunction-java.util.function.BinaryOperator-">3</a> will end up serializing the result as much as the accumulator can do. Then it will accumulate the local and remote results together locally, before combining if you have provided that. Note this means a value coming from the combiner doesn&#8217;t have to be Serializable.</p> </dd> </dl> </div> </div> <div class="sect2"> <h3 id="key_based_rehash_aware_operators"><a class="anchor" href="#key_based_rehash_aware_operators"></a>4.11. Key based rehash aware operators</h3> <div class="paragraph"> <p>The <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/CacheStream.html#iterator--">iterator</a>, <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/CacheStream.html#spliterator--">spliterator</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/CacheStream.html#forEach-java.util.function.Consumer-">forEach</a> are unlike the other terminal operators in that the rehash awareness has to keep track of what keys per segment have been processed instead of just segments. This is to guarantee an exactly once (iterator &amp; spliterator) or at least once behavior (forEach) even under cluster membership changes.</p> </div> <div class="paragraph"> <p>The <code>iterator</code> and <code>spliterator</code> operators when invoked on a remote node will return back batches of entries, where the next batch is only sent back after the last has been fully consumed. This batching is done to limit how many entries are in memory at a given time. The user node will hold onto which keys it has processed and when a given segment is completed it will release those keys from memory. This is why sequential processing is preferred for the iterator method, so only a subset of segment keys are held in memory at once, instead of from all nodes.</p> </div> <div class="paragraph"> <p>The <code>forEach()</code> method also returns batches, but it returns a batch of keys after it has finished processing at least a batch worth of keys. This way the originating node can know what keys have been processed already to reduce chances of processing the same entry again. Unfortunately this means it is possible to have an at least once behavior when a node goes down unexpectedly. In this case that node could have been processing a batch and not yet completed one and those entries that were processed but not in a completed batch will be ran again when the rehash failure operation occurs. Note that adding a node will not cause this issue as the rehash failover doesn&#8217;t occur until all responses are received.</p> </div> <div class="paragraph"> <p>These operations batch sizes are both controlled by the same value which can be configured by invoking <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/CacheStream.html#distributedBatchSize-int-">distributedBatchSize</a> method on the <code>CacheStream</code>. This value will default to the <code>chunkSize</code> configured in state transfer. Unfortunately this value is a tradeoff with memory usage vs performance vs at least once and your mileage may vary.</p> </div> <div class="paragraph"> <p><strong>Using <code>iterator</code> with replicated and distributed caches</strong></p> </div> <div class="paragraph"> <p>When a node is the primary or backup owner of all requested segments for a distributed stream, Infinispan performs the <code>iterator</code> or <code>spliterator</code> terminal operations locally, which optimizes performance as remote iterations are more resource intensive.</p> </div> <div class="paragraph"> <p>This optimization applies to both replicated and distributed caches. However, Infinispan performs iterations remotely when using cache stores that are both <code>shared</code> and have <code>write-behind</code> enabled. In this case performing the iterations remotely ensures consistency.</p> </div> </div> <div class="sect2"> <h3 id="intermediate_operation_exceptions"><a class="anchor" href="#intermediate_operation_exceptions"></a>4.12. Intermediate operation exceptions</h3> <div class="paragraph"> <p>There are some intermediate operations that have special exceptions, these are <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#skip-long-">skip</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#peek-java.util.function.Consumer-">peek</a>, sorted <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#sorted-java.util.Comparator-">1</a> <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#sorted--">2</a>. &amp; <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#distinct--">distinct</a>. All of these methods have some sort of artificial iterator implanted in the stream processing to guarantee correctness, they are documented as below. Note this means these operations may cause possibly severe performance degradation.</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">Skip</dt> <dd> <p>An artificial iterator is implanted up to the intermediate skip operation. Then results are brought locally so it can skip the appropriate amount of elements.</p> </dd> <dt class="hdlist1">Sorted</dt> <dd> <p>WARNING: This operation requires having all entries in memory on the local node. An artificial iterator is implanted up to the intermediate sorted operation. All results are sorted locally. There are possible plans to have a distributed sort which returns batches of elements, but this is not yet implemented.</p> </dd> <dt class="hdlist1">Distinct</dt> <dd> <p>WARNING: This operation requires having all or nearly all entries in memory on the local node. Distinct is performed on each remote node and then an artificial iterator returns those distinct values. Then finally all of those results have a distinct operation performed upon them.</p> </dd> </dl> </div> <div class="paragraph"> <p>The rest of the intermediate operations are fully distributed as one would expect.</p> </div> </div> <div class="sect2"> <h3 id="examples"><a class="anchor" href="#examples"></a>4.13. Examples</h3> <div class="paragraph"> <p><strong>Word Count</strong></p> </div> <div class="paragraph"> <p>Word count is a classic, if overused, example of map/reduce paradigm. Assume we have a mapping of key &#8594; sentence stored on Infinispan nodes. Key is a String, each sentence is also a String, and we have to count occurrence of all words in all sentences available. The implementation of such a distributed task could be defined as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordCountExample</span> {

   <span class="comment">/**
    * In this example replace c1 and c2 with
    * real Cache references
    *
    * @param args
    */</span>
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; c1 = ...;
      Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; c2 = ...;

      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world here I am</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan rules the world</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JUDCon is in Boston</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss World is in Boston as well</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">12</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss Application Server</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">15</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">14</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan community</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">15</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world</span><span class="delimiter">&quot;</span></span>);

      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">111</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan open source</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">112</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Boston is close to Toronto</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">113</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Toronto is a capital of Ontario</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">114</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JUDCon is cool</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">211</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss World is awesome</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">212</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss rules</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">213</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss division of RedHat </span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">214</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RedHat community</span><span class="delimiter">&quot;</span></span>);

      <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt; wordCountMap = c1.entrySet().parallelStream()
         .map(e -&gt; e.getValue().split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s</span><span class="delimiter">&quot;</span></span>))
         .flatMap(<span class="predefined-type">Arrays</span>::stream)
         .collect(() -&gt; Collectors.groupingBy(Function.identity(), Collectors.counting()));
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>In this case it is pretty simple to do the word count from the previous example.</p> </div> <div class="paragraph"> <p>However what if we want to find the most frequent word in the example? If you take a second to think about this case you will realize you need to have all words counted and available locally first. Thus we actually have a few options.</p> </div> <div class="paragraph"> <p>We could use a finisher on the collector, which is invoked on the user thread after all the results have been collected. Some redundant lines have been removed from the previous example.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordCountExample</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      <span class="comment">// Lines removed</span>

      <span class="predefined-type">String</span> mostFrequentWord = c1.entrySet().parallelStream()
         .map(e -&gt; e.getValue().split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s</span><span class="delimiter">&quot;</span></span>))
         .flatMap(<span class="predefined-type">Arrays</span>::stream)
         .collect(() -&gt; Collectors.collectingAndThen(
            Collectors.groupingBy(Function.identity(), Collectors.counting()),
               wordCountMap -&gt; {
                  <span class="predefined-type">String</span> mostFrequent = <span class="predefined-constant">null</span>;
                  <span class="type">long</span> maxCount = <span class="integer">0</span>;
                     <span class="keyword">for</span> (<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt; e : wordCountMap.entrySet()) {
                        <span class="type">int</span> count = e.getValue().intValue();
                        <span class="keyword">if</span> (count &gt; maxCount) {
                           maxCount = count;
                           mostFrequent = e.getKey();
                        }
                     }
                     <span class="keyword">return</span> mostFrequent;
               }));

}</code></pre> </div> </div> <div class="paragraph"> <p>Unfortunately the last step is only going to be ran in a single thread, which if we have a lot of words could be quite slow. Maybe there is another way to parallelize this with Streams.</p> </div> <div class="paragraph"> <p>We mentioned before we are in the local node after processing, so we could actually use a stream on the map results. We can therefore use a parallel stream on the results.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordFrequencyExample</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      <span class="comment">// Lines removed</span>

      <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt; wordCount = c1.entrySet().parallelStream()
              .map(e -&gt; e.getValue().split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s</span><span class="delimiter">&quot;</span></span>))
              .flatMap(<span class="predefined-type">Arrays</span>::stream)
              .collect(() -&gt; Collectors.groupingBy(Function.identity(), Collectors.counting()));
      Optional&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt;&gt; mostFrequent = wordCount.entrySet().parallelStream().reduce(
              (e1, e2) -&gt; e1.getValue() &gt; e2.getValue() ? e1 : e2);</code></pre> </div> </div> <div class="paragraph"> <p>This way you can still utilize all of the cores locally when calculating the most frequent element.</p> </div> <div class="paragraph"> <p><strong>Remove specific entries</strong></p> </div> <div class="paragraph"> <p>Distributed streams can also be used as a way to modify data where it lives. For example you may want to remove all entries in your cache that contain a specific word.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">RemoveBadWords</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      <span class="comment">// Lines removed</span>
      <span class="predefined-type">String</span> word = ..

      c1.entrySet().parallelStream()
         .filter(e -&gt; e.getValue().contains(word))
         .forEach((c, e) -&gt; c.remove(e.getKey());</code></pre> </div> </div> <div class="paragraph"> <p>If we carefully note what is serialized and what is not, we notice that only the word along with the operations are serialized across to other nods as it is captured by the lambda. However the real saving piece is that the cache operation is performed on the primary owner thus reducing the amount of network traffic required to remove these values from the cache. The cache is not captured by the lambda as we provide a special BiConsumer method override that when invoked on each node passes the cache to the BiConsumer</p> </div> <div class="paragraph"> <p>One thing to keep in mind using the <code>forEach</code> command in this manner is that the underlying stream obtains no locks. The cache remove operation will still obtain locks naturally, but the value could have changed from what the stream saw. That means that the entry could have been changed after the stream read it but the remove actually removed it.</p> </div> <div class="paragraph"> <p>We have specifically added a new variant which is called <code>LockedStream</code>.</p> </div> <div class="paragraph"> <p><strong>Plenty of other examples</strong></p> </div> <div class="paragraph"> <p>The <code>Streams</code> API is a JRE tool and there are lots of examples for using it. Just remember that your operations need to be Serializable in some way.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="locked_streams"><a class="anchor" href="#locked_streams"></a>5. Locked Streams</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="locked_streams_2"><a class="anchor" href="#locked_streams_2"></a>5.1. Locked Streams</h3> <div class="paragraph"> <p>TODO: need to detail</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="cloud_services"><a class="anchor" href="#cloud_services"></a>6. Running on Cloud Services</h2> <div class="sectionbody"> <div class="paragraph"> <p>In order to turn on Cloud support for Infinispan library mode, one needs to add a specific dependency according to the cloud provider in use.</p> </div> <div class="sect2"> <h3 id="generic_discovery_protocols"><a class="anchor" href="#generic_discovery_protocols"></a>6.1. Generic Discovery protocols</h3> <div class="paragraph"> <p>The main difference between running Infinispan in a private environment and a cloud provider is that in the latter node discovery becomes a bit trickier because things like multicast don&#8217;t work. To circumvent this you can use alternate JGroups PING protocols. Before delving into the cloud-specific, lets look at some generic discovery protocols.</p> </div> <div class="sect3"> <h4 id="tcpping"><a class="anchor" href="#tcpping"></a>6.1.1. TCPPing</h4> <div class="paragraph"> <p>The TCPPing approach contains a static list of the IP address of each member of the cluster in the JGroups configuration file. While this works it doesn&#8217;t really help when cluster nodes are dynamically added to the cluster.</p> </div> <div class="listingblock"> <div class="title">Sample TCPPing configuration</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
 <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;TCPPING</span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3000</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">initial_hosts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jgroups.tcpping.initial_hosts:localhost[7800],localhost[7801]}</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">port_range</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">num_initial_members</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
...
...
<span class="tag">&lt;/config&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>See <a href="http://community.jboss.org/wiki/JGroupsTCPPING">JGroups TCPPING</a> for more information about TCPPing.</p> </div> </div> <div class="sect3"> <h4 id="gossiprouter"><a class="anchor" href="#gossiprouter"></a>6.1.2. GossipRouter</h4> <div class="paragraph"> <p>Another approach is to have a central server (Gossip, which each node will be configured to contact. This central server will tell each node in the cluster about each other node.</p> </div> <div class="paragraph"> <p>The address (ip:port) that the Gossip router is listening on can be injected into the JGroups configuration used by Infinispan. To do this pass the gossip routers address as a system property to the JVM e.g. <code>-DGossipRouterAddress="10.10.2.4[12001]"</code> and reference this property in the JGroups configuration that Infinispan is using e.g.</p> </div> <div class="listingblock"> <div class="title">Sample TCPGOSSIP configuration</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
 <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;TCPGOSSIP</span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial_hosts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${GossipRouterAddress}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">num_initial_members</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
...
...
<span class="tag">&lt;/config&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>More on Gossip Router @ <a href="http://community.jboss.org/docs/DOC-10890">http://www.jboss.org/community/wiki/JGroupsGossipRouter</a></p> </div> </div> </div> <div class="sect2"> <h3 id="amazon_web_services"><a class="anchor" href="#amazon_web_services"></a>6.2. Amazon Web Services</h3> <div class="paragraph"> <p>When running on Amazon Web Service (AWS) platform and similar cloud based environment you can use the S3_PING protocol for discovery.</p> </div> <div class="sect3"> <h4 id="native_s3_ping"><a class="anchor" href="#native_s3_ping"></a>6.2.1. NATIVE_S3_PING</h4> <div class="paragraph"> <p>You can configure your JGroups instances to use a shared storage to exchange the details of the cluster nodes. NATIVE_S3_PING allows Amazon S3 to be used as the shared storage. Be sure that you have signed up for Amazon S3 as well as EC2 to use this method.</p> </div> <div class="listingblock"> <div class="title">Sample NATIVE_S3_PING configuration</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
    <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;org.jgroups.aws.s3.NATIVE_S3_PING</span>
            <span class="attribute-name">region_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your region (e.g. eu-west-1)</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">bucket_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your bucket name</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">bucket_prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with a prefix to use for entries in the bucket (optional)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/config&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="title">NATIVE_S3_PING support in library mode</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jgroups.aws.s3<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>native-s3-ping<span class="tag">&lt;/artifactId&gt;</span>
  <span class="comment">&lt;!-- Replace ${version.jgroups.native_s3_ping} with the
  version of the native-s3-ping module you want to use. --&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.jgroups.native_s3_ping}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="jdbc_ping"><a class="anchor" href="#jdbc_ping"></a>6.2.2. JDBC_PING</h4> <div class="paragraph"> <p>A similar approach to S3_PING, but using a JDBC connection to a shared database. On EC2 that is quite easy using Amazon RDS. See the <a href="http://community.jboss.org/wiki/JDBCPING">JDBC_PING Wiki page</a> for details.</p> </div> </div> </div> <div class="sect2"> <h3 id="microsoft_azure"><a class="anchor" href="#microsoft_azure"></a>6.3. Microsoft Azure</h3> <div class="paragraph"> <p>Infinispan can be used on the Azure platform. Aside from using TCP_PING or GossipRouter, there is an Azure-specific discovery protocol:</p> </div> <div class="sect3"> <h4 id="azure_ping"><a class="anchor" href="#azure_ping"></a>6.3.1. AZURE_PING</h4> <div class="paragraph"> <p>AZURE_PING uses a shared Azure Blob Storage to store discovery information. Configuration is as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;azure.AZURE_PING</span>
        <span class="attribute-name">storage_account_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your account name</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">storage_access_key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your access key</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your container name</span><span class="delimiter">&quot;</span></span>
<span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="title">AZURE_PING support in library mode</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jgroups.azure<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jgroups-azure<span class="tag">&lt;/artifactId&gt;</span>
  <span class="comment">&lt;!-- Replace ${version.jgroups.azure} with the
  version of the jgroups-azure module you want to use. --&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.jgroups.azure}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="google_compute_engine"><a class="anchor" href="#google_compute_engine"></a>6.4. Google Compute Engine</h3> <div class="paragraph"> <p>Infinispan can be used on the Google Compute Engine (GCE) platform. Aside from using TCP_PING or GossipRouter, there is a GCE-specific discovery protocol:</p> </div> <div class="sect3"> <h4 id="google2_ping"><a class="anchor" href="#google2_ping"></a>6.4.1. GOOGLE2_PING</h4> <div class="paragraph"> <p>GOOGLE2_PING uses Google Cloud Storage (GCS) to store information about the cluster members.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;org.jgroups.protocols.google.GOOGLE_PING2</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jgroups.google.bucket_name}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="title">GOOGLE2_PING support in library mode</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jgroups.google<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jgroups-google<span class="tag">&lt;/artifactId&gt;</span>
  <span class="comment">&lt;!-- Replace ${version.jgroups.google} with the
  version of the jgroups-goole module you want to use. --&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.jgroups.google}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="cloud_services_k8s"><a class="anchor" href="#cloud_services_k8s"></a>6.5. Kubernetes</h3> <div class="paragraph"> <p>Infinispan in Kubernetes environments, such as OKD or OpenShift, can use <a href="#cloud_services_kube_ping">Kube_PING</a> or [DNS_PING] for cluster discovery.</p> </div> <div class="sect3"> <h4 id="cloud_services_kube_ping"><a class="anchor" href="#cloud_services_kube_ping"></a>6.5.1. Kube_PING</h4> <div class="paragraph"> <p>The JGroups <a href="http://www.jgroups.org/manual4/index.html#_kube_ping">Kube_PING</a> protocol uses the following configuration:</p> </div> <div class="listingblock"> <div class="title">Example KUBE_PING configuration</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
 <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_addr</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${match-interface:eth.*}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;kubernetes.KUBE_PING</span> <span class="tag">/&gt;</span>
...
...
<span class="tag">&lt;/config&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The most important thing is to bind JGroups to <code>eth0</code> interface, which is <a href="https://docs.docker.com/engine/userguide/networking/dockernetworks/">used by Docker containers for network communication</a>.</p> </div> <div class="paragraph"> <p>KUBE_PING protocol is configured by environmental variables (which should be available inside a container). The most important thing is to set <code>KUBERNETES_NAMESPACE</code> to proper namespace. It might be either hardcoded or populated via <a href="https://github.com/kubernetes/kubernetes/tree/release-1.0/docs/user-guide/downward-api">Kubernetes' Downward API</a>.</p> </div> <div class="paragraph"> <p>Since KUBE_PING uses Kubernetes API for obtaining available Pods, OpenShift requires adding additional privileges. Assuming that <code>oc project -q</code> returns current namespace and <code>default</code> is the service account name, one needs to run:</p> </div> <div class="listingblock"> <div class="title">Adding additional OpenShift privileges</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="bash">$ oc policy add-role-to-user view system:serviceaccount:$(oc project -q):default -n $(oc project -q)</code></pre> </div> </div> <div class="paragraph"> <p>After performing all above steps, the clustering should be enabled and all Pods should automatically form a cluster within a single namespace.</p> </div> </div> <div class="sect3"> <h4 id="cloud_services_dns_ping"><a class="anchor" href="#cloud_services_dns_ping"></a>6.5.2. DNS_PING</h4> <div class="paragraph"> <p>The JGroups <a href="http://www.jgroups.org/manual4/index.html#_dns_ping">DNS_PING</a> protocol uses the following configuration:</p> </div> <div class="listingblock"> <div class="title">Example DNS_PING configuration</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dns-ping</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
...
    <span class="tag">&lt;dns.DNS_PING</span>
      <span class="attribute-name">dns_query</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myservice.myproject.svc.cluster.local</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
...
<span class="tag">&lt;/stack&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>DNS_PING runs the specified query against the DNS server to get the list of cluster members.</p> </div> <div class="paragraph"> <p>For information about creating DNS entries for nodes in a cluster, see <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/">DNS for Services and Pods</a>.</p> </div> </div> <div class="sect3"> <h4 id="using_kubernetes_and_openshift_rolling_updates"><a class="anchor" href="#using_kubernetes_and_openshift_rolling_updates"></a>6.5.3. Using Kubernetes and OpenShift Rolling Updates</h4> <div class="paragraph"> <p>Since Pods in Kubernetes and OpenShift are immutable, the only way to alter the configuration is to roll out a new deployment. There are several different strategies to do that but we suggest using <a href="https://docs.openshift.org/latest/dev_guide/deployments/deployment_strategies.html#when-to-use-a-rolling-deployment">Rolling Updates</a>.</p> </div> <div class="paragraph"> <p>An example Deployment Configuration (Kubernetes uses very similar concept called <code>Deployment</code>) looks like the following:</p> </div> <div class="listingblock"> <div class="title">DeploymentConfiguration for Rolling Updates</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="yaml">- <span class="string"><span class="content">apiVersion: v1</span></span>
  <span class="key">kind</span>: <span class="string"><span class="content">DeploymentConfig</span></span>
  <span class="key">metadata</span>:
    <span class="key">name</span>: <span class="string"><span class="content">infinispan-cluster</span></span>
  <span class="key">spec</span>:
    <span class="key">replicas</span>: <span class="string"><span class="content">3</span></span>
    <span class="key">strategy</span>:
      <span class="key">type</span>: <span class="string"><span class="content">Rolling</span></span>
      <span class="key">rollingParams</span>:
        <span class="key">updatePeriodSeconds</span>: <span class="string"><span class="content">10</span></span>
        <span class="key">intervalSeconds</span>: <span class="string"><span class="content">20</span></span>
        <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">600</span></span>
        <span class="key">maxUnavailable</span>: <span class="string"><span class="content">1</span></span>
        <span class="key">maxSurge</span>: <span class="string"><span class="content">1</span></span>
    <span class="key">template</span>:
      <span class="key">spec</span>:
        <span class="key">containers</span>:
        - <span class="string"><span class="content">args:</span></span>
          - <span class="string"><span class="content">-Djboss.default.jgroups.stack=kubernetes</span></span>
          <span class="key">image</span>: <span class="string"><span class="content">jboss/infinispan-server:latest</span></span>
          <span class="key">name</span>: <span class="string"><span class="content">infinispan-server</span></span>
          <span class="key">ports</span>:
          - <span class="string"><span class="content">containerPort: 8181</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 9990</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 11211</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 11222</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 57600</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 7600</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          - <span class="string"><span class="content">containerPort: 8080</span></span>
            <span class="key">protocol</span>: <span class="string"><span class="content">TCP</span></span>
          <span class="key">env</span>:
          - <span class="string"><span class="content">name: KUBERNETES_NAMESPACE</span></span>
            <span class="key">valueFrom</span>: <span class="string"><span class="content">{fieldRef: {apiVersion: v1, fieldPath: metadata.namespace}}</span></span>
          <span class="key">terminationMessagePath</span>: <span class="string"><span class="content">/dev/termination-log</span></span>
          <span class="key">terminationGracePeriodSeconds</span>: <span class="string"><span class="content">90</span></span>
          <span class="key">livenessProbe</span>:
            <span class="key">exec</span>:
              <span class="key">command</span>:
              - <span class="string"><span class="content">/usr/local/bin/is_running.sh</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">10</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">80</span></span>
            <span class="key">periodSeconds</span>: <span class="string"><span class="content">60</span></span>
            <span class="key">successThreshold</span>: <span class="string"><span class="content">1</span></span>
            <span class="key">failureThreshold</span>: <span class="string"><span class="content">5</span></span>
          <span class="key">readinessProbe</span>:
             <span class="key">exec</span>:
                <span class="key">command</span>:
                - <span class="string"><span class="content">/usr/local/bin/is_healthy.sh</span></span>
             <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">10</span></span>
             <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">40</span></span>
             <span class="key">periodSeconds</span>: <span class="string"><span class="content">30</span></span>
             <span class="key">successThreshold</span>: <span class="string"><span class="content">2</span></span>
             <span class="key">failureThreshold</span>: <span class="string"><span class="content">5</span></span></code></pre> </div> </div> <div class="paragraph"> <p>It is also highly recommended to adjust the JGroups stack to discover new nodes (or leaves) more quickly. One should at least adjust the value of <code>FD_ALL</code> timeout and adjust it to the longest GC Pause.</p> </div> <div class="ulist"> <div class="title">Other hints for tuning configuration parameters are:</div> <ul> <li> <p>OpenShift should replace running nodes one by one. This can be achieved by adjusting <code>rollingParams</code> (<code>maxUnavailable: 1</code> and <code>maxSurge: 1</code>).</p> </li> <li> <p>Depending on the cluster size, one needs to adjust <code>updatePeriodSeconds</code> and <code>intervalSeconds</code>. The bigger cluster size is, the bigger those values should be used.</p> </li> <li> <p>When using Initial State Transfer, the <code>initialDelaySeconds</code> value for both probes should be set to higher value.</p> </li> <li> <p>During Initial State Transfer nodes might not respond to probes. The best results are achieved with higher values of <code>failureThreshold</code> and <code>successThreshold</code> values.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="rolling_upgrades_with_kubernetes_and_openshift"><a class="anchor" href="#rolling_upgrades_with_kubernetes_and_openshift"></a>6.5.4. Rolling upgrades with Kubernetes and OpenShift</h4> <div class="paragraph"> <p>Even though Rolling Upgrades and Rolling Update may sound similarly, they mean different things. The <a href="https://docs.openshift.org/latest/dev_guide/deployments/deployment_strategies.html#rolling-strategy">Rolling Update</a> is a process of replacing old Pods with new ones. In other words it is a process of rolling out new version of an application. A typical example is a configuration change. Since Pods are immutable, Kubernetes/OpenShift needs to replace them one by one in order to use the updated configuration bits. On the other hand, Rolling Upgrade is a process of migrating data from one Infinispan cluster to another one. A typical example is migrating from one version to another.</p> </div> <div class="paragraph"> <p>For both Kubernetes and OpenShift, the Rolling Upgrade procedure is almost the same. It is based on a standard Rolling Upgrade procedure with small changes.</p> </div> <div class="ulist"> <div class="title">Key differences when upgrading using OpenShift/Kubernetes are:</div> <ul> <li> <p>Depending on configuration, it is a good practice to use <a href="https://docs.openshift.org/latest/architecture/core_concepts/routes.html">OpenShift Routes</a> or <a href="http://kubernetes.io/docs/user-guide/ingress">Kubernetes Ingress API</a> to expose services to the clients. During the upgrade the Route (or Ingress) used by the clients can be altered to point to the new cluster.</p> </li> <li> <p>Invoking CLI commands can be done by using Kubernetes (<code>kubectl exec</code>) or OpenShift clients (<code>oc exec</code>). Here is an example: <code>oc exec &lt;POD_NAME&gt;&#8201;&#8212;&#8201;'/opt/jboss/infinispan-server/bin/ispn-cli.sh' '-c' '--controller=$(hostname -i):9990' '/subsystem=datagrid-infinispan/cache-container=clustered/distributed-cache=default:disconnect-source(migrator-name=hotrod)'</code></p> </li> </ul> </div> <div class="ulist"> <div class="title">Key differences when upgrading using the library mode:</div> <ul> <li> <p>Client application needs to expose JMX. It usually depends on application and environment type but the easiest way to do it is to add the following switches into the Java boostrap script <code>-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=&lt;PORT&gt;</code>.</p> </li> <li> <p>Connecting to the JMX can be done by forwarding ports. With OpenShift this might be achieved by using <code>oc port-forward</code> command whereas in Kubernetes by <code>kubectl port-forward</code>.</p> </li> </ul> </div> <div class="paragraph"> <p>The last step in the Rolling Upgrade (removing a Remote Cache Store) needs to be performed differently. We need to use <a href="http://kubernetes.io/docs/user-guide/rolling-updates/">Kubernetes/OpenShift Rolling update</a> command and replace Pods configuration with the one which does not contain Remote Cache Store.</p> </div> <div class="paragraph"> <p>A detailed instruction might be found in <a href="https://issues.jboss.org/browse/ISPN-6673">ISPN-6673</a> ticket.</p> </div> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2019-09-15 07:35:22 UTC </div> </div> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script> <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script> </body> </html>