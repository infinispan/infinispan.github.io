<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="generator" content="Asciidoctor 1.5.8"> <title>Running Infinispan 10.0 Servers</title> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"> <style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> <style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style> <link rel="canonical" href="http://infinispan.org/docs/stable/user_guide/user_guide.html"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css"> <link rel="stylesheet" href="../../css/css.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script> <script src="../../js/js.js"></script> </head> <body class="book toc2 toc-left"> <div id="header"> <h1>Running Infinispan 10.0 Servers</h1> <div id="toc" class="toc2"> <div id="toctitle">Table of Contents</div> <ul class="sectlevel1"> <li><a href="#about_the_infinispan_server">1. About the Infinispan Server</a> <ul class="sectlevel2"> <li><a href="#getting_started">1.1. Getting Started</a></li> </ul> </li> <li><a href="#operating_modes">2. Operating modes</a> <ul class="sectlevel2"> <li><a href="#standalone_mode">2.1. Standalone mode</a></li> <li><a href="#domain_mode">2.2. Domain mode</a> <ul class="sectlevel3"> <li><a href="#host">2.2.1. Host</a> <ul class="sectlevel4"> <li><a href="#host_controller">Host Controller</a></li> </ul> </li> <li><a href="#domain_controller">2.2.2. Domain Controller</a></li> <li><a href="#server_group">2.2.3. Server Group</a></li> <li><a href="#server">2.2.4. Server</a></li> </ul> </li> <li><a href="#example_configurations">2.3. Example configurations</a></li> </ul> </li> <li><a href="#server_config">3. Configuration</a> <ul class="sectlevel2"> <li><a href="#server_config_jgroups">3.1. JGroups subsystem configuration</a> <ul class="sectlevel3"> <li><a href="#cluster_authentication_and_authorization">3.1.1. Cluster authentication and authorization</a></li> </ul> </li> <li><a href="#infinispan_subsystem_configuration">3.2. Infinispan subsystem configuration</a> <ul class="sectlevel3"> <li><a href="#containers">3.2.1. Containers</a></li> <li><a href="#caches">3.2.2. Caches</a></li> <li><a href="#expiration">3.2.3. Expiration</a></li> <li><a href="#eviction">3.2.4. Eviction</a></li> <li><a href="#locking">3.2.5. Locking</a></li> <li><a href="#transactional_operations_with_hot_rod">3.2.6. Transactional Operations with Hot Rod</a></li> <li><a href="#loaders_and_stores">3.2.7. Loaders and Stores</a></li> <li><a href="#state_transfer">3.2.8. State Transfer</a></li> </ul> </li> <li><a href="#endpoint_subsystem_configuration">3.3. Endpoint subsystem configuration</a> <ul class="sectlevel3"> <li><a href="#hot_rod">3.3.1. Hot Rod</a></li> <li><a href="#memcached">3.3.2. Memcached</a></li> <li><a href="#websocket">3.3.3. WebSocket</a></li> <li><a href="#rest">3.3.4. REST</a></li> <li><a href="#common_protocol_connector_settings">3.3.5. Common Protocol Connector Settings</a></li> <li><a href="#protocol_interoperability">3.3.6. Protocol Interoperability</a></li> <li><a href="#custom_marshaller_bridges">3.3.7. Custom Marshaller Bridges</a> <ul class="sectlevel4"> <li><a href="#protostuff">Protostuff</a></li> <li><a href="#kryo">Kryo</a></li> <li><a href="#storing_deserialized_objects">Storing deserialized objects</a> <ul class="sectlevel5"> <li><a href="#registering_custom_schemasserializers">Registering Custom Schemas/Serializers</a></li> </ul> </li> </ul> </li> </ul> </li> </ul> </li> <li><a href="#rolling_upgrades">4. Performing Rolling Upgrades</a> <ul class="sectlevel2"> <li><a href="#setting_up_a_target_cluster">4.1. Setting Up a Target Cluster</a></li> <li><a href="#synchronizing_data_from_the_source_cluster">4.2. Synchronizing Data from the Source Cluster</a></li> </ul> </li> <li><a href="#client_server">5. Client/Server</a> <ul class="sectlevel2"> <li><a href="#why_clientserver">5.1. Why Client/Server?</a></li> <li><a href="#why_use_embedded_mode">5.2. Why use embedded mode?</a></li> <li><a href="#server_modules">5.3. Server Modules</a></li> <li><a href="#which_protocol_should_i_use">5.4. Which protocol should I use?</a></li> </ul> </li> <li><a href="#hot_rod_server_usage">6. Using Hot Rod Server</a> <ul class="sectlevel2"> <li><a href="#hotrod_java_client">6.1. Java Hot Rod client</a> <ul class="sectlevel3"> <li><a href="#configuration">6.1.1. Configuration</a></li> <li><a href="#authentication">6.1.2. Authentication</a> <ul class="sectlevel4"> <li><a href="#digest_md5">DIGEST-MD5</a></li> <li><a href="#plain">PLAIN</a></li> <li><a href="#external">EXTERNAL</a></li> <li><a href="#gssapi_kerberos">GSSAPI (Kerberos)</a></li> <li><a href="#custom_callbackhandlers">Custom CallbackHandlers</a></li> </ul> </li> <li><a href="#hr_encryption">6.1.3. Encryption</a> <ul class="sectlevel4"> <li><a href="#sni">SNI</a></li> <li><a href="#client_certificates">Client certificates</a></li> </ul> </li> <li><a href="#hr_basic_api">6.1.4. Basic API</a></li> <li><a href="#remotecache_keyset_entryset_values">6.1.5. RemoteCache(.keySet|.entrySet|.values)</a></li> <li><a href="#remote_iterator">6.1.6. Remote Iterator</a></li> <li><a href="#hr_versioned_api">6.1.7. Versioned API</a></li> <li><a href="#streaming_api">6.1.8. Streaming API</a></li> <li><a href="#creating_event_listeners">6.1.9. Creating Event Listeners</a></li> <li><a href="#removing_event_listeners">6.1.10. Removing Event Listeners</a></li> <li><a href="#filtering_events">6.1.11. Filtering Events</a> <ul class="sectlevel4"> <li><a href="#skipping_notifications">Skipping Notifications</a></li> </ul> </li> <li><a href="#customizing_events">6.1.12. Customizing Events</a></li> <li><a href="#filter_and_custom_events">6.1.13. Filter and Custom Events</a></li> <li><a href="#event_marshalling">6.1.14. Event Marshalling</a> <ul class="sectlevel4"> <li><a href="#protostream_deployment">Deploying Protostream Marshallers</a></li> </ul> </li> <li><a href="#listener_state_handling">6.1.15. Listener State Handling</a></li> <li><a href="#listener_failure_handling">6.1.16. Listener Failure Handling</a></li> <li><a href="#near_caching">6.1.17. Near Caching</a></li> <li><a href="#unsupported_methods">6.1.18. Unsupported methods</a></li> <li><a href="#return_values">6.1.19. Return values</a></li> </ul> </li> </ul> </li> <li><a href="#hr_transactions">7. Hot Rod Transactions</a> <ul class="sectlevel2"> <li><a href="#hr_transactions_config_server">7.1. Configuring the Server</a></li> <li><a href="#hr_transactions_config_client">7.2. Configuring Hot Rod Clients</a> <ul class="sectlevel3"> <li><a href="#hr_transactions_tmlookup">7.2.1. TransactionManagerLookup Interface</a></li> <li><a href="#hr_transactions_modes">7.2.2. Transaction Modes</a></li> </ul> </li> <li><a href="#hr_transactions_override_rcm">7.3. Overriding Configuration for Cache Instances</a></li> <li><a href="#hr_transactions_force_return_value">7.4. Detecting Conflicts with Transactions</a></li> <li><a href="#hr_transactions_ex_use_config">7.5. Using the Configured Transaction Manager and Transaction Mode</a></li> <li><a href="#hr_transactions_ex_override_tm">7.6. Overriding the Transaction Manager</a></li> <li><a href="#hr_transactions_ex_override_mode">7.7. Overriding the Transaction Mode</a> <ul class="sectlevel3"> <li><a href="#client_intelligence">7.7.1. Client Intelligence</a> <ul class="sectlevel4"> <li><a href="#distribution_aware_client">Distribution-aware client</a></li> </ul> </li> <li><a href="#request_balancing">7.7.2. Request Balancing</a></li> <li><a href="#persistent_connections">7.7.3. Persistent connections</a></li> <li><a href="#hot_rod_marshalling_data">7.7.4. Marshalling data</a></li> <li><a href="#reading_data_in_different_data_formats">7.7.5. Reading data in different data formats</a> <ul class="sectlevel4"> <li><a href="#using_different_marshallers_for_key_and_values">Using different marshallers for Key and Values</a></li> <li><a href="#reading_data_in_different_formats">Reading data in different formats</a></li> </ul> </li> <li><a href="#statistics">7.7.6. Statistics</a></li> <li><a href="#multi_get_operations">7.7.7. Multi-Get Operations</a></li> <li><a href="#server_hotrod_failover">7.7.8. Failover capabilities</a></li> <li><a href="#site_cluster_failover">7.7.9. Site Cluster Failover</a></li> <li><a href="#manual_site_cluster_switch">7.7.10. Manual Site Cluster Switch</a></li> <li><a href="#hotrod_java_client_monitoring">7.7.11. Monitoring the Hot Rod client</a></li> <li><a href="#concurrent_updates">7.7.12. Concurrent Updates</a> <ul class="sectlevel4"> <li><a href="#data_consistency_problem">Data Consistency Problem</a></li> <li><a href="#embedded_mode_solution">Embedded-mode Solution</a></li> <li><a href="#client_server_solution">Client-Server Solution</a></li> </ul> </li> <li><a href="#javadocs">7.7.13. Javadocs</a></li> </ul> </li> </ul> </li> <li><a href="#rest_server">8. REST Server</a> <ul class="sectlevel2"> <li><a href="#rest_run_server">8.1. Running the REST server</a> <ul class="sectlevel3"> <li><a href="#rest_security">8.1.1. Security</a></li> </ul> </li> <li><a href="#rest_supported_protocols">8.2. Supported protocols</a></li> <li><a href="#rest_server_cors">8.3. CORS</a></li> <li><a href="#rest_server_data_format">8.4. Data formats</a> <ul class="sectlevel3"> <li><a href="#rest_server_data_format_config">8.4.1. Configuration</a></li> <li><a href="#rest_server_data_format_support">8.4.2. Supported formats</a></li> <li><a href="#rest_accept">8.4.3. Accept header</a></li> <li><a href="#rest_key_content_type">8.4.4. Key-Content-Type header</a></li> <li><a href="#jsonprotostream_conversion">8.4.5. JSON/Protostream conversion</a></li> </ul> </li> <li><a href="#rest_v1_api">8.5. REST V1 API</a> <ul class="sectlevel3"> <li><a href="#putting_data_in">8.5.1. Putting data in</a> <ul class="sectlevel4"> <li><a href="#rest_server_put_request"><code>PUT /{cacheName}/{cacheKey}</code></a></li> <li><a href="#rest_server_post_request"><code>POST /{cacheName}/{cacheKey}</code></a></li> </ul> </li> <li><a href="#rest_server_get_data">8.5.2. Getting data back out</a> <ul class="sectlevel4"> <li><a href="#rest_server_get_request"><code>GET /{cacheName}/{cacheKey}</code></a></li> <li><a href="#rest_server_head_request"><code>HEAD /{cacheName}/{cacheKey}</code></a></li> </ul> </li> <li><a href="#rest_server_list_keys">8.5.3. Listing keys</a> <ul class="sectlevel4"> <li><a href="#rest_server_list_get"><code>GET /{cacheName}</code></a></li> </ul> </li> <li><a href="#rest_server_remove_data">8.5.4. Removing data</a> <ul class="sectlevel4"> <li><a href="#rest_server_delete_keys"><code>DELETE /{cacheName}/{cacheKey}</code></a></li> <li><a href="#rest_server_delete_cache"><code>DELETE /{cacheName}</code></a></li> </ul> </li> <li><a href="#rest_server_query">8.5.5. Querying</a> <ul class="sectlevel4"> <li><a href="#rest_server_query_get"><code>GET /{cacheName}?action=search&amp;query={ickle query}</code></a></li> <li><a href="#rest_server_query_post"><code>POST /{cacheName}?action=search</code></a></li> </ul> </li> </ul> </li> <li><a href="#rest_v2_api">8.6. REST v2 API</a> <ul class="sectlevel3"> <li><a href="#rest_v2_cache_operations">8.6.1. Working with Caches</a> <ul class="sectlevel4"> <li><a href="#rest_v2_create_cache">Creating Caches</a> <ul class="sectlevel5"> <li><a href="#rest_v2_create_cache_template">Creating with Templates</a></li> </ul> </li> <li><a href="#rest_v2_cache_configuration">Retrieving Cache Configuration</a></li> <li><a href="#rest_v2_add_entries">Adding Entries</a></li> <li><a href="#rest_v2_replace_entries">Replacing Entries</a></li> <li><a href="#rest_v2_retrieve_cache">Retrieving Caches By Keys</a></li> <li><a href="#rest_v2_check_entries">Checking if Entries Exist</a></li> <li><a href="#rest_v2_delete_entries">Deleting Entries</a></li> <li><a href="#rest_v2_remove_cache">Removing Caches</a></li> <li><a href="#rest_v2_clear_cache">Clearing Caches</a></li> <li><a href="#rest_v2_cache_size">Getting the size of Caches</a></li> <li><a href="#rest_v2_query_cache">Querying Caches</a></li> </ul> </li> <li><a href="#rest_server_cluster">8.6.2. Monitoring Infinispan Clusters</a> <ul class="sectlevel4"> <li><a href="#rest_server_cluster_get">Retrieving Cluster Information</a></li> <li><a href="#rest_server_cluster_head">Check availability</a></li> </ul> </li> <li><a href="#rest_server_counters">8.6.3. Counter</a> <ul class="sectlevel4"> <li><a href="#rest_server_counters_create">Creating a Counter</a></li> <li><a href="#rest_server_counters_delete">Deleting a Counter</a></li> <li><a href="#rest_server_counters_config">Retrieving Counters Configuration</a></li> <li><a href="#rest_server_counters_add">Adding Values to Counters</a></li> <li><a href="#rest_server_counters_get">Getting a Counter Value</a></li> <li><a href="#rest_server_counters_reset">Reseting Counters</a></li> <li><a href="#rest_server_counters_inc_weak">Incrementing Counters</a></li> <li><a href="#rest_server_counters_add_weak">Adding a delta to Counters</a></li> <li><a href="#rest_server_counters_dec_strong">Decrementing Counters</a></li> <li><a href="#rest_server_counters_cmpset">compareAndSet Strong Counters</a></li> <li><a href="#rest_server_counters_cmpswp">compareAndSwap Strong Counter</a></li> </ul> </li> </ul> </li> <li><a href="#client_side_code">8.7. Client-Side Code</a> <ul class="sectlevel3"> <li><a href="#rest_server_client_ruby">8.7.1. Ruby example</a></li> <li><a href="#rest_server_client_python">8.7.2. Python 3 example</a></li> <li><a href="#rest_server_client_java">8.7.3. Java example</a></li> </ul> </li> </ul> </li> <li><a href="#memcached_server">9. Memcached Server</a> <ul class="sectlevel2"> <li><a href="#memcached_client_encoding">9.1. Client Encoding</a></li> <li><a href="#command_clarifications">9.2. Command Clarifications</a> <ul class="sectlevel3"> <li><a href="#flush_all">9.2.1. Flush All</a></li> </ul> </li> <li><a href="#unsupported_features">9.3. Unsupported Features</a> <ul class="sectlevel3"> <li><a href="#individual_stats">9.3.1. Individual Stats</a></li> <li><a href="#statistic_settings">9.3.2. Statistic Settings</a></li> <li><a href="#settings_with_arguments_parameter">9.3.3. Settings with Arguments Parameter</a></li> <li><a href="#delete_hold_time_parameter">9.3.4. Delete Hold Time Parameter</a></li> <li><a href="#verbosity_command">9.3.5. Verbosity Command</a></li> </ul> </li> <li><a href="#talking_to_infinispan_memcached_servers_from_non_java_clients">9.4. Talking To Infinispan Memcached Servers From Non-Java Clients</a> <ul class="sectlevel3"> <li><a href="#multi_clustered_server_tutorial">9.4.1. Multi Clustered Server Tutorial</a></li> </ul> </li> </ul> </li> <li><a href="#scripting">10. Scripting</a> <ul class="sectlevel2"> <li><a href="#installing_scripts">10.1. Installing scripts</a></li> <li><a href="#script_metadata">10.2. Script metadata</a> <ul class="sectlevel3"> <li><a href="#metadata_properties">10.2.1. Metadata properties</a></li> </ul> </li> <li><a href="#script_bindings">10.3. Script bindings</a></li> <li><a href="#script_parameters">10.4. Script parameters</a></li> <li><a href="#running_scripts_using_the_hot_rod_java_client">10.5. Running Scripts using the Hot Rod Java client</a></li> <li><a href="#distributed_execution">10.6. Distributed execution</a></li> </ul> </li> <li><a href="#server_tasks">11. Server Tasks</a> <ul class="sectlevel2"> <li><a href="#implementing_server_tasks">11.1. Implementing Server Tasks</a></li> </ul> </li> <li><a href="#health_monitoring">12. Health monitoring</a> <ul class="sectlevel2"> <li><a href="#accessing_health_api_using_jmx">12.1. Accessing Health API using JMX</a></li> <li><a href="#accessing_health_api_using_cli">12.2. Accessing Health API using CLI</a></li> <li><a href="#accessing_health_api_using_rest">12.3. Accessing Health API using REST</a></li> </ul> </li> <li><a href="#multi_tenancy">13. Multi-tenancy</a> <ul class="sectlevel2"> <li><a href="#using_rest_interface">13.1. Using REST interface</a></li> <li><a href="#using_hot_rod_client">13.2. Using Hot Rod client</a> <ul class="sectlevel3"> <li><a href="#multi_tenant_router">13.2.1. Multi-tenant router</a></li> </ul> </li> </ul> </li> <li><a href="#single_port">14. Single-Port</a> <ul class="sectlevel2"> <li><a href="#single_port_router">14.1. Single-Port router</a> <ul class="sectlevel3"> <li><a href="#testing_the_single_port_router">14.1.1. Testing the Single-Port router</a></li> </ul> </li> <li><a href="#hot_rod_2">14.2. Hot Rod</a> <ul class="sectlevel3"> <li><a href="#tlsalpn_protocol_selection">14.2.1. TLS/ALPN protocol selection</a></li> </ul> </li> </ul> </li> </ul> </div> </div> <div id="content"> <div class="sect1"> <h2 id="about_the_infinispan_server"><a class="anchor" href="#about_the_infinispan_server"></a>1. About the Infinispan Server</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan Server is a standalone server which exposes any number of caches to clients over a variety of protocols, including HotRod, Memcached and REST.</p> </div> <div class="paragraph"> <p>The server itself is built on top of the robust foundation provided by WildFly, therefore delegating services such as management, configuration, datasources, transactions, logging, security to the respective subsystems.</p> </div> <div class="paragraph"> <p>Because Infinispan Server is closely tied to the latest releases of Infinispan and JGroups, the subsystems which control these components are different, in that they introduce new features and change some existing ones (e.g. cross-site replication, etc).</p> </div> <div class="paragraph"> <p>For this reason, the configuration of these subsystems should use the Infinispan Server-specific schema, although for most use-cases the configuration is interchangeable. See the Configuration section for more information.</p> </div> <div class="sect2"> <h3 id="getting_started"><a class="anchor" href="#getting_started"></a>1.1. Getting Started</h3> <div class="paragraph"> <p>To get started using the server, download the Infinispan Server distribution, unpack it to a local directory and launch it using the bin/standalone.sh or bin/standalone.bat scripts depending on your platform. This will start a single-node server using the standalone/configuration/standalone.xml configuration file, with four endpoints, one for each of the supported protocols. These endpoints allow access to all of the caches configured in the Infinispan subsystem (apart from the Memcached endpoint which, because of the protocol&#8217;s design, only allows access to a single cache).</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="operating_modes"><a class="anchor" href="#operating_modes"></a>2. Operating modes</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan Server, like WildFly, can be booted in two different modes: standalone and domain.</p> </div> <div class="sect2"> <h3 id="standalone_mode"><a class="anchor" href="#standalone_mode"></a>2.1. Standalone mode</h3> <div class="paragraph"> <p>For simple configurations, standalone mode is the easiest to start with. It allows both local and clustered configurations, although we only really recommend it for running single nodes, since the configuration, management and coordination of multiple nodes is up to the user&#8217;s responsibility. For example, adding a cache to a cluster of standalone server, the user would need to configure individually to all nodes. Note that the default standalone.xml configuration does not provide a JGroups subsystem and therefore cannot work in clustered mode. To start standalone mode with an alternative configuration file, use the -c command-line switch as follows:</p> </div> <div class="literalblock"> <div class="content"> <pre>bin/standalone.sh -c clustered.xml</pre> </div> </div> <div class="paragraph"> <p>If you start the server in clustered mode on multiple hosts, they should automatically discover each other using UDP multicast and form a cluster. If you want to start multiple nodes on a single host, start each one by specifying a port offset using the jboss.socket.binding.port-offset property together with a unique jboss.node.name as follows:</p> </div> <div class="literalblock"> <div class="content"> <pre>bin/standalone.sh -Djboss.socket.binding.port-offset=100 -Djboss.node.name=nodeA</pre> </div> </div> <div class="paragraph"> <p>If, for some reason, you cannot use UDP multicast, you can use TCP discovery. Read the <strong>JGroups Subsystem Configuration</strong> section below for details on how to configure TCP discovery.</p> </div> </div> <div class="sect2"> <h3 id="domain_mode"><a class="anchor" href="#domain_mode"></a>2.2. Domain mode</h3> <div class="paragraph"> <p>Domain mode is the recommended way to run a cluster of servers, since they can all be managed centrally from a single control point. The following diagram explains the topology of an example domain configuration, with 4 server nodes (A1, A2, B1, B2) running on two physical hosts (A, B):</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./images/domain.svg" alt="domain"> </div> <div class="title">Figure 1. Domain-mode</div> </div> <div class="sect3"> <h4 id="host"><a class="anchor" href="#host"></a>2.2.1. Host</h4> <div class="paragraph"> <p>Each "Host" box in the above diagram represents a physical or virtual host. A physical host can contain zero, one or more server instances.</p> </div> <div class="sect4"> <h5 id="host_controller"><a class="anchor" href="#host_controller"></a>Host Controller</h5> <div class="paragraph"> <p>When the domain.sh or domain.bat script is run on a host, a process known as a Host Controller is launched. The Host Controller is solely concerned with server management; it does not itself handle Infinispan server workloads. The Host Controller is responsible for starting and stopping the individual Infinispan server processes that run on its host, and interacts with the Domain Controller to help manage them.</p> </div> <div class="paragraph"> <p>Each Host Controller by default reads its configuration from the domain/configuration/host.xml file located in the Infinispan Server installation on its host&#8217;s filesystem. The host.xml file contains configuration information that is specific to the particular host. Primarily:</p> </div> <div class="ulist"> <ul> <li> <p>the listing of the names of the actual Infinispan Server instances that are meant to run off of this installation.</p> </li> <li> <p>configuration of how the Host Controller is to contact the Domain Controller to register itself and access the domain configuration. This may either be configuration of how to find and contact a remote Domain Controller, or a configuration telling the Host Controller to itself act as the Domain Controller.</p> </li> <li> <p>configuration of items that are specific to the local physical installation. For example, named interface definitions declared in domain.xml (see below) can be mapped to an actual machine-specific IP address in host.xml. Abstract path names in domain.xml can be mapped to actual filesystem paths in host.xml.</p> </li> </ul> </div> </div> </div> <div class="sect3"> <h4 id="domain_controller"><a class="anchor" href="#domain_controller"></a>2.2.2. Domain Controller</h4> <div class="paragraph"> <p>One Host Controller instance is configured to act as the central management point for the entire domain, i.e. to be the Domain Controller. The primary responsibility of the Domain Controller is to maintain the domain&#8217;s central management policy, to ensure all Host Controllers are aware of its current contents, and to assist the Host Controllers in ensuring any running Infinispan server instances are configured in accordance with this policy. This central management policy is stored by default in the domain/configuration/domain.xml file in the Infinispan Server installation on Domain Controller&#8217;s host&#8217;s filesystem.</p> </div> <div class="paragraph"> <p>A domain.xml file must be located in the domain/configuration directory of an installation that&#8217;s meant to run the Domain Controller. It does not need to be present in installations that are not meant to run a Domain Controller; i.e. those whose Host Controller is configured to contact a remote Domain Controller. The presence of a domain.xml file on such a server does no harm.</p> </div> <div class="paragraph"> <p>The domain.xml file includes, among other things, the configuration of the various "profiles" that Infinispan Server instances in the domain can be configured to run. A profile configuration includes the detailed configuration of the various subsystems that comprise that profile (e.g. Cache Containers and Caches, Endpoints, Security Realms, DataSources, etc). The domain configuration also includes the definition of groups of sockets that those subsystems may open. The domain configuration also includes the definition of "server groups".</p> </div> </div> <div class="sect3"> <h4 id="server_group"><a class="anchor" href="#server_group"></a>2.2.3. Server Group</h4> <div class="paragraph"> <p>A server group is set of server instances that will be managed and configured as one. In a managed domain each application server instance is a member of a server group. Even if the group only has a single server, the server is still a member of a group. It is the responsibility of the Domain Controller and the Host Controllers to ensure that all servers in a server group have a consistent configuration. They should all be configured with the same profile and they should have the same deployment content deployed. To keep things simple, ensure that all the nodes that you want to belong to an Infinispan cluster are configured as servers of one server group.</p> </div> <div class="paragraph"> <p>The domain can have multiple server groups, i.e. multiple Infinispan clusters. Different server groups can be configured with different profiles and deployments; for example in a domain with different Infinispan Server clusters providing different services. Different server groups can also run the same profile and have the same deployments.</p> </div> <div class="paragraph"> <p>An example server group definition is as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;server-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">main-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">profile</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clustered</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/server-group&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>A server-group configuration includes the following required attributes:</p> </div> <div class="ulist"> <ul> <li> <p>name&#8201;&#8212;&#8201;the name of the server group</p> </li> <li> <p>profile&#8201;&#8212;&#8201;the name of the profile the servers in the group should run</p> </li> </ul> </div> <div class="paragraph"> <p>In addition, the following optional elements are available:</p> </div> <div class="ulist"> <ul> <li> <p>socket-binding-group&#8201;&#8212;&#8201;specifies the name of the default socket binding group to use on servers in the group. Can be overridden on a per-server basis in host.xml. If not provided in the server-group element, it must be provided for each server in host.xml.</p> </li> <li> <p>deployments&#8201;&#8212;&#8201;the deployment content that should be deployed on the servers in the group.</p> </li> <li> <p>system-properties&#8201;&#8212;&#8201;system properties that should be set on all servers in the group</p> </li> <li> <p>jvm&#8201;&#8212;&#8201;default jvm settings for all servers in the group. The Host Controller will merge these settings with any provided in host.xml to derive the settings to use to launch the server&#8217;s JVM. See JVM settings for further details.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="server"><a class="anchor" href="#server"></a>2.2.4. Server</h4> <div class="paragraph"> <p>Each "Server" in the above diagram represents an actual Infinispan Server node. The server runs in a separate JVM process from the Host Controller. The Host Controller is responsible for launching that process. In a managed domain the end user cannot directly launch a server process from the command line.</p> </div> <div class="paragraph"> <p>The Host Controller synthesizes the server&#8217;s configuration by combining elements from the domain wide configuration (from domain.xml) and the host-specific configuration (from host.xml).</p> </div> </div> </div> <div class="sect2"> <h3 id="example_configurations"><a class="anchor" href="#example_configurations"></a>2.3. Example configurations</h3> <div class="paragraph"> <p>The server distribution also provides a set of example configuration files in the docs/examples/configs (mostly using standalone mode) which illustrate a variety of possible configurations and use-cases. To use them, just copy them to the standalone/configuration directory and start the server using the following syntax:</p> </div> <div class="literalblock"> <div class="content"> <pre>bin/standalone.sh -c configuration_file_name.xml</pre> </div> </div> <div class="paragraph"> <p>For more information regarding the parameters supported by the startup scripts, refer to the WildFly documentation on <a href="https://docs.jboss.org/author/display/WFLY11/Command+line+parameters">Command line parameters</a>.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="server_config"><a class="anchor" href="#server_config"></a>3. Configuration</h2> <div class="sectionbody"> <div class="paragraph"> <p>Since the server is based on the WildFly codebase, refer to the WildFly documentation, apart from the JGroups, Infinispan and Endpoint subsytems.</p> </div> <div class="sect2"> <h3 id="server_config_jgroups"><a class="anchor" href="#server_config_jgroups"></a>3.1. JGroups subsystem configuration</h3> <div class="paragraph"> <p>The JGroups subsystem configures the network transport and is only required when clustering multiple Infinispan Server nodes together.</p> </div> <div class="paragraph"> <p>The subsystem declaration is enclosed in the following XML element:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:server:jgroups:9.2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;channels</span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cluster</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;channel</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cluster</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/channels&gt;</span>
  <span class="tag">&lt;stacks</span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.default.jgroups.stack:udp}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
  <span class="tag">&lt;/stacks&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Within the subsystem, you need to declare the stacks that you wish to use and name them. The default-stack attribute in the subsystem declaration must point to one of the declared stacks. You can switch stacks from the command-line using the jboss.default.jgroups.stack property:</p> </div> <div class="literalblock"> <div class="content"> <pre>bin/standalone.sh -c clustered.xml -Djboss.default.jgroups.stack=tcp</pre> </div> </div> <div class="paragraph"> <p>A stack declaration is composed of a transport, <code>UDP</code> or <code>TCP</code>, followed by a list of protocols. You can tune protocols by adding properties as child elements with this format:</p> </div> <div class="paragraph"> <p><code>&lt;property name="prop_name"&gt;prop_value&lt;/property&gt;</code></p> </div> <div class="paragraph"> <p>Default stacks for Infinispan are as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">udp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;transport</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UDP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-udp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PING</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FD_SOCK</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-udp-fd</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FD_ALL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VERIFY_SUSPECT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.NAKACK2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UNICAST3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.STABLE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.GMS</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UFC_NB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MFC_NB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FRAG3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/stack&gt;</span>
<span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tcp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;transport</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TCP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-tcp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MPING</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-mping</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FD_SOCK</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-tcp-fd</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FD_ALL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VERIFY_SUSPECT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.NAKACK2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">use_mcast_xmit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>false<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;/protocol&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UNICAST3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.STABLE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.GMS</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MFC_NB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FRAG3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/stack&gt;</span></code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>For some properties, Infinispan uses values other than the JGroups defaults to tune performance. You should examine the following files to review the JGroups configuration for Infinispan:</p> </div> <div class="ulist"> <ul> <li> <p>Remote Client/Server Mode:</p> <div class="ulist"> <ul> <li> <p><code>jgroups-defaults.xml</code></p> </li> <li> <p><code>infinispan-jgroups.xml</code></p> </li> </ul> </div> </li> <li> <p>Library Mode:</p> <div class="ulist"> <ul> <li> <p><code>default-jgroups-tcp.xml</code></p> </li> <li> <p><code>default-jgroups-udp.xml</code></p> </li> </ul> </div> </li> </ul> </div> <div class="paragraph"> <p>See <a href="http://www.jgroups.org/manual/html/protlist.html">JGroups Protocol</a> documentation for more information about available properties and default values.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>The default TCP stack uses the MPING protocol for discovery, which uses UDP multicast. If you need to use a different protocol, look at the <a href="http://www.jgroups.org/manual/html/protlist.html#DiscoveryProtocols">JGroups Discovery Protocols</a> . The following example stack configures the TCPPING discovery protocol with two initial hosts:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tcp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;transport</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TCP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-tcp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TCPPING</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">initial_hosts</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>HostA[7800],HostB[7800]<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;/protocol&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FD_SOCK</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-tcp-fd</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FD_ALL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VERIFY_SUSPECT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.NAKACK2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">use_mcast_xmit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>false<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;/protocol&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UNICAST3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.STABLE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.GMS</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UFC_NB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MFC_NB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FRAG3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/stack&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The default configurations come with a variety of pre-configured stacks for different enviroments. For example, the tcpgossip stack uses Gossip discovery:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TCPGOSSIP</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">initial_hosts</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${jgroups.gossip.initial_hosts:}<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/protocol&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Use the s3 stack when running in Amazon AWS:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">S3_PING</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">location</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${jgroups.s3.bucket:}<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">access_key</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${jgroups.s3.access_key:}<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secret_access_key</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${jgroups.s3.secret_access_key:}<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pre_signed_delete_url</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${jgroups.s3.pre_signed_delete_url:}<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pre_signed_put_url</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${jgroups.s3.pre_signed_put_url:}<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">prefix</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${jgroups.s3.prefix:}<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/protocol&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Similarly, when using Google&#8217;s Cloud Platform, use the google stack:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">GOOGLE_PING</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">location</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${jgroups.google.bucket:}<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">access_key</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${jgroups.google.access_key:}<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secret_access_key</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${jgroups.google.secret_access_key:}<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/protocol&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Use the dns-ping stack to run Infinispan on Kubernetes environments such as OKD or OpenShift:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dns.DNS_PING</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dns_query</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${jgroups.dns_ping.dns_query}<span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/protocol&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The value of the <code>dns_query</code> property is the DNS query that returns the cluster members. See <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/">DNS for Services and Pods</a> for information about Kubernetes DNS naming.</p> </div> <div class="sect3"> <h4 id="cluster_authentication_and_authorization"><a class="anchor" href="#cluster_authentication_and_authorization"></a>3.1.1. Cluster authentication and authorization</h4> <div class="paragraph"> <p>The JGroups subsystem can be configured so that nodes need to authenticate each other when joining / merging. The authentication uses SASL and integrates with the security realms.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;management&gt;</span>
  <span class="tag">&lt;security-realms&gt;</span>
  ...
    <span class="tag">&lt;security-realm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ClusterRealm</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;authentication&gt;</span>
        <span class="tag">&lt;properties</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cluster-users.properties</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">relative-to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jboss.server.config.dir</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/authentication&gt;</span>
      <span class="tag">&lt;authorization&gt;</span>
        <span class="tag">&lt;properties</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cluster-roles.properties</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">relative-to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jboss.server.config.dir</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/authorization&gt;</span>
    <span class="tag">&lt;/security-realm&gt;</span>
  ...
  <span class="tag">&lt;/security-realms&gt;</span>
<span class="tag">&lt;/management&gt;</span>

<span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">udp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
  <span class="tag">&lt;sasl</span> <span class="attribute-name">mech</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DIGEST-MD5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ClusterRealm</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cluster-role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cluster</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">client_name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>node1<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">client_password</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>password<span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;/sasl&gt;</span>
  ...
<span class="tag">&lt;/stack&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>In the above example the nodes will use the DIGEST-MD5 mech to authenticate against the ClusterRealm. In order to join, nodes need to have the cluster role. If the cluster-role attribute is not specified it defaults to the name of the Infinispan cache-container, as described below. Each node identifies itself using the client_name property. If none is explicitly specified, the hostname on which the server is running will be used. This name can also be overridden by specifying the jboss.node.name system property. The client_password property contains the password of the node. It is recommended that this password be stored in the Vault. Refer to <a href="https://community.jboss.org/wiki/AS7UtilisingMaskedPasswordsViaTheVault">AS7: Utilising masked passwords via the vault</a> for instructions on how to do so. When using the GSSAPI mech, client_name will be used as the name of a Kerberos-enabled login module defined within the security domain subsystem:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;security-domain</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">krb-node0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;authentication&gt;</span>
    <span class="tag">&lt;login-module</span> <span class="attribute-name">code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Kerberos</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">flag</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">required</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;module-option</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">storeKey</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;module-option</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">useKeyTab</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;module-option</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">refreshKrb5Config</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;module-option</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">principal</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups/node0/clustered@INFINISPAN.ORG</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;module-option</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keyTab</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.server.config.dir}/keytabs/jgroups_node0_clustered.keytab</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;module-option</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">doNotPrompt</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/login-module&gt;</span>
  <span class="tag">&lt;/authentication&gt;</span>
<span class="tag">&lt;/security-domain&gt;</span></code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="infinispan_subsystem_configuration"><a class="anchor" href="#infinispan_subsystem_configuration"></a>3.2. Infinispan subsystem configuration</h3> <div class="paragraph"> <p>The Infinispan subsystem configures the cache containers and caches.</p> </div> <div class="paragraph"> <p>The subsystem declaration is enclosed in the following XML element:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:server:core:9.4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clustered</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre> </div> </div> <div class="sect3"> <h4 id="containers"><a class="anchor" href="#containers"></a>3.2.1. Containers</h4> <div class="paragraph"> <p>The Infinispan subsystem can declare multiple containers. A container is declared as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clustered</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
<span class="tag">&lt;/cache-container&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Note that in server mode is the lack of an implicit default cache, but the ability to specify a named cache as the default.</p> </div> <div class="paragraph"> <p>If you need to declare clustered caches (distributed, replicated, invalidation), you also need to specify the <code>&lt;transport/&gt;</code> element which references an existing JGroups transport. This is not needed if you only intend to have local caches only.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;transport</span> <span class="attribute-name">executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-transport</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lock-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">udp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cluster-name</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="caches"><a class="anchor" href="#caches"></a>3.2.2. Caches</h4> <div class="paragraph"> <p>Now you can declare your caches. Please be aware that only the caches declared in the configuration will be available to the endpoints and that attempting to access an undefined cache is an illegal operation. Contrast this with the default Infinispan library behaviour where obtaining an undefined cache will implicitly create one using the default settings. The following are example declarations for all four available types of caches:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EAGER</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
<span class="tag">&lt;/local-cache&gt;</span>

<span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replcache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EAGER</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
<span class="tag">&lt;/replicated-cache&gt;</span>

<span class="tag">&lt;invalidation-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invcache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EAGER</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
<span class="tag">&lt;/invalidation-cache&gt;</span>

<span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">distcache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">segments</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">remote-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EAGER</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="expiration"><a class="anchor" href="#expiration"></a>3.2.3. Expiration</h4> <div class="paragraph"> <p>To define a default expiration for entries in a cache, add the <code>&lt;expiration/&gt;</code> element as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;expiration</span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The possible attributes for the expiration element are:</p> </div> <div class="ulist"> <ul> <li> <p><em>lifespan</em> maximum lifespan of a cache entry, after which the entry is expired cluster-wide, in milliseconds. -1 means the entries never expire.</p> </li> <li> <p><em>max-idle</em> maximum idle time a cache entry will be maintained in the cache, in milliseconds. If the idle time is exceeded, the entry will be expired cluster-wide. -1 means the entries never expire.</p> </li> <li> <p><em>interval</em> interval (in milliseconds) between subsequent runs to purge expired entries from memory and any cache stores. If you wish to disable the periodic eviction process altogether, set interval to -1.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="eviction"><a class="anchor" href="#eviction"></a>3.2.4. Eviction</h4> <div class="paragraph"> <p>To define eviction for a cache, add the <code>&lt;memory/&gt;</code> element as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;memory&gt;</span> <span class="tag">&lt;binary</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">eviction</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COUNT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="tag">&lt;/memory&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The possible attributes for the eviction element are:</p> </div> <div class="ulist"> <ul> <li> <p><em>strategy</em> sets the cache eviction strategy. Available options are 'UNORDERED', 'FIFO', 'LRU', 'LIRS' and 'NONE' (to disable eviction).</p> </li> <li> <p><em>max-entries</em> maximum number of entries in a cache instance. If selected value is not a power of two the actual value will default to the least power of two larger than selected value. -1 means no limit.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="locking"><a class="anchor" href="#locking"></a>3.2.5. Locking</h4> <div class="paragraph"> <p>To define the locking configuration for a cache, add the <code>&lt;locking/&gt;</code> element as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;locking</span> <span class="attribute-name">isolation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REPEATABLE_READ</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">acquire-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">concurrency-level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">striping</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The possible attributes for the locking element are:</p> </div> <div class="ulist"> <ul> <li> <p><em>isolation</em> sets the cache locking isolation level. Can be NONE, READ_UNCOMMITTED, READ_COMMITTED, REPEATABLE_READ, SERIALIZABLE. Defaults to REPEATABLE_READ</p> </li> <li> <p><em>striping</em> if true, a pool of shared locks is maintained for all entries that need to be locked. Otherwise, a lock is created per entry in the cache. Lock striping helps control memory footprint but may reduce concurrency in the system.</p> </li> <li> <p><em>acquire-timeout</em> maximum time to attempt a particular lock acquisition.</p> </li> <li> <p><em>concurrency-level</em> concurrency level for lock containers. Adjust this value according to the number of concurrent threads interacting with Infinispan.</p> </li> <li> <p><em>concurrent-updates</em> for non-transactional caches only: if set to true(default value) the cache keeps data consistent in the case of concurrent updates. For clustered caches this comes at the cost of an additional RPC, so if you don&#8217;t expect your application to write data concurrently, disabling this flag increases performance.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="transactional_operations_with_hot_rod"><a class="anchor" href="#transactional_operations_with_hot_rod"></a>3.2.6. Transactional Operations with Hot Rod</h4> <div class="paragraph"> <p>Hot Rod clients can take advantage of transactional capabilities when performing cache operations. No other protocols that Infinispan supports offer transactional capabilities.</p> </div> </div> <div class="sect3"> <h4 id="loaders_and_stores"><a class="anchor" href="#loaders_and_stores"></a>3.2.7. Loaders and Stores</h4> <div class="paragraph"> <p>Loaders and stores can be defined in server mode in almost the same way as in embedded mode. See <a href="../user_guide/user_guide.html#persistence">Persistence</a> in the User Guide.</p> </div> <div class="paragraph"> <p>However, in server mode it is no longer necessary to define the <code>&lt;persistence&gt;&#8230;&#8203;&lt;/persistence&gt;</code> tag. Instead, a store&#8217;s attributes are now defined on the store type element. For example, to configure the H2 database with a distributed cache in domain mode we define the "default" cache as follows in our domain.xml configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:server:core:9.4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clustered</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;transport</span> <span class="attribute-name">lock-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;global-state</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;string-keyed-jdbc-store</span> <span class="attribute-name">datasource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/datasources/ExampleDS</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">datum</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/string-keyed-table&gt;</span>
        <span class="tag">&lt;write-behind</span> <span class="attribute-name">modification-queue-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/string-keyed-jdbc-store&gt;</span>
    <span class="tag">&lt;/distributed-cache&gt;</span>
  <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Another important thing to note in this example, is that we use the "ExampleDS" datasource which is defined in the datasources subsystem in our domain.xml configuration as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:datasources:4.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;datasources&gt;</span>
    <span class="tag">&lt;datasource</span> <span class="attribute-name">jndi-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/datasources/ExampleDS</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pool-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ExampleDS</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">use-java-context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;connection-url&gt;</span>jdbc:h2:mem:test;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE<span class="tag">&lt;/connection-url&gt;</span>
      <span class="tag">&lt;driver&gt;</span>h2<span class="tag">&lt;/driver&gt;</span>
      <span class="tag">&lt;security&gt;</span>
        <span class="tag">&lt;user-name&gt;</span>sa<span class="tag">&lt;/user-name&gt;</span>
        <span class="tag">&lt;password&gt;</span>sa<span class="tag">&lt;/password&gt;</span>
      <span class="tag">&lt;/security&gt;</span>
    <span class="tag">&lt;/datasource&gt;</span>
  <span class="tag">&lt;/datasources&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> For additional examples of store configurations, please view the configuration templates in the default "domain.xml" file provided with in the server distribution at <code>./domain/configuration/domain.xml</code>. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="state_transfer"><a class="anchor" href="#state_transfer"></a>3.2.8. State Transfer</h4> <div class="paragraph"> <p>To define the state transfer configuration for a distributed or replicated cache, add the <code>&lt;state-transfer/&gt;</code> element as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;state-transfer</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">240000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">chunk-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">512</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">await-initial-transfer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The possible attributes for the state-transfer element are:</p> </div> <div class="ulist"> <ul> <li> <p><em>enabled</em> if true, this will cause the cache to ask neighboring caches for state when it starts up, so the cache starts 'warm', although it will impact startup time. Defaults to true.</p> </li> <li> <p><em>timeout</em> the maximum amount of time (ms) to wait for state from neighboring caches, before throwing an exception and aborting startup. Defaults to 240000 (4 minutes).</p> </li> <li> <p><em>chunk-size</em> the number of cache entries to batch in each transfer. Defaults to 512.</p> </li> <li> <p><em>await-initial-transfer</em> if true, this will cause the cache to wait for initial state transfer to complete before responding to requests. Defaults to true.</p> </li> </ul> </div> </div> </div> <div class="sect2"> <h3 id="endpoint_subsystem_configuration"><a class="anchor" href="#endpoint_subsystem_configuration"></a>3.3. Endpoint subsystem configuration</h3> <div class="paragraph"> <p>The endpoint subsystem exposes a whole container (or in the case of Memcached, a single cache) over a specific connector protocol. You can define as many connector as you need, provided they bind on different interfaces/ports.</p> </div> <div class="paragraph"> <p>The subsystem declaration is enclosed in the following XML element:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"> <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:server:endpoint:9.4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
 <span class="tag">&lt;/subsystem&gt;</span></code></pre> </div> </div> <div class="sect3"> <h4 id="hot_rod"><a class="anchor" href="#hot_rod"></a>3.3.1. Hot Rod</h4> <div class="paragraph"> <p>The following connector declaration enables a HotRod server using the <em>hotrod</em> socket binding (declared within a <code>&lt;socket-binding-group /&gt;</code> element) and exposing the caches declared in the <em>local</em> container, using defaults for all other settings.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;hotrod-connector</span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The connector will create a supporting topology cache with default settings. If you wish to tune these settings add the <code>&lt;topology-state-transfer /&gt;</code> child element to the connector as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;hotrod-connector</span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;topology-state-transfer</span> <span class="attribute-name">lazy-retrieval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lock-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">replication-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/hotrod-connector&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The Hot Rod connector can be further tuned with additional settings such as concurrency and buffering. See the protocol connector settings paragraph for additional details</p> </div> <div class="paragraph"> <p>Furthermore the HotRod connector can be secured using SSL. First you need to declare an SSL server identity within a security realm in the management section of the configuration file. The SSL server identity should specify the path to a keystore and its secret. Refer to the AS <a href="https://docs.jboss.org/author/display/WFLY11/Security%20Realms">documentation</a> on this. Next add the <code>&lt;security /&gt;</code> element to the HotRod connector as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;hotrod-connector</span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;security</span> <span class="attribute-name">ssl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ApplicationRealm</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">require-ssl-client-auth</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/hotrod-connector&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="memcached"><a class="anchor" href="#memcached"></a>3.3.2. Memcached</h4> <div class="paragraph"> <p>The following connector declaration enables a Memcached server using the <em>memcached</em> socket binding (declared within a <code>&lt;socket-binding-group /&gt;</code> element) and exposing the <em>memcachedCache</em> cache declared in the <em>local</em> container, using defaults for all other settings. Because of limitations in the Memcached protocol, only one cache can be exposed by a connector. If you wish to expose more than one cache, declare additional memcached-connectors on different socket-bindings.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;memcached-connector</span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">memcached</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="websocket"><a class="anchor" href="#websocket"></a>3.3.3. WebSocket</h4> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;websocket-connector</span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">websocket</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="rest"><a class="anchor" href="#rest"></a>3.3.4. REST</h4> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;rest-connector</span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">security-domain</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">other</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auth-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BASIC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="common_protocol_connector_settings"><a class="anchor" href="#common_protocol_connector_settings"></a>3.3.5. Common Protocol Connector Settings</h4> <div class="paragraph"> <p>The HotRod, Memcached and WebSocket protocol connectors support a number of tuning attributes in their declaration:</p> </div> <div class="ulist"> <ul> <li> <p><em>worker-threads</em> Sets the number of worker threads. Defaults to 160.</p> </li> <li> <p><em>idle-timeout</em> Specifies the maximum time in seconds that connections from client will be kept open without activity. Defaults to -1 (connections will never timeout)</p> </li> <li> <p><em>tcp-nodelay</em> Affects TCP NODELAY on the TCP stack. Defaults to enabled.</p> </li> <li> <p><em>send-buffer-size</em> Sets the size of the send buffer.</p> </li> <li> <p><em>receive-buffer-size</em> Sets the size of the receive buffer.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="protocol_interoperability"><a class="anchor" href="#protocol_interoperability"></a>3.3.6. Protocol Interoperability</h4> <div class="paragraph"> <p>Clients exchange data with Infinispan through endpoints such as REST or Hot Rod.</p> </div> <div class="paragraph"> <p>Each endpoint uses a different protocol so that clients can read and write data in a suitable format. Because Infinispan can interoperate with multiple clients at the same time, it must convert data between client formats and the storage formats.</p> </div> <div class="paragraph"> <p>For more information, see <a href="../user_guide/user_guide.html#endpoint_interop">Protocol Interoperability</a> in the User Guide.</p> </div> </div> <div class="sect3"> <h4 id="custom_marshaller_bridges"><a class="anchor" href="#custom_marshaller_bridges"></a>3.3.7. Custom Marshaller Bridges</h4> <div class="paragraph"> <p>Infinispan provides two marshalling bridges for marshalling client/server requests using the Kryo and Protostuff libraries. To utilise either of these marshallers, you simply place the dependency of the marshaller you require in your client pom. Custom schemas for object marshalling must then be registered with the selected library using the library&#8217;s api on the client or by implementing a RegistryService for the given marshaller bridge. Examples of how to achieve this for both libraries are presented below:</p> </div> <div class="sect4"> <h5 id="protostuff"><a class="anchor" href="#protostuff"></a>Protostuff</h5> <div class="paragraph"> <p>Add the protostuff marshaller dependency to your pom:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-marshaller-protostuff<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p> </div> <div class="paragraph"> <p>To register custom Protostuff schemas in your own code, you must register the custom schema with Protostuff before any marshalling begins. This can be achieved by simply calling:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RuntimeSchema.register(ExampleObject.class, <span class="keyword">new</span> ExampleObjectSchema());</code></pre> </div> </div> <div class="paragraph"> <p>Or, you can implement a service provider for the <code>SchemaRegistryService.java</code> interface, placing all Schema registrations in the <code>register()</code> method. Implementations of this interface are loaded via Java&#8217;s ServiceLoader api, therefore the full path of the implementing class(es) should be provided in a <code>META-INF/services/org/infinispan/marshaller/protostuff/SchemaRegistryService</code> file within your deployment jar.</p> </div> </div> <div class="sect4"> <h5 id="kryo"><a class="anchor" href="#kryo"></a>Kryo</h5> <div class="paragraph"> <p>Add the kryo marshaller dependency to your pom:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-marshaller-kryo<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Replace <code>${version.infinispan}</code> with the appropriate version of Infinispan.</p> </div> <div class="paragraph"> <p>To register custom Kryo serializer in your own code, you must register the custom serializer with Kryo before any marshalling begins. This can be achieved by implementing a service provider for the <code>SerializerRegistryService.java</code> interface, placing all serializer registrations in the <code>register(Kryo)</code> method; where serializers should be registered with the supplied <code>Kryo</code> object using the Kryo api. e.g. <code>kryo.register(ExampleObject.class, new ExampleObjectSerializer())</code>. Implementations of this interface are loaded via Java&#8217;s ServiceLoader api, therefore the full path of the implementing class(es) should be provided in a <code>META-INF/services/org/infinispan/marshaller/kryo/SerializerRegistryService</code> file within your deployment jar.</p> </div> </div> <div class="sect4"> <h5 id="storing_deserialized_objects"><a class="anchor" href="#storing_deserialized_objects"></a>Storing deserialized objects</h5> <div class="paragraph"> <p>When using the Protostuff/Kryo bridges in caches configured with <em>application/x-java-object</em> as MediaType (storing POJOs instead of binary content) it is necessary for the class files of all custom objects to be placed on the classpath of the server. To achieve this, you should place a jar containing all of their custom classes on the server&#8217;s classpath.</p> </div> <div class="paragraph"> <p>When utilising a custom marshaller, it is also necessary for the marshaller and it&#8217;s runtime dependencies to be on the server&#8217;s classpath. To aid with this step we have created a "bundle" jar for each of the bridge implementations which includes all of the runtime class files required by the bridge and underlying library. Therefore, it is only necessary to include this single jar on the server&#8217;s classpath.</p> </div> <div class="paragraph"> <p>Bundle jar downloads:</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://central.maven.org/maven2/org/infinispan/infinispan-marshaller-kryo-bundle/10.0/infinispan-marshaller-kryo-bundle-10.0.jar">Kryo Bundle</a></p> </li> <li> <p><a href="http://central.maven.org/maven2/org/infinispan/infinispan-marshaller-protostuff-bundle/10.0/infinispan-marshaller-protostuff-bundle-10.0.jar">Protostuff Bundle</a></p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Jar files containing custom classes must be placed in the same module/directory as the custom marshaller bundle so that the marshaller can load them. i.e. if you register the marshaller bundle in <code>modules/system/layers/base/org/infinispan/main/modules.xml</code>, then you must also register your custom classes here. </td> </tr> </table> </div> <div class="sect5"> <h6 id="registering_custom_schemasserializers"><a class="anchor" href="#registering_custom_schemasserializers"></a>Registering Custom Schemas/Serializers</h6> <div class="paragraph"> <p>Custom serializers/schemas for the Kryo/Protostuff marshallers must be registered via their respective service interfaces in order to store deserialized objects. To achieve this, it is necessary for a <strong>JAR</strong> that contains the service provider to be registered in the same directory or module as the marshaller bundle and custom classes.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>It is not necessary for the service provider implementation to be provided in the same <strong>JAR</strong> as the user&#8217;s custom classes. However, the <strong>JAR</strong> that contains the provider must be in the same directory/module as the marshaller and custom class <strong>JAR</strong> files.</p> </div> </td> </tr> </table> </div> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="rolling_upgrades"><a class="anchor" href="#rolling_upgrades"></a>4. Performing Rolling Upgrades</h2> <div class="sectionbody"> <div class="paragraph"> <p>Upgrade Infinispan without downtime or data loss. You can perform rolling upgrades in Remote Client/Server Mode to start using a more recent version of Infinispan.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>This section explains how to upgrade Infinispan servers, see the appropriate documentation for your Hot Rod client for upgrade procedures.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>From a high-level, you do the following to perform rolling upgrades:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Set up a target cluster. The target cluster is the Infinispan version to which you want to migrate data. The source cluster is the Infinispan deployment that is currently in use. After the target cluster is running, you configure all clients to point to it instead of the source cluster.</p> </li> <li> <p>Synchronize data from the source cluster to the target cluster.</p> </li> </ol> </div> <div class="sect2"> <h3 id="setting_up_a_target_cluster"><a class="anchor" href="#setting_up_a_target_cluster"></a>4.1. Setting Up a Target Cluster</h3> <div class="olist arabic"> <ol class="arabic"> <li> <p>Start the target cluster with unique network properties or a different JGroups cluster name to keep it separate from the source cluster.</p> </li> <li> <p>Configure a <code>RemoteCacheStore</code> on the target cluster for each cache you want to migrate from the source cluster.</p> <div class="dlist"> <dl> <dt class="hdlist1"><code>RemoteCacheStore</code> settings</dt> <dd> <div class="ulist"> <ul> <li> <p><code>remote-server</code> must point to the source cluster via the <code>outbound-socket-binding</code> property.</p> </li> <li> <p><code>remoteCacheName</code> must match the cache name on the source cluster.</p> </li> <li> <p><code>hotrod-wrapping</code> must be <code>true</code> (enabled).</p> </li> <li> <p><code>shared</code> must be <code>true</code> (enabled).</p> </li> <li> <p><code>purge</code> must be <code>false</code> (disabled).</p> </li> <li> <p><code>passivation</code> must be <code>false</code> (disabled).</p> </li> <li> <p><code>protocol-version</code> matches the Hot Rod protocol version of the source cluster.</p> <div class="listingblock"> <div class="title">Example <code>RemoteCacheStore</code> Configuration</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache&gt;</span>
   <span class="tag">&lt;remote-store</span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MyCache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">tcp-no-delay</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">protocol-version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2.5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">hotrod-wrapping</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;remote-server</span> <span class="attribute-name">outbound-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-store-hotrod-server</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span>
...
<span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.socket.binding.port-offset:0}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
  <span class="tag">&lt;outbound-socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-store-hotrod-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;remote-destination</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">198.51.100.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">11222</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/outbound-socket-binding&gt;</span>
  ...
<span class="tag">&lt;/socket-binding-group&gt;</span></code></pre> </div> </div> </li> </ul> </div> </dd> </dl> </div> </li> <li> <p>Configure the target cluster to handle all client requests instead of the source cluster:</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>Configure all clients to point to the target cluster instead of the source cluster.</p> </li> <li> <p>Restart each client node.</p> <div class="paragraph"> <p>The target cluster lazily loads data from the source cluster on demand via <code>RemoteCacheStore</code>.</p> </div> </li> </ol> </div> </li> </ol> </div> </div> <div class="sect2"> <h3 id="synchronizing_data_from_the_source_cluster"><a class="anchor" href="#synchronizing_data_from_the_source_cluster"></a>4.2. Synchronizing Data from the Source Cluster</h3> <div class="olist arabic"> <ol class="arabic"> <li> <p>Call the <code>synchronizeData()</code> method in the <code>TargetMigrator</code> interface. Do one of the following on the target cluster for each cache that you want to migrate:</p> <div class="dlist"> <dl> <dt class="hdlist1">JMX</dt> <dd> <div class="paragraph"> <p>Invoke the <code>synchronizeData</code> operation and specify the <code>hotrod</code> parameter on the <code>RollingUpgradeManager</code> MBean.</p> </div> </dd> <dt class="hdlist1">CLI</dt> <dd> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>$ bin/ispn-cli.sh --connect controller=127.0.0.1:9990 -c "/subsystem=datagrid-infinispan/cache-container=clustered/distributed-cache=MyCache:synchronize-data(migrator-name=hotrod)"</code></pre> </div> </div> <div class="paragraph"> <p>Data migrates to all nodes in the target cluster in parallel, with each node receiving a subset of the data.</p> </div> <div class="paragraph"> <p>Use the following parameters to tune the operation:</p> </div> <div class="ulist"> <ul> <li> <p><code>read-batch</code> configures the number of entries to read from the source cluster at a time. The default value is <code>10000</code>.</p> </li> <li> <p><code>write-threads</code> configures the number of threads used to write data. The default value is the number of processors available.</p> <div class="paragraph"> <p>For example:</p> </div> <div class="paragraph"> <p><code>synchronize-data(migrator-name=hotrod, read-batch=100000, write-threads=3)</code></p> </div> </li> </ul> </div> </dd> </dl> </div> </li> <li> <p>Disable the <code>RemoteCacheStore</code> on the target cluster. Do one of the following:</p> <div class="dlist"> <dl> <dt class="hdlist1">JMX</dt> <dd> <div class="paragraph"> <p>Invoke the <code>disconnectSource</code> operation and specify the <code>hotrod</code> parameter on the <code>RollingUpgradeManager</code> MBean.</p> </div> </dd> <dt class="hdlist1">CLI</dt> <dd> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>$ bin/ispn-cli.sh --connect controller=127.0.0.1:9990 -c "/subsystem=datagrid-infinispan/cache-container=clustered/distributed-cache=MyCache:disconnect-source(migrator-name=hotrod)"</code></pre> </div> </div> </dd> </dl> </div> </li> <li> <p>Decommission the source cluster.</p> </li> </ol> </div> </div> </div> </div> <div class="sect1"> <h2 id="client_server"><a class="anchor" href="#client_server"></a>5. Client/Server</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan offers two alternative access methods: embedded mode and client-server mode.</p> </div> <div class="ulist"> <ul> <li> <p>In Embedded mode the Infinispan libraries co-exist with the user application in the same JVM as shown in the following diagram</p> </li> </ul> </div> <div class="imageblock text-center"> <div class="content"> <img src="./images/server_modules_1.png" alt="server modules 1"> </div> <div class="title">Figure 2. Peer-to-peer access</div> </div> <div class="ulist"> <ul> <li> <p>Client-server mode is when applications access the data stored in a remote Infinispan server using some kind of network protocol</p> </li> </ul> </div> <div class="sect2"> <h3 id="why_clientserver"><a class="anchor" href="#why_clientserver"></a>5.1. Why Client/Server?</h3> <div class="paragraph"> <p>There are situations when accessing Infinispan in a client-server mode might make more sense than embedding it within your application, for example, when trying to access Infinispan from a non-JVM environment. Since Infinispan is written in Java, if someone had a C\\ application that wanted to access it, it couldn&#8217;t just do it in a p2p way. On the other hand, client-server would be perfectly suited here assuming that a language neutral protocol was used and the corresponding client and server implementations were available.</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./images/server_modules_2.png" alt="server modules 2"> </div> <div class="title">Figure 3. Non-JVM access</div> </div> <div class="paragraph"> <p>In other situations, Infinispan users want to have an elastic application tier where you start/stop business processing servers very regularly. Now, if users deployed Infinispan configured with distribution or state transfer, startup time could be greatly influenced by the shuffling around of data that happens in these situations. So in the following diagram, assuming Infinispan was deployed in p2p mode, the app in the second server could not access Infinispan until state transfer had completed.</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./images/server_modules_3.png" alt="server modules 3"> </div> <div class="title">Figure 4. Elasticity issue with P2P</div> </div> <div class="paragraph"> <p>This effectively means that bringing up new application-tier servers is impacted by things like state transfer because applications cannot access Infinispan until these processes have finished and if the state being shifted around is large, this could take some time. This is undesirable in an elastic environment where you want quick application-tier server turnaround and predictable startup times. Problems like this can be solved by accessing Infinispan in a client-server mode because starting a new application-tier server is just a matter of starting a lightweight client that can connect to the backing data grid server. No need for rehashing or state transfer to occur and as a result server startup times can be more predictable which is very important for modern cloud-based deployments where elasticity in your application tier is important.</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./images/AchievingElasticity.png" alt="AchievingElasticity"> </div> <div class="title">Figure 5. Achieving elasticity</div> </div> <div class="paragraph"> <p>Other times, it&#8217;s common to find multiple applications needing access to data storage. In this cases, you could in theory deploy an Infinispan instance per each of those applications but this could be wasteful and difficult to maintain. Think about databases here, you don&#8217;t deploy a database alongside each of your applications, do you? So, alternatively you could deploy Infinispan in client-server mode keeping a pool of Infinispan data grid nodes acting as a shared storage tier for your applications.</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./images/server_modules_4.png" alt="server modules 4"> </div> <div class="title">Figure 6. Shared data storage</div> </div> <div class="paragraph"> <p>Deploying Infinispan in this way also allows you to manage each tier independently, for example, you can upgrade you application or app server without bringing down your Infinispan data grid nodes.</p> </div> </div> <div class="sect2"> <h3 id="why_use_embedded_mode"><a class="anchor" href="#why_use_embedded_mode"></a>5.2. Why use embedded mode?</h3> <div class="paragraph"> <p>Before talking about individual Infinispan server modules, it&#8217;s worth mentioning that in spite of all the benefits, client-server Infinispan still has disadvantages over p2p. Firstly, p2p deployments are simpler than client-server ones because in p2p, all peers are equals to each other and hence this simplifies deployment. So, if this is the first time you&#8217;re using Infinispan, p2p is likely to be easier for you to get going compared to client-server.</p> </div> <div class="paragraph"> <p>Client-server Infinispan requests are likely to take longer compared to p2p requests, due to the serialization and network cost in remote calls. So, this is an important factor to take in account when designing your application. For example, with replicated Infinispan caches, it might be more performant to have lightweight HTTP clients connecting to a server side application that accesses Infinispan in p2p mode, rather than having more heavyweight client side apps talking to Infinispan in client-server mode, particularly if data size handled is rather large. With distributed caches, the difference might not be so big because even in p2p deployments, you&#8217;re not guaranteed to have all data available locally.</p> </div> <div class="paragraph"> <p>Environments where application tier elasticity is not so important, or where server side applications access state-transfer-disabled, replicated Infinispan cache instances are amongst scenarios where Infinispan p2p deployments can be more suited than client-server ones.</p> </div> </div> <div class="sect2"> <h3 id="server_modules"><a class="anchor" href="#server_modules"></a>5.3. Server Modules</h3> <div class="paragraph"> <p>So, now that it&#8217;s clear when it makes sense to deploy Infinispan in client-server mode, what are available solutions? All Infinispan server modules are based on the same pattern where the server backend creates an embedded Infinispan instance and if you start multiple backends, they can form a cluster and share/distribute state if configured to do so. The server types below primarily differ in the type of listener endpoint used to handle incoming connections.</p> </div> <div class="paragraph"> <p>Here&#8217;s a brief summary of the available server endpoints.</p> </div> <div class="ulist"> <ul> <li> <p><strong>Hot Rod Server Module</strong> - This module is an implementation of the Hot Rod binary protocol backed by Infinispan which allows clients to do dynamic load balancing and failover and smart routing.</p> <div class="ulist"> <ul> <li> <p>A <a href="http://www.infinispan.org/hotrod-clients">variety of clients</a> exist for this protocol.</p> </li> <li> <p>If you&#8217;re clients are running Java, this should be your defacto server module choice because it allows for dynamic load balancing and failover. This means that Hot Rod clients can dynamically detect changes in the topology of Hot Rod servers as long as these are clustered, so when new nodes join or leave, clients update their Hot Rod server topology view. On top of that, when Hot Rod servers are configured with distribution, clients can detect where a particular key resides and so they can route requests smartly.</p> </li> <li> <p>Load balancing and failover is dynamically provided by Hot Rod client implementations using information provided by the server.</p> </li> </ul> </div> </li> <li> <p><strong>REST Server Module</strong> - The REST server, which is distributed as a WAR file, can be deployed in any servlet container to allow Infinispan to be accessed via a RESTful HTTP interface.</p> <div class="ulist"> <ul> <li> <p>To connect to it, you can use any HTTP client out there and there&#8217;re tons of different client implementations available out there for pretty much any language or system.</p> </li> <li> <p>This module is particularly recommended for those environments where HTTP port is the only access method allowed between clients and servers.</p> </li> <li> <p>Clients wanting to load balance or failover between different Infinispan REST servers can do so using any standard HTTP load balancer such as <a href="http://www.jboss.org/mod_cluster">mod_cluster</a> . It&#8217;s worth noting though these load balancers maintain a static view of the servers in the backend and if a new one was to be added, it would require manual update of the load balancer.</p> </li> </ul> </div> </li> <li> <p><strong>Memcached Server Module</strong> - This module is an implementation of the <a href="http://github.com/memcached/memcached/blob/master/doc/protocol.txt">Memcached text protocol</a> backed by Infinispan.</p> <div class="ulist"> <ul> <li> <p>To connect to it, you can use any of the <a href="http://code.google.com/p/memcached/wiki/Clients">existing Memcached clients</a> which are pretty diverse.</p> </li> <li> <p>As opposed to Memcached servers, Infinispan based Memcached servers can actually be clustered and hence they can replicate or distribute data using consistent hash algorithms around the cluster. So, this module is particularly of interest to those users that want to provide failover capabilities to the data stored in Memcached servers.</p> </li> <li> <p>In terms of load balancing and failover, there&#8217;re a few clients that can load balance or failover given a static list of server addresses (perl&#8217;s Cache::Memcached for example) but any server addition or removal would require manual intervention.</p> </li> </ul> </div> </li> </ul> </div> </div> <div class="sect2"> <h3 id="which_protocol_should_i_use"><a class="anchor" href="#which_protocol_should_i_use"></a>5.4. Which protocol should I use?</h3> <div class="paragraph"> <p>Choosing the right protocol depends on a number of factors.</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"></th> <th class="tableblock halign-center valign-top">Hot Rod</th> <th class="tableblock halign-center valign-top">HTTP / REST</th> <th class="tableblock halign-center valign-top">Memcached</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Topology-aware</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hash-aware</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Encryption</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Authentication</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Conditional ops</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Bulk ops</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Transactions</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Listeners</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Query</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Execution</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Cross-site failover</p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Y</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> <td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">N</strong></p></td> </tr> </tbody> </table> </div> </div> </div> <div class="sect1"> <h2 id="hot_rod_server_usage"><a class="anchor" href="#hot_rod_server_usage"></a>6. Using Hot Rod Server</h2> <div class="sectionbody"> <div class="paragraph"> <p>The Infinispan Server distribution contains a server module that implements Infinispan&#8217;s custom binary protocol called Hot Rod. The protocol was designed to enable faster client/server interactions compared to other existing text based protocols and to allow clients to make more intelligent decisions with regards to load balancing, failover and even data location operations. Please refer to Infinispan Server&#8217;s <a href="../server_guide/server_guide.html">documentation</a> for instructions on how to configure and run a HotRod server.</p> </div> <div class="paragraph"> <p>To connect to Infinispan over this highly efficient Hot Rod protocol you can either use one of the clients described in this chapter, or use higher level tools such as Hibernate OGM.</p> </div> <div class="sect2"> <h3 id="hotrod_java_client"><a class="anchor" href="#hotrod_java_client"></a>6.1. Java Hot Rod client</h3> <div class="paragraph"> <p>Hot Rod is a binary, language neutral protocol. This article explains how a Java client can interact with a server via the Hot Rod protocol. A reference implementation of the protocol written in Java can be found in all Infinispan distributions, and this article focuses on the capabilities of this java client.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Looking for more clients? Visit <a href="http://infinispan.org/hotrod-clients">this website</a> for clients written in a variety of different languages. </td> </tr> </table> </div> <div class="sect3"> <h4 id="configuration"><a class="anchor" href="#configuration"></a>6.1.1. Configuration</h4> <div class="paragraph"> <p>The Java Hot Rod client can be configured both programmatically and externally, through a configuration file.</p> </div> <div class="paragraph"> <p>The code snippet below illustrates the creation of a client instance using the available Java fluent API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb
      = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.tcpNoDelay(<span class="predefined-constant">true</span>)
  .connectionPool()
      .numTestsPerEvictionRun(<span class="integer">3</span>)
      .testOnBorrow(<span class="predefined-constant">false</span>)
      .testOnReturn(<span class="predefined-constant">false</span>)
      .testWhileIdle(<span class="predefined-constant">true</span>)
  .addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>)
      .port(<span class="integer">11222</span>);
RemoteCacheManager rmc = <span class="keyword">new</span> RemoteCacheManager(cb.build());</code></pre> </div> </div> <div class="paragraph"> <p>For a complete reference to the available configuration option please refer to the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/ConfigurationBuilder.html">ConfigurationBuilder</a>'s javadoc.</p> </div> <div class="paragraph"> <p>It is also possible to configure the Java Hot Rod client using a properties file, e.g.:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>infinispan.client.hotrod.transport_factory = org.infinispan.client.hotrod.impl.transport.tcp.TcpTransportFactory
infinispan.client.hotrod.server_list = 127.0.0.1:11222
infinispan.client.hotrod.marshaller = org.infinispan.commons.marshall.jboss.GenericJBossMarshaller
infinispan.client.hotrod.async_executor_factory = org.infinispan.client.hotrod.impl.async.DefaultAsyncExecutorFactory
infinispan.client.hotrod.default_executor_factory.pool_size = 1
infinispan.client.hotrod.default_executor_factory.queue_size = 10000
infinispan.client.hotrod.tcp_no_delay = true
infinispan.client.hotrod.request_balancing_strategy = org.infinispan.client.hotrod.impl.transport.tcp.RoundRobinBalancingStrategy
infinispan.client.hotrod.key_size_estimate = 64
infinispan.client.hotrod.value_size_estimate = 512
infinispan.client.hotrod.force_return_values = false
infinispan.client.hotrod.client_intelligence = HASH_DISTRIBUTION_AWARE
infinispan.client.hotrod.batch_Size = 10000

## below is connection pooling config
maxActive=-1
maxTotal = -1
maxIdle = -1
whenExhaustedAction = 1
timeBetweenEvictionRunsMillis=120000
minEvictableIdleTimeMillis=300000
testWhileIdle = true
minIdle = 1</code></pre> </div> </div> <div class="paragraph"> <p>The properties file is then passed to one of constructors of <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html#RemoteCacheManager-java.net.URL-">RemoteCacheManager</a>. You can use property substitution to replace values at runtime with <a href="https://docs.oracle.com/javase/tutorial/essential/environment/sysprop.html">Java system properties</a>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>infinispan.client.hotrod.server_list = ${server_list}</code></pre> </div> </div> <div class="paragraph"> <p>In the above example the value of the <em>infinispan.client.hotrod.server_list</em> property will be expanded to the value of the <em>server_list</em> Java system property.</p> </div> <div class="paragraph"> <p>which means that the value should be taken from a system property named jboss.bind.address.management and if it is not defined use 127.0.0.1.</p> </div> <div class="paragraph"> <p>For a complete reference of the available configuration options for the properties file please refer to <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/package-summary.html#package.description">remote client configuration</a> javadoc.</p> </div> </div> <div class="sect3"> <h4 id="authentication"><a class="anchor" href="#authentication"></a>6.1.2. Authentication</h4> <div class="paragraph"> <p>If the server has set up authentication, you need to configure your client accordingly. Depending on the mechs enabled on the server, the client must provide the required information.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This section is about client configuration. If you want to set up the server to require authentication, read the <a href="../server_guide/server_guide.html#security:hotrod_auth">Hot Rod server authentication</a> section. </td> </tr> </table> </div> <div class="sect4"> <h5 id="digest_md5"><a class="anchor" href="#digest_md5"></a>DIGEST-MD5</h5> <div class="paragraph"> <p>DIGEST-MD5 is the recommended approach for simple username/password authentication scenarios. If you are using the default realm on the server (<em>"ApplicationRealm"</em>), all you need to do is provide your credentials as follows:</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with DIGEST-MD5 authentication</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">myuser</span><span class="delimiter">&quot;</span></span>)
            .password(<span class="string"><span class="delimiter">&quot;</span><span class="content">qwer1234!</span><span class="delimiter">&quot;</span></span>);
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="plain"><a class="anchor" href="#plain"></a>PLAIN</h5> <div class="paragraph"> <p>The PLAIN mechanism is not really recommended unless the connection is also encrypted, as anyone can sniff the clear-text password being sent along the wire.</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with DIGEST-MD5 authentication</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .authentication()
            .saslMechanism(<span class="string"><span class="delimiter">&quot;</span><span class="content">PLAIN</span><span class="delimiter">&quot;</span></span>)
            .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">myuser</span><span class="delimiter">&quot;</span></span>)
            .password(<span class="string"><span class="delimiter">&quot;</span><span class="content">qwer1234!</span><span class="delimiter">&quot;</span></span>);
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="external"><a class="anchor" href="#external"></a>EXTERNAL</h5> <div class="paragraph"> <p>The EXTERNAL mechanism is special in that it doesn&#8217;t explicitly provide credentials but uses the client certificate as identity. In order for this to work, in addition to the <em>TrustStore</em> (to validate the server certificate) you need to provide a <em>KeyStore</em> (to supply the client certificate).</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with EXTERNAL authentication (client cert)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            <span class="comment">// TrustStore is a KeyStore which contains part of the server certificate chain (e.g. the CA Root public cert)</span>
            .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/truststore</span><span class="delimiter">&quot;</span></span>)
            .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray())
            <span class="comment">// KeyStore containing this client's own certificate</span>
            .keyStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/keystore</span><span class="delimiter">&quot;</span></span>)
            .keyStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">keystorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray())
        .authentication()
            .saslMechanism(<span class="string"><span class="delimiter">&quot;</span><span class="content">EXTERNAL</span><span class="delimiter">&quot;</span></span>);
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>For more details, read the <a href="#hr_encryption">Encryption</a> section below.</p> </div> </div> <div class="sect4"> <h5 id="gssapi_kerberos"><a class="anchor" href="#gssapi_kerberos"></a>GSSAPI (Kerberos)</h5> <div class="paragraph"> <p>GSSAPI/Kerberos requires a much more complex setup, but it is used heavily in enterprises with centralized authentication servers. To successfully authenticate with Kerberos, you need to create a <em>LoginContext</em>. This will obtain a Ticket Granting Ticket (TGT) which will be used as a token to authenticate with the service.</p> </div> <div class="paragraph"> <p>You will need to define a login module in a login configuration file:</p> </div> <div class="listingblock"> <div class="title">gss.conf</div> <div class="content"> <pre class="CodeRay highlight"><code>GssExample {
    com.sun.security.auth.module.Krb5LoginModule required client=TRUE;
};</code></pre> </div> </div> <div class="paragraph"> <p>If you are using the IBM JDK, the above becomes:</p> </div> <div class="listingblock"> <div class="title">gss-ibm.conf</div> <div class="content"> <pre class="CodeRay highlight"><code>GssExample {
    com.ibm.security.auth.module.Krb5LoginModule required client=TRUE;
};</code></pre> </div> </div> <div class="paragraph"> <p>You will also need to set the following system properties:</p> </div> <div class="paragraph"> <p>java.security.auth.login.config=gss.conf</p> </div> <div class="paragraph"> <p>java.security.krb5.conf=/etc/krb5.conf</p> </div> <div class="paragraph"> <p>The krb5.conf file is dependent on your environment and needs to point to your KDC. Ensure that you can authenticate via Kerberos using <em>kinit</em>.</p> </div> <div class="paragraph"> <p>Next up, configure your client as follows:</p> </div> <div class="listingblock"> <div class="title">Hot Rod client GSSAPI configuration</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">LoginContext</span> lc = <span class="keyword">new</span> <span class="predefined-type">LoginContext</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">GssExample</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> BasicCallbackHandler(<span class="string"><span class="delimiter">&quot;</span><span class="content">krb_user</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">krb_password</span><span class="delimiter">&quot;</span></span>.toCharArray()));
lc.login();
<span class="predefined-type">Subject</span> clientSubject = lc.getSubject();

ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .authentication()
            .enable()
            .serverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-server</span><span class="delimiter">&quot;</span></span>)
            .saslMechanism(<span class="string"><span class="delimiter">&quot;</span><span class="content">GSSAPI</span><span class="delimiter">&quot;</span></span>)
            .clientSubject(clientSubject)
            .callbackHandler(<span class="keyword">new</span> BasicCallbackHandler());
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>For brevity we used the same callback handler both for obtaining the client subject and for handling authentication in the SASL GSSAPI mech, however different callbacks will actually be invoked: NameCallback and PasswordCallback are needed to construct the client subject, while the AuthorizeCallback will be called during the SASL authentication.</p> </div> </div> <div class="sect4"> <h5 id="custom_callbackhandlers"><a class="anchor" href="#custom_callbackhandlers"></a>Custom CallbackHandlers</h5> <div class="paragraph"> <p>In all of the above examples, the Hot Rod client is setting up a default <em>CallbackHandler</em> for you that supplies the provided credentials to the SASL mechanism. For advanced scenarios it may be necessary to provide your own custom <em>CallbackHandler</em>:</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with authentication via callback</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyCallbackHandler</span> <span class="directive">implements</span> <span class="predefined-type">CallbackHandler</span> {
   <span class="directive">final</span> <span class="directive">private</span> <span class="predefined-type">String</span> username;
   <span class="directive">final</span> <span class="directive">private</span> <span class="type">char</span><span class="type">[]</span> password;
   <span class="directive">final</span> <span class="directive">private</span> <span class="predefined-type">String</span> realm;

   <span class="directive">public</span> MyCallbackHandler(<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> realm, <span class="type">char</span><span class="type">[]</span> password) {
      <span class="local-variable">this</span>.username = username;
      <span class="local-variable">this</span>.password = password;
      <span class="local-variable">this</span>.realm = realm;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> handle(<span class="predefined-type">Callback</span><span class="type">[]</span> callbacks) <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">UnsupportedCallbackException</span> {
      <span class="keyword">for</span> (<span class="predefined-type">Callback</span> callback : callbacks) {
         <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> <span class="predefined-type">NameCallback</span>) {
            <span class="predefined-type">NameCallback</span> nameCallback = (<span class="predefined-type">NameCallback</span>) callback;
            nameCallback.setName(username);
         } <span class="keyword">else</span> <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> <span class="predefined-type">PasswordCallback</span>) {
            <span class="predefined-type">PasswordCallback</span> passwordCallback = (<span class="predefined-type">PasswordCallback</span>) callback;
            passwordCallback.setPassword(password);
         } <span class="keyword">else</span> <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> <span class="predefined-type">AuthorizeCallback</span>) {
            <span class="predefined-type">AuthorizeCallback</span> authorizeCallback = (<span class="predefined-type">AuthorizeCallback</span>) callback;
            authorizeCallback.setAuthorized(authorizeCallback.getAuthenticationID().equals(
                  authorizeCallback.getAuthorizationID()));
         } <span class="keyword">else</span> <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> <span class="predefined-type">RealmCallback</span>) {
            <span class="predefined-type">RealmCallback</span> realmCallback = (<span class="predefined-type">RealmCallback</span>) callback;
            realmCallback.setText(realm);
         } <span class="keyword">else</span> {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedCallbackException</span>(callback);
         }
      }
   }
}

ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .authentication()
            .enable()
            .serverName(<span class="string"><span class="delimiter">&quot;</span><span class="content">myhotrodserver</span><span class="delimiter">&quot;</span></span>)
            .saslMechanism(<span class="string"><span class="delimiter">&quot;</span><span class="content">DIGEST-MD5</span><span class="delimiter">&quot;</span></span>)
            .callbackHandler(<span class="keyword">new</span> MyCallbackHandler(<span class="string"><span class="delimiter">&quot;</span><span class="content">myuser</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ApplicationRealm</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">qwer1234!</span><span class="delimiter">&quot;</span></span>.toCharArray()));
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>The actual type of callbacks that your CallbackHandler will need to be able to handle are mech-specific, so the above is just a simple example.</p> </div> </div> </div> <div class="sect3"> <h4 id="hr_encryption"><a class="anchor" href="#hr_encryption"></a>6.1.3. Encryption</h4> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This section is about client configuration. If you want to set up the server to require encryption, read the <a href="../server_guide/server_guide.html#security:hotrod_rest_encryption">Hot Rod server encryption</a> section. </td> </tr> </table> </div> <div class="paragraph"> <p>Encryption uses TLS/SSL, so it requires setting up an appropriate server certificate chain. Generally, a certificate chain looks like the following:</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./images/cert_chain.png" alt="cert chain"> </div> <div class="title">Figure 7. Certificate chain</div> </div> <div class="paragraph"> <p>In the above example there is one certificate authority <em>"CA"</em> which has issued a certificate for <em>"HotRodServer"</em>. In order for a client to trust the server, it needs at least a portion of the above chain (usually, just the public certificate for <em>"CA"</em>). This certificate needs to placed in a keystore and used as a <em>TrustStore</em> on the client and used as shown below:</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with TLS (server cert)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            <span class="comment">// TrustStore is a KeyStore which contains part of the server certificate chain (e.g. the CA Root public cert)</span>
            .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/truststore</span><span class="delimiter">&quot;</span></span>)
            .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="sect4"> <h5 id="sni"><a class="anchor" href="#sni"></a>SNI</h5> <div class="paragraph"> <p>The server may have been configured with TLS/SNI support (<a href="https://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication</a>). This means that the server is presenting multiple identities (probably bound to separate cache containers). The client can specify which identity to connect to by specifying its name:</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with SNI (server cert)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            .sniHostName(<span class="string"><span class="delimiter">&quot;</span><span class="content">myservername</span><span class="delimiter">&quot;</span></span>)
            <span class="comment">// TrustStore is a KeyStore which contains part of the server certificate chain (e.g. the CA Root public cert)</span>
            .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/truststore</span><span class="delimiter">&quot;</span></span>)
            .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="client_certificates"><a class="anchor" href="#client_certificates"></a>Client certificates</h5> <div class="paragraph"> <p>With the above configurations the client trusts the server. For increased security, a server administrator may have set up the server to require the client to offer a valid certificate for mutual trust. This kind of configuration requires the client to present its own certificate, usually issued by the same certificate authority as the server. This certificate must be stored in a keystore and used as follows:</p> </div> <div class="listingblock"> <div class="title">Hot Rod client configuration with TLS (server and client cert)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(<span class="integer">11222</span>)
    .security()
        .ssl()
            <span class="comment">// TrustStore is a KeyStore which contains part of the server certificate chain (e.g. the CA Root public cert)</span>
            .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/truststore</span><span class="delimiter">&quot;</span></span>)
            .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray())
            <span class="comment">// KeyStore containing this client's own certificate</span>
            .keyStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/keystore</span><span class="delimiter">&quot;</span></span>)
            .keyStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">keystorepassword</span><span class="delimiter">&quot;</span></span>.toCharArray())
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">secured</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Please read the <a href="{jdkroot}/technotes/tools/unix/keytool.html">KeyTool</a> documentation for more details on KeyStores. Additionally, the <a href="http://keystore-explorer.org/">KeyStore Explorer</a> is a great GUI tool for easily managing KeyStores.</p> </div> </div> </div> <div class="sect3"> <h4 id="hr_basic_api"><a class="anchor" href="#hr_basic_api"></a>6.1.4. Basic API</h4> <div class="paragraph"> <p>Below is a sample code snippet on how the client API can be used to store or retrieve information from a Hot Rod server using the Java Hot Rod client. It assumes that a Hot Rod server has been started bound to the default location (localhost:11222)</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//API entry point, by default it connects to localhost:11222</span>
CacheContainer cacheContainer = <span class="keyword">new</span> RemoteCacheManager();

<span class="comment">//obtain a handle to the remote default cache</span>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheContainer.getCache();

<span class="comment">//now add something to the cache and make sure it is there</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>).equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);

<span class="comment">//remove the data</span>
cache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> !cache.containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>) : <span class="string"><span class="delimiter">&quot;</span><span class="content">Value must have been removed!</span><span class="delimiter">&quot;</span></span>;</code></pre> </div> </div> <div class="paragraph"> <p>The client API maps the local API: <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> corresponds to <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/DefaultCacheManager.html">DefaultCacheManager</a> (both implement <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/CacheContainer.html">CacheContainer</a> ). This common API facilitates an easy migration from local calls to remote calls through Hot Rod: all one needs to do is switch between <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/DefaultCacheManager.html">DefaultCacheManager</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> - which is further simplified by the common <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/CacheContainer.html">CacheContainer</a> interface that both inherit.</p> </div> </div> <div class="sect3"> <h4 id="remotecache_keyset_entryset_values"><a class="anchor" href="#remotecache_keyset_entryset_values"></a>6.1.5. RemoteCache(.keySet|.entrySet|.values)</h4> <div class="paragraph"> <p>The collection methods <code>keySet</code>, <code>entrySet</code> and <code>values</code> are backed by the remote cache. That is that every method is called back into the <code>RemoteCache</code>. This is useful as it allows for the various keys, entries or values to be retrieved lazily, and not requiring them all be stored in the client memory at once if the user does not want. These collections adhere to the <code>Map</code> specification being that <code>add</code> and <code>addAll</code> are not supported but all other methods are supported.</p> </div> <div class="paragraph"> <p>One thing to note is the <code>Iterator.remove</code> and <code>Set.remove</code> or <code>Collection.remove</code> methods require more than 1 round trip to the server to operate. You can check out the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> Javadoc to see more details about these and the other methods.</p> </div> <div class="paragraph"> <p><strong>Iterator Usage</strong></p> </div> <div class="paragraph"> <p>The iterator method of these collections uses <code>retrieveEntries</code> internally, which is described below. If you notice <code>retrieveEntries</code> takes an argument for the batch size. There is no way to provide this to the iterator. As such the batch size can be configured via system property <code>infinispan.client.hotrod.batch_size</code> or through the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuraion/ConfigurationBuilder.html#batchSize-int-">ConfigurationBuilder</a> when configuring the <code>RemoteCacheManager</code>.</p> </div> <div class="paragraph"> <p>Also the <code>retrieveEntries</code> iterator returned is <code>Closeable</code> as such the iterators from <code>keySet</code>, <code>entrySet</code> and <code>values</code> return an <code>AutoCloseable</code> variant. Therefore you should always close these `Iterator`s when you are done with them.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (CloseableIterator&lt;Entry&lt;K, V&gt;&gt; iterator = remoteCache.entrySet().iterator) {
 ...
}</code></pre> </div> </div> <div class="paragraph"> <p><strong>What if I want a deep copy and not a backing collection?</strong></p> </div> <div class="paragraph"> <p>Previous version of <code>RemoteCache</code> allowed for the retrieval of a deep copy of the <code>keySet</code>. This is still possible with the new backing map, you just have to copy the contents yourself. Also you can do this with <code>entrySet</code> and <code>values</code>, which we didn&#8217;t support before.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;K&gt; keysCopy = remoteCache.keySet().stream().collect(Collectors.toSet());</code></pre> </div> </div> <div class="paragraph"> <p>Please use extreme cautiong with this as a large number of keys can and will cause OutOfMemoryError in the client.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span> keys = remoteCache.keySet();</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="remote_iterator"><a class="anchor" href="#remote_iterator"></a>6.1.6. Remote Iterator</h4> <div class="paragraph"> <p>Alternatively, if memory is a concern (different batch size) or you wish to do server side filtering or conversion), use the remote iterator api to retrieve entries from the server. With this method you can limit the entries that are retrieved or even returned a converted value if you dont' need all properties of your entry.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Retrieve all entries in batches of 1000</span>
<span class="type">int</span> batchSize = <span class="integer">1000</span>;
<span class="keyword">try</span> (CloseableIterator&lt;Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt;&gt; iterator = remoteCache.retrieveEntries(<span class="predefined-constant">null</span>, batchSize)) {
     <span class="keyword">while</span>(iterator.hasNext()) {
        <span class="comment">// Do something</span>
     }
}

<span class="comment">// Filter by segment</span>
<span class="predefined-type">Set</span>&lt;<span class="predefined-type">Integer</span>&gt; segments = ...
try (CloseableIterator&lt;Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt;&gt; iterator = remoteCache.retrieveEntries(<span class="predefined-constant">null</span>, segments, batchSize)) {
     <span class="keyword">while</span>(iterator.hasNext()) {
        <span class="comment">// Do something</span>
     }
}

<span class="comment">// Filter by custom filter</span>
<span class="keyword">try</span> (CloseableIterator&lt;Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt;&gt; iterator = remoteCache.retrieveEntries(<span class="string"><span class="delimiter">&quot;</span><span class="content">myFilterConverterFactory</span><span class="delimiter">&quot;</span></span>, segments, batchSize)) {
     <span class="keyword">while</span>(iterator.hasNext()) {
        <span class="comment">// Do something</span>
     }
}</code></pre> </div> </div> <div class="paragraph"> <p>In order to use custom filters, it&#8217;s necessary to deploy them first in the server. Follow the steps:</p> </div> <div class="ulist"> <ul> <li> <p>Create a factory for the filter extending <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/filter/KeyValueFilterConverterFactory.html">KeyValueFilterConverterFactory</a>, annotated with @NamedFactory containing the name of the factory, example:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.io.Serializable</span>;

<span class="keyword">import</span> <span class="include">org.infinispan.filter.AbstractKeyValueFilterConverter</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.KeyValueFilterConverter</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.KeyValueFilterConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.NamedFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.metadata.Metadata</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">myFilterConverterFactory</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyKeyValueFilterConverterFactory</span> <span class="directive">implements</span> KeyValueFilterConverterFactory {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> KeyValueFilterConverter&lt;<span class="predefined-type">String</span>, SampleEntity1, SampleEntity2&gt; getFilterConverter() {
      <span class="keyword">return</span> <span class="keyword">new</span> MyKeyValueFilterConverter();
   }
   <span class="comment">// Filter implementation. Should be serializable or externalizable for DIST caches</span>
   <span class="directive">static</span> <span class="type">class</span> <span class="class">MyKeyValueFilterConverter</span> <span class="directive">extends</span> AbstractKeyValueFilterConverter&lt;<span class="predefined-type">String</span>, SampleEntity1, SampleEntity2&gt; <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
      <span class="annotation">@Override</span>
      <span class="directive">public</span> SampleEntity2 filterAndConvert(<span class="predefined-type">String</span> key, SampleEntity1 entity, Metadata metadata) {
         <span class="comment">// returning null will case the entry to be filtered out</span>
         <span class="comment">// return SampleEntity2 will convert from the cache type SampleEntity1</span>
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> MediaType format() {
         <span class="comment">// returns the MediaType that data should be presented to this converter.</span>
         <span class="comment">// When ommitted, the server will use &quot;application/x-java-object&quot;.</span>
         <span class="comment">// Returning null will cause the filter/converter to be done in the storage format.</span>
      }
   }
}</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Create a jar with a <code>META-INF/services/org.infinispan.filter.KeyValueFilterConverterFactory</code> file and within it, write the fully qualified class name of the filter factory class implementation.</p> </li> <li> <p>Optional: If the filter uses custom key/value classes, these must be included in the JAR so that the filter can correctly unmarshall key and/or value instances.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="hr_versioned_api"><a class="anchor" href="#hr_versioned_api"></a>6.1.7. Versioned API</h4> <div class="paragraph"> <p>A RemoteCacheManager provides instances of <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interface that represents a handle to the named or default cache on the remote cluster. API wise, it extends the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html">Cache</a> interface to which it also adds some new methods, including the so called versioned API. Please find below some examples of this API link:#server_hotrod_failover[but to understand the motivation behind it, make sure you read this section.</p> </div> <div class="paragraph"> <p>The code snippet bellow depicts the usage of these versioned methods:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// To use the versioned API, remote classes are specifically needed</span>
RemoteCacheManager remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager();
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache();

remoteCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);
RemoteCache.VersionedValue valueBinary = remoteCache.getVersioned(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// removal only takes place only if the version has not been changed</span>
<span class="comment">// in between. (a new version is associated with 'car' key on each change)</span>
<span class="keyword">assert</span> remoteCache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, valueBinary.getVersion());
<span class="keyword">assert</span> !cache.containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>In a similar way, for replace:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">remoteCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ferrari</span><span class="delimiter">&quot;</span></span>);
RemoteCache.VersionedValue valueBinary = remoteCache.getVersioned(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> remoteCache.replace(<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">lamborghini</span><span class="delimiter">&quot;</span></span>, valueBinary.getVersion());</code></pre> </div> </div> <div class="paragraph"> <p>For more details on versioned operations refer to <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> 's javadoc.</p> </div> </div> <div class="sect3"> <h4 id="streaming_api"><a class="anchor" href="#streaming_api"></a>6.1.8. Streaming API</h4> <div class="paragraph"> <p>When sending / receiving large objects, it might make sense to stream them between the client and the server. The Streaming API implements methods similar to the <a href="#hr_basic_api">Hot Rod Basic API</a> and <a href="#hr_versioned_api">Hot Rod Versioned API</a> described above but, instead of taking the value as a parameter, they return instances of InputStream and OutputStream. The following example shows how one would write a potentially large object:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteStreamingCache&lt;<span class="predefined-type">String</span>&gt; streamingCache = remoteCache.streaming();
<span class="predefined-type">OutputStream</span> os = streamingCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">a_large_object</span><span class="delimiter">&quot;</span></span>);
os.write(...);
os.close();</code></pre> </div> </div> <div class="paragraph"> <p>Reading such an object through streaming:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteStreamingCache&lt;<span class="predefined-type">String</span>&gt; streamingCache = remoteCache.streaming();
<span class="predefined-type">InputStream</span> is = streamingCache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">a_large_object</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">for</span>(<span class="type">int</span> b = is.read(); b &gt;= <span class="integer">0</span>; b = is.read()) {
   ...
}
is.close();</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The streaming API does <strong>not</strong> apply marshalling/unmarshalling to the values. For this reason you cannot access the same entries using both the streaming and non-streaming API at the same time, unless you provide your own marshaller to detect this situation. </td> </tr> </table> </div> <div class="paragraph"> <p>The InputStream returned by the <code>RemoteStreamingCache.get(K key)</code> method implements the <code>VersionedMetadata</code> interface, so you can retrieve version and expiration information:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteStreamingCache&lt;<span class="predefined-type">String</span>&gt; streamingCache = remoteCache.streaming();
<span class="predefined-type">InputStream</span> is = streamingCache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">a_large_object</span><span class="delimiter">&quot;</span></span>);
<span class="type">int</span> version = ((VersionedMetadata) is).getVersion();
<span class="keyword">for</span>(<span class="type">int</span> b = is.read(); b &gt;= <span class="integer">0</span>; b = is.read()) {
   ...
}
is.close();</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Conditional write methods (<code>putIfAbsent</code>, <code>replace</code>) only perform the actual condition check once the value has been completely sent to the server (i.e. when the <code>close()</code> method has been invoked on the <code>OutputStream</code>. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="creating_event_listeners"><a class="anchor" href="#creating_event_listeners"></a>6.1.9. Creating Event Listeners</h4> <div class="paragraph"> <p>Java Hot Rod clients can register listeners to receive cache-entry level events. Cache entry created, modified and removed events are supported.</p> </div> <div class="paragraph"> <p>Creating a client listener is very similar to embedded listeners, except that different annotations and event classes are used. Here&#8217;s an example of a client listener that prints out each event received:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.annotation</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.event</span>.*;

<span class="annotation">@ClientListener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">EventPrintListener</span> {

   <span class="annotation">@ClientCacheEntryCreated</span>
   <span class="directive">public</span> <span class="type">void</span> handleCreatedEvent(ClientCacheEntryCreatedEvent e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

   <span class="annotation">@ClientCacheEntryModified</span>
   <span class="directive">public</span> <span class="type">void</span> handleModifiedEvent(ClientCacheEntryModifiedEvent e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

   <span class="annotation">@ClientCacheEntryRemoved</span>
   <span class="directive">public</span> <span class="type">void</span> handleRemovedEvent(ClientCacheEntryRemovedEvent e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

}</code></pre> </div> </div> <div class="paragraph"> <p><code>ClientCacheEntryCreatedEvent</code> and <code>ClientCacheEntryModifiedEvent</code> instances provide information on the affected key, and the version of the entry. This version can be used to invoke conditional operations on the server, such as <code>replaceWithVersion</code> or <code>removeWithVersion</code>.</p> </div> <div class="paragraph"> <p><code>ClientCacheEntryRemovedEvent</code> events are only sent when the remove operation succeeds. In other words, if a remove operation is invoked but no entry is found or no entry should be removed, no event is generated. Users interested in removed events, even when no entry was removed, can develop event customization logic to generate such events. More information can be found in the <a href="#customizing_events">customizing client events section</a>.</p> </div> <div class="paragraph"> <p>All <code>ClientCacheEntryCreatedEvent</code>, <code>ClientCacheEntryModifiedEvent</code> and <code>ClientCacheEntryRemovedEvent</code> event instances also provide a <code>boolean isCommandRetried()</code> method that will return true if the write command that caused this had to be retried again due to a topology change. This could be a sign that this event has been duplicated or another event was dropped and replaced (eg: ClientCacheEntryModifiedEvent replaced ClientCacheEntryCreatedEvent).</p> </div> <div class="paragraph"> <p>Once the client listener implementation has been created, it needs to be registered with the server. To do so, execute:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener());</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="removing_event_listeners"><a class="anchor" href="#removing_event_listeners"></a>6.1.10. Removing Event Listeners</h4> <div class="paragraph"> <p>When an client event listener is not needed any more, it can be removed:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EventPrintListener listener = ...
cache.removeClientListener(listener);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="filtering_events"><a class="anchor" href="#filtering_events"></a>6.1.11. Filtering Events</h4> <div class="paragraph"> <p>In order to avoid inundating clients with events, users can provide filtering functionality to limit the number of events fired by the server for a particular client listener. To enable filtering, a cache event filter factory needs to be created that produces filter instances:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.NamedFactory</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-filter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">StaticCacheEventFilterFactory</span> <span class="directive">implements</span> CacheEventFilterFactory {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> CacheEventFilterFactory&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; getFilter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> StaticCacheEventFilter();
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// needed when running in a cluster</span>
<span class="type">class</span> <span class="class">StaticCacheEventFilter</span> <span class="directive">implements</span> CacheEventFilter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;, <span class="predefined-type">Serializable</span> {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> accept(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="keyword">if</span> (key.equals(<span class="integer">1</span>)) <span class="comment">// static key</span>
         <span class="keyword">return</span> <span class="predefined-constant">true</span>;

      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>The cache event filter factory instance defined above creates filter instances which statically filter out all entries except the one whose key is <code>1</code>.</p> </div> <div class="paragraph"> <p>To be able to register a listener with this cache event filter factory, the factory has to be given a unique name, and the Hot Rod server needs to be plugged with the name and the cache event filter factory instance. Plugging the Infinispan Server with a custom filter involves the following steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file with the filter implementation within it.</p> </li> <li> <p>Optional: If the cache uses custom key/value classes, these must be included in the JAR so that the callbacks can be executed with the correctly unmarshalled key and/or value instances. If the client listener has <code>useRawData</code> enabled, this is not necessary since the callback key/value instances will be provided in binary format.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.notifications.cachelistener.filter.CacheEventFilterFactory</code> file within the JAR file and within it, write the fully qualified class name of the filter class implementation.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> <div class="paragraph"> <p>On top of that, the client listener needs to be linked with this cache event filter factory by adding the factory&#8217;s name to the @ClientListener annotation:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientListener</span>(filterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-filter</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">EventPrintListener</span> { ... }</code></pre> </div> </div> <div class="paragraph"> <p>And, register the listener with the server:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener());</code></pre> </div> </div> <div class="paragraph"> <p>Dynamic filter instances that filter based on parameters provided when the listener is registered are also possible. Filters use the parameters received by the filter factories to enable this option. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventFilter</span>;

<span class="type">class</span> <span class="class">DynamicCacheEventFilterFactory</span> <span class="directive">implements</span> CacheEventFilterFactory {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> CacheEventFilter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; getFilter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> DynamicCacheEventFilter(params);
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// needed when running in a cluster</span>
<span class="type">class</span> <span class="class">DynamicCacheEventFilter</span> <span class="directive">implements</span> CacheEventFilter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params;

   DynamicCacheEventFilter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="local-variable">this</span>.params = params;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> accept(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="keyword">if</span> (key.equals(params[<span class="integer">0</span>])) <span class="comment">// dynamic key</span>
         <span class="keyword">return</span> <span class="predefined-constant">true</span>;

      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>The dynamic parameters required to do the filtering are provided when the listener is registered:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener(), <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1</span>}, <span class="predefined-constant">null</span>);</code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Filter instances have to marshallable when they are deployed in a cluster so that the filtering can happen right where the event is generated, even if the even is generated in a different node to where the listener is registered. To make them marshallable, either make them extend <code>Serializable</code>, <code>Externalizable</code>, or provide a custom <code>Externalizer</code> for them. </td> </tr> </table> </div> <div class="sect4"> <h5 id="skipping_notifications"><a class="anchor" href="#skipping_notifications"></a>Skipping Notifications</h5> <div class="paragraph"> <p>Include the <code>SKIP_LISTENER_NOTIFICATION</code> flag when calling remote API methods to perform operations without getting event notifications from the server. For example, to prevent listener notifications when creating or modifying values, set the flag as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">remoteCache.withFlags(Flag.SKIP_LISTENER_NOTIFICATION).put(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="customizing_events"><a class="anchor" href="#customizing_events"></a>6.1.12. Customizing Events</h4> <div class="paragraph"> <p>The events generated by default contain just enough information to make the event relevant but they avoid cramming too much information in order to reduce the cost of sending them. Optionally, the information shipped in the events can be customised in order to contain more information, such as values, or to contain even less information. This customization is done with <code>CacheEventConverter</code> instances generated by a <code>CacheEventConverterFactory</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverter</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.filter.NamedFactory</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-converter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">StaticConverterFactory</span> <span class="directive">implements</span> CacheEventConverterFactory {
   <span class="directive">final</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; staticConverter = <span class="keyword">new</span> StaticCacheEventConverter();
   <span class="directive">public</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; getConverter(<span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> staticConverter;
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// needed when running in a cluster</span>
<span class="type">class</span> <span class="class">StaticCacheEventConverter</span> <span class="directive">implements</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">public</span> CustomEvent convert(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata, <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, newValue);
   }
}

<span class="comment">// Needs to be Serializable, Externalizable or marshallable with Infinispan Externalizers</span>
<span class="comment">// regardless of cluster or local caches</span>
<span class="directive">static</span> <span class="type">class</span> <span class="class">CustomEvent</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Integer</span> key;
   <span class="directive">final</span> <span class="predefined-type">String</span> value;
   CustomEvent(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> value) {
      <span class="local-variable">this</span>.key = key;
      <span class="local-variable">this</span>.value = value;
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>In the example above, the converter generates a new custom event which includes the value as well as the key in the event. This will result in bigger event payloads compared with default events, but if combined with filtering, it can reduce its network bandwidth cost.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> The target type of the converter must be either <code>Serializable</code> or <code>Externalizable</code>. In this particular case of converters, providing an Externalizer will not work by default since the default Hot Rod client marshaller does not support them. </td> </tr> </table> </div> <div class="paragraph"> <p>Handling custom events requires a slightly different client listener implementation to the one demonstrated previously. To be more precise, it needs to handle <code>ClientCacheEntryCustomEvent</code> instances:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.annotation</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.event</span>.*;

<span class="annotation">@ClientListener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomEventPrintListener</span> {

   <span class="annotation">@ClientCacheEntryCreated</span>
   <span class="annotation">@ClientCacheEntryModified</span>
   <span class="annotation">@ClientCacheEntryRemoved</span>
   <span class="directive">public</span> <span class="type">void</span> handleCustomEvent(ClientCacheEntryCustomEvent&lt;CustomEvent&gt; e) {
      <span class="predefined-type">System</span>.out.println(e);
   }

}</code></pre> </div> </div> <div class="paragraph"> <p>The <code>ClientCacheEntryCustomEvent</code> received in the callback exposes the custom event via <code>getEventData</code> method, and the <code>getType</code> method provides information on whether the event generated was as a result of cache entry creation, modification or removal.</p> </div> <div class="paragraph"> <p>Similar to filtering, to be able to register a listener with this converter factory, the factory has to be given a unique name, and the Hot Rod server needs to be plugged with the name and the cache event converter factory instance. Plugging the Infinispan Server with an event converter involves the following steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file with the converter implementation within it.</p> </li> <li> <p>Optional: If the cache uses custom key/value classes, these must be included in the JAR so that the callbacks can be executed with the correctly unmarshalled key and/or value instances. If the client listener has <code>useRawData</code> enabled, this is not necessary since the callback key/value instances will be provided in binary format.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</code> file within the JAR file and within it, write the fully qualified class name of the converter class implementation.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> <div class="paragraph"> <p>On top of that, the client listener needs to be linked with this converter factory by adding the factory&#8217;s name to the @ClientListener annotation:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientListener</span>(converterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">static-converter</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomEventPrintListener</span> { ... }</code></pre> </div> </div> <div class="paragraph"> <p>And, register the listener with the server:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> CustomEventPrintListener());</code></pre> </div> </div> <div class="paragraph"> <p>Dynamic converter instances that convert based on parameters provided when the listener is registered are also possible. Converters use the parameters received by the converter factories to enable this option. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverter</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-converter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">DynamicCacheEventConverterFactory</span> <span class="directive">implements</span> CacheEventConverterFactory {
   <span class="directive">public</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; getConverter(<span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> DynamicCacheEventConverter(params);
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers needed when running in a cluster</span>
<span class="type">class</span> <span class="class">DynamicCacheEventConverter</span> <span class="directive">implements</span> CacheEventConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params;

   DynamicCacheEventConverter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="local-variable">this</span>.params = params;
   }

   <span class="directive">public</span> CustomEvent convert(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="comment">// If the key matches a key given via parameter, only send the key information</span>
      <span class="keyword">if</span> (params[<span class="integer">0</span>].equals(key))
         <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, <span class="predefined-constant">null</span>);

      <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, newValue);
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>The dynamic parameters required to do the conversion are provided when the listener is registered:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> EventPrintListener(), <span class="predefined-constant">null</span>, <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1</span>});</code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Converter instances have to marshallable when they are deployed in a cluster, so that the conversion can happen right where the event is generated, even if the even is generated in a different node to where the listener is registered. To make them marshallable, either make them extend <code>Serializable</code>, <code>Externalizable</code>, or provide a custom <code>Externalizer</code> for them. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="filter_and_custom_events"><a class="anchor" href="#filter_and_custom_events"></a>6.1.13. Filter and Custom Events</h4> <div class="paragraph"> <p>If you want to do both event filtering and customization, it&#8217;s easier to implement <code>org.infinispan.notifications.cachelistener.filter.CacheEventFilterConverter</code> which allows both filter and customization to happen in a single step. For convenience, it&#8217;s recommended to extend <code>org.infinispan.notifications.cachelistener.filter.AbstractCacheEventFilterConverter</code> instead of implementing <code>org.infinispan.notifications.cachelistener.filter.CacheEventFilterConverter</code> directly. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverterFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.filter.CacheEventConverter</span>;

<span class="annotation">@NamedFactory</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-filter-converter</span><span class="delimiter">&quot;</span></span>)
<span class="type">class</span> <span class="class">DynamicCacheEventFilterConverterFactory</span> <span class="directive">implements</span> CacheEventFilterConverterFactory {
   <span class="directive">public</span> CacheEventFilterConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt; getFilterConverter(<span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="keyword">return</span> <span class="keyword">new</span> DynamicCacheEventFilterConverter(params);
   }
}

<span class="comment">// Serializable, Externalizable or marshallable with Infinispan Externalizers needed when running in a cluster</span>
<span class="comment">//</span>
<span class="type">class</span> <span class="class">DynamicCacheEventFilterConverter</span> <span class="directive">extends</span> AbstractCacheEventFilterConverter&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, CustomEvent&gt;, <span class="predefined-type">Serializable</span> {
   <span class="directive">final</span> <span class="predefined-type">Object</span><span class="type">[]</span> params;

   DynamicCacheEventFilterConverter(<span class="predefined-type">Object</span><span class="type">[]</span> params) {
      <span class="local-variable">this</span>.params = params;
   }

   <span class="directive">public</span> CustomEvent filterAndConvert(<span class="predefined-type">Integer</span> key, <span class="predefined-type">String</span> oldValue, Metadata oldMetadata,
         <span class="predefined-type">String</span> newValue, Metadata newMetadata, EventType eventType) {
      <span class="comment">// If the key matches a key given via parameter, only send the key information</span>
      <span class="keyword">if</span> (params[<span class="integer">0</span>].equals(key))
         <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, <span class="predefined-constant">null</span>);

      <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(key, newValue);
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>Similar to filters and converters, to be able to register a listener with this combined filter/converter factory, the factory has to be given a unique name via the <code>@NamedFactory</code> annotation, and the Hot Rod server needs to be plugged with the name and the cache event converter factory instance. Plugging the Infinispan Server with an event converter involves the following steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file with the converter implementation within it.</p> </li> <li> <p>Optional: If the cache uses custom key/value classes, these must be included in the JAR so that the callbacks can be executed with the correctly unmarshalled key and/or value instances. If the client listener has <code>useRawData</code> enabled, this is not necessary since the callback key/value instances will be provided in binary format.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.notifications.cachelistener.filter.CacheEventFilterConverterFactory</code> file within the JAR file and within it, write the fully qualified class name of the converter class implementation.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> <div class="paragraph"> <p>From a client perspective, to be able to use the combined filter and converter class, the client listener must define the same filter factory and converter factory names, e.g.:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientListener</span>(filterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-filter-converter</span><span class="delimiter">&quot;</span></span>, converterFactoryName = <span class="string"><span class="delimiter">&quot;</span><span class="content">dynamic-filter-converter</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomEventPrintListener</span> { ... }</code></pre> </div> </div> <div class="paragraph"> <p>The dynamic parameters required in the example above are provided when the listener is registered via either filter or converter parameters. If filter parameters are non-empty, those are used, otherwise, the converter parameters:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;?, ?&gt; cache = ...
cache.addClientListener(<span class="keyword">new</span> CustomEventPrintListener(), <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1</span>}, <span class="predefined-constant">null</span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="event_marshalling"><a class="anchor" href="#event_marshalling"></a>6.1.14. Event Marshalling</h4> <div class="paragraph"> <p>Hot Rod servers can store data in different formats, but in spite of that, Java Hot Rod client users can still develop <code>CacheEventConverter</code> or <code>CacheEventFilter</code> instances that work on typed objects. By default, filters and converter will use data as POJO (application/x-java-object) but it is possible to override the desired format by overriding the method <code>format()</code> from the filter/converter. If the format returns <code>null</code>, the filter/converter will receive data as it&#8217;s stored.</p> </div> <div class="paragraph"> <p>As indicated in the <a href="#hot_rod_marshalling_data">Marshalling Data</a> section, Hot Rod Java clients can be configured to use a different <code>org.infinispan.commons.marshall.Marshaller</code> instance. If doing this and deploying <code>CacheEventConverter</code> or <code>CacheEventFilter</code> instances, to be able to present filters/converter with Java Objects rather than marshalled content, the server needs to be able to convert between objects and the binary format produced by the marshaller.</p> </div> <div class="paragraph"> <p>To deploy a Marshaller instance server-side, follow a similar method to the one used to deploy <code>CacheEventConverter</code> or <code>CacheEventFilter</code> instances:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a JAR file with the converter implementation within it.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.commons.marshall.Marshaller</code> file within the JAR file and within it, write the fully qualified class name of the marshaller class implementation.</p> </li> <li> <p>Deploy the JAR file in the Infinispan Server.</p> </li> </ol> </div> <div class="paragraph"> <p>Note that the Marshaller could be deployed in either a separate jar, or in the same jar as the <code>CacheEventConverter</code> and/or <code>CacheEventFilter</code> instances.</p> </div> <div class="sect4"> <h5 id="protostream_deployment"><a class="anchor" href="#protostream_deployment"></a>Deploying Protostream Marshallers</h5> <div class="paragraph"> <p>If a cache stores protobuf content, as it happens when using protostream marshaller in the Hot Rod client, it&#8217;s not necessary to deploy a custom marshaller since the format is already support by the server: there are transcoders from protobuf format to most common formats like JSON and POJO.</p> </div> <div class="paragraph"> <p>When using filters/converters with those caches, and it&#8217;s desirable to use filter/converters with Java Objects rather binary prototobuf data, it&#8217;s necessary to deploy the extra protostream marshallers so that the server can unmarshall the data before filtering/converting. To do so, follow these steps:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a jar and include an implementation of the interface <code>org.infinispan.query.remote.client.ProtostreamSerializationContextInitializer</code>, adding extra marshallers and optionally extra protobuf files to the cache manager&#8217;s Serialization context.</p> </li> <li> <p>Create a <code>META-INF/services/org.infinispan.query.remote.client.ProtostreamSerializationContextInitializer</code> file within the JAR file containing the fully qualified class name of the <code>ProtostreamSerializationContextInitializer</code> class implementation.</p> </li> <li> <p>Create a META-INF/MANIFEST.MF with <code>Dependencies: org.infinispan.protostream, org.infinispan.remote-query.client</code></p> </li> <li> <p>Deploy the JAR file in the Infinispan Server in the <code>standalone/deployments</code> folder</p> </li> <li> <p>Configure this deployment in the desired cache manager:</p> </li> </ol> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;modules&gt;</span>
     <span class="tag">&lt;module</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">deployment.my-file.jar</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/modules&gt;</span>
   ...
<span class="tag">&lt;/cache-container&gt;</span></code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> The deployment must be available during the server startup! </td> </tr> </table> </div> </div> </div> <div class="sect3"> <h4 id="listener_state_handling"><a class="anchor" href="#listener_state_handling"></a>6.1.15. Listener State Handling</h4> <div class="paragraph"> <p>Client listener annotation has an optional <code>includeCurrentState</code> attribute that specifies whether state will be sent to the client when the listener is added or when there&#8217;s a failover of the listener.</p> </div> <div class="paragraph"> <p>By default, <code>includeCurrentState</code> is false, but if set to true and a client listener is added in a cache already containing data, the server iterates over the cache contents and sends an event for each entry to the client as a <code>ClientCacheEntryCreated</code> (or custom event if configured). This allows clients to build some local data structures based on the existing content. Once the content has been iterated over, events are received as normal, as cache updates are received. If the cache is clustered, the entire cluster wide contents are iterated over.</p> </div> <div class="paragraph"> <p><code>includeCurrentState</code> also controls whether state is received when the node where the client event listener is registered fails and it&#8217;s moved to a different node. The next section discusses this topic in depth.</p> </div> </div> <div class="sect3"> <h4 id="listener_failure_handling"><a class="anchor" href="#listener_failure_handling"></a>6.1.16. Listener Failure Handling</h4> <div class="paragraph"> <p>When a Hot Rod client registers a client listener, it does so in a single node in a cluster. If that node fails, the Java Hot Rod client detects that transparently and fails over all listeners registered in the node that failed to another node.</p> </div> <div class="paragraph"> <p>During this fail over the client might miss some events. To avoid missing these events, the client listener annotation contains an optional parameter called <code>includeCurrentState</code> which if set to true, when the failover happens, the cache contents can iterated over and <code>ClientCacheEntryCreated</code> events (or custom events if configured) are generated. By default, <code>includeCurrentState</code> is set to false.</p> </div> <div class="paragraph"> <p>Java Hot Rod clients can be made aware of such fail over event by adding a callback to handle it:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ClientCacheFailover</span>
<span class="directive">public</span> <span class="type">void</span> handleFailover(ClientCacheFailoverEvent e) {
  ...
}</code></pre> </div> </div> <div class="paragraph"> <p>This is very useful in use cases where the client has cached some data, and as a result of the fail over, taking in account that some events could be missed, it could decide to clear any locally cached data when the fail over event is received, with the knowledge that after the fail over event, it will receive events for the contents of the entire cache.</p> </div> </div> <div class="sect3"> <h4 id="near_caching"><a class="anchor" href="#near_caching"></a>6.1.17. Near Caching</h4> <div class="paragraph"> <p>The Java Hot Rod client can be optionally configured with a near cache, which means that the Hot Rod client can keep a local cache that stores recently used data. Enabling near caching can significantly improve the performance of read operations <code>get</code> and <code>getVersioned</code> since data can potentially be located locally within the Hot Rod client instead of having to go remote.</p> </div> <div class="paragraph"> <p>To enable near caching, the user must set the near cache mode to <code>INVALIDATED</code>. By doing that near cache is populated upon retrievals from the server via calls to <code>get</code> or <code>getVersioned</code> operations. When near cached entries are updated or removed server-side, the cached near cache entries are invalidated. If a key is requested after it&#8217;s been invalidated, it&#8217;ll have to be re-fetched from the server.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> You should not use <code>maxIdle</code> expiration with near caches, as near-cache reads will not propagate the last access change to the server and to the other clients. </td> </tr> </table> </div> <div class="paragraph"> <p>When near cache is enabled, its size must be configured by defining the maximum number of entries to keep in the near cache. When the maximum is reached, near cached entries are evicted using a least-recently-used (LRU) algorithm. If providing 0 or a negative value, it is assumed that the near cache is unbounded.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Users should be careful when configuring near cache to be unbounded since it shifts the responsibility to keep the near cache&#8217;s size within the boundaries of the client JVM to the user. </td> </tr> </table> </div> <div class="paragraph"> <p>The Hot Rod client&#8217;s near cache mode is configured using the <code>NearCacheMode</code> enumeration and calling:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.NearCacheMode</span>;
...

<span class="comment">// Unbounded invalidated near cache</span>
ConfigurationBuilder unbounded = <span class="keyword">new</span> ConfigurationBuilder();
unbounded.nearCache().mode(NearCacheMode.INVALIDATED).maxEntries(-<span class="integer">1</span>);

<span class="comment">// Bounded invalidated near cache</span>
ConfigurationBuilder bounded = <span class="keyword">new</span> ConfigurationBuilder();
bounded.nearCache().mode(NearCacheMode.INVALIDATED).maxEntries(<span class="integer">100</span>);</code></pre> </div> </div> <div class="paragraph"> <p>Since the configuration is shared by all caches obtained from a single <code>RemoteCacheManager</code>, you may not want to enable near-caching for all of them. You can use the <code>cacheNamePattern</code> configuration attribute to define a regular expression which matches the names of the caches for which you want near-caching. Caches whose name don&#8217;t match the regular expression, will not have near-caching enabled.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Bounded invalidated near cache with pattern matching</span>
ConfigurationBuilder bounded = <span class="keyword">new</span> ConfigurationBuilder();
bounded.nearCache()
  .mode(NearCacheMode.INVALIDATED)
  .maxEntries(<span class="integer">100</span>)
  .cacheNamePattern(<span class="string"><span class="delimiter">&quot;</span><span class="content">near.*</span><span class="delimiter">&quot;</span></span>); <span class="comment">// enable near-cache only for caches whose name starts with 'near'</span></code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Near caches work the same way for local caches as they do for clustered caches, but in a clustered cache scenario, if the server node sending the near cache notifications to the Hot Rod client goes down, the Hot Rod client transparently fails over to another node in the cluster, clearing the near cache along the way. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="unsupported_methods"><a class="anchor" href="#unsupported_methods"></a>6.1.18. Unsupported methods</h4> <div class="paragraph"> <p>Some of the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html">Cache</a> methods are not being supported by the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> . Calling one of these methods results in an <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/UnsupportedOperationException.html">UnsupportedOperationException</a> being thrown. Most of these methods do not make sense on the remote cache (e.g. listener management operations), or correspond to methods that are not supported by local cache as well (e.g. containsValue). Another set of unsupported operations are some of the atomic operations inherited from <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">ConcurrentMap</a> :</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> remove(<span class="predefined-type">Object</span> key, <span class="predefined-type">Object</span> value);
<span class="type">boolean</span> replace(<span class="predefined-type">Object</span> key, <span class="predefined-type">Object</span> value);
<span class="type">boolean</span> replace(<span class="predefined-type">Object</span> key, <span class="predefined-type">Object</span> oldValue, <span class="predefined-type">Object</span> value);</code></pre> </div> </div> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> offers alternative versioned methods for these atomic operations, that are also network friendly, by not sending the whole value object over the network, but a version identifier. See the section on versioned API.</p> </div> <div class="paragraph"> <p>Each one of these unsupported operation is documented in the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> javadoc.</p> </div> </div> <div class="sect3"> <h4 id="return_values"><a class="anchor" href="#return_values"></a>6.1.19. Return values</h4> <div class="paragraph"> <p>There is a set of methods that alter a cached entry and return the previous existing value, e.g.:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">V remove(<span class="predefined-type">Object</span> key);
V put(K key, V value);</code></pre> </div> </div> <div class="paragraph"> <p>By default on RemoteCache, these operations return null even if such a previous value exists. This approach reduces the amount of data sent over the network. However, if these return values are needed they can be enforced on a per invocation basis using flags:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">initialValue</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> <span class="predefined-constant">null</span> == cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">assert</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>.equals(cache.withFlags(Flag.FORCE_RETURN_VALUE).put(<span class="string"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span>,
<span class="error"></span><span class="error"></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">newValue</span><span class="delimiter">&quot;</span></span>));</code></pre> </div> </div> <div class="paragraph"> <p>This default behavior can can be changed through force-return-value=true configuration parameter (see configuration section bellow).</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="hr_transactions"><a class="anchor" href="#hr_transactions"></a>7. Hot Rod Transactions</h2> <div class="sectionbody"> <div class="paragraph"> <p>You can configure and use Hot Rod clients in JTA <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Transaction.html">Transaction</a>s.</p> </div> <div class="paragraph"> <p>To participate in a transaction, the Hot Rod client requires the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> with which it interacts and whether it participates in the transaction through the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Synchronization.html">Synchronization</a> or <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a> interface.</p> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="paragraph"> <p>Transactions are optimistic in that clients acquire write locks on entries during the prepare phase. To avoid data inconsistency, be sure to read about <a href="#hr_transactions_force_return_value">Detecting Conflicts with Transactions</a>.</p> </div> </td> </tr> </table> </div> <div class="sect2"> <h3 id="hr_transactions_config_server"><a class="anchor" href="#hr_transactions_config_server"></a>7.1. Configuring the Server</h3> <div class="paragraph"> <p>Caches in the server must also be transactional for clients to participate in JTA <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Transaction.html">Transaction</a>s.</p> </div> <div class="paragraph"> <p>The following server configuration is required, otherwise transactions rollback only:</p> </div> <div class="ulist"> <ul> <li> <p>Isolation level must be <code>REPEATABLE_READ</code>.</p> </li> <li> <p>Locking mode must be <code>PESSIMISTIC</code>. In a future release, <code>OPTIMISTIC</code> locking mode will be supported.</p> </li> <li> <p>Transaction mode should be <code>NON_XA</code> or <code>NON_DURABLE_XA</code>. Hot Rod transactions cannot use <code>FULL_XA</code> because it degrades performance.</p> </li> </ul> </div> <div class="paragraph"> <p>Hot Rod transactions have their own recovery mechanism.</p> </div> </div> <div class="sect2"> <h3 id="hr_transactions_config_client"><a class="anchor" href="#hr_transactions_config_client"></a>7.2. Configuring Hot Rod Clients</h3> <div class="paragraph"> <p>When you create the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a>, you can set the default <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/TransactionMode.html">TransactionMode</a> that the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> uses.</p> </div> <div class="paragraph"> <p>The <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> lets you create only one configuration for transactional caches, as in the following example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
<span class="comment">//other client configuration parameters</span>
cb.transaction().transactionManagerLookup(GenericTransactionManagerLookup.getInstance());
cb.transaction().transactionMode(TransactionMode.NON_XA);
cb.transaction().timeout(<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.MINUTES)
RemoteCacheManager rmc = <span class="keyword">new</span> RemoteCacheManager(cb.build());</code></pre> </div> </div> <div class="paragraph"> <p>The preceding configuration applies to all instances of a remote cache. If you need to apply different configurations to remote cache instances, you can override the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> configuration. See <a href="#hr_transactions_override_rcm">Overriding RemoteCacheManager Configuration</a>.</p> </div> <div class="paragraph"> <p>See <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/ConfigurationBuilder.html">ConfigurationBuilder</a> Javadoc for documentation on configuration parameters.</p> </div> <div class="paragraph"> <p>You can also configure the Java Hot Rod client with a properties file, as in the following example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>infinispan.client.hotrod.transaction.transaction_manager_lookup = org.infinispan.client.hotrod.transaction.lookup.GenericTransactionManagerLookup
infinispan.client.hotrod.transaction.transaction_mode = NON_XA
infinispan.client.hotrod.transaction.timeout = 60000</code></pre> </div> </div> <div class="sect3"> <h4 id="hr_transactions_tmlookup"><a class="anchor" href="#hr_transactions_tmlookup"></a>7.2.1. TransactionManagerLookup Interface</h4> <div class="paragraph"> <p><code>TransactionManagerLookup</code> provides an entry point to fetch a <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p> </div> <div class="paragraph"> <p>Available implementations of <code>TransactionManagerLookup</code>:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1"><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/transaction/lookup/GenericTransactionManagerLookup.html">GenericTransactionManagerLookup</a></dt> <dd> <p>A lookup class that locates <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>s running in Java EE application servers. Defaults to the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/transaction/manager/RemoteTransactionManager.html">RemoteTransactionManager</a> if it cannot find a <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p> </dd> </dl> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>In most cases, <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/transaction/lookup/GenericTransactionManagerLookup.html">GenericTransactionManagerLookup</a> is suitable. However, you can implement the <code>TransactionManagerLookup</code> interface if you need to integrate a custom <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p> </div> </td> </tr> </table> </div> <div class="dlist"> <dl> <dt class="hdlist1"><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/transaction/lookup/RemoteTransactionManagerLookup.html">RemoteTransactionManagerLookup</a></dt> <dd> <p>A basic, and volatile, <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> if no other implementation is available. Note that this implementation has significant limitations when handling concurrent transactions and recovery.</p> </dd> </dl> </div> </div> <div class="sect3"> <h4 id="hr_transactions_modes"><a class="anchor" href="#hr_transactions_modes"></a>7.2.2. Transaction Modes</h4> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/TransactionMode.html">TransactionMode</a> controls how a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interacts with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="paragraph"> <p>Configure transaction modes on both the Infinispan server and your client application. If clients attempt to perform transactional operations on non-transactional caches, runtime exceptions can occur.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Transaction modes are the same in both the Infinispan configuration and client settings. Use the following modes with your client, see the Infinispan configuration schema for the server:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1"><code>NONE</code></dt> <dd> <p>The <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> does not interact with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>. This is the default mode and is non-transactional.</p> </dd> <dt class="hdlist1"><code>NON_XA</code></dt> <dd> <p>The <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interacts with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> via <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Synchronization.html">Synchronization</a>.</p> </dd> <dt class="hdlist1"><code>NON_DURABLE_XA</code></dt> <dd> <p>The <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interacts with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> via <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a>. Recovery capabilities are disabled.</p> </dd> <dt class="hdlist1"><code>FULL_XA</code></dt> <dd> <p>The <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> interacts with the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> via <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a>. Recovery capabilities are enabled. Invoke the <code>XaResource.recover()</code> method to retrieve transactions to recover.</p> </dd> </dl> </div> </div> </div> <div class="sect2"> <h3 id="hr_transactions_override_rcm"><a class="anchor" href="#hr_transactions_override_rcm"></a>7.3. Overriding Configuration for Cache Instances</h3> <div class="paragraph"> <p>Because <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> does not support different configurations for each cache instance. However, <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> includes the <code>getCache(String)</code> method that returns the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> instances and lets you override some configuration parameters, as follows:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1"><code>getCache(String cacheName, TransactionMode transactionMode)</code></dt> <dd> <p>Returns a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> and overrides the configured <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/TransactionMode.html">TransactionMode</a>.</p> </dd> <dt class="hdlist1"><code>getCache(String cacheName, boolean forceReturnValue, TransactionMode transactionMode)</code></dt> <dd> <p>Same as previous, but can also force return values for write operations.</p> </dd> <dt class="hdlist1"><code>getCache(String cacheName, TransactionManager transactionManager)</code></dt> <dd> <p>Returns a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> and overrides the configured <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.</p> </dd> <dt class="hdlist1"><code>getCache(String cacheName, boolean forceReturnValue, TransactionManager transactionManager)</code></dt> <dd> <p>Same as previous, but can also force return values for write operations.</p> </dd> <dt class="hdlist1"><code>getCache(String cacheName, TransactionMode transactionMode, TransactionManager transactionManager)</code></dt> <dd> <p>Returns a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> and overrides the configured <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/configuration/TransactionMode.html">TransactionMode</a>. Uses the configured values, if <code>transactionManager</code> or <code>transactionMode</code> is null.</p> </dd> <dt class="hdlist1"><code>getCache(String cacheName, boolean forceReturnValue, TransactionMode transactionMode, TransactionManager transactionManager)</code></dt> <dd> <p>Same as previous, but can also force return values for write operations.</p> </dd> </dl> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>The <code>getCache(String)</code> method returns <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> instances regardless of whether they are transaction or not. <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> includes a <code>getTransactionManager()</code> method that returns the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> that the cache uses. If the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> is not transactional, the method returns <code>null</code>.</p> </div> </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="hr_transactions_force_return_value"><a class="anchor" href="#hr_transactions_force_return_value"></a>7.4. Detecting Conflicts with Transactions</h3> <div class="paragraph"> <p>Transactions use the initial values of keys to detect conflicts. For example, "k" has a value of "v" when a transaction begins. During the prepare phase, the transaction fetches "k" from the server to read the value. If the value has changed, the transaction rolls back to avoid a conflict.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>Transactions use versions to detect changes instead of checking value equality.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>The <code>forceReturnValue</code> parameter controls write operations to the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> and helps avoid conflicts. It has the following values:</p> </div> <div class="ulist"> <ul> <li> <p>If <code>true</code>, the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> fetches the most recent value from the server before performing write operations. However, the <code>forceReturnValue</code> parameter applies only to write operations that access the key for the first time.</p> </li> <li> <p>If <code>false</code>, the <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a> does not fetch the most recent value from the server before performing write operations. Because this setting</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>This parameter does not affect <em>conditional</em> write operations such as <code>replace</code> or <code>putIfAbsent</code> because they require the most recent value.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>The following transactions provide an example where the <code>forceReturnValue</code> parameter can prevent conflicting write operations:</p> </div> <div class="listingblock"> <div class="title">Transaction 1 (TX1)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...
TransactionManager tm = ...

tm.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
tm.commit();</code></pre> </div> </div> <div class="listingblock"> <div class="title">Transaction 2 (TX2)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...
TransactionManager tm = ...

tm.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v2</span><span class="delimiter">&quot;</span></span>);
tm.commit();</code></pre> </div> </div> <div class="paragraph"> <p>In this example, TX1 and TX2 are executed in parallel. The initial value of "k" is "v".</p> </div> <div class="ulist"> <ul> <li> <p>If <code>forceReturnValue = true</code>, the <code>cache.put()</code> operation fetches the value for "k" from the server in both TX1 and TX2. The transaction that acquires the lock for "k" first then commits. The other transaction rolls back during the commit phase because the transaction can detect that "k" has a value other than "v".</p> </li> <li> <p>If <code>forceReturnValue = false</code>, the <code>cache.put()</code> operation does not fetch the value for "k" from the server and returns null. Both TX1 and TX2 can successfully commit, which results in a conflict. This occurs because neither transaction can detect that the initial value of "k" changed.</p> </li> </ul> </div> <div class="paragraph"> <p>The following transactions include <code>cache.get()</code> operations to read the value for "k" before doing the <code>cache.put()</code> operations:</p> </div> <div class="listingblock"> <div class="title">Transaction 1 (TX1)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...
TransactionManager tm = ...

tm.begin();
cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
tm.commit();</code></pre> </div> </div> <div class="listingblock"> <div class="title">Transaction 2 (TX2)</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...
TransactionManager tm = ...

tm.begin();
cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v2</span><span class="delimiter">&quot;</span></span>);
tm.commit();</code></pre> </div> </div> <div class="paragraph"> <p>In the preceding examples, TX1 and TX2 both read the key so the <code>forceReturnValue</code> parameter does not take effect. One transaction commits, the other rolls back. However, the <code>cache.get()</code> operation requires an additional server request. If you do not need the return value for the <code>cache.put()</code> operation that server request is inefficient.</p> </div> </div> <div class="sect2"> <h3 id="hr_transactions_ex_use_config"><a class="anchor" href="#hr_transactions_ex_use_config"></a>7.5. Using the Configured Transaction Manager and Transaction Mode</h3> <div class="paragraph"> <p>The following example shows how to use the <code>TransactionManager</code> and <code>TransactionMode</code> that you configure in the <code>RemoteCacheManager</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//Configure the transaction manager and transaction mode.</span>
org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.transaction().transactionManagerLookup(RemoteTransactionManagerLookup.getInstance());
cb.transaction().transactionMode(TransactionMode.NON_XA);

RemoteCacheManager rcm = <span class="keyword">new</span> RemoteCacheManager(cb.build());

<span class="comment">//The my-cache instance uses the RemoteCacheManager configuration.</span>
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = rcm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span>);

<span class="comment">//Return the transaction manager that the cache uses.</span>
TransactionManager tm = cache.getTransactionManager();

<span class="comment">//Perform a simple transaction.</span>
tm.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">K1 value is </span><span class="delimiter">&quot;</span></span> + cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>));
tm.commit();</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="hr_transactions_ex_override_tm"><a class="anchor" href="#hr_transactions_ex_override_tm"></a>7.6. Overriding the Transaction Manager</h3> <div class="paragraph"> <p>The following example shows how to override <code>TransactionManager</code> with the <code>getCache</code> method:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//Configure the transaction manager and transaction mode.</span>
org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.transaction().transactionManagerLookup(RemoteTransactionManagerLookup.getInstance());
cb.transaction().transactionMode(TransactionMode.NON_XA);

RemoteCacheManager rcm = <span class="keyword">new</span> RemoteCacheManager(cb.build());

<span class="comment">//Define a custom TransactionManager.</span>
TransactionManager myCustomTM = ...

<span class="comment">//Override the TransactionManager for the my-cache instance. Use the default configuration if null is returned.</span>
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = rcm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>, myCustomTM);

<span class="comment">//Perform a simple transaction.</span>
myCustomTM.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">K1 value is </span><span class="delimiter">&quot;</span></span> + cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>));
myCustomTM.commit();</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="hr_transactions_ex_override_mode"><a class="anchor" href="#hr_transactions_ex_override_mode"></a>7.7. Overriding the Transaction Mode</h3> <div class="paragraph"> <p>The following example shows how to override <code>TransactionMode</code> with the <code>getCache</code> method:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//Configure the transaction manager and transaction mode.</span>
org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.transaction().transactionManagerLookup(RemoteTransactionManagerLookup.getInstance());
cb.transaction().transactionMode(TransactionMode.NON_XA);

RemoteCacheManager rcm = <span class="keyword">new</span> RemoteCacheManager(cb.build());

<span class="comment">//Override the transaction mode for the my-cache instance.</span>
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = rcm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span>, TransactionMode.NON_DURABLE_XA, <span class="predefined-constant">null</span>);

<span class="comment">//Return the transaction manager that the cache uses.</span>
TransactionManager tm = cache.getTransactionManager();

<span class="comment">//Perform a simple transaction.</span>
tm.begin();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">K1 value is </span><span class="delimiter">&quot;</span></span> + cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>));
tm.commit();</code></pre> </div> </div> <div class="sect3"> <h4 id="client_intelligence"><a class="anchor" href="#client_intelligence"></a>7.7.1. Client Intelligence</h4> <div class="paragraph"> <p>HotRod defines three level of intelligence for the clients:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>basic client, interested in neither cluster nor hash information</p> </li> <li> <p>topology-aware client, interested in cluster information</p> </li> <li> <p>hash-distribution-aware client, that is interested in both cluster and hash information</p> </li> </ol> </div> <div class="paragraph"> <p>The java client supports all 3 levels of intelligence. It is transparently notified whenever a new server is added/removed from the HotRod cluster. At startup it only needs to know the address of one HotRod server (ip:host). On connection to the server the cluster topology is piggybacked to the client, and all further requests are being dispatched to all available servers. Any further topology change is also piggybacked.</p> </div> <div class="sect4"> <h5 id="distribution_aware_client"><a class="anchor" href="#distribution_aware_client"></a>Distribution-aware client</h5> <div class="paragraph"> <p>Another aspect of the 3rd level of intelligence is the fact that it is hash-distribution-aware. This means that, for each operation, the client chooses the most appropriate remote server to go to: the data owner. As an example, for a put(k,v) operation, the client calculates k&#8217;s hash value and knows exactly on which server the data resides on. Then it picks up a tcp connection to that particular server and dispatches the operation to it. This means less burden on the server side which would otherwise need to lookup the value based on the key&#8217;s hash. It also results in a quicker response from the server, as an additional network roundtrip is skipped. This hash-distribution-aware aspect is only relevant to the distributed HotRod clusters and makes no difference for replicated server deployments.</p> </div> </div> </div> <div class="sect3"> <h4 id="request_balancing"><a class="anchor" href="#request_balancing"></a>7.7.2. Request Balancing</h4> <div class="paragraph"> <p>Request balancing is only relevant when the server side is configured with replicated Infinispan cluster (on distributed clusters the hash-distribution-aware client logic is used, as discussed in the previos paragraph). Because the client is topology-aware, it knows the list of available servers at all the time. Request balancing has to do with how the client dispatches requests to the available servers.</p> </div> <div class="paragraph"> <p>The default strategy is round-robin: requests are being dispatched to all existing servers in a circular manner. E.g. given a cluster of servers {s1, s2, s3} here is how request will be dispatched:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CacheContainer cacheContainer = <span class="keyword">new</span> RemoteCacheManager();
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheContainer.getCache();

cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>); <span class="comment">//this goes to s1</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>); <span class="comment">//this goes to s2</span>
<span class="predefined-type">String</span> value = cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>); <span class="comment">//this goes to s3</span>

cache.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>); <span class="comment">//this is dispatched to s1 again, and so on...</span></code></pre> </div> </div> <div class="paragraph"> <p>Custom types of balancing policies can defined by implementing the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/FailoverRequestBalancingStrategy.html">FailoverRequestBalancingStrategy</a> and by specifying it through the infinispan.client.hotrod.request-balancing-strategy configuration property. Please refer to configuration section for more details on this.</p> </div> </div> <div class="sect3"> <h4 id="persistent_connections"><a class="anchor" href="#persistent_connections"></a>7.7.3. Persistent connections</h4> <div class="paragraph"> <p>In order to avoid creating a TCP connection on each request (which is a costly operation), the client keeps a pool of persistent connections to all the available servers and it reuses these connections whenever it is possible. The validity of the connections is checked using an async thread that iterates over the connections in the pool and sends a HotRod ping command to the server. By using this connection validation process the client is being proactive: there&#8217;s a hight chance for broken connections to be found while being idle in the pool and no on actual request from the application.</p> </div> <div class="paragraph"> <p>The number of connections per server, total number of connections, how long should a connection be kept idle in the pool before being closed - all these (and more) can be configured. Please refer to the javadoc of <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a> for a list of all possible configuration elements.</p> </div> </div> <div class="sect3"> <h4 id="hot_rod_marshalling_data"><a class="anchor" href="#hot_rod_marshalling_data"></a>7.7.4. Marshalling data</h4> <div class="paragraph"> <p>The Hot Rod client allows one to plug in a custom marshaller for transforming user objects into byte arrays and the other way around. This transformation is needed because of Hot Rod&#8217;s binary nature - it doesn&#8217;t know about objects.</p> </div> <div class="paragraph"> <p>The marshaller can be plugged through the "marshaller" configuration element (see Configuration section): the value should be the fully qualified name of a class implementing the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/marshall/Marshaller.html">Marshaller</a> interface. This is a optional parameter, if not specified it defaults to the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/marshall/jboss/GenericJBossMarshaller.html">GenericJBossMarshaller</a> - a highly optimized implementation based on the <a href="http://www.jboss.org/jbossmarshalling">JBoss Marshalling</a> library.</p> </div> <div class="paragraph"> <p>Since version 6.0, there&#8217;s a new marshaller available to Java Hot Rod clients based on Protostream which generates portable payloads.</p> </div> <div class="paragraph"> <div class="title">WARNING: If developing your own custom marshaller, take care of potential injection attacks.</div> <p>To avoid such attacks, make the marshaller verify that any class names read, before instantiating it, is amongst the expected/allowed class names.</p> </div> <div class="paragraph"> <p>The client configuration can be enhanced with a list of regular expressions for classes that are allowed to be read.</p> </div> <div class="paragraph"> <div class="title">WARNING: These checks are opt-in, so if not configured, any class can be read.</div> <p>In the example below, only classes with fully qualified names containing <code>Person</code> or <code>Employee</code> would be allowed:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</span>;

...
ConfigurationBuilder configBuilder = ...
configBuilder.addJavaSerialWhiteList(<span class="string"><span class="delimiter">&quot;</span><span class="content">.*Person.*</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">.*Employee.*</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="reading_data_in_different_data_formats"><a class="anchor" href="#reading_data_in_different_data_formats"></a>7.7.5. Reading data in different data formats</h4> <div class="paragraph"> <p>By default, every Hot Rod client operation will use the configured marshaller when reading and writing from the server for both keys and values. See <a href="#hot_rod_marshalling_data">Marshalling Data</a>. Using the DataFormat API, it&#8217;s possible to decorate remote caches so that all operations can happen with a custom data format.</p> </div> <div class="sect4"> <h5 id="using_different_marshallers_for_key_and_values"><a class="anchor" href="#using_different_marshallers_for_key_and_values"></a>Using different marshallers for Key and Values</h5> <div class="paragraph"> <p>Marshallers for Keys and Values can be overridden at run time. For example, to bypass all serialization in the Hot Rod client and read the byte[] as they are stored in the server:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Existing Remote cache instance</span>
RemoteCache&lt;<span class="predefined-type">String</span>, Pojo&gt; remoteCache = ...

<span class="comment">// IdentityMarshaller is a no-op marshaller</span>
DataFormat rawKeyAndValues = DataFormat.builder().keyMarshaller(IdentityMarshaller.INSTANCE).valueMarshaller(IdentityMarshaller.INSTANCE).build();

<span class="comment">// Will create a new instance of RemoteCache with the supplied DataFormat</span>
RemoteCache&lt;<span class="type">byte</span><span class="type">[]</span>, <span class="type">byte</span><span class="type">[]</span>&gt; rawResultsCache = remoteCache.withDataFormat(rawKeyAndValues);</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="reading_data_in_different_formats"><a class="anchor" href="#reading_data_in_different_formats"></a>Reading data in different formats</h5> <div class="paragraph"> <p>Apart from defining custom key and value marshallers, it&#8217;s also possible to request/send data in different formats specified by a <code>org.infinispan.commons.dataconversion.MediaType</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Existing remote cache using ProtostreamMarshaller</span>
RemoteCache&lt;<span class="predefined-type">String</span>, Pojo&gt; protobufCache = ...

<span class="comment">// Request values returned as JSON, using the UTF8StringMarshaller that converts between UTF-8 to String:</span>
DataFormat jsonString = DataFormat.builder().valueType(MediaType.APPLICATION_JSON).valueMarshaller(<span class="keyword">new</span> UTF8StringMarshaller().build();

RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; jsonStrCache = remoteCache.withDataFormat(jsonString);

<span class="comment">// Alternativelly, it's possible to request JSON values but marshalled/unmarshalled with a custom value marshaller that returns `org.codehaus.jackson.JsonNode` objects:</span>
DataFormat jsonNode = DataFormat.builder().valueType(MediaType.APPLICATION_JSON).valueMarshaller(<span class="keyword">new</span> CustomJacksonMarshaller().build();

RemoteCache&lt;<span class="predefined-type">String</span>, JsonNode&gt; jsonNodeCache = remoteCache.withDataFormat(jsonNode);</code></pre> </div> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> The data conversions happen in the server, and if it doesn&#8217;t support converting from the storage format to the request format and vice versa, an error will be returned. </td> </tr> </table> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Using different marshallers and formats for the key, with <code>.keyMarshaller()</code> and <code>.keyType()</code> may interfere with the client intelligence routing mechanism, causing it contact the server that is not the owner of the key during Hot Rod operations. This will not result in errors but can result in extra hops inside the cluster to execute the operation. If performance is critical, make sure to use the keys in the format stored by the server. </td> </tr> </table> </div> </div> </div> <div class="sect3"> <h4 id="statistics"><a class="anchor" href="#statistics"></a>7.7.6. Statistics</h4> <div class="paragraph"> <p>Various server usage statistics can be obtained through the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a> .stats() method. This returns a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/ServerStatistics.html">ServerStatistics</a> object - please refer to javadoc for details on the available statistics.</p> </div> </div> <div class="sect3"> <h4 id="multi_get_operations"><a class="anchor" href="#multi_get_operations"></a>7.7.7. Multi-Get Operations</h4> <div class="paragraph"> <p>The Java Hot Rod client does not provide multi-get functionality out of the box but clients can build it themselves with the given APIs.</p> </div> </div> <div class="sect3"> <h4 id="server_hotrod_failover"><a class="anchor" href="#server_hotrod_failover"></a>7.7.8. Failover capabilities</h4> <div class="paragraph"> <p>Hot Rod clients' capabilities to keep up with topology changes helps with request balancing and more importantly, with the ability to failover operations if one or several of the servers fail.</p> </div> <div class="paragraph"> <p>Some of the conditional operations mentioned above, including <code>putIfAbsent</code>, <code>replace</code> with and without version, and conditional <code>remove</code> have strict method return guarantees, as well as those operations where returning the previous value is forced.</p> </div> <div class="paragraph"> <p>In spite of failures, these methods return values need to be guaranteed, and in order to do so, it&#8217;s necessary that these methods are not applied partially in the cluster in the event of failure. For example, imagine a <code>replace()</code> operation called in a server for key=k1 with <code>Flag.FORCE_RETURN_VALUE</code>, whose current value is <code>A</code> and the replace wants to set it to <code>B</code>. If the replace fails, it could happen that some servers contain <code>B</code> and others contain <code>A</code>, and during the failover, the original <code>replace()</code> could end up returning <code>B</code>, if the replace failovers to a node where <code>B</code> is set, or could end up returning <code>A</code>.</p> </div> <div class="paragraph"> <p>To avoid this kind of situations, whenever Java Hot Rod client users want to use conditional operations, or operations whose previous value is required, it&#8217;s important that the cache is configured to be transactional in order to avoid incorrect conditional operations or return values.</p> </div> </div> <div class="sect3"> <h4 id="site_cluster_failover"><a class="anchor" href="#site_cluster_failover"></a>7.7.9. Site Cluster Failover</h4> <div class="paragraph"> <p>On top of the in-cluster failover, Hot Rod clients are also able to failover to different clusters, which could be represented as an independent site.</p> </div> <div class="paragraph"> <p>The way site cluster failover works is that if all the main cluster nodes are not available, the client checks to see if any other clusters have been defined in which cases it tries to failover to the alternative cluster. If the failover succeeds, the client will remain connected to the alternative cluster until this becomes unavailable, in which case it&#8217;ll try any other clusters defined, and ultimately, it&#8217;ll try the original server settings.</p> </div> <div class="paragraph"> <p>To configure a cluster in the Hot Rod client, one host/port pair details must be provided for each of the clusters configured. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">org.infinispan.client.hotrod.configuration.ConfigurationBuilder cb
      = <span class="keyword">new</span> org.infinispan.client.hotrod.configuration.ConfigurationBuilder();
cb.addCluster().addClusterNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-cluster-host</span><span class="delimiter">&quot;</span></span>, <span class="integer">11222</span>);
RemoteCacheManager rmc = <span class="keyword">new</span> RemoteCacheManager(cb.build());</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Remember that regardless of the cluster definitions, the initial server(s) configuration must be provided unless the initial servers can be resolved using the default server host and port details. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="manual_site_cluster_switch"><a class="anchor" href="#manual_site_cluster_switch"></a>7.7.10. Manual Site Cluster Switch</h4> <div class="paragraph"> <p>As well as supporting automatic site cluster failover, Java Hot Rod clients can also switch between site clusters manually by calling RemoteCacheManager&#8217;s <code>switchToCluster(clusterName)</code> and <code>switchToDefaultCluster()</code>.</p> </div> <div class="paragraph"> <p>Using <code>switchToCluster(clusterName)</code>, users can force a client to switch to one of the clusters pre-defined in the Hot Rod client configuration. To switch to the initial servers defined in the client configuration, call <code>switchToDefaultCluster()</code>.</p> </div> </div> <div class="sect3"> <h4 id="hotrod_java_client_monitoring"><a class="anchor" href="#hotrod_java_client_monitoring"></a>7.7.11. Monitoring the Hot Rod client</h4> <div class="paragraph"> <p>The Hot Rod client can be monitored and managed via JMX. By enabling statistics, an MBean will be registered for the <code>RemoteCacheManager</code> as well as for each <code>RemoteCache</code> obtained through it. Through these MBeans it is possible to obtain statistics about remote and near-cache hits/misses and connection pool usage.</p> </div> </div> <div class="sect3"> <h4 id="concurrent_updates"><a class="anchor" href="#concurrent_updates"></a>7.7.12. Concurrent Updates</h4> <div class="paragraph"> <p>Data structures, such as Infinispan <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html">Cache</a> , that are accessed and modified concurrently can suffer from data consistency issues unless there&#8217;re mechanisms to guarantee data correctness. Infinispan Cache, since it implements <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">ConcurrentMap</a> , provides operations such as <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#replace-K-V-V-">conditional replace</a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#putIfAbsent-K-V-">putIfAbsent</a> , and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#remove-java.lang.Object-java.lang.Object-">conditional remove</a> to its clients in order to guarantee data correctness. It even allows clients to operate against cache instances within JTA transactions, hence providing the necessary data consistency guarantees.</p> </div> <div class="paragraph"> <p>However, when it comes to <a href="http://community.jboss.org/wiki/HotRodProtocol">Hot Rod protocol</a> backed servers, clients do not yet have the ability to start remote transactions but they can call instead versioned operations to mimic the conditional methods provided by the embedded Infinispan cache instanceAPI. Let&#8217;s look at a real example to understand how it works.</p> </div> <div class="sect4"> <h5 id="data_consistency_problem"><a class="anchor" href="#data_consistency_problem"></a>Data Consistency Problem</h5> <div class="paragraph"> <p>Imagine you have two ATMs that connect using Hot Rod to a bank where an account&#8217;s balance is stored. Two closely followed operations to retrieve the latest balance could return 500 CHF (swiss francs) as shown below:</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./images/server_modules_6.png" alt="server modules 6"> </div> <div class="title">Figure 8. Concurrent readers</div> </div> <div class="paragraph"> <p>Next a customer connects to the first ATM and requests 400 CHF to be retrieved. Based on the last value read, the ATM could calculate what the new balance is, which is 100 CHF, and request a put with this new value. Let&#8217;s imagine now that around the same time another customer connects to the ATM and requests 200 CHF to be retrieved. Let&#8217;s assume that the ATM thinks it has the latest balance and based on its calculations it sets the new balance to 300 CHF:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/server_modules_7.png" alt="Concurrent updates"> </div> </div> <div class="paragraph"> <p>Obviously, this would be wrong. Two concurrent updates have resulted in an incorrect account balance. The second update should not have been allowed since the balance the second ATM had was incorrect. Even if the ATM would have retrieved the balance before calculating the new balance, someone could have updated between the new balance being retrieved and the update. Before finding out how to solve this issue in a client-server scenario with Hot Rod, let&#8217;s look at how this is solved when Infinispan clients run in peer-to-peer mode where clients and Infinispan live within the same JVM.</p> </div> </div> <div class="sect4"> <h5 id="embedded_mode_solution"><a class="anchor" href="#embedded_mode_solution"></a>Embedded-mode Solution</h5> <div class="paragraph"> <p>If the ATM and the Infinispan instance storing the bank account lived in the same JVM, the ATM could use the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#replace-K-V-V-">conditional replace API</a> referred at the beginning of this article. So, it could send the previous known value to verify whether it has changed since it was last read. By doing so, the first operation could double check that the balance is still 500 CHF when it was to update to 100 CHF. Now, when the second operation comes, the current balance would not be 500 CHF any more and hence the conditional replace call would fail, hence avoiding data consistency issues:</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./images/server_modules_8.png" alt="server modules 8"> </div> <div class="title">Figure 9. P2P solution</div> </div> </div> <div class="sect4"> <h5 id="client_server_solution"><a class="anchor" href="#client_server_solution"></a>Client-Server Solution</h5> <div class="paragraph"> <p>In theory, Hot Rod could use the same p2p solution but sending the previous value would be not practical. In this example, the previous value is just an integer but the value could be a lot bigger and hence forcing clients to send it to the server would be rather wasteful. Instead, Hot Rod offers versioned operations to deal with this situation.</p> </div> <div class="paragraph"> <p>Basically, together with each key/value pair, Hot Rod stores a version number which uniquely identifies each modification. So, using an operation called <a href="http://community.jboss.org/wiki/HotRodProtocol#getWithVersion_response">getVersioned or getWithVersion</a> , clients can retrieve not only the value associated with a key, but also the current version. So, if we look at the previous example once again, the ATMs could call getVersioned and get the balance&#8217;s version:</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./images/server_modules_9.png" alt="server modules 9"> </div> <div class="title">Figure 10. Get versioned</div> </div> <div class="paragraph"> <p>When the ATMs wanted to modify the balance, instead of just calling put, they could call <a href="http://community.jboss.org/wiki/HotRodProtocol#removeIfUnmodified_request">replaceIfUnmodified</a> operation passing the latest version number of which the clients are aware of. The operation will only succeed if the version passed matches the version in the server. So, the first modification by the ATM would be allowed since the client passes 1 as version and the server side version for the balance is also 1. On the other hand, the second ATM would not be able to make the modification because after the first ATMs modification the version would have been incremented to 2, and now the passed version (1) and the server side version (2) would not match:</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./images/server_modules_10.png" alt="server modules 10"> </div> <div class="title">Figure 11. Replace if versions match</div> </div> </div> </div> <div class="sect3"> <h4 id="javadocs"><a class="anchor" href="#javadocs"></a>7.7.13. Javadocs</h4> <div class="paragraph"> <p>It is highly recommended to read the following Javadocs (this is pretty much all the public API of the client):</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a></p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a></p> </li> </ul> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="rest_server"><a class="anchor" href="#rest_server"></a>8. REST Server</h2> <div class="sectionbody"> <div class="paragraph"> <p>The Infinispan Server distribution contains a module that implements <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer">RESTful</a> HTTP access to the Infinispan data grid, built on <a href="https://github.com/netty/netty">Netty</a>.</p> </div> <div class="sect2"> <h3 id="rest_run_server"><a class="anchor" href="#rest_run_server"></a>8.1. Running the REST server</h3> <div class="paragraph"> <p>The REST server endpoint is part of the Infinispan Server and by default listens on port 8080. To run the server locally, <a href="http://infinispan.org/download/">download</a> the zip distribution and execute in the extracted directory:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>bin/standalone.sh -b 0.0.0.0</code></pre> </div> </div> <div class="paragraph"> <p>or alternatively, run via docker:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>docker run -it -p 8080:8080 -e "APP_USER=user" -e "APP_PASS=changeme" jboss/infinispan-server</code></pre> </div> </div> <div class="sect3"> <h4 id="rest_security"><a class="anchor" href="#rest_security"></a>8.1.1. Security</h4> <div class="paragraph"> <p>The REST server is protected by authentication, so before usage it is necessary to create an application login. When running via docker, this is achieved by the APP_USER and APP_PASS command line arguments, but when running locally, this can be done with:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>bin/add-user.sh -u user -p changeme -a</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="rest_supported_protocols"><a class="anchor" href="#rest_supported_protocols"></a>8.2. Supported protocols</h3> <div class="paragraph"> <p>The REST Server supports HTTP/1.1 as well as HTTP/2 protocols. It is possible to switch to HTTP/2 by either performing a <a href="https://http2.github.io/http2-spec/#discover-http">HTTP/1.1 Upgrade procedure</a> or by negotiating communication protocol using <a href="https://http2.github.io/http2-spec/#versioning">TLS/ALPN extension</a>.</p> </div> <div class="paragraph"> <p>Note: TLS/ALPN with JDK8 requires additional steps from the client perspective. Please refer to your client documentation but it is very likely that you will need Jetty ALPN Agent or OpenSSL bindings.</p> </div> </div> <div class="sect2"> <h3 id="rest_server_cors"><a class="anchor" href="#rest_server_cors"></a>8.3. CORS</h3> <div class="paragraph"> <p>The REST server supports <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a> including preflight and rules based on the request origin.</p> </div> <div class="paragraph"> <p>Example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;rest-connector</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;cors-rules&gt;</span>
      <span class="tag">&lt;cors-rule</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">restrict host1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">allow-credentials</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;allowed-origins&gt;</span>http://host1,https://host1<span class="tag">&lt;/allowed-origins&gt;</span>
         <span class="tag">&lt;allowed-methods&gt;</span>GET<span class="tag">&lt;/allowed-methods&gt;</span>
      <span class="tag">&lt;/cors-rule&gt;</span>
      <span class="tag">&lt;cors-rule</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">allow ALL</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">allow-credentials</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-age-seconds</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;allowed-origins&gt;</span>*<span class="tag">&lt;/allowed-origins&gt;</span>
         <span class="tag">&lt;allowed-methods&gt;</span>GET,OPTIONS,POST,PUT,DELETE<span class="tag">&lt;/allowed-methods&gt;</span>
         <span class="tag">&lt;allowed-headers&gt;</span>Key-Content-Type<span class="tag">&lt;/allowed-headers&gt;</span>
      <span class="tag">&lt;/cors-rule&gt;</span>
   <span class="tag">&lt;/cors-rules&gt;</span>
<span class="tag">&lt;/rest-connector&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The rules are evaluated sequentially based on the "Origin" header set by the browser; in the example above if the origin is either "http://host1" or "https://host1" the rule "restrict host1" will apply, otherwise the next rule will be tested. Since the rule "allow ALL" permits all origins, any script coming from a different origin will be able to perform the methods specified and use the headers supplied.</p> </div> <div class="paragraph"> <p>The &lt;cors-rule&gt; element can be configured as follows:</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Config</th> <th class="tableblock halign-left valign-top">Description</th> <th class="tableblock halign-left valign-top">Mandatory</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The name of the rule</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">allow-credentials</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Enable CORS requests to use credentials</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">allowed-origins</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">A comma separated list used to set the CORS 'Access-Control-Allow-Origin' header to indicate the response can be shared with the origins</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">allowed-methods</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">A comma separated list used to set the CORS 'Access-Control-Allow-Methods' header in the preflight response to specify the methods allowed for the configured origin(s)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">max-age-seconds</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The amount of time CORS preflight request headers can be cached</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">expose-headers</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">A comma separated list used to set the CORS 'Access-Control-Expose-Headers' in the preflight response to specify which headers can be exposed to the configured origin(s)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td> </tr> </tbody> </table> </div> <div class="sect2"> <h3 id="rest_server_data_format"><a class="anchor" href="#rest_server_data_format"></a>8.4. Data formats</h3> <div class="sect3"> <h4 id="rest_server_data_format_config"><a class="anchor" href="#rest_server_data_format_config"></a>8.4.1. Configuration</h4> <div class="paragraph"> <p>Each cache exposed via REST stores data in a configurable data format defined by a <a href="https://en.wikipedia.org/wiki/Media_type">MediaType</a>. More details in the configuration <a href="#encoding_media_type">here</a>.</p> </div> <div class="paragraph"> <p>An example of storage configuration is as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;cache&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object; type=java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xml; charset=UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>When no MediaType is configured, Infinispan assumes "application/octet-stream" for both keys and values, with the following exceptions:</p> </div> <div class="ulist"> <ul> <li> <p>If the cache is indexed, it assumes "application/x-protostream"</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="rest_server_data_format_support"><a class="anchor" href="#rest_server_data_format_support"></a>8.4.2. Supported formats</h4> <div class="paragraph"> <p>Data can be written and read in different formats than the storage format; Infinispan can convert between those formats when required.</p> </div> <div class="paragraph"> <p>The following "standard" formats can be converted interchangeably:</p> </div> <div class="ulist"> <ul> <li> <p><em>application/x-java-object</em></p> </li> <li> <p><em>application/octet-stream</em></p> </li> <li> <p><em>application/x-www-form-urlencoded</em></p> </li> <li> <p><em>text/plain</em></p> </li> </ul> </div> <div class="paragraph"> <p>The following formats can be converted to/from the formats above:</p> </div> <div class="ulist"> <ul> <li> <p><em>application/xml</em></p> </li> <li> <p><em>application/json</em></p> </li> <li> <p><em>application/x-jboss-marshalling</em></p> </li> <li> <p><em>application/x-protostream</em></p> </li> <li> <p><em>application/x-java-serialized</em></p> </li> </ul> </div> <div class="paragraph"> <p>Finally, the following conversion is also supported:</p> </div> <div class="ulist"> <ul> <li> <p>Between <em>application/x-protostream</em> and <em>application/json</em></p> </li> </ul> </div> <div class="paragraph"> <p>All the REST API calls can provide headers describing the content written or the required format of the content when reading. Infinispan supports the standard HTTP/1.1 headers "Content-Type" and "Accept" that are applied for values, plus the "Key-Content-Type" with similar effect for keys.</p> </div> </div> <div class="sect3"> <h4 id="rest_accept"><a class="anchor" href="#rest_accept"></a>8.4.3. Accept header</h4> <div class="paragraph"> <p>The REST server is compliant with the <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">RFC-2616</a> Accept header, and will negotiate the correct MediaType based on the conversions supported. Example, sending the following header when reading data:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>Accept: text/plain;q=0.7, application/json;q=0.8, */*;q=0.6</code></pre> </div> </div> <div class="paragraph"> <p>will cause Infinispan to try first to return content in JSON format (higher priority 0.8). If it&#8217;s not possible to convert the storage format to JSON, next format tried will be <em>text/plain</em> (second highest priority 0.7), and finally it falls back to <em>*/*</em>, that will pick a format suitable for displaying automatically based on the cache configuration.</p> </div> </div> <div class="sect3"> <h4 id="rest_key_content_type"><a class="anchor" href="#rest_key_content_type"></a>8.4.4. Key-Content-Type header</h4> <div class="paragraph"> <p>Most REST API calls have the Key included in the URL. Infinispan will assume the Key is a <em>java.lang.String</em> when handling those calls, but it&#8217;s possible to use a specific header <em>Key-Content-Type</em> for keys in different formats.</p> </div> <div class="paragraph"> <p>Examples:</p> </div> <div class="ulist"> <ul> <li> <p>Specifying a byte[] Key as a Base64 string:</p> </li> </ul> </div> <div class="paragraph"> <p>API call:</p> </div> <div class="literalblock"> <div class="content"> <pre>`PUT /my-cache/AQIDBDM=`</pre> </div> </div> <div class="paragraph"> <p>Headers:</p> </div> <div class="paragraph"> <p><code>Key-Content-Type: application/octet-stream</code></p> </div> <div class="ulist"> <ul> <li> <p>Specifying a byte[] Key as a hexadecimal string:</p> </li> </ul> </div> <div class="paragraph"> <p>API call:</p> </div> <div class="paragraph"> <p><code>GET /my-cache/0x01CA03042F</code></p> </div> <div class="paragraph"> <p>Headers:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>Key-Content-Type: application/octet-stream; encoding=hex</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Specifying a double Key:</p> </li> </ul> </div> <div class="paragraph"> <p>API call:</p> </div> <div class="paragraph"> <p><code>POST /my-cache/3.141456</code></p> </div> <div class="paragraph"> <p>Headers:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>Key-Content-Type: application/x-java-object;type=java.lang.Double</code></pre> </div> </div> <div class="paragraph"> <p>The <em>type</em> parameter for <em>application/x-java-object</em> is restricted to:</p> </div> <div class="ulist"> <ul> <li> <p>Primitive wrapper types</p> </li> <li> <p>java.lang.String</p> </li> <li> <p>Bytes, making <em>application/x-java-object;type=Bytes</em> equivalent to <em>application/octet-stream;encoding=hex</em></p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="jsonprotostream_conversion"><a class="anchor" href="#jsonprotostream_conversion"></a>8.4.5. JSON/Protostream conversion</h4> <div class="paragraph"> <p>When caches are indexed, or specifically configured to store <em>application/x-protostream</em>, it&#8217;s possible to send and receive JSON documents that are automatically converted to/from protostream. In order for the conversion to work, a protobuf schema must be registered.</p> </div> <div class="paragraph"> <p>The registration can be done via REST, by doing a POST/PUT in the <em>___protobuf_metadata</em> cache. Example using cURL:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="bash">curl -u user:password -X POST --data-binary @./schema.proto http://127.0.0.1:8080/rest/___protobuf_metadata/schema.proto</code></pre> </div> </div> <div class="paragraph"> <p>When writing a JSON document, a special field <strong><em>_type</em></strong> must be present in the document to identity the protobuf <em>Message</em> corresponding to the document.</p> </div> <div class="paragraph"> <p>For example, consider the following schema:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="protobuf">message Person  {
  required string name = 1;
  required int32 age = 2;
}</code></pre> </div> </div> <div class="paragraph"> <p>A conformant JSON document would be:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">_type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Person</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">user1</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span>: <span class="integer">32</span>
}</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="rest_v1_api"><a class="anchor" href="#rest_v1_api"></a>8.5. REST V1 API</h3> <div class="paragraph"> <p>The REST V1 API supports basic cache capabilities including operations on keys and query, and is now deprecated. For a more powerful and comprehensive API, check the <a href="#rest_v2_api">REST V2 API</a>.</p> </div> <div class="paragraph"> <p>HTTP PUT and POST methods are used to place data in the cache, with URLs to address the cache name and key(s) - the data being the body of the request (the data can be anything you like). Other headers are used to control the cache settings and behaviour.</p> </div> <div class="sect3"> <h4 id="putting_data_in"><a class="anchor" href="#putting_data_in"></a>8.5.1. Putting data in</h4> <div class="sect4"> <h5 id="rest_server_put_request"><a class="anchor" href="#rest_server_put_request"></a><code>PUT /{cacheName}/{cacheKey}</code></h5> <div class="paragraph"> <p>A PUT request of the above URL form will place the payload (body) in the given cache, with the given key (the named cache must exist on the server). For example <code><a href="http://someserver/hr/payRoll-3" class="bare">http://someserver/hr/payRoll-3</a></code> (in which case <code>hr</code> is the cache name, and <code>payRoll-3</code> is the key). Any existing data will be replaced, and Time-To-Live and Last-Modified values etc will updated (if applicable).</p> </div> </div> <div class="sect4"> <h5 id="rest_server_post_request"><a class="anchor" href="#rest_server_post_request"></a><code>POST /{cacheName}/{cacheKey}</code></h5> <div class="paragraph"> <p>Exactly the same as PUT, only if a value in a cache/key already exists, it will return a Http CONFLICT status (and the content will not be updated).</p> </div> <div class="ulist"> <div class="title">Headers</div> <ul> <li> <p><a href="#rest_key_content_type">Key-Content-Type</a>: OPTIONAL The content type for the Key present in the URL.</p> </li> <li> <p>Content-Type : OPTIONAL The <a href="https://en.wikipedia.org/wiki/Media_type">MediaType</a> of the Value being sent.</p> </li> <li> <p>timeToLiveSeconds : OPTIONAL number (the number of seconds before this entry will automatically be deleted). If no parameter is sent, Infinispan assumes configuration default value. Passing any negative value will create an entry which will live forever.</p> </li> <li> <p>maxIdleTimeSeconds : OPTIONAL number (the number of seconds after last usage of this entry when it will automatically be deleted). If no parameter is sent, Infinispan configuration default value. Passing any negative value will create an entry which will live forever.</p> </li> </ul> </div> <div class="ulist"> <div class="title">Passing 0 as parameter for timeToLiveSeconds and/or maxIdleTimeSeconds</div> <ul> <li> <p>If both <code>timeToLiveSeconds</code> and <code>maxIdleTimeSeconds</code> are 0, the cache will use the default <code>lifespan</code> and <code>maxIdle</code> values configured in XML/programmatically</p> </li> <li> <p>If <em>only</em> <code>maxIdleTimeSeconds</code> is 0, it uses the <code>timeToLiveSeconds</code> value passed as parameter (or -1 if not present), and default <code>maxIdle</code> configured in XML/programmatically</p> </li> <li> <p>If <em>only</em> <code>timeToLiveSeconds</code> is 0, it uses default <code>lifespan</code> configured in XML/programmatically, and <code>maxIdle</code> is set to whatever came as parameter (or -1 if not present)</p> </li> </ul> </div> </div> </div> <div class="sect3"> <h4 id="rest_server_get_data"><a class="anchor" href="#rest_server_get_data"></a>8.5.2. Getting data back out</h4> <div class="paragraph"> <p>HTTP GET and HEAD are used to retrieve data from entries.</p> </div> <div class="sect4"> <h5 id="rest_server_get_request"><a class="anchor" href="#rest_server_get_request"></a><code>GET /{cacheName}/{cacheKey}</code></h5> <div class="paragraph"> <p>This will return the data found in the given cacheName, under the given key - as the body of the response. A Content-Type header will be present in the response according to the Media Type negotiation. Browsers can use the cache directly of course (eg as a CDN). An <a href="http://en.wikipedia.org/wiki/HTTP_ETag">ETag</a> will be returned unique for each entry, as will the Last-Modified and Expires headers field indicating the state of the data at the given URL. ETags allow browsers (and other clients) to ask for data only in the case where it has changed (to save on bandwidth) - this is standard HTTP and is honoured by Infinispan.</p> </div> <div class="ulist"> <div class="title">Headers</div> <ul> <li> <p><a href="#rest_key_content_type">Key-Content-Type</a>: OPTIONAL The content type for the Key present in the URL. When omitted, <em>application/x-java-object; type=java.lang.String</em> is assumed</p> </li> <li> <p><a href="#rest_accept">Accept</a>: OPTIONAL The required format to return the content</p> </li> </ul> </div> <div class="paragraph"> <p>It is possible to obtain additional information by appending the "extended" parameter on the query string, as follows:</p> </div> <div class="paragraph"> <p><code>GET /cacheName/cacheKey?extended</code></p> </div> <div class="paragraph"> <p>This will return the following custom headers:</p> </div> <div class="ulist"> <ul> <li> <p>Cluster-Primary-Owner: the node name of the primary owner for this key</p> </li> <li> <p>Cluster-Node-Name: the JGroups node name of the server that has handled the request</p> </li> <li> <p>Cluster-Physical-Address: the physical JGroups address of the server that has handled the request.</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="rest_server_head_request"><a class="anchor" href="#rest_server_head_request"></a><code>HEAD /{cacheName}/{cacheKey}</code></h5> <div class="paragraph"> <p>The same as GET, only no content is returned (only the header fields). You will receive the same content that you stored. E.g., if you stored a String, this is what you get back. If you stored some XML or JSON, this is what you will receive. If you stored a binary (base 64 encoded) blob, perhaps a serialized; Java; object - you will need to; deserialize this yourself.</p> </div> <div class="paragraph"> <p>Similarly to the GET method, the HEAD method also supports returning extended information via headers. See above.</p> </div> <div class="ulist"> <div class="title">Headers</div> <ul> <li> <p><a href="#rest_key_content_type">Key-Content-Type</a>: OPTIONAL The content type for the Key present in the URL. When omitted, <em>application/x-java-object; type=java.lang.String</em> is assumed</p> </li> </ul> </div> </div> </div> <div class="sect3"> <h4 id="rest_server_list_keys"><a class="anchor" href="#rest_server_list_keys"></a>8.5.3. Listing keys</h4> <div class="sect4"> <h5 id="rest_server_list_get"><a class="anchor" href="#rest_server_list_get"></a><code>GET /{cacheName}</code></h5> <div class="paragraph"> <p>This will return a list of keys present in the given cacheName as the body of the response. The format of the response can be controlled via the Accept header as follows:</p> </div> <div class="ulist"> <ul> <li> <p><em>application/xml</em> - the list of keys will be returned in XML format.</p> </li> <li> <p><em>application/json</em> - the list of keys will be return in JSON format.</p> </li> <li> <p><em>text/plain</em> - the list of keys will be returned in plain text format, one key per line</p> </li> </ul> </div> <div class="paragraph"> <p>If the cache identified by cacheName is distributed, only the keys owned by the node handling the request will be returned. To return all keys, append the "global" parameter to the query, as follows:</p> </div> <div class="paragraph"> <p><code>GET /cacheName?global</code></p> </div> </div> </div> <div class="sect3"> <h4 id="rest_server_remove_data"><a class="anchor" href="#rest_server_remove_data"></a>8.5.4. Removing data</h4> <div class="paragraph"> <p>Data can be removed at the cache key/element level, or via a whole cache name using the HTTP delete method.</p> </div> <div class="sect4"> <h5 id="rest_server_delete_keys"><a class="anchor" href="#rest_server_delete_keys"></a><code>DELETE /{cacheName}/{cacheKey}</code></h5> <div class="paragraph"> <p>Removes the given key name from the cache.</p> </div> <div class="ulist"> <div class="title">Headers</div> <ul> <li> <p><a href="#rest_key_content_type">Key-Content-Type</a>: OPTIONAL The content type for the Key present in the URL. When omitted, <em>application/x-java-object; type=java.lang.String</em> is assumed</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="rest_server_delete_cache"><a class="anchor" href="#rest_server_delete_cache"></a><code>DELETE /{cacheName}</code></h5> <div class="paragraph"> <p>Removes ALL the entries in the given cache name (i.e., everything from that path down). If the operation is successful, it returns 200 code.</p> </div> </div> </div> <div class="sect3"> <h4 id="rest_server_query"><a class="anchor" href="#rest_server_query"></a>8.5.5. Querying</h4> <div class="paragraph"> <p>The REST server supports Ickle Queries in JSON format. It&#8217;s important that the cache is configured with <em>application/x-protostream</em> for both Keys and Values. If the cache is indexed, no configuration is needed.</p> </div> <div class="sect4"> <h5 id="rest_server_query_get"><a class="anchor" href="#rest_server_query_get"></a><code>GET /{cacheName}?action=search&amp;query={ickle query}</code></h5> <div class="paragraph"> <p>Will execute an Ickle query in the given cache name.</p> </div> <div class="ulist"> <div class="title">Request parameters</div> <ul> <li> <p><em>query</em>: REQUIRED the query string</p> </li> <li> <p><em>max_results</em>: OPTIONAL the number of results to return, default is <em>10</em></p> </li> <li> <p><em>offset</em>: OPTIONAL the index of the first result to return, default is <em>0</em></p> </li> <li> <p><em>query_mode</em>: OPTIONAL the execution mode of the query once it&#8217;s received by server. Valid values are <em>FETCH</em> and <em>BROADCAST</em>. Default is <em>FETCH</em>.</p> </li> </ul> </div> <div class="paragraph"> <div class="title">Query Result</div> <p>Results are JSON documents containing one or more hits. Example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">total_results</span><span class="delimiter">&quot;</span></span> : <span class="integer">150</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">hits</span><span class="delimiter">&quot;</span></span> : [ {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">hit</span><span class="delimiter">&quot;</span></span> : {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">user1</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span> : <span class="integer">35</span>
    }
  }, {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">hit</span><span class="delimiter">&quot;</span></span> : {
       <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">user2</span><span class="delimiter">&quot;</span></span>,
       <span class="key"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span> : <span class="integer">42</span>
    }
  }, {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">hit</span><span class="delimiter">&quot;</span></span> : {
       <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">user3</span><span class="delimiter">&quot;</span></span>,
       <span class="key"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span> : <span class="integer">12</span>
    }
  } ]
}</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p><em>total_results</em>: NUMBER, the total number of results from the query.</p> </li> <li> <p><em>hits</em>: ARRAY, list of matches from the query</p> </li> <li> <p><em>hit</em>: OBJECT, each result from the query. Can contain all fields or just a subset of fields in case a <em>Select</em> clause is used.</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="rest_server_query_post"><a class="anchor" href="#rest_server_query_post"></a><code>POST /{cacheName}?action=search</code></h5> <div class="paragraph"> <p>Similar to que query using GET, but the body of the request is used instead to specify the query parameters.</p> </div> <div class="paragraph"> <p>Example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json">{
 <span class="key"><span class="delimiter">&quot;</span><span class="content">query</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">from Entity where name:</span><span class="char">\&quot;</span><span class="content">user1</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>,
 <span class="key"><span class="delimiter">&quot;</span><span class="content">max_results</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span>,
 <span class="key"><span class="delimiter">&quot;</span><span class="content">offset</span><span class="delimiter">&quot;</span></span>:<span class="integer">10</span>
}</code></pre> </div> </div> </div> </div> </div> <div class="sect2"> <h3 id="rest_v2_api"><a class="anchor" href="#rest_v2_api"></a>8.6. REST v2 API</h3> <div class="paragraph"> <p>Infinispan provides a REST v2 (version 2) API that improves upon the REST v1 API. The REST v2 API gives you all the features of the v1 API in addition to support for resources beyond caching.</p> </div> <div class="sect3"> <h4 id="rest_v2_cache_operations"><a class="anchor" href="#rest_v2_cache_operations"></a>8.6.1. Working with Caches</h4> <div class="paragraph"> <p>Use the REST API to create and manage caches on your Infinispan cluster and interact with cached entries.</p> </div> <div class="sect4"> <h5 id="rest_v2_create_cache"><a class="anchor" href="#rest_v2_create_cache"></a>Creating Caches</h5> <div class="paragraph"> <p>To create a named cache across the Infinispan cluster, invoke a <code>POST</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>POST /v2/caches/{cacheName}</code></pre> </div> </div> <div class="paragraph"> <p>To configure the cache, you supply the configuration in XML or JSON format as part of the payload.</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">XML Configuration</dt> <dd> <p>If you supply the Infinispan configuration in XML format, it must conform to the schema and include the <code>&lt;infinispan&gt;</code> root element and a <code>&lt;cache-container&gt;</code> definition, as in the following example:</p> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
    <span class="tag">&lt;cache-container&gt;</span>
        <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;memory&gt;</span>
                <span class="tag">&lt;object</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/memory&gt;</span>
        <span class="tag">&lt;/distributed-cache&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> </dd> <dt class="hdlist1">JSON Configuration</dt> <dd> <p>If you supply the Infinispan configuration in a JSON payload, it requires only the cache definition. However, the JSON payload must follow the structure of an XML configuration. XML elements become JSON objects. XML attributes become JSON fields.</p> <div class="paragraph"> <p>For example, the preceding XML configuration is represented in JSON as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">distributed-cache</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">mode</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">memory</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">object</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>: <span class="integer">20</span>
      }
    }
  }
}</code></pre> </div> </div> </dd> </dl> </div> <table class="tableblock frame-all grid-all stretch"> <caption class="title">Table 1. Headers</caption> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Header</th> <th class="tableblock halign-left valign-top">Required or Optional</th> <th class="tableblock halign-left valign-top">Parameter</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Content-Type</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">REQUIRED</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Sets the <a href="https://en.wikipedia.org/wiki/Media_type">MediaType</a> for the Infinispan configuration payload; either <code>application/xml</code> or <code>application/json</code>.</p></td> </tr> </tbody> </table> <div class="sect5"> <h6 id="rest_v2_create_cache_template"><a class="anchor" href="#rest_v2_create_cache_template"></a>Creating with Templates</h6> <div class="paragraph"> <p>To create a cache across the Infinispan cluster based on a pre-defined template, invoke a <code>POST</code> request with no payload and an extra request parameter:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>POST /v2/caches/{cacheName}?template={templateName}</code></pre> </div> </div> </div> </div> <div class="sect4"> <h5 id="rest_v2_cache_configuration"><a class="anchor" href="#rest_v2_cache_configuration"></a>Retrieving Cache Configuration</h5> <div class="paragraph"> <p>To retrieve a Infinispan cache configuration, invoke a <code>GET</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/configurations/{name}</code></pre> </div> </div> <table class="tableblock frame-all grid-all stretch"> <caption class="title">Table 2. Headers</caption> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Header</th> <th class="tableblock halign-left valign-top">Required or Optional</th> <th class="tableblock halign-left valign-top">Parameter</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Accept</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Sets the required format to return content. Supported formats are <code>application/xml</code> and <code>application/json</code>. The default is <code>application/json</code>. See <a href="#rest_accept">Accept</a> for more information.</p></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="rest_v2_add_entries"><a class="anchor" href="#rest_v2_add_entries"></a>Adding Entries</h5> <div class="paragraph"> <p>To add entries to a named cache, invoke a <code>POST</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>POST /v2/caches/{cacheName}/{cacheKey}</code></pre> </div> </div> <div class="paragraph"> <p>The preceding request places the payload, or request body, in the <code>cacheName</code> cache with the <code>cacheKey</code> key. The request replaces any data that already exists and updates the <code>Time-To-Live</code> and <code>Last-Modified</code> values, if they apply.</p> </div> <div class="paragraph"> <p>If the specified key has an existing value, the request returns an HTTP <code>CONFLICT</code> status and the value is not updated. In this case, you should use a <code>PUT</code> request. See <a href="#rest_v2_replace_entries">Replacing Entries</a>.</p> </div> <table class="tableblock frame-all grid-all stretch"> <caption class="title">Table 3. Headers</caption> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Header</th> <th class="tableblock halign-left valign-top">Required or Optional</th> <th class="tableblock halign-left valign-top">Parameter</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Key-Content-Type</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Sets the content type for the key in the request. See <a href="#rest_key_content_type">Key-Content-Type</a> for more information.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Content-Type</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Sets the <a href="https://en.wikipedia.org/wiki/Media_type">MediaType</a> of the value for the key.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>timeToLiveSeconds</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Sets the number of seconds before the entry is automatically deleted. If you do not set this parameter, Infinispan uses the default value from the configuration. If you set a negative value, the entry is never deleted.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxIdleTimeSeconds</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Sets the number of seconds that entries can be idle. If a read or write operation does not occur for an entry after the maximum idle time elapses, the entry is automatically deleted. If you do not set this parameter, Infinispan uses the default value from the configuration. If you set a negative value, the entry is never deleted.</p></td> </tr> </tbody> </table> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>If both <code>timeToLiveSeconds</code> and <code>maxIdleTimeSeconds</code> have a value of <code>0</code>, Infinispan uses the default <code>lifespan</code> and <code>maxIdle</code> values from the configuration.</p> </div> <div class="paragraph"> <p>If <em>only</em> <code>maxIdleTimeSeconds</code> has a value of <code>0</code>, Infinispan uses:</p> </div> <div class="ulist"> <ul> <li> <p>the default <code>maxIdle</code> value from the configuration.</p> </li> <li> <p>the value for <code>timeToLiveSeconds</code> that you pass as a request parameter or a value of <code>-1</code> if you do not pass a value.</p> </li> </ul> </div> <div class="paragraph"> <p>If <em>only</em> <code>timeToLiveSeconds</code> has a value of <code>0</code>, Infinispan uses:</p> </div> <div class="ulist"> <ul> <li> <p>the default <code>lifespan</code> value from the configuration.</p> </li> <li> <p>the value for <code>maxIdle</code> that you pass as a request parameter or a value of <code>-1</code> if you do not pass a value.</p> </li> </ul> </div> </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="rest_v2_replace_entries"><a class="anchor" href="#rest_v2_replace_entries"></a>Replacing Entries</h5> <div class="paragraph"> <p>To replace entries in a named cache, invoke a <code>PUT</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>PUT /v2/caches/{cacheName}/{cacheKey}</code></pre> </div> </div> <div class="paragraph"> <p>The preceding request is the same as a <code>POST</code> request to add entries to the cache. However, if the entry already exists, the <code>PUT</code> request replaces it instead of returning an HTTP <code>CONFLICT</code> status.</p> </div> </div> <div class="sect4"> <h5 id="rest_v2_retrieve_cache"><a class="anchor" href="#rest_v2_retrieve_cache"></a>Retrieving Caches By Keys</h5> <div class="paragraph"> <p>To retrieve data for a specific key in a cache, invoke a <code>GET</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/caches/{cacheName}/{cacheKey}</code></pre> </div> </div> <div class="paragraph"> <p>The preceding request returns data from the given cache, <code>cacheName</code>, under the given key, <code>cacheKey</code>, as the response body. Responses contain a <code>Content-Type</code> headers that correspond to the MediaType negotiation.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>Browsers can also access caches directly, for example as a content delivery network (CDN). Infinispan returns a unique <a href="http://en.wikipedia.org/wiki/HTTP_ETag">ETag</a> for each entry along with the <code>Last-Modified</code> and <code>Expires</code> header fields. These fields provide information about the state of the data that is returned in your request. ETags allow browsers and other clients to request only data that has changed, which conserves bandwidth.</p> </div> </td> </tr> </table> </div> <table class="tableblock frame-all grid-all stretch"> <caption class="title">Table 4. Headers</caption> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Header</th> <th class="tableblock halign-left valign-top">Required or Optional</th> <th class="tableblock halign-left valign-top">Parameter</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Key-Content-Type</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Sets the content type for the key in the request. The default is <code>application/x-java-object; type=java.lang.String</code>. See <a href="#rest_key_content_type">Key-Content-Type</a> for more information.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Accept</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Sets the required format to return content. See <a href="#rest_accept">Accept</a> for more information.</p></td> </tr> </tbody> </table> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>Append the <code>extended</code> parameter to the query string to get additional information.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /cacheName/cacheKey?extended</code></pre> </div> </div> <div class="paragraph"> <p>The preceding request returns custom headers:</p> </div> <div class="ulist"> <ul> <li> <p><code>Cluster-Primary-Owner</code> returns the node name that is the primary owner of the key.</p> </li> <li> <p><code>Cluster-Node-Name</code> returns the JGroups node name of the server that handled the request.</p> </li> <li> <p><code>Cluster-Physical-Address</code> returns the physical JGroups address of the server that handled the request.</p> </li> </ul> </div> </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="rest_v2_check_entries"><a class="anchor" href="#rest_v2_check_entries"></a>Checking if Entries Exist</h5> <div class="paragraph"> <p>To check if a specific entry exists in a cache, invoke a <code>HEAD</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>HEAD /v2/caches/{cacheName}/{cacheKey}</code></pre> </div> </div> <div class="paragraph"> <p>The preceding request returns only the header fields and the same content that you stored with the entry. For example, if you stored a String, the request returns a String. If you stored binary, base64-encoded, blobs or serialized Java objects, Infinispan does not de-serialize the content in the request.</p> </div> <div class="paragraph"> <p>As with <code>GET</code> requests, <code>HEAD</code> requests also support the <code>extended</code> parameter.</p> </div> <table class="tableblock frame-all grid-all stretch"> <caption class="title">Table 5. Headers</caption> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Header</th> <th class="tableblock halign-left valign-top">Required or Optional</th> <th class="tableblock halign-left valign-top">Parameter</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Key-Content-Type</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Sets the content type for the key in the request. The default is <code>application/x-java-object; type=java.lang.String</code>. See <a href="#rest_key_content_type">Key-Content-Type</a> for more information.</p></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="rest_v2_delete_entries"><a class="anchor" href="#rest_v2_delete_entries"></a>Deleting Entries</h5> <div class="paragraph"> <p>To delete entries from a cache, invoke a <code>DELETE</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>DELETE /v2/caches/{cacheName}/{cacheKey}</code></pre> </div> </div> <div class="paragraph"> <p>The preceding request removes the entry under <code>cacheKey</code> name from the cache.</p> </div> <table class="tableblock frame-all grid-all stretch"> <caption class="title">Table 6. Headers</caption> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Header</th> <th class="tableblock halign-left valign-top">Required or Optional</th> <th class="tableblock halign-left valign-top">Parameter</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Key-Content-Type</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Sets the content type for the key in the request. The default is <code>application/x-java-object; type=java.lang.String</code>. See <a href="#rest_key_content_type">Key-Content-Type</a> for more information.</p></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="rest_v2_remove_cache"><a class="anchor" href="#rest_v2_remove_cache"></a>Removing Caches</h5> <div class="paragraph"> <p>To remove caches, invoke a <code>DELETE</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>DELETE /v2/caches/{cacheName}</code></pre> </div> </div> <div class="paragraph"> <p>The preceding request deletes all data and removes the cache named <code>cacheName</code> from the cluster.</p> </div> </div> <div class="sect4"> <h5 id="rest_v2_clear_cache"><a class="anchor" href="#rest_v2_clear_cache"></a>Clearing Caches</h5> <div class="paragraph"> <p>To delete all data from a cache, invoke a <code>GET</code> request with the <code>?action=clear</code> parameter.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/caches/{cacheName}?action=clear</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="rest_v2_cache_size"><a class="anchor" href="#rest_v2_cache_size"></a>Getting the size of Caches</h5> <div class="paragraph"> <p>To obtain the size of the cache across the entire cluster, invoke a <code>GET</code> request with the <code>?action=size</code> parameter.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/caches/{cacheName}?action=size</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="rest_v2_query_cache"><a class="anchor" href="#rest_v2_query_cache"></a>Querying Caches</h5> <div class="paragraph"> <p>Invoke a <code>GET</code> request to perform and Ickle query on a given cache, as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/caches/{cacheName}?action=search&amp;query={ickle query}</code></pre> </div> </div> <div class="paragraph"> <p>The preceding request returns a <code>JSON</code> document that contains one or more query hits, for example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">total_results</span><span class="delimiter">&quot;</span></span> : <span class="integer">150</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">hits</span><span class="delimiter">&quot;</span></span> : [ {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">hit</span><span class="delimiter">&quot;</span></span> : {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">user1</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span> : <span class="integer">35</span>
    }
  }, {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">hit</span><span class="delimiter">&quot;</span></span> : {
       <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">user2</span><span class="delimiter">&quot;</span></span>,
       <span class="key"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span> : <span class="integer">42</span>
    }
  }, {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">hit</span><span class="delimiter">&quot;</span></span> : {
       <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">user3</span><span class="delimiter">&quot;</span></span>,
       <span class="key"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span> : <span class="integer">12</span>
    }
  } ]
}</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p><code>total_results</code> displays the total number of results from the query.</p> </li> <li> <p><code>hits</code> is an array of matches from the query.</p> </li> <li> <p><code>hit</code> is an object that matches the query. Each hit can contain all fields or a subset of fields if you use a <code>Select</code> clause.</p> </li> </ul> </div> <table class="tableblock frame-all grid-all stretch"> <caption class="title">Table 7. Request Parameters</caption> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Parameter</th> <th class="tableblock halign-left valign-top">Required or Optional</th> <th class="tableblock halign-left valign-top">Value</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>query</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">REQUIRED</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the query string.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>max_results</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Sets the number of results to return. The default is <code>10</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>offset</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the index of the first result to return. The default is <code>0</code>.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>query_mode</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Specifies how the Infinispan server executes the query. Values are <code>FETCH</code> and <code>BROADCAST</code>. The default is <code>FETCH</code>.</p></td> </tr> </tbody> </table> <div class="paragraph"> <p>To use the body of the request instead of specifying query parameters, invoke a <code>POST</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>POST /v2/caches/{cacheName}?action=search</code></pre> </div> </div> <div class="paragraph"> <p>The following is an example of a query in the request body:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json">{
 <span class="key"><span class="delimiter">&quot;</span><span class="content">query</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">from Entity where name:</span><span class="char">\&quot;</span><span class="content">user1</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>,
 <span class="key"><span class="delimiter">&quot;</span><span class="content">max_results</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span>,
 <span class="key"><span class="delimiter">&quot;</span><span class="content">offset</span><span class="delimiter">&quot;</span></span>:<span class="integer">10</span>
}</code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="rest_server_cluster"><a class="anchor" href="#rest_server_cluster"></a>8.6.2. Monitoring Infinispan Clusters</h4> <div class="paragraph"> <p>Use the REST API to monitor Infinispan clusters.</p> </div> <div class="sect4"> <h5 id="rest_server_cluster_get"><a class="anchor" href="#rest_server_cluster_get"></a>Retrieving Cluster Information</h5> <div class="paragraph"> <p>To retrieve information about a Infinispan cluster, invoke a <code>GET</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/cluster</code></pre> </div> </div> <div class="paragraph"> <p>The preceding request returns information such as the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">clusterName</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">healthStatus</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">HEALTHY</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">numberOfNodes</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">nodeNames</span><span class="delimiter">&quot;</span></span>:[
      <span class="string"><span class="delimiter">&quot;</span><span class="content">NodeA</span><span class="delimiter">&quot;</span></span>,
      <span class="string"><span class="delimiter">&quot;</span><span class="content">NodeB</span><span class="delimiter">&quot;</span></span>
   ]
}</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p><code>clusterName</code> specifies the name of the cluster as defined in the configuration.</p> </li> <li> <p><code>healthStatus</code> provides one of the following:</p> <div class="ulist"> <ul> <li> <p><code>UNHEALTHY</code> indicates at least one of the caches is in degraded mode.</p> </li> <li> <p><code>REBALANCING</code> indicates at least one cache is in the rebalancing state.</p> </li> <li> <p><code>HEALTHY</code> indicates all cache instances in the cluster are operating as expected.</p> </li> </ul> </div> </li> <li> <p><code>numberOfNodes</code> displays the total number of cluster members. Returns a value of <code>0</code> for non-clustered (standalone) servers.</p> </li> <li> <p><code>nodeNames</code> is an array of all cluster members. Empty for standalone servers.</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="rest_server_cluster_head"><a class="anchor" href="#rest_server_cluster_head"></a>Check availability</h5> <div class="paragraph"> <p>To check that a Infinispan exists and is available, invoke a <code>HEAD</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>HEAD /v2/cluster</code></pre> </div> </div> <div class="paragraph"> <p>If the preceding request returns a successful response code then the Infinispan REST server is running and serving requests.</p> </div> </div> </div> <div class="sect3"> <h4 id="rest_server_counters"><a class="anchor" href="#rest_server_counters"></a>8.6.3. Counter</h4> <div class="paragraph"> <p>Use the REST API to work with counters.</p> </div> <div class="sect4"> <h5 id="rest_server_counters_create"><a class="anchor" href="#rest_server_counters_create"></a>Creating a Counter</h5> <div class="paragraph"> <p>To create a counter, use a <code>POST</code> request with the configuration as payload.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>POST /v2/counters/{counterName}</code></pre> </div> </div> <div class="paragraph"> <p>The payload must contain a JSON configuration of the counter. Example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">weak-counter</span><span class="delimiter">&quot;</span></span>:{
        <span class="key"><span class="delimiter">&quot;</span><span class="content">initial-value</span><span class="delimiter">&quot;</span></span>:<span class="integer">5</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">storage</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENT</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">concurrency-level</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>
    }
}</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">strong-counter</span><span class="delimiter">&quot;</span></span>:{
        <span class="key"><span class="delimiter">&quot;</span><span class="content">initial-value</span><span class="delimiter">&quot;</span></span>:<span class="integer">3</span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">storage</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENT</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">upper-bound</span><span class="delimiter">&quot;</span></span>:{
            <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>:<span class="integer">5</span>
        }
    }
}</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="rest_server_counters_delete"><a class="anchor" href="#rest_server_counters_delete"></a>Deleting a Counter</h5> <div class="paragraph"> <p>To delete a counter, send a <code>DELETE</code> request with the counter name.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>DELETE /v2/counters/{counterName}</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="rest_server_counters_config"><a class="anchor" href="#rest_server_counters_config"></a>Retrieving Counters Configuration</h5> <div class="paragraph"> <p>The get the counter configuration, use a <code>GET</code> request with the counter name.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/counters/{counterName}/config</code></pre> </div> </div> <div class="paragraph"> <p>The result will be a JSON representation of the counter config.</p> </div> </div> <div class="sect4"> <h5 id="rest_server_counters_add"><a class="anchor" href="#rest_server_counters_add"></a>Adding Values to Counters</h5> <div class="paragraph"> <p>To add a value to a named counter, invoke a <code>POST</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>POST /v2/counters/{counterName}</code></pre> </div> </div> <div class="paragraph"> <p>If the request payload is empty, the counter is incremented by one, otherwise the payload is interpreted as a signed long and added to the counter.</p> </div> <div class="paragraph"> <p>Request responses depend on the type of counter, as follows:</p> </div> <div class="ulist"> <ul> <li> <p><code>WEAK</code> counters return empty responses.</p> </li> <li> <p><code>STRONG</code> counters return their values after the operation is applied.</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>This method processes only <code>plain/text</code> content.</p> </div> </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="rest_server_counters_get"><a class="anchor" href="#rest_server_counters_get"></a>Getting a Counter Value</h5> <div class="paragraph"> <p>To retrieve the value of a counter, invoke a <code>GET</code> request.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/counters/{counterName}</code></pre> </div> </div> <table class="tableblock frame-all grid-all stretch"> <caption class="title">Table 8. Headers</caption> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Header</th> <th class="tableblock halign-left valign-top">Required or Optional</th> <th class="tableblock halign-left valign-top">Parameter</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="#rest_accept">Accept</a></code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">OPTIONAL</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The required format to return the content. Supported formats are <em>application/json</em> and <em>text/plain</em>. JSON is assumed if no header is provided.</p></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="rest_server_counters_reset"><a class="anchor" href="#rest_server_counters_reset"></a>Reseting Counters</h5> <div class="paragraph"> <p>To reset counters, use a <code>GET</code> request with the <code>?action=reset</code> parameter.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/counters/{counterName}?action=reset</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="rest_server_counters_inc_weak"><a class="anchor" href="#rest_server_counters_inc_weak"></a>Incrementing Counters</h5> <div class="paragraph"> <p>To increment a Counter, use the <code>?action=increment</code> parameter.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/counters/{counterName}?action=increment</code></pre> </div> </div> <div class="paragraph"> <p>Request responses depend on the type of counter, as follows:</p> </div> <div class="ulist"> <ul> <li> <p><code>WEAK</code> counters return empty responses.</p> </li> <li> <p><code>STRONG</code> counters return their values after the operation is applied.</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="rest_server_counters_add_weak"><a class="anchor" href="#rest_server_counters_add_weak"></a>Adding a delta to Counters</h5> <div class="paragraph"> <p>To add an arbitrary amount to a Counter, use the params <code>?action=add</code> and <code>delta</code>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/counters/{counterName}?action=add&amp;delta={delta}</code></pre> </div> </div> <div class="paragraph"> <p>Request responses depend on the type of counter, as follows:</p> </div> <div class="ulist"> <ul> <li> <p><code>WEAK</code> counters return empty responses.</p> </li> <li> <p><code>STRONG</code> counters return their values after the operation is applied.</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="rest_server_counters_dec_strong"><a class="anchor" href="#rest_server_counters_dec_strong"></a>Decrementing Counters</h5> <div class="paragraph"> <p>To increment a Counter, use the <code>?action=decrement</code> parameter.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/counters/{counterName}?action=decrement</code></pre> </div> </div> <div class="paragraph"> <p>Request responses depend on the type of counter, as follows:</p> </div> <div class="ulist"> <ul> <li> <p><code>WEAK</code> counters return empty responses.</p> </li> <li> <p><code>STRONG</code> counters return their values after the operation is applied.</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="rest_server_counters_cmpset"><a class="anchor" href="#rest_server_counters_cmpset"></a>compareAndSet Strong Counters</h5> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/counters/{counterName}?action=compareAndSet&amp;expect={expect}&amp;update={update}</code></pre> </div> </div> <div class="paragraph"> <p>Atomically sets the value to {update} if the current value is {expect}</p> </div> <div class="paragraph"> <p>Returns <em>true</em> if successful.</p> </div> </div> <div class="sect4"> <h5 id="rest_server_counters_cmpswp"><a class="anchor" href="#rest_server_counters_cmpswp"></a>compareAndSwap Strong Counter</h5> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>GET /v2/counters/{counterName}?action=compareAndSwap&amp;expect={expect}&amp;update={update}</code></pre> </div> </div> <div class="paragraph"> <p>Atomically sets the value to {update} if the current value is {expect}. Returns the previous value in the payload if the operation is successful.</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="client_side_code"><a class="anchor" href="#client_side_code"></a>8.7. Client-Side Code</h3> <div class="paragraph"> <p>Part of the point of a RESTful service is that you don&#8217;t need to have tightly coupled client libraries/bindings. All you need is a HTTP client library. For Java, Apache HTTP Commons Client works just fine (and is used in the integration tests), or you can use java.net API.</p> </div> <div class="sect3"> <h4 id="rest_server_client_ruby"><a class="anchor" href="#rest_server_client_ruby"></a>8.7.1. Ruby example</h4> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="ruby"><span class="comment"># Shows how to interact with the REST api from ruby.</span>
<span class="comment"># No special libraries, just standard net/http</span>
<span class="comment">#</span>
<span class="comment"># Author: Michael Neale</span>
<span class="comment">#</span>
require <span class="string"><span class="delimiter">'</span><span class="content">net/http</span><span class="delimiter">'</span></span>

uri = <span class="constant">URI</span>.parse(<span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080/rest/default/MyKey</span><span class="delimiter">'</span></span>)
http = <span class="constant">Net</span>::<span class="constant">HTTP</span>.new(uri.host, uri.port)

<span class="comment">#Create new entry</span>

post = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Post</span>.new(uri.path, {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>})
post.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)
post.body = <span class="string"><span class="delimiter">&quot;</span><span class="content">DATA HERE</span><span class="delimiter">&quot;</span></span>

resp = http.request(post)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">POST response code : </span><span class="delimiter">&quot;</span></span> + resp.code

<span class="comment">#get it back</span>

get = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Get</span>.new(uri.path)
get.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)
resp = http.request(get)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">GET response code: </span><span class="delimiter">&quot;</span></span> + resp.code
puts <span class="string"><span class="delimiter">&quot;</span><span class="content">GET Body: </span><span class="delimiter">&quot;</span></span> + resp.body

<span class="comment">#use PUT to overwrite</span>

put = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Put</span>.new(uri.path, {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>})
put.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)
put.body = <span class="string"><span class="delimiter">&quot;</span><span class="content">ANOTHER DATA HERE</span><span class="delimiter">&quot;</span></span>

resp = http.request(put)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">PUT response code : </span><span class="delimiter">&quot;</span></span> + resp.code

<span class="comment">#and remove...</span>
delete = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Delete</span>.new(uri.path)
delete.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)

resp = http.request(delete)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">DELETE response code : </span><span class="delimiter">&quot;</span></span> + resp.code

<span class="comment">#Create binary data like this... just the same...</span>

uri = <span class="constant">URI</span>.parse(<span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080/rest/default/MyLogo</span><span class="delimiter">'</span></span>)
put = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Put</span>.new(uri.path, {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">application/octet-stream</span><span class="delimiter">&quot;</span></span>})
put.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)
put.body = <span class="constant">File</span>.read(<span class="string"><span class="delimiter">'</span><span class="content">./logo.png</span><span class="delimiter">'</span></span>)

resp = http.request(put)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">PUT response code : </span><span class="delimiter">&quot;</span></span> + resp.code

<span class="comment">#and if you want to do json...</span>
require <span class="string"><span class="delimiter">'</span><span class="content">rubygems</span><span class="delimiter">'</span></span>
require <span class="string"><span class="delimiter">'</span><span class="content">json</span><span class="delimiter">'</span></span>

<span class="comment">#now for fun, lets do some JSON !</span>
uri = <span class="constant">URI</span>.parse(<span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080/rest/jsonCache/user</span><span class="delimiter">'</span></span>)
put = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Put</span>.new(uri.path, {<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>})
put.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)

data = {<span class="symbol">:name</span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">michael</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:age</span> =&gt; <span class="integer">42</span> }
put.body = data.to_json

resp = http.request(put)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">PUT response code : </span><span class="delimiter">&quot;</span></span> + resp.code

get = <span class="constant">Net</span>::<span class="constant">HTTP</span>::<span class="constant">Get</span>.new(uri.path)
get.basic_auth(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>)
resp = http.request(get)

puts <span class="string"><span class="delimiter">&quot;</span><span class="content">GET Body: </span><span class="delimiter">&quot;</span></span> + resp.body</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="rest_server_client_python"><a class="anchor" href="#rest_server_client_python"></a>8.7.2. Python 3 example</h4> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">urllib.request</span>

<span class="comment"># Setup basic auth</span>
base_uri = <span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080/rest/default</span><span class="delimiter">'</span></span>
auth_handler = urllib.request.HTTPBasicAuthHandler()
auth_handler.add_password(user=<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>, passwd=<span class="string"><span class="delimiter">'</span><span class="content">pass</span><span class="delimiter">'</span></span>, realm=<span class="string"><span class="delimiter">'</span><span class="content">ApplicationRealm</span><span class="delimiter">'</span></span>, uri=base_uri)
opener = urllib.request.build_opener(auth_handler)
urllib.request.install_opener(opener)

<span class="comment"># putting data in</span>
data = <span class="string"><span class="delimiter">&quot;</span><span class="content">SOME DATA HERE </span><span class="content">\!</span><span class="delimiter">&quot;</span></span>

req = urllib.request.Request(url=base_uri + <span class="string"><span class="delimiter">'</span><span class="content">/Key</span><span class="delimiter">'</span></span>, data=data.encode(<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>), method=<span class="string"><span class="delimiter">'</span><span class="content">PUT</span><span class="delimiter">'</span></span>,
                             headers={<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>})
<span class="keyword">with</span> urllib.request.urlopen(req) <span class="keyword">as</span> f:
    <span class="keyword">pass</span>

print(f.status)
print(f.reason)

<span class="comment"># getting data out</span>
resp = urllib.request.urlopen(base_uri + <span class="string"><span class="delimiter">'</span><span class="content">/Key</span><span class="delimiter">'</span></span>)
print(resp.read().decode(<span class="string"><span class="delimiter">'</span><span class="content">utf-8</span><span class="delimiter">'</span></span>))</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="rest_server_client_java"><a class="anchor" href="#rest_server_client_java"></a>8.7.3. Java example</h4> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.infinispan</span>;

<span class="keyword">import</span> <span class="include">java.io.BufferedReader</span>;
<span class="keyword">import</span> <span class="include">java.io.IOException</span>;
<span class="keyword">import</span> <span class="include">java.io.InputStreamReader</span>;
<span class="keyword">import</span> <span class="include">java.io.OutputStreamWriter</span>;
<span class="keyword">import</span> <span class="include">java.net.HttpURLConnection</span>;
<span class="keyword">import</span> <span class="include">java.net.URL</span>;
<span class="keyword">import</span> <span class="include">java.util.Base64</span>;

<span class="comment">/**
 * Rest example accessing a cache.
 *
 * @author Samuel Tauil (samuel@redhat.com)
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RestExample</span> {

    <span class="comment">/**
     * Method that puts a String value in cache.
     *
     * @param urlServerAddress URL containing the cache and the key to insert
     * @param value            Text to insert
     * @param user             Used for basic auth
     * @param password         Used for basic auth
     */</span>
    <span class="directive">public</span> <span class="type">void</span> putMethod(<span class="predefined-type">String</span> urlServerAddress, <span class="predefined-type">String</span> value, <span class="predefined-type">String</span> user, <span class="predefined-type">String</span> password) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Executing PUT</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">URL</span> address = <span class="keyword">new</span> <span class="predefined-type">URL</span>(urlServerAddress);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">executing request </span><span class="delimiter">&quot;</span></span> + urlServerAddress);
        <span class="predefined-type">HttpURLConnection</span> connection = (<span class="predefined-type">HttpURLConnection</span>) address.openConnection();
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Executing put method of value: </span><span class="delimiter">&quot;</span></span> + value);
        connection.setRequestMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">PUT</span><span class="delimiter">&quot;</span></span>);
        connection.setRequestProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>);
        addAuthorization(connection, user, password);
        connection.setDoOutput(<span class="predefined-constant">true</span>);

        <span class="predefined-type">OutputStreamWriter</span> outputStreamWriter = <span class="keyword">new</span> <span class="predefined-type">OutputStreamWriter</span>(connection.getOutputStream());
        outputStreamWriter.write(value);

        connection.connect();
        outputStreamWriter.flush();
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(connection.getResponseCode() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> + connection.getResponseMessage());
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
        connection.disconnect();
    }

    <span class="comment">/**
     * Method that gets a value by a key in url as param value.
     *
     * @param urlServerAddress URL containing the cache and the key to read
     * @param user             Used for basic auth
     * @param password         Used for basic auth
     * @return String value
     */</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getMethod(<span class="predefined-type">String</span> urlServerAddress, <span class="predefined-type">String</span> user, <span class="predefined-type">String</span> password) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="predefined-type">String</span> line;
        <span class="predefined-type">StringBuilder</span> stringBuilder = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>();

        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Executing GET</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);

        <span class="predefined-type">URL</span> address = <span class="keyword">new</span> <span class="predefined-type">URL</span>(urlServerAddress);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">executing request </span><span class="delimiter">&quot;</span></span> + urlServerAddress);

        <span class="predefined-type">HttpURLConnection</span> connection = (<span class="predefined-type">HttpURLConnection</span>) address.openConnection();
        connection.setRequestMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">GET</span><span class="delimiter">&quot;</span></span>);
        connection.setRequestProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>);
        addAuthorization(connection, user, password);
        connection.setDoOutput(<span class="predefined-constant">true</span>);

        <span class="predefined-type">BufferedReader</span> bufferedReader = <span class="keyword">new</span> <span class="predefined-type">BufferedReader</span>(<span class="keyword">new</span> <span class="predefined-type">InputStreamReader</span>(connection.getInputStream()));

        connection.connect();

        <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="predefined-constant">null</span>) {
            stringBuilder.append(line).append(<span class="string"><span class="delimiter">'</span><span class="content">\n</span><span class="delimiter">'</span></span>);
        }

        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Executing get method of value: </span><span class="delimiter">&quot;</span></span> + stringBuilder.toString());

        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(connection.getResponseCode() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> + connection.getResponseMessage());
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------------</span><span class="delimiter">&quot;</span></span>);

        connection.disconnect();

        <span class="keyword">return</span> stringBuilder.toString();
    }

    <span class="directive">private</span> <span class="type">void</span> addAuthorization(<span class="predefined-type">HttpURLConnection</span> connection, <span class="predefined-type">String</span> user, <span class="predefined-type">String</span> pass) {
        <span class="predefined-type">String</span> credentials = user + <span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span> + pass;
        <span class="predefined-type">String</span> basic = Base64.getEncoder().encodeToString(credentials.getBytes());
        connection.setRequestProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">Authorization</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Basic </span><span class="delimiter">&quot;</span></span> + basic);
    }

    <span class="comment">/**
     * Main method example.
     */</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> <span class="exception">IOException</span> {
        RestExample restExample = <span class="keyword">new</span> RestExample();
        <span class="predefined-type">String</span> user = <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>;
        <span class="predefined-type">String</span> pass = <span class="string"><span class="delimiter">&quot;</span><span class="content">pass</span><span class="delimiter">&quot;</span></span>;
        restExample.putMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/rest/default/1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan REST Test</span><span class="delimiter">&quot;</span></span>, user, pass);
        restExample.getMethod(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/rest/default/1</span><span class="delimiter">&quot;</span></span>, user, pass);
    }
}</code></pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="memcached_server"><a class="anchor" href="#memcached_server"></a>9. Memcached Server</h2> <div class="sectionbody"> <div class="paragraph"> <p>The Infinispan Server distribution contains a server module that implements the <a href="http://github.com/memcached/memcached/blob/master/doc/protocol.txt">Memcached text protocol</a>. This allows Memcached clients to talk to one or several Infinispan backed Memcached servers. These servers could either be working standalone just like Memcached does where each server acts independently and does not communicate with the rest, or they could be clustered where servers replicate or distribute their contents to other Infinispan backed Memcached servers, thus providing clients with failover capabilities. Please refer to Infinispan Server&#8217;s <a href="../server_guide/server_guide.html#memcached">memcached server guide</a> for instructions on how to configure and run a Memcached server.</p> </div> <div class="sect2"> <h3 id="memcached_client_encoding"><a class="anchor" href="#memcached_client_encoding"></a>9.1. Client Encoding</h3> <div class="paragraph"> <p>The memcached text protocol assumes data values read and written by clients are raw bytes. The support for type negotiation will come with <a href="https://github.com/memcached/memcached/wiki/BinaryProtocolRevamped#data-types">the memcached binary protocol</a> implementation, as part of <a href="https://issues.jboss.org/browse/ISPN-8726">ISPN-8726</a>.</p> </div> <div class="paragraph"> <p>Although it&#8217;s not possible for a memcached client to negotiate the data type to obtain data from the server or send data in different formats, the server can optionally be configured to handle values encoded with a certain Media Type. By setting the <code>client-encoding</code> attribute in the <code>memcached-connector</code> element, the server will return content in this configured format, and clients also send data in this format.</p> </div> <div class="paragraph"> <p>The <code>client-encoding</code> is useful when a single cache is accessed from multiple remote endpoints (Rest, HotRod, Memcached) and it allows to tailor the responses/requests to memcached text clients. For more infomarmation on interoperability between endpoints, consult the endpoint interoperability documentation.</p> </div> </div> <div class="sect2"> <h3 id="command_clarifications"><a class="anchor" href="#command_clarifications"></a>9.2. Command Clarifications</h3> <div class="sect3"> <h4 id="flush_all"><a class="anchor" href="#flush_all"></a>9.2.1. Flush All</h4> <div class="paragraph"> <p>Even in a clustered environment, flush_all command leads to the clearing of the Infinispan Memcached server where the call lands. There&#8217;s no attempt to propagate this flush to other nodes in the cluster. This is done so that flush_all with delay use case can be reproduced with the Infinispan Memcached server. The aim of passing a delay to flush_all is so that different Memcached servers in a full can be flushed at different times, and hence avoid overloading the database with requests as a result of all Memcached servers being empty. For more info, check the <a href="http://github.com/memcached/memcached/blob/master/doc/protocol.txt">Memcached text protocol section on flush_all</a> .</p> </div> </div> </div> <div class="sect2"> <h3 id="unsupported_features"><a class="anchor" href="#unsupported_features"></a>9.3. Unsupported Features</h3> <div class="paragraph"> <p>This section explains those parts of the memcached text protocol that for one reason or the other, are not currently supported by the Infinispan based memcached implementation.</p> </div> <div class="sect3"> <h4 id="individual_stats"><a class="anchor" href="#individual_stats"></a>9.3.1. Individual Stats</h4> <div class="paragraph"> <p>Due to difference in nature between the original memcached implementation which is C/C\\ based and the Infinispan implementation which is Java based, there&#8217;re some general purpose stats that are not supported. For these unsupported stats, Infinispan memcached server always returns 0.</p> </div> <div class="ulist"> <div class="title">Unsupported statistics</div> <ul> <li> <p>pid</p> </li> <li> <p>pointer_size</p> </li> <li> <p>rusage_user</p> </li> <li> <p>rusage_system</p> </li> <li> <p>bytes</p> </li> <li> <p>curr_connections</p> </li> <li> <p>total_connections</p> </li> <li> <p>connection_structures</p> </li> <li> <p>auth_cmds</p> </li> <li> <p>auth_errors</p> </li> <li> <p>limit_maxbytes</p> </li> <li> <p>threads</p> </li> <li> <p>conn_yields</p> </li> <li> <p>reclaimed</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="statistic_settings"><a class="anchor" href="#statistic_settings"></a>9.3.2. Statistic Settings</h4> <div class="paragraph"> <p>The settings statistics section of the text protocol has not been implemented due to its volatility.</p> </div> </div> <div class="sect3"> <h4 id="settings_with_arguments_parameter"><a class="anchor" href="#settings_with_arguments_parameter"></a>9.3.3. Settings with Arguments Parameter</h4> <div class="paragraph"> <p>Since the arguments that can be send to the Memcached server are not documented, Infinispan Memcached server does not support passing any arguments to stats command. If any parameters are passed, the Infinispan Memcached server will respond with a CLIENT_ERROR .</p> </div> </div> <div class="sect3"> <h4 id="delete_hold_time_parameter"><a class="anchor" href="#delete_hold_time_parameter"></a>9.3.4. Delete Hold Time Parameter</h4> <div class="paragraph"> <p>Memcached does no longer honor the optional hold time parameter to delete command and so the Infinispan based memcached server does not implement such feature either.</p> </div> </div> <div class="sect3"> <h4 id="verbosity_command"><a class="anchor" href="#verbosity_command"></a>9.3.5. Verbosity Command</h4> <div class="paragraph"> <p>Verbosity command is not supported since Infinispan logging cannot be simplified to defining the logging level alone.</p> </div> </div> </div> <div class="sect2"> <h3 id="talking_to_infinispan_memcached_servers_from_non_java_clients"><a class="anchor" href="#talking_to_infinispan_memcached_servers_from_non_java_clients"></a>9.4. Talking To Infinispan Memcached Servers From Non-Java Clients</h3> <div class="paragraph"> <p>This section shows how to talk to Infinispan memcached server via non-java client, such as a python script.</p> </div> <div class="sect3"> <h4 id="multi_clustered_server_tutorial"><a class="anchor" href="#multi_clustered_server_tutorial"></a>9.4.1. Multi Clustered Server Tutorial</h4> <div class="paragraph"> <p>The example showcases the distribution capabilities of Infinispan memcached severs that are not available in the original memcached implementation.</p> </div> <div class="ulist"> <ul> <li> <p>Start two clustered nodes: This configuration is the same one used for the GUI demo:</p> <div class="literalblock"> <div class="content"> <pre>$ ./bin/standalone.sh -c clustered.xml -Djboss.node.name=nodeA
$ ./bin/standalone.sh -c clustered.xml -Djboss.node.name=nodeB -Djboss.socket.binding.port-offset=100</pre> </div> </div> </li> </ul> </div> <div class="paragraph"> <p>Alternatively use</p> </div> <div class="literalblock"> <div class="content"> <pre>$ ./bin/domain.sh</pre> </div> </div> <div class="paragraph"> <p>Which automatically starts two nodes.</p> </div> <div class="ulist"> <ul> <li> <p>Execute <a href="https://github.com/infinispan/infinispan/tree/master/server/memcached/src/test/resources/test_memcached_write.py">test_memcached_write.py</a> script which basically executes several write operations against the Infinispan memcached server bound to port 11211. If the script is executed successfully, you should see an output similar to this:</p> <div class="literalblock"> <div class="content"> <pre>Connecting to 127.0.0.1:11211
Testing set ['Simple_Key': Simple value] ... OK
Testing set ['Expiring_Key' : 999 : 3] ... OK
Testing increment 3 times ['Incr_Key' : starting at 1 ]
Initialise at 1 ... OK
Increment by one ... OK
Increment again ... OK
Increment yet again ... OK
Testing decrement 1 time ['Decr_Key' : starting at 4 ]
Initialise at 4 ... OK
Decrement by one ... OK
Testing decrement 2 times in one call ['Multi_Decr_Key' : 3 ]
Initialise at 3 ... OK
Decrement by 2 ... OK</pre> </div> </div> </li> <li> <p>Execute <a href="https://github.com/infinispan/infinispan/tree/master/server/memcached/src/test/resources/test_memcached_read.py">test_memcached_read.py</a> script which connects to server bound to 127.0.0.1:11311 and verifies that it can read the data that was written by the writer script to the first server. If the script is executed successfully, you should see an output similar to this:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code> Connecting to 127.0.0.1:11311
 Testing get ['Simple_Key'] should return Simple value ... OK
 Testing get ['Expiring_Key'] should return nothing... OK
 Testing get ['Incr_Key'] should return 4 ... OK
 Testing get ['Decr_Key'] should return 3 ... OK
 Testing get ['Multi_Decr_Key'] should return 1 ... OK</code></pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="scripting"><a class="anchor" href="#scripting"></a>10. Scripting</h2> <div class="sectionbody"> <div class="paragraph"> <p>Scripting is a feature of Infinispan Server which allows invoking server-side scripts from remote clients. Scripting leverages the JDK&#8217;s javax.script ScriptEngines, therefore allowing the use of any JVM languages which offer one. By default, the JDK comes with Nashorn, a ScriptEngine capable of running JavaScript.</p> </div> <div class="sect2"> <h3 id="installing_scripts"><a class="anchor" href="#installing_scripts"></a>10.1. Installing scripts</h3> <div class="paragraph"> <p>Scripts are stored in a special script cache, named '___script_cache'. Adding a script is therefore as simple as put+ting it into the cache itself. If the name of the script contains a filename extension, e.g. +myscript.js, then that extension determines the engine that will be used to execute it. Alternatively the script engine can be selected using script metadata (see below). Be aware that, when security is enabled, access to the script cache via the remote protocols requires that the user belongs to the '___script_manager' role.</p> </div> </div> <div class="sect2"> <h3 id="script_metadata"><a class="anchor" href="#script_metadata"></a>10.2. Script metadata</h3> <div class="paragraph"> <p>Script metadata is additional information about the script that the user can provide to the server to affect how a script is executed. It is contained in a specially-formatted comment on the first lines of the script.</p> </div> <div class="paragraph"> <p>Properties are specified as key=value pairs, separated by commas. You can use several different comment styles: The <code>//</code>, <code>;;</code>, <code>#</code> depending on the scripting language you use. You can split metadata over multiple lines if necessary, and you can use single (') or double (") quotes to delimit your values.</p> </div> <div class="paragraph"> <p>The following are examples of valid metadata comments:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// name=test, language=javascript</span>
<span class="comment">// mode=local, parameters=[a,b,c]</span></code></pre> </div> </div> <div class="sect3"> <h4 id="metadata_properties"><a class="anchor" href="#metadata_properties"></a>10.2.1. Metadata properties</h4> <div class="paragraph"> <p>The following metadata property keys are available</p> </div> <div class="ulist"> <ul> <li> <p>mode: defines the mode of execution of a script. Can be one of the following values:</p> <div class="ulist"> <ul> <li> <p>local: the script will be executed only by the node handling the request. The script itself however can invoke clustered operations</p> </li> <li> <p>distributed: runs the script using the Distributed Executor Service</p> </li> </ul> </div> </li> <li> <p>language: defines the script engine that will be used to execute the script, e.g. Javascript</p> </li> <li> <p>extension: an alternative method of specifying the script engine that will be used to execute the script, e.g. js</p> </li> <li> <p>role: a specific role which is required to execute the script</p> </li> <li> <p>parameters: an array of valid parameter names for this script. Invocations which specify parameter names not included in this list will cause an exception.</p> </li> <li> <p>datatype: optional property providing information, in the form of Media Types (also known as MIME) about the type of the data stored in the caches, as well as parameter and return values. Currently it only accepts a single value which is <code>text/plain; charset=utf-8</code>, indicating that data is String UTF-8 format. This metadata parameter is designed for remote clients that only support a particular type of data, making it easy for them to retrieve, store and work with parameters.</p> </li> </ul> </div> <div class="paragraph"> <p>Since the execution mode is a characteristic of the script, nothing special needs to be done on the client to invoke scripts in different modes.</p> </div> </div> </div> <div class="sect2"> <h3 id="script_bindings"><a class="anchor" href="#script_bindings"></a>10.3. Script bindings</h3> <div class="paragraph"> <p>The script engine within Infinispan exposes several internal objects as bindings in the scope of the script execution. These are:</p> </div> <div class="ulist"> <ul> <li> <p>cache: the cache against which the script is being executed</p> </li> <li> <p>marshaller: the marshaller to use for marshalling/unmarshalling data to the cache</p> </li> <li> <p>cacheManager: the cacheManager for the cache</p> </li> <li> <p>scriptingManager: the instance of the script manager which is being used to run the script. This can be used to run other scripts from a script.</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="script_parameters"><a class="anchor" href="#script_parameters"></a>10.4. Script parameters</h3> <div class="paragraph"> <p>Aside from the standard bindings described above, when a script is executed it can be passed a set of named parameters which also appear as bindings. Parameters are passed as name,value pairs where name is a string and value can be any value that is understood by the marshaller in use.</p> </div> <div class="paragraph"> <p>The following is an example of a JavaScript script which takes two parameters, multiplicand and multiplier and multiplies them. Because the last operation is an expression evaluation, its result is returned to the invoker.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// mode=local,language=javascript</span>
multiplicand * multiplier</code></pre> </div> </div> <div class="paragraph"> <p>To store the script in the script cache, use the following Hot Rod code:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; scriptCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">___script_cache</span><span class="delimiter">&quot;</span></span>);
scriptCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">multiplication.js</span><span class="delimiter">&quot;</span></span>,
  <span class="string"><span class="delimiter">&quot;</span><span class="content">// mode=local,language=javascript</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> +
  <span class="string"><span class="delimiter">&quot;</span><span class="content">multiplicand * multiplier</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="running_scripts_using_the_hot_rod_java_client"><a class="anchor" href="#running_scripts_using_the_hot_rod_java_client"></a>10.5. Running Scripts using the Hot Rod Java client</h3> <div class="paragraph"> <p>The following example shows how to invoke the above script by passing two named parameters.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; cache = cacheManager.getCache();
<span class="comment">// Create the parameters for script execution</span>
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
params.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">multiplicand</span><span class="delimiter">&quot;</span></span>, <span class="integer">10</span>);
params.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">multiplier</span><span class="delimiter">&quot;</span></span>, <span class="integer">20</span>);
<span class="comment">// Run the script on the server, passing in the parameters</span>
<span class="predefined-type">Object</span> result = cache.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">multiplication.js</span><span class="delimiter">&quot;</span></span>, params);</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="distributed_execution"><a class="anchor" href="#distributed_execution"></a>10.6. Distributed execution</h3> <div class="paragraph"> <p>The following is a script which runs on all nodes. Each node will return its address, and the results from all nodes will be collected in a List and returned to the client.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// mode:distributed,language=javascript</span>
cacheManager.getAddress().toString();</code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="server_tasks"><a class="anchor" href="#server_tasks"></a>11. Server Tasks</h2> <div class="sectionbody"> <div class="paragraph"> <p>Server tasks are server-side scripts defined in Java language.</p> </div> <div class="sect2"> <h3 id="implementing_server_tasks"><a class="anchor" href="#implementing_server_tasks"></a>11.1. Implementing Server Tasks</h3> <div class="paragraph"> <p>To develop a server task, you should define a class that extends <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/tasks/ServerTask.html"><code>org.infinispan.tasks.ServerTask</code></a> interface, defined in <code>infinispan-tasks-api</code> module.</p> </div> <div class="paragraph"> <p>A typical server task implementation would implement these methods:</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/tasks/ServerTask.html#setTaskContext-org.infinispan.tasks.TaskContext-"><code>setTaskContext</code></a> allows server tasks implementors to access execution context information. This includes task parameters, cache reference on which the task is executed&#8230;&#8203;etc. Normally, implementors would store this information locally and use it when the task is actually executed.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/tasks/Task.html#getName--"><code>getName</code></a> should return a unique name for the task. The client will use this name to to invoke the task.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/tasks/Task.html#getExecutionMode--"><code>getExecutionMode</code></a> is used to decide whether to invoke the task in 1 node in a cluster of N nodes or invoke it in N nodes. For example, server tasks that invoke stream processing are only required to be executed in 1 node in the cluster. This is because stream processing itself makes sure processing is distributed to all nodes in cluster.</p> </li> <li> <p><a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Callable.html?is-external=true#call--"><code>call</code></a> is the method that&#8217;s invoked when the user invokes the server task.</p> </li> </ul> </div> <div class="paragraph"> <p>Here&#8217;s an example of a hello greet task that takes as parameter the name of the person to greet.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example</span>;

<span class="keyword">import</span> <span class="include">org.infinispan.tasks.ServerTask</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.tasks.TaskContext</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">HelloTask</span> <span class="directive">implements</span> ServerTask&lt;<span class="predefined-type">String</span>&gt; {

   <span class="directive">private</span> TaskContext ctx;

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> setTaskContext(TaskContext ctx) {
      <span class="local-variable">this</span>.ctx = ctx;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> call() <span class="directive">throws</span> <span class="exception">Exception</span> {
      <span class="predefined-type">String</span> name = (<span class="predefined-type">String</span>) ctx.getParameters().get().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>);
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + name;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello-task</span><span class="delimiter">&quot;</span></span>;
   }

}</code></pre> </div> </div> <div class="paragraph"> <p>Once the task has been implemented, it needs to be wrapped inside a jar. The jar is then deployed to the Infinispan Server and from them on it can be invoked. The Infinispan Server uses <a href="https://docs.oracle.com/javase/8/docs/api/java/util/ServiceLoader.html">service loader pattern</a> to load the task, so implementations need to adhere to these requirements. For example, server task implementations must have a zero-argument constructor.</p> </div> <div class="paragraph"> <p>Moreover, the jar must contain a <code>META-INF/services/org.infinispan.tasks.ServerTask</code> file containing the fully qualified name(s) of the server tasks included in the jar. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>example.HelloTask</code></pre> </div> </div> <div class="paragraph"> <p>With jar packaged, the next step is to push the jar to the Infinispan Server. The server is powered by WildFly Application Server, so if using Maven <a href="https://docs.jboss.org/wildfly/plugins/maven/latest/index.html">Wildfly&#8217;s Maven plugin</a> can be used for this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.wildfly.plugins<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>wildfly-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>1.2.0.Final<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Then call the following from command line:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="bash">$ mvn package wildfly:deploy</code></pre> </div> </div> <div class="paragraph"> <p>Alternative ways of deployment jar files to Wildfly Application Server are explained <a href="https://docs.jboss.org/author/display/WFLY10/Application+deployment">here</a>.</p> </div> <div class="paragraph"> <p>Executing the task can be done using the following code:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Create a configuration for a locally-running server</span>
ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.addServer().host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>).port(<span class="integer">11222</span>);

<span class="comment">// Connect to the server</span>
RemoteCacheManager cacheManager = <span class="keyword">new</span> RemoteCacheManager(builder.build());

<span class="comment">// Obtain the remote cache</span>
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.getCache();

<span class="comment">// Create task parameters</span>
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; parameters = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
parameters.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">developer</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Execute task</span>
<span class="predefined-type">String</span> greet = cache.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello-task</span><span class="delimiter">&quot;</span></span>, parameters);
<span class="predefined-type">System</span>.out.println(greet);</code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="health_monitoring"><a class="anchor" href="#health_monitoring"></a>12. Health monitoring</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan server has special endpoints for monitoring cluster health. The API is exposed via:</p> </div> <div class="ulist"> <ul> <li> <p>Programmatically (using <code>embeddedCacheManager.getHealth()</code>)</p> </li> <li> <p>JMX</p> </li> <li> <p>CLI</p> </li> <li> <p>REST (using <a href="https://docs.jboss.org/author/display/WFLY10/The+HTTP+management+API">WildFly HTTP Management API</a>)</p> </li> </ul> </div> <div class="sect2"> <h3 id="accessing_health_api_using_jmx"><a class="anchor" href="#accessing_health_api_using_jmx"></a>12.1. Accessing Health API using JMX</h3> <div class="paragraph"> <p>At first you need to connect to the Infinispan Server using JMX (use JConsole or other tool for this). Next, navigate to object name <code>jboss.datagrid-infinispan:type=CacheManager,name="clustered",component=CacheContainerHealth</code>.</p> </div> </div> <div class="sect2"> <h3 id="accessing_health_api_using_cli"><a class="anchor" href="#accessing_health_api_using_cli"></a>12.2. Accessing Health API using CLI</h3> <div class="paragraph"> <p>You can access the Health API from the Command Line Interface (CLI), as in the following examples:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">Standalone</dt> <dd> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>$ bin/ispn-cli.sh -c "/subsystem=datagrid-infinispan/cache-container=clustered/health=HEALTH:read-resource(include-runtime=true)"</code></pre> </div> </div> </dd> <dt class="hdlist1">Domain Mode</dt> <dd> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>$ bin/ispn-cli.sh -c "/host=master/server=${servername}/subsystem=datagrid-infinispan/cache-container=clustered/health=HEALTH:read-resource(include-runtime=true)"</code></pre> </div> </div> <div class="paragraph"> <p>Where <code>${servername}</code> is the name of the Infinispan server instance.</p> </div> </dd> </dl> </div> <div class="paragraph"> <p>The following is a sample result for the CLI invocation:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "cache-health" =&gt; "HEALTHY",
        "cluster-health" =&gt; ["test"],
        "cluster-name" =&gt; "clustered",
        "free-memory" =&gt; 99958L,
        "log-tail" =&gt; [
            "&lt;time_stamp&gt; INFO  [org.infinispan.server.endpoint] (MSC service thread 1-5) DGENDPT10001: HotRodServer listening on 127.0.0.1:11222",
            "&lt;time_stamp&gt; INFO  [org.infinispan.server.endpoint] (MSC service thread 1-1) DGENDPT10001: MemcachedServer listening on 127.0.0.1:11211",
            "&lt;time_stamp&gt; INFO  [org.jboss.as.clustering.infinispan] (MSC service thread 1-6) DGISPN0001: Started ___protobuf_metadata cache from clustered container",
            "&lt;time_stamp&gt; INFO  [org.jboss.as.clustering.infinispan] (MSC service thread 1-6) DGISPN0001: Started ___script_cache cache from clustered container",
            "&lt;time_stamp&gt; INFO  [org.jboss.as.clustering.infinispan] (MSC service thread 1-5) DGISPN0001: Started ___hotRodTopologyCache cache from clustered container",
            "&lt;time_stamp&gt; INFO  [org.infinispan.rest.NettyRestServer] (MSC service thread 1-6) ISPN012003: REST server starting, listening on 127.0.0.1:8080",
            "&lt;time_stamp&gt; INFO  [org.infinispan.server.endpoint] (MSC service thread 1-6) DGENDPT10002: REST mapped to /rest",
            "&lt;time_stamp&gt; INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0060: Http management interface listening on http://127.0.0.1:9990/management",
            "&lt;time_stamp&gt; INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0051: Admin console listening on http://127.0.0.1:9990",
            "&lt;time_stamp&gt; INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: Infinispan Server &lt;build_version&gt; (WildFly Core &lt;build_version&gt;) started in 8681ms - Started 196 of 237 services (121 services are lazy, passive or on-demand)"
        ],
        "number-of-cpus" =&gt; 8,
        "number-of-nodes" =&gt; 1,
        "total-memory" =&gt; 235520L
    }
}</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="accessing_health_api_using_rest"><a class="anchor" href="#accessing_health_api_using_rest"></a>12.3. Accessing Health API using REST</h3> <div class="paragraph"> <p>The REST interface lets you access the same set of resources as the CLI. However, the HTTP Management API requires authentication so you must first add credentials with the <code>add-user.sh</code> script.</p> </div> <div class="paragraph"> <p>After you set up credentials, access the Health API via REST as in the following examples:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">Standalone</dt> <dd> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="bash">curl --digest -L -D - &quot;http://localhost:9990/management/subsystem/datagrid-infinispan/cache-container/clustered/health/HEALTH?operation=resource&amp;include-runtime=true&amp;json.pretty=1&quot; --header &quot;Content-Type: application/json&quot; -u username:password</code></pre> </div> </div> </dd> <dt class="hdlist1">Domain Mode</dt> <dd> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="bash">curl --digest -L -D - &quot;http://localhost:9990/management/host/master/server/${servername}/subsystem/datagrid-infinispan/cache-container/clustered/health/HEALTH?operation=resource&amp;include-runtime=true&amp;json.pretty=1&quot; --header &quot;Content-Type: application/json&quot; -u username:password</code></pre> </div> </div> <div class="paragraph"> <p>Where <code>${servername}</code> is the name of the Infinispan server instance.</p> </div> </dd> </dl> </div> <div class="paragraph"> <p>The following is a sample result for the REST invocation:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code>HTTP/1.1 200 OK
Connection: keep-alive
Authentication-Info: nextnonce="AuZzFxz7uC4NMTQ3MDgyNTU1NTQ3OCfIJBHXVpPHPBdzGUy7Qts=",qop="auth",rspauth="b518c3170e627bd732055c382ce5d970",cnonce="NGViOWM0NDY5OGJmNjY0MjcyOWE4NDkyZDU3YzNhYjY=",nc=00000001
Content-Type: application/json; charset=utf-8
Content-Length: 1927
Date: &lt;time_stamp&gt;

{
    "cache-health" : "HEALTHY",
    "cluster-health" : ["test", "HEALTHY"],
    "cluster-name" : "clustered",
    "free-memory" : 96778,
    "log-tail" : [
        "&lt;time_stamp&gt; INFO  [org.infinispan.server.endpoint] (MSC service thread 1-5) DGENDPT10001: HotRodServer listening on 127.0.0.1:11222",
        "&lt;time_stamp&gt; INFO  [org.infinispan.server.endpoint] (MSC service thread 1-1) DGENDPT10001: MemcachedServer listening on 127.0.0.1:11211",
        "&lt;time_stamp&gt; INFO  [org.jboss.as.clustering.infinispan] (MSC service thread 1-6) DGISPN0001: Started ___protobuf_metadata cache from clustered container",
        "&lt;time_stamp&gt; INFO  [org.jboss.as.clustering.infinispan] (MSC service thread 1-6) DGISPN0001: Started ___script_cache cache from clustered container",
        "&lt;time_stamp&gt; INFO  [org.jboss.as.clustering.infinispan] (MSC service thread 1-5) DGISPN0001: Started ___hotRodTopologyCache cache from clustered container",
        "&lt;time_stamp&gt; INFO  [org.infinispan.rest.NettyRestServer] (MSC service thread 1-6) ISPN012003: REST server starting, listening on 127.0.0.1:8080",
        "&lt;time_stamp&gt; INFO  [org.infinispan.server.endpoint] (MSC service thread 1-6) DGENDPT10002: REST mapped to /rest",
        "&lt;time_stamp&gt; INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0060: Http management interface listening on http://127.0.0.1:9990/management",
        "&lt;time_stamp&gt; INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0051: Admin console listening on http://127.0.0.1:9990",
        "&lt;time_stamp&gt; INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: Infinispan Server &lt;build_version&gt; (WildFly Core &lt;build_version&gt;) started in 8681ms - Started 196 of 237 services (121 services are lazy, passive or on-demand)"
    ],
    "number-of-cpus" : 8,
    "number-of-nodes" : 1,
    "total-memory" : 235520
}%</code></pre> </div> </div> <div class="paragraph"> <p>Note that the result from the REST API is exactly the same as the one obtained by CLI.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="multi_tenancy"><a class="anchor" href="#multi_tenancy"></a>13. Multi-tenancy</h2> <div class="sectionbody"> <div class="paragraph"> <p>Multi-tenancy allows accessing multiple containers as shown below:</p> </div> <div class="imageblock"> <div class="content"> <img src="./images/multi-tenancy.png" alt="multi tenancy"> </div> </div> <div class="paragraph"> <p>Currently there are two supported protocols for accessing the data - using Hot Rod client and using REST interface.</p> </div> <div class="sect2"> <h3 id="using_rest_interface"><a class="anchor" href="#using_rest_interface"></a>13.1. Using REST interface</h3> <div class="paragraph"> <p>Multi-tenancy router uses URL prefixes to separate containers using the following template: <code><a href="https://&lt;server_ip&gt;:&lt;server_port&gt;/rest/&lt;rest_connector_name&gt;/&lt;cache_name&gt;/&lt;key&gt" class="bare">https://&lt;server_ip&gt;:&lt;server_port&gt;/rest/&lt;rest_connector_name&gt;/&lt;cache_name&gt;/&lt;key&gt</a>;</code>. All HTTP operations remain exactly the same as using standard <code>rest-connector</code>.</p> </div> <div class="paragraph"> <p>The REST connector by default support both HTTP/1.1 and HTTP/2 protocols. The switching from HTTP/1.1 to HTTP/2 procedure involves either using TLS/ALPN negotiation or HTTP/1.1 upgrade procedure. The former requires proper encryption to be enabled. The latter is always enabled.</p> </div> </div> <div class="sect2"> <h3 id="using_hot_rod_client"><a class="anchor" href="#using_hot_rod_client"></a>13.2. Using Hot Rod client</h3> <div class="paragraph"> <p>Multi-tenant routing for binary protocols requires using a standard, transport layer mechanism such as <a href="https://en.wikipedia.org/wiki/Server_Name_Indication">SSL/TLS Server Name Indication</a>. The server needs to be configured to support encryption and additional SNI routing needs to be added to the <code>router-connector</code>.</p> </div> <div class="paragraph"> <p>In order to connect to a secured Hot Rod server, the client needs to use configuration similar to this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
clientBuilder
    .addServer()
        .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>)
        .port(hotrodServer.getPort())
     .security()
        .ssl()
           .enabled(sslClient)
           .sniHostName(<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod-1</span><span class="delimiter">&quot;</span></span>) <span class="comment">// SNI Host Name</span>
           .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststore.jks</span><span class="delimiter">&quot;</span></span>)
           .trustStorePassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>.toCharArray());
remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());</code></pre> </div> </div> <div class="sect3"> <h4 id="multi_tenant_router"><a class="anchor" href="#multi_tenant_router"></a>13.2.1. Multi-tenant router</h4> <div class="paragraph"> <p>The Multi-tenant router endpoint works as a facade for one or more REST/Hot Rod connectors. Its main purpose is to forward client requests into proper container.</p> </div> <div class="paragraph"> <p>In order to properly configure the routing, <code>socket-binding</code> attributes of other connectors must be disabled and additional attribute <code>name</code> must be used as shown below:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;rest-connector</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;rest-connector</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest-2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;hotrod-connector</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;hotrod-connector</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod-2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The next step is to add a new <code>router-connector</code> endpoint and configure how other containers will be accessed. Note that Hot Rod connectors require using TLS/SNI and REST connectors require using prefix in the URL:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;router-connector</span> <span class="attribute-name">hotrod-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">rest-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">keep-alive</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">tcp-nodelay</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">receive-buffer-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1024</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">send-buffer-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1024</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;hotrod</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod-1</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
        <span class="tag">&lt;sni</span> <span class="attribute-name">host-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SSLRealm1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/hotrod&gt;</span>
    <span class="tag">&lt;hotrod</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod-2</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
        <span class="tag">&lt;sni</span> <span class="attribute-name">host-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod-2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SSLRealm2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/hotrod&gt;</span>
    <span class="tag">&lt;rest</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest-1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;prefix</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest-1</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/rest&gt;</span>
    <span class="tag">&lt;rest</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest-2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;prefix</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest-2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/rest&gt;</span>
<span class="tag">&lt;/router-connector&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>With the following configuration, Hot Rod clients will access <code>hotrod-1</code> connector when using SNI Host Name "hotrod-1". REST clients will need to use the following URL to access "rest-1" connector - <code><a href="https://&lt;server_ip&gt;:&lt;server_port&gt;/rest/rest-1" class="bare">https://&lt;server_ip&gt;:&lt;server_port&gt;/rest/rest-1</a></code>.</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="single_port"><a class="anchor" href="#single_port"></a>14. Single-Port</h2> <div class="sectionbody"> <div class="paragraph"> <p>Single-Port is a special type of router connector which allows exposing multiple protocols over the same TCP port. This approach is very convenient because it reduces the number of ports required by a server, with advantages in security, configuration and management. Protocol switching is handled in three ways:</p> </div> <div class="ulist"> <ul> <li> <p><strong>HTTP/1.1 Upgrade header</strong>: initiate an HTTP/1.1 connection and send an <code>Upgrade: protocol</code> header where protocol is the name assigned to the desired endpoint.</p> </li> <li> <p><strong>TLS/ALPN</strong>: protocol selection is performed based on the SNI specified by the client.</p> </li> <li> <p><strong>Hot Rod header detection</strong>: if a Hot Rod endpoint is present in the router configuration, then any attempt to send a Hot Rod header will be detected and the protocol will be switched automatically.</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The initial implementation supports only HTTP/1.1, HTTP/2 and Hot Rod protocols. The Memcached protocol is not supported. </td> </tr> </table> </div> <div class="sect2"> <h3 id="single_port_router"><a class="anchor" href="#single_port_router"></a>14.1. Single-Port router</h3> <div class="paragraph"> <p>Internally, Single-Port is based on the same router component used to enable multi-tenancy, and therefore it shares the same configuration.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- TLS/ALPN negotiation --&gt;</span>
<span class="tag">&lt;router-connector</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">router-ssl</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">single-port-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest-ssl</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;single-port</span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SSLRealm1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;hotrod</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;rest</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/single-port&gt;</span>
<span class="tag">&lt;/router-connector&gt;</span>
<span class="comment">&lt;!-- HTTP 1.1/Upgrade procedure --&gt;</span>
<span class="tag">&lt;router-connector</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">router</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">single-port-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;single-port&gt;</span>
        <span class="tag">&lt;hotrod</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hotrod</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;rest</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rest</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/single-port&gt;</span>
<span class="tag">&lt;/router-connector&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>With the configuration above, the Single-Port Router will operate on <code>rest</code> and <code>rest-ssl</code> socket bindings. The router named <code>router</code> should typically operate on port <code>8080</code> and will use HTTP/1.1 Upgrade (also known as <em>cleartext upgrade</em>) procedure. The other router instance (called <code>router-ssl</code>) should typically operate on port <code>8443</code> and will use TLS/ALPN.</p> </div> <div class="sect3"> <h4 id="testing_the_single_port_router"><a class="anchor" href="#testing_the_single_port_router"></a>14.1.1. Testing the Single-Port router</h4> <div class="paragraph"> <p>A tool such as <code>curl</code> can be used to access cache using both <em>cleartext upgrade</em> or TLS/ALPN. Here&#8217;s an example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="bash">curl -v -k --http2-prior-knowledge https://127.0.0.1:8443/rest/default/test</code></pre> </div> </div> <div class="paragraph"> <p>The <code>--http2-prior-knowledge</code> can be exchanged with <code>--http2</code> switch allowing to control how the switch procedure is being done (via Plain-Text Upgrade or TLS/ALPN).</p> </div> </div> </div> <div class="sect2"> <h3 id="hot_rod_2"><a class="anchor" href="#hot_rod_2"></a>14.2. Hot Rod</h3> <div class="paragraph"> <p>The single-port router has built-in automatic detection of Hot Rod messages which trigger a transparent "upgrade" to the Hot Rod protocol. This means that no changes are required on the client side to connect to a single-port endpoint. It also means that older clients will also be able to function seamlessly.</p> </div> <div class="sect3"> <h4 id="tlsalpn_protocol_selection"><a class="anchor" href="#tlsalpn_protocol_selection"></a>14.2.1. TLS/ALPN protocol selection</h4> <div class="paragraph"> <p>Another supported way to select the protocol is to use TLS/ALPN which uses the <a href="https://tools.ietf.org/html/rfc7301">Application-Layer Protocol Negotiation</a> spec. This feature requires that you have configured your endpoint to enable TLS. If you are using JDK 9 or greater, ALPN is supported out-of-the-box. However, if you are using JDK 8, you will need to use <a href="https://netty.io/wiki/forked-tomcat-native.html">Netty&#8217;s BoringSSL</a> library, which leverages native libraries to enable ALPN.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
      <span class="tag">&lt;dependency&gt;</span>
         <span class="tag">&lt;groupId&gt;</span>io.netty<span class="tag">&lt;/groupId&gt;</span>
         <span class="tag">&lt;artifactId&gt;</span>netty-bom<span class="tag">&lt;/artifactId&gt;</span>
         <span class="comment">&lt;!-- Pulled from Infinispan BOM --&gt;</span>
         <span class="tag">&lt;version&gt;</span>${version.netty}<span class="tag">&lt;/version&gt;</span>
         <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
         <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
      <span class="tag">&lt;/dependency&gt;</span>
   <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span>

<span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>io.netty<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>netty-tcnative-boringssl-static<span class="tag">&lt;/artifactId&gt;</span>
   <span class="comment">&lt;!-- The version is defined in Netty BOM --&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>After adding the library, configure your trust store accordingly:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder()
      .addServers(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1:8443</span><span class="delimiter">&quot;</span></span>);

builder.security().ssl().enable()
      .trustStoreFileName(<span class="string"><span class="delimiter">&quot;</span><span class="content">truststore.pkcs12</span><span class="delimiter">&quot;</span></span>)
      .trustStorePassword(DEFAULT_TRUSTSTORE_PASSWORD.toCharArray());

RemoteCacheManager remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(builder.build());
RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="content">);
</span></span></code></pre> </div> </div> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2019-07-12 16:02:11 UTC </div> </div> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script> <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script> </body> </html>