<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]--> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="generator" content="Asciidoctor 1.5.8"> <title>Developing for Infinispan 10.0</title> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"> <style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> <style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style> <link rel="canonical" href="http://infinispan.org/docs/stable/user_guide/user_guide.html"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css"> <link rel="stylesheet" href="../../css/css.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script> <script src="../../js/js.js"></script> </head> <body class="book toc2 toc-left"> <div id="header"> <h1>Developing for Infinispan 10.0</h1> <div id="toc" class="toc2"> <div id="toctitle">Table of Contents</div> <ul class="sectlevel1"> <li><a href="#cache_api">1. The Cache API</a> <ul class="sectlevel2"> <li><a href="#the_cache_interface">1.1. The Cache interface</a> <ul class="sectlevel3"> <li><a href="#performance_concerns_of_certain_map_methods">1.1.1. Performance Concerns of Certain Map Methods</a></li> <li><a href="#mortal_and_immortal_data">1.1.2. Mortal and Immortal Data</a></li> <li><a href="#putforexternalread_operation">1.1.3. putForExternalRead operation</a></li> </ul> </li> <li><a href="#the_advancedcache_interface">1.2. The AdvancedCache interface</a> <ul class="sectlevel3"> <li><a href="#flags">1.2.1. Flags</a></li> <li><a href="#custom_interceptors">1.2.2. Custom Interceptors</a></li> </ul> </li> <li><a href="#listeners_and_notifications">1.3. Listeners and Notifications</a> <ul class="sectlevel3"> <li><a href="#cache_level_notifications">1.3.1. Cache-level notifications</a> <ul class="sectlevel4"> <li><a href="#cluster_listeners">Cluster Listeners</a></li> <li><a href="#event_filtering_and_conversion">Event filtering and conversion</a></li> <li><a href="#initial_state_events">Initial State Events</a></li> <li><a href="#duplicate_events">Duplicate Events</a></li> </ul> </li> <li><a href="#cache_manager_level_notifications">1.3.2. Cache manager-level notifications</a></li> <li><a href="#synchronicity_of_events">1.3.3. Synchronicity of events</a> <ul class="sectlevel4"> <li><a href="#asynchronous_thread_pool">Asynchronous thread pool</a></li> </ul> </li> </ul> </li> <li><a href="#cache_asynchronous_api">1.4. Asynchronous API</a> <ul class="sectlevel3"> <li><a href="#why_use_such_an_api">1.4.1. Why use such an API?</a></li> <li><a href="#which_processes_actually_happen_asynchronously">1.4.2. Which processes actually happen asynchronously?</a></li> <li><a href="#notifying_futures">1.4.3. Notifying futures</a></li> <li><a href="#further_reading">1.4.4. Further reading</a></li> </ul> </li> <li><a href="#invocation_flags">1.5. Invocation Flags</a> <ul class="sectlevel3"> <li><a href="#examples">1.5.1. Examples</a> <ul class="sectlevel4"> <li><a href="#suppressing_return_values_from_a_put_or_remove">Suppressing return values from a put() or remove()</a></li> </ul> </li> </ul> </li> </ul> </li> <li><a href="#functional_map_api">2. Functional Map API</a> <ul class="sectlevel2"> <li><a href="#asynchronous_and_lazy">2.1. Asynchronous and Lazy</a></li> <li><a href="#function_transparency">2.2. Function transparency</a></li> <li><a href="#constructing_functional_maps">2.3. Constructing Functional Maps</a></li> <li><a href="#read_only_map_api">2.4. Read-Only Map API</a> <ul class="sectlevel3"> <li><a href="#read_only_entry_view">2.4.1. Read-Only Entry View</a></li> </ul> </li> <li><a href="#write_only_map_api">2.5. Write-Only Map API</a> <ul class="sectlevel3"> <li><a href="#write_only_entry_view">2.5.1. Write-Only Entry View</a></li> </ul> </li> <li><a href="#read_write_map_api">2.6. Read-Write Map API</a> <ul class="sectlevel3"> <li><a href="#read_write_entry_view">2.6.1. Read-Write Entry View</a></li> </ul> </li> <li><a href="#meta_parameter">2.7. Metadata Parameter Handling</a></li> <li><a href="#_invocation_parameter">2.8. Invocation Parameter</a></li> <li><a href="#functional_listeners">2.9. Functional Listeners</a> <ul class="sectlevel3"> <li><a href="#write_listeners">2.9.1. Write Listeners</a></li> <li><a href="#read_write_listeners">2.9.2. Read-Write Listeners</a></li> </ul> </li> <li><a href="#marshalling_of_functions">2.10. Marshalling of Functions</a></li> <li><a href="#use_cases_for_functional_api">2.11. Use Cases for Functional API</a></li> </ul> </li> <li><a href="#data_encoding">3. Encoding</a> <ul class="sectlevel2"> <li><a href="#overview">3.1. Overview</a></li> <li><a href="#default_encoders">3.2. Default encoders</a></li> <li><a href="#overriding_programmatically">3.3. Overriding programmatically</a></li> <li><a href="#defining_custom_encoders">3.4. Defining custom Encoders</a></li> <li><a href="#encoding_media_type">3.5. MediaType</a> <ul class="sectlevel3"> <li><a href="#configuration">3.5.1. Configuration</a></li> <li><a href="#mediatype_override">3.5.2. Overriding the MediaType Programmatically</a></li> <li><a href="#transcoders_and_encoders">3.5.3. Transcoders and Encoders</a></li> </ul> </li> </ul> </li> <li><a href="#cache_manager">4. The Embedded CacheManager</a> <ul class="sectlevel2"> <li><a href="#obtaining_caches">4.1. Obtaining caches</a></li> <li><a href="#clustering_information">4.2. Clustering Information</a></li> <li><a href="#member_information">4.3. Member Information</a></li> <li><a href="#other_methods">4.4. Other methods</a></li> </ul> </li> <li><a href="#locking_concurrency">5. Locking and Concurrency</a> <ul class="sectlevel2"> <li><a href="#locking_implementation_details">5.1. Locking implementation details</a> <ul class="sectlevel3"> <li><a href="#how_does_it_work_in_clustered_caches">5.1.1. How does it work in clustered caches?</a> <ul class="sectlevel4"> <li><a href="#non_transactional_caches">Non Transactional caches</a></li> </ul> </li> <li><a href="#transactional_caches">5.1.2. Transactional caches</a></li> <li><a href="#isolation_levels">5.1.3. Isolation levels</a></li> <li><a href="#the_lockmanager">5.1.4. The LockManager</a></li> <li><a href="#lock_striping">5.1.5. Lock striping</a></li> <li><a href="#concurrency_levels">5.1.6. Concurrency levels</a></li> <li><a href="#lock_timeout">5.1.7. Lock timeout</a></li> <li><a href="#consistency">5.1.8. Consistency</a></li> </ul> </li> <li><a href="#data_versioning">5.2. Data Versioning</a></li> </ul> </li> <li><a href="#clustered_lock">6. Clustered Lock</a> <ul class="sectlevel2"> <li><a href="#installation">6.1. Installation</a></li> <li><a href="#clusteredlock_configuration">6.2. ClusteredLock Configuration</a> <ul class="sectlevel3"> <li><a href="#clustered_lock_ownership">6.2.1. Ownership</a></li> <li><a href="#reentrancy">6.2.2. Reentrancy</a></li> </ul> </li> <li><a href="#clusteredlockmanager_interface">6.3. ClusteredLockManager Interface</a></li> <li><a href="#clustered_lock_interface">6.4. ClusteredLock Interface</a> <ul class="sectlevel3"> <li><a href="#clustered_lock_usage">6.4.1. Usage Examples</a></li> <li><a href="#clusteredlockmanager_configuration">6.4.2. ClusteredLockManager Configuration</a></li> </ul> </li> </ul> </li> <li><a href="#clustered_counters">7. Clustered Counters</a> <ul class="sectlevel2"> <li><a href="#installation_and_configuration">7.1. Installation and Configuration</a> <ul class="sectlevel3"> <li><a href="#list_counter_names">7.1.1. List counter names</a></li> </ul> </li> <li><a href="#the_countermanager_interface">7.2. The <code>CounterManager</code> interface.</a> <ul class="sectlevel3"> <li><a href="#remove_a_counter_via_countermanager">7.2.1. Remove a counter via CounterManager</a></li> </ul> </li> <li><a href="#the_counter">7.3. The Counter</a> <ul class="sectlevel3"> <li><a href="#the_strongcounter_interface_when_the_consistency_or_bounds_matters">7.3.1. The <code>StrongCounter</code> interface: when the consistency or bounds matters.</a> <ul class="sectlevel4"> <li><a href="#bounded_strongcounter">Bounded <code>StrongCounter</code></a></li> <li><a href="#uses_cases">Uses cases</a></li> <li><a href="#usage_examples">Usage Examples</a></li> </ul> </li> <li><a href="#the_weakcounter_interface_when_speed_is_needed">7.3.2. The <code>WeakCounter</code> interface: when speed is needed</a> <ul class="sectlevel4"> <li><a href="#weak_counter_interface">Weak Counter Interface</a></li> <li><a href="#uses_cases_2">Uses cases</a></li> <li><a href="#examples_2">Examples</a></li> </ul> </li> </ul> </li> <li><a href="#clustered_counters_notify_events">7.4. Notifications and Events</a></li> </ul> </li> <li><a href="#endpoint_interop">8. Protocol Interoperability</a> <ul class="sectlevel2"> <li><a href="#considerations_with_media_types_and_endpoint_interoperability">8.1. Considerations with Media Types and Endpoint Interoperability</a></li> <li><a href="#rest_hot_rod_and_memcached_interoperability_with_text_based_storage">8.2. REST, Hot Rod, and Memcached Interoperability with Text-Based Storage</a></li> <li><a href="#rest_hot_rod_and_memcached_interoperability_with_custom_java_objects">8.3. REST, Hot Rod, and Memcached Interoperability with Custom Java Objects</a></li> <li><a href="#java_and_non_java_client_interoperability_with_protobuf">8.4. Java and Non-Java Client Interoperability with Protobuf</a></li> <li><a href="#embedded_remote_interop">8.5. Custom Code Interoperability</a> <ul class="sectlevel3"> <li><a href="#converting_data_on_demand">8.5.1. Converting Data On Demand</a></li> <li><a href="#storing_data_as_pojos">8.5.2. Storing Data as POJOs</a></li> </ul> </li> <li><a href="#entities_deploy">8.6. Deploying Entity Classes</a></li> <li><a href="#trying_the_interoperability_demo">8.7. Trying the Interoperability Demo</a></li> </ul> </li> <li><a href="#marshalling">9. Marshalling</a> <ul class="sectlevel2"> <li><a href="#the_role_of_jboss_marshalling">9.1. The Role Of JBoss Marshalling</a></li> <li><a href="#support_for_non_serializable_objects">9.2. Support For Non-Serializable Objects</a> <ul class="sectlevel3"> <li><a href="#store_as_binary">9.2.1. Store As Binary</a> <ul class="sectlevel4"> <li><a href="#equality_considerations">Equality Considerations</a></li> <li><a href="#store_by_value_via_defensive_copying">Store-by-value via defensive copying</a></li> </ul> </li> </ul> </li> <li><a href="#advanced_configuration">9.3. Advanced Configuration</a> <ul class="sectlevel3"> <li><a href="#troubleshooting">9.3.1. Troubleshooting</a></li> </ul> </li> <li><a href="#user_defined_externalizers">9.4. User Defined Externalizers</a> <ul class="sectlevel3"> <li><a href="#benefits_of_externalizers">9.4.1. Benefits of Externalizers</a></li> <li><a href="#user_friendly_externalizers">9.4.2. User Friendly Externalizers</a></li> <li><a href="#advanced_externalizers">9.4.3. Advanced Externalizers</a> <ul class="sectlevel4"> <li><a href="#linking_externalizers_with_marshaller_classes">Linking Externalizers with Marshaller Classes</a></li> <li><a href="#externalizer_identifier">Externalizer Identifier</a></li> <li><a href="#registering_advanced_externalizers">Registering Advanced Externalizers</a></li> <li><a href="#preassigned_externalizer_id_ranges">Preassigned Externalizer Id Ranges</a></li> </ul> </li> </ul> </li> </ul> </li> <li><a href="#grid_file">10. Grid File System</a> <ul class="sectlevel2"> <li><a href="#webdav_demo">10.1. WebDAV demo</a></li> </ul> </li> <li><a href="#cdi_support">11. CDI Support</a> <ul class="sectlevel2"> <li><a href="#maven_dependencies">11.1. Maven Dependencies</a></li> <li><a href="#embedded_cache_integration">11.2. Embedded cache integration</a> <ul class="sectlevel3"> <li><a href="#inject_an_embedded_cache">11.2.1. Inject an embedded cache</a></li> <li><a href="#override_the_default_embedded_cache_manager_and_configuration">11.2.2. Override the default embedded cache manager and configuration</a></li> <li><a href="#configure_the_transport_for_clustered_use">11.2.3. Configure the transport for clustered use</a></li> </ul> </li> <li><a href="#remote_cache_integration">11.3. Remote cache integration</a> <ul class="sectlevel3"> <li><a href="#inject_a_remote_cache">11.3.1. Inject a remote cache</a></li> <li><a href="#override_the_default_remote_cache_manager">11.3.2. Override the default remote cache manager</a></li> </ul> </li> <li><a href="#use_a_custom_remoteembedded_cache_manager_for_one_or_more_cache">11.4. Use a custom remote/embedded cache manager for one or more cache</a></li> <li><a href="#use_jcache_caching_annotations">11.5. Use JCache caching annotations</a></li> <li><a href="#use_cache_events_and_cdi">11.6. Use Cache events and CDI</a></li> </ul> </li> <li><a href="#jcache_jsr_107">12. JCache (JSR-107) provider</a> <ul class="sectlevel2"> <li><a href="#dependencies">12.1. Dependencies</a></li> <li><a href="#create_a_local_cache">12.2. Create a local cache</a></li> <li><a href="#create_a_remote_cache">12.3. Create a remote cache</a></li> <li><a href="#store_and_retrieve_data">12.4. Store and retrieve data</a></li> <li><a href="#comparing_java_util_concurrent_concurrentmap_and_javax_cache_cache_apis">12.5. Comparing java.util.concurrent.ConcurrentMap and javax.cache.Cache APIs</a></li> <li><a href="#clustering_jcache_instances">12.6. Clustering JCache instances</a></li> </ul> </li> <li><a href="#multimap_cache">13. Multimap Cache</a> <ul class="sectlevel2"> <li><a href="#installation_and_configuration_2">13.1. Installation and configuration</a></li> <li><a href="#multimapcache_api">13.2. MultimapCache API</a> <ul class="sectlevel3"> <li><a href="#completablefuturevoid_putk_key_v_value">13.2.1. CompletableFuture&lt;Void&gt; put(K key, V value)</a></li> <li><a href="#completablefuturecollectionv_getk_key">13.2.2. CompletableFuture&lt;Collection&lt;V&gt;&gt; get(K key)</a></li> <li><a href="#completablefutureboolean_removek_key">13.2.3. CompletableFuture&lt;Boolean&gt; remove(K key)</a></li> <li><a href="#completablefutureboolean_removek_key_v_value">13.2.4. CompletableFuture&lt;Boolean&gt; remove(K key, V value)</a></li> <li><a href="#completablefuturevoid_removepredicate_super_v_p">13.2.5. CompletableFuture&lt;Void&gt; remove(Predicate&lt;? super V&gt; p)</a></li> <li><a href="#completablefutureboolean_containskeyk_key">13.2.6. CompletableFuture&lt;Boolean&gt; containsKey(K key)</a></li> <li><a href="#completablefutureboolean_containsvaluev_value">13.2.7. CompletableFuture&lt;Boolean&gt; containsValue(V value)</a></li> <li><a href="#completablefutureboolean_containsentryk_key_v_value">13.2.8. CompletableFuture&lt;Boolean&gt; containsEntry(K key, V value)</a></li> <li><a href="#completablefuturelong_size">13.2.9. CompletableFuture&lt;Long&gt; size()</a></li> <li><a href="#boolean_supportsduplicates">13.2.10. boolean supportsDuplicates()</a></li> </ul> </li> <li><a href="#creating_a_multimap_cache">13.3. Creating a Multimap Cache</a> <ul class="sectlevel3"> <li><a href="#embedded_mode">13.3.1. Embedded mode</a></li> </ul> </li> <li><a href="#limitations">13.4. Limitations</a> <ul class="sectlevel3"> <li><a href="#support_for_duplicates">13.4.1. Support for duplicates</a></li> <li><a href="#eviction">13.4.2. Eviction</a></li> <li><a href="#transactions">13.4.3. Transactions</a></li> </ul> </li> </ul> </li> <li><a href="#transactions">14. Transactions</a> <ul class="sectlevel2"> <li><a href="#tx_configuration">14.1. Configuring transactions</a></li> <li><a href="#tx_isolation_levels">14.2. Isolation levels</a></li> <li><a href="#tx_locking">14.3. Transaction locking</a> <ul class="sectlevel3"> <li><a href="#pessimistic_transactional_cache">14.3.1. Pessimistic transactional cache</a></li> <li><a href="#optimistic_transactional_cache">14.3.2. Optimistic transactional cache</a></li> <li><a href="#what_do_i_need_pessimistic_or_optimistic_transactions">14.3.3. What do I need - pessimistic or optimistic transactions?</a></li> </ul> </li> <li><a href="#tx_write_skew">14.4. Write Skews</a> <ul class="sectlevel3"> <li><a href="#forcing_write_locks_on_keys_in_pessimitic_transactions">14.4.1. Forcing write locks on keys in pessimitic transactions</a></li> </ul> </li> <li><a href="#dealing_with_exceptions">14.5. Dealing with exceptions</a></li> <li><a href="#tx_sync_enlist">14.6. Enlisting Synchronizations</a></li> <li><a href="#tx_batching">14.7. Batching</a> <ul class="sectlevel3"> <li><a href="#api">14.7.1. API</a></li> <li><a href="#batching_and_jta">14.7.2. Batching and JTA</a></li> </ul> </li> <li><a href="#tx_recovery">14.8. Transaction recovery</a> <ul class="sectlevel3"> <li><a href="#when_to_use_recovery">14.8.1. When to use recovery</a></li> <li><a href="#how_does_it_work">14.8.2. How does it work</a></li> <li><a href="#configuring_recovery">14.8.3. Configuring recovery   </a> <ul class="sectlevel4"> <li><a href="#enable_jmx_support">Enable JMX support</a></li> </ul> </li> <li><a href="#recovery_cache">14.8.4. Recovery cache</a></li> <li><a href="#integration_with_the_transaction_manager">14.8.5. Integration with the transaction manager</a></li> <li><a href="#tx_recovery_reconciliation">14.8.6. Reconciliation</a> <ul class="sectlevel4"> <li><a href="#force_commitrollback_based_on_xid">Force commit/rollback based on XID</a></li> </ul> </li> <li><a href="#want_to_know_more">14.8.7. Want to know more?</a></li> </ul> </li> <li><a href="#tx_total_order">14.9. Total Order based commit protocol</a> <ul class="sectlevel3"> <li><a href="#overview_2">14.9.1. Overview</a> <ul class="sectlevel4"> <li><a href="#commit_in_one_phase">Commit in one phase</a></li> <li><a href="#commit_in_two_phases">Commit in two phases</a></li> <li><a href="#transaction_recovery">Transaction Recovery</a></li> <li><a href="#state_transfer">State Transfer</a></li> </ul> </li> <li><a href="#configuration_2">14.9.2. Configuration</a></li> <li><a href="#when_to_use_it">14.9.3. When to use it?</a></li> </ul> </li> </ul> </li> </ul> </div> </div> <div id="content"> <div class="sect1"> <h2 id="cache_api"><a class="anchor" href="#cache_api"></a>1. The Cache API</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="the_cache_interface"><a class="anchor" href="#the_cache_interface"></a>1.1. The Cache interface</h3> <div class="paragraph"> <p>Infinispan&#8217;s Caches are manipulated through the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html">Cache</a> interface.</p> </div> <div class="paragraph"> <p>A Cache exposes simple methods for adding, retrieving and removing entries, including atomic mechanisms exposed by the JDK&#8217;s ConcurrentMap interface. Based on the cache mode used, invoking these methods will trigger a number of things to happen, potentially even including replicating an entry to a remote node or looking up an entry from a remote node, or potentially a cache store.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> For simple usage, using the Cache API should be no different from using the JDK Map API, and hence migrating from simple in-memory caches based on a Map to Infinispan&#8217;s Cache should be trivial. </td> </tr> </table> </div> <div class="sect3"> <h4 id="performance_concerns_of_certain_map_methods"><a class="anchor" href="#performance_concerns_of_certain_map_methods"></a>1.1.1. Performance Concerns of Certain Map Methods</h4> <div class="paragraph"> <p>Certain methods exposed in Map have certain performance consequences when used with Infinispan, such as <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html#size--">size()</a> , <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html#values--">values()</a> , <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html#keySet--">keySet()</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html#entrySet--">entrySet()</a> . Specific methods on the <code>keySet</code>, <code>values</code> and <code>entrySet</code> are fine for use please see their Javadoc for further details.</p> </div> <div class="paragraph"> <p>Attempting to perform these operations globally would have large performance impact as well as become a scalability bottleneck. As such, these methods should only be used for informational or debugging purposes only.</p> </div> <div class="paragraph"> <p>It should be noted that using certain flags with the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/AdvancedCache.html#withFlags-org.infinispan.context.Flag&#8230;&#8203;-">withFlags</a> method can mitigate some of these concerns, please check each method&#8217;s documentation for more details.</p> </div> </div> <div class="sect3"> <h4 id="mortal_and_immortal_data"><a class="anchor" href="#mortal_and_immortal_data"></a>1.1.2. Mortal and Immortal Data</h4> <div class="paragraph"> <p>Further to simply storing entries, Infinispan&#8217;s cache API allows you to attach mortality information to data. For example, simply using <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">put(key, value)</a> would create an <em>immortal</em> entry, i.e., an entry that lives in the cache forever, until it is removed (or evicted from memory to prevent running out of memory). If, however, you put data in the cache using <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/BasicCache.html#put-K-V-long-java.util.concurrent.TimeUnit-">put(key, value, lifespan, timeunit)</a> , this creates a <em>mortal</em> entry, i.e., an entry that has a fixed lifespan and expires after that lifespan.</p> </div> <div class="paragraph"> <p>In addition to <em>lifespan</em> , Infinispan also supports <em>maxIdle</em> as an additional metric with which to determine expiration. Any combination of lifespans or maxIdles can be used.</p> </div> </div> <div class="sect3"> <h4 id="putforexternalread_operation"><a class="anchor" href="#putforexternalread_operation"></a>1.1.3. putForExternalRead operation</h4> <div class="paragraph"> <p>Infinispan&#8217;s <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html">Cache</a> class contains a different 'put' operation called <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html#putForExternalRead-K-V-">putForExternalRead</a> . This operation is particularly useful when Infinispan is used as a temporary cache for data that is persisted elsewhere. Under heavy read scenarios, contention in the cache should not delay the real transactions at hand, since caching should just be an optimization and not something that gets in the way.</p> </div> <div class="paragraph"> <p>To achieve this, putForExternalRead acts as a put call that only operates if the key is not present in the cache, and fails fast and silently if another thread is trying to store the same key at the same time. In this particular scenario, caching data is a way to optimise the system and it&#8217;s not desirable that a failure in caching affects the on-going transaction, hence why failure is handled differently. putForExternalRead is considered to be a fast operation because regardless of whether it&#8217;s successful or not, it doesn&#8217;t wait for any locks, and so returns to the caller promptly.</p> </div> <div class="paragraph"> <p>To understand how to use this operation, let&#8217;s look at basic example. Imagine a cache of Person instances, each keyed by a PersonId , whose data originates in a separate data store. The following code shows the most common pattern of using <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html#putForExternalRead-K-V-">putForExternalRead</a> within the context of this example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Id of the person to look up, provided by the application</span>
PersonId id = ...;

<span class="comment">// Get a reference to the cache where person instances will be stored</span>
Cache&lt;PersonId, Person&gt; cache = ...;

<span class="comment">// First, check whether the cache contains the person instance</span>
<span class="comment">// associated with with the given id</span>
Person cachedPerson = cache.get(id);

<span class="keyword">if</span> (cachedPerson == <span class="predefined-constant">null</span>) {
   <span class="comment">// The person is not cached yet, so query the data store with the id</span>
   Person person = dataStore.lookup(id);

   <span class="comment">// Cache the person along with the id so that future requests can</span>
   <span class="comment">// retrieve it from memory rather than going to the data store</span>
   cache.putForExternalRead(id, person);
} <span class="keyword">else</span> {
   <span class="comment">// The person was found in the cache, so return it to the application</span>
   <span class="keyword">return</span> cachedPerson;
}</code></pre> </div> </div> <div class="paragraph"> <p>Please note that <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html#putForExternalRead-K-V-">putForExternalRead</a> should never be used as a mechanism to update the cache with a new Person instance originating from application execution (i.e. from a transaction that modifies a Person&#8217;s address). When updating cached values, please use the standard <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">put</a> operation, otherwise the possibility of caching corrupt data is likely.</p> </div> </div> </div> <div class="sect2"> <h3 id="the_advancedcache_interface"><a class="anchor" href="#the_advancedcache_interface"></a>1.2. The AdvancedCache interface</h3> <div class="paragraph"> <p>In addition to the simple Cache interface, Infinispan offers an <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> interface, geared towards extension authors. The AdvancedCache offers the ability to inject custom interceptors, access certain internal components and to apply flags to alter the default behavior of certain cache methods. The following code snippet depicts how an AdvancedCache can be obtained:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">AdvancedCache advancedCache = cache.getAdvancedCache();</code></pre> </div> </div> <div class="sect3"> <h4 id="flags"><a class="anchor" href="#flags"></a>1.2.1. Flags</h4> <div class="paragraph"> <p>Flags are applied to regular cache methods to alter the behavior of certain methods. For a list of all available flags, and their effects, see the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/context/Flag.html">Flag</a> enumeration. Flags are applied using <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/AdvancedCache.html#withFlags-org.infinispan.context.Flag&#8230;&#8203;-">AdvancedCache.withFlags()</a> . This builder method can be used to apply any number of flags to a cache invocation, for example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">advancedCache.withFlags(Flag.CACHE_MODE_LOCAL, Flag.SKIP_LOCKING)
<span class="error"> </span><span class="error"> </span> .withFlags(Flag.FORCE_SYNCHRONOUS)
<span class="error"> </span><span class="error"> </span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="custom_interceptors"><a class="anchor" href="#custom_interceptors"></a>1.2.2. Custom Interceptors</h4> <div class="paragraph"> <p>The AdvancedCache interface also offers advanced developers a mechanism with which to attach custom interceptors. Custom interceptors allow developers to alter the behavior of the cache API methods, and the AdvancedCache interface allows developers to attach these interceptors programmatically, at run-time. See the AdvancedCache Javadocs for more details.</p> </div> </div> </div> <div class="sect2"> <h3 id="listeners_and_notifications"><a class="anchor" href="#listeners_and_notifications"></a>1.3. Listeners and Notifications</h3> <div class="paragraph"> <p>Infinispan offers a listener API, where clients can register for and get notified when events take place. This annotation-driven API applies to 2 different levels: cache level events and cache manager level events.</p> </div> <div class="paragraph"> <p>Events trigger a notification which is dispatched to listeners. Listeners are simple <a href="http://en.wikipedia.org/wiki/Plain_Old_Java_Object">POJO</a> s annotated with <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/notifications/Listener.html">@Listener</a> and registered using the methods defined in the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/notifications/Listenable.html">Listenable</a> interface.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Both Cache and CacheManager implement Listenable, which means you can attach listeners to either a cache or a cache manager, to receive either cache-level or cache manager-level notifications. </td> </tr> </table> </div> <div class="paragraph"> <p>For example, the following class defines a listener to print out some information every time a new entry is added to the cache, in a non blocking fashion:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PrintWhenAdded</span> {
  <span class="predefined-type">Queue</span>&lt;CacheEntryCreatedEvent&gt; events = <span class="keyword">new</span> <span class="predefined-type">ConcurrentLinkedQueue</span>&lt;&gt;();

<span class="error"> </span> <span class="annotation">@CacheEntryCreated</span>
<span class="error"> </span> <span class="directive">public</span> CompletionStage&lt;<span class="predefined-type">Void</span>&gt; print(CacheEntryCreatedEvent event) {
    events.add(event);
    <span class="keyword">return</span> <span class="predefined-constant">null</span>;
<span class="error"> </span> }

}</code></pre> </div> </div> <div class="paragraph"> <p>For more comprehensive examples, please see the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/notifications/Listener.html">Javadocs for @Listener</a>.</p> </div> <div class="sect3"> <h4 id="cache_level_notifications"><a class="anchor" href="#cache_level_notifications"></a>1.3.1. Cache-level notifications</h4> <div class="paragraph"> <p>Cache-level events occur on a per-cache basis, and by default are only raised on nodes where the events occur. Note in a distributed cache these events are only raised on the owners of data being affected. Examples of cache-level events are entries being added, removed, modified, etc. These events trigger notifications to listeners registered to a specific cache.</p> </div> <div class="paragraph"> <p>Please see the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for a comprehensive list of all cache-level notifications, and their respective method-level annotations.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Please refer to the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for the list of cache-level notifications available in Infinispan. </td> </tr> </table> </div> <div class="sect4"> <h5 id="cluster_listeners"><a class="anchor" href="#cluster_listeners"></a>Cluster Listeners</h5> <div class="paragraph"> <p>The cluster listeners should be used when it is desirable to listen to the cache events on a single node.</p> </div> <div class="paragraph"> <p>To do so all that is required is set to annotate your listener as being clustered.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span> (clustered = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyClusterListener</span> { .... }</code></pre> </div> </div> <div class="paragraph"> <p>There are some limitations to cluster listeners from a non clustered listener.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>A cluster listener can only listen to <code>@CacheEntryModified</code>, <code>@CacheEntryCreated</code>, <code>@CacheEntryRemoved</code> and <code>@CacheEntryExpired</code> events. Note this means any other type of event will not be listened to for this listener.</p> </li> <li> <p>Only the post event is sent to a cluster listener, the pre event is ignored.</p> </li> </ol> </div> </div> <div class="sect4"> <h5 id="event_filtering_and_conversion"><a class="anchor" href="#event_filtering_and_conversion"></a>Event filtering and conversion</h5> <div class="paragraph"> <p>All applicable events on the node where the listener is installed will be raised to the listener. It is possible to dynamically filter what events are raised by using a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/filter/KeyFilter.html">KeyFilter</a> (only allows filtering on keys) or <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventFilter.html">CacheEventFilter</a> (used to filter for keys, old value, old metadata, new value, new metadata, whether command was retried, if the event is before the event (ie. isPre) and also the command type).</p> </div> <div class="paragraph"> <p>The example here shows a simple <code>KeyFilter</code> that will only allow events to be raised when an event modified the entry for the key <code>Only Me</code>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SpecificKeyFilter</span> <span class="directive">implements</span> KeyFilter&lt;<span class="predefined-type">String</span>&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> keyToAccept;

    <span class="directive">public</span> SpecificKeyFilter(<span class="predefined-type">String</span> keyToAccept) {
      <span class="keyword">if</span> (keyToAccept == <span class="predefined-constant">null</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>();
      }
      <span class="local-variable">this</span>.keyToAccept = keyToAccept;
    }

    <span class="type">boolean</span> accept(<span class="predefined-type">String</span> key) {
      <span class="keyword">return</span> keyToAccept.equals(key);
    }
}

...
cache.addListener(listener, <span class="keyword">new</span> SpecificKeyFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">Only Me</span><span class="delimiter">&quot;</span></span>));
...</code></pre> </div> </div> <div class="paragraph"> <p>This can be useful when you want to limit what events you receive in a more efficient manner.</p> </div> <div class="paragraph"> <p>There is also a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventConverter.html">CacheEventConverter</a> that can be supplied that allows for converting a value to another before raising the event. This can be nice to modularize any code that does value conversions.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The mentioned filters and converters are especially beneficial when used in conjunction with a Cluster Listener. This is because the filtering and conversion is done on the node where the event originated and not on the node where event is listened to. This can provide benefits of not having to replicate events across the cluster (filter) or even have reduced payloads (converter). </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="initial_state_events"><a class="anchor" href="#initial_state_events"></a>Initial State Events</h5> <div class="paragraph"> <p>When a listener is installed it will only be notified of events after it is fully installed.</p> </div> <div class="paragraph"> <p>It may be desirable to get the current state of the cache contents upon first registration of listener by having an event generated of type <code>@CacheEntryCreated</code> for each element in the cache. Any additionally generated events during this initial phase will be queued until appropriate events have been raised.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> This only works for clustered listeners at this time. <a href="https://issues.jboss.org/browse/ISPN-4608">ISPN-4608</a> covers adding this for non clustered listeners. </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="duplicate_events"><a class="anchor" href="#duplicate_events"></a>Duplicate Events</h5> <div class="paragraph"> <p>It is possible in a non transactional cache to receive duplicate events. This is possible when the primary owner of a key goes down while trying to perform a write operation such as a put.</p> </div> <div class="paragraph"> <p>Infinispan internally will rectify the put operation by sending it to the new primary owner for the given key automatically, however there are no guarantees in regards to if the write was first replicated to backups. Thus more than 1 of the following write events (<code>CacheEntryCreatedEvent</code>, <code>CacheEntryModifiedEvent</code> &amp; <code>CacheEntryRemovedEvent</code>) may be sent on a single operation.</p> </div> <div class="paragraph"> <p>If more than one event is generated Infinispan will mark the event that it was generated by a retried command to help the user to know when this occurs without having to pay attention to view changes.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyRetryListener</span> {
  <span class="annotation">@CacheEntryModified</span>
  <span class="directive">public</span> <span class="type">void</span> entryModified(CacheEntryModifiedEvent event) {
    <span class="keyword">if</span> (event.isCommandRetried()) {
      <span class="comment">// Do something</span>
    }
  }
}</code></pre> </div> </div> <div class="paragraph"> <p>Also when using a <code>CacheEventFilter</code> or <code>CacheEventConverter</code> the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/notifications/cachelistener/filter/EventType.html">EventType</a> contains a method <code>isRetry</code> to tell if the event was generated due to retry.</p> </div> </div> </div> <div class="sect3"> <h4 id="cache_manager_level_notifications"><a class="anchor" href="#cache_manager_level_notifications"></a>1.3.2. Cache manager-level notifications</h4> <div class="paragraph"> <p>Cache manager-level events occur on a cache manager. These too are global and cluster-wide, but involve events that affect all caches created by a single cache manager. Examples of cache manager-level events are nodes joining or leaving a cluster, or caches starting or stopping.</p> </div> <div class="paragraph"> <p>Please see the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/notifications/cachemanagerlistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachemanagerlistener.annotation package</a> for a comprehensive list of all cache manager-level notifications, and their respective method-level annotations.</p> </div> </div> <div class="sect3"> <h4 id="synchronicity_of_events"><a class="anchor" href="#synchronicity_of_events"></a>1.3.3. Synchronicity of events</h4> <div class="paragraph"> <p>By default, all async notifications are dispatched in the notification thread pool. Sync notifications will delay the operation from continuing until the listener method completes or the CompletionStage completes (the former causing the thread to block). Alternatively, you could annotate your listener as <em>asynchronous</em> in which case the operation will continue immediately, while the notification is completed asynchronously on the notification thread pool. To do this, simply annotate your listener such:</p> </div> <div class="paragraph"> <p>Asynchronous Listener</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span> (sync = <span class="predefined-constant">false</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyAsyncListener</span> {
   <span class="annotation">@CacheEntryCreated</span>
   <span class="type">void</span> listen(CacheEntryCreatedEvent event) { }
}</code></pre> </div> </div> <div class="paragraph"> <p>Blocking Synchronous Listener</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MySyncListener</span> {
   <span class="annotation">@CacheEntryCreated</span>
   <span class="type">void</span> listen(CacheEntryCreatedEvent event) { }
}</code></pre> </div> </div> <div class="paragraph"> <p>Non-Blocking Listener</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyNonBlockingListener</span> {
   <span class="annotation">@CacheEntryCreated</span>
   CompletionStage&lt;<span class="predefined-type">Void</span>&gt; listen(CacheEntryCreatedEvent event) { }
}</code></pre> </div> </div> <div class="sect4"> <h5 id="asynchronous_thread_pool"><a class="anchor" href="#asynchronous_thread_pool"></a>Asynchronous thread pool</h5> <div class="paragraph"> <p>To tune the thread pool used to dispatch such asynchronous notifications, use the <a href="http://docs.jboss.org/infinispan/10.0/configdocs/infinispan-config-10.0.html"><code>&lt;listener-executor /&gt;</code></a> XML element in your configuration file.</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="cache_asynchronous_api"><a class="anchor" href="#cache_asynchronous_api"></a>1.4. Asynchronous API</h3> <div class="paragraph"> <p>In addition to synchronous API methods like <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">Cache.put()</a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#remove-java.lang.Object-">Cache.remove()</a> , etc., Infinispan also has an asynchronous, non-blocking API where you can achieve the same results in a non-blocking fashion.</p> </div> <div class="paragraph"> <p>These methods are named in a similar fashion to their blocking counterparts, with "Async" appended.  E.g., <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/AsyncCache.html#putAsync-K-V-">Cache.putAsync()</a> , <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/AsyncCache.html#removeAsync-java.lang.Object-">Cache.removeAsync()</a> , etc.  These asynchronous counterparts return a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Future.html">Future</a> containing the actual result of the operation.</p> </div> <div class="paragraph"> <p>For example, in a cache parameterized as <code>Cache&lt;String, String&gt;</code>, <code>Cache.put(String key, String value)</code> returns a <code>String</code>. <code>Cache.putAsync(String key, String value)</code> would return a <code>Future&lt;String&gt;</code>.</p> </div> <div class="sect3"> <h4 id="why_use_such_an_api"><a class="anchor" href="#why_use_such_an_api"></a>1.4.1. Why use such an API?</h4> <div class="paragraph"> <p>Non-blocking APIs are powerful in that they provide all of the guarantees of synchronous communications - with the ability to handle communication failures and exceptions - with the ease of not having to block until a call completes.  This allows you to better harness parallelism in your system.  For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;<span class="predefined-type">Future</span>&lt;?&gt;&gt; futures = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;<span class="predefined-type">Future</span>&lt;?&gt;&gt;();
futures.add(cache.putAsync(key1, value1)); <span class="comment">// does not block</span>
futures.add(cache.putAsync(key2, value2)); <span class="comment">// does not block</span>
futures.add(cache.putAsync(key3, value3)); <span class="comment">// does not block</span>

<span class="comment">// the remote calls for the 3 puts will effectively be executed</span>
<span class="comment">// in parallel, particularly useful if running in distributed mode</span>
<span class="comment">// and the 3 keys would typically be pushed to 3 different nodes</span>
<span class="comment">// in the cluster</span>

<span class="comment">// check that the puts completed successfully</span>
<span class="keyword">for</span> (<span class="predefined-type">Future</span>&lt;?&gt; f: futures) f.get();</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="which_processes_actually_happen_asynchronously"><a class="anchor" href="#which_processes_actually_happen_asynchronously"></a>1.4.2. Which processes actually happen asynchronously?</h4> <div class="paragraph"> <p>There are 4 things in Infinispan that can be considered to be on the critical path of a typical write operation. These are, in order of cost:</p> </div> <div class="ulist"> <ul> <li> <p>network calls</p> </li> <li> <p>marshalling</p> </li> <li> <p>writing to a cache store (optional)</p> </li> <li> <p>locking</p> </li> </ul> </div> <div class="paragraph"> <p>As of Infinispan 4.0, using the async methods will take the network calls and marshalling off the critical path.  For various technical reasons, writing to a cache store and acquiring locks, however, still happens in the caller&#8217;s thread.  In future, we plan to take these offline as well.  See <a href="http://lists.jboss.org/pipermail/infinispan-dev/2010-January/002219.html">this developer mail list thread</a> about this topic.</p> </div> </div> <div class="sect3"> <h4 id="notifying_futures"><a class="anchor" href="#notifying_futures"></a>1.4.3. Notifying futures</h4> <div class="paragraph"> <p>Strictly, these methods do not return JDK Futures, but rather a sub-interface known as a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/util/concurrent/NotifyingFuture.html">NotifyingFuture</a> .  The main difference is that you can attach a listener to a NotifyingFuture such that you could be notified when the future completes.  Here is an example of making use of a notifying future:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">FutureListener futureListener = <span class="keyword">new</span> FutureListener() {

   <span class="directive">public</span> <span class="type">void</span> futureDone(<span class="predefined-type">Future</span> future) {
<span class="error"> </span><span class="error"> </span><span class="error"> </span>   <span class="keyword">try</span> {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span>future.get();
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span>} <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="comment">// Future did not complete successfully</span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Help!</span><span class="delimiter">&quot;</span></span>);
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span>}
<span class="error"> </span><span class="error"> </span><span class="error"> </span>}
};
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span>
cache.putAsync(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>).attachListener(futureListener);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="further_reading"><a class="anchor" href="#further_reading"></a>1.4.4. Further reading</h4> <div class="paragraph"> <p>The Javadocs on the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html">Cache</a> interface has some examples on using the asynchronous API, as does <a href="http://infinispan.blogspot.com/2009/05/whats-so-cool-about-asynchronous-api.html">this article</a> by Manik Surtani introducing the API.</p> </div> </div> </div> <div class="sect2"> <h3 id="invocation_flags"><a class="anchor" href="#invocation_flags"></a>1.5. Invocation Flags</h3> <div class="paragraph"> <p>An important aspect of getting the most of Infinispan is the use of per-invocation flags in order to provide specific behaviour to each particular cache call. By doing this, some important optimizations can be implemented potentially saving precious time and network resources. One of the most popular usages of flags can be found right in Cache API, underneath the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html#putForExternalRead-K-V-">putForExternalRead()</a> method which is used to load an Infinispan cache with data read from an external resource. In order to make this call efficient, Infinispan basically calls a normal put operation passing the following flags: <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/context/Flag.html#FAIL_SILENTLY">FAIL_SILENTLY</a> , <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/context/Flag.html#FORCE_ASYNCHRONOUS">FORCE_ASYNCHRONOUS</a> , <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/context/Flag.html#ZERO_LOCK_ACQUISITION_TIMEOUT">ZERO_LOCK_ACQUISITION_TIMEOUT</a></p> </div> <div class="paragraph"> <p>What Infinispan is doing here is effectively saying that when putting data read from external read, it will use an almost-zero lock acquisition time and that if the locks cannot be acquired, it will fail silently without throwing any exception related to lock acquisition. It also specifies that regardless of the cache mode, if the cache is clustered, it will replicate asynchronously and so won&#8217;t wait for responses from other nodes. The combination of all these flags make this kind of operation very efficient, and the efficiency comes from the fact this type of <em>putForExternalRead</em> calls are used with the knowledge that client can always head back to a persistent store of some sorts to retrieve the data that should be stored in memory. So, any attempt to store the data is just a best effort and if not possible, the client should try again if there&#8217;s a cache miss.</p> </div> <div class="sect3"> <h4 id="examples"><a class="anchor" href="#examples"></a>1.5.1. Examples</h4> <div class="paragraph"> <p>If you want to use these or any other flags available, which by the way are described in detail the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/context/Flag.html">Flag enumeration</a> , you simply need to get hold of the advanced cache and add the flags you need via the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/AdvancedCache.html#withFlags-org.infinispan.context.Flag&#8230;&#8203;-">withFlags()</a> method call. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache cache = ...
cache.getAdvancedCache()
<span class="error"> </span><span class="error"> </span> .withFlags(Flag.SKIP_CACHE_STORE, Flag.CACHE_MODE_LOCAL)
<span class="error"> </span><span class="error"> </span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>It&#8217;s worth noting that these flags are only active for the duration of the cache operation. If the same flags need to be used in several invocations, even if they&#8217;re in the same transaction, <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/AdvancedCache.html#withFlags-org.infinispan.context.Flag&#8230;&#8203;-">withFlags()</a> needs to be called repeatedly. Clearly, if the cache operation is to be replicated in another node, the flags are carried over to the remote nodes as well.</p> </div> <div class="sect4"> <h5 id="suppressing_return_values_from_a_put_or_remove"><a class="anchor" href="#suppressing_return_values_from_a_put_or_remove"></a>Suppressing return values from a put() or remove()</h5> <div class="paragraph"> <p>Another very important use case is when you want a write operation such as put() to <em>not</em> return the previous value. To do that, you need to use two flags to make sure that in a distributed environment, no remote lookup is done to potentially get previous value, and if the cache is configured with a cache loader, to avoid loading the previous value from the cache store. You can see these two flags in action in the following example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache cache = ...
cache.getAdvancedCache()
<span class="error"> </span><span class="error"> </span> .withFlags(Flag.SKIP_REMOTE_LOOKUP, Flag.SKIP_CACHE_LOAD)
<span class="error"> </span><span class="error"> </span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>)</code></pre> </div> </div> <div class="paragraph"> <p>For more information, please check the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/context/Flag.html">Flag enumeration</a> javadoc.</p> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="functional_map_api"><a class="anchor" href="#functional_map_api"></a>2. Functional Map API</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan 8 introduces a new experimental API for interacting with your data which takes advantage of the functional programming additions and improved asynchronous programming capabilities available in Java 8.</p> </div> <div class="paragraph"> <p>Infinispan&#8217;s <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.html">Functional Map API</a> is a distilled map-like asynchronous API which uses functions to interact with data.</p> </div> <div class="sect2"> <h3 id="asynchronous_and_lazy"><a class="anchor" href="#asynchronous_and_lazy"></a>2.1. Asynchronous and Lazy</h3> <div class="paragraph"> <p>Being an asynchronous API, all methods that return a single result, return a CompletableFuture which wraps the result, so you can use the resources of your system more efficiently by having the possibility to receive callbacks when the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a> has completed, or you can chain or compose them with other CompletableFuture.</p> </div> <div class="paragraph"> <p>For those operations that return multiple results, the API returns instances of a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Traversable.html"><code>​Traversable</code></a> interface which offers a lazy pull-style API for working with multiple results. <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Traversable.html"><code>​Traversable</code></a> ,​ being a lazy pull-style API, can still be asynchronous underneath since the user can decide to work on the traversable at a later stage, and the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Traversable.html"><code>​Traversable</code></a> implementation itself can decide when to compute those results.</p> </div> </div> <div class="sect2"> <h3 id="function_transparency"><a class="anchor" href="#function_transparency"></a>2.2. Function transparency</h3> <div class="paragraph"> <p>Since the content of the functions is transparent to Infinispan, the API has been split into 3 interfaces for read­-only ( <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadOnlyMap.html"><code>R​eadOnlyMap</code></a> )​, read­-write ( <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html"><code>R​eadWriteMap</code></a> )​ and write­-only ( <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html"><code>W​riteOnlyMap</code></a> )​ operations respectively, in order to provide hints to the Infinispan internals on the type of work needed to support functions.</p> </div> </div> <div class="sect2"> <h3 id="constructing_functional_maps"><a class="anchor" href="#constructing_functional_maps"></a>2.3. Constructing Functional Maps</h3> <div class="paragraph"> <p>To construct any of the read-only, write-only or read-write map instances, an Infinispan <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a> is required, which is retrieved from the Cache Manager, and using the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a> , static method factory methods are used to create <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadOnlyMap.html"><code>R​eadOnlyMap</code></a> , <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html"><code>R​eadWriteMap</code></a> or <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html"><code>W​riteOnlyMap</code></a></p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.impl</span>.*;

AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...

FunctionalMapImpl&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; functionalMap = FunctionalMapImpl.create(cache);
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ReadOnlyMapImpl.create(functionalMap);
WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = WriteOnlyMapImpl.create(functionalMap);
ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ReadWriteMapImpl.create(functionalMap);</code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> At this stage, the Functional Map API is experimental and hence the way FunctionalMap, ReadOnlyMap, WriteOnlyMap and ReadWriteMap are constructed is temporary. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="read_only_map_api"><a class="anchor" href="#read_only_map_api"></a>2.4. Read-Only Map API</h3> <div class="paragraph"> <p>Read-only operations have the advantage that no locks are acquired for the duration of the operation. Here&#8217;s an example on how to the equivalent operation for <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#get-java.lang.Object-">Map.get(K)</a>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...
CompletableFuture&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt; readFuture = readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, ReadEntryView::find);
readFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre> </div> </div> <div class="paragraph"> <p>Read-only map also exposes operations to retrieve multiple keys in one go:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Traversable</span>;

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

Set&lt;<span class="predefined-type">String</span>&gt; keys = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;(<span class="predefined-type">Arrays</span>.asList(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>));
Traversable&lt;<span class="predefined-type">String</span>&gt; values = readOnlyMap.evalMany(keys, ReadEntryView::get);
values.forEach(<span class="predefined-type">System</span>.out::println);</code></pre> </div> </div> <div class="paragraph"> <p>Finally, read-only map also exposes methods to read all existing keys as well as entries, which include both key and value information.</p> </div> <div class="sect3"> <h4 id="read_only_entry_view"><a class="anchor" href="#read_only_entry_view"></a>2.4.1. Read-Only Entry View</h4> <div class="paragraph"> <p>The function parameters for read-only maps provide the user with a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html">read-only entry view</a> to interact with the data in the cache, which include these operations:</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#key--"><code>key()</code></a> method returns the key for which this function is being executed.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#find--"><code>find()</code></a> returns a Java 8 <code>Optional</code> wrapping the value if present, otherwise it returns an empty optional. Unless the value is guaranteed to be associated with the key, it&#8217;s recommended to use <code>find()</code> to verify whether there&#8217;s a value associated with the key.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#get--"><code>get()</code></a> returns the value associated with the key. If the key has no value associated with it, calling <code>get()</code> throws a <code>NoSuchElementException</code>. <code>get()</code> can be considered as a shortcut of <code>ReadEntryView.find().get()</code> which should be used only when the caller has guarantees that there&#8217;s definitely a value associated with the key.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/MetaParam.Lookup.html#findMetaParam-java.lang.Class-"><code>findMetaParam(Class&lt;T&gt; type)</code></a> allows metadata parameter information associated with the cache entry to be looked up, for example: entry lifespan, last accessed time&#8230;&#8203;etc. See <a href="#meta_parameter">Metadata Parameter Handling</a> to find out more.</p> </li> </ul> </div> </div> </div> <div class="sect2"> <h3 id="write_only_map_api"><a class="anchor" href="#write_only_map_api"></a>2.5. Write-Only Map API</h3> <div class="paragraph"> <p>Write-only operations include operations that insert or update data in the cache and also removals. Crucially, a write-only operation does not attempt to read any previous value associated with the key. This is an important optimization since that means neither the cluster nor any persistence stores will be looked up to retrieve previous values. In the main Infinispan Cache, this kind of optimization was achieved using a local-only per-invocation flag, but the use case is so common that in this new functional API, this optimization is provided as a first-class citizen.</p> </div> <div class="paragraph"> <p>Using <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html">write-only map API</a> , an operation equivalent to <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>javax.cache.Cache</code> (<code>JCache</code>)</a> 's void returning <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java#L194"><code>put</code></a> can be achieved this way, followed by an attempt to read the stored value using the read-only map API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
   (v, view) -&gt; view.set(v));
CompletableFuture&lt;<span class="predefined-type">String</span>&gt; readFuture = writeFuture.thenCompose(r -&gt;
   readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, ReadEntryView::get));
readFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre> </div> </div> <div class="paragraph"> <p>Multiple key/value pairs can be stored in one go using <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#evalMany-java.util.Map-java.util.function.BiConsumer-"><code>evalMany</code></a> API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

Map&lt;K, <span class="predefined-type">String</span>&gt; data = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
data.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>);
data.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span>);
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writerAllFuture = writeOnlyMap.evalMany(data, (v, view) -&gt; view.set(v));
writerAllFuture.thenAccept(x -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Write completed</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>To remove all contents of the cache, there are two possibilities with different semantics. If using <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#evalAll-java.util.function.Consumer-"><code>evalAll</code></a> each cached entry is iterated over and the function is called with that entry&#8217;s information. Using this method also results in listeners being invoked.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; removeAllFuture = writeOnlyMap.evalAll(WriteEntryView::remove);
removeAllFuture.thenAccept(x -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">All entries removed</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>The alternative way to remove all entries is to call <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#truncate--"><code>truncate</code></a> operation which clears the entire cache contents in one go without invoking any listeners and is best-effort:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; truncateFuture = writeOnlyMap.truncate();
truncateFuture.thenAccept(x -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Cache contents cleared</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="sect3"> <h4 id="write_only_entry_view"><a class="anchor" href="#write_only_entry_view"></a>2.5.1. Write-Only Entry View</h4> <div class="paragraph"> <p>The function parameters for write-only maps provide the user with a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/EntryView.WriteEntryView.html">write-only entry view</a> to modify the data in the cache, which include these operations:</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/EntryView.WriteEntryView.html#set-V-org.infinispan.commons.api.functional.MetaParam.Writable&#8230;&#8203;-"><code>set(V, MetaParam.Writable&#8230;&#8203;)</code></a> method allows for a new value to be associated with the cache entry for which this function is executed, and it optionally takes zero or more metadata parameters to be stored along with the value. See <a href="#meta_parameter">Metadata Parameter Handling</a> for more information.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/EntryView.WriteEntryView.html#remove--"><code>remove()</code></a> method removes the cache entry, including both value and metadata parameters associated with this key.</p> </li> </ul> </div> </div> </div> <div class="sect2"> <h3 id="read_write_map_api"><a class="anchor" href="#read_write_map_api"></a>2.6. Read-Write Map API</h3> <div class="paragraph"> <p>The final type of operations we have are read­write operations, and within this category CAS-like (Compare­And­Swap) operations can be found. This type of operations require previous value associated with the key to be read and for locks to be acquired before executing the function. The vast majority of operations within <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a> and <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a> APIs fall within this category, and they can easily be implemented using the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html">read-write map API</a> . Moreover, with <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html">read-write map API</a> , you can make CAS­like comparisons not only based on value equality but based on metadata parameter equality such as version information, and you can send back previous value or boolean instances to signal whether the CAS­like comparison succeeded.</p> </div> <div class="paragraph"> <p>Implementing a write operation that returns the previous value associated with the cache entry is easy to achieve with the read-write map API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ...

CompletableFuture&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt; readWriteFuture = readWriteMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
   (v, view) -&gt; {
      Optional&lt;V&gt; prev = rw.find();
      view.set(v);
      <span class="keyword">return</span> prev;
   });
readWriteFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre> </div> </div> <div class="paragraph"> <p><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#replace-K-V-V-"><code>ConcurrentMap.replace(K, V, V)</code></a> is a replace function that compares the value present in the map and if it&#8217;s equals to the value passed in as first parameter, the second value is stored, returning a boolean indicating whether the replace was successfully completed. This operation can easily be implemented using the read-write map API:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ...

String oldValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">old-value</span><span class="delimiter">&quot;</span></span>;
CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; replaceFuture = readWriteMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>, (v, view) -&gt; {
   <span class="keyword">return</span> view.find().map(prev -&gt; {
      <span class="keyword">if</span> (prev.equals(oldValue)) {
         rw.set(v);
         <span class="keyword">return</span> <span class="predefined-constant">true</span>; <span class="comment">// previous value present and equals to the expected one</span>
      }
      <span class="keyword">return</span> <span class="predefined-constant">false</span>; <span class="comment">// previous value associated with key does not match</span>
   }).orElse(<span class="predefined-constant">false</span>); <span class="comment">// no value associated with this key</span>
});
replaceFuture.thenAccept(replaced -&gt; <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Value was replaced? %s%n</span><span class="delimiter">&quot;</span></span>, replaced));</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The function in the example above captures <code>oldValue</code> which is an external value to the function which is valid use case. </td> </tr> </table> </div> <div class="paragraph"> <p>Read-write map API contains <code>evalMany</code> and <code>evalAll</code> operations which behave similar to the write-only map offerings, except that they enable previous value and metadata parameters to be read.</p> </div> <div class="sect3"> <h4 id="read_write_entry_view"><a class="anchor" href="#read_write_entry_view"></a>2.6.1. Read-Write Entry View</h4> <div class="paragraph"> <p>The function parameters for read-write maps provide the user with the possibility to query the information associated with the key, including value and metadata parameters, and the user can also use this <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadWriteEntryView.html">read-write entry view</a> to modify the data in the cache.</p> </div> <div class="paragraph"> <p>The operations are exposed by read-write entry views are a union of the operations exposed by <a href="#read_only_entry_view">read-only entry views</a> and <a href="#write_only_entry_view">write-only entry views</a>.</p> </div> </div> </div> <div class="sect2"> <h3 id="meta_parameter"><a class="anchor" href="#meta_parameter"></a>2.7. Metadata Parameter Handling</h3> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/MetaParam.html">Metadata parameters</a> provide extra information about the cache entry, such as version information, lifespan, last accessed/used time&#8230;&#8203;etc. Some of these can be provided by the user, e.g. version, lifespan&#8230;&#8203;etc, but some others are computed internally and can only be queried, e.g. last accessed/used time.</p> </div> <div class="paragraph"> <p>The functional map API provides a flexible way to store metadata parameters along with an cache entry. To be able to store a metadata parameter, it must extend <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/MetaParam.Lookup.html"><code>MetaParam.Writable</code></a> interface, and implement the methods to allow the internal logic to extra the data. Storing is done via the <code>set(V, MetaParam.Writable&#8230;&#8203;)</code> method in the <a href="#write_only_entry_view">write-only entry view</a> or <a href="#read_write_entry_view">read-write entry view</a> function parameters.</p> </div> <div class="paragraph"> <p>Querying metadata parameters is available via the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/MetaParam.Lookup.html#findMetaParam-java.lang.Class-"><code>findMetaParam(Class)</code></a> method available via <a href="#read_write_entry_view">read-write entry view</a> or <a href="#read_only_entry_view">read-only entry views</a> or function parameters.</p> </div> <div class="paragraph"> <p>Here is an example showing how to store metadata parameters and how to query them:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.time.Duration</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.MetaParam</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
   (v, view) -&gt; view.set(v, <span class="keyword">new</span> MetaLifespan(<span class="predefined-type">Duration</span>.ofHours(<span class="integer">1</span>).toMillis())));
CompletableFuture&lt;MetaLifespan&gt; readFuture = writeFuture.thenCompose(r -&gt;
   readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, view -&gt; view.findMetaParam(MetaLifespan.class).get()));
readFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre> </div> </div> <div class="paragraph"> <p>If the metadata parameter is generic, for example <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/MetaParam.MetaEntryVersion.html"><code>MetaEntryVersion&lt;T&gt;</code></a> , retrieving the metadata parameter along with a specific type can be tricky if using <code>.class</code> static helper in a class because it does not return a <code>Class&lt;T&gt;</code> but only <code>Class</code>, and hence any generic information in the class is lost:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">String</span>&gt; readFuture = readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, view -&gt; {
   <span class="comment">// If caller depends on the typed information, this is not an ideal way to retrieve it</span>
   <span class="comment">// If the caller does not depend on the specific type, this works just fine.</span>
   Optional&lt;MetaEntryVersion&gt; version = view.findMetaParam(MetaEntryVersion.class);
   <span class="keyword">return</span> view.get();
});</code></pre> </div> </div> <div class="paragraph"> <p>When generic information is important the user can define a static helper method that coerces the static class retrieval to the type requested, and then use that helper method in the call to <code>findMetaParam</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">MetaEntryVersion</span>&lt;T&gt; <span class="directive">implements</span> MetaParam.Writable&lt;EntryVersion&lt;T&gt;&gt; {
   ...
   public <span class="directive">static</span> &lt;T&gt; T type() { <span class="keyword">return</span> (T) MetaEntryVersion.class; }
   ...
}

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">String</span>&gt; readFuture = readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, view -&gt; {
   <span class="comment">// The caller wants guarantees that the metadata parameter for version is numeric</span>
   <span class="comment">// e.g. to query the actual version information</span>
   Optional&lt;MetaEntryVersion&lt;<span class="predefined-type">Long</span>&gt;&gt; version = view.findMetaParam(MetaEntryVersion.type());
   <span class="keyword">return</span> view.get();
});</code></pre> </div> </div> <div class="paragraph"> <p>Finally, users are free to create new instances of metadata parameters to suit their needs. They are stored and retrieved in the very same way as done for the metadata parameters already provided by the functional map API.</p> </div> </div> <div class="sect2"> <h3 id="_invocation_parameter"><a class="anchor" href="#_invocation_parameter"></a>2.8. Invocation Parameter</h3> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Param.html">Per-invocation parameters</a> are applied to regular functional map API calls to alter the behaviour of certain aspects. Adding per invocation parameters is done using the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.html#withParams-org.infinispan.commons.api.functional.Param&#8230;&#8203;-"><code>withParams(Param&lt;?&gt;&#8230;&#8203;)</code></a> method.</p> </div> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Param.FutureMode.html"><code>Param.FutureMode</code></a> tweaks whether a method returning a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a> will span a thread to invoke the method, or instead will use the caller thread. By default, whenever a call is made to a method returning a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a> , a separate thread will be span to execute the method asynchronously. However, if the caller will immediately block waiting for the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a> to complete, spanning a different thread is wasteful, and hence <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Param.FutureMode.html#COMPLETED"><code>Param.FutureMode.COMPLETED</code></a> can be passed as per-invocation parameter to avoid creating that extra thread. Example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Param</span>.*;

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMapCompleted = readOnlyMap.withParams(FutureMode.COMPLETED);
Optional&lt;<span class="predefined-type">String</span>&gt; readFuture = readOnlyMapCompleted.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, ReadEntryView::find).get();</code></pre> </div> </div> <div class="paragraph"> <p>Param.PersistenceMode controls whether a write operation will be propagated to a persistence store. The default behaviour is for all write-operations to be propagated to the persistence store if the cache is configured with a persistence store. By passing PersistenceMode.SKIP as parameter, the write operation skips the persistence store and its effects are only seen in the in-memory contents of the cache. PersistenceMode.SKIP can be used to implement an <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/Cache.html#evict-K-"><code>Cache.evict()</code></a> method which removes data from memory but leaves the persistence store untouched:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Param</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; skiPersistMap = writeOnlyMap.withParams(PersistenceMode.SKIP);
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; removeFuture = skiPersistMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, WriteEntryView::remove);</code></pre> </div> </div> <div class="paragraph"> <p>Note that there&#8217;s no need for another PersistenceMode option to skip reading from the persistence store, because a write operation can skip reading previous value from the store by calling a write-only operation via the WriteOnlyMap.</p> </div> <div class="paragraph"> <p>Finally, new Param implementations are normally provided by the functional map API since they tweak how the internal logic works. So, for the most part of users, they should limit themselves to using the Param instances exposed by the API. The exception to this rule would be advanced users who decide to add new interceptors to the internal stack. These users have the ability to query these parameters within the interceptors.</p> </div> </div> <div class="sect2"> <h3 id="functional_listeners"><a class="anchor" href="#functional_listeners"></a>2.9. Functional Listeners</h3> <div class="paragraph"> <p>The functional map offers a listener API, where clients can register for and get notified when events take place. These notifications are post-event, so that means the events are received after the event has happened.</p> </div> <div class="paragraph"> <p>The listeners that can be registered are split into two categories: <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.html">write listeners</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.html">read-write listeners</a>.</p> </div> <div class="sect3"> <h4 id="write_listeners"><a class="anchor" href="#write_listeners"></a>2.9.1. Write Listeners</h4> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.html">Write listeners</a> enable user to register listeners for any cache entry write events that happen in either a read-write or write-only functional map.</p> </div> <div class="paragraph"> <p>Listeners for write events cannot distinguish between cache entry created and cache entry modify/update events because they don&#8217;t have access to the previous value. All they know is that a new non-null entry has been written.</p> </div> <div class="paragraph"> <p>However, write event listeners can distinguish between entry removals and cache entry create/modify-update events because they can query what the new entry&#8217;s value via <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/EntryView.ReadEntryView.html#find--"><code>ReadEntryView.find()</code></a> method.</p> </div> <div class="paragraph"> <p>Adding a write listener is done via the WriteListeners interface which is accessible via both <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html#listeners--"><code>ReadWriteMap.listeners()</code></a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.WriteOnlyMap.html#listeners--"><code>WriteOnlyMap.listeners()</code></a> method.</p> </div> <div class="paragraph"> <p>A write listener implementation can be defined either passing a function to <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.html#onWrite-java.util.function.Consumer-"><code>onWrite(Consumer&lt;ReadEntryView&lt;K, V&gt;&gt;)</code></a> method, or passing a WriteListener implementation to <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.html#add-org.infinispan.commons.api.functional.Listeners.WriteListeners.WriteListener-"><code>add(WriteListener&lt;K, V&gt;)</code></a> method. Either way, all these methods return an <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html">AutoCloseable</a> instance that can be used to de-register the function listener:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Listeners.WriteListeners.WriteListener</span>;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; woMap = ...

AutoCloseable writeFunctionCloseHandler = woMap.listeners().onWrite(written -&gt; {
   <span class="comment">// `written` is a ReadEntryView of the written entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
});
AutoCloseable writeCloseHanlder = woMap.listeners().add(<span class="keyword">new</span> WriteListener&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;() {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onWrite(ReadEntryView&lt;K, V&gt; written) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
   }
});

<span class="comment">// Either wrap handler in a try section to have it auto close...</span>
<span class="keyword">try</span>(writeFunctionCloseHandler) {
   <span class="comment">// Write entries using read-write or write-only functional map API</span>
   ...
}
<span class="comment">// Or close manually</span>
writeCloseHanlder.close();</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="read_write_listeners"><a class="anchor" href="#read_write_listeners"></a>2.9.2. Read-Write Listeners</h4> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.html">Read-write listeners</a> enable users to register listeners for cache entry created, modified and removed events, and also register listeners for any cache entry write events.</p> </div> <div class="paragraph"> <p>Entry created, modified and removed events can only be fired when these originate on a read-write functional map, since this is the only one that guarantees that the previous value has been read, and hence the differentiation between create, modified and removed can be fully guaranteed.</p> </div> <div class="paragraph"> <p>Adding a read-write listener is done via the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.html"><code>ReadWriteListeners</code></a> interface which is accessible via <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/FunctionalMap.ReadWriteMap.html#listeners--"><code>ReadWriteMap.listeners()</code></a> method.</p> </div> <div class="paragraph"> <p>If interested in only one of the event types, the simplest way to add a listener is to pass a function to either <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onCreate-org.infinispan.commons.api.functional.EntryView.ReadEntryView-"><code>onCreate</code></a> , <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onModify-org.infinispan.commons.api.functional.EntryView.ReadEntryView-org.infinispan.commons.api.functional.EntryView.ReadEntryView-"><code>onModify</code></a> or <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onRemove-org.infinispan.commons.api.functional.EntryView.ReadEntryView-"><code>onRemove</code></a> methods. All these methods return an AutoCloseable instance that can be used to de-register the function listener:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; rwMap = ...
AutoCloseable createClose = rwMap.listeners().onCreate(created -&gt; {
   <span class="comment">// `created` is a ReadEntryView of the created entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Created: %s%n</span><span class="delimiter">&quot;</span></span>, created.get());
});
AutoCloseable modifyClose = rwMap.listeners().onModify((before, after) -&gt; {
   <span class="comment">// `before` is a ReadEntryView of the entry before update</span>
   <span class="comment">// `after` is a ReadEntryView of the entry after update</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Before: %s%n</span><span class="delimiter">&quot;</span></span>, before.get());
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">After: %s%n</span><span class="delimiter">&quot;</span></span>, after.get());
});
AutoCloseable removeClose = rwMap.listeners().onRemove(removed -&gt; {
   <span class="comment">// `removed` is a ReadEntryView of the removed entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Removed: %s%n</span><span class="delimiter">&quot;</span></span>, removed.get());
});
AutoCloseable writeClose = woMap.listeners().onWrite(written -&gt; {
   <span class="comment">// `written` is a ReadEntryView of the written entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
});
...
<span class="comment">// Either wrap handler in a try section to have it auto close...</span>
try(createClose) {
   <span class="comment">// Create entries using read-write functional map API</span>
   ...
}
<span class="comment">// Or close manually</span>
modifyClose.close();</code></pre> </div> </div> <div class="paragraph"> <p>If listening for two or more event types, it&#8217;s better to pass in an implementation of <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Listeners.WriteListeners.WriteListener.html"><code>ReadWriteListener</code></a> interface via the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/api/functional/Listeners.ReadWriteListeners.html#add-org.infinispan.commons.api.functional.Listeners.ReadWriteListeners.ReadWriteListener-"><code>ReadWriteListeners.add()</code></a> method. <code>ReadWriteListener</code> offers the same <code>onCreate</code>/<code>onModify</code>/<code>onRemove</code> callbacks with default method implementations that are empty:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.Listeners.ReadWriteListeners.ReadWriteListener</span>;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; rwMap = ...
AutoCloseable readWriteClose = rwMap.listeners.add(<span class="keyword">new</span> ReadWriteListener&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;() {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onCreate(ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; created) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Created: %s%n</span><span class="delimiter">&quot;</span></span>, created.get());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onModify(ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; before, ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; after) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Before: %s%n</span><span class="delimiter">&quot;</span></span>, before.get());
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">After: %s%n</span><span class="delimiter">&quot;</span></span>, after.get());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onRemove(ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; removed) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Removed: %s%n</span><span class="delimiter">&quot;</span></span>, removed.get());
   }
);
AutoCloseable writeClose = rwMap.listeners.add(<span class="keyword">new</span> WriteListener&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;() {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onWrite(ReadEntryView&lt;K, V&gt; written) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
   }
);

<span class="comment">// Either wrap handler in a try section to have it auto close...</span>
<span class="keyword">try</span>(readWriteClose) {
   <span class="comment">// Create/update/remove entries using read-write functional map API</span>
   ...
}
<span class="comment">// Or close manually</span>
writeClose.close();</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="marshalling_of_functions"><a class="anchor" href="#marshalling_of_functions"></a>2.10. Marshalling of Functions</h3> <div class="paragraph"> <p>Running functional map in a cluster of nodes involves marshalling and replication of the operation parameters under certain circumstances.</p> </div> <div class="paragraph"> <p>To be more precise, when write operations are executed in a cluster, regardless of read-write or write-only operations, all the parameters to the method and the functions are replicated to other nodes.</p> </div> <div class="paragraph"> <p>There are multiple ways in which a function can be marshalled. The simplest way, which is also the most costly option in terms of payload size, is to mark the function as <a href="https://docs.oracle.com/javase/8/docs/api/java/io/Serializable.html"><code>Serializable</code></a>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

<span class="comment">// Force a function to be Serializable</span>
Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; function =
   (Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; &amp; <span class="predefined-type">Serializable</span>) wv -&gt; wv.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>);

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, function);</code></pre> </div> </div> <div class="paragraph"> <p>Infinispan provides overloads for all functional methods that make lambdas passed directly to the API serializable by default; the compiler automatically selects this overload if that&#8217;s possible. Therefore you can call</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, wv -&gt; wv.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>));</code></pre> </div> </div> <div class="paragraph"> <p>without doing the cast described above.</p> </div> <div class="paragraph"> <p>A more economical way to marshall a function is to provide an Infinispan <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/marshall/Externalizer.html"><code>Externalizer</code></a> for it:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.Externalizer</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.SerializeFunctionWith</span>;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

<span class="comment">// Force a function to be Serializable</span>
Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; function = <span class="keyword">new</span> SetStringConstant&lt;&gt;();
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, function);

<span class="annotation">@SerializeFunctionWith</span>(value = SetStringConstant.Externalizer0.class)
<span class="type">class</span> <span class="class">SetStringConstant</span> <span class="directive">implements</span> Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> accept(WriteEntryView&lt;<span class="predefined-type">String</span>&gt; view) {
      view.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>);
   }

   <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">Externalizer0</span> <span class="directive">implements</span> Externalizer&lt;<span class="predefined-type">Object</span>&gt; {
      <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> oo, <span class="predefined-type">Object</span> o) {
         <span class="comment">// No-op</span>
      }
      <span class="directive">public</span> <span class="predefined-type">Object</span> readObject(<span class="predefined-type">ObjectInput</span> input) {
         <span class="keyword">return</span> <span class="keyword">new</span> SetStringConstant&lt;&gt;();
      }
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>To help users take advantage of the tiny payloads generated by <code>Externalizer</code>-based functions, the functional API comes with a helper class called <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/marshall/MarshallableFunctions.html"><code>org.infinispan.commons.marshall.MarshallableFunctions</code></a> which provides marshallable functions for some of the most commonly user functions.</p> </div> <div class="paragraph"> <p>In fact, all the functions required to implement <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a> and <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a> using the functional map API have been defined in <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/marshall/MarshallableFunctions.html"><code>MarshallableFunctions</code></a>. For example, here is an implementation of JCache&#8217;s <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java#L283"><code>boolean putIfAbsent(K, V)</code></a> using functional map API which can be run in a cluster:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.api.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.MarshallableFunctions</span>;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ...

CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; future = readWriteMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1,
   MarshallableFunctions.setValueIfAbsentReturnBoolean());
future.thenAccept(stored -&gt; System.out.printf(</span><span class="delimiter">&quot;</span></span>Value was put? %s%n<span class="string"><span class="delimiter">&quot;</span><span class="content">, stored));</span></span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="use_cases_for_functional_api"><a class="anchor" href="#use_cases_for_functional_api"></a>2.11. Use Cases for Functional API</h3> <div class="paragraph"> <p>This new API is meant to complement existing Key/Value Infinispan API offerings, so you&#8217;ll still be able to use <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a> or <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a> standard APIs if that&#8217;s what suits your use case best.</p> </div> <div class="paragraph"> <p>The target audience for this new API is either:</p> </div> <div class="ulist"> <ul> <li> <p>Distributed or persistent caching/in­memory­data­grid users that want to benefit from CompletableFuture and/or Traversable for async/lazy data grid or caching data manipulation. The clear advantage here is that threads do not need to be idle waiting for remote operations to complete, but instead these can be notified when remote operations complete and then chain them with other subsequent operations.</p> </li> <li> <p>Users who want to go beyond the standard operations exposed by <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a> and <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>, for example, if you want to do a replace operation using metadata parameter equality instead of value equality, or if you want to retrieve metadata information from values and so on.</p> </li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="data_encoding"><a class="anchor" href="#data_encoding"></a>3. Encoding</h2> <div class="sectionbody"> <div class="paragraph"> <p>Encoding is the data conversion operation done by Infinispan caches before storing data, and when reading back from storage.</p> </div> <div class="sect2"> <h3 id="overview"><a class="anchor" href="#overview"></a>3.1. Overview</h3> <div class="paragraph"> <p>Encoding allows dealing with a certain data format during API calls (map, listeners, stream, etc) while the format effectively stored is different.</p> </div> <div class="paragraph"> <p>The data conversions are handled by instances of <em>org.infinispan.commons.dataconversion.Encoder</em> :</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Encoder</span> {

   <span class="comment">/**
    * Convert data in the read/write format to the storage format.
    *
    * @param content data to be converted, never null.
    * @return Object in the storage format.
    */</span>
   <span class="predefined-type">Object</span> toStorage(<span class="predefined-type">Object</span> content);

   <span class="comment">/**
    * Convert from storage format to the read/write format.
    *
    * @param content data as stored in the cache, never null.
    * @return data in the read/write format
    */</span>
   <span class="predefined-type">Object</span> fromStorage(<span class="predefined-type">Object</span> content);

   <span class="comment">/**
     * Returns the {@link MediaType} produced by this encoder or null if the storage format is not known.
     */</span>
   MediaType getStorageFormat();
}</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="default_encoders"><a class="anchor" href="#default_encoders"></a>3.2. Default encoders</h3> <div class="paragraph"> <p>Infinispan automatically picks the Encoder depending on the cache configuration. The table below shows which internal Encoder is used for several configurations:</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> <col style="width: 25%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Mode</th> <th class="tableblock halign-left valign-top">Configuration</th> <th class="tableblock halign-left valign-top">Encoder</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Embedded/Server</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Default</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">IdentityEncoder</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Passthrough encoder, no conversion done</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Embedded</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">StorageType.OFF_HEAP</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">GlobalMarshallerEncoder</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Use the Infinispan internal marshaller to convert to byte[]. May delegate to the configured marshaller in the cache manager.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Embedded</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">StorageType.BINARY</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">BinaryEncoder</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Use the Infinispan internal marshaller to convert to byte[], except for primitives and String.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Server</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">StorageType.OFF_HEAP</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">IdentityEncoder</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Store byte[]s directly as received by remote clients</p></td> </tr> </tbody> </table> </div> <div class="sect2"> <h3 id="overriding_programmatically"><a class="anchor" href="#overriding_programmatically"></a>3.3. Overriding programmatically</h3> <div class="paragraph"> <p>Is is possible to override programmatically the encoding used for both keys and values, by calling the <em>.withEncoding()</em> method variants from <em>AdvancedCache</em>.</p> </div> <div class="paragraph"> <p>Example, consider the following cache configured as OFF_HEAP:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Read and write POJO, storage will be byte[] since for</span>
<span class="comment">// OFF_HEAP the GlobalMarshallerEncoder is used internally:</span>
cache.put(<span class="integer">1</span>, <span class="keyword">new</span> Pojo())
Pojo value = cache.get(<span class="integer">1</span>)

<span class="comment">// Get the content in its stored format by overriding</span>
<span class="comment">// the internal encoder with a no-op encoder (IdentityEncoder)</span>
Cache&lt;?,?&gt; rawContent = cache.getAdvancedCache().withValueEncoding(IdentityEncoder.class)
<span class="type">byte</span><span class="type">[]</span> marshalled = rawContent.get(<span class="integer">1</span>)</code></pre> </div> </div> <div class="paragraph"> <p>The override can be useful if any operation in the cache does not require decoding, such as counting number of entries, or calculating the size of byte[] of an OFF_HEAP cache.</p> </div> </div> <div class="sect2"> <h3 id="defining_custom_encoders"><a class="anchor" href="#defining_custom_encoders"></a>3.4. Defining custom Encoders</h3> <div class="paragraph"> <p>A custom encoder can be registered in the <em>EncoderRegistry</em>.</p> </div> <div class="admonitionblock caution"> <table> <tr> <td class="icon"> <i class="fa icon-caution" title="Caution"></i> </td> <td class="content"> Ensure that the registration is done in every node of the cluster, before starting the caches. </td> </tr> </table> </div> <div class="paragraph"> <p>Consider a custom encoder used to compress/decompress with gzip:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">GzipEncoder</span> <span class="directive">implements</span> <span class="predefined-type">Encoder</span> {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Object</span> toStorage(<span class="predefined-type">Object</span> content) {
      <span class="keyword">assert</span> content <span class="keyword">instanceof</span> <span class="predefined-type">String</span>;
      <span class="keyword">return</span> compress(content.toString());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Object</span> fromStorage(<span class="predefined-type">Object</span> content) {
      <span class="keyword">assert</span> content <span class="keyword">instanceof</span> <span class="type">byte</span><span class="type">[]</span>;
      <span class="keyword">return</span> decompress((<span class="type">byte</span><span class="type">[]</span>) content);
   }

   <span class="directive">private</span> <span class="type">byte</span><span class="type">[]</span> compress(<span class="predefined-type">String</span> str) {
      <span class="keyword">try</span> (<span class="predefined-type">ByteArrayOutputStream</span> baos = <span class="keyword">new</span> <span class="predefined-type">ByteArrayOutputStream</span>();
           <span class="predefined-type">GZIPOutputStream</span> gis = <span class="keyword">new</span> <span class="predefined-type">GZIPOutputStream</span>(baos)) {
         gis.write(str.getBytes(<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>));
         gis.close();
         <span class="keyword">return</span> baos.toByteArray();
      } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unabled to compress</span><span class="delimiter">&quot;</span></span>, e);
      }
   }

   <span class="directive">private</span> <span class="predefined-type">String</span> decompress(<span class="type">byte</span><span class="type">[]</span> compressed) {
      <span class="keyword">try</span> (<span class="predefined-type">GZIPInputStream</span> gis = <span class="keyword">new</span> <span class="predefined-type">GZIPInputStream</span>(<span class="keyword">new</span> <span class="predefined-type">ByteArrayInputStream</span>(compressed));
           <span class="predefined-type">BufferedReader</span> bf = <span class="keyword">new</span> <span class="predefined-type">BufferedReader</span>(<span class="keyword">new</span> <span class="predefined-type">InputStreamReader</span>(gis, <span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>))) {
         <span class="predefined-type">StringBuilder</span> result = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>();
         <span class="predefined-type">String</span> line;
         <span class="keyword">while</span> ((line = bf.readLine()) != <span class="predefined-constant">null</span>) {
            result.append(line);
         }
         <span class="keyword">return</span> result.toString();
      } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unable to decompress</span><span class="delimiter">&quot;</span></span>, e);
      }
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> MediaType getStorageFormat() {
      <span class="keyword">return</span> MediaType.parse(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/gzip</span><span class="delimiter">&quot;</span></span>);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> isStorageFormatFilterable() {
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">short</span> id() {
      <span class="keyword">return</span> <span class="integer">10000</span>;
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>It can be registered by:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalComponentRegistry registry = cacheManager.getGlobalComponentRegistry();
EncoderRegistry encoderRegistry = registry.getComponent(EncoderRegistry.class);
encoderRegistry.registerEncoder(<span class="keyword">new</span> GzipEncoder());</code></pre> </div> </div> <div class="paragraph"> <p>And then be used to write and read data from a cache:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...

<span class="comment">// Decorate cache with the newly registered encoder, without encoding keys (IdentityEncoder)</span>
<span class="comment">// but compressing values</span>
AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; compressingCache = (AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;) cache.withEncoding(IdentityEncoder.class, GzipEncoder.class);

<span class="comment">// All values will be stored compressed...</span>
compressingCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">297931749</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">0412c789a37f5086f743255cfa693dd5</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// ... but API calls deals with String</span>
<span class="predefined-type">String</span> value = compressingCache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">297931749</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Bypassing the value encoder to obtain the value as it is stored</span>
<span class="predefined-type">Object</span> value = compressingCache.withEncoding(IdentityEncoder.class).get(<span class="string"><span class="delimiter">&quot;</span><span class="content">297931749</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// value is a byte[] which is the compressed value</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="encoding_media_type"><a class="anchor" href="#encoding_media_type"></a>3.5. MediaType</h3> <div class="paragraph"> <p>A Cache can optionally be configured with a <code>org.infinispan.commons.dataconversion.MediaType</code> for keys and values. By describing the data format of the cache, Infinispan is able to convert data on the fly during cache operations.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The MediaType configuration is more suitable when storing binary data. When using server mode, it&#8217;s common to have a MediaType configured and clients such as REST or Hot Rod reading and writing in different formats. </td> </tr> </table> </div> <div class="paragraph"> <p>The data conversion between MediaType formats are handled by instances of <code>org.infinispan.commons.dataconversion.Transcoder</code></p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Transcoder</span> {

   <span class="comment">/**
    * Transcodes content between two different {@link MediaType}.
    *
    * @param content         Content to transcode.
    * @param contentType     The {@link MediaType} of the content.
    * @param destinationType The target {@link MediaType} to convert.
    * @return the transcoded content.
    */</span>
   <span class="predefined-type">Object</span> transcode(<span class="predefined-type">Object</span> content, MediaType contentType, MediaType destinationType);

   <span class="comment">/**
    * @return all the {@link MediaType} handled by this Transcoder.
    */</span>
   <span class="predefined-type">Set</span>&lt;MediaType&gt; getSupportedMediaTypes();
}</code></pre> </div> </div> <div class="sect3"> <h4 id="configuration"><a class="anchor" href="#configuration"></a>3.5.1. Configuration</h4> <div class="paragraph"> <p>Declarative:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object; type=java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xml; charset=UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Programmatic:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();

cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>);
cfg.encoding().value().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="mediatype_override"><a class="anchor" href="#mediatype_override"></a>3.5.2. Overriding the MediaType Programmatically</h4> <div class="paragraph"> <p>It&#8217;s possible to decorate the Cache with a different MediaType, allowing cache operations to be executed sending and receiving different data formats.</p> </div> <div class="paragraph"> <p>Example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">DefaultCacheManager cacheManager = <span class="keyword">new</span> DefaultCacheManager();

<span class="comment">// The cache will store POJO for keys and values</span>
ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();
cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span>);
cfg.encoding().value().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span>);

cacheManager.defineConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span>, cfg.build());

Cache&lt;<span class="predefined-type">Integer</span>, Person&gt; cache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span>);

cache.put(<span class="integer">1</span>, <span class="keyword">new</span> Person(<span class="string"><span class="delimiter">&quot;</span><span class="content">John</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>));

<span class="comment">// Wraps cache using 'application/x-java-object' for keys but JSON for values</span>
Cache&lt;<span class="predefined-type">Integer</span>, <span class="type">byte</span><span class="type">[]</span>&gt; jsonValuesCache = (Cache&lt;<span class="predefined-type">Integer</span>, <span class="type">byte</span><span class="type">[]</span>&gt;) cache.getAdvancedCache().withMediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);

<span class="type">byte</span><span class="type">[]</span> json = jsonValuesCache.get(<span class="integer">1</span>);</code></pre> </div> </div> <div class="paragraph"> <p>Will return the value in JSON format:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">_type</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.sample.Person</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">John</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>
}</code></pre> </div> </div> <div class="admonitionblock caution"> <table> <tr> <td class="icon"> <i class="fa icon-caution" title="Caution"></i> </td> <td class="content"> Most Transcoders are installed when server mode is used; when using library mode, an extra dependency, <em>org.infinispan:infinispan-server-core</em> should be added to the project. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="transcoders_and_encoders"><a class="anchor" href="#transcoders_and_encoders"></a>3.5.3. Transcoders and Encoders</h4> <div class="paragraph"> <p>Usually there will be none or only one data conversion involved in a cache operation:</p> </div> <div class="ulist"> <ul> <li> <p>No conversion by default on caches using in embedded or server mode;</p> </li> <li> <p><em>Encoder</em> based conversion for embedded caches without MediaType configured, but using OFF_HEAP or BINARY;</p> </li> <li> <p><em>Transcoder</em> based conversion for caches used in server mode with multiple REST and Hot Rod clients sending and receiving data in different formats. Those caches will have MediaType configured describing the storage.</p> </li> </ul> </div> <div class="paragraph"> <p>But it&#8217;s possible to have both encoders and transcoders being used simultaneously for advanced use cases.</p> </div> <div class="paragraph"> <p>Consider an example, a cache that stores marshalled objects (with jboss marshaller) content but for security reasons a transparent encryption layer should be added in order to avoid storing "plain" data to an external store. Clients should be able to read and write data in multiple formats.</p> </div> <div class="paragraph"> <p>This can be achieved by configuring the cache with the the MediaType that describes the storage regardless of the encoding layer:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();
cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-jboss-marshalling</span><span class="delimiter">&quot;</span></span>);
cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-jboss-marshalling</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>The transparent encryption can be added by decorating the cache with a special <em>Encoder</em> that encrypts/decrypts with storing/retrieving, for example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Scrambler</span> <span class="directive">implements</span> <span class="predefined-type">Encoder</span> {

   <span class="predefined-type">Object</span> toStorage(<span class="predefined-type">Object</span> content) {
      <span class="comment">// Encrypt data</span>
   }

   <span class="predefined-type">Object</span> fromStorage(<span class="predefined-type">Object</span> content) {
      <span class="comment">// Decrypt data</span>
   }

   MediaType getStorageFormat() {
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">application/scrambled</span><span class="delimiter">&quot;</span></span>;
   }

}</code></pre> </div> </div> <div class="paragraph"> <p>To make sure all data written to the cache will be stored encrypted, it&#8217;s necessary to decorate the cache with the Encoder above and perform all cache operations in this decorated cache:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache&lt;?,?&gt; secureStorageCache = cache.getAdvancedCache().withEncoding(Scrambler.class).put(k,v);</code></pre> </div> </div> <div class="paragraph"> <p>The capability of reading data in multiple formats can be added by decorating the cache with the desired MediaType:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Obtain a stream of values in XML format from the secure cache</span>
secureStorageCache.getAdvancedCache().withMediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xml</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xml</span><span class="delimiter">&quot;</span></span>).values().stream();</code></pre> </div> </div> <div class="paragraph"> <p>Internally, Infinispan will first apply the encoder <em>fromStorage</em> operation to obtain the entries, that will be in "application/x-jboss-marshalling" format and then apply a successive conversion to "application/xml" by using the adequate Transcoder.</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="cache_manager"><a class="anchor" href="#cache_manager"></a>4. The Embedded CacheManager</h2> <div class="sectionbody"> <div class="paragraph"> <p>The CacheManager is Infinispan&#8217;s main entry point. You use a CacheManager to</p> </div> <div class="ulist"> <ul> <li> <p>configure and obtain caches</p> </li> <li> <p>manage and monitor your nodes</p> </li> <li> <p>execute code across a cluster</p> </li> <li> <p>more&#8230;&#8203;</p> </li> </ul> </div> <div class="paragraph"> <p>Depending on whether you are embedding Infinispan in your application or you are using it remotely, you will be dealing with either an <code>EmbeddedCacheManager</code> or a <code>RemoteCacheManager</code>. While they share some methods and properties, be aware that there are semantic differences between them. The following chapters focus mostly on the <em>embedded</em> implementation.</p> </div> <div class="paragraph"> <p>CacheManagers are heavyweight objects, and we foresee no more than one CacheManager being used per JVM (unless specific setups require more than one; but either way, this would be a minimal and finite number of instances).</p> </div> <div class="paragraph"> <p>The simplest way to create a CacheManager is:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager();</code></pre> </div> </div> <div class="paragraph"> <p>which starts the most basic, local mode, non-clustered cache manager with no caches. CacheManagers have a lifecycle and the default constructors also call <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#start--">start()</a>. Overloaded versions of the constructors are available, that do not start the CacheManager, although keep in mind that CacheManagers need to be started before they can be used to create Cache instances.</p> </div> <div class="paragraph"> <p>Once constructed, CacheManagers should be made available to any component that require to interact with it via some form of application-wide scope such as JNDI, a ServletContext or via some other mechanism such as an IoC container.</p> </div> <div class="paragraph"> <p>When you are done with a CacheManager, you must stop it so that it can release its resources: <code>manager.stop();</code></p> </div> <div class="paragraph"> <p>This will ensure all caches within its scope are properly stopped, thread pools are shutdown. If the CacheManager was clustered it will also leave the cluster gracefully.</p> </div> <div class="sect2"> <h3 id="obtaining_caches"><a class="anchor" href="#obtaining_caches"></a>4.1. Obtaining caches</h3> <div class="paragraph"> <p>After you configure the <code>CacheManager</code>, you can obtain and control caches.</p> </div> <div class="paragraph"> <p>Invoke the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getCache--"><code>getCache()</code></a> method to obtain caches, as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; myCache = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>The preceding operation creates a cache named <code>myCache</code>, if it does not already exist, and returns it.</p> </div> <div class="paragraph"> <p>Using the <code>getCache()</code> method creates the cache only on the node where you invoke the method. In other words, it performs a local operation that must be invoked on each node across the cluster. Typically, applications deployed across multiple nodes obtain caches during initialization to ensure that caches are <em>symmetric</em> and exist on each node.</p> </div> <div class="paragraph"> <p>Invoke the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/EmbeddedCacheManagerAdmin.html#createCache--"><code>createCache()</code></a> method to create caches dynamically across the entire cluster, as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; myCache = manager.administration().createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">myTemplate</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>The preceding operation also automatically creates caches on any nodes that subsequently join the cluster.</p> </div> <div class="paragraph"> <p>Caches that you create with the <code>createCache()</code> method are ephemeral by default. If the entire cluster shuts down, the cache is not automatically created again when it restarts.</p> </div> <div class="paragraph"> <p>Use the PERMANENT flag to ensure that caches can survive restarts, as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; myCache = manager.administration().withFlags(AdminFlag.PERMANENT).createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">myTemplate</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>For the PERMANENT flag to take effect, you must enable global state and set a configuration storage provider.</p> </div> <div class="paragraph"> <p>For more information about configuration storage providers, see <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/configuration/global/GlobalStateConfigurationBuilder.html#configurationStorage-org.infinispan.globalstate.ConfigurationStorage-">GlobalStateConfigurationBuilder#configurationStorage()</a>.</p> </div> </div> <div class="sect2"> <h3 id="clustering_information"><a class="anchor" href="#clustering_information"></a>4.2. Clustering Information</h3> <div class="paragraph"> <p>The <code>EmbeddedCacheManager</code> has quite a few methods to provide information as to how the cluster is operating. The following methods only really make sense when being used in a clustered environment (that is when a Transport is configured).</p> </div> </div> <div class="sect2"> <h3 id="member_information"><a class="anchor" href="#member_information"></a>4.3. Member Information</h3> <div class="paragraph"> <p>When you are using a cluster it is very important to be able to find information about membership in the cluster including who is the owner of the cluster.</p> </div> <div class="paragraph"> <div class="title"><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getMembers--">getMembers()</a></div> <p>The getMembers() method returns all of the nodes in the current cluster.</p> </div> <div class="paragraph"> <div class="title"><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getCoordinator--">getCoordinator()</a></div> <p>The getCoordinator() method will tell you which one of the members is the coordinator of the cluster. For most intents you shouldn&#8217;t need to care who the coordinator is. You can use <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#isCoordinator--">isCoordinator()</a> method directly to see if the local node is the coordinator as well.</p> </div> </div> <div class="sect2"> <h3 id="other_methods"><a class="anchor" href="#other_methods"></a>4.4. Other methods</h3> <div class="paragraph"> <div class="title"><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getTransport--">getTransport()</a></div> <p>This method provides you access to the underlying Transport that is used to send messages to other nodes. In most cases a user wouldn&#8217;t ever need to go to this level, but if you want to get Transport specific information (in this case JGroups) you can use this mechanism.</p> </div> <div class="paragraph"> <div class="title"><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getStats--">getStats()</a></div> <p>The stats provided here are coalesced from all of the active caches in this manager. These stats can be useful to see if there is something wrong going on with your cluster overall.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="locking_concurrency"><a class="anchor" href="#locking_concurrency"></a>5. Locking and Concurrency</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan makes use of multi-versioned concurrency control (<a href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a>) - a concurrency scheme popular with relational databases and other data stores. MVCC offers many advantages over coarse-grained Java synchronization and even JDK Locks for access to shared data, including:</p> </div> <div class="ulist"> <ul> <li> <p>allowing concurrent readers and writers</p> </li> <li> <p>readers and writers do not block one another</p> </li> <li> <p>write skews can be detected and handled</p> </li> <li> <p>internal locks can be striped</p> </li> </ul> </div> <div class="sect2"> <h3 id="locking_implementation_details"><a class="anchor" href="#locking_implementation_details"></a>5.1. Locking implementation details</h3> <div class="paragraph"> <p>Infinispan&#8217;s MVCC implementation makes use of minimal locks and synchronizations, leaning heavily towards lock-free techniques such as <a href="http://en.wikipedia.org/wiki/Compare-and-swap">compare-and-swap</a> and lock-free data structures wherever possible, which helps optimize for multi-CPU and multi-core environments.</p> </div> <div class="paragraph"> <p>In particular, Infinispan&#8217;s MVCC implementation is heavily optimized for readers. Reader threads do not acquire explicit locks for entries, and instead directly read the entry in question.</p> </div> <div class="paragraph"> <p>Writers, on the other hand, need to acquire a write lock. This ensures only one concurrent writer per entry, causing concurrent writers to queue up to change an entry.</p> </div> <div class="paragraph"> <p>To allow concurrent reads, writers make a copy of the entry they intend to modify, by wrapping the entry in an <code>MVCCEntry</code>. This copy isolates concurrent readers from seeing partially modified state. Once a write has completed, <code>MVCCEntry.commit()</code> will flush changes to the data container and subsequent readers will see the changes written.</p> </div> <div class="sect3"> <h4 id="how_does_it_work_in_clustered_caches"><a class="anchor" href="#how_does_it_work_in_clustered_caches"></a>5.1.1. How does it work in clustered caches?</h4> <div class="paragraph"> <p>In clustered caches, each key has a node responsible to lock the key. This node is called primary owner.</p> </div> <div class="sect4"> <h5 id="non_transactional_caches"><a class="anchor" href="#non_transactional_caches"></a>Non Transactional caches</h5> <div class="olist arabic"> <ol class="arabic"> <li> <p>The write operation is sent to the primary owner of the key.</p> </li> <li> <p>The primary owner tries to lock the key.</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>If it succeeds, it forwards the operation to the other owners;</p> </li> <li> <p>Otherwise, an exception is thrown.</p> </li> </ol> </div> </li> </ol> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> If the operation is conditional and it fails on the primary owner, it is not forwarded to the other owners. </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> If the operation is executed locally in the primary owner, the first step is skipped. </td> </tr> </table> </div> </div> </div> <div class="sect3"> <h4 id="transactional_caches"><a class="anchor" href="#transactional_caches"></a>5.1.2. Transactional caches</h4> <div class="paragraph"> <p>The transactional cache supports optimistic and pessimistic locking mode. Refer to Transaction Locking for more information.</p> </div> </div> <div class="sect3"> <h4 id="isolation_levels"><a class="anchor" href="#isolation_levels"></a>5.1.3. Isolation levels</h4> <div class="paragraph"> <p>Isolation level affects what transactions can read when running concurrently with other transaction. Refer to Isolation Levels for more information.</p> </div> </div> <div class="sect3"> <h4 id="the_lockmanager"><a class="anchor" href="#the_lockmanager"></a>5.1.4. The LockManager</h4> <div class="paragraph"> <p>The <code>LockManager</code> is a component that is responsible for locking an entry for writing. The <code>LockManager</code> makes use of a <code>LockContainer</code> to locate/hold/create locks. <code>LockContainers</code> come in two broad flavours, with support for lock striping and with support for one lock per entry.</p> </div> </div> <div class="sect3"> <h4 id="lock_striping"><a class="anchor" href="#lock_striping"></a>5.1.5. Lock striping</h4> <div class="paragraph"> <p>Lock striping entails the use of a fixed-size, shared collection of locks for the entire cache, with locks being allocated to entries based on the entry&#8217;s key&#8217;s hash code. Similar to the way the JDK&#8217;s <code>ConcurrentHashMap</code> allocates locks, this allows for a highly scalable, fixed-overhead locking mechanism in exchange for potentially unrelated entries being blocked by the same lock.</p> </div> <div class="paragraph"> <p>The alternative is to disable lock striping - which would mean a <em>new</em> lock is created per entry. This approach <em>may</em> give you greater concurrent throughput, but it will be at the cost of additional memory usage, garbage collection churn, etc.</p> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="title">Default lock striping settings</div> lock striping is disabled by default, due to potential deadlocks that can happen if locks for different keys end up in the same lock stripe. </td> </tr> </table> </div> <div class="paragraph"> <p>The size of the shared lock collection used by lock striping can be tuned using the <code>concurrencyLevel</code> attribute of the `&lt;locking /&gt; configuration element.</p> </div> <div class="paragraph"> <p><strong>Configuration example:</strong></p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;locking</span> <span class="attribute-name">striping</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false|true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Or</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> ConfigurationBuilder().locking().useLockStriping(<span class="predefined-constant">false</span>|<span class="predefined-constant">true</span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="concurrency_levels"><a class="anchor" href="#concurrency_levels"></a>5.1.6. Concurrency levels</h4> <div class="paragraph"> <p>In addition to determining the size of the striped lock container, this concurrency level is also used to tune any JDK <code>ConcurrentHashMap</code> based collections where related, such as internal to <code>DataContainer</code>s. Please refer to the JDK <code>ConcurrentHashMap</code> Javadocs for a detailed discussion of concurrency levels, as this parameter is used in exactly the same way in Infinispan.</p> </div> <div class="paragraph"> <p><strong>Configuration example:</strong></p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;locking</span> <span class="attribute-name">concurrency-level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">32</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Or</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> ConfigurationBuilder().locking().concurrencyLevel(<span class="integer">32</span>);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="lock_timeout"><a class="anchor" href="#lock_timeout"></a>5.1.7. Lock timeout</h4> <div class="paragraph"> <p>The lock timeout specifies the amount of time, in milliseconds, to wait for a contented lock.</p> </div> <div class="paragraph"> <p><strong>Configuration example:</strong></p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;locking</span> <span class="attribute-name">acquire-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Or</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> ConfigurationBuilder().locking().lockAcquisitionTimeout(<span class="integer">10000</span>);
<span class="comment">//alternatively</span>
<span class="keyword">new</span> ConfigurationBuilder().locking().lockAcquisitionTimeout(<span class="integer">10</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="consistency"><a class="anchor" href="#consistency"></a>5.1.8. Consistency</h4> <div class="paragraph"> <p>The fact that a single owner is locked (as opposed to all owners being locked) does not break the following consistency guarantee: if key <code>K</code> is hashed to nodes <code>{A, B}</code> and transaction <code>TX1</code> acquires a lock for <code>K</code>, let&#8217;s say on <code>A</code>. If another transaction, <code>TX2</code>, is started on <code>B</code> (or any other node) and <code>TX2</code> tries to lock <code>K</code> then it will fail with a timeout as the lock is already held by <code>TX1</code>. The reason for this is the that the lock for a key <code>K</code> is always, deterministically, acquired on the same node of the cluster, regardless of where the transaction originates.</p> </div> </div> </div> <div class="sect2"> <h3 id="data_versioning"><a class="anchor" href="#data_versioning"></a>5.2. Data Versioning</h3> <div class="paragraph"> <p>Infinispan supports two forms of data versioning: simple and external. The simple versioning is used in transactional caches for write skew check.</p> </div> <div class="paragraph"> <p>The external versioning is used to encapsulate an external source of data versioning within Infinispan, such as when using Infinispan with Hibernate which in turn gets its data version information directly from a database.</p> </div> <div class="paragraph"> <p>In this scheme, a mechanism to pass in the version becomes necessary, and overloaded versions of <code>put()</code> and <code>putForExternalRead()</code> will be provided in <code>AdvancedCache</code> to take in an external data version. This is then stored on the <code>InvocationContext</code> and applied to the entry at commit time.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Write skew checks cannot and will not be performed in the case of external data versioning. </td> </tr> </table> </div> </div> </div> </div> <div class="sect1"> <h2 id="clustered_lock"><a class="anchor" href="#clustered_lock"></a>6. Clustered Lock</h2> <div class="sectionbody"> <div class="paragraph"> <p>A <em>clustered lock</em> is a lock which is distributed and shared among all nodes in the Infinispan cluster and currently provides a way to execute code that will be synchronized between the nodes in a given cluster.</p> </div> <div class="sect2"> <h3 id="installation"><a class="anchor" href="#installation"></a>6.1. Installation</h3> <div class="paragraph"> <p>In order to start using the clustered locks, you needs to add the dependency in your Maven <code>pom.xml</code> file:</p> </div> <div class="listingblock"> <div class="title">pom.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-clustered-lock<span class="tag">&lt;/artifactId&gt;</span>
  <span class="comment">&lt;!-- Replace ${version.infinispan} with the
  version of Infinispan that you're using. --&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="clusteredlock_configuration"><a class="anchor" href="#clusteredlock_configuration"></a>6.2. ClusteredLock Configuration</h3> <div class="paragraph"> <p>Currently there is a single type of <code>ClusteredLock</code> supported : non reentrant, NODE ownership lock.</p> </div> <div class="sect3"> <h4 id="clustered_lock_ownership"><a class="anchor" href="#clustered_lock_ownership"></a>6.2.1. Ownership</h4> <div class="ulist"> <ul> <li> <p><code>NODE</code> When a <code>ClusteredLock</code> is defined, this lock can be used from all the nodes in the Infinispan cluster. When the ownership is NODE type, this means that the owner of the lock is the Infinispan node that acquired the lock at a given time. This means that each time we get a <code>ClusteredLock</code> instance with the <code>ClusteredCacheManager</code>, this instance will be the same instance for each Infinispan node. This lock can be used to synchronize code between Infinispan nodes. The advantage of this lock is that any thread in the node can release the lock at a given time.</p> </li> <li> <p><code>INSTANCE</code> - not yet supported</p> </li> </ul> </div> <div class="paragraph"> <p>When a <code>ClusteredLock</code> is defined, this lock can be used from all the nodes in the Infinispan cluster. When the ownership is INSTANCE type, this means that the owner of the lock is the actual instance we acquired when <code>ClusteredLockManager.get("lockName")</code> is called.</p> </div> <div class="paragraph"> <p>This means that each time we get a <code>ClusteredLock</code> instance with the <code>ClusteredCacheManager</code>, this instance will be a new instance. This lock can be used to synchronize code between Infinispan nodes and inside each Infinispan node. The advantage of this lock is that only the instance that called 'lock' can release the lock.</p> </div> </div> <div class="sect3"> <h4 id="reentrancy"><a class="anchor" href="#reentrancy"></a>6.2.2. Reentrancy</h4> <div class="paragraph"> <p>When a <code>ClusteredLock</code> is configured reentrant, the owner of the lock can reacquire the lock as many consecutive times as it wants while holding the lock.</p> </div> <div class="paragraph"> <p>Currently, only non reentrant locks are supported. This means that when two consecutive <code>lock</code> calls are sent for the same owner, the first call will acquire the lock if it&#8217;s available, and the second call will block.</p> </div> </div> </div> <div class="sect2"> <h3 id="clusteredlockmanager_interface"><a class="anchor" href="#clusteredlockmanager_interface"></a>6.3. ClusteredLockManager Interface</h3> <div class="paragraph"> <p>The <code>ClusteredLockManager</code> interface, <strong>marked as experimental</strong>, is the entry point to define, retrieve and remove a lock. It automatically listen to the creation of <code>EmbeddedCacheManager</code> and proceeds with the registration of an instance of it per <code>EmbeddedCacheManager</code>. It starts the internal caches needed to store the lock state.</p> </div> <div class="paragraph"> <p>Retrieving the <code>ClusteredLockManager</code> is as simple as invoking the <code>EmbeddedClusteredLockManagerFactory.from(EmbeddedCacheManager)</code> as shown in the example below:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// create or obtain your EmbeddedCacheManager</span>
EmbeddedCacheManager manager = ...;

<span class="comment">// retrieve the ClusteredLockManager</span>
ClusteredLockManager clusteredLockManager = EmbeddedClusteredLockManagerFactory.from(manager);</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Experimental</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ClusteredLockManager</span> {

   <span class="type">boolean</span> defineLock(<span class="predefined-type">String</span> name);

   <span class="type">boolean</span> defineLock(<span class="predefined-type">String</span> name, ClusteredLockConfiguration configuration);

   ClusteredLock get(<span class="predefined-type">String</span> name);

   ClusteredLockConfiguration getConfiguration(<span class="predefined-type">String</span> name);

   <span class="type">boolean</span> isDefined(<span class="predefined-type">String</span> name);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; remove(<span class="predefined-type">String</span> name);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; forceRelease(<span class="predefined-type">String</span> name);
}</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p><code>defineLock</code> : Defines a lock with the specified name and the default <code>ClusteredLockConfiguration</code>. It does not overwrite existing configurations.</p> </li> <li> <p><code>defineLock(String name, ClusteredLockConfiguration configuration)</code> : Defines a lock with the specified name and <code>ClusteredLockConfiguration</code>. It does not overwrite existing configurations.</p> </li> <li> <p><code>ClusteredLock get(String name)</code> : Get’s a <code>ClusteredLock</code> by it’s name. A call of <code>defineLock</code> must be done at least once in the cluster. See <a href="#clustered_lock_ownership">ownership</a> level section to understand the implications of <code>get</code> method call.</p> </li> </ul> </div> <div class="paragraph"> <p>Currently, the only ownership level supported is <strong>NODE</strong>.</p> </div> <div class="ulist"> <ul> <li> <p><code>ClusteredLockConfiguration getConfiguration(String name)</code> :</p> </li> </ul> </div> <div class="paragraph"> <p>Returns the configuration of a <code>ClusteredLock</code>, if such exists.</p> </div> <div class="ulist"> <ul> <li> <p><code>boolean isDefined(String name)</code> : Checks if a lock is already defined.</p> </li> <li> <p><code>CompletableFuture&lt;Boolean&gt; remove(String name)</code> : Removes a <code>ClusteredLock</code> if such exists.</p> </li> <li> <p><code>CompletableFuture&lt;Boolean&gt; forceRelease(String name)</code> : Releases - or unlocks - a <code>ClusteredLock</code>, if such exists, no matter who is holding it at a given time. Calling this method may cause concurrency issues and has to be used in <strong>exceptional situations</strong>.</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="clustered_lock_interface"><a class="anchor" href="#clustered_lock_interface"></a>6.4. ClusteredLock Interface</h3> <div class="paragraph"> <p><code>ClusteredLock</code> interface, <strong>marked as experimental</strong>, is the interface that implements the clustered locks.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Experimental</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ClusteredLock</span> {

   CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; lock();

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; tryLock();

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; tryLock(<span class="type">long</span> time, <span class="predefined-type">TimeUnit</span> unit);

   CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; unlock();

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; isLocked();

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; isLockedByMe();
}</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p><code>lock</code> : Acquires the lock. If the lock is not available then call blocks until the lock is acquired. Currently, <strong>there is no maximum time specified for a lock request to fail</strong>, so this could cause thread starvation.</p> </li> <li> <p><code>tryLock</code> Acquires the lock only if it is free at the time of invocation, and returns <code>true</code> in that case. This method does not block (or wait) for any lock acquisition.</p> </li> <li> <p><code>tryLock(long time, TimeUnit unit)</code> If the lock is available this method returns immediately with <code>true</code>. If the lock is not available then the call waits until :</p> <div class="ulist"> <ul> <li> <p>The lock is acquired</p> </li> <li> <p>The specified waiting time elapses</p> </li> </ul> </div> </li> </ul> </div> <div class="paragraph"> <p>If the time is less than or equal to zero, the method will not wait at all.</p> </div> <div class="ulist"> <ul> <li> <p><code>unlock</code></p> </li> </ul> </div> <div class="paragraph"> <p>Releases the lock. Only the holder of the lock may release the lock.</p> </div> <div class="ulist"> <ul> <li> <p><code>isLocked</code> Returns <code>true</code> when the lock is locked and <code>false</code> when the lock is released.</p> </li> <li> <p><code>isLockedByMe</code> Returns <code>true</code> when the lock is owned by the caller and <code>false</code> when the lock is owned by someone else or it&#8217;s released.</p> </li> </ul> </div> <div class="sect3"> <h4 id="clustered_lock_usage"><a class="anchor" href="#clustered_lock_usage"></a>6.4.1. Usage Examples</h4> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">EmbeddedCache cm = ...;
ClusteredLockManager cclm = EmbeddedClusteredLockManagerFactory.from(cm);

lock.tryLock()
  .thenCompose(result -&gt; {
     <span class="keyword">if</span> (result) {
      <span class="keyword">try</span> {
          <span class="comment">// manipulate protected state</span>
          } <span class="keyword">finally</span> {
             <span class="keyword">return</span> lock.unlock();
          }
     } <span class="keyword">else</span> {
        <span class="comment">// Do something else</span>
     }
  });
}</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="clusteredlockmanager_configuration"><a class="anchor" href="#clusteredlockmanager_configuration"></a>6.4.2. ClusteredLockManager Configuration</h4> <div class="paragraph"> <p>You can configure <code>ClusteredLockManager</code> to use different strategies for locks, either declaratively or programmatically, with the following attributes:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1"><code>num-owners</code></dt> <dd> <p>Defines the total number of nodes in each cluster that store the states of clustered locks. The default value is <code>-1</code>, which replicates the value to all nodes.</p> </dd> <dt class="hdlist1"><code>reliability</code></dt> <dd> <p>Controls how clustered locks behave when clusters split into partitions or multiple nodes leave a cluster. You can set the following values:</p> <div class="ulist"> <ul> <li> <p><code>AVAILABLE</code>: Nodes in any partition can concurrently operate on locks.</p> </li> <li> <p><code>CONSISTENT</code>: Only nodes that belong to the majority partition can operate on locks. This is the default value.</p> </li> </ul> </div> </dd> </dl> </div> <div class="paragraph"> <p>The following is an example declarative configuration for <code>ClusteredLockManager</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;infinispan</span>
        <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:${infinispan.core.schema.version} http://www.infinispan.org/schemas/infinispan-config-10.0.xsd</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:10.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;transport</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;locking</span> <span class="attribute-name">concurrency-level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">acquire-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>

        <span class="tag">&lt;clustered-locks</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:clustered-locks:10.0</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">num-owners</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">reliability</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AVAILABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;clustered-lock</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lock1</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;clustered-lock</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lock2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/clustered-locks&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span>
    ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="clustered_counters"><a class="anchor" href="#clustered_counters"></a>7. Clustered Counters</h2> <div class="sectionbody"> <div class="paragraph"> <p><em>Clustered counters</em> are counters which are distributed and shared among all nodes in the Infinispan cluster. Counters can have different consistency levels: strong and weak.</p> </div> <div class="paragraph"> <p>Although a strong/weak consistent counter has separate interfaces, both support updating its value, return the current value and they provide events when its value is updated. Details are provided below in this document to help you choose which one fits best your uses-case.</p> </div> <div class="sect2"> <h3 id="installation_and_configuration"><a class="anchor" href="#installation_and_configuration"></a>7.1. Installation and Configuration</h3> <div class="paragraph"> <p>In order to start using the counters, you needs to add the dependency in your Maven <code>pom.xml</code> file:</p> </div> <div class="listingblock"> <div class="title">pom.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-clustered-counter<span class="tag">&lt;/artifactId&gt;</span>
  <span class="comment">&lt;!-- Replace ${version.infinispan} with the
  version of Infinispan that you're using. --&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The counters can be configured Infinispan configuration file or on-demand via the <code>CounterManager</code> interface detailed later in this document. A counters configured in Infinispan configuration file is created at boot time when the <code>EmbeddedCacheManager</code> is starting. Theses counters are started eagerly and they are available in all the cluster&#8217;s nodes.</p> </div> <div class="listingblock"> <div class="title">configuration.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;infinispan&gt;</span>
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">...</span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- if needed to persist counter, global state needs to be configured --&gt;</span>
        <span class="tag">&lt;global-state&gt;</span>
            ...
        <span class="tag">&lt;/global-state&gt;</span>
        <span class="comment">&lt;!-- your caches configuration goes here --&gt;</span>
         <span class="tag">&lt;counters</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:counters:9.2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">num-owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">reliability</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CONSISTENT</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
             <span class="tag">&lt;strong-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;strong-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VOLATILE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                 <span class="tag">&lt;lower-bound</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;/strong-counter&gt;</span>
             <span class="tag">&lt;strong-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENT</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                 <span class="tag">&lt;upper-bound</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;/strong-counter&gt;</span>
             <span class="tag">&lt;strong-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VOLATILE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                 <span class="tag">&lt;lower-bound</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                 <span class="tag">&lt;upper-bound</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;/strong-counter&gt;</span>
             <span class="tag">&lt;weak-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENT</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">concurrency-level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/counters&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>or programmatically, in the <code>GlobalConfigurationBuilder</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder globalConfigurationBuilder = ...;
CounterManagerConfigurationBuilder builder = globalConfigurationBuilder.addModule(CounterManagerConfigurationBuilder.class);
builder.numOwner(<span class="integer">3</span>).reliability(Reliability.CONSISTENT);
builder.addStrongCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c1</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">1</span>).storage(Storage.PERSISTENT);
builder.addStrongCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c2</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">2</span>).lowerBound(<span class="integer">0</span>).storage(Storage.VOLATILE);
builder.addStrongCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c3</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">3</span>).upperBound(<span class="integer">5</span>).storage(Storage.PERSISTENT);
builder.addStrongCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c4</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">4</span>).lowerBound(<span class="integer">0</span>).upperBound(<span class="integer">10</span>).storage(Storage.VOLATILE);
builder.addWeakCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c5</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">5</span>).concurrencyLevel(<span class="integer">1</span>).storage(Storage.PERSISTENT);</code></pre> </div> </div> <div class="paragraph"> <p>On other hand, the counters can be configured on-demand, at any time after the <code>EmbeddedCacheManager</code> is initialized.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CounterManager manager = ...;
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c1</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.UNBOUNDED_STRONG).initialValue(<span class="integer">1</span>).storage(Storage.PERSISTENT)build());
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c2</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(<span class="integer">2</span>).lowerBound(<span class="integer">0</span>).storage(Storage.VOLATILE).build());
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c3</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(<span class="integer">3</span>).upperBound(<span class="integer">5</span>).storage(Storage.PERSISTENT).build());
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c4</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(<span class="integer">4</span>).lowerBound(<span class="integer">0</span>).upperBound(<span class="integer">10</span>).storage(Storage.VOLATILE).build());
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c2</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.WEAK).initialValue(<span class="integer">5</span>).concurrencyLevel(<span class="integer">1</span>).storage(Storage.PERSISTENT).build());</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <code>CounterConfiguration</code> is immutable and can be reused. </td> </tr> </table> </div> <div class="paragraph"> <p>The method <code>defineCounter()</code> will return <code>true</code> if the counter is successful configured or <code>false</code> otherwise. However, if the configuration is invalid, the method will throw a <code>CounterConfigurationException</code>. To find out if a counter is already defined, use the method <code>isDefined()</code>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CounterManager manager = ...
if (!manager.isDefined(<span class="string"><span class="delimiter">&quot;</span><span class="content">someCounter</span><span class="delimiter">&quot;</span></span>)) {
    manager.define(<span class="string"><span class="delimiter">&quot;</span><span class="content">someCounter</span><span class="delimiter">&quot;</span></span>, ...);
}</code></pre> </div> </div> <div class="paragraph"> <p><strong>Per cluster attributes:</strong></p> </div> <div class="ulist"> <ul> <li> <p><code>num-owners</code>: Sets the number of counter&#8217;s copies to keep cluster-wide. A smaller number will make update operations faster but will support a lower number of server crashes. It <strong>must be positive</strong> and its default value is <code>2</code>.</p> </li> <li> <p><code>reliability</code>: Sets the counter&#8217;s update behavior in a network partition. Default value is <code>AVAILABLE</code> and valid values are:</p> <div class="ulist"> <ul> <li> <p><code>AVAILABLE</code>: all partitions are able to read and update the counter&#8217;s value.</p> </li> <li> <p><code>CONSISTENT</code>: only the primary partition (majority of nodes) will be able to read and update the counter&#8217;s value. The remaining partitions can only read its value.</p> </li> </ul> </div> </li> </ul> </div> <div class="paragraph"> <p><strong>Per counter attributes:</strong></p> </div> <div class="ulist"> <ul> <li> <p><code>initial-value</code> [common]: Sets the counter&#8217;s initial value. Default is <code>0</code> (zero).</p> </li> <li> <p><code>storage</code> [common]: Sets the counter&#8217;s behavior when the cluster is shutdown and restarted. Default value is <code>VOLATILE</code> and valid values are:</p> <div class="ulist"> <ul> <li> <p><code>VOLATILE</code>: the counter&#8217;s value is only available in memory. The value will be lost when a cluster is shutdown.</p> </li> <li> <p><code>PERSISTENT</code>: the counter&#8217;s value is stored in a private and local persistent store. The value is kept when the cluster is shutdown and restored after a restart.</p> </li> </ul> </div> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> On-demand and <code>VOLATILE</code> counters will lose its value and configuration after a cluster shutdown. They must be defined again after the restart. </td> </tr> </table> </div> <div class="ulist"> <ul> <li> <p><code>lower-bound</code> [strong]: Sets the strong consistent counter&#8217;s lower bound. Default value is <code>Long.MIN_VALUE</code>.</p> </li> <li> <p><code>upper-bound</code> [strong]: Sets the strong consistent counter&#8217;s upper bound. Default value is <code>Long.MAX_VALUE</code>.</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> If neither the <code>lower-bound</code> or <code>upper-bound</code> are configured, the strong counter is set as unbounded. </td> </tr> </table> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> The <code>initial-value</code> must be between <code>lower-bound</code> and <code>upper-bound</code> inclusive. </td> </tr> </table> </div> <div class="ulist"> <ul> <li> <p><code>concurrency-level</code> [weak]: Sets the number of concurrent updates. Its value <strong>must be positive</strong> and the default value is <code>16</code>.</p> </li> </ul> </div> <div class="sect3"> <h4 id="list_counter_names"><a class="anchor" href="#list_counter_names"></a>7.1.1. List counter names</h4> <div class="paragraph"> <p>To list all the counters defined, the method <code>CounterManager.getCounterNames()</code> returns a collection of all counter names created cluster-wide.</p> </div> </div> </div> <div class="sect2"> <h3 id="the_countermanager_interface"><a class="anchor" href="#the_countermanager_interface"></a>7.2. The <code>CounterManager</code> interface.</h3> <div class="paragraph"> <p>The <code>CounterManager</code> interface is the entry point to define, retrieve and remove a counter. It automatically listen to the creation of <code>EmbeddedCacheManager</code> and proceeds with the registration of an instance of it per <code>EmbeddedCacheManager</code>. It starts the caches needed to store the counter state and configures the default counters.</p> </div> <div class="paragraph"> <p>Retrieving the <code>CounterManager</code> is as simple as invoke the <code>EmbeddedCounterManagerFactory.asCounterManager(EmbeddedCacheManager)</code> as shown in the example below:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// create or obtain your EmbeddedCacheManager</span>
EmbeddedCacheManager manager = ...;

<span class="comment">// retrieve the CounterManager</span>
CounterManager counterManager = EmbeddedCounterManagerFactory.asCounterManager(manager);</code></pre> </div> </div> <div class="paragraph"> <p>For Hot Rod client, the <code>CounterManager</code> is registered in the RemoteCacheManager and it can be retrieved like:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// create or obtain your RemoteCacheManager</span>
RemoteCacheManager manager = ...;

<span class="comment">// retrieve the CounterManager</span>
CounterManager counterManager = RemoteCounterManagerFactory.asCounterManager(manager);</code></pre> </div> </div> <div class="sect3"> <h4 id="remove_a_counter_via_countermanager"><a class="anchor" href="#remove_a_counter_via_countermanager"></a>7.2.1. Remove a counter via CounterManager</h4> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> use with caution. </td> </tr> </table> </div> <div class="paragraph"> <p>There is a difference between remove a counter via the <code>Strong/WeakCounter</code> interfaces and the <code>CounterManager</code>. The <code>CounterManager.remove(String)</code> removes the counter value from the cluster and removes all the listeners registered in the counter in the local counter instance. In addition, the counter instance is no longer reusable and it may return an invalid results.</p> </div> <div class="paragraph"> <p>On the other side, the <code>Strong/WeakCounter</code> removal only removes the counter value. The instance can still be reused and the listeners still works.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The counter is re-created if it is accessed after a removal. </td> </tr> </table> </div> </div> </div> <div class="sect2"> <h3 id="the_counter"><a class="anchor" href="#the_counter"></a>7.3. The Counter</h3> <div class="paragraph"> <p>A counter can be strong (<code>StrongCounter</code>) or weakly consistent (<code>WeakCounter</code>) and both is identified by a name. They have a specific interface but they share some logic, namely, both of them are asynchronous ( a <code>CompletableFuture</code> is returned by each operation), provide an update event and can be reset to its initial value.</p> </div> <div class="paragraph"> <p>If you don&#8217;t want to use the async API, it is possible to return a synchronous counter via <code>sync()</code> method. The API is the same but without the <code>CompletableFuture</code> return value.</p> </div> <div class="paragraph"> <p>The following methods are common to both interfaces:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> getName();
CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; getValue();
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; reset();
&lt;T <span class="directive">extends</span> CounterListener&gt; Handle&lt;T&gt; addListener(T listener);
CounterConfiguration getConfiguration();
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; remove();
SyncStrongCounter sync(); <span class="comment">//SyncWeakCounter for WeakCounter</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p><code>getName()</code> returns the counter name (identifier).</p> </li> <li> <p><code>getValue()</code> returns the current counter&#8217;s value.</p> </li> <li> <p><code>reset()</code> allows to reset the counter&#8217;s value to its initial value.</p> </li> <li> <p><code>addListener()</code> register a listener to receive update events. More details about it in the <a href="#clustered_counters_notify_events">Notification and Events</a> section.</p> </li> <li> <p><code>getConfiguration()</code> returns the configuration used by the counter.</p> </li> <li> <p><code>remove()</code> removes the counter value from the cluster. The instance can still be used and the listeners are kept.</p> </li> <li> <p><code>sync()</code> creates a synchronous counter.</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The counter is re-created if it is accessed after a removal. </td> </tr> </table> </div> <div class="sect3"> <h4 id="the_strongcounter_interface_when_the_consistency_or_bounds_matters"><a class="anchor" href="#the_strongcounter_interface_when_the_consistency_or_bounds_matters"></a>7.3.1. The <code>StrongCounter</code> interface: when the consistency or bounds matters.</h4> <div class="paragraph"> <p>The strong counter provides uses a single key stored in Infinispan cache to provide the consistency needed. All the updates are performed under the key lock to updates its values. On other hand, the reads don&#8217;t acquire any locks and reads the current value. Also, with this scheme, it allows to bound the counter value and provide atomic operations like compare-and-set/swap.</p> </div> <div class="paragraph"> <p>A <code>StrongCounter</code> can be retrieved from the <code>CounterManager</code> by using the <code>getStrongCounter()</code> method. As an example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CounterManager counterManager = ...
StrongCounter aCounter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-counter);</span></span></code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> Since every operation will hit a single key, the <code>StrongCounter</code> has a higher contention rate. </td> </tr> </table> </div> <div class="paragraph"> <p>The <code>StrongCounter</code> interface adds the following method:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">default</span> CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; incrementAndGet() {
   <span class="keyword">return</span> addAndGet(<span class="integer">1L</span>);
}

<span class="keyword">default</span> CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; decrementAndGet() {
   <span class="keyword">return</span> addAndGet(-<span class="integer">1L</span>);
}

CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; addAndGet(<span class="type">long</span> delta);

CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; compareAndSet(<span class="type">long</span> expect, <span class="type">long</span> update);

CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; compareAndSwap(<span class="type">long</span> expect, <span class="type">long</span> update);</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p><code>incrementAndGet()</code> increments the counter by one and returns the new value.</p> </li> <li> <p><code>decrementAndGet()</code> decrements the counter by one and returns the new value.</p> </li> <li> <p><code>addAndGet()</code> adds a delta to the counter&#8217;s value and returns the new value.</p> </li> <li> <p><code>compareAndSet()</code> and <code>compareAndSwap()</code> atomically set the counter&#8217;s value if the current value is the expected.</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> A operation is considered completed when the <code>CompletableFuture</code> is completed. </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The difference between compare-and-set and compare-and-swap is that the former returns true if the operation succeeds while the later returns the previous value. The compare-and-swap is successful if the return value is the same as the expected. </td> </tr> </table> </div> <div class="sect4"> <h5 id="bounded_strongcounter"><a class="anchor" href="#bounded_strongcounter"></a>Bounded <code>StrongCounter</code></h5> <div class="paragraph"> <p>When bounded, all the update method above will throw a <code>CounterOutOfBoundsException</code> when they reached the lower or upper bound. The exception has the following methods to check which side bound has been reached:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">boolean</span> isUpperBoundReached();
<span class="directive">public</span> <span class="type">boolean</span> isLowerBoundReached();</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="uses_cases"><a class="anchor" href="#uses_cases"></a>Uses cases</h5> <div class="paragraph"> <p>The strong counter fits better in the following uses cases:</p> </div> <div class="ulist"> <ul> <li> <p>When counter&#8217;s value is needed after each update (example, cluster-wise ids generator or sequences)</p> </li> <li> <p>When a bounded counter is needed (example, rate limiter)</p> </li> </ul> </div> </div> <div class="sect4"> <h5 id="usage_examples"><a class="anchor" href="#usage_examples"></a>Usage Examples</h5> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">StrongCounter counter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded_counter</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// incrementing the counter</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + counter.incrementAndGet().get());

<span class="comment">// decrement the counter's value by 100 using the functional API</span>
counter.addAndGet(-<span class="integer">100</span>).thenApply(v -&gt; {
   <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + v);
   <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}).get

<span class="comment">// alternative, you can do some work while the counter is updated</span>
CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; f = counter.addAndGet(<span class="integer">10</span>);
<span class="comment">// ... do some work ...</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + f.get());

<span class="comment">// and then, check the current value</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());

<span class="comment">// finally, reset to initial value</span>
counter.reset().get();
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());

<span class="comment">// or set to a new value if zero</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">compare and set succeeded? </span><span class="delimiter">&quot;</span></span> + counter.compareAndSet(<span class="integer">0</span>, <span class="integer">1</span>));</code></pre> </div> </div> <div class="paragraph"> <p>And below, there is another example using a bounded counter:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">StrongCounter counter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">bounded_counter</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// incrementing the counter</span>
<span class="keyword">try</span> {
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + counter.addAndGet(<span class="integer">100</span>).get());
} <span class="keyword">catch</span> (<span class="exception">ExecutionException</span> e) {
    <span class="predefined-type">Throwable</span> cause = e.getCause();
    <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> CounterOutOfBoundsException) {
       <span class="keyword">if</span> (((CounterOutOfBoundsException) cause).isUpperBoundReached()) {
          <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ops, upper bound reached.</span><span class="delimiter">&quot;</span></span>);
       } <span class="keyword">else</span> <span class="keyword">if</span> (((CounterOutOfBoundsException) cause).isLowerBoundReached()) {
          <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ops, lower bound reached.</span><span class="delimiter">&quot;</span></span>);
       }
    }
}

<span class="comment">// now using the functional API</span>
counter.addAndGet(-<span class="integer">100</span>).handle((v, throwable) -&gt; {
   <span class="keyword">if</span> (throwable != <span class="predefined-constant">null</span>) {
      <span class="predefined-type">Throwable</span> cause = throwable.getCause();
      <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> CounterOutOfBoundsException) {
         <span class="keyword">if</span> (((CounterOutOfBoundsException) cause).isUpperBoundReached()) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ops, upper bound reached.</span><span class="delimiter">&quot;</span></span>);
         } <span class="keyword">else</span> <span class="keyword">if</span> (((CounterOutOfBoundsException) cause).isLowerBoundReached()) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ops, lower bound reached.</span><span class="delimiter">&quot;</span></span>);
         }
      }
      <span class="keyword">return</span> <span class="predefined-constant">null</span>;
   }
   <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + v);
   <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}).get();</code></pre> </div> </div> <div class="paragraph"> <p>Compare-and-set vs Compare-and-swap examples:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">StrongCounter counter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-counter</span><span class="delimiter">&quot;</span></span>);
<span class="type">long</span> oldValue, newValue;
<span class="keyword">do</span> {
   oldValue = counter.getValue().get();
   newValue = someLogic(oldValue);
} <span class="keyword">while</span> (!counter.compareAndSet(oldValue, newValue).get());</code></pre> </div> </div> <div class="paragraph"> <p>With compare-and-swap, it saves one invocation counter invocation (<code>counter.getValue()</code>)</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">StrongCounter counter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-counter</span><span class="delimiter">&quot;</span></span>);
<span class="type">long</span> oldValue = counter.getValue().get();
<span class="type">long</span> currentValue, newValue;
<span class="keyword">do</span> {
   currentValue = oldValue;
   newValue = someLogic(oldValue);
} <span class="keyword">while</span> ((oldValue = counter.compareAndSwap(oldValue, newValue).get()) != currentValue);</code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="the_weakcounter_interface_when_speed_is_needed"><a class="anchor" href="#the_weakcounter_interface_when_speed_is_needed"></a>7.3.2. The <code>WeakCounter</code> interface: when speed is needed</h4> <div class="paragraph"> <p>The <code>WeakCounter</code> stores the counter&#8217;s value in multiple keys in Infinispan cache. The number of keys created is configured by the <code>concurrency-level</code> attribute. Each key stores a partial state of the counter&#8217;s value and it can be updated concurrently. It main advantage over the <code>StrongCounter</code> is the lower contention in the cache. On other hand, the read of its value is more expensive and bounds are not allowed.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> The reset operation should be handled with caution. It is <strong>not</strong> atomic and it produces intermediates values. These value may be seen by a read operation and by any listener registered. </td> </tr> </table> </div> <div class="paragraph"> <p>A <code>WeakCounter</code> can be retrieved from the <code>CounterManager</code> by using the <code>getWeakCounter()</code> method. As an example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">CounterManager counterManager = ...
StrongCounter aCounter = counterManager.getWeakCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-counter);</span></span></code></pre> </div> </div> <div class="sect4"> <h5 id="weak_counter_interface"><a class="anchor" href="#weak_counter_interface"></a>Weak Counter Interface</h5> <div class="paragraph"> <p>The <code>WeakCounter</code> adds the following methods:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">default</span> CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; increment() {
   <span class="keyword">return</span> add(<span class="integer">1L</span>);
}

<span class="keyword">default</span> CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; decrement() {
   <span class="keyword">return</span> add(-<span class="integer">1L</span>);
}

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; add(<span class="type">long</span> delta);</code></pre> </div> </div> <div class="paragraph"> <p>They are similar to the `StrongCounter&#8217;s methods but they don&#8217;t return the new value.</p> </div> </div> <div class="sect4"> <h5 id="uses_cases_2"><a class="anchor" href="#uses_cases_2"></a>Uses cases</h5> <div class="paragraph"> <p>The weak counter fits best in uses cases where the result of the update operation is not needed or the counter&#8217;s value is not required too often. Collecting statistics is a good example of such an use case.</p> </div> </div> <div class="sect4"> <h5 id="examples_2"><a class="anchor" href="#examples_2"></a>Examples</h5> <div class="paragraph"> <p>Below, there is an example of the weak counter usage.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">WeakCounter counter = counterManager.getWeakCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my_counter</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// increment the counter and check its result</span>
counter.increment().get();
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; f = counter.add(-<span class="integer">100</span>);
<span class="comment">//do some work</span>
f.get(); <span class="comment">//wait until finished</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());

<span class="comment">//using the functional API</span>
counter.reset().whenComplete((aVoid, throwable) -&gt; <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Reset done </span><span class="delimiter">&quot;</span></span> + (throwable == <span class="predefined-constant">null</span> ? <span class="string"><span class="delimiter">&quot;</span><span class="content">successfully</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">unsuccessfully</span><span class="delimiter">&quot;</span></span>))).get();
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());</code></pre> </div> </div> </div> </div> </div> <div class="sect2"> <h3 id="clustered_counters_notify_events"><a class="anchor" href="#clustered_counters_notify_events"></a>7.4. Notifications and Events</h3> <div class="paragraph"> <p>Both strong and weak counter supports a listener to receive its updates events. The listener must implement <code>CounterListener</code> and it can be registered by the following method:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">&lt;T <span class="directive">extends</span> CounterListener&gt; Handle&lt;T&gt; addListener(T listener);</code></pre> </div> </div> <div class="paragraph"> <p>The <code>CounterListener</code> has the following interface:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CounterListener</span> {
   <span class="type">void</span> onUpdate(CounterEvent entry);
}</code></pre> </div> </div> <div class="paragraph"> <p>The <code>Handle</code> object returned has the main goal to remove the <code>CounterListener</code> when it is not longer needed. Also, it allows to have access to the <code>CounterListener</code> instance that is it handling. It has the following interface:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Handle</span>&lt;T <span class="directive">extends</span> CounterListener&gt; {
   T getCounterListener();
   <span class="type">void</span> remove();
}</code></pre> </div> </div> <div class="paragraph"> <p>Finally, the <code>CounterEvent</code> has the previous and current value and state. It has the following interface:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CounterEvent</span> {
   <span class="type">long</span> getOldValue();
   State getOldState();
   <span class="type">long</span> getNewValue();
   State getNewState();
}</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> The state is always <code>State.VALID</code> for unbounded strong counter and weak counter. <code>State.LOWER_BOUND_REACHED</code> and <code>State.UPPER_BOUND_REACHED</code> are only valid for bounded strong counters. </td> </tr> </table> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> The weak counter <code>reset()</code> operation will trigger multiple notification with intermediate values. </td> </tr> </table> </div> </div> </div> </div> <div class="sect1"> <h2 id="endpoint_interop"><a class="anchor" href="#endpoint_interop"></a>8. Protocol Interoperability</h2> <div class="sectionbody"> <div class="paragraph"> <p>Clients exchange data with Infinispan through endpoints such as REST or Hot Rod.</p> </div> <div class="paragraph"> <p>Each endpoint uses a different protocol so that clients can read and write data in a suitable format. Because Infinispan can interoperate with multiple clients at the same time, it must convert data between client formats and the storage formats.</p> </div> <div class="paragraph"> <p>To configure Infinispan endpoint interoperability, you should define the <a href="#encoding_media_type">MediaType</a> that sets the format for data stored in the cache.</p> </div> <div class="sect2"> <h3 id="considerations_with_media_types_and_endpoint_interoperability"><a class="anchor" href="#considerations_with_media_types_and_endpoint_interoperability"></a>8.1. Considerations with Media Types and Endpoint Interoperability</h3> <div class="paragraph"> <p>Configuring Infinispan to store data with a specific media type affects client interoperability.</p> </div> <div class="paragraph"> <p>Although REST clients do support sending and receiving encoded binary data, they are better at handling text formats such as JSON, XML, or plain text.</p> </div> <div class="paragraph"> <p>Memcached text clients can handle String-based keys and byte[] values but cannot negotiate data types with the server. These clients do not offer much flexibility when handling data formats because of the protocol definition.</p> </div> <div class="paragraph"> <p>Java Hot Rod clients are suitable for handling Java objects that represent entities that reside in the cache. Java Hot Rod clients use marshalling operations to serialize and deserialize those objects into byte arrays.</p> </div> <div class="paragraph"> <p>Similarly, non-Java Hot Rod clients, such as the C++, C#, and Javascript clients, are suitable for handling objects in the respective languages. However, non-Java Hot Rod clients can interoperate with Java Hot Rod clients using platform independent data formats.</p> </div> </div> <div class="sect2"> <h3 id="rest_hot_rod_and_memcached_interoperability_with_text_based_storage"><a class="anchor" href="#rest_hot_rod_and_memcached_interoperability_with_text_based_storage"></a>8.2. REST, Hot Rod, and Memcached Interoperability with Text-Based Storage</h3> <div class="paragraph"> <p>You can configure key and values with a text-based storage format.</p> </div> <div class="paragraph"> <p>For example, specify <code>text/plain; charset=UTF-8</code>, or any other character set, to set plain text as the media type. You can also specify a media type for other text-based formats such as JSON (<code>application/json</code>) or XML (<code>application/xml</code>) with an optional character set.</p> </div> <div class="paragraph"> <p>The following example configures the cache to store entries with the <code>text/plain; charset=UTF-8</code> media type:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain; charset=UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain; charset=UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>To handle the exchange of data in a text-based format, you must configure Hot Rod clients with the <code>org.infinispan.commons.marshall.StringMarshaller</code> marshaller.</p> </div> <div class="paragraph"> <p>REST clients must also send the correct headers when writing and reading from the cache, as follows:</p> </div> <div class="ulist"> <ul> <li> <p>Write: <code>Content-Type: text/plain; charset=UTF-8</code></p> </li> <li> <p>Read: <code>Accept: text/plain; charset=UTF-8</code></p> </li> </ul> </div> <div class="paragraph"> <p>Memcached clients do not require any configuration to handle text-based formats.</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top" colspan="2">This configuration is compatible with&#8230;&#8203;</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">REST clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Java Hot Rod clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Memcached clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Non-Java Hot Rod clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Querying and Indexing</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom Java objects</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> </tbody> </table> </div> <div class="sect2"> <h3 id="rest_hot_rod_and_memcached_interoperability_with_custom_java_objects"><a class="anchor" href="#rest_hot_rod_and_memcached_interoperability_with_custom_java_objects"></a>8.3. REST, Hot Rod, and Memcached Interoperability with Custom Java Objects</h3> <div class="paragraph"> <p>If you store entries in the cache as marshalled, custom Java objects, you should configure the cache with the MediaType of the marshalled storage.</p> </div> <div class="paragraph"> <p>Java Hot Rod clients use the JBoss marshalling storage format as the default to store entries in the cache as custom Java objects.</p> </div> <div class="paragraph"> <p>The following example configures the cache to store entries with the <code>application/x-jboss-marshalling</code> media type:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-jboss-marshalling</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-jboss-marshalling</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>If you use the Protostream marshaller, configure the MediaType as <code>application/x-protostream</code>. For UTF8Marshaller, configure the MediaType as <code>text/plain</code>.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>If only Hot Rod clients interact with the cache, you do not need to configure the MediaType.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Because REST clients are most suitable for handling text formats, you should use primitives such as <code>java.lang.String</code> for keys. Otherwise, REST clients must handle keys as <code>bytes[]</code> using a supported binary encoding.</p> </div> <div class="paragraph"> <p>REST clients can read values for cache entries in XML or JSON format. However, the classes must be available in the server.</p> </div> <div class="paragraph"> <p>To read and write data from Memcached clients, you must use <code>java.lang.String</code> for keys. Values are stored and returned as marshalled objects.</p> </div> <div class="paragraph"> <p>Some Java Memcached clients allow data transformers that marshall and unmarshall objects. You can also configure the Memcached server module to encode responses in different formats, such as 'JSON' which is language neutral. This allows non-Java clients to interact with the data even if the storage format for the cache is Java-specific.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>Storing Java objects in the cache requires you to deploy entity classes to {ProductName}. See <a href="#entities_deploy">Deploying Entity Classes</a>.</p> </div> </td> </tr> </table> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top" colspan="2">This configuration is compatible with&#8230;&#8203;</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">REST clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Java Hot Rod clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Memcached clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Non-Java Hot Rod clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Querying and Indexing</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom Java objects</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> </tbody> </table> </div> <div class="sect2"> <h3 id="java_and_non_java_client_interoperability_with_protobuf"><a class="anchor" href="#java_and_non_java_client_interoperability_with_protobuf"></a>8.4. Java and Non-Java Client Interoperability with Protobuf</h3> <div class="paragraph"> <p>Storing data in the cache as Protobuf encoded entries provides a platform independent configuration that enables Java and Non-Java clients to access and query the cache from any endpoint.</p> </div> <div class="paragraph"> <p>If indexing is configured for the cache, Infinispan automatically stores keys and values with the <code>application/x-protostream</code> media type.</p> </div> <div class="paragraph"> <p>If indexing is not configured for the cache, you can configure it to store entries with the <code>application/x-protostream</code> media type as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Infinispan converts between <code>application/x-protostream</code> and <code>application/json</code>, which allows REST clients to read and write JSON formatted data. However REST clients must send the correct headers, as follows:</p> </div> <div class="dlist"> <dl> <dt class="hdlist1">Read Header</dt> </dl> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="http">Read: Accept: application/json</code></pre> </div> </div> <div class="dlist"> <dl> <dt class="hdlist1">Write Header</dt> </dl> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="http">Write: Content-Type: application/json</code></pre> </div> </div> <div class="admonitionblock important"> <table> <tr> <td class="icon"> <i class="fa icon-important" title="Important"></i> </td> <td class="content"> <div class="paragraph"> <p>The <code>application/x-protostream</code> media type uses Protobuf encoding, which requires you to register a Protocol Buffers schema definition that describes the entities and marshallers that the clients use.</p> </div> </td> </tr> </table> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top" colspan="2">This configuration is compatible with&#8230;&#8203;</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">REST clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Java Hot Rod clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Non-Java Hot Rod clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Querying and Indexing</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom Java objects</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> </tbody> </table> </div> <div class="sect2"> <h3 id="embedded_remote_interop"><a class="anchor" href="#embedded_remote_interop"></a>8.5. Custom Code Interoperability</h3> <div class="paragraph"> <p>You can deploy custom code with Infinispan. For example, you can deploy scripts, tasks, listeners, converters, and merge policies. Because your custom code can access data directly in the cache, it must interoperate with clients that access data in the cache through different endpoints.</p> </div> <div class="paragraph"> <p>For example, you might create a remote task to handle custom objects stored in the cache while other clients store data in binary format.</p> </div> <div class="paragraph"> <p>To handle interoperability with custom code you can either convert data on demand or store data as Plain Old Java Objects (POJOs).</p> </div> <div class="sect3"> <h4 id="converting_data_on_demand"><a class="anchor" href="#converting_data_on_demand"></a>8.5.1. Converting Data On Demand</h4> <div class="paragraph"> <p>If the cache is configured to store data in a binary format such as <code>application/x-protostream</code> or <code>application/x-jboss-marshalling</code>, you can configure your deployed code to perform cache operations using Java objects as the media type. See <a href="#mediatype_override">Overriding the MediaType Programmatically</a>.</p> </div> <div class="paragraph"> <p>This approach allows remote clients to use a binary format for storing cache entries, which is optimal. However, you must make entity classes available to the server so that it can convert between binary format and Java objects.</p> </div> <div class="paragraph"> <p>Additionally, if the cache uses Protobuf (<code>application/x-protostream</code>) as the binary format, you must deploy protostream marshallers so that {ProductName} can unmarshall data from your custom code.</p> </div> </div> <div class="sect3"> <h4 id="storing_data_as_pojos"><a class="anchor" href="#storing_data_as_pojos"></a>8.5.2. Storing Data as POJOs</h4> <div class="paragraph"> <p>Storing unmarshalled Java objects in the server is not recommended. Doing so requires Infinispan to serialize data when remote clients read from the cache and then deserialize data when remote clients write to the cache.</p> </div> <div class="paragraph"> <p>The following example configures the cache to store entries with the <code>application/x-java-object</code> media type:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Hot Rod clients must use a supported marshaller when data is stored as POJOs in the cache, either the JBoss marshaller or the default Java serialization mechanism. You must also deploy the classes must be deployed in the server.</p> </div> <div class="paragraph"> <p>REST clients must use a storage format that Infinispan can convert to and from Java objects, currently JSON or XML.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>Storing Java objects in the cache requires you to deploy entity classes to Infinispan. See <a href="#entities_deploy">Deploying Entity Classes</a>.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Memcached clients must send and receive a serialized version of the stored POJO, which is a JBoss marshalled payload by default. However if you configure the client encoding in the appropriate Memcached connector, you change the storage format so that Memcached clients use a platform neutral format such as <code>JSON</code>.</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top" colspan="2">This configuration is compatible with&#8230;&#8203;</th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">REST clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Java Hot Rod clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Non-Java Hot Rod clients</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Querying and Indexing</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes. However, querying and indexing works with POJOs only if the entities are annotated.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Custom Java objects</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td> </tr> </tbody> </table> </div> </div> <div class="sect2"> <h3 id="entities_deploy"><a class="anchor" href="#entities_deploy"></a>8.6. Deploying Entity Classes</h3> <div class="paragraph"> <p>If you plan to store entries in the cache as custom Java objects or POJOs, you must deploy entity classes to Infinispan. Clients always exchange objects as <code>bytes[]</code>. The entity classes represent those custom objects so that Infinispan can serialize and deserialize them.</p> </div> <div class="paragraph"> <p>To make entity classes available to the server, do the following:</p> </div> <div class="ulist"> <ul> <li> <p>Create a <code>JAR</code> file that contains the entities and dependencies.</p> </li> <li> <p>Stop Infinispan if it is running.</p> <div class="paragraph"> <p>Infinispan loads entity classes during boot. You cannot make entity classes available to Infinispan if the server is running.</p> </div> </li> <li> <p>Copy the <code>JAR</code> file to the <strong><em>$INFINISPAN_HOME/standalone/deployments/</em></strong> directory.</p> </li> <li> <p>Specify the <code>JAR</code> file as a module in the cache manager configuration, as in the following example:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;modules&gt;</span>
     <span class="tag">&lt;module</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">deployment.my-entities.jar</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/modules&gt;</span>
   ...
<span class="tag">&lt;/cache-container&gt;</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="trying_the_interoperability_demo"><a class="anchor" href="#trying_the_interoperability_demo"></a>8.7. Trying the Interoperability Demo</h3> <div class="paragraph"> <p>Try the demo for protocol interoperability using the Infinispan Docker image at: <a href="https://github.com/infinispan-demos/endpoint-interop" class="bare">https://github.com/infinispan-demos/endpoint-interop</a></p> </div> </div> </div> </div> <div class="sect1"> <h2 id="marshalling"><a class="anchor" href="#marshalling"></a>9. Marshalling</h2> <div class="sectionbody"> <div class="paragraph"> <p>Marshalling is the process of converting Java POJOs into something that can be written in a format that can be transferred over the wire. Unmarshalling is the reverse process whereby data read from a wire format is transformed back into Java POJOs. Infinispan uses marshalling/unmarshalling in order to:</p> </div> <div class="ulist"> <ul> <li> <p>Transform data so that it can be send over to other Infinispan nodes in a cluster.</p> </li> <li> <p>Transform data so that it can be stored in underlying cache stores.</p> </li> <li> <p>Store data in Infinispan in a wire format to provide lazy deserialization capabilities.</p> </li> </ul> </div> <div class="sect2"> <h3 id="the_role_of_jboss_marshalling"><a class="anchor" href="#the_role_of_jboss_marshalling"></a>9.1. The Role Of JBoss Marshalling</h3> <div class="paragraph"> <p>Since performance is a very important factor in this process, Infinispan uses JBoss Marshalling framework instead of standard Java Serialization in order to marshall/unmarshall Java POJOs. Amongst other things, this framework enables Infinispan to provide highly efficient ways to marshall internal Infinispan Java POJOs that are constantly used. Apart from providing more efficient ways to marshall Java POJOs, including internal Java classes, JBoss Marshalling uses highly performant <code>java.io.ObjectOutput</code> and <code>java.io.ObjectInput</code> implementations compared to standard <code>java.io.ObjectOutputStream</code> and <code>java.io.ObjectInputStream</code>.</p> </div> </div> <div class="sect2"> <h3 id="support_for_non_serializable_objects"><a class="anchor" href="#support_for_non_serializable_objects"></a>9.2. Support For Non-Serializable Objects</h3> <div class="paragraph"> <p>From a users perspective, a very common concern is whether Infinispan supports storing non-Serializable objects. In 4.0, an Infinispan cache instance can only store non-Serializable key or value objects if, and only if:</p> </div> <div class="ulist"> <ul> <li> <p>cache is configured to be a local cache <em>and&#8230;&#8203;</em></p> </li> <li> <p>cache is not configured with lazy serialization <em>and&#8230;&#8203;</em></p> </li> <li> <p>cache is not configured with any write-behind cache store</p> </li> </ul> </div> <div class="paragraph"> <p>If either of these options is true, key/value pairs in the cache will need to be marshalled and currently they require to either to extend <code>java.io.Serializable</code> or <code>java.io.Externalizable</code>.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Since Infinispan 5.0, marshalling non-Serializable key/value objects are supported as long as users can to provide meaningful Externalizer implementations for these non-Seralizable objects. </td> </tr> </table> </div> <div class="paragraph"> <p>If you&#8217;re unable to retrofit Serializable or Externalizable into the classes whose instances are stored in Infinispan, you could alternatively use something like <a href="http://x-stream.github.io/">XStream</a> to convert your Non-Serializable objects into a String that can be stored into Infinispan. The one caveat about using XStream is that it slows down the process of storing key/value objects due to the XML transformation that it needs to do.</p> </div> <div class="sect3"> <h4 id="store_as_binary"><a class="anchor" href="#store_as_binary"></a>9.2.1. Store As Binary</h4> <div class="paragraph"> <p>Store as binary enables data to be stored in its serialized form. This can be useful to achieve lazy deserialization, which is the mechanism by which Infinispan by which serialization and deserialization of objects is deferred till the point in time in which they are used and needed. This typically means that any deserialization happens using the thread context class loader of the invocation that requires deserialization, and is an effective mechanism to provide classloader isolation. By default lazy deserialization is disabled but if you want to enable it, you can do it like this:</p> </div> <div class="ulist"> <ul> <li> <p>Via XML at the Cache level, either under <code>&lt;*-cache /&gt;</code> element:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;memory&gt;</span>
   <span class="tag">&lt;binary</span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/memory&gt;</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = ...
builder.memory().storageType(StorageType.BINARY);</code></pre> </div> </div> <div class="sect4"> <h5 id="equality_considerations"><a class="anchor" href="#equality_considerations"></a>Equality Considerations</h5> <div class="paragraph"> <p>When using lazy deserialization/storing as binary, keys and values are wrapped as <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/marshall/">WrappedBytes</a>. It is this wrapper class that transparently takes care of serialization and deserialization on demand, and internally may have a reference to the object itself being wrapped, or the serialized, byte array representation of this object.</p> </div> <div class="paragraph"> <p>This has a particular effect on the behavior of equality. The equals() method of this class will either compare binary representations (byte arrays) or delegate to the wrapped object instance&#8217;s equals() method, depending on whether both instances being compared are in serialized or deserialized form at the time of comparison. If one of the instances being compared is in one form and the other in another form, then one instance is either serialized or deserialized.</p> </div> <div class="paragraph"> <p>This will affect the way keys stored in the cache will work, when <code>storeAsBinary</code> is used, since comparisons happen on the key which will be wrapped by a MarshalledValue. Implementers of equals() methods on their keys need to be aware of the behavior of equality comparison, when a key is wrapped as a MarshalledValue, as detailed above.</p> </div> </div> <div class="sect4"> <h5 id="store_by_value_via_defensive_copying"><a class="anchor" href="#store_by_value_via_defensive_copying"></a>Store-by-value via defensive copying</h5> <div class="paragraph"> <p>The configuration <code>storeAsBinary</code> offers the possibility to enable defensive copying, which allows for store-by-value like behaviour.</p> </div> <div class="paragraph"> <p>Infinispan marshalls objects the moment they&#8217;re stored, hence changes made to object references are not stored in the cache, not even for local caches. This provides store-by-value like behaviour. Enabling <code>storeAsBinary</code> can be achieved:</p> </div> <div class="ulist"> <ul> <li> <p>Via XML at the Cache level, either under <code>&lt;*-cache /&gt;</code> or <code>&lt;default /&gt;</code> elements:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;store-as-binary</span> <span class="attribute-name">keys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">values</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = ...
builder.storeAsBinary().enable().storeKeysAsBinary(<span class="predefined-constant">true</span>).storeValuesAsBinary(<span class="predefined-constant">true</span>);</code></pre> </div> </div> </div> </div> </div> <div class="sect2"> <h3 id="advanced_configuration"><a class="anchor" href="#advanced_configuration"></a>9.3. Advanced Configuration</h3> <div class="paragraph"> <p>Internally, Infinispan uses an implementation of <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/marshall/Marshaller.html">this Marshaller interface</a> in order to marshall/unmarshall Java objects so that they&#8217;re sent other nodes in the grid, or so that they&#8217;re stored in a cache store, or even so to transform them into byte arrays for lazy deserialization.</p> </div> <div class="paragraph"> <p>By default, Infinispan uses the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/marshall/core/GlobalMarshaller.html">GlobalMarshaller</a>. Optionally, Infinispan users can provide their own marshaller, for example:</p> </div> <div class="ulist"> <ul> <li> <p>Via XML at the CacheManager level, under <code>&lt;cache-manager /&gt;</code> element:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;serialization</span> <span class="attribute-name">marshaller</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.MyMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = ...
builder.serialization().marshaller(myMarshaller); <span class="comment">// needs an instance of the marshaller</span></code></pre> </div> </div> <div class="sect3"> <h4 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>9.3.1. Troubleshooting</h4> <div class="paragraph"> <p>Sometimes it might happen that the Infinispan marshalling layer, and in particular JBoss Marshalling, might have issues marshalling/unmarshalling some user object. In Infinispan 4.0, marshalling exceptions will contain further information on the objects that were being marshalled. Example:</p> </div> <div class="listingblock"> <div class="content"> <pre>java.io.NotSerializableException: java.lang.Object
at org.jboss.marshalling.river.RiverMarshaller.doWriteObject(RiverMarshaller.java:857)
at org.jboss.marshalling.AbstractMarshaller.writeObject(AbstractMarshaller.java:407)
at org.infinispan.marshall.exts.ReplicableCommandExternalizer.writeObject(ReplicableCommandExternalizer.java:54)
at org.infinispan.marshall.jboss.ConstantObjectTable$ExternalizerAdapter.writeObject(ConstantObjectTable.java:267)
at org.jboss.marshalling.river.RiverMarshaller.doWriteObject(RiverMarshaller.java:143)
at org.jboss.marshalling.AbstractMarshaller.writeObject(AbstractMarshaller.java:407)
at org.infinispan.marshall.jboss.JBossMarshaller.objectToObjectStream(JBossMarshaller.java:167)
at org.infinispan.marshall.VersionAwareMarshaller.objectToBuffer(VersionAwareMarshaller.java:92)
at org.infinispan.marshall.VersionAwareMarshaller.objectToByteBuffer(VersionAwareMarshaller.java:170)
at org.infinispan.marshall.DefaultMarshallerTest.testNestedNonSerializable(VersionAwareMarshallerTest.java:415)
Caused by: an exception which occurred:
in object java.lang.Object@b40ec4
in object org.infinispan.commands.write.PutKeyValueCommand@df661da7
... Removed 22 stack frames</pre> </div> </div> <div class="paragraph"> <p>The way the "in object" messages are read is the same in which stacktraces are read. The highest "in object" being the most inner one and the lowest "in object" message being the most outer one. So, the above example indicates that a java.lang.Object instance contained in an instance of org.infinispan.commands.write.PutKeyValueCommand could not be serialized because java.lang.Object@b40ec4 is not serializable.</p> </div> <div class="paragraph"> <p>This is not all though! If you enable DEBUG or TRACE logging levels, marshalling exceptions will contain show the toString() representations of objects in the stacktrace. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>java.io.NotSerializableException: java.lang.Object
...
Caused by: an exception which occurred:
in object java.lang.Object@b40ec4
-&gt; toString = java.lang.Object@b40ec4
in object org.infinispan.commands.write.PutKeyValueCommand@df661da7
-&gt; toString = PutKeyValueCommand{key=k, value=java.lang.Object@b40ec4, putIfAbsent=false, lifespanMillis=0, maxIdleTimeMillis=0}</pre> </div> </div> <div class="paragraph"> <p>With regards to unmarshalling exceptions, showing such level of information it&#8217;s a lot more complicated but where possible. Infinispan will provide class type information. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>java.io.IOException: Injected failure!
at org.infinispan.marshall.DefaultMarshallerTest$1.readExternal(VersionAwareMarshallerTest.java:426)
at org.jboss.marshalling.river.RiverUnmarshaller.doReadNewObject(RiverUnmarshaller.java:1172)
at org.jboss.marshalling.river.RiverUnmarshaller.doReadObject(RiverUnmarshaller.java:273)
at org.jboss.marshalling.river.RiverUnmarshaller.doReadObject(RiverUnmarshaller.java:210)
at org.jboss.marshalling.AbstractUnmarshaller.readObject(AbstractUnmarshaller.java:85)
at org.infinispan.marshall.jboss.JBossMarshaller.objectFromObjectStream(JBossMarshaller.java:210)
at org.infinispan.marshall.VersionAwareMarshaller.objectFromByteBuffer(VersionAwareMarshaller.java:104)
at org.infinispan.marshall.VersionAwareMarshaller.objectFromByteBuffer(VersionAwareMarshaller.java:177)
at org.infinispan.marshall.DefaultMarshallerTest.testErrorUnmarshalling(VersionAwareMarshallerTest.java:431)
Caused by: an exception which occurred:
in object of type org.infinispan.marshall.DefaultMarshallerTest$1</pre> </div> </div> <div class="paragraph"> <p>In this example, an IOException was thrown when trying to unmarshall a instance of the inner class org.infinispan.marshall.DefaultMarshallerTest$1. In similar fashion to marshalling exceptions, when DEBUG or TRACE logging levels are enabled, classloader information of the class type is provided. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>java.io.IOException: Injected failure!
...
Caused by: an exception which occurred:
in object of type org.infinispan.marshall.DefaultMarshallerTest$1
-&gt; classloader hierarchy:
-&gt; type classloader = sun.misc.Launcher$AppClassLoader@198dfaf
-&gt;...file:/opt/eclipse/configuration/org.eclipse.osgi/bundles/285/1/.cp/eclipse-testng.jar
-&gt;...file:/opt/eclipse/configuration/org.eclipse.osgi/bundles/285/1/.cp/lib/testng-jdk15.jar
-&gt;...file:/home/galder/jboss/infinispan/code/trunk/core/target/test-classes/
-&gt;...file:/home/galder/jboss/infinispan/code/trunk/core/target/classes/
-&gt;...file:/home/galder/.m2/repository/org/testng/testng/5.9/testng-5.9-jdk15.jar
-&gt;...file:/home/galder/.m2/repository/net/jcip/jcip-annotations/1.0/jcip-annotations-1.0.jar
-&gt;...file:/home/galder/.m2/repository/org/easymock/easymockclassextension/2.4/easymockclassextension-2.4.jar
-&gt;...file:/home/galder/.m2/repository/org/easymock/easymock/2.4/easymock-2.4.jar
-&gt;...file:/home/galder/.m2/repository/cglib/cglib-nodep/2.1_3/cglib-nodep-2.1_3.jar
-&gt;...file:/home/galder/.m2/repository/javax/xml/bind/jaxb-api/2.1/jaxb-api-2.1.jar
-&gt;...file:/home/galder/.m2/repository/javax/xml/stream/stax-api/1.0-2/stax-api-1.0-2.jar
-&gt;...file:/home/galder/.m2/repository/javax/activation/activation/1.1/activation-1.1.jar
-&gt;...file:/home/galder/.m2/repository/jgroups/jgroups/2.8.0.CR1/jgroups-2.8.0.CR1.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/javaee/jboss-transaction-api/1.0.1.GA/jboss-transaction-api-1.0.1.GA.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/marshalling/river/1.2.0.CR4-SNAPSHOT/river-1.2.0.CR4-SNAPSHOT.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/marshalling/marshalling-api/1.2.0.CR4-SNAPSHOT/marshalling-api-1.2.0.CR4-SNAPSHOT.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/jboss-common-core/2.2.14.GA/jboss-common-core-2.2.14.GA.jar
-&gt;...file:/home/galder/.m2/repository/org/jboss/logging/jboss-logging-spi/2.0.5.GA/jboss-logging-spi-2.0.5.GA.jar
-&gt;...file:/home/galder/.m2/repository/log4j/log4j/1.2.14/log4j-1.2.14.jar
-&gt;...file:/home/galder/.m2/repository/com/thoughtworks/xstream/xstream/1.2/xstream-1.2.jar
-&gt;...file:/home/galder/.m2/repository/xpp3/xpp3_min/1.1.3.4.O/xpp3_min-1.1.3.4.O.jar
-&gt;...file:/home/galder/.m2/repository/com/sun/xml/bind/jaxb-impl/2.1.3/jaxb-impl-2.1.3.jar
-&gt; parent classloader = sun.misc.Launcher$ExtClassLoader@1858610
-&gt;...file:/usr/java/jdk1.5.0_19/jre/lib/ext/localedata.jar
-&gt;...file:/usr/java/jdk1.5.0_19/jre/lib/ext/sunpkcs11.jar
-&gt;...file:/usr/java/jdk1.5.0_19/jre/lib/ext/sunjce_provider.jar
-&gt;...file:/usr/java/jdk1.5.0_19/jre/lib/ext/dnsns.jar
... Removed 22 stack frames
&lt;/code&gt;</pre> </div> </div> <div class="paragraph"> <p>Finding the root cause of marshalling/unmarshalling exceptions can sometimes be really daunting but we hope that the above improvements would help get to the bottom of those in a more quicker and efficient manner.</p> </div> </div> </div> <div class="sect2"> <h3 id="user_defined_externalizers"><a class="anchor" href="#user_defined_externalizers"></a>9.4. User Defined Externalizers</h3> <div class="paragraph"> <p>One of the key aspects of Infinispan is that it often needs to marshall/unmarshall objects in order to provide some of its functionality. For example, if it needs to store objects in a write-through or write-behind cache store, the stored objects need marshalling. If a cluster of Infinispan nodes is formed, objects shipped around need marshalling. Even if you enable lazy deserialization, objects need to be marshalled so that they can be lazily unmarshalled with the correct classloader.</p> </div> <div class="paragraph"> <p>Using standard JDK serialization is slow and produces payloads that are too big and can affect bandwidth usage. On top of that, JDK serialization does not work well with objects that are supposed to be immutable. In order to avoid these issues, Infinispan uses <a href="http://jboss.org/jbossmarshalling">JBoss Marshalling</a> for marshalling/unmarshalling objects. JBoss Marshalling is fast, produces very space efficient payloads, and on top of that  during unmarshalling, it enables users to have full control over how to construct objects, hence allowing objects to carry on being immutable.</p> </div> <div class="paragraph"> <p>Starting with 5.0, users of Infinispan can now benefit from this marshalling framework as well, and they can provide their own externalizer implementations, but before finding out how to provide externalizers, let&#8217;s look at the benefits they bring.</p> </div> <div class="sect3"> <h4 id="benefits_of_externalizers"><a class="anchor" href="#benefits_of_externalizers"></a>9.4.1. Benefits of Externalizers</h4> <div class="paragraph"> <p>The JDK provides a simple way to serialize objects which, in its simplest form, is just a matter of extending <a href="https://docs.oracle.com/javase/8/docs/api/java/io/Serializable.html">java.io.Serializable</a> , but as it&#8217;s well known, this is known to be slow and it generates payloads that are far too big. An alternative way to do serialization, still relying on JDK serialization, is for your objects to extend <a href="https://docs.oracle.com/javase/8/docs/api/java/io/Externalizable.html">java.io.Externalizable</a> . This allows for users to provide their own ways to marshall/unmarshall classes, but has some serious issues because, on top of relying on slow JDK serialization, it forces the class that you want to serialize to extend this interface, which has two side effects: The first is that you&#8217;re forced to modify the source code of the class that you want to marshall/unmarshall which you might not be able to do because you either, don&#8217;t own the source, or you don&#8217;t even have it. Secondly, since Externalizable implementations do not control object creation, you&#8217;re forced to add set methods in order to restore the state, hence potentially forcing your immutable objects to become mutable.</p> </div> <div class="paragraph"> <p>Instead of relying on JDK serialization, Infinispan uses JBoss Marshalling to serialize objects and requires any classes to be serialized to be associated with an <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/marshall/Externalizer.html">Externalizer</a> interface implementation that knows how to transform an object of a particular class into a serialized form and how to read an object of that class from a given input. Infinispan does not force the objects to be serialized to implement Externalizer. In fact, it is recommended that a separate class is used to implement the Externalizer interface because, contrary to JDK serialization, Externalizer implementations control how objects of a particular class are created when trying to read an object from a stream. This means that readObject() implementations are responsible of creating object instances of the target class, hence giving users a lot of flexibility on how to create these instances (whether direct instantiation, via factory or reflection), and more importantly, allows target classes to carry on being immutable. This type of externalizer architecture promotes good OOP designs principles, such as the principle of <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">single responsibility</a> .</p> </div> <div class="paragraph"> <p>It&#8217;s quite common, and in general recommended, that Externalizer implementations are stored as inner static public classes within classes that they externalize. The advantages of doing this is that related code stays together, making it easier to maintain. In Infinispan, there are two ways in which Infinispan can be plugged with user defined externalizers:</p> </div> </div> <div class="sect3"> <h4 id="user_friendly_externalizers"><a class="anchor" href="#user_friendly_externalizers"></a>9.4.2. User Friendly Externalizers</h4> <div class="paragraph"> <p>In the simplest possible form, users just need to provide an <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/marshall/Externalizer.html">Externalizer</a> implementation for the type that they want to marshall/unmarshall, and then annotate the marshalled type class with {@link SerializeWith} annotation indicating the externalizer class to use. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.Externalizer</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.SerializeWith</span>;

<span class="annotation">@SerializeWith</span>(Person.PersonExternalizer.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Person</span> {

<span class="error"> </span><span class="error"> </span> <span class="directive">final</span> <span class="predefined-type">String</span> name;
<span class="error"> </span><span class="error"> </span> <span class="directive">final</span> <span class="type">int</span> age;

<span class="error"> </span><span class="error"> </span> <span class="directive">public</span> Person(<span class="predefined-type">String</span> name, <span class="type">int</span> age) {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="local-variable">this</span>.name = name;
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="local-variable">this</span>.age = age;
<span class="error"> </span><span class="error"> </span> }

<span class="error"> </span><span class="error"> </span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">PersonExternalizer</span> <span class="directive">implements</span> Externalizer&lt;Person&gt; {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="annotation">@Override</span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, Person person)
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="directive">throws</span> <span class="exception">IOException</span> {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> output.writeObject(person.name);
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> output.writeInt(person.age);
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> }

<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="annotation">@Override</span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="directive">public</span> Person readObject(<span class="predefined-type">ObjectInput</span> input)
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="keyword">return</span> <span class="keyword">new</span> Person((<span class="predefined-type">String</span>) input.readObject(), input.readInt());
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> }
<span class="error"> </span><span class="error"> </span> }
}</code></pre> </div> </div> <div class="paragraph"> <p>At runtime JBoss Marshalling will inspect the object and discover that it is marshallable (thanks to the annotation) and so marshall it using the externalizer class passed. To make externalizer implementations easier to code and more typesafe, make sure you define type <code>&lt;T&gt;</code> as the type of object that&#8217;s being marshalled/unmarshalled.</p> </div> <div class="paragraph"> <p>Even though this way of defining externalizers is very user friendly, it has some disadvantages:</p> </div> <div class="ulist"> <ul> <li> <p>Due to several constraints of the model, such as support for different versions of the same class or the need to marshall the Externalizer class, the payload sizes generated via this method are not the most efficient.</p> </li> <li> <p>This model requires that the marshalled class be annotated with link:https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/marshall/SerializeWith.html but a user might need to provide an Externalizer for a class for which source code is not available, or for any other constraints, it cannot be modified.</p> </li> <li> <p>The use of annotations by this model might be limiting for framework developers or service providers that try to abstract lower level details, such as the marshalling layer, away from the user.</p> </li> </ul> </div> <div class="paragraph"> <p>If you&#8217;re affected by any of these disadvantages, an alternative method to provide externalizers is available via more advanced externalizers:</p> </div> </div> <div class="sect3"> <h4 id="advanced_externalizers"><a class="anchor" href="#advanced_externalizers"></a>9.4.3. Advanced Externalizers</h4> <div class="paragraph"> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/marshall/AdvancedExternalizer.html">AdvancedExternalizer</a> provides an alternative way to provide externalizers for marshalling/unmarshalling user defined classes that overcome the deficiencies of the more user-friendly externalizer definition model explained in Externalizer. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.marshall.AdvancedExternalizer</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Person</span> {

<span class="error"> </span><span class="error"> </span> <span class="directive">final</span> <span class="predefined-type">String</span> name;
<span class="error"> </span><span class="error"> </span> <span class="directive">final</span> <span class="type">int</span> age;

<span class="error"> </span><span class="error"> </span> <span class="directive">public</span> Person(<span class="predefined-type">String</span> name, <span class="type">int</span> age) {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="local-variable">this</span>.name = name;
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="local-variable">this</span>.age = age;
<span class="error"> </span><span class="error"> </span> }

<span class="error"> </span><span class="error"> </span> <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">PersonExternalizer</span> <span class="directive">implements</span> AdvancedExternalizer&lt;Person&gt; {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="annotation">@Override</span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, Person person)
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="directive">throws</span> <span class="exception">IOException</span> {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> output.writeObject(person.name);
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> output.writeInt(person.age);
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> }

<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="annotation">@Override</span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="directive">public</span> Person readObject(<span class="predefined-type">ObjectInput</span> input)
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="keyword">return</span> <span class="keyword">new</span> Person((<span class="predefined-type">String</span>) input.readObject(), input.readInt());
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> }

<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="annotation">@Override</span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> Person&gt;&gt; getTypeClasses() {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="keyword">return</span> <span class="predefined-type">Util</span>.&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> Person&gt;&gt;asSet(Person.class);
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> }

<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="annotation">@Override</span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="directive">public</span> <span class="predefined-type">Integer</span> getId() {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="keyword">return</span> <span class="integer">2345</span>;
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> }
<span class="error"> </span><span class="error"> </span> }
}</code></pre> </div> </div> <div class="paragraph"> <p>The first noticeable difference is that this method does not require user classes to be annotated in anyway, so it can be used with classes for which source code is not available or that cannot be modified. The bound between the externalizer and the classes that are marshalled/unmarshalled is set by providing an implementation for <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/marshall/AdvancedExternalizer.html#getTypeClasses--">getTypeClasses()</a> which should return the list of classes that this externalizer can marshall:</p> </div> <div class="sect4"> <h5 id="linking_externalizers_with_marshaller_classes"><a class="anchor" href="#linking_externalizers_with_marshaller_classes"></a>Linking Externalizers with Marshaller Classes</h5> <div class="paragraph"> <p>Once the Externalizer&#8217;s <code>readObject()</code> and <code>writeObject()</code> methods have been implemented, it&#8217;s time to link them up together with the type classes that they externalize. To do so, the Externalizer implementation must provide a <code>getTypeClasses()</code> implementation. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.commons.util.Util</span>;
...
<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> ReplicableCommand&gt;&gt; getTypeClasses() {
<span class="error"> </span> <span class="keyword">return</span> <span class="predefined-type">Util</span>.asSet(LockControlCommand.class, RehashControlCommand.class,
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> StateTransferControlCommand.class, GetKeyValueCommand.class,
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> ClusteredGetCommand.class,
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> SingleRpcCommand.class, CommitCommand.class,
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> PrepareCommand.class, RollbackCommand.class,
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> ClearCommand.class, EvictCommand.class,
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> InvalidateCommand.class, InvalidateL1Command.class,
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> PutKeyValueCommand.class, PutMapCommand.class,
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> RemoveCommand.class, ReplaceCommand.class);
}</code></pre> </div> </div> <div class="paragraph"> <p>In the code above, ReplicableCommandExternalizer indicates that it can externalize several type of commands. In fact, it marshalls all commands that extend ReplicableCommand interface, but currently the framework only supports class equality comparison and so, it&#8217;s not possible to indicate that the classes to marshalled are all children of a particular class/interface.</p> </div> <div class="paragraph"> <p>However there might sometimes when the classes to be externalized are private and hence it&#8217;s not possible to reference the actual class instance. In this situation, users can attempt to look up the class with the given fully qualified class name and pass that back. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">List</span>&gt;&gt; getTypeClasses() {
<span class="error"> </span> <span class="keyword">return</span> <span class="predefined-type">Util</span>.&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">List</span>&gt;&gt;asSet(
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="predefined-type">Util</span>.loadClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">java.util.Collections$SingletonList</span><span class="delimiter">&quot;</span></span>));
}</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="externalizer_identifier"><a class="anchor" href="#externalizer_identifier"></a>Externalizer Identifier</h5> <div class="paragraph"> <p>Secondly, in order to save the maximum amount of space possible in the payloads generated, advanced externalizers require externalizer implementations to provide a positive identified via <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/marshall/AdvancedExternalizer.html#getId--">getId()</a> implementations or via XML/programmatic configuration that identifies the externalizer when unmarshalling a payload.  In order for this to work however, advanced externalizers require externalizers to be registered on cache manager creation time via XML or programmatic configuration which will be explained in next section. On the contrary, externalizers based on Externalizer and SerializeWith require no pre-registration whatsoever. Internally, Infinispan uses this advanced externalizer mechanism in order to marshall/unmarshall internal classes.</p> </div> <div class="paragraph"> <p>So, <code>getId()</code> should return a positive integer that allows the externalizer to be identified at read time to figure out which Externalizer should read the contents of the incoming buffer, or it can return null. If getId() returns null, it is indicating that the id of this advanced externalizer will be defined via XML/programmatic configuration, which will be explained in next section.</p> </div> <div class="paragraph"> <p>Regardless of the source of the the id, using a positive integer allows for very efficient variable length encoding of numbers, and it&#8217;s much more efficient than shipping externalizer implementation class information or class name around. Infinispan users can use any positive integer as long as it does not clash with any other identifier in the system. It&#8217;s important to understand that a user defined externalizer can even use the same numbers as the externalizers in the Infinispan Core project because the internal Infinispan Core externalizers are special and they use a different number space to the user defined externalizers. On the contrary, users should avoid using numbers that are within the pre-assigned identifier ranges which can be found at the end of this article. Infinispan checks for id duplicates on startup, and if any are found, startup is halted with an error.</p> </div> <div class="paragraph"> <p>When it comes to maintaining which ids are in use, it&#8217;s highly recommended that this is done in a centralized way. For example, getId() implementations could reference a set of statically defined identifiers in a separate class or interface. Such class/interface would give a global view of the identifiers in use and so can make it easier to assign new ids.</p> </div> </div> <div class="sect4"> <h5 id="registering_advanced_externalizers"><a class="anchor" href="#registering_advanced_externalizers"></a>Registering Advanced Externalizers</h5> <div class="paragraph"> <p>The following example shows the type of configuration required to register an advanced externalizer implementation for Person object shown earlier stored as a static inner class within it:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;cache-container&gt;</span>
    <span class="tag">&lt;serialization&gt;</span>
      <span class="tag">&lt;advanced-externalizer</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Person$PersonExternalizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/serialization&gt;</span>
  <span class="tag">&lt;/cache-container&gt;</span>
  ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = ...
builder.serialization()
<span class="error"> </span><span class="error"> </span> .addAdvancedExternalizer(<span class="keyword">new</span> Person.PersonExternalizer());</code></pre> </div> </div> <div class="paragraph"> <p>As mentioned earlier, when listing these externalizer implementations, users can optionally provide the identifier of the externalizer via XML or programmatically instead of via getId() implementation. Again, this offers a centralized way to maintain the identifiers but it&#8217;s important that the rules are clear: An AdvancedExternalizer implementation, either via XML/programmatic configuration or via annotation, needs to be associated with an identifier. If it isn&#8217;t, Infinispan will throw an error and abort startup. If a particular AdvancedExternalizer implementation defines an id both via XML/programmatic configuration and annotation, the value defined via XML/programmatically is the one that will be used. Here&#8217;s an example of an externalizer whose id is defined at registration time:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;cache-container&gt;</span>
    <span class="tag">&lt;serialization&gt;</span>
      <span class="tag">&lt;advanced-externalizer</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Person$PersonExternalizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/serialization&gt;</span>
  <span class="tag">&lt;/cache-container&gt;</span>
  ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = ...
builder.serialization()
<span class="error"> </span><span class="error"> </span> .addAdvancedExternalizer(<span class="integer">123</span>, <span class="keyword">new</span> Person.PersonExternalizer());</code></pre> </div> </div> <div class="paragraph"> <p>Finally, a couple of notes about the programmatic configuration. <code>GlobalConfiguration.addExternalizer()</code> takes <code>varargs</code>, so it means that it is possible to register multiple externalizers in just one go, assuming that their ids have already been defined via <code>@Marshalls</code> annotation. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">builder.serialization()
<span class="error"> </span><span class="error"> </span> .addAdvancedExternalizer(<span class="keyword">new</span> Person.PersonExternalizer(),
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="keyword">new</span> Address.AddressExternalizer());</code></pre> </div> </div> </div> <div class="sect4"> <h5 id="preassigned_externalizer_id_ranges"><a class="anchor" href="#preassigned_externalizer_id_ranges"></a>Preassigned Externalizer Id Ranges</h5> <div class="paragraph"> <p>This is the list of Externalizer identifiers that are used by Infinispan based modules or frameworks. Infinispan users should avoid using ids within these ranges.</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 50%;"> <col style="width: 50%;"> </colgroup> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Tree Module:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1000 - 1099</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Server Modules:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1100 - 1199</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Infinispan Second Level Cache:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1200 - 1299</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Lucene Directory:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1300 - 1399</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate OGM:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1400 - 1499</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Search:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1500 - 1599</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Query Module:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1600 - 1699</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Remote Query Module:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1700 - 1799</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Scripting Module:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1800 - 1849</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Server Event Logger Module:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1850 - 1899</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Remote Store:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1900 - 1999</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Counters:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">2000 - 2049</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Multimap:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">2050 - 2099</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Locks:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">2100 - 2149</p></td> </tr> </tbody> </table> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="grid_file"><a class="anchor" href="#grid_file"></a>10. Grid File System</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan&#8217;s GridFileSystem is an experimental API that exposes an Infinispan-backed data grid as a file system.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> This is a deprecated API that will be removed in a future version. </td> </tr> </table> </div> <div class="paragraph"> <p>Specifically, the API works as an extension to the JDK&#8217;s <a href="https://docs.oracle.com/javase/8/docs/api/java/io/File.html">File</a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/io/InputStream.html">InputStream</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/io/OutputStream.html">OutputStream</a> classes: specifically, <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/io/GridFile.html">GridFile</a>, <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/io/GridInputStream.html">GridInputStream</a> and <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/io/GridOutputStream.html">GridOutputStream</a>. A helper class, <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/io/GridFilesystem.html">GridFilesystem</a>, is also included.</p> </div> <div class="paragraph"> <p>Essentially, the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/io/GridFilesystem.html">GridFilesystem</a> is backed by 2 Infinispan caches - one for metadata (typically replicated) and one for the actual data (typically distributed). The former is replicated so that each node has metadata information locally and would not need to make RPC calls to list files, etc. The latter is distributed since this is where the bulk of storage space is used up, and a scalable mechanism is needed here. Files themselves are chunked and each chunk is stored as a cache entry, as a byte array.</p> </div> <div class="paragraph"> <p>Here is a quick code snippet demonstrating usage:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>,<span class="type">byte</span><span class="type">[]</span>&gt; data = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">distributed</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">String</span>,GridFile.Metadata&gt; metadata = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">replicated</span><span class="delimiter">&quot;</span></span>);
GridFilesystem fs = <span class="keyword">new</span> GridFilesystem(data, metadata);

<span class="comment">// Create directories</span>
<span class="predefined-type">File</span> file=fs.getFile(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/testfile/stuff</span><span class="delimiter">&quot;</span></span>);
fs.mkdirs(); <span class="comment">// creates directories /tmp/testfile/stuff</span>

<span class="comment">// List all files and directories under &quot;/usr/local&quot;</span>
file=fs.getFile(<span class="string"><span class="delimiter">&quot;</span><span class="content">/usr/local</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">File</span><span class="type">[]</span> files=file.listFiles();

<span class="comment">// Create a new file</span>
file=fs.getFile(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/testfile/stuff/README.txt</span><span class="delimiter">&quot;</span></span>);
file.createNewFile();</code></pre> </div> </div> <div class="paragraph"> <p>Copying stuff to the grid file system:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">InputStream</span> in=<span class="keyword">new</span> <span class="predefined-type">FileInputStream</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/my-movies/dvd-image.iso</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">OutputStream</span> out=fs.getOutput(<span class="string"><span class="delimiter">&quot;</span><span class="content">/grid-movies/dvd-image.iso</span><span class="delimiter">&quot;</span></span>);
<span class="type">byte</span><span class="type">[]</span> buffer=<span class="keyword">new</span> <span class="type">byte</span>[<span class="integer">20000</span>];
<span class="type">int</span> len;
<span class="keyword">while</span>((len=in.read(buffer, <span class="integer">0</span>, buffer.length)) != -<span class="integer">1</span>) out.write(buffer, <span class="integer">0</span>, len);
in.close();
out.close();</code></pre> </div> </div> <div class="paragraph"> <p>Reading stuff from the grid:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">InputStream</span> in=in.getInput(<span class="string"><span class="delimiter">&quot;</span><span class="content">/grid-movies/dvd-image.iso</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">OutputStream</span> out=<span class="keyword">new</span> <span class="predefined-type">FileOutputStream</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/my-movies/dvd-image.iso</span><span class="delimiter">&quot;</span></span>);
<span class="type">byte</span><span class="type">[]</span> buffer=<span class="keyword">new</span> <span class="type">byte</span>[<span class="integer">200000</span>];
<span class="type">int</span> len;
<span class="keyword">while</span>((len=in.read(buffer, <span class="integer">0</span>, buffer.length)) != -<span class="integer">1</span>) out.write(buffer, <span class="integer">0</span>, len);
in.close();
out.close();</code></pre> </div> </div> <div class="sect2"> <h3 id="webdav_demo"><a class="anchor" href="#webdav_demo"></a>10.1. WebDAV demo</h3> <div class="paragraph"> <p>Infinispan ships with a demo <a href="http://en.wikipedia.org/wiki/WebDAV">WebDAV</a> application that makes use of the grid file system APIs. This demo app is packaged as a <a href="http://en.wikipedia.org/wiki/WAR_(Sun_file_format)">WAR</a> file which can be deployed in a servlet container, such as JBoss AS or Tomcat, and exposes the grid as a file system over WebDAV. This could then be mounted as a remote drive on your operating system.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="cdi_support"><a class="anchor" href="#cdi_support"></a>11. CDI Support</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan includes integration with <a href="http://www.cdi-spec.org">Contexts and Dependency Injection (better known as CDI)</a> via Infinispan&#8217;s <code>infinispan-cdi-embedded</code> or <code>infinispan-cdi-remote</code> module. CDI is part of <a href="http://www.oracle.com/technetwork/java/javaee/tech/index-jsp-142185.html">Java EE specification</a> and aims for managing beans' lifecycle inside the container. The integration allows to inject Cache interface and bridge Cache and CacheManager events. JCache annotations (JSR-107) are supported by <code>infinispan-jcache</code> and <code>infinispan-jcache-remote</code> artifacts. For more information have a look at <a href="http://download.oracle.com/otndocs/jcp/jcache-1_0-fr-spec/index.html">Chapter 11</a> of the JCACHE specification.</p> </div> <div class="sect2"> <h3 id="maven_dependencies"><a class="anchor" href="#maven_dependencies"></a>11.1. Maven Dependencies</h3> <div class="paragraph"> <p>To include CDI support for Infinispan in your project, use one of the following dependencies:</p> </div> <div class="paragraph"> <div class="title">pom.xml for Embedded mode</div> <p>&lt;dependency&gt; &lt;groupId&gt;org.infinispan&lt;/groupId&gt; &lt;artifactId&gt;infinispan-cdi-embedded&lt;/artifactId&gt; &lt;!-- Replace ${version.infinispan} with the version of Infinispan that you&#8217;re using. -&#8594; &lt;version&gt;${version.infinispan}&lt;/version&gt; &lt;/dependency&gt;</p> </div> <div class="paragraph"> <div class="title">pom.xml for Remote mode</div> <p>&lt;dependency&gt; &lt;groupId&gt;org.infinispan&lt;/groupId&gt; &lt;artifactId&gt;infinispan-cdi-remote&lt;/artifactId&gt; &lt;!-- Replace ${version.infinispan} with the version of Infinispan that you&#8217;re using. -&#8594; &lt;version&gt;${version.infinispan}&lt;/version&gt; &lt;/dependency&gt;</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Which version of Infinispan should I use?</div> We recommend using the latest final version Infinispan. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="embedded_cache_integration"><a class="anchor" href="#embedded_cache_integration"></a>11.2. Embedded cache integration</h3> <div class="sect3"> <h4 id="inject_an_embedded_cache"><a class="anchor" href="#inject_an_embedded_cache"></a>11.2.1. Inject an embedded cache</h4> <div class="paragraph"> <p>By default you can inject the default Infinispan cache. Let&#8217;s look at the following example:</p> </div> <div class="listingblock"> <div class="title">Default cache injection</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">...
import javax.inject.Inject;

<span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="annotation">@Inject</span>
    <span class="directive">private</span> Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;

    <span class="directive">public</span> <span class="predefined-type">String</span> greet(<span class="predefined-type">String</span> user) {
        <span class="predefined-type">String</span> cachedValue = cache.get(user);
        <span class="keyword">if</span> (cachedValue == <span class="predefined-constant">null</span>) {
            cachedValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + user;
            cache.put(user, cachedValue);
        }
        <span class="keyword">return</span> cachedValue;
    }
}</code></pre> </div> </div> <div class="paragraph"> <p>If you want to use a specific cache rather than the default one, you just have to provide your own cache configuration and cache qualifier. See example below:</p> </div> <div class="listingblock"> <div class="title">Qualifier example</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">...
import javax.inject.Qualifier;

<span class="annotation">@Qualifier</span>
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.FIELD, <span class="predefined-type">ElementType</span>.PARAMETER, <span class="predefined-type">ElementType</span>.METHOD})
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Documented</span>
<span class="directive">public</span> <span class="annotation">@interface</span> GreetingCache {
}</code></pre> </div> </div> <div class="listingblock"> <div class="title">Injecting Cache with qualifier</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">...
import org.infinispan.configuration.cache.Configuration;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.cdi.ConfigureCache</span>;
<span class="keyword">import</span> <span class="include">javax.enterprise.inject.Produces</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

    <span class="annotation">@ConfigureCache</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>) <span class="comment">// This is the cache name.</span>
    <span class="annotation">@GreetingCache</span> <span class="comment">// This is the cache qualifier.</span>
    <span class="annotation">@Produces</span>
    <span class="directive">public</span> <span class="predefined-type">Configuration</span> greetingCacheConfiguration() {
        <span class="keyword">return</span> <span class="keyword">new</span> ConfigurationBuilder()
                    .memory()
                        .size(<span class="integer">1000</span>)
                    .build();
    }

    <span class="comment">// The same example without providing a custom configuration.</span>
    <span class="comment">// In this case the default cache configuration will be used.</span>
    <span class="annotation">@ConfigureCache</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GreetingCache</span>
    <span class="annotation">@Produces</span>
    <span class="directive">public</span> <span class="predefined-type">Configuration</span> greetingCacheConfiguration;
}</code></pre> </div> </div> <div class="paragraph"> <p>To use this cache in the GreetingService add the <code>@GeetingCache</code> qualifier on your cache injection point.</p> </div> </div> <div class="sect3"> <h4 id="override_the_default_embedded_cache_manager_and_configuration"><a class="anchor" href="#override_the_default_embedded_cache_manager_and_configuration"></a>11.2.2. Override the default embedded cache manager and configuration</h4> <div class="paragraph"> <p>You can override the default cache configuration used by the default <code>EmbeddedCacheManager</code>. For that, you just have to create a <code>Configuration</code> producer with default qualifiers as illustrated in the following snippet:</p> </div> <div class="listingblock"> <div class="title">Overriding Configuration</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

    <span class="comment">// By default CDI adds the @Default qualifier if no other qualifier is provided.</span>
    <span class="annotation">@Produces</span>
    <span class="directive">public</span> <span class="predefined-type">Configuration</span> defaultEmbeddedCacheConfiguration() {
        <span class="keyword">return</span> <span class="keyword">new</span> ConfigurationBuilder()
                    .memory()
                        .size(<span class="integer">100</span>)
                    .build();
    }
}</code></pre> </div> </div> <div class="paragraph"> <p>It&#8217;s also possible to override the default <code>EmbeddedCacheManager</code>. The newly created manager must have default qualifiers and Application scope.</p> </div> <div class="listingblock"> <div class="title">Overriding EmbeddedCacheManager</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">...
import javax.enterprise.context.ApplicationScoped;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

    <span class="annotation">@Produces</span>
    <span class="annotation">@ApplicationScoped</span>
    <span class="directive">public</span> EmbeddedCacheManager defaultEmbeddedCacheManager() {
      <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager(<span class="keyword">new</span> ConfigurationBuilder()
                                          .memory()
                                              .size(<span class="integer">100</span>)
                                          .build());
   }
}</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="configure_the_transport_for_clustered_use"><a class="anchor" href="#configure_the_transport_for_clustered_use"></a>11.2.3. Configure the transport for clustered use</h4> <div class="paragraph"> <p>To use Infinispan in a clustered mode you have to configure the transport with the <code>GlobalConfiguration</code>. To achieve that override the default cache manager as explained in the previous section. Look at the following snippet:</p> </div> <div class="listingblock"> <div class="title">Overriding default EmbeddedCacheManager</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">...
package org.infinispan.configuration.global.GlobalConfigurationBuilder;

<span class="annotation">@Produces</span>
<span class="annotation">@ApplicationScoped</span>
<span class="directive">public</span> EmbeddedCacheManager defaultClusteredCacheManager() {
    <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager(
        <span class="keyword">new</span> GlobalConfigurationBuilder().transport().defaultTransport().build(),
        <span class="keyword">new</span> ConfigurationBuilder().memory().size(<span class="integer">7</span>).build()
    );
}</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="remote_cache_integration"><a class="anchor" href="#remote_cache_integration"></a>11.3. Remote cache integration</h3> <div class="sect3"> <h4 id="inject_a_remote_cache"><a class="anchor" href="#inject_a_remote_cache"></a>11.3.1. Inject a remote cache</h4> <div class="paragraph"> <p>With the CDI integration it&#8217;s also possible to use a <code>RemoteCache</code> as illustrated in the following snippet:</p> </div> <div class="listingblock"> <div class="title">Injecting RemoteCache</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="annotation">@Inject</span>
    <span class="directive">private</span> RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;

    <span class="directive">public</span> <span class="predefined-type">String</span> greet(<span class="predefined-type">String</span> user) {
        <span class="predefined-type">String</span> cachedValue = cache.get(user);
        <span class="keyword">if</span> (cachedValue == <span class="predefined-constant">null</span>) {
            cachedValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + user;
            cache.put(user, cachedValue);
        }
        <span class="keyword">return</span> cachedValue;
    }
}</code></pre> </div> </div> <div class="paragraph"> <p>If you want to use another cache, for example the greeting-cache, add the <code>@Remote</code> qualifier on the cache injection point which contains the cache name.</p> </div> <div class="listingblock"> <div class="title">Injecting RemoteCache with qualifier</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="annotation">@Inject</span>
    <span class="annotation">@Remote</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;

    ...
}</code></pre> </div> </div> <div class="paragraph"> <p>Adding the <code>@Remote</code> cache qualifier on each injection point might be error prone. That&#8217;s why the remote cache integration provides another way to achieve the same goal. For that you have to create your own qualifier annotated with <code>@Remote</code>:</p> </div> <div class="listingblock"> <div class="title">RemoteCache qualifier</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Remote</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Qualifier</span>
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.FIELD, <span class="predefined-type">ElementType</span>.PARAMETER, <span class="predefined-type">ElementType</span>.METHOD})
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Documented</span>
<span class="directive">public</span> <span class="annotation">@interface</span> RemoteGreetingCache {
}</code></pre> </div> </div> <div class="paragraph"> <p>To use this cache in the GreetingService add the qualifier <code>@RemoteGreetingCache</code> qualifier on your cache injection.</p> </div> </div> <div class="sect3"> <h4 id="override_the_default_remote_cache_manager"><a class="anchor" href="#override_the_default_remote_cache_manager"></a>11.3.2. Override the default remote cache manager</h4> <div class="paragraph"> <p>Like the embedded cache integration, the remote cache integration comes with a default remote cache manager producer. This default <code>RemoteCacheManager</code> can be overridden as illustrated in the following snippet:</p> </div> <div class="listingblock"> <div class="title">Overriding default RemoteCacheManager</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

    <span class="annotation">@Produces</span>
    <span class="annotation">@ApplicationScoped</span>
    <span class="directive">public</span> RemoteCacheManager defaultRemoteCacheManager() {
        <span class="keyword">return</span> <span class="keyword">new</span> RemoteCacheManager(localhost, <span class="integer">1544</span>);
    }
}</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="use_a_custom_remoteembedded_cache_manager_for_one_or_more_cache"><a class="anchor" href="#use_a_custom_remoteembedded_cache_manager_for_one_or_more_cache"></a>11.4. Use a custom remote/embedded cache manager for one or more cache</h3> <div class="paragraph"> <p>It&#8217;s possible to use a custom cache manager for one or more cache. You just need to annotate the cache manager producer with the cache qualifiers. Look at the following example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

   <span class="annotation">@GreetingCache</span>
   <span class="annotation">@Produces</span>
   <span class="annotation">@ApplicationScoped</span>
   <span class="directive">public</span> EmbeddedCacheManager specificEmbeddedCacheManager() {
      <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager(<span class="keyword">new</span> ConfigurationBuilder()
                                          .expiration()
                                              .lifespan(<span class="integer">60000l</span>)
                                          .build());
   }

   <span class="annotation">@RemoteGreetingCache</span>
   <span class="annotation">@Produces</span>
   <span class="annotation">@ApplicationScoped</span>
   <span class="directive">public</span> RemoteCacheManager specificRemoteCacheManager() {
       <span class="keyword">return</span> <span class="keyword">new</span> RemoteCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>, <span class="integer">1544</span>);
   }
}</code></pre> </div> </div> <div class="paragraph"> <p>With the above code the GreetingCache or the RemoteGreetingCache will be associated with the produced cache manager.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Producer method scope</div> To work properly the producers must have the scope @ApplicationScoped . Otherwise each injection of cache will be associated to a new instance of cache manager. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="use_jcache_caching_annotations"><a class="anchor" href="#use_jcache_caching_annotations"></a>11.5. Use JCache caching annotations</h3> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> There is now a separate module for JSR 107 (JCACHE) integration, including API. </td> </tr> </table> </div> <div class="paragraph"> <p>When CDI integration and JCache artifacts are present on the classpath, it is possible to use JCache annotations with CDI managed beans. These annotations provide a simple way to handle common use cases. The following caching annotations are defined in this specification:</p> </div> <div class="ulist"> <ul> <li> <p><code>@CacheResult</code> - caches the result of a method call</p> </li> <li> <p><code>@CachePut</code> - caches a method parameter</p> </li> <li> <p><code>@CacheRemoveEntry</code> - removes an entry from a cache</p> </li> <li> <p><code>@CacheRemoveAll</code> - removes all entries from a cache</p> </li> </ul> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> <div class="title">Annotations target type</div> These annotations must only be used on methods. </td> </tr> </table> </div> <div class="paragraph"> <p>To use these annotations, proper interceptors need to be declared in <code>beans.xml</code> file:</p> </div> <div class="listingblock"> <div class="title">Interceptors for managed environments such as Application Servers</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/beans_1_1.xsd</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">bean-discovery-mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">annotated</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;interceptors&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCacheResultInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCachePutInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCacheRemoveEntryInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCacheRemoveAllInterceptor<span class="tag">&lt;/class&gt;</span>
  <span class="tag">&lt;/interceptors&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre> </div> </div> <div class="listingblock"> <div class="title">Interceptors for unmanaged environments such as standalone applications</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/beans_1_1.xsd</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">bean-discovery-mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">annotated</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;interceptors&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.CacheResultInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.CachePutInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.CacheRemoveEntryInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.CacheRemoveAllInterceptor<span class="tag">&lt;/class&gt;</span>
  <span class="tag">&lt;/interceptors&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>The following snippet of code illustrates the use of <code>@CacheResult</code> annotation. As you can see it simplifies the caching of the <code>Greetingservice#greet</code> method results.</p> </div> <div class="listingblock"> <div class="title">Using JCache annotations</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache.interceptor.CacheResult</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="annotation">@CacheResult</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> greet(<span class="predefined-type">String</span> user) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello</span><span class="delimiter">&quot;</span></span> + user;
    }
}</code></pre> </div> </div> <div class="paragraph"> <p>The first version of the <code>GreetingService</code> and the above version have exactly the same behavior. The only difference is the cache used. By default it&#8217;s the fully qualified name of the annotated method with its parameter types (e.g. <code>org.infinispan.example.GreetingService.greet(java.lang.String)</code>).</p> </div> <div class="paragraph"> <p>Using other cache than default is rather simple. All you need to do is to specify its name with the <code>cacheName</code> attribute of the cache annotation. For example:</p> </div> <div class="listingblock"> <div class="title">Specifying cache name for JCache</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@CacheResult</span>(cacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="use_cache_events_and_cdi"><a class="anchor" href="#use_cache_events_and_cdi"></a>11.6. Use Cache events and CDI</h3> <div class="paragraph"> <p>It is possible to receive Cache and Cache Manager level events using CDI Events. You can achieve it using <code>@Observes</code> annotation as shown in the following snippet:</p> </div> <div class="listingblock"> <div class="title">Event listeners based on CDI</div> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.enterprise.event.Observes</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachemanagerlistener.event.CacheStartedEvent</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.event</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="comment">// Cache level events</span>
    <span class="directive">private</span> <span class="type">void</span> entryRemovedFromCache(<span class="annotation">@Observes</span> CacheEntryCreatedEvent event) {
        ...
    }

    <span class="comment">// Cache Manager level events</span>
    <span class="directive">private</span> <span class="type">void</span> cacheStarted(<span class="annotation">@Observes</span> CacheStartedEvent event) {
        ...
    }
}</code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="jcache_jsr_107"><a class="anchor" href="#jcache_jsr_107"></a>12. JCache (JSR-107) provider</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan provides an implementation of JCache 1.0 API ( <a href="http://www.jcp.org/en/jsr/detail?id=107">JSR-107</a> ). JCache specifies a standard Java API for caching temporary Java objects in memory. Caching java objects can help get around bottlenecks arising from using data that is expensive to retrieve (i.e. DB or web service), or data that is hard to calculate. Caching these type of objects in memory can help speed up application performance by retrieving the data directly from memory instead of doing an expensive roundtrip or recalculation. This document specifies how to use JCache with Infinispan&#8217;s implementation of the specification, and explains key aspects of the API.</p> </div> <div class="sect2"> <h3 id="dependencies"><a class="anchor" href="#dependencies"></a>12.1. Dependencies</h3> <div class="paragraph"> <p>In order to start using Infinispan JCache implementation, a single dependency needs to be added to the Maven pom.xml file:</p> </div> <div class="listingblock"> <div class="title">pom.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-jcache<span class="tag">&lt;/artifactId&gt;</span>
  <span class="comment">&lt;!-- Replace ${version.infinispan} with the
  version of Infinispan that you're using. --&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="create_a_local_cache"><a class="anchor" href="#create_a_local_cache"></a>12.2. Create a local cache</h3> <div class="paragraph"> <p>Creating a local cache, using default configuration options as defined by the JCache API specification, is as simple as doing the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

<span class="comment">// Retrieve the system wide cache manager</span>
CacheManager cacheManager = Caching.getCachingProvider().getCacheManager();
<span class="comment">// Define a named cache with default JCache configuration</span>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;());</code></pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="fa icon-warning" title="Warning"></i> </td> <td class="content"> By default, the JCache API specifies that data should be stored as <code>storeByValue</code>, so that object state mutations outside of operations to the cache, won&#8217;t have an impact in the objects stored in the cache. Infinispan has so far implemented this using serialization/marshalling to make copies to store in the cache, and that way adhere to the spec. Hence, if using default JCache configuration with Infinispan, data stored must be marshallable. </td> </tr> </table> </div> <div class="paragraph"> <p>Alternatively, JCache can be configured to store data by reference (just like Infinispan or JDK Collections work). To do that, simply call:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;().setStoreByValue(<span class="predefined-constant">false</span>));</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="create_a_remote_cache"><a class="anchor" href="#create_a_remote_cache"></a>12.3. Create a remote cache</h3> <div class="paragraph"> <p>Creating a remote cache (client-server mode), using default configuration options as defined by the JCache API specification, is as simple as doing the following:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

<span class="comment">// Retrieve the system wide cache manager via org.infinispan.jcache.remote.JCachingProvider</span>
CacheManager cacheManager = Caching.getCachingProvider(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.jcache.remote.JCachingProvider</span><span class="delimiter">&quot;</span></span>).getCacheManager();
<span class="comment">// Define a named cache with default JCache configuration</span>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">remoteNamedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;());</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> In order to use the org.infinispan.jcache.remote.JCachingProvider, infinispan-jcache-remote-&lt;version&gt;.jar and all its transitive dependencies need to be on put your classpath. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="store_and_retrieve_data"><a class="anchor" href="#store_and_retrieve_data"></a>12.4. Store and retrieve data</h3> <div class="paragraph"> <p>Even though JCache API does not extend neither <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">java.util.Map</a> not <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">java.util.concurrent.ConcurrentMap</a>, it providers a key/value API to store and retrieve data:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

CacheManager cacheManager = Caching.getCacheManager();
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;());
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>); <span class="comment">// Notice that javax.cache.Cache.put(K) returns void!</span>
<span class="predefined-type">String</span> value = cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>); <span class="comment">// Returns &quot;world&quot;</span></code></pre> </div> </div> <div class="paragraph"> <p>Contrary to standard <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">java.util.Map</a>, <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java">javax.cache.Cache</a> comes with two basic put methods called put and getAndPut. The former returns <code>void</code> whereas the latter returns the previous value associated with the key. So, the equivalent of <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">java.util.Map.put(K)</a> in JCache is <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java#L230">javax.cache.Cache.getAndPut(K)</a>.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Even though JCache API only covers standalone caching, it can be plugged with a persistence store, and has been designed with clustering or distribution in mind. The reason why javax.cache.Cache offers two put methods is because standard java.util.Map put call forces implementors to calculate the previous value. When a persistent store is in use, or the cache is distributed, returning the previous value could be an expensive operation, and often users call standard <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">java.util.Map.put(K)</a> without using the return value. Hence, JCache users need to think about whether the return value is relevant to them, in which case they need to call <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java#L230">javax.cache.Cache.getAndPut(K)</a> , otherwise they can call <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">java.util.Map.put(K, V)</a> which avoids returning the potentially expensive operation of returning the previous value. </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="comparing_java_util_concurrent_concurrentmap_and_javax_cache_cache_apis"><a class="anchor" href="#comparing_java_util_concurrent_concurrentmap_and_javax_cache_cache_apis"></a>12.5. Comparing java.util.concurrent.ConcurrentMap and javax.cache.Cache APIs</h3> <div class="paragraph"> <p>Here&#8217;s a brief comparison of the data manipulation APIs provided by <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">java.util.concurrent.ConcurrentMap</a> and <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java">javax.cache.Cache</a> APIs.</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Operation</th> <th class="tableblock halign-left valign-top"><code>java.util.concurrent.ConcurrentMap&lt;K, V&gt;</code></th> <th class="tableblock halign-left valign-top"><code>javax.cache.Cache&lt;K, V&gt;</code></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">store and no return</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">N/A </p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>void put(K key)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">store and return previous value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V put(K key)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V getAndPut(K key)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">store if not present</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V putIfAbsent(K key, V value)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean putIfAbsent(K key, V value)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">retrieve</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V get(Object key)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V get(K key)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">delete if present</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V remove(Object key)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(K key)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">delete and return previous value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V remove(Object key)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V getAndRemove(K key)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">delete conditional</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(Object key, Object value)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(K key, V oldValue)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">replace if present</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V replace(K key, V value)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean replace(K key, V value)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">replace and return previous value</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V replace(K key, V value)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>V getAndReplace(K key, V value)</code></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">replace conditional</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean replace(K key, V oldValue, V newValue)</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean replace(K key, V oldValue, V newValue)</code></p></td> </tr> </tbody> </table> <div class="paragraph"> <p>Comparing the two APIs, it&#8217;s obvious to see that, where possible, JCache avoids returning the previous value to avoid operations doing expensive network or IO operations. This is an overriding principle in the design of JCache API. In fact, there&#8217;s a set of operations that are present in <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">java.util.concurrent.ConcurrentMap</a> , but are not present in the <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java">javax.cache.Cache</a> because they could be expensive to compute in a distributed cache. The only exception is iterating over the contents of the cache:</p> </div> <table class="tableblock frame-all grid-all stretch"> <colgroup> <col style="width: 33.3333%;"> <col style="width: 33.3333%;"> <col style="width: 33.3334%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Operation</th> <th class="tableblock halign-left valign-top"><code>java.util.concurrent.ConcurrentMap&lt;K, V&gt;</code></th> <th class="tableblock halign-left valign-top"><code>javax.cache.Cache&lt;K, V&gt;</code></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">calculate size of cache</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>int size()</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> N/A</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">return all keys in the cache</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Set&lt;K&gt; keySet()</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> N/A</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">return all values in the cache</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Collection&lt;V&gt; values()</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> N/A</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">return all entries in the cache</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet()</code></p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> N/A</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">iterate over the cache</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">use <code>iterator()</code> method on keySet, values or entrySet</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><code>Iterator&lt;Cache.Entry&lt;K, V&gt;&gt; iterator()</code></p></td> </tr> </tbody> </table> </div> <div class="sect2"> <h3 id="clustering_jcache_instances"><a class="anchor" href="#clustering_jcache_instances"></a>12.6. Clustering JCache instances</h3> <div class="paragraph"> <p>Infinispan JCache implementation goes beyond the specification in order to provide the possibility to cluster caches using the standard API. Given a Infinispan configuration file configured to replicate caches like this:</p> </div> <div class="listingblock"> <div class="title">infinispan.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;transport</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jcache-cluster</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>You can create a cluster of caches using this code:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">java.net.URI</span>;

<span class="comment">// For multiple cache managers to be constructed with the standard JCache API</span>
<span class="comment">// and live in the same JVM, either their names, or their classloaders, must</span>
<span class="comment">// be different.</span>
<span class="comment">// This example shows how to force their classloaders to be different.</span>
<span class="comment">// An alternative method would have been to duplicate the XML file and give</span>
<span class="comment">// it a different name, but this results in unnecessary file duplication.</span>
<span class="predefined-type">ClassLoader</span> tccl = <span class="predefined-type">Thread</span>.currentThread().getContextClassLoader();
CacheManager cacheManager1 = Caching.getCachingProvider().getCacheManager(
      <span class="predefined-type">URI</span>.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-jcache-cluster.xml</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> TestClassLoader(tccl));
CacheManager cacheManager2 = Caching.getCachingProvider().getCacheManager(
      <span class="predefined-type">URI</span>.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-jcache-cluster.xml</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> TestClassLoader(tccl));

Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache1 = cacheManager1.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache2 = cacheManager2.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>);

cache1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">String</span> value = cache2.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>); <span class="comment">// Returns &quot;world&quot; if clustering is working</span>

<span class="comment">// --</span>

<span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">TestClassLoader</span> <span class="directive">extends</span> <span class="predefined-type">ClassLoader</span> {
  <span class="directive">public</span> TestClassLoader(<span class="predefined-type">ClassLoader</span> parent) {
     <span class="local-variable">super</span>(parent);
  }
}</code></pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="multimap_cache"><a class="anchor" href="#multimap_cache"></a>13. Multimap Cache</h2> <div class="sectionbody"> <div class="paragraph"> <p>MutimapCache is a type of Infinispan Cache that maps keys to values in which each key can contain multiple values.</p> </div> <div class="sect2"> <h3 id="installation_and_configuration_2"><a class="anchor" href="#installation_and_configuration_2"></a>13.1. Installation and configuration</h3> <div class="listingblock"> <div class="title">pom.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-multimap<span class="tag">&lt;/artifactId&gt;</span>
  <span class="comment">&lt;!-- Replace ${version.infinispan} with the
  version of Infinispan that you're using. --&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre> </div> </div> </div> <div class="sect2"> <h3 id="multimapcache_api"><a class="anchor" href="#multimapcache_api"></a>13.2. MultimapCache API</h3> <div class="paragraph"> <p>MultimapCache API exposes several methods to interact with the Multimap Cache. All these methods are non-blocking in most of the cases. See [limitations]</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">MultimapCache</span>&lt;K, V&gt; {

   CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; put(K key, V value);

   CompletableFuture&lt;<span class="predefined-type">Collection</span>&lt;V&gt;&gt; get(K key);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; remove(K key);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; remove(K key, V value);

   CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; remove(<span class="predefined-type">Predicate</span>&lt;? <span class="local-variable">super</span> V&gt; p);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; containsKey(K key);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; containsValue(V value);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; containsEntry(K key, V value);

   CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; size();

   <span class="type">boolean</span> supportsDuplicates();

}</code></pre> </div> </div> <div class="sect3"> <h4 id="completablefuturevoid_putk_key_v_value"><a class="anchor" href="#completablefuturevoid_putk_key_v_value"></a>13.2.1. CompletableFuture&lt;Void&gt; put(K key, V value)</h4> <div class="paragraph"> <p>Puts a key-value pair in the multimap cache.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">MultimapCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; multimapCache = ...;

multimapCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">girlNames</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">marie</span><span class="delimiter">&quot;</span></span>)
             .thenCompose(r1 -&gt; multimapCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">girlNames</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">oihana</span><span class="delimiter">&quot;</span></span>))
             .thenCompose(r3 -&gt; multimapCache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">girlNames</span><span class="delimiter">&quot;</span></span>))
             .thenAccept(names -&gt; {
                          <span class="keyword">if</span>(names.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">marie</span><span class="delimiter">&quot;</span></span>))
                              <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Marie is a girl name</span><span class="delimiter">&quot;</span></span>);

                           <span class="keyword">if</span>(names.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">oihana</span><span class="delimiter">&quot;</span></span>))
                              <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Oihana is a girl name</span><span class="delimiter">&quot;</span></span>);
                        });</code></pre> </div> </div> <div class="paragraph"> <p>The output of this code is as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="txt">Marie is a girl name
Oihana is a girl name</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="completablefuturecollectionv_getk_key"><a class="anchor" href="#completablefuturecollectionv_getk_key"></a>13.2.2. CompletableFuture&lt;Collection&lt;V&gt;&gt; get(K key)</h4> <div class="paragraph"> <p>Asynchronous that returns a view collection of the values associated with key in this multimap cache, if any. Any changes to the retrieved collection won&#8217;t change the values in this multimap cache. When this method returns an empty collection, it means the key was not found.</p> </div> </div> <div class="sect3"> <h4 id="completablefutureboolean_removek_key"><a class="anchor" href="#completablefutureboolean_removek_key"></a>13.2.3. CompletableFuture&lt;Boolean&gt; remove(K key)</h4> <div class="paragraph"> <p>Asynchronous that removes the entry associated with the key from the multimap cache, if such exists.</p> </div> </div> <div class="sect3"> <h4 id="completablefutureboolean_removek_key_v_value"><a class="anchor" href="#completablefutureboolean_removek_key_v_value"></a>13.2.4. CompletableFuture&lt;Boolean&gt; remove(K key, V value)</h4> <div class="paragraph"> <p>Asynchronous that removes a key-value pair from the multimap cache, if such exists.</p> </div> </div> <div class="sect3"> <h4 id="completablefuturevoid_removepredicate_super_v_p"><a class="anchor" href="#completablefuturevoid_removepredicate_super_v_p"></a>13.2.5. CompletableFuture&lt;Void&gt; remove(Predicate&lt;? super V&gt; p)</h4> <div class="paragraph"> <p>Asynchronous method. Removes every value that match the given predicate.</p> </div> </div> <div class="sect3"> <h4 id="completablefutureboolean_containskeyk_key"><a class="anchor" href="#completablefutureboolean_containskeyk_key"></a>13.2.6. CompletableFuture&lt;Boolean&gt; containsKey(K key)</h4> <div class="paragraph"> <p>Asynchronous that returns true if this multimap contains the key.</p> </div> </div> <div class="sect3"> <h4 id="completablefutureboolean_containsvaluev_value"><a class="anchor" href="#completablefutureboolean_containsvaluev_value"></a>13.2.7. CompletableFuture&lt;Boolean&gt; containsValue(V value)</h4> <div class="paragraph"> <p>Asynchronous that returns true if this multimap contains the value in at least one key.</p> </div> </div> <div class="sect3"> <h4 id="completablefutureboolean_containsentryk_key_v_value"><a class="anchor" href="#completablefutureboolean_containsentryk_key_v_value"></a>13.2.8. CompletableFuture&lt;Boolean&gt; containsEntry(K key, V value)</h4> <div class="paragraph"> <p>Asynchronous that returns true if this multimap contains at least one key-value pair with the value.</p> </div> </div> <div class="sect3"> <h4 id="completablefuturelong_size"><a class="anchor" href="#completablefuturelong_size"></a>13.2.9. CompletableFuture&lt;Long&gt; size()</h4> <div class="paragraph"> <p>Asynchronous that returns the number of key-value pairs in the multimap cache. It doesn&#8217;t return the distinct number of keys.</p> </div> </div> <div class="sect3"> <h4 id="boolean_supportsduplicates"><a class="anchor" href="#boolean_supportsduplicates"></a>13.2.10. boolean supportsDuplicates()</h4> <div class="paragraph"> <p>Asynchronous that returns true if the multimap cache supports duplicates. This means that the content of the multimap can be 'a' &#8594; ['1', '1', '2']. For now this method will always return false, as duplicates are not yet supported. The existence of a given value is determined by 'equals' and `hashcode' method&#8217;s contract.</p> </div> </div> </div> <div class="sect2"> <h3 id="creating_a_multimap_cache"><a class="anchor" href="#creating_a_multimap_cache"></a>13.3. Creating a Multimap Cache</h3> <div class="paragraph"> <p>Currently the MultimapCache is configured as a regular cache. This can be done either by code or XML configuration. See how to configure a regular Cache in the section link to [configure a cache].</p> </div> <div class="sect3"> <h4 id="embedded_mode"><a class="anchor" href="#embedded_mode"></a>13.3.1. Embedded mode</h4> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// create or obtain your EmbeddedCacheManager</span>
EmbeddedCacheManager cm = ... ;

<span class="comment">// create or obtain a MultimapCacheManager passing the EmbeddedCacheManager</span>
MultimapCacheManager multimapCacheManager = EmbeddedMultimapCacheManagerFactory.from(cm);

<span class="comment">// define the configuration for the multimap cache</span>
multimapCacheManager.defineConfiguration(multimapCacheName, c.build());

<span class="comment">// get the multimap cache</span>
multimapCache = multimapCacheManager.get(multimapCacheName);</code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="limitations"><a class="anchor" href="#limitations"></a>13.4. Limitations</h3> <div class="paragraph"> <p>In almost every case the Multimap Cache will behave as a regular Cache, but some limitations exist in the current version.</p> </div> <div class="sect3"> <h4 id="support_for_duplicates"><a class="anchor" href="#support_for_duplicates"></a>13.4.1. Support for duplicates</h4> <div class="paragraph"> <p>Duplicates are not supported yet. This means that the multimap won&#8217;t contain any duplicate key-value pair. Whenever put method is called, if the key-value pair already exist, this key-value par won&#8217;t be added. Methods used to check if a key-value pair is already present in the Multimap are the <code>equals</code> and <code>hashcode</code>.</p> </div> </div> <div class="sect3"> <h4 id="eviction"><a class="anchor" href="#eviction"></a>13.4.2. Eviction</h4> <div class="paragraph"> <p>For now, the eviction works per key, and not per key-value pair. This means that whenever a key is evicted, all the values associated with the key will be evicted too. Eviction per key-value could be supported in the future.</p> </div> </div> <div class="sect3"> <h4 id="transactions"><a class="anchor" href="#transactions"></a>13.4.3. Transactions</h4> <div class="paragraph"> <p>Implicit transactions are supported through the auto-commit and all the methods are non blocking. Explicit transactions work without blocking in most of the cases. Methods that will block are <code>size</code>, <code>containsEntry</code> and <code>remove(Predicate&lt;? super V&gt; p)</code></p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="transactions"><a class="anchor" href="#transactions"></a>14. Transactions</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan can be configured to use and to participate in JTA compliant transactions. Alternatively, if transaction support is disabled, it is equivalent to using autocommit in JDBC calls, where modifications are potentially replicated after every change (if replication is enabled).</p> </div> <div class="paragraph"> <p>On every cache operation Infinispan does the following:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Retrieves the current <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Transaction.html">Transaction</a> associated with the thread</p> </li> <li> <p>If not already done, registers <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a> with the transaction manager to be notified when a transaction commits or is rolled back.</p> </li> </ol> </div> <div class="paragraph"> <p>In order to do this, the cache has to be provided with a reference to the environment&#8217;s <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>. This is usually done by configuring the cache with the class name of an implementation of the <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/transaction/lookup/TransactionManagerLookup.html">TransactionManagerLookup</a> interface. When the cache starts, it will create an instance of this class and invoke its <code>getTransactionManager()</code> method, which returns a reference to the <code>TransactionManager</code>.</p> </div> <div class="paragraph"> <p>Infinispan ships with several transaction manager lookup classes:</p> </div> <div class="ulist"> <div class="title">Transaction manager lookup implementations</div> <ul> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/transaction/lookup/EmbeddedTransactionManagerLookup.html">EmbeddedTransactionManagerLookup</a>: This provides with a basic transaction manager which should only be used for embedded mode when no other implementation is available. This implementation has some severe limitations to do with concurrent transactions and recovery.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/transaction/lookup/JBossStandaloneJTAManagerLookup.html">JBossStandaloneJTAManagerLookup</a>: If you&#8217;re running Infinispan in a standalone environment, or in JBoss AS 7 and earlier, and WildFly 8, 9, and 10, this should be your default choice for transaction manager. It&#8217;s a fully fledged transaction manager based on <a href="http://narayana.io/">JBoss Transactions</a> which overcomes all the deficiencies of the <code>EmbeddedTransactionManager</code>.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/transaction/lookup/WildflyTransactionManagerLookup.html">WildflyTransactionManagerLookup</a>: If you&#8217;re running Infinispan in Wildfly 11 or later, this should be your default choice for transaction manager.</p> </li> <li> <p><a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/transaction/lookup/GenericTransactionManagerLookup.html">GenericTransactionManagerLookup</a>: This is a lookup class that locate transaction managers in the most popular Java EE application servers. If no transaction manager can be found, it defaults on the <code>EmbeddedTransactionManager</code>.</p> </li> </ul> </div> <div class="paragraph"> <p>WARN: <code>DummyTransactionManagerLookup</code> has been deprecated in 9.0 and it will be removed in the future. Use <code>EmbeddedTransactionManagerLookup</code> instead.</p> </div> <div class="paragraph"> <p>Once initialized, the <code>TransactionManager</code> can also be obtained from the <code>Cache</code> itself:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//the cache must have a transactionManagerLookupClass defined</span>
Cache cache = cacheManager.getCache();

<span class="comment">//equivalent with calling TransactionManagerLookup.getTransactionManager();</span>
TransactionManager tm = cache.getAdvancedCache().getTransactionManager();</code></pre> </div> </div> <div class="sect2"> <h3 id="tx_configuration"><a class="anchor" href="#tx_configuration"></a>14.1. Configuring transactions</h3> <div class="paragraph"> <p>Transactions are configured at cache level. Below is the configuration that affects a transaction behaviour and a small description of each configuration attribute.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;locking</span>
   <span class="attribute-name">isolation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">READ_COMMITTED</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">write-skew</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;transaction</span>
   <span class="attribute-name">locking</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OPTIMISTIC</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">auto-commit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">complete-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">notifications</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DEFAULT</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">reaper-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">recovery-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">__recoveryInfoCacheName__</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">stop-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">transaction-manager-lookup</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.transaction.lookup.GenericTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;versioning</span>
   <span class="attribute-name">scheme</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>or programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.locking()
    .isolationLevel(IsolationLevel.READ_COMMITTED)
    .writeSkewCheck(<span class="predefined-constant">false</span>);
builder.transaction()
    .lockingMode(LockingMode.OPTIMISTIC)
    .autoCommit(<span class="predefined-constant">true</span>)
    .completedTxTimeout(<span class="integer">60000</span>)
    .transactionMode(TransactionMode.NON_TRANSACTIONAL)
    .useSynchronization(<span class="predefined-constant">false</span>)
    .notifications(<span class="predefined-constant">true</span>)
    .transactionProtocol(TransactionProtocol.DEFAULT)
    .reaperWakeUpInterval(<span class="integer">30000</span>)
    .cacheStopTimeout(<span class="integer">30000</span>)
    .transactionManagerLookup(<span class="keyword">new</span> GenericTransactionManagerLookup())
    .recovery()
    .enabled(<span class="predefined-constant">false</span>)
    .recoveryInfoCacheName(<span class="string"><span class="delimiter">&quot;</span><span class="content">__recoveryInfoCacheName__</span><span class="delimiter">&quot;</span></span>);
builder.versioning()
    .enabled(<span class="predefined-constant">false</span>)
    .scheme(VersioningScheme.NONE);</code></pre> </div> </div> <div class="ulist"> <ul> <li> <p><code>isolation</code> - configures the isolation level. Check section <a href="#tx_isolation_levels">Isolation Levels</a> for more details. Default is <code>REPEATABLE_READ</code>.</p> </li> <li> <p><code>write-skew</code> - enables write skew checks (deprecated). Infinispan automatically sets this attribute in Library Mode. Default is <code>false</code> for <code>READ_COMMITTED</code>. Default is <code>true</code> for <code>REPEATABLE_READ</code>. See <a href="#tx_write_skew">Write Skews</a> for more details.</p> </li> <li> <p><code>locking</code> - configures whether the cache uses optimistic or pessimistic locking. Check section <a href="#tx_locking">Transaction Locking</a> for more details. Default is <code>OPTIMISTIC</code>.</p> </li> <li> <p><code>auto-commit</code> - if enable, the user does not need to start a transaction manually for a single operation. The transaction is automatically started and committed. Default is <code>true</code>.</p> </li> <li> <p><code>complete-timeout</code> - the duration in milliseconds to keep information about completed transactions. Default is <code>60000</code>.</p> </li> <li> <p><code>mode</code> - configures whether the cache is transactional or not. Default is <code>NONE</code>. The available options are:</p> <div class="ulist"> <ul> <li> <p><code>NONE</code> - non transactional cache</p> </li> <li> <p><code>FULL_XA</code> - XA transactional cache with recovery enabled. Check section <a href="#tx_recovery">Transaction recovery</a> for more details about recovery.</p> </li> <li> <p><code>NON_DURABLE_XA</code> - XA transactional cache with recovery disabled.</p> </li> <li> <p><code>NON_XA</code> - transactional cache with integration via <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Synchronization.html">Synchronization</a> instead of XA. Check section <a href="#tx_sync_enlist">Enlisting Synchronizations</a> for details.</p> </li> <li> <p><code>BATCH</code>- transactional cache using batch to group operations. Check section <a href="#tx_batching">Batching</a> for details.</p> </li> </ul> </div> </li> <li> <p><code>notifications</code> - enables/disables triggering transactional events in cache listeners. Default is <code>true</code>.</p> </li> <li> <p><code>protocol</code> - configures the protocol uses. Default is <code>DEFAULT</code>. Values available are:</p> <div class="ulist"> <ul> <li> <p><code>DEFAULT</code> - uses the traditional Two-Phase-Commit protocol. It is described below.</p> </li> <li> <p><code>TOTAL_ORDER</code> - uses total order ensured by the <code>Transport</code> to commit transactions. Check section <a href="#tx_total_order">Total Order based commit protocol</a> for details.</p> </li> </ul> </div> </li> <li> <p><code>reaper-interval</code> - the time interval in millisecond at which the thread that cleans up transaction completion information kicks in. Defaults is <code>30000</code>.</p> </li> <li> <p><code>recovery-cache</code> - configures the cache name to store the recovery information. Check section <a href="#tx_recovery">Transaction recovery</a> for more details about recovery. Default is <code><em>recoveryInfoCacheName</em></code>.</p> </li> <li> <p><code>stop-timeout</code> - the time in millisecond to wait for ongoing transaction when the cache is stopping. Default is <code>30000</code>.</p> </li> <li> <p><code>transaction-manager-lookup</code> - configures the fully qualified class name of a class that looks up a reference to a <code>javax.transaction.TransactionManager</code>. Default is <code>org.infinispan.transaction.lookup.GenericTransactionManagerLookup</code>.</p> </li> <li> <p>Versioning <code>scheme</code> - configure the version scheme to use when write skew is enabled with optimistic or total order transactions. Check section <a href="#tx_write_skew">Write Skews</a> for more details. Default is <code>NONE</code>.</p> </li> </ul> </div> <div class="paragraph"> <p>For more details on how Two-Phase-Commit (2PC) is implemented in Infinispan and how locks are being acquired see the section below. More details about the configuration settings are available in <a href="http://docs.jboss.org/infinispan/10.0/configdocs/">Configuration reference</a>.</p> </div> </div> <div class="sect2"> <h3 id="tx_isolation_levels"><a class="anchor" href="#tx_isolation_levels"></a>14.2. Isolation levels</h3> <div class="paragraph"> <p>Infinispan offers two isolation levels - <a href="https://en.wikipedia.org/wiki/Isolation_(database_systems)#Read_committed">READ_COMMITTED</a> and <a href="https://en.wikipedia.org/wiki/Isolation_(database_systems)#Repeatable_reads">REPEATABLE_READ</a>.</p> </div> <div class="paragraph"> <p>These isolation levels determine when readers see a concurrent write, and are internally implemented using different subclasses of <code>MVCCEntry</code>, which have different behaviour in how state is committed back to the data container.</p> </div> <div class="paragraph"> <p>Here&#8217;s a more detailed example that should help understand the difference between <code>READ_COMMITTED</code> and <code>REPEATABLE_READ</code> in the context of Infinispan. With <code>READ_COMMITTED</code>, if between two consecutive read calls on the same key, the key has been updated by another transaction, the second read may return the new updated value:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Thread1: tx1.begin()
Thread1: cache.get(k) <span class="comment">// returns v</span>
Thread2:                                       tx2.begin()
Thread2:                                       cache.get(k) <span class="comment">// returns v</span>
Thread2:                                       cache.put(k, v2)
Thread2:                                       tx2.commit()
Thread1: cache.get(k) <span class="comment">// returns v2!</span>
Thread1: tx1.commit()</code></pre> </div> </div> <div class="paragraph"> <p>With <code>REPEATABLE_READ</code>, the final get will still return <code>v</code>. So, if you&#8217;re going to retrieve the same key multiple times within a transaction, you should use <code>REPEATABLE_READ</code>.</p> </div> <div class="paragraph"> <p>However, as read-locks are not acquired even for <code>REPEATABLE_READ</code>, this phenomena can occur:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>) <span class="comment">// returns 1</span>
cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>) <span class="comment">// returns 1</span>

Thread1: tx1.begin()
Thread1: cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>, <span class="integer">2</span>)
Thread1: cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>, <span class="integer">2</span>)
Thread2:                                       tx2.begin()
Thread2:                                       cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>) <span class="comment">// returns 1</span>
Thread1: tx1.commit()
Thread2:                                       cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>) <span class="comment">// returns 2</span>
Thread2:                                       tx2.commit()</code></pre> </div> </div> </div> <div class="sect2"> <h3 id="tx_locking"><a class="anchor" href="#tx_locking"></a>14.3. Transaction locking</h3> <div class="sect3"> <h4 id="pessimistic_transactional_cache"><a class="anchor" href="#pessimistic_transactional_cache"></a>14.3.1. Pessimistic transactional cache</h4> <div class="paragraph"> <p>From a lock acquisition perspective, pessimistic transactions obtain locks on keys at the time the key is written.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>A lock request is sent to the primary owner (can be an explicit lock request or an operation)</p> </li> <li> <p>The primary owner tries to acquire the lock:</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>If it succeed, it sends back a positive reply;</p> </li> <li> <p>Otherwise, a negative reply is sent and the transaction is rollback.</p> </li> </ol> </div> </li> </ol> </div> <div class="paragraph"> <p>As an example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">transactionManager.begin();
cache.put(k1,v1); <span class="comment">//k1 is locked.</span>
cache.remove(k2); <span class="comment">//k2 is locked when this returns</span>
transactionManager.commit();</code></pre> </div> </div> <div class="paragraph"> <p>When <code>cache.put(k1,v1)</code> returns, <code>k1</code> is locked and no other transaction running anywhere in the cluster can write to it. Reading <code>k1</code> is still possible. The lock on <code>k1</code> is released when the transaction completes (commits or rollbacks).</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> For conditional operations, the validation is performed in the originator. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="optimistic_transactional_cache"><a class="anchor" href="#optimistic_transactional_cache"></a>14.3.2. Optimistic transactional cache</h4> <div class="paragraph"> <p>With optimistic transactions locks are being acquired at transaction prepare time and are only being held up to the point the transaction commits (or rollbacks). This is different from the 5.0 default locking model where local locks are being acquire on writes and cluster locks are being acquired during prepare time.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>The prepare is sent to all the owners.</p> </li> <li> <p>The primary owners try to acquire the locks needed:</p> <div class="olist loweralpha"> <ol class="loweralpha" type="a"> <li> <p>If locking succeeds, it performs the write skew check.</p> </li> <li> <p>If the write skew check succeeds (or is disabled), send a positive reply.</p> </li> <li> <p>Otherwise, a negative reply is sent and the transaction is rolled back.</p> </li> </ol> </div> </li> </ol> </div> <div class="paragraph"> <p>As an example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">transactionManager.begin();
cache.put(k1,v1);
cache.remove(k2);
transactionManager.commit(); <span class="comment">//at prepare time, K1 and K2 is locked until committed/rolled back.</span></code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> For conditional commands, the validation still happens on the originator. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="what_do_i_need_pessimistic_or_optimistic_transactions"><a class="anchor" href="#what_do_i_need_pessimistic_or_optimistic_transactions"></a>14.3.3. What do I need - pessimistic or optimistic transactions?</h4> <div class="paragraph"> <p>From a use case perspective, optimistic transactions should be used when there is <em>not</em> a lot of contention between multiple transactions running at the same time. That is because the optimistic transactions rollback if data has changed between the time it was read and the time it was committed (with write skew check enabled).</p> </div> <div class="paragraph"> <p>On the other hand, pessimistic transactions might be a better fit when there is high contention on the keys and transaction rollbacks are less desirable. Pessimistic transactions are more costly by their nature: each write operation potentially involves a RPC for lock acquisition.</p> </div> </div> </div> <div class="sect2"> <h3 id="tx_write_skew"><a class="anchor" href="#tx_write_skew"></a>14.4. Write Skews</h3> <div class="paragraph"> <p>Write skews occur when two transactions independently and simultaneously read and write to the same key. The result of a write skew is that both transactions successfully commit updates to the same key but with different values.</p> </div> <div class="paragraph"> <p>In Library Mode, Infinispan automatically performs write skew checks to ensure data consistency for <code>REPEATABLE_READ</code> isolation levels in optimistic transactions. This allows Infinispan to detect and roll back one of the transactions.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>The <code>write-skew</code> attribute is deprecated for Library Mode. In Remote Client/Server Mode, this attribute is not a valid declaration.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>When operating in <code>LOCAL</code> mode, write skew checks rely on Java object references to compare differences, which provides a reliable technique for checking for write skews.</p> </div> <div class="paragraph"> <p>In clustered environments, you should configure data versioning to ensure reliable write skew checks. Infinispan provides an implementation of the <code>EntryVersion</code> interface called <code>SIMPLE</code> versioning, which is backed by a long that is incremented each time the entry is updated.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;versioning</span> <span class="attribute-name">scheme</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SIMPLE|NONE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="paragraph"> <p>Or</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> ConfigurationBuilder().versioning().scheme(SIMPLE);</code></pre> </div> </div> <div class="sect3"> <h4 id="forcing_write_locks_on_keys_in_pessimitic_transactions"><a class="anchor" href="#forcing_write_locks_on_keys_in_pessimitic_transactions"></a>14.4.1. Forcing write locks on keys in pessimitic transactions</h4> <div class="paragraph"> <p>To avoid write-skews with pessimistic transactions, lock keys at read-time with <code>Flag.FORCE_WRITE_LOCK</code>.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="ulist"> <ul> <li> <p>In non-transactional caches, <code>Flag.FORCE_WRITE_LOCK</code> does not work. The <code>get()</code> call reads the key value but does not acquire locks remotely.</p> </li> <li> <p>You should use <code>Flag.FORCE_WRITE_LOCK</code> with transactions in which the entity is updated later in the same transaction.</p> </li> </ul> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Compare the following code snippets for an example of <code>Flag.FORCE_WRITE_LOCK</code>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// begin the transaction</span>
<span class="keyword">if</span> (!cache.getAdvancedCache().lock(key)) {
   <span class="comment">// abort the transaction because the key was not locked</span>
} <span class="keyword">else</span> {
   cache.get(key);
   cache.put(key, value);
   <span class="comment">// commit the transaction</span>
}</code></pre> </div> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// begin the transaction</span>
<span class="keyword">try</span> {
   <span class="comment">// throws an exception if the key is not locked.</span>
   cache.getAdvancedCache().withFlags(Flag.FORCE_WRITE_LOCK).get(key);
   cache.put(key, value);
} <span class="keyword">catch</span> (CacheException e) {
   <span class="comment">// mark the transaction rollback-only</span>
}
<span class="comment">// commit or rollback the transaction</span></code></pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="dealing_with_exceptions"><a class="anchor" href="#dealing_with_exceptions"></a>14.5. Dealing with exceptions</h3> <div class="paragraph"> <p>If a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/commons/CacheException.html">CacheException</a> (or a subclass of it) is thrown by a cache method within the scope of a JTA transaction, then the transaction is automatically marked for rollback.</p> </div> </div> <div class="sect2"> <h3 id="tx_sync_enlist"><a class="anchor" href="#tx_sync_enlist"></a>14.6. Enlisting Synchronizations</h3> <div class="paragraph"> <p>By default Infinispan registers itself as a first class participant in distributed transactions through <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a>. There are situations where Infinispan is not required to be a participant in the transaction, but only to be notified by its lifecycle (prepare, complete): e.g. in the case Infinispan is used as a 2nd level cache in Hibernate.</p> </div> <div class="paragraph"> <p>Infinispan allows transaction enlistment through <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Synchronization.html">Synchronization</a>. To enable it just use <code>NON_XA</code> transaction mode.</p> </div> <div class="paragraph"> <p><code>Synchronization</code>s have the advantage that they allow <code>TransactionManager</code> to optimize 2PC with a 1PC where only one other resource is enlisted with that transaction (<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html/development_guide/java_transaction_api_jta#about_the_lrco_optimization_for_single_phase_commit_1pc">last resource commit optimization</a>). E.g. Hibernate second level cache: if Infinispan registers itself with the <code>TransactionManager</code> as a <code>XAResource</code> than at commit time, the <code>TransactionManager</code> sees two <code>XAResource</code> (cache and database) and does not make this optimization. Having to coordinate between two resources it needs to write the tx log to disk. On the other hand, registering Infinispan as a <code>Synchronisation</code> makes the <code>TransactionManager</code> skip writing the log to the disk (performance improvement).</p> </div> </div> <div class="sect2"> <h3 id="tx_batching"><a class="anchor" href="#tx_batching"></a>14.7. Batching</h3> <div class="paragraph"> <p>Batching allows atomicity and some characteristics of a transaction, but not full-blown JTA or XA capabilities. Batching is often a lot lighter and cheaper than a full-blown transaction.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> Generally speaking, one should use batching API whenever the only participant in the transaction is an Infinispan cluster. On the other hand, JTA transactions (involving <code>TransactionManager</code>) should be used whenever the transactions involves multiple systems. E.g. considering the "Hello world!" of transactions: transferring money from one bank account to the other. If both accounts are stored within Infinispan, then batching can be used. If one account is in a database and the other is Infinispan, then distributed transactions are required. </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> You <em>do not</em> have to have a transaction manager defined to use batching. </td> </tr> </table> </div> <div class="sect3"> <h4 id="api"><a class="anchor" href="#api"></a>14.7.1. API</h4> <div class="paragraph"> <p>Once you have configured your cache to use batching, you use it by calling <code>startBatch()</code> and <code>endBatch()</code> on <code>Cache</code>. E.g.,</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java">Cache cache = cacheManager.getCache();
<span class="comment">// not using a batch</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>); <span class="comment">// will replicate immediately</span>

<span class="comment">// using a batch</span>
cache.startBatch();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.endBatch(<span class="predefined-constant">true</span>); <span class="comment">// This will now replicate the modifications since the batch was started.</span>

<span class="comment">// a new batch</span>
cache.startBatch();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.endBatch(<span class="predefined-constant">false</span>); <span class="comment">// This will &quot;discard&quot; changes made in the batch</span></code></pre> </div> </div> </div> <div class="sect3"> <h4 id="batching_and_jta"><a class="anchor" href="#batching_and_jta"></a>14.7.2. Batching and JTA</h4> <div class="paragraph"> <p>Behind the scenes, the batching functionality starts a JTA transaction, and all the invocations in that scope are associated with it. For this it uses a very simple (e.g. no recovery) internal <code>TransactionManager</code> implementation. With batching, you get:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Locks you acquire during an invocation are held until the batch completes</p> </li> <li> <p>Changes are all replicated around the cluster in a batch as part of the batch completion process. Reduces replication chatter for each update in the batch.</p> </li> <li> <p>If synchronous replication or invalidation are used, a failure in replication/invalidation will cause the batch to roll back.</p> </li> <li> <p>All the transaction related configurations apply for batching as well.</p> </li> </ol> </div> </div> </div> <div class="sect2"> <h3 id="tx_recovery"><a class="anchor" href="#tx_recovery"></a>14.8. Transaction recovery</h3> <div class="paragraph"> <p>Recovery is a feature of XA transactions, which deal with the eventuality of a resource or possibly even the transaction manager failing, and recovering accordingly from such a situation.</p> </div> <div class="sect3"> <h4 id="when_to_use_recovery"><a class="anchor" href="#when_to_use_recovery"></a>14.8.1. When to use recovery</h4> <div class="paragraph"> <p>Consider a distributed transaction in which money is transferred from an account stored in an external database to an account stored in Infinispan. When <code>TransactionManager.commit()</code> is invoked, both resources prepare successfully (1st phase). During the commit (2nd) phase, the database successfully applies the changes whilst Infinispan fails before receiving the commit request from the transaction manager. At this point the system is in an inconsistent state: money is taken from the account in the external database but not visible yet in Infinispan (since locks are only released during 2nd phase of a two-phase commit protocol). Recovery deals with this situation to make sure data in both the database and Infinispan ends up in a consistent state.</p> </div> </div> <div class="sect3"> <h4 id="how_does_it_work"><a class="anchor" href="#how_does_it_work"></a>14.8.2. How does it work</h4> <div class="paragraph"> <p>Recovery is coordinated by the transaction manager. The transaction manager works with Infinispan to determine the list of in-doubt transactions that require manual intervention and informs the system administrator (via email, log alerts, etc). This process is transaction manager specific, but generally requires some configuration on the transaction manager.  </p> </div> <div class="paragraph"> <p>Knowing the in-doubt transaction ids, the system administrator can now connect to the Infinispan cluster and replay the commit of transactions or force the rollback. Infinispan provides JMX tooling for this - this is explained extensively in the <a href="#tx_recovery_reconciliation">Transaction recovery and reconciliation</a> section.</p> </div> </div> <div class="sect3"> <h4 id="configuring_recovery"><a class="anchor" href="#configuring_recovery"></a>14.8.3. Configuring recovery   </h4> <div class="paragraph"> <p>Recovery is <em>not</em> enabled by default in Infinispan. If disabled, the <code>TransactionManager</code> won&#8217;t be able to work with Infinispan to determine the in-doubt transactions. The <a href="#tx_configuration">Transaction configuration</a> section shows how to enable it.</p> </div> <div class="paragraph"> <p>NOTE: <code>recovery-cache</code> attribute is not mandatory and it is configured per-cache.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> For recovery to work, <code>mode</code> must be set to <code>FULL_XA</code>, since full-blown XA transactions are needed. </td> </tr> </table> </div> <div class="sect4"> <h5 id="enable_jmx_support"><a class="anchor" href="#enable_jmx_support"></a>Enable JMX support</h5> <div class="paragraph"> <p>In order to be able to use JMX for managing recovery JMX support must be explicitly enabled.</p> </div> </div> </div> <div class="sect3"> <h4 id="recovery_cache"><a class="anchor" href="#recovery_cache"></a>14.8.4. Recovery cache</h4> <div class="paragraph"> <p>In order to track in-doubt transactions and be able to reply them, Infinispan caches all transaction state for future use. This state is held only for in-doubt transaction, being removed for successfully completed transactions after when the commit/rollback phase completed.</p> </div> <div class="paragraph"> <p>This in-doubt transaction data is held within a local cache: this allows one to configure swapping this info to disk through cache loader in the case it gets too big. This cache can be specified through the <code>recovery-cache</code> configuration attribute. If not specified Infinispan will configure a local cache for you.</p> </div> <div class="paragraph"> <p>It is possible (though not mandated) to share same recovery cache between all the Infinispan caches that have recovery enabled. If the default recovery cache is overridden, then the specified recovery cache must use a <a href="https://docs.jboss.org/infinispan/10.0/apidocs/org/infinispan/transaction/lookup/TransactionManagerLookup.html">TransactionManagerLookup</a> that returns a different transaction manager than the one used by the cache itself.</p> </div> </div> <div class="sect3"> <h4 id="integration_with_the_transaction_manager"><a class="anchor" href="#integration_with_the_transaction_manager"></a>14.8.5. Integration with the transaction manager</h4> <div class="paragraph"> <p>Even though this is transaction manager specific, generally a transaction manager would need a reference to a <code>XAResource</code> implementation in order to invoke <code>XAResource.recover()</code> on it. In order to obtain a reference to an Infinispan <code>XAResource</code> following API can be used:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">XAResource</span> xar = cache.getAdvancedCache().getXAResource();</code></pre> </div> </div> <div class="paragraph"> <p>It is a common practice to run the recovery in a different process from the one running the transaction.</p> </div> </div> <div class="sect3"> <h4 id="tx_recovery_reconciliation"><a class="anchor" href="#tx_recovery_reconciliation"></a>14.8.6. Reconciliation</h4> <div class="paragraph"> <p>The transaction manager informs the system administrator on in-doubt transaction in a proprietary way. At this stage it is assumed that the system administrator knows transaction&#8217;s XID (a byte array).</p> </div> <div class="paragraph"> <p>A normal recovery flow is:</p> </div> <div class="ulist"> <ul> <li> <p><strong>STEP 1</strong>: The system administrator connects to an Infinispan server through JMX, and lists the in doubt transactions. The image below demonstrates JConsole connecting to an Infinispan node that has an in doubt transaction.</p> </li> </ul> </div> <div class="imageblock text-center"> <div class="content"> <img src="./../../topics/images/showInDoubtTx.png" alt="showInDoubtTx"> </div> <div class="title">Figure 1. Show in-doubt transactions</div> </div> <div class="paragraph"> <p>The status of each in-doubt transaction is displayed(in this example " <em>PREPARED</em> "). There might be multiple elements in the status field, e.g. "PREPARED" and "COMMITTED" in the case the transaction committed on certain nodes but not on all of them.  </p> </div> <div class="ulist"> <ul> <li> <p><strong>STEP 2</strong>: The system administrator visually maps the XID received from the transaction manager to an Infinispan internal id, represented as a number. This step is needed because the XID, a byte array, cannot conveniently be passed to the JMX tool (e.g. JConsole) and then re-assembled on Infinispan&#8217;s side.</p> </li> <li> <p><strong>STEP 3</strong>: The system administrator forces the transaction&#8217;s commit/rollback through the corresponding jmx operation, based on the internal id. The image below is obtained by forcing the commit of the transaction based on its internal id.</p> </li> </ul> </div> <div class="imageblock text-center"> <div class="content"> <img src="./../../topics/images/forceCommit.png" alt="forceCommit"> </div> <div class="title">Figure 2. Force commit</div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> All JMX operations described above can be executed on any node, regardless of where the transaction originated. </td> </tr> </table> </div> <div class="sect4"> <h5 id="force_commitrollback_based_on_xid"><a class="anchor" href="#force_commitrollback_based_on_xid"></a>Force commit/rollback based on XID</h5> <div class="paragraph"> <p>XID-based JMX operations for forcing in-doubt transactions' commit/rollback are available as well: these methods receive byte[] arrays describing the XID instead of the number associated with the transactions (as previously described at step 2). These can be useful e.g. if one wants to set up an automatic completion job for certain in-doubt transactions. This process is plugged into transaction manager&#8217;s recovery and has access to the transaction manager&#8217;s XID objects.</p> </div> </div> </div> <div class="sect3"> <h4 id="want_to_know_more"><a class="anchor" href="#want_to_know_more"></a>14.8.7. Want to know more?</h4> <div class="paragraph"> <p>The <a href="https://community.jboss.org/wiki/TransactionRecoveryDesign">recovery design document</a> describes in more detail the insides of transaction recovery implementation.</p> </div> </div> </div> <div class="sect2"> <h3 id="tx_total_order"><a class="anchor" href="#tx_total_order"></a>14.9. Total Order based commit protocol</h3> <div class="paragraph"> <p>The Total Order based protocol is a multi-master scheme (in this context, multi-master scheme means that all nodes can update all the data) as the (optimistic/pessimist) locking mode implemented in Infinispan. This commit protocol relies on the concept of totally ordered delivery of messages which, informally, implies that each node which delivers a set of messages, delivers them in the same order.</p> </div> <div class="paragraph"> <p>This protocol comes with this advantages.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>transactions can be committed in one phase, as they are delivered in the same order by the nodes that receive them.</p> </li> <li> <p>it mitigates distributed deadlocks.</p> </li> </ol> </div> <div class="paragraph"> <p>The weaknesses of this approach are the fact that its implementation relies on a single thread per node which delivers the transaction and its modification, and the slightly cost of total ordering the messages in <code>Transport</code>.</p> </div> <div class="paragraph"> <p>Thus, this protocol delivers best performance in scenarios of <em>high contention</em> , in which it can benefit from the single-phase commit and the deliver thread is not the bottleneck.</p> </div> <div class="paragraph"> <p>Currently, the Total Order based protocol is available only in <em>transactional</em> caches for <em>replicated</em> and <em>distributed</em> modes.</p> </div> <div class="sect3"> <h4 id="overview_2"><a class="anchor" href="#overview_2"></a>14.9.1. Overview</h4> <div class="paragraph"> <p>The Total Order based commit protocol only affects how transactions are committed by Infinispan and the isolation level and write skew affects it behaviour.</p> </div> <div class="paragraph"> <p>When write skew is disabled, the transaction can be committed/rolled back in single phase. The data consistency is guaranteed by the <code>Transport</code> that ensures that all owners of a key will deliver the same transactions set by the same order.</p> </div> <div class="paragraph"> <p>On other hand, when write skew is enabled, the protocol adapts and uses one phase commit when it is safe. In <code>XaResource</code> enlistment, we can use one phase if the <code>TransactionManager</code> request a commit in one phase (last resource commit optimization) and the Infinispan cache is configured in replicated mode. This optimization is not safe in distributed mode because each node performs the write skew check validation in different keys subset. When in <code>Synchronization</code> enlistment, the <code>TransactionManager</code> does not provide any information if Infinispan is the only resource enlisted (last resource commit optimization), so it is not possible to commit in a single phase.</p> </div> <div class="sect4"> <h5 id="commit_in_one_phase"><a class="anchor" href="#commit_in_one_phase"></a>Commit in one phase</h5> <div class="paragraph"> <p>When the transaction ends, Infinispan sends the transaction (and its modification) in total order. This ensures all the transactions are deliver in the same order in all the involved Infinispan nodes. As a result, when a transaction is delivered, it performs a deterministic write skew check over the same state (if enabled), leading to the same outcome (transaction commit or rollback).</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./../../topics/images/total-order-1pc.png" alt="total order 1pc"> </div> <div class="title">Figure 3. 1-phase commit</div> </div> <div class="paragraph"> <p>The figure above demonstrates a high level example with 3 nodes. <code>Node1</code> and <code>Node3</code> are running one transaction each and lets assume that both transaction writes on the same key. To make it more interesting, lets assume that both nodes tries to commit at the same time, represented by the first colored circle in the figure. The <em>blue</em> circle represents the transaction <em>tx1</em> and the <em>green</em> the transaction <em>tx2</em> . Both nodes do a remote invocation in total order (<em>to-send</em>) with the transaction&#8217;s modifications. At this moment, all the nodes will agree in the same deliver order, for example, <em>tx1</em> followed by <em>tx2</em> . Then, each node delivers <em>tx1</em> , perform the validation and commits the modifications. The same steps are performed for <em>tx2</em> but, in this case, the validation will fail and the transaction is rollback in all the involved nodes.</p> </div> </div> <div class="sect4"> <h5 id="commit_in_two_phases"><a class="anchor" href="#commit_in_two_phases"></a>Commit in two phases</h5> <div class="paragraph"> <p>In the first phase, it sends the modification in total order and the write skew check is performed. The result of the write skew check is sent back to the originator. As soon as it has the confirmation that all keys are successfully validated, it give a positive response to the <code>TransactionManager</code>. On other hand, if it receives a negative reply, it returns a negative response to the <code>TransactionManager</code>. Finally, the transaction is committed or aborted in the second phase depending of the <code>TransactionManager</code> request.</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./../../topics/images/total-order-2pc.png" alt="total order 2pc"> </div> <div class="title">Figure 4. 2-phase commit</div> </div> <div class="paragraph"> <p>The figure above shows the scenario described in the first figure but now committing the transactions using two phases. When <em>tx1</em> is deliver, it performs the validation and it replies to the <code>TransactionManager</code>. Next, lets assume that <em>tx2</em> is deliver before the <code>TransactionManager</code> request the second phase for <em>tx1</em>. In this case, <em>tx2</em> will be enqueued and it will be validated only when <em>tx1</em> is completed. Eventually, the <code>TransactionManager</code> for <em>tx1</em> will request the second phase (the commit) and all the nodes are free to perform the validation of <em>tx2</em> .</p> </div> </div> <div class="sect4"> <h5 id="transaction_recovery"><a class="anchor" href="#transaction_recovery"></a>Transaction Recovery</h5> <div class="paragraph"> <p><a href="#tx_recovery">Transaction recovery</a> is currently not available for Total Order based commit protocol.</p> </div> </div> <div class="sect4"> <h5 id="state_transfer"><a class="anchor" href="#state_transfer"></a>State Transfer</h5> <div class="paragraph"> <p>For simplicity reasons, the total order based commit protocol uses a blocking version of the current state transfer. The main differences are:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>enqueue the transaction deliver while the state transfer is in progress;</p> </li> <li> <p>the state transfer control messages (<code>CacheTopologyControlCommand</code>) are sent in total order.</p> </li> </ol> </div> <div class="paragraph"> <p>This way, it provides a synchronization between the state transfer and the transactions deliver that is the same all the nodes. Although, the transactions caught in the middle of state transfer (i.e. sent before the state transfer start and deliver after it) needs to be re-sent to find a new total order involving the new joiners.</p> </div> <div class="imageblock text-center"> <div class="content"> <img src="./../../topics/images/total-order-joing-during-st.png" alt="total order joing during st"> </div> <div class="title">Figure 5. Node joining during transaction</div> </div> <div class="paragraph"> <p>The figure above describes a node joining. In the scenario, the <em>tx2</em> is sent in <em>topologyId=1</em> but when it is received, it is in <em>topologyId=2</em> . So, the transaction is re-sent involving the new nodes.</p> </div> </div> </div> <div class="sect3"> <h4 id="configuration_2"><a class="anchor" href="#configuration_2"></a>14.9.2. Configuration</h4> <div class="paragraph"> <p>To use total order in your cache, you need to add the <code>TOA</code> protocol in your <code>jgroups.xml</code> configuration file.</p> </div> <div class="listingblock"> <div class="title">jgroups.xml</div> <div class="content"> <pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;tom.TOA</span> <span class="tag">/&gt;</span></code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> Check the <a href="http://jgroups.org/manual-3.x/html/index.html">JGroups Manual</a> for more details. </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> If you are interested in detail how JGroups guarantees total order, check the link::http://jgroups.org/manual/index.html#TOA[TOA manual]. </td> </tr> </table> </div> <div class="paragraph"> <p>Also, you need to set the <code>protocol=TOTAL_ORDER</code> in the <code>&lt;transaction&gt;</code> element, as shown in <a href="#tx_configuration">Transaction configuration</a>.</p> </div> </div> <div class="sect3"> <h4 id="when_to_use_it"><a class="anchor" href="#when_to_use_it"></a>14.9.3. When to use it?</h4> <div class="paragraph"> <p>Total order shows benefits when used in write intensive and high contented workloads. It avoids contention in the lock keys.</p> </div> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2019-09-15 07:35:22 UTC </div> </div> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script> <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script> </body> </html>