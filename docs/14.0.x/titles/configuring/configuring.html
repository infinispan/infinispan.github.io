<!DOCTYPE html>
<html lang="en">
<head><meta name="robots" content="noindex">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Configuring Infinispan caches</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="canonical" href="https://infinispan.org/docs/stable/titles/configuring/configuring.html">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css">
<link rel="stylesheet" href="../../css/css.css">
<link rel="stylesheet" href="/assets/css/clipboard.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script>
<script src="../../js/js.js"></script>
<script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
<script src="/assets/javascript/copy.js" type="text/javascript"></script>
<style>
.hidden {
    display: none;
}

.switch {
    border-width: 1px 1px 0 1px;
    border-style: solid;
    border-color: #7a2518;
    display: inline-block;
}

.switch--item {
    padding: 10px;
    background-color: #ffffff;
    color: #7a2518;
    display: inline-block;
    cursor: pointer;
}

.switch--item.selected {
    background-color: #7a2519;
    color: #ffffff;
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script type="text/javascript">
function addBlockSwitches() {
    $('.primary').each(function() {
        primary = $(this);
        createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
        primary.children('.title').remove();
    });
    $('.secondary').each(function(idx, node) {
        secondary = $(node);
        primary = findPrimary(secondary);
        switchItem = createSwitchItem(secondary, primary.children('.switch'));
        switchItem.content.addClass('hidden');
        findPrimary(secondary).append(switchItem.content);
        secondary.remove();
    });
}

function createBlockSwitch(primary) {
    blockSwitch = $('<div class="switch"></div>');
    primary.prepend(blockSwitch);
    return blockSwitch;
}

function findPrimary(secondary) {
    candidate = secondary.prev();
    while (!candidate.is('.primary')) {
        candidate = candidate.prev();
    }
    return candidate;
}

function createSwitchItem(block, blockSwitch) {
    blockName = block.children('.title').text();
    content = block.children('.content').first().append(block.next('.colist'));
    item = $('<div class="switch--item">' + blockName + '</div>');
    item.on('click', '', content, function(e) {
        $(this).addClass('selected');
        $(this).siblings().removeClass('selected');
        e.data.siblings('.content').addClass('hidden');
        e.data.removeClass('hidden');
    });
    blockSwitch.append(item);
    return {'item': item, 'content': content};
}

$(addBlockSwitches);

</script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Configuring Infinispan caches</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#caches">1. Infinispan caches</a>
<ul class="sectlevel2">
<li><a href="#cache-interface_caches">1.1. Cache API</a></li>
<li><a href="#cache-managers_caches">1.2. Cache Managers</a></li>
<li><a href="#cache-modes_caches">1.3. Cache modes</a>
<ul class="sectlevel3">
<li><a href="#cache-mode-comparison_caches">1.3.1. Comparison of cache modes</a></li>
</ul>
</li>
<li><a href="#local-caches_caches">1.4. Local caches</a>
<ul class="sectlevel3">
<li><a href="#simple-caches_caches">1.4.1. Simple caches</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#clustered-caches">2. Clustered caches</a>
<ul class="sectlevel2">
<li><a href="#replicated-caches_clustered-caches">2.1. Replicated caches</a></li>
<li><a href="#distributed-caches_clustered-caches">2.2. Distributed caches</a>
<ul class="sectlevel3">
<li><a href="#read-consistency_clustered-caches">2.2.1. Read consistency</a></li>
<li><a href="#key-ownership_clustered-caches">2.2.2. Key ownership</a></li>
<li><a href="#capacity-factors_clustered-caches">2.2.3. Capacity factors</a>
<ul class="sectlevel4">
<li><a href="#zero-capacity-nodes_clustered-caches">Zero capacity nodes</a></li>
</ul>
</li>
<li><a href="#level-one-caches_clustered-caches">2.2.4. Level one (L1) caches</a></li>
<li><a href="#server-hinting_clustered-caches">2.2.5. Server hinting</a></li>
<li><a href="#key-affinity-service_clustered-caches">2.2.6. Key affinity service</a></li>
<li><a href="#grouping-api_clustered-caches">2.2.7. Grouping API</a></li>
</ul>
</li>
<li><a href="#invalidation-caches_clustered-caches">2.3. Invalidation caches</a></li>
<li><a href="#scattered-caches_clustered-caches">2.4. Scattered caches</a></li>
<li><a href="#asynchronous-replication_clustered-caches">2.5. Asynchronous replication</a>
<ul class="sectlevel3">
<li><a href="#asynchronous-return-values_clustered-caches">2.5.1. Return values with asynchronous replication</a></li>
</ul>
</li>
<li><a href="#configuring-initial-cluster-size_clustered-caches">2.6. Configuring initial cluster size</a></li>
</ul>
</li>
<li><a href="#cache-configuration">3. Infinispan cache configuration</a>
<ul class="sectlevel2">
<li><a href="#declarative-cache-configuration_cache-configuration">3.1. Declarative cache configuration</a>
<ul class="sectlevel3">
<li><a href="#cache-configuration_cache-configuration">3.1.1. Cache configuration</a></li>
</ul>
</li>
<li><a href="#adding-cache-configuration-templates_cache-configuration">3.2. Adding cache templates</a>
<ul class="sectlevel3">
<li><a href="#creating-caches-templates_cache-configuration">3.2.1. Creating caches from templates</a></li>
<li><a href="#cache-templates_cache-configuration">3.2.2. Cache template inheritance</a></li>
<li><a href="#cache-wildcards-cache-configuration">3.2.3. Cache template wildcards</a></li>
<li><a href="#cache-template-xinclude_cache-configuration">3.2.4. Cache templates from multiple XML files</a></li>
</ul>
</li>
<li><a href="#creating-remote-caches">3.3. Creating remote caches</a>
<ul class="sectlevel3">
<li><a href="#default-cache-manager-creating-remote-caches">3.3.1. Default Cache Manager</a></li>
<li><a href="#creating-caches-console_creating-remote-caches">3.3.2. Creating caches with Infinispan Console</a></li>
<li><a href="#creating-caches-cli_creating-remote-caches">3.3.3. Creating remote caches with the Infinispan CLI</a></li>
<li><a href="#creating-caches-hotrod_creating-remote-caches">3.3.4. Creating remote caches from Hot Rod clients</a></li>
<li><a href="#creating-caches-rest_creating-remote-caches">3.3.5. Creating remote caches with the REST API</a></li>
</ul>
</li>
<li><a href="#creating-embedded-caches">3.4. Creating embedded caches</a>
<ul class="sectlevel3">
<li><a href="#installing-embedded_creating-embedded-caches">3.4.1. Adding Infinispan to your project</a></li>
<li><a href="#configuring-embedded-caches_creating-embedded-caches">3.4.2. Creating and using embedded caches</a></li>
<li><a href="#cache-modes_creating-embedded-caches">3.4.3. Cache API</a>
<ul class="sectlevel4">
<li><a href="#advancedcache_api">AdvancedCache API</a>
<ul class="sectlevel5">
<li><a href="#flags">Flags</a></li>
</ul>
</li>
<li><a href="#cache_asynchronous_api">Asynchronous API</a>
<ul class="sectlevel5">
<li><a href="#why_use_such_an_api">Why use such an API?</a></li>
<li><a href="#which_processes_actually_happen_asynchronously">Which processes actually happen asynchronously?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#statistics-jmx">4. Enabling and configuring Infinispan statistics and JMX monitoring</a>
<ul class="sectlevel2">
<li><a href="#enabling-statistics-embedded_statistics-jmx">4.1. Enabling statistics in embedded caches</a></li>
<li><a href="#enabling-statistics-remote_statistics-jmx">4.2. Enabling statistics in remote caches</a></li>
<li><a href="#enabling-hotrod-client-statistics_statistics-jmx">4.3. Enabling Hot Rod client statistics</a></li>
<li><a href="#configuring-metrics_statistics-jmx">4.4. Configuring Infinispan metrics</a></li>
<li><a href="#enabling-jmx_statistics-jmx">4.5. Registering JMX MBeans</a>
<ul class="sectlevel3">
<li><a href="#enabling-jmx-port_statistics-jmx">4.5.1. Enabling JMX remote ports</a></li>
<li><a href="#jmx-mbeans_statistics-jmx">4.5.2. Infinispan MBeans</a></li>
<li><a href="#registering-jmx-mbean-servers-statistics-jmx">4.5.3. Registering MBeans in custom MBean servers</a></li>
</ul>
</li>
<li><a href="#displaying-metrics-state-transfer_statistics-jmx">4.6. Exporting metrics during a state transfer operation</a></li>
<li><a href="#monitor-xsite-replication">4.7. Monitoring the status of cross-site replication</a></li>
</ul>
</li>
<li><a href="#configuring-memory-usage">5. Configuring JVM memory usage</a>
<ul class="sectlevel2">
<li><a href="#default-memory_configuring-memory-usage">5.1. Default memory configuration</a></li>
<li><a href="#eviction-and-expiration_configuring-memory-usage">5.2. Eviction and expiration</a></li>
<li><a href="#eviction_configuring-memory-usage">5.3. Eviction with Infinispan caches</a>
<ul class="sectlevel3">
<li><a href="#eviction-strategies_configuring-memory-usage">5.3.1. Eviction strategies</a></li>
<li><a href="#configuring-eviction-total-entries_configuring-memory-usage">5.3.2. Configuring maximum count eviction</a></li>
<li><a href="#configuring-eviction-maximum-size_configuring-memory-usage">5.3.3. Configuring maximum size eviction</a></li>
<li><a href="#eviction-manual_configuring-memory-usage">5.3.4. Manual eviction</a></li>
<li><a href="#eviction-passivation_configuring-memory-usage">5.3.5. Passivation with eviction</a></li>
</ul>
</li>
<li><a href="#expiration_configuring-memory-usage">5.4. Expiration with lifespan and maximum idle</a>
<ul class="sectlevel3">
<li><a href="#how-expiration-works_configuring-memory-usage">5.4.1. How expiration works</a></li>
<li><a href="#expiration-reaper_configuring-memory-usage">5.4.2. Expiration reaper</a></li>
<li><a href="#expiration-maxidle_configuring-memory-usage">5.4.3. Maximum idle and clustered caches</a></li>
<li><a href="#configuring-expiration-for-caches_configuring-memory-usage">5.4.4. Configuring lifespan and maximum idle times for caches</a></li>
<li><a href="#configuring-expiration-per-entry_configuring-memory-usage">5.4.5. Configuring lifespan and maximum idle times per entry</a></li>
</ul>
</li>
<li><a href="#off-heap-memory_configuring-memory-usage">5.5. JVM heap and off-heap memory</a>
<ul class="sectlevel3">
<li><a href="#off-heap-storage_configuring-memory-usage">5.5.1. Off-heap data storage</a></li>
<li><a href="#configuring-memory-off-heap_configuring-memory-usage">5.5.2. Configuring off-heap memory</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#persistence">6. Configuring persistent storage</a>
<ul class="sectlevel2">
<li><a href="#passivation_persistence">6.1. Passivation</a>
<ul class="sectlevel3">
<li><a href="#how-passivation-works_persistence">6.1.1. How passivation works</a></li>
</ul>
</li>
<li><a href="#write-through_persistence">6.2. Write-through cache stores</a></li>
<li><a href="#write-behind_persistence">6.3. Write-behind cache stores</a></li>
<li><a href="#segmented-cache-stores_persistence">6.4. Segmented cache stores</a></li>
<li><a href="#shared-cache-stores_persistence">6.5. Shared cache stores</a></li>
<li><a href="#cache-loaders-transactional_persistence">6.6. Transactions with persistent cache stores</a></li>
<li><a href="#global-persistent-location_persistence">6.7. Global persistent location</a>
<ul class="sectlevel3">
<li><a href="#configuring-global-persistent-location_persistence">6.7.1. Configuring the global persistent location</a></li>
</ul>
</li>
<li><a href="#file-stores_persistence">6.8. File-based cache stores</a>
<ul class="sectlevel3">
<li><a href="#configuring-file-stores_persistence">6.8.1. Configuring file-based cache stores</a></li>
<li><a href="#configuring-single-file-stores_persistence">6.8.2. Configuring single file cache stores</a></li>
</ul>
</li>
<li><a href="#jdbc-connection-factories_persistence">6.9. JDBC connection factories</a>
<ul class="sectlevel3">
<li><a href="#configuring-server-datasources_persistence">6.9.1. Configuring managed datasources</a>
<ul class="sectlevel4">
<li><a href="#configuring-caches-with-jndi-names_persistence">Configuring caches with JNDI names</a></li>
<li><a href="#server-connection-pool-properties_persistence">Connection pool tuning properties</a></li>
</ul>
</li>
<li><a href="#configuring-jdbc-agroal-properties_persistence">6.9.2. Configuring JDBC connection pools with Agroal properties</a></li>
</ul>
</li>
<li><a href="#sql-cache-store_persistence">6.10. SQL cache stores</a>
<ul class="sectlevel3">
<li><a href="#sql-store-data-types_persistence">6.10.1. Data types for keys and values</a>
<ul class="sectlevel4">
<li><a href="#sql-store-composite-keys-values_persistence">Composite keys and values</a></li>
<li><a href="#sql-store-embedded-keys_persistence">Embedded keys</a></li>
<li><a href="#sql-store-protobuf-types_persistence">SQL types to Protobuf types</a></li>
</ul>
</li>
<li><a href="#configuring-sql-cache-stores-table_persistence">6.10.2. Loading Infinispan caches from database tables</a></li>
<li><a href="#configuring-sql-cache-stores-query_persistence">6.10.3. Using SQL queries to load data and perform operations</a>
<ul class="sectlevel4">
<li><a href="#sql-store-query-configuration_persistence">SQL query store configuration</a></li>
</ul>
</li>
<li><a href="#sql-cache-store-troubleshooting_persistence">6.10.4. SQL cache store troubleshooting</a></li>
</ul>
</li>
<li><a href="#jdbc-cache-store_persistence">6.11. JDBC string-based cache stores</a>
<ul class="sectlevel3">
<li><a href="#configuring-jdbc-cache-stores_persistence">6.11.1. Configuring JDBC string-based cache stores</a></li>
</ul>
</li>
<li><a href="#rocksdb-cache-store_persistence">6.12. RocksDB cache stores</a></li>
<li><a href="#remote-cache-store_persistence">6.13. Remote cache stores</a></li>
<li><a href="#cluster-cache-loader_persistence">6.14. Cluster cache loaders</a></li>
<li><a href="#creating-custom-cache-stores">6.15. Creating custom cache store implementations</a>
<ul class="sectlevel3">
<li><a href="#persistent-spi_custom-cache-stores">6.15.1. Infinispan Persistence SPI</a></li>
<li><a href="#creating-custom-cache-stores_custom-cache-stores">6.15.2. Creating cache stores</a></li>
<li><a href="#custom-cache-store-configuration_custom-cache-stores">6.15.3. Examples of custom cache store configuration</a></li>
<li><a href="#deploying-custom-cache-stores_custom-cache-stores">6.15.4. Deploying custom cache stores</a></li>
</ul>
</li>
<li><a href="#cache-store-migrator">6.16. Migrating data between cache stores</a>
<ul class="sectlevel3">
<li><a href="#store-migrator_cache-store-migrator">6.16.1. Cache store migrator</a></li>
<li><a href="#getting-store-migrator_cache-store-migrator">6.16.2. Getting the cache store migrator</a></li>
<li><a href="#configuring-store-migrator_cache-store-migrator">6.16.3. Configuring the cache store migrator</a>
<ul class="sectlevel4">
<li><a href="#store-migrator-properties_cache-store-migrator">Configuration properties for the cache store migrator</a></li>
</ul>
</li>
<li><a href="#migrating-cache-stores_cache-store-migrator">6.16.4. Migrating Infinispan cache stores</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#partition-handling">7. Configuring Infinispan to handle network partitions</a>
<ul class="sectlevel2">
<li><a href="#partition-handling_partition-handling">7.1. Split clusters and network partitions</a>
<ul class="sectlevel3">
<li><a href="#partition-handling-data-consistency_partition-handling">7.1.1. Data consistency in a split cluster</a></li>
</ul>
</li>
<li><a href="#partition-handling-degraded-mode_partition-handling">7.2. Cache availability and degraded mode</a>
<ul class="sectlevel3">
<li><a href="#degraded-mode-example_partition-handling">7.2.1. Degraded cache recovery example</a></li>
<li><a href="#checking-cache-availability_partition-handling">7.2.2. Verifying cache availability during network partitions</a></li>
<li><a href="#making-caches-available_partition-handling">7.2.3. Making caches available</a></li>
</ul>
</li>
<li><a href="#configuring-partition-handling_partition-handling">7.3. Configuring partition handling</a></li>
<li><a href="#partition-handling-strategies_partition-handling">7.4. Partition handling strategies</a></li>
<li><a href="#partition-handling-merge-policies_partition-handling">7.5. Merge policies</a></li>
<li><a href="#configuring-custom-merge-policies_partition-handling">7.6. Configuring custom merge policies</a></li>
<li><a href="#merging-partitions-manually_partition-handling">7.7. Manually merging partitions in embedded caches</a></li>
</ul>
</li>
<li><a href="#security-authorization">8. Security authorization with role-based access control</a>
<ul class="sectlevel2">
<li><a href="#default-user-roles_security-authorization">8.1. Infinispan user roles and permissions</a>
<ul class="sectlevel3">
<li><a href="#user-permissions_security-authorization">8.1.1. Permissions</a></li>
<li><a href="#role-mappers_security-authorization">8.1.2. Role and permission mappers</a>
<ul class="sectlevel4">
<li><a href="#mapping_users_to_roles_and_permissions_in_infinispan">Mapping users to roles and permissions in Infinispan</a></li>
</ul>
</li>
<li><a href="#configuring-role-mappers_security-authorization">8.1.3. Configuring role mappers</a></li>
</ul>
</li>
<li><a href="#configuring-cache-authorization_security-authorization">8.2. Configuring caches with security authorization</a></li>
</ul>
</li>
<li><a href="#transactions">9. Configuring transactions</a>
<ul class="sectlevel2">
<li><a href="#transaction_manager">9.1. Transactions</a>
<ul class="sectlevel3">
<li><a href="#tx_configuration">9.1.1. Configuring transactions</a></li>
<li><a href="#tx_isolation_levels">9.1.2. Isolation levels</a></li>
<li><a href="#tx_locking">9.1.3. Transaction locking</a>
<ul class="sectlevel4">
<li><a href="#pessimistic_transactional_cache">Pessimistic transactional cache</a></li>
<li><a href="#optimistic_transactional_cache">Optimistic transactional cache</a></li>
<li><a href="#what_do_i_need_pessimistic_or_optimistic_transactions">What do I need - pessimistic or optimistic transactions?</a></li>
</ul>
</li>
<li><a href="#tx_write_skew">9.1.4. Write Skews</a>
<ul class="sectlevel4">
<li><a href="#forcing_write_locks_on_keys_in_pessimitic_transactions">Forcing write locks on keys in pessimitic transactions</a></li>
</ul>
</li>
<li><a href="#dealing_with_exceptions">9.1.5. Dealing with exceptions</a></li>
<li><a href="#tx_sync_enlist">9.1.6. Enlisting Synchronizations</a></li>
<li><a href="#tx_batching">9.1.7. Batching</a>
<ul class="sectlevel4">
<li><a href="#api">API</a></li>
<li><a href="#batching_and_jta">Batching and JTA</a></li>
</ul>
</li>
<li><a href="#tx_recovery">9.1.8. Transaction recovery</a>
<ul class="sectlevel4">
<li><a href="#when_to_use_recovery">When to use recovery</a></li>
<li><a href="#how_does_it_work">How does it work</a></li>
<li><a href="#configuring_recovery">Configuring recovery   </a>
<ul class="sectlevel5">
<li><a href="#enable_jmx_support">Enable JMX support</a></li>
</ul>
</li>
<li><a href="#recovery_cache">Recovery cache</a></li>
<li><a href="#integration_with_the_transaction_manager">Integration with the transaction manager</a></li>
<li><a href="#tx_recovery_reconciliation">Reconciliation</a>
<ul class="sectlevel5">
<li><a href="#force_commitrollback_based_on_xid">Force commit/rollback based on XID</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#locking">10. Configuring locking and concurrency</a>
<ul class="sectlevel2">
<li><a href="#locking-concurrency_locking">10.1. Locking and concurrency</a>
<ul class="sectlevel3">
<li><a href="#clustered_caches_and_locks">10.1.1. Clustered caches and locks</a></li>
<li><a href="#the_lockmanager">10.1.2. The LockManager</a></li>
<li><a href="#lock_striping">10.1.3. Lock striping</a></li>
<li><a href="#concurrency_levels">10.1.4. Concurrency levels</a></li>
<li><a href="#lock_timeout">10.1.5. Lock timeout</a></li>
<li><a href="#consistency">10.1.6. Consistency</a></li>
<li><a href="#data_versioning">10.1.7. Data Versioning</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#clustered-counters">11. Using clustered counters</a>
<ul class="sectlevel2">
<li><a href="#clustered-counters_clustered-counters">11.1. Clustered Counters</a>
<ul class="sectlevel3">
<li><a href="#installation_and_configuration">11.1.1. Installation and Configuration</a>
<ul class="sectlevel4">
<li><a href="#list_counter_names">List counter names</a></li>
</ul>
</li>
<li><a href="#countermanager_interface">11.1.2. <code>CounterManager</code> interface</a>
<ul class="sectlevel4">
<li><a href="#remove_a_counter_via_countermanager">Remove a counter via CounterManager</a></li>
</ul>
</li>
<li><a href="#the_counter">11.1.3. The Counter</a>
<ul class="sectlevel4">
<li><a href="#the_strongcounter_interface_when_the_consistency_or_bounds_matters">The <code>StrongCounter</code> interface: when the consistency or bounds matters.</a>
<ul class="sectlevel5">
<li><a href="#bounded_strongcounter">Bounded <code>StrongCounter</code></a></li>
<li><a href="#uses_cases">Uses cases</a></li>
<li><a href="#usage_examples">Usage Examples</a></li>
</ul>
</li>
<li><a href="#the_weakcounter_interface_when_speed_is_needed">The <code>WeakCounter</code> interface: when speed is needed</a>
<ul class="sectlevel5">
<li><a href="#weak_counter_interface">Weak Counter Interface</a></li>
<li><a href="#uses_cases_2">Uses cases</a></li>
<li><a href="#examples">Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#clustered_counters_notify_events">11.1.4. Notifications and Events</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#listeners-notifications">12. Listeners and notifications</a>
<ul class="sectlevel2">
<li><a href="#listeners-and-notifications_listeners-notifications">12.1. Listeners and notifications</a></li>
<li><a href="#cache-notifications_listeners-notifications">12.2. Cache-level notifications</a></li>
<li><a href="#cache-manager-notifications_listeners-notifications">12.3. Cache Manager notifications</a></li>
<li><a href="#event-synchronicity_listeners-notifications">12.4. Synchronicity of events</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Create and configure Infinispan caches with the mode and capabilities that suit your application requirements.
You can configure caches with expiration to remove stale entries or use eviction to control cache size.
You can also add persistent storage to caches, enable partition handling for clustered caches, set up transactions, and more.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="caches"><a class="anchor" href="#caches"></a>1. Infinispan caches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan caches provide flexible, in-memory data stores that you can configure to suit use cases such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Boosting application performance with high-speed local caches.</p>
</li>
<li>
<p>Optimizing databases by decreasing the volume of write operations.</p>
</li>
<li>
<p>Providing resiliency and durability for consistent data across clusters.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="cache-interface_caches"><a class="anchor" href="#cache-interface_caches"></a>1.1. Cache API</h3>
<div class="paragraph">
<p><code>Cache&lt;K,V&gt;</code> is the central interface for Infinispan and extends <code>java.util.concurrent.ConcurrentMap</code>.</p>
</div>
<div class="paragraph">
<p>Cache entries are highly concurrent data structures in <code>key:value</code> format that support a wide and configurable range of data types, from simple strings to much more complex objects.</p>
</div>
</div>
<div class="sect2">
<h3 id="cache-managers_caches"><a class="anchor" href="#cache-managers_caches"></a>1.2. Cache Managers</h3>
<div class="paragraph">
<p>The <code>CacheManager</code> API is the entry point for interacting with Infinispan.
Cache Managers control cache lifecycle; creating, modifying, and deleting cache instances.
Cache Managers also provide cluster management and monitoring along with the ability to execute code across nodes.</p>
</div>
<div class="paragraph">
<p>Infinispan provides two <code>CacheManager</code> implementations:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>EmbeddedCacheManager</code></dt>
<dd>
<p>Entry point for caches when running Infinispan inside the same Java Virtual Machine (JVM) as the client application.</p>
</dd>
<dt class="hdlist1"><code>RemoteCacheManager</code></dt>
<dd>
<p>Entry point for caches when running Infinispan Server in its own JVM. When you instantiate a <code>RemoteCacheManager</code> it establishes a persistent TCP connection to Infinispan Server through the Hot Rod endpoint.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Both embedded and remote <code>CacheManager</code> implementations share some methods and properties.
However, semantic differences do exist between <code>EmbeddedCacheManager</code> and <code>RemoteCacheManager</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="cache-modes_caches"><a class="anchor" href="#cache-modes_caches"></a>1.3. Cache modes</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan Cache Managers can create and control multiple caches that use
different modes. For example, you can use the same Cache Manager for local
caches, distributed caches, and caches with invalidation mode.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Local</dt>
<dd>
<p>Infinispan runs as a single node and never replicates read or write operations on cache entries.</p>
</dd>
<dt class="hdlist1">Replicated</dt>
<dd>
<p>Infinispan replicates all cache entries on all nodes in a cluster and performs local read operations only.</p>
</dd>
<dt class="hdlist1">Distributed</dt>
<dd>
<p>Infinispan replicates cache entries on a subset of nodes in a cluster and assigns entries to fixed owner nodes.<br>
Infinispan requests read operations from owner nodes to ensure it returns the correct value.</p>
</dd>
<dt class="hdlist1">Invalidation</dt>
<dd>
<p>Infinispan evicts stale data from all nodes whenever operations modify entries in the cache. Infinispan performs local read operations only.</p>
</dd>
<dt class="hdlist1">Scattered</dt>
<dd>
<p>Infinispan stores cache entries across a subset of nodes.<br>
By default Infinispan assigns a primary owner and a backup owner to each cache entry in scattered caches.<br>
Infinispan assigns primary owners in the same way as with distributed caches, while backup owners are always the nodes that initiate the write operations.<br>
Infinispan requests read operations from at least one owner node to ensure it returns the correct value.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="cache-mode-comparison_caches"><a class="anchor" href="#cache-mode-comparison_caches"></a>1.3.1. Comparison of cache modes</h4>
<div class="paragraph">
<p>The cache mode that you should choose depends on the qualities and guarantees you need for your data.</p>
</div>
<div class="paragraph">
<p>The following table summarizes the primary differences between cache modes:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 13.6363%;">
<col style="width: 13.6363%;">
<col style="width: 13.6363%;">
<col style="width: 13.6363%;">
<col style="width: 13.6363%;">
<col style="width: 13.6367%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-center valign-top">Simple</th>
<th class="tableblock halign-center valign-top">Local</th>
<th class="tableblock halign-center valign-top">Invalidation</th>
<th class="tableblock halign-center valign-top">Replicated</th>
<th class="tableblock halign-center valign-top">Distributed</th>
<th class="tableblock halign-center valign-top">Scattered</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clustered</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">No</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">No</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Yes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Yes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Yes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Yes</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read performance</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Highest</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">High</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">High</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">High</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Medium</strong><br>
(owners)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Medium</strong><br>
(primary)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write performance</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Highest</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">High</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Low</strong><br>
(all nodes, no data)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Lowest</strong><br>
(all nodes)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Medium</strong><br>
(owner nodes)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Higher</strong><br>
(single RPC)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Capacity</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Smallest node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Cluster</strong><br>
\$(sum_(i=1)^"nodes""node_capacity")/"owners"\$</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Cluster</strong><br>
\$(sum_(i=1)^"nodes""node_capacity")/"2"\$</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Availability</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All nodes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Owner nodes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Owner nodes</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Features</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">No TX, persistence, indexing</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">No indexing</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">No TX</strong></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="local-caches_caches"><a class="anchor" href="#local-caches_caches"></a>1.4. Local caches</h3>
<div class="paragraph">
<p>Infinispan offers a local cache mode that is similar to a <code>ConcurrentHashMap</code>.</p>
</div>
<div class="paragraph">
<p>Caches offer more capabilities than simple maps, including write-through and
write-behind to persistent storage as well as management capabilities such as eviction and expiration.</p>
</div>
<div class="paragraph">
<p>The Infinispan <code>Cache</code> API extends the <code>ConcurrentMap</code> API in Java, making it easy to migrate from a map to a Infinispan cache.</p>
</div>
<h4 id="local_cache_configuration" class="discrete">Local cache configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;local-cache name="mycache"
             statistics="true"&gt;
  &lt;encoding media-type="application/x-protostream"/&gt;
&lt;/local-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "local-cache": {
    "name": "mycache",
    "statistics": "true",
    "encoding": {
      "media-type": "application/x-protostream"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">localCache:
  name: "mycache"
  statistics: "true"
  encoding:
    mediaType: "application/x-protostream"</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="simple-caches_caches"><a class="anchor" href="#simple-caches_caches"></a>1.4.1. Simple caches</h4>
<div class="paragraph">
<p>A simple cache is a type of local cache that disables support for the following capabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Transactions and invocation batching</p>
</li>
<li>
<p>Persistent storage</p>
</li>
<li>
<p>Custom interceptors</p>
</li>
<li>
<p>Indexing</p>
</li>
<li>
<p>Transcoding</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, you can use other Infinispan capabilities with simple caches such as expiration, eviction, statistics, and security features.
If you configure a capability that is not compatible with a simple cache, Infinispan throws an exception.</p>
</div>
<h5 id="simple_cache_configuration" class="discrete">Simple cache configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;local-cache simple-cache="true" /&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "local-cache" : {
    "simple-cache" : "true"
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">localCache:
  simpleCache: "true"</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clustered-caches"><a class="anchor" href="#clustered-caches"></a>2. Clustered caches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can create embedded and remote caches on Infinispan clusters that replicate data across nodes.</p>
</div>
<div class="sect2">
<h3 id="replicated-caches_clustered-caches"><a class="anchor" href="#replicated-caches_clustered-caches"></a>2.1. Replicated caches</h3>
<div class="paragraph">
<p>Infinispan replicates all entries in the cache to all nodes in the cluster.
Each node can perform read operations locally.</p>
</div>
<div class="paragraph">
<p>Replicated caches provide a quick and easy way to share state across a cluster, but is suitable for clusters of less than ten nodes.
Because the number of replication requests scales linearly with the number of nodes in the cluster, using replicated caches with larger clusters reduces performance.
However you can use UDP multicasting for replication requests to improve performance.</p>
</div>
<div class="paragraph">
<p>Each key has a primary owner, which serializes data container updates in order to provide consistency.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/replicated_cache_ispn.png" alt="replicated cache ispn">
</div>
<div class="title">Figure 1. Replicated cache</div>
</div>
<div class="ulist">
<div class="title">Synchronous or asynchronous replication</div>
<ul>
<li>
<p>Synchronous replication blocks the caller (e.g. on a <code>cache.put(key, value)</code>) until the modifications have been replicated successfully to all the nodes in the cluster.</p>
</li>
<li>
<p>Asynchronous replication performs replication in the background, and write operations return immediately.
Asynchronous replication is not recommended, because communication errors, or errors that happen on remote nodes are not reported to the caller.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Transactions</div>
<p>If transactions are enabled, write operations are not replicated through the primary owner.</p>
</div>
<div class="paragraph">
<p>With pessimistic locking, each write triggers a lock message, which is broadcast to all the nodes.
During transaction commit, the originator broadcasts a one-phase prepare message and an unlock message (optional).
Either the one-phase prepare or the unlock message is fire-and-forget.</p>
</div>
<div class="paragraph">
<p>With optimistic locking, the originator broadcasts a prepare message, a commit message, and an unlock message (optional).
Again, either the one-phase prepare or the unlock message is fire-and-forget.</p>
</div>
</div>
<div class="sect2">
<h3 id="distributed-caches_clustered-caches"><a class="anchor" href="#distributed-caches_clustered-caches"></a>2.2. Distributed caches</h3>
<div class="paragraph">
<p>Infinispan attempts to keep a fixed number of copies of any entry in the cache,
configured as <code>numOwners</code>.
This allows distributed caches to scale linearly, storing more data as nodes are added to the cluster.</p>
</div>
<div class="paragraph">
<p>As nodes join and leave the cluster, there will be times when a key has more or less than <code>numOwners</code> copies.
In particular, if <code>numOwners</code> nodes leave in quick succession, some entries will be lost, so we say that a distributed cache tolerates <code>numOwners - 1</code> node failures.</p>
</div>
<div class="paragraph">
<p>The number of copies represents a trade-off between performance and durability of data.
The more copies you maintain, the lower performance will be, but also the lower the risk of losing data due to server or network failures.</p>
</div>
<div class="paragraph">
<p>Infinispan splits the owners of a key into one <strong>primary owner</strong>, which coordinates writes to the key, and zero or more <strong>backup owners</strong>.</p>
</div>
<div class="paragraph">
<p>The following diagram shows a write operation that a client sends to a backup owner.
In this case the backup node forwards the write to the primary owner, which then replicates the write to the backup.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/replication_ispn.png" alt="replication ispn">
</div>
<div class="title">Figure 2. Cluster replication</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/distributed_cache_ispn.png" alt="distributed cache ispn">
</div>
<div class="title">Figure 3. Distributed cache</div>
</div>
<div class="paragraph">
<div class="title">Read operations</div>
<p>Read operations request the value from the primary owner.
If the primary owner does not respond in a reasonable amount of time, Infinispan requests the value from the backup owners as well.</p>
</div>
<div class="paragraph">
<p>A read operation may require <code>0</code> messages if the key is present in the local cache, or up to <code>2 * numOwners</code> messages if all the owners are slow.</p>
</div>
<div class="paragraph">
<div class="title">Write operations</div>
<p>Write operations result in at most <code>2 * numOwners</code> messages.
One message from the originator to the primary owner and <code>numOwners - 1</code> messages from the primary to the backup nodes along with the corresponding acknowledgment messages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Cache topology changes may cause retries and additional messages for both read and write operations.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Synchronous or asynchronous replication</div>
<p>Asynchronous replication is not recommended because it can lose updates.
In addition to losing updates, asynchronous distributed caches can also see a stale value when a thread writes to a key and then immediately reads the same key.</p>
</div>
<div class="paragraph">
<div class="title">Transactions</div>
<p>Transactional distributed caches send lock/prepare/commit/unlock messages to the affected nodes only, meaning all nodes that own at least one key affected by the transaction.
As an optimization, if the transaction writes to a single key and the originator is the primary owner of the key, lock messages are not replicated.</p>
</div>
<div class="sect3">
<h4 id="read-consistency_clustered-caches"><a class="anchor" href="#read-consistency_clustered-caches"></a>2.2.1. Read consistency</h4>
<div class="paragraph">
<p>Even with synchronous replication, distributed caches are not linearizable.
For transactional caches, they do not support serialization/snapshot isolation.</p>
</div>
<div class="paragraph">
<p>For example, a thread is carrying out a single put request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">cache.get(k) -&gt; v1
cache.put(k, v2)
cache.get(k) -&gt; v2</code></pre>
</div>
</div>
<div class="paragraph">
<p>But another thread might see the values in a different order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">cache.get(k) -&gt; v2
cache.get(k) -&gt; v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reason is that read can return the value from any owner, depending on how fast the primary owner replies.
The write is not atomic across all the owners.
In fact, the primary commits the update only after it receives a confirmation from the backup.
While the primary is waiting for the confirmation message from the backup, reads from the backup will see the new value, but reads from the primary will see the old one.</p>
</div>
</div>
<div class="sect3">
<h4 id="key-ownership_clustered-caches"><a class="anchor" href="#key-ownership_clustered-caches"></a>2.2.2. Key ownership</h4>
<div class="paragraph">
<p>Distributed caches split entries into a fixed number of segments and assign
each segment to a list of owner nodes.
Replicated caches do the same, with the exception that every node is an owner.</p>
</div>
<div class="paragraph">
<p>The first node in the list of owners is the <strong>primary owner</strong>.
The other nodes in the list are <strong>backup owners</strong>.
When the cache topology changes, because a node joins or leaves the cluster, the segment ownership table is broadcast to every node.
This allows nodes to locate keys without making multicast requests or maintaining metadata for each key.</p>
</div>
<div class="paragraph">
<p>The <code>numSegments</code> property configures the number of segments available.
However, the number of segments cannot change unless the cluster is restarted.</p>
</div>
<div class="paragraph">
<p>Likewise the key-to-segment mapping cannot change.
Keys must always map to the same segments regardless of cluster topology changes.
It is important that the key-to-segment mapping evenly distributes the number of segments allocated to each node while minimizing the number of segments that must move when the cluster topology changes.</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Consistent hash factory implementation</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SyncConsistentHashFactory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses an algorithm based on <a href="http://en.wikipedia.org/wiki/Consistent_hashing">consistent hashing</a>. Selected by default when server hinting is disabled.</p>
<p class="tableblock">This implementation always assigns keys to the same nodes in every cache as
long as the cluster is symmetric. In other words, all caches run on all nodes.
This implementation does have some negative points in that the load distribution is slightly uneven. It also moves more segments than strictly necessary on a join or leave.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TopologyAwareSyncConsistentHashFactory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equivalent to <code>SyncConsistentHashFactory</code> but used with server hinting to distribute data across the topology so that backed up copies of data are stored on different nodes in the topology than the primary owners. This is the default consistent hashing implementation with server hinting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DefaultConsistentHashFactory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Achieves a more even distribution than <code>SyncConsistentHashFactory</code>, but with one disadvantage. The order in which nodes join the cluster determines which nodes own which segments. As a result, keys might be assigned to different nodes in different caches.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TopologyAwareConsistentHashFactory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equivalent to <code>DefaultConsistentHashFactory</code> but used with server hinting to distribute data across the topology so that backed up copies of data are stored on different nodes in the topology than the primary owners.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ReplicatedConsistentHashFactory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used internally to implement replicated caches. You should never explicitly
select this algorithm in a distributed cache.</p></td>
</tr>
</tbody>
</table>
<h5 id="hashing_configuration" class="discrete">Hashing configuration</h5>
<div class="paragraph">
<p>You can configure <code>ConsistentHashFactory</code> implementations, including custom ones, with embedded caches only.</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache name="distributedCache"
                   owners="2"
                   segments="100"
                   capacity-factor="2" /&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">Configuration c = new ConfigurationBuilder()
   .clustering()
      .cacheMode(CacheMode.DIST_SYNC)
      .hash()
         .numOwners(2)
         .numSegments(100)
         .capacityFactor(2)
   .build();</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/distribution/ch/KeyPartitioner.html">KeyPartitioner</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="capacity-factors_clustered-caches"><a class="anchor" href="#capacity-factors_clustered-caches"></a>2.2.3. Capacity factors</h4>
<div class="paragraph">
<p>Capacity factors allocate the number of segments based on resources available to each node in the cluster.</p>
</div>
<div class="paragraph">
<p>The capacity factor for a node applies to segments for which that node is both the primary owner and backup owner.
In other words, the capacity factor specifies is the total capacity that a node has in comparison to other nodes in the cluster.</p>
</div>
<div class="paragraph">
<p>The default value is <code>1</code> which means that all nodes in the cluster have an equal capacity and Infinispan allocates the same number of segments to all nodes in the cluster.</p>
</div>
<div class="paragraph">
<p>However, if nodes have different amounts of memory available to them, you can configure the capacity factor so that the Infinispan hashing algorithm assigns each node a number of segments weighted by its capacity.</p>
</div>
<div class="paragraph">
<p>The value for the capacity factor configuration must be a positive number and can be a fraction such as 1.5.
You can also configure a capacity factor of <code>0</code> but is recommended only for nodes that join the cluster temporarily and should use the zero capacity configuration instead.</p>
</div>
<div class="sect4">
<h5 id="zero-capacity-nodes_clustered-caches"><a class="anchor" href="#zero-capacity-nodes_clustered-caches"></a>Zero capacity nodes</h5>
<div class="paragraph">
<p>You can configure nodes where the capacity factor is <code>0</code> for every cache, user defined caches, and internal caches.
When defining a zero capacity node, the node does not hold any data.</p>
</div>
<h6 id="zero_capacity_node_configuration" class="discrete">Zero capacity node configuration</h6>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container zero-capacity-node="true" /&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "zero-capacity-node" : "true"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    zeroCapacityNode: "true"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">new GlobalConfigurationBuilder().zeroCapacityNode(true);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="level-one-caches_clustered-caches"><a class="anchor" href="#level-one-caches_clustered-caches"></a>2.2.4. Level one (L1) caches</h4>
<div class="paragraph">
<p>Infinispan nodes create local replicas when they retrieve entries from another node in the cluster.
L1 caches avoid repeatedly looking up entries on primary owner nodes and adds performance.</p>
</div>
<div class="paragraph">
<p>The following diagram illustrates how L1 caches work:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/l1_cache_ispn.png" alt="l1 cache ispn">
</div>
<div class="title">Figure 4. L1 cache</div>
</div>
<div class="paragraph">
<p>In the "L1 cache" diagram:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A client invokes <code>cache.get()</code> to read an entry for which another node in the cluster is the primary owner.</p>
</li>
<li>
<p>The originator node forwards the read operation to the primary owner.</p>
</li>
<li>
<p>The primary owner returns the key/value entry.</p>
</li>
<li>
<p>The originator node creates a local copy.</p>
</li>
<li>
<p>Subsequent <code>cache.get()</code> invocations return the local entry instead of forwarding to the primary owner.</p>
</li>
</ol>
</div>
<h5 id="l1_caching_performance" class="discrete">L1 caching performance</h5>
<div class="paragraph">
<p>Enabling L1 improves performance for read operations but requires primary owner nodes to broadcast invalidation messages when entries are modified.
This ensures that Infinispan removes any out of date replicas across the cluster.
However this also decreases performance of write operations and increases memory usage, reducing overall capacity of caches.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan evicts and expires local replicas, or L1 entries, like any other cache entry.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="l1_cache_configuration" class="discrete">L1 cache configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache l1-lifespan="5000"
                   l1-cleanup-interval="60000"&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "l1-lifespan": "5000",
    "l1-cleanup-interval": "60000"
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  l1Lifespan: "5000"
  l1-cleanup-interval: "60000"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.clustering().cacheMode(CacheMode.DIST_SYNC)
         .l1()
         .lifespan(5000, TimeUnit.MILLISECONDS)
         .cleanupTaskFrequency(60000, TimeUnit.MILLISECONDS);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="server-hinting_clustered-caches"><a class="anchor" href="#server-hinting_clustered-caches"></a>2.2.5. Server hinting</h4>
<div class="paragraph">
<p>Server hinting increases availability of data in distributed caches by replicating entries across as many servers, racks, and data centers as possible.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Server hinting applies only to distributed caches.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When Infinispan distributes the copies of your data, it follows the order of precedence: site, rack, machine, and node.
All of the configuration attributes are optional.
For example, when you specify only the rack IDs, then Infinispan distributes the copies across different racks and nodes.</p>
</div>
<div class="paragraph">
<p>Server hinting can impact cluster rebalancing operations by moving more segments than necessary if the number of segments for the cache is too low.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
An alternative for clusters in multiple data centers is cross-site replication.
</td>
</tr>
</table>
</div>
<h5 id="server_hinting_configuration" class="discrete">Server hinting configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;cache-container&gt;
  &lt;transport cluster="MyCluster"
            machine="LinuxServer01"
            rack="Rack01"
            site="US-WestCoast"/&gt;
&lt;/cache-container&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "transport" : {
        "cluster" : "MyCluster",
        "machine" : "LinuxServer01",
        "rack" : "Rack01",
        "site" : "US-WestCoast"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">cacheContainer:
  transport:
    cluster: "MyCluster"
    machine: "LinuxServer01"
    rack: "Rack01"
    site: "US-WestCoast"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">GlobalConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">GlobalConfigurationBuilder global = GlobalConfigurationBuilder.defaultClusteredBuilder()
  .transport()
  .clusterName("MyCluster")
  .machineId("LinuxServer01")
  .rackId("Rack01")
  .siteId("US-WestCoast");</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/global/TransportConfigurationBuilder.html">org.infinispan.configuration.global.TransportConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="key-affinity-service_clustered-caches"><a class="anchor" href="#key-affinity-service_clustered-caches"></a>2.2.6. Key affinity service</h4>
<div class="paragraph">
<p>In a distributed cache, a key is allocated to a list of nodes with an opaque algorithm.
There is no easy way to reverse the computation and generate a key that maps to a particular node.
However, Infinispan can generate a sequence of (pseudo-)random keys, see what their primary owner is, and hand them out to the application when it needs a key mapping to a particular node.</p>
</div>
<div class="paragraph">
<p>Following code snippet depicts how a reference to this service can be obtained and used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// 1. Obtain a reference to a cache
Cache cache = ...
Address address = cache.getCacheManager().getAddress();

// 2. Create the affinity service
KeyAffinityService keyAffinityService = KeyAffinityServiceFactory.newLocalKeyAffinityService(
      cache,
      new RndKeyGenerator(),
      Executors.newSingleThreadExecutor(),
      100);

// 3. Obtain a key for which the local node is the primary owner
Object localKey = keyAffinityService.getKeyForAddress(address);

// 4. Insert the key in the cache
cache.put(localKey, "yourValue");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service is started at step 2: after this point it uses the supplied <em>Executor</em> to generate and queue keys.
At step 3, we obtain a key from the service, and at step 4 we use it.</p>
</div>
<h5 id="lifecycle" class="discrete">Lifecycle</h5>
<div class="paragraph">
<p><code>KeyAffinityService</code> extends <code>Lifecycle</code>, which allows stopping and (re)starting it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface Lifecycle {
   void start();
   void stop();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service is instantiated through <code>KeyAffinityServiceFactory</code>.
All the factory methods have an <code>Executor</code> parameter, that is used for asynchronous key generation (so that it
won&#8217;t happen in the caller&#8217;s thread).
It is the user&#8217;s responsibility to handle the shutdown of this <code>Executor</code>.</p>
</div>
<div class="paragraph">
<p>The <code>KeyAffinityService</code>, once started, needs to be explicitly stopped.
This stops the background key generation and releases other held resources.</p>
</div>
<div class="paragraph">
<p>The only situation in which <code>KeyAffinityService</code> stops by itself is when the Cache Manager with which it was registered is shutdown.</p>
</div>
<h5 id="topology_changes" class="discrete">Topology changes</h5>
<div class="paragraph">
<p>When the cache topology changes, the ownership of the keys generated by the <code>KeyAffinityService</code> might change.
The key affinity service keep tracks of these topology changes and doesn&#8217;t return keys that would currently map to a different node, but it won&#8217;t do anything about keys generated earlier.</p>
</div>
<div class="paragraph">
<p>As such, applications should treat <code>KeyAffinityService</code> purely as an optimization, and they should not rely on the location of a generated key for correctness.</p>
</div>
<div class="paragraph">
<p>In particular, applications should not rely on keys generated by <code>KeyAffinityService</code> for the same address to always be located together.
Collocation of keys is only provided by the <code>Grouping</code> API.</p>
</div>
</div>
<div class="sect3">
<h4 id="grouping-api_clustered-caches"><a class="anchor" href="#grouping-api_clustered-caches"></a>2.2.7. Grouping API</h4>
<div class="paragraph">
<p>Complementary to the Key affinity service, the <code>Grouping</code> API allows you to co-locate a group of entries on the same nodes, but without being able to select the actual nodes.</p>
</div>
<div class="paragraph">
<p>By default, the segment of a key is computed using the key&#8217;s <code>hashCode()</code>.
If you use the <code>Grouping</code> API, Infinispan will compute the segment of the group and use that as the segment of the key.</p>
</div>
<div class="paragraph">
<p>When the <code>Grouping</code> API is in use, it is important that every node can still compute the owners of every key without contacting other nodes.
For this reason, the group cannot be specified manually.
The group can either be intrinsic to the entry (generated by the key class) or extrinsic (generated by an external function).</p>
</div>
<div class="paragraph">
<p>To use the <code>Grouping</code> API, you must enable groups.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Configuration c = new ConfigurationBuilder()
   .clustering().hash().groups().enabled()
   .build();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
   &lt;groups enabled="true"/&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have control of the key class (you can alter the class definition, it&#8217;s not part of an unmodifiable library), then we recommend using an intrinsic group.
The intrinsic group is specified by adding the <code>@Group</code> annotation to a method, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class User {
   ...
   String office;
   ...

   public int hashCode() {
      // Defines the hash for the key, normally used to determine location
      ...
   }

   // Override the location by specifying a group
   // All keys in the same group end up with the same owners
   @Group
   public String getOffice() {
      return office;
   }
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The group method must return a <code>String</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you don&#8217;t have control over the key class, or the determination of the group is an orthogonal concern to the key class, we recommend using an extrinsic group.
An extrinsic group is specified by implementing the <code>Grouper</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface Grouper&lt;T&gt; {
    String computeGroup(T key, String group);

    Class&lt;T&gt; getKeyType();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If multiple <code>Grouper</code> classes are configured for the same key type, all of them will be called, receiving the value computed by the previous one.
If the key class also has a <code>@Group</code> annotation, the first <code>Grouper</code> will receive the group computed by the annotated method.
This allows you even greater control over the group when using an intrinsic group.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>Grouper</code> implementation</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class KXGrouper implements Grouper&lt;String&gt; {

   // The pattern requires a String key, of length 2, where the first character is
   // "k" and the second character is a digit. We take that digit, and perform
   // modular arithmetic on it to assign it to group "0" or group "1".
   private static Pattern kPattern = Pattern.compile("(^k)(&lt;a&gt;\\d&lt;/a&gt;)$");

   public String computeGroup(String key, String group) {
      Matcher matcher = kPattern.matcher(key);
      if (matcher.matches()) {
         String g = Integer.parseInt(matcher.group(2)) % 2 + "";
         return g;
      } else {
         return null;
      }
   }

   public Class&lt;String&gt; getKeyType() {
      return String.class;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Grouper</code> implementations must be registered explicitly in the cache configuration.
If you are configuring Infinispan programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Configuration c = new ConfigurationBuilder()
   .clustering().hash().groups().enabled().addGrouper(new KXGrouper())
   .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, if you are using XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
   &lt;groups enabled="true"&gt;
      &lt;grouper class="com.example.KXGrouper" /&gt;
   &lt;/groups&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<h5 id="advanced_api" class="discrete">Advanced API</h5>
<div class="paragraph">
<p><code>AdvancedCache</code> has two group-specific methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/AdvancedCache.html#getGroup-java.lang.String-">getGroup(groupName)</a></code> retrieves all keys in the cache that belong to a group.</p>
</li>
<li>
<p><code><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/AdvancedCache.html#removeGroup-java.lang.String-">removeGroup(groupName)</a></code> removes all the keys in the cache that belong to a group.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both methods iterate over the entire data container and store (if present), so they can be slow when a cache contains lots of small groups.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="invalidation-caches_clustered-caches"><a class="anchor" href="#invalidation-caches_clustered-caches"></a>2.3. Invalidation caches</h3>
<div class="paragraph">
<p>Invalidation cache mode in Infinispan is designed to optimize systems that perform high volumes of read operations to a shared permanent data store.
You can use invalidation mode to reduce the number of database writes when state changes occur.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Invalidation cache mode is deprecated for Infinispan remote deployments.
Use invalidation cache mode with embedded caches that are stored in shared cache stores only.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Invalidation cache mode is effective only when you have a permanent data store, such as a database, and are only using Infinispan as an optimization in a read-heavy system to prevent hitting the database for every read.</p>
</div>
<div class="paragraph">
<p>When a cache is configured for invalidation, each data change in a cache triggers a message to other caches in the cluster, informing them that their data is now stale and should be removed from memory.
Invalidation messages remove stale values from other nodes' memory.
The messages are very small compared to replicating the entire value, and also other caches in the cluster look up modified data in a lazy manner, only when needed.
The update to the shared store is typically handled by user application code or Hibernate.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/invalidation_cache_ispn.png" alt="invalidation cache ispn">
</div>
<div class="title">Figure 5. Invalidation cache</div>
</div>
<div class="paragraph">
<p>Sometimes the application reads a value from the external store and wants to write it to the local cache, without removing it from the other nodes.
To do this, it must call <code>Cache.putForExternalRead(key, value)</code> instead of <code>Cache.put(key, value)</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Invalidation mode is suitable only for shared stores where all nodes can access the same data.
Using invalidation mode without a persistent store is impractical, as updated values need to be read from a shared store for consistency across nodes.</p>
</div>
<div class="paragraph">
<p>Never use invalidation mode with a local, non-shared, cache store.
The invalidation message will not remove entries in the local store, and some nodes will keep seeing the stale value.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An invalidation cache can also be configured with a special cache loader, <code>ClusterLoader</code>.
When <code>ClusterLoader</code> is enabled, read operations that do not find the key on the local node will request it from all the other nodes first, and store it in memory locally.
This can lead to storing stale values, so only use it if you have a high tolerance for stale values.</p>
</div>
<div class="paragraph">
<div class="title">Synchronous or asynchronous replication</div>
<p>When synchronous, a write operation blocks until all nodes in the cluster have evicted the stale value.
When asynchronous, the originator broadcasts invalidation messages but does not wait for responses.
That means other nodes still see the stale value for a while after the write completed on the originator.</p>
</div>
<div class="paragraph">
<div class="title">Transactions</div>
<p>Transactions can be used to batch the invalidation messages.
Transactions acquire the key lock on the primary owner.</p>
</div>
<div class="paragraph">
<p>With pessimistic locking, each write triggers a lock message, which is
broadcast to all the nodes.
During transaction commit, the originator broadcasts a one-phase prepare message (optionally fire-and-forget) which invalidates all affected keys and releases the locks.</p>
</div>
<div class="paragraph">
<p>With optimistic locking, the originator broadcasts a prepare message, a commit message, and an unlock message (optional).
Either the one-phase prepare or the unlock message is fire-and-forget, and the last message always releases the locks.</p>
</div>
</div>
<div class="sect2">
<h3 id="scattered-caches_clustered-caches"><a class="anchor" href="#scattered-caches_clustered-caches"></a>2.4. Scattered caches</h3>
<div class="paragraph">
<p>Scattered caches are very similar to distributed caches as they allow linear scaling of the cluster.
Scattered caches allow single node failure by maintaining two copies of the data (<code>numOwners=2</code>).
Unlike distributed caches, the location of data is not fixed; while we use the same Consistent Hash algorithm to locate the primary owner, the backup copy is stored on the node that wrote the data last time.
When the write originates on the primary owner, backup copy is stored on any other node (the exact location of this copy is not important).</p>
</div>
<div class="paragraph">
<p>This has the advantage of single Remote Procedure Call (RPC) for any write (distributed caches require one or two RPCs), but reads have to always target the primary owner.
That results in faster writes but possibly slower reads, and therefore this mode is more suitable for write-intensive applications.</p>
</div>
<div class="paragraph">
<p>Storing multiple backup copies also results in slightly higher memory consumption.
In order to remove out-of-date backup copies, invalidation messages are broadcast in the cluster, which generates some overhead.
This lowers the performance of scattered caches in clusters with a large number of nodes.</p>
</div>
<div class="paragraph">
<p>When a node crashes, the primary copy may be lost.
Therefore, the cluster has to reconcile the backups and find out the last written backup copy.
This process results in more network traffic during state transfer.</p>
</div>
<div class="paragraph">
<p>Since the writer of data is also a backup, even if we specify machine/rack/site IDs on the transport level the cluster cannot be resilient to more than one failure on the same machine/rack/site.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot use scattered caches with transactions or asynchronous replication.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The cache is configured in a similar way as the other cache modes, here is an example of declarative configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;scattered-cache name="scatteredCache" /&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Configuration c = new ConfigurationBuilder()
   .clustering().cacheMode(CacheMode.SCATTERED_SYNC)
   .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Scattered mode is not exposed in the server configuration as the server is usually accessed through the Hot Rod
protocol. The protocol automatically selects primary owner for the writes and therefore the write (in distributed
mode with two owner) requires single RPC inside the cluster, too. Therefore, scattered cache would not bring
the performance benefit.</p>
</div>
</div>
<div class="sect2">
<h3 id="asynchronous-replication_clustered-caches"><a class="anchor" href="#asynchronous-replication_clustered-caches"></a>2.5. Asynchronous replication</h3>
<div class="paragraph">
<p>All clustered cache modes can be configured to use asynchronous communications with the
<a href="https://docs.jboss.org/infinispan/14.0/configdocs/"><code>mode="ASYNC"</code></a>
attribute on the <code>&lt;replicated-cache/&gt;</code>, <code>&lt;distributed-cache&gt;</code>, or <code>&lt;invalidation-cache/&gt;</code>
element.</p>
</div>
<div class="paragraph">
<p>With asynchronous communications, the originator node does not receive any
acknowledgement from the other nodes about the status of the operation, so there is no
way to check if it succeeded on other nodes.</p>
</div>
<div class="paragraph">
<p>We do not recommend asynchronous communications in general, as they can cause
inconsistencies in the data, and the results are hard to reason about.
Nevertheless, sometimes speed is more important than consistency, and the option is
available for those cases.</p>
</div>
<h4 id="asynchronous_api" class="discrete">Asynchronous API</h4>
<div class="paragraph">
<p>The Asynchronous API allows you to use synchronous communications,
but without blocking the user thread.</p>
</div>
<div class="paragraph">
<p>There is one caveat:
The asynchronous operations do NOT preserve the program order.
If a thread calls <code>cache.putAsync(k, v1); cache.putAsync(k, v2)</code>, the final value of <code>k</code>
may be either <code>v1</code> or <code>v2</code>.
The advantage over using asynchronous communications is that the final value can&#8217;t be
<code>v1</code> on one node and <code>v2</code> on another.</p>
</div>
<div class="sect3">
<h4 id="asynchronous-return-values_clustered-caches"><a class="anchor" href="#asynchronous-return-values_clustered-caches"></a>2.5.1. Return values with asynchronous replication</h4>
<div class="paragraph">
<p>Because the <code>Cache</code> interface extends <code>java.util.Map</code>, write methods like
<code>put(key, value)</code> and <code>remove(key)</code> return the previous value by default.</p>
</div>
<div class="paragraph">
<p>In some cases, the return value may not be correct:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When using <code>AdvancedCache.withFlags()</code> with <code>Flag.IGNORE_RETURN_VALUE</code>,
<code>Flag.SKIP_REMOTE_LOOKUP</code>, or <code>Flag.SKIP_CACHE_LOAD</code>.</p>
</li>
<li>
<p>When the cache is configured with <code>unreliable-return-values="true"</code>.</p>
</li>
<li>
<p>When using asynchronous communications.</p>
</li>
<li>
<p>When there are multiple concurrent writes to the same key, and the cache topology
changes.
The topology change will make Infinispan retry the write operations, and a retried
operation&#8217;s return value is not reliable.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Transactional caches return the correct previous value in cases 3 and 4.
However, transactional caches also have a gotcha: in distributed mode, the
read-committed isolation level is implemented as repeatable-read.
That means this example of "double-checked locking" won&#8217;t work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Cache cache = ...
TransactionManager tm = ...

tm.begin();
try {
   Integer v1 = cache.get(k);
   // Increment the value
   Integer v2 = cache.put(k, v1 + 1);
   if (Objects.equals(v1, v2) {
      // success
   } else {
      // retry
   }
} finally {
  tm.commit();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The correct way to implement this is to use
<code>cache.getAdvancedCache().withFlags(Flag.FORCE_WRITE_LOCK).get(k)</code>.</p>
</div>
<div class="paragraph">
<p>In caches with optimistic locking, writes can also return stale previous values. Write skew checks can avoid stale previous values.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-initial-cluster-size_clustered-caches"><a class="anchor" href="#configuring-initial-cluster-size_clustered-caches"></a>2.6. Configuring initial cluster size</h3>
<div class="paragraph">
<p>Infinispan handles cluster topology changes dynamically.
This means that nodes do not need to wait for other nodes to join the cluster before Infinispan initializes the caches.</p>
</div>
<div class="paragraph">
<p>If your applications require a specific number of nodes in the cluster before caches start, you can configure the initial cluster size as part of the transport.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Set the minimum number of nodes required before caches start with the <code>initial-cluster-size</code> attribute or <code>initialClusterSize()</code> method.</p>
</li>
<li>
<p>Set the timeout, in milliseconds, after which the Cache Manager does not start with the <code>initial-cluster-timeout</code> attribute or <code>initialClusterTimeout()</code> method.</p>
</li>
<li>
<p>Save and close your Infinispan configuration.</p>
</li>
</ol>
</div>
<h4 id="initial_cluster_size_configuration" class="discrete">Initial cluster size configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container&gt;
    &lt;transport initial-cluster-size="4"
               initial-cluster-timeout="30000" /&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "transport" : {
        "initial-cluster-size" : "4",
        "initial-cluster-timeout" : "30000"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    transport:
      initialClusterSize: "4"
      initialClusterTimeout: "30000"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">GlobalConfiguration global = GlobalConfigurationBuilder.defaultClusteredBuilder()
   .transport()
   .initialClusterSize(4)
   .initialClusterTimeout(30000, TimeUnit.MILLISECONDS);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cache-configuration"><a class="anchor" href="#cache-configuration"></a>3. Infinispan cache configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cache configuration controls how Infinispan stores your data.</p>
</div>
<div class="paragraph">
<p>As part of your cache configuration, you declare the cache mode you want to use.
For instance, you can configure Infinispan clusters to use replicated caches or distributed caches.</p>
</div>
<div class="paragraph">
<p>Your configuration also defines the characteristics of your caches and enables the Infinispan capabilities that you want to use when handling data.
For instance, you can configure how Infinispan encodes entries in your caches, whether replication requests happen synchronously or asynchronously between nodes, if entries are mortal or immortal, and so on.</p>
</div>
<div class="sect2">
<h3 id="declarative-cache-configuration_cache-configuration"><a class="anchor" href="#declarative-cache-configuration_cache-configuration"></a>3.1. Declarative cache configuration</h3>
<div class="paragraph">
<p>You can configure caches declaratively, in XML, JSON, and YAML format, according to the Infinispan schema.</p>
</div>
<div class="paragraph">
<p>Declarative cache configuration has the following advantages over programmatic configuration:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Portability</dt>
<dd>
<p>Define each configuration in a standalone file that you can use to create embedded and remote caches.<br>
You can also use declarative configuration to create caches with Infinispan Operator for clusters running on Kubernetes.</p>
</dd>
<dt class="hdlist1">Simplicity</dt>
<dd>
<p>Keep markup languages separate to programming languages.<br>
For example, to create remote caches it is generally better to not add complex XML directly to Java code.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan Server configuration extends <code>infinispan.xml</code> to include cluster transport mechanisms, security realms, and endpoint configuration.
If you declare caches as part of your Infinispan Server configuration you should use management tooling, such as Ansible or Chef, to keep it synchronized across the cluster.</p>
</div>
<div class="paragraph">
<p>To dynamically synchronize remote caches across Infinispan clusters, create them at runtime.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="cache-configuration_cache-configuration"><a class="anchor" href="#cache-configuration_cache-configuration"></a>3.1.1. Cache configuration</h4>
<div class="paragraph">
<p>You can create declarative cache configuration in XML, JSON, and YAML format.</p>
</div>
<div class="paragraph">
<p>All declarative caches must conform to the Infinispan schema.
Configuration in JSON format must follow the structure of an XML configuration, elements correspond to objects and attributes correspond to fields.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan restricts characters to a maximum of <code>255</code> for a cache name or a cache template name.
If you exceed this character limit, Infinispan throws an exception.
Write succinct cache names and cache template names.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A file system might set a limitation for the length of a file name, so ensure that a cache&#8217;s name does not exceed this limitation.
If a cache name exceeds a file system&#8217;s naming limitation, general operations or initialing operations towards that cache might fail.
Write succinct file names.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="distributed_caches" class="discrete">Distributed caches</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache owners="2"
                   segments="256"
                   capacity-factor="1.0"
                   l1-lifespan="5000"
                   mode="SYNC"
                   statistics="true"&gt;
  &lt;encoding media-type="application/x-protostream"/&gt;
  &lt;locking isolation="REPEATABLE_READ"/&gt;
  &lt;transaction mode="FULL_XA"
               locking="OPTIMISTIC"/&gt;
  &lt;expiration lifespan="5000"
              max-idle="1000" /&gt;
  &lt;memory max-count="1000000"
          when-full="REMOVE"/&gt;
  &lt;indexing enabled="true"
            storage="local-heap"&gt;
    &lt;index-reader refresh-interval="1000"/&gt;
    &lt;indexed-entities&gt;
      &lt;indexed-entity&gt;org.infinispan.Person&lt;/indexed-entity&gt;
    &lt;/indexed-entities&gt;
  &lt;/indexing&gt;
  &lt;partition-handling when-split="ALLOW_READ_WRITES"
                      merge-policy="PREFERRED_NON_NULL"/&gt;
  &lt;persistence passivation="false"&gt;
    &lt;!-- Persistent storage configuration. --&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "mode": "SYNC",
    "owners": "2",
    "segments": "256",
    "capacity-factor": "1.0",
    "l1-lifespan": "5000",
    "statistics": "true",
    "encoding": {
      "media-type": "application/x-protostream"
    },
    "locking": {
      "isolation": "REPEATABLE_READ"
    },
    "transaction": {
      "mode": "FULL_XA",
      "locking": "OPTIMISTIC"
    },
    "expiration" : {
      "lifespan" : "5000",
      "max-idle" : "1000"
    },
    "memory": {
      "max-count": "1000000",
      "when-full": "REMOVE"
    },
    "indexing" : {
          "enabled" : true,
          "storage" : "local-heap",
          "index-reader" : {
            "refresh-interval" : "1000"
          },
          "indexed-entities": [
            "org.infinispan.Person"
          ]
    },
    "partition-handling" : {
      "when-split" : "ALLOW_READ_WRITES",
      "merge-policy" : "PREFERRED_NON_NULL"
    },
    "persistence" : {
      "passivation" : false
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  mode: "SYNC"
  owners: "2"
  segments: "256"
  capacityFactor: "1.0"
  l1Lifespan: "5000"
  statistics: "true"
  encoding:
    mediaType: "application/x-protostream"
  locking:
    isolation: "REPEATABLE_READ"
  transaction:
    mode: "FULL_XA"
    locking: "OPTIMISTIC"
  expiration:
    lifespan: "5000"
    maxIdle: "1000"
  memory:
    maxCount: "1000000"
    whenFull: "REMOVE"
  indexing:
    enabled: "true"
    storage: "local-heap"
    indexReader:
      refreshInterval: "1000"
    indexedEntities:
      - "org.infinispan.Person"
  partitionHandling:
    whenSplit: "ALLOW_READ_WRITES"
    mergePolicy: "PREFERRED_NON_NULL"
  persistence:
    passivation: "false"
    # Persistent storage configuration.</code></pre>
</div>
</div>
<h5 id="replicated_caches" class="discrete">Replicated caches</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;replicated-cache segments="256"
                  mode="SYNC"
                  statistics="true"&gt;
  &lt;encoding media-type="application/x-protostream"/&gt;
  &lt;locking isolation="REPEATABLE_READ"/&gt;
  &lt;transaction mode="FULL_XA"
               locking="OPTIMISTIC"/&gt;
  &lt;expiration lifespan="5000"
              max-idle="1000" /&gt;
  &lt;memory max-count="1000000"
          when-full="REMOVE"/&gt;
  &lt;indexing enabled="true"
            storage="local-heap"&gt;
    &lt;index-reader refresh-interval="1000"/&gt;
    &lt;indexed-entities&gt;
      &lt;indexed-entity&gt;org.infinispan.Person&lt;/indexed-entity&gt;
    &lt;/indexed-entities&gt;
  &lt;/indexing&gt;
  &lt;partition-handling when-split="ALLOW_READ_WRITES"
                      merge-policy="PREFERRED_NON_NULL"/&gt;
  &lt;persistence passivation="false"&gt;
    &lt;!-- Persistent storage configuration. --&gt;
  &lt;/persistence&gt;
&lt;/replicated-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "replicated-cache": {
    "mode": "SYNC",
    "segments": "256",
    "statistics": "true",
    "encoding": {
      "media-type": "application/x-protostream"
    },
    "locking": {
      "isolation": "REPEATABLE_READ"
    },
    "transaction": {
      "mode": "FULL_XA",
      "locking": "OPTIMISTIC"
    },
    "expiration" : {
      "lifespan" : "5000",
      "max-idle" : "1000"
    },
    "memory": {
      "max-count": "1000000",
      "when-full": "REMOVE"
    },
    "indexing" : {
      "enabled" : true,
      "storage" : "local-heap",
      "index-reader" : {
        "refresh-interval" : "1000"
        },
      "indexed-entities": [
        "org.infinispan.Person"
      ]
    },
    "partition-handling" : {
      "when-split" : "ALLOW_READ_WRITES",
      "merge-policy" : "PREFERRED_NON_NULL"
    },
    "persistence" : {
      "passivation" : false
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">replicatedCache:
  mode: "SYNC"
  segments: "256"
  statistics: "true"
  encoding:
    mediaType: "application/x-protostream"
  locking:
    isolation: "REPEATABLE_READ"
  transaction:
    mode: "FULL_XA"
    locking: "OPTIMISTIC"
  expiration:
    lifespan: "5000"
    maxIdle: "1000"
  memory:
    maxCount: "1000000"
    whenFull: "REMOVE"
  indexing:
    enabled: "true"
    storage: "local-heap"
    indexReader:
      refreshInterval: "1000"
    indexedEntities:
      - "org.infinispan.Person"
  partitionHandling:
    whenSplit: "ALLOW_READ_WRITES"
    mergePolicy: "PREFERRED_NON_NULL"
  persistence:
    passivation: "false"
    # Persistent storage configuration.</code></pre>
</div>
</div>
<h5 id="multiple_caches" class="discrete">Multiple caches</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="urn:infinispan:config:14.0 https://infinispan.org/schemas/infinispan-config-14.0.xsd
                          urn:infinispan:server:14.0 https://infinispan.org/schemas/infinispan-server-14.0.xsd"
      xmlns="urn:infinispan:config:14.0"
      xmlns:server="urn:infinispan:server:14.0"&gt;
  &lt;cache-container name="default"
                   statistics="true"&gt;
    &lt;distributed-cache name="mycacheone"
                       mode="ASYNC"
                       statistics="true"&gt;
      &lt;encoding media-type="application/x-protostream"/&gt;
      &lt;expiration lifespan="300000"/&gt;
      &lt;memory max-size="400MB"
              when-full="REMOVE"/&gt;
    &lt;/distributed-cache&gt;
    &lt;distributed-cache name="mycachetwo"
                       mode="SYNC"
                       statistics="true"&gt;
      &lt;encoding media-type="application/x-protostream"/&gt;
      &lt;expiration lifespan="300000"/&gt;
      &lt;memory max-size="400MB"
              when-full="REMOVE"/&gt;
    &lt;/distributed-cache&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "name" : "default",
      "statistics" : "true",
      "caches" : {
        "mycacheone" : {
          "distributed-cache" : {
            "mode": "ASYNC",
            "statistics": "true",
            "encoding": {
              "media-type": "application/x-protostream"
            },
            "expiration" : {
              "lifespan" : "300000"
            },
            "memory": {
              "max-size": "400MB",
              "when-full": "REMOVE"
            }
          }
        },
        "mycachetwo" : {
          "distributed-cache" : {
            "mode": "SYNC",
            "statistics": "true",
            "encoding": {
              "media-type": "application/x-protostream"
            },
            "expiration" : {
              "lifespan" : "300000"
            },
            "memory": {
              "max-size": "400MB",
              "when-full": "REMOVE"
            }
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    name: "default"
    statistics: "true"
    caches:
      mycacheone:
       distributedCache:
          mode: "ASYNC"
          statistics: "true"
          encoding:
            mediaType: "application/x-protostream"
          expiration:
            lifespan: "300000"
          memory:
            maxSize: "400MB"
            whenFull: "REMOVE"
      mycachetwo:
        distributedCache:
          mode: "SYNC"
          statistics: "true"
          encoding:
            mediaType: "application/x-protostream"
          expiration:
            lifespan: "300000"
          memory:
            maxSize: "400MB"
            whenFull: "REMOVE"</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/">Infinispan configuration schema reference</a></p>
</li>
<li>
<p><a href="http://infinispan.org/schemas/infinispan-config-14.0.xsd">infinispan-config-14.0.xsd</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-cache-configuration-templates_cache-configuration"><a class="anchor" href="#adding-cache-configuration-templates_cache-configuration"></a>3.2. Adding cache templates</h3>
<div class="paragraph">
<p>The Infinispan schema includes <code>*-cache-configuration</code> elements that you can use to create templates.
You can then create caches on demand, using the same configuration multiple times.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add the cache configuration with the appropriate <code>*-cache-configuration</code> element or object to the Cache Manager.</p>
</li>
<li>
<p>Save and close your Infinispan configuration.</p>
</li>
</ol>
</div>
<h4 id="cache_template_example" class="discrete">Cache template example</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
   &lt;cache-container&gt;
      &lt;distributed-cache-configuration name="my-dist-template"
                                       mode="SYNC"
                                       statistics="true"&gt;
        &lt;encoding media-type="application/x-protostream"/&gt;
        &lt;memory max-count="1000000"
                when-full="REMOVE"/&gt;
        &lt;expiration lifespan="5000"
                    max-idle="1000"/&gt;
      &lt;/distributed-cache-configuration&gt;
   &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "distributed-cache-configuration" : {
        "name" : "my-dist-template",
        "mode": "SYNC",
        "statistics": "true",
        "encoding": {
          "media-type": "application/x-protostream"
        },
        "expiration" : {
          "lifespan" : "5000",
          "max-idle" : "1000"
        },
        "memory": {
          "max-count": "1000000",
          "when-full": "REMOVE"
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    distributedCacheConfiguration:
      name: "my-dist-template"
      mode: "SYNC"
      statistics: "true"
      encoding:
        mediaType: "application/x-protostream"
      expiration:
        lifespan: "5000"
        maxIdle: "1000"
      memory:
        maxCount: "1000000"
        whenFull: "REMOVE"</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="creating-caches-templates_cache-configuration"><a class="anchor" href="#creating-caches-templates_cache-configuration"></a>3.2.1. Creating caches from templates</h4>
<div class="paragraph">
<p>Create caches from configuration templates.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Templates for remote caches are available from the <strong>Cache templates</strong> menu in Infinispan Console.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Add at least one cache template to the Cache Manager.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Specify the template from which the cache inherits with the <code>configuration</code> attribute or field.</p>
</li>
<li>
<p>Save and close your Infinispan configuration.</p>
</li>
</ol>
</div>
<h5 id="cache_configuration_inherited_from_a_template" class="discrete">Cache configuration inherited from a template</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache configuration="my-dist-template" /&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "configuration": "my-dist-template"
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  configuration: "my-dist-template"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cache-templates_cache-configuration"><a class="anchor" href="#cache-templates_cache-configuration"></a>3.2.2. Cache template inheritance</h4>
<div class="paragraph">
<p>Cache configuration templates can inherit from other templates to extend and override settings.</p>
</div>
<div class="paragraph">
<p>Cache template inheritance is hierarchical.
For a child configuration template to inherit from a parent, you must include it after the parent template.</p>
</div>
<div class="paragraph">
<p>Additionally, template inheritance is additive for elements that have multiple values.
A cache that inherits from another template merges the values from that template, which can override properties.</p>
</div>
<h5 id="template_inheritance_example" class="discrete">Template inheritance example</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container&gt;
    &lt;distributed-cache-configuration name="base-template"&gt;
      &lt;expiration lifespan="5000"/&gt;
    &lt;/distributed-cache-configuration&gt;
    &lt;distributed-cache-configuration name="extended-template"
                                     configuration="base-template"&gt;
      &lt;encoding media-type="application/x-protostream"/&gt;
      &lt;expiration lifespan="10000"
                  max-idle="1000"/&gt;
    &lt;/distributed-cache-configuration&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "caches" : {
        "base-template" : {
          "distributed-cache-configuration" : {
            "expiration" : {
              "lifespan" : "5000"
            }
          }
        },
        "extended-template" : {
          "distributed-cache-configuration" : {
            "configuration" : "base-template",
            "encoding": {
              "media-type": "application/x-protostream"
              },
            "expiration" : {
              "lifespan" : "10000",
              "max-idle" : "1000"
            }
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    caches:
      base-template:
        distributedCacheConfiguration:
          expiration:
            lifespan: "5000"
      extended-template:
        distributedCacheConfiguration:
          configuration: "base-template"
          encoding:
            mediaType: "application/x-protostream"
          expiration:
            lifespan: "10000"
            maxIdle: "1000"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cache-wildcards-cache-configuration"><a class="anchor" href="#cache-wildcards-cache-configuration"></a>3.2.3. Cache template wildcards</h4>
<div class="paragraph">
<p>You can add wildcards to cache configuration template names.
If you then create caches where the name matches the wildcard, Infinispan applies the configuration template.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan throws exceptions if cache names match more than one wildcard.</p>
</div>
</td>
</tr>
</table>
</div>
<h5 id="template_wildcard_example" class="discrete">Template wildcard example</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
   &lt;cache-container&gt;
      &lt;distributed-cache-configuration name="async-dist-cache-*"
                                       mode="ASYNC"
                                       statistics="true"&gt;
        &lt;encoding media-type="application/x-protostream"/&gt;
      &lt;/distributed-cache-configuration&gt;
   &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "distributed-cache-configuration" : {
        "name" : "async-dist-cache-*",
        "mode": "ASYNC",
        "statistics": "true",
        "encoding": {
          "media-type": "application/x-protostream"
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    distributedCacheConfiguration:
      name: "async-dist-cache-*"
      mode: "ASYNC"
      statistics: "true"
      encoding:
        mediaType: "application/x-protostream"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the preceding example, if you create a cache named "async-dist-cache-prod" then Infinispan uses the configuration from the <code>async-dist-cache-*</code> template.</p>
</div>
</div>
<div class="sect3">
<h4 id="cache-template-xinclude_cache-configuration"><a class="anchor" href="#cache-template-xinclude_cache-configuration"></a>3.2.4. Cache templates from multiple XML files</h4>
<div class="paragraph">
<p>Split cache configuration templates into multiple XML files for granular flexibility and reference them with XML inclusions (XInclude).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan provides minimal support for the XInclude specification.
This means you cannot use the <code>xpointer</code> attribute, the <code>xi:fallback</code> element, text processing, or content negotiation.</p>
</div>
<div class="paragraph">
<p>You must also add the <code>xmlns:xi="http://www.w3.org/2001/XInclude"</code> namespace to <code>infinispan.xml</code> to use XInclude.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Xinclude cache template</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan xmlns:xi="http://www.w3.org/2001/XInclude"&gt;
  &lt;cache-container default-cache="cache-1"&gt;
    &lt;!-- References files that contain cache configuration templates. --&gt;
    &lt;xi:include href="distributed-cache-template.xml" /&gt;
    &lt;xi:include href="replicated-cache-template.xml" /&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan also provides an <code>infinispan-config-fragment-14.0.xsd</code> schema that you can use with configuration fragments.</p>
</div>
<div class="listingblock">
<div class="title">Configuration fragment schema</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;local-cache xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="urn:infinispan:config:14.0 https://infinispan.org/schemas/infinispan-config-fragment-14.0.xsd"
             xmlns="urn:infinispan:config:14.0"
             name="mycache"/&gt;</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://www.w3.org/TR/xinclude/">XInclude specification</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-remote-caches"><a class="anchor" href="#creating-remote-caches"></a>3.3. Creating remote caches</h3>
<div class="paragraph">
<p>When you create remote caches at runtime, Infinispan Server synchronizes your configuration across the cluster so that all nodes have a copy.
For this reason you should always create remote caches dynamically with the following mechanisms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Infinispan Console</p>
</li>
<li>
<p>Infinispan Command Line Interface (CLI)</p>
</li>
<li>
<p>Hot Rod or HTTP clients</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="default-cache-manager-creating-remote-caches"><a class="anchor" href="#default-cache-manager-creating-remote-caches"></a>3.3.1. Default Cache Manager</h4>
<div class="paragraph">
<p>Infinispan Server provides a default Cache Manager that controls the lifecycle of remote caches.
Starting Infinispan Server automatically instantiates the Cache Manager so you can create and delete remote caches and other resources like Protobuf schema.</p>
</div>
<div class="paragraph">
<p>After you start Infinispan Server and add user credentials, you can view details about the Cache Manager and get cluster information from Infinispan Console.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open <code>127.0.0.1:11222</code> in any browser.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also get information about the Cache Manager through the Command Line Interface (CLI) or REST API:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">CLI</dt>
<dd>
<p>Run the <code class="command">describe</code> command in the default container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>[//containers/default]&gt; describe</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">REST</dt>
<dd>
<p>Open <code>127.0.0.1:11222/rest/v2/cache-managers/default/</code> in any browser.</p>
</dd>
</dl>
</div>
<h5 id="default_cache_manager_configuration" class="discrete">Default Cache Manager configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;!-- Creates a Cache Manager named "default" and enables metrics. --&gt;
  &lt;cache-container name="default"
                   statistics="true"&gt;
     &lt;!-- Adds cluster transport that uses the default JGroups TCP stack. --&gt;
     &lt;transport cluster="${infinispan.cluster.name:cluster}"
                stack="${infinispan.cluster.stack:tcp}"
                node-name="${infinispan.node.name:}"/&gt;
     &lt;!-- Requires user permission to access caches and perform operations. --&gt;
     &lt;security&gt;
        &lt;authorization/&gt;
     &lt;/security&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "jgroups" : {
      "transport" : "org.infinispan.remoting.transport.jgroups.JGroupsTransport"
    },
    "cache-container" : {
      "name" : "default",
      "statistics" : "true",
      "transport" : {
        "cluster" : "cluster",
        "node-name" : "",
        "stack" : "tcp"
      },
      "security" : {
        "authorization" : {}
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  jgroups:
    transport: "org.infinispan.remoting.transport.jgroups.JGroupsTransport"
  cacheContainer:
    name: "default"
    statistics: "true"
    transport:
      cluster: "cluster"
      nodeName: ""
      stack: "tcp"
    security:
      authorization: ~</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="creating-caches-console_creating-remote-caches"><a class="anchor" href="#creating-caches-console_creating-remote-caches"></a>3.3.2. Creating caches with Infinispan Console</h4>
<div class="paragraph">
<p>Use Infinispan Console to create remote caches in an intuitive visual interface from any web browser.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a Infinispan user with <code>admin</code> permissions.</p>
</li>
<li>
<p>Start at least one Infinispan Server instance.</p>
</li>
<li>
<p>Have a Infinispan cache configuration.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open <code>127.0.0.1:11222/console/</code> in any browser.</p>
</li>
<li>
<p>Select <strong>Create Cache</strong> and follow the steps as Infinispan Console guides you through the process.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="creating-caches-cli_creating-remote-caches"><a class="anchor" href="#creating-caches-cli_creating-remote-caches"></a>3.3.3. Creating remote caches with the Infinispan CLI</h4>
<div class="paragraph">
<p>Use the Infinispan Command Line Interface (CLI) to add remote caches on Infinispan Server.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a Infinispan user with <code>admin</code> permissions.</p>
</li>
<li>
<p>Start at least one Infinispan Server instance.</p>
</li>
<li>
<p>Have a Infinispan cache configuration.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Start the CLI.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>bin/cli.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>connect</code> command and enter your username and password when prompted.</p>
</li>
<li>
<p>Use the <code class="command">create cache</code> command to create remote caches.</p>
<div class="paragraph">
<p>For example, create a cache named "mycache" from a file named <code>mycache.xml</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>create cache --file=mycache.xml mycache</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Verification</div>
<ol class="arabic">
<li>
<p>List all remote caches with the <code class="command">ls</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>ls caches
mycache</code></pre>
</div>
</div>
</li>
<li>
<p>View cache configuration with the <code class="command">describe</code> command.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>describe caches/mycache</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="creating-caches-hotrod_creating-remote-caches"><a class="anchor" href="#creating-caches-hotrod_creating-remote-caches"></a>3.3.4. Creating remote caches from Hot Rod clients</h4>
<div class="paragraph">
<p>Use the Infinispan Hot Rod API to create remote caches on Infinispan Server from Java, C++, .NET/C#, JS clients and more.</p>
</div>
<div class="paragraph">
<p>This procedure shows you how to use Hot Rod Java clients that create remote caches on first access.
You can find code examples for other Hot Rod clients in the <a href="https://infinispan.org/tutorials/simple/simple_tutorials.html">Infinispan Tutorials</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a Infinispan user with <code>admin</code> permissions.</p>
</li>
<li>
<p>Start at least one Infinispan Server instance.</p>
</li>
<li>
<p>Have a Infinispan cache configuration.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Invoke the <code>remoteCache()</code> method as part of your the <code>ConfigurationBuilder</code>.</p>
</li>
<li>
<p>Set the <code>configuration</code> or <code>configuration_uri</code> properties in the <code>hotrod-client.properties</code> file on your classpath.</p>
</li>
</ul>
</div>
<div class="listingblock primary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">File file = new File("path/to/infinispan.xml")
ConfigurationBuilder builder = new ConfigurationBuilder();
builder.remoteCache("another-cache")
       .configuration("&lt;distributed-cache name=\"another-cache\"/&gt;");
builder.remoteCache("my.other.cache")
       .configurationURI(file.toURI());</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">hotrod-client.properties</div>
<div class="content">
<pre class="highlight nowrap"><code>infinispan.client.hotrod.cache.another-cache.configuration=&lt;distributed-cache name=\"another-cache\"/&gt;
infinispan.client.hotrod.cache.[my.other.cache].configuration_uri=file:///path/to/infinispan.xml</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the name of your remote cache contains the <code>.</code> character, you must enclose it in square brackets when using <code>hotrod-client.properties</code> files.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/client/hotrod/configuration/package-summary.html">Hot Rod Client Configuration</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/client/hotrod/configuration/RemoteCacheConfigurationBuilder.html">org.infinispan.client.hotrod.configuration.RemoteCacheConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="creating-caches-rest_creating-remote-caches"><a class="anchor" href="#creating-caches-rest_creating-remote-caches"></a>3.3.5. Creating remote caches with the REST API</h4>
<div class="paragraph">
<p>Use the Infinispan REST API to create remote caches on Infinispan Server from any suitable HTTP client.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create a Infinispan user with <code>admin</code> permissions.</p>
</li>
<li>
<p>Start at least one Infinispan Server instance.</p>
</li>
<li>
<p>Have a Infinispan cache configuration.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Invoke <code>POST</code> requests to <code>/rest/v2/caches/&lt;cache_name&gt;</code> with cache configuration in the payload.</p>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../rest/rest.html#rest_v2_cache_operations">Creating and Managing Caches with the REST API</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-embedded-caches"><a class="anchor" href="#creating-embedded-caches"></a>3.4. Creating embedded caches</h3>
<div class="paragraph">
<p>Infinispan provides an <code>EmbeddedCacheManager</code> API that lets you control both the Cache Manager and embedded cache lifecycles programmatically.</p>
</div>
<div class="sect3">
<h4 id="installing-embedded_creating-embedded-caches"><a class="anchor" href="#installing-embedded_creating-embedded-caches"></a>3.4.1. Adding Infinispan to your project</h4>
<div class="paragraph">
<p>Add Infinispan to your project to create embedded caches in your applications.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Configure your project to get Infinispan artifacts from the Maven repository.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Add the <code>infinispan-core</code> artifact as a dependency in your <code>pom.xml</code> as
follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
    &lt;artifactId&gt;infinispan-core&lt;/artifactId&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-embedded-caches_creating-embedded-caches"><a class="anchor" href="#configuring-embedded-caches_creating-embedded-caches"></a>3.4.2. Creating and using embedded caches</h4>
<div class="paragraph">
<p>Infinispan provides a <code>GlobalConfigurationBuilder</code> API that controls the Cache Manager and a <code>ConfigurationBuilder</code> API that configures caches.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Add the <code>infinispan-core</code> artifact as a dependency in your <code>pom.xml</code>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Initialize a <code>CacheManager</code>.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You must always call the <code>cacheManager.start()</code> method to initialize a <code>CacheManager</code> before you can create caches.
Default constructors do this for you but there are overloaded versions of the constructors that do not.</p>
</div>
<div class="paragraph">
<p>Cache Managers are also heavyweight objects and Infinispan recommends instantiating only one instance per JVM.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Use the <code>ConfigurationBuilder</code> API to define cache configuration.</p>
</li>
<li>
<p>Obtain caches with <code>getCache()</code>, <code>createCache()</code>, or <code>getOrCreateCache()</code> methods.</p>
<div class="paragraph">
<p>Infinispan recommends using the <code>getOrCreateCache()</code> method because it either creates a cache on all nodes or returns an existing cache.</p>
</div>
</li>
<li>
<p>If necessary use the <code>PERMANENT</code> flag for caches to survive restarts.</p>
</li>
<li>
<p>Stop the <code>CacheManager</code> by calling the <code>cacheManager.stop()</code> method to release JVM resources and gracefully shutdown any caches.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">// Set up a clustered Cache Manager.
GlobalConfigurationBuilder global = GlobalConfigurationBuilder.defaultClusteredBuilder();
// Initialize the default Cache Manager.
DefaultCacheManager cacheManager = new DefaultCacheManager(global.build());
// Create a distributed cache with synchronous replication.
ConfigurationBuilder builder = new ConfigurationBuilder();
                     builder.clustering().cacheMode(CacheMode.DIST_SYNC);
// Obtain a volatile cache.
Cache&lt;String, String&gt; cache = cacheManager.administration().withFlags(CacheContainerAdmin.AdminFlag.VOLATILE).getOrCreateCache("myCache", builder.build());
// Stop the Cache Manager.
cacheManager.stop();</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title"><code>getCache()</code> method</div>
<p>Invoke the <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getCache(java.lang.String)"><code>getCache(String)</code></a> method to obtain caches, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">Cache&lt;String, String&gt; myCache = manager.getCache("myCache");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding operation creates a cache named <code>myCache</code>, if it does not already exist, and returns it.</p>
</div>
<div class="paragraph">
<p>Using the <code>getCache()</code> method creates the cache only on the node where you invoke the method. In other words, it performs a local operation that must be invoked on each node across the cluster. Typically, applications deployed across multiple nodes obtain caches during initialization to ensure that caches are <em>symmetric</em> and exist on each node.</p>
</div>
<div class="paragraph">
<div class="title"><code>createCache()</code> method</div>
<p>Invoke the <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/manager/EmbeddedCacheManagerAdmin.html#createCache(java.lang.String,java.lang.String)"><code>createCache()</code></a> method to create caches dynamically across the entire cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Cache&lt;String, String&gt; myCache = manager.administration().createCache("myCache", "myTemplate");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding operation also automatically creates caches on any nodes that subsequently join the cluster.</p>
</div>
<div class="paragraph">
<p>Caches that you create with the <code>createCache()</code> method are ephemeral by default. If the entire cluster shuts down, the cache is not automatically created again when it restarts.</p>
</div>
<div class="paragraph">
<div class="title"><code>PERMANENT</code> flag</div>
<p>Use the PERMANENT flag to ensure that caches can survive restarts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">Cache&lt;String, String&gt; myCache = manager.administration().withFlags(AdminFlag.PERMANENT).createCache("myCache", "myTemplate");</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the PERMANENT flag to take effect, you must enable global state and set a configuration storage provider.</p>
</div>
<div class="paragraph">
<p>For more information about configuration storage providers, see <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/global/GlobalStateConfigurationBuilder.html#configurationStorage(org.infinispan.globalstate.ConfigurationStorage)">GlobalStateConfigurationBuilder#configurationStorage()</a>.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html">EmbeddedCacheManager</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/global/package-summary.html">EmbeddedCacheManager Configuration</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/global/GlobalConfiguration.html">org.infinispan.configuration.global.GlobalConfiguration</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/cache/ConfigurationBuilder.html">org.infinispan.configuration.cache.ConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="cache-modes_creating-embedded-caches"><a class="anchor" href="#cache-modes_creating-embedded-caches"></a>3.4.3. Cache API</h4>
<div class="paragraph">
<p>Infinispan provides a <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/Cache.html">Cache</a> interface that exposes simple methods for adding, retrieving and removing entries, including atomic mechanisms exposed by the JDK&#8217;s ConcurrentMap interface.  Based on the cache mode used, invoking these methods will trigger a number of things to happen, potentially even including replicating an entry to a remote node or looking up an entry from a remote node, or potentially a cache store.</p>
</div>
<div class="paragraph">
<p>For simple usage, using the Cache API should be no different from using the JDK Map API, and hence migrating from simple in-memory caches based on a Map to Infinispan&#8217;s Cache should be trivial.</p>
</div>
<div class="paragraph">
<div class="title">Performance Concerns of Certain Map Methods</div>
<p>Certain methods exposed in Map have certain performance consequences when used with Infinispan, such as
<a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/Cache.html#size()">size()</a> ,
<a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/Cache.html#values()">values()</a> ,
<a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/Cache.html#keySet()">keySet()</a> and
<a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/Cache.html#entrySet()">entrySet()</a> .
Specific methods on the <code>keySet</code>, <code>values</code> and <code>entrySet</code> are fine for use please see their Javadoc for further details.</p>
</div>
<div class="paragraph">
<p>Attempting to perform these operations globally would have large performance impact as well as become a scalability bottleneck.  As such, these methods should only be used for informational or debugging purposes only.</p>
</div>
<div class="paragraph">
<p>It should be noted that using certain flags with the <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/AdvancedCache.html#withFlags(java.util.Collection)">withFlags()</a> method can mitigate some of these concerns, please check each method&#8217;s documentation for more details.</p>
</div>
<div class="paragraph">
<div class="title">Mortal and Immortal Data</div>
<p>Further to simply storing entries, Infinispan&#8217;s cache API allows you to attach mortality information to data.  For example, simply using <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java/util/Map.html#put-K-V-">put(key, value)</a> would create an <em>immortal</em> entry, i.e., an entry that lives in the cache forever, until it is removed (or evicted from memory to prevent running out of memory).  If, however, you put data in the cache using <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/commons/api/BasicCache.html#put(K,V,long,java.util.concurrent.TimeUnit)">put(key, value, lifespan, timeunit)</a> , this creates a <em>mortal</em> entry, i.e., an entry that has a fixed lifespan and expires after that lifespan.</p>
</div>
<div class="paragraph">
<p>In addition to <em>lifespan</em> , Infinispan also supports <em>maxIdle</em> as an additional metric with which to determine expiration.  Any combination of lifespans or maxIdles can be used.</p>
</div>
<div class="paragraph">
<div class="title"><code>putForExternalRead</code> operation</div>
<p>Infinispan&#8217;s <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/Cache.html">Cache</a> class contains a different 'put' operation called <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K,V)">putForExternalRead</a> . This operation is particularly useful when Infinispan is used as a temporary cache for data that is persisted elsewhere.  Under heavy read scenarios, contention in the cache should not delay the real transactions at hand, since caching should just be an optimization and not something that gets in the way.</p>
</div>
<div class="paragraph">
<p>To achieve this, <code>putForExternalRead()</code> acts as a put call that only operates if the key is not present in the cache, and fails fast and silently if another thread is trying to store the same key at the same time. In this particular scenario, caching data is a way to optimise the system and it&#8217;s not desirable that a failure in caching affects the on-going transaction, hence why failure is handled differently. <code>putForExternalRead()</code> is considered to be a fast operation because regardless of whether it&#8217;s successful or not, it doesn&#8217;t wait for any locks, and so returns to the caller promptly.</p>
</div>
<div class="paragraph">
<p>To understand how to use this operation, let&#8217;s look at basic example. Imagine a cache of Person instances, each keyed by a PersonId , whose data originates in a separate data store. The following code shows the most common pattern of using <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K,V)">putForExternalRead</a> within the context of this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// Id of the person to look up, provided by the application
PersonId id = ...;

// Get a reference to the cache where person instances will be stored
Cache&lt;PersonId, Person&gt; cache = ...;

// First, check whether the cache contains the person instance
// associated with with the given id
Person cachedPerson = cache.get(id);

if (cachedPerson == null) {
   // The person is not cached yet, so query the data store with the id
   Person person = dataStore.lookup(id);

   // Cache the person along with the id so that future requests can
   // retrieve it from memory rather than going to the data store
   cache.putForExternalRead(id, person);
} else {
   // The person was found in the cache, so return it to the application
   return cachedPerson;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K,V)">putForExternalRead</a> should never be used as a mechanism to update the cache with a new Person instance originating from application execution (i.e. from a transaction that modifies a Person&#8217;s address). When updating cached values, please use the standard <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java/util/Map.html#put-K-V-">put</a> operation, otherwise the possibility of caching corrupt data is likely.</p>
</div>
<div class="sect4">
<h5 id="advancedcache_api"><a class="anchor" href="#advancedcache_api"></a>AdvancedCache API</h5>
<div class="paragraph">
<p>In addition to the simple Cache interface, Infinispan offers an <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> interface, geared towards extension authors.  The AdvancedCache offers the ability to access certain internal components and to apply flags to alter the default behavior of certain cache methods.  The following code snippet depicts how an AdvancedCache can be obtained:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">AdvancedCache advancedCache = cache.getAdvancedCache();</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="flags"><a class="anchor" href="#flags"></a>Flags</h6>
<div class="paragraph">
<p>Flags are applied to regular cache methods to alter the behavior of certain methods.  For a list of all available flags, and their effects, see the <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/context/Flag.html">Flag</a> enumeration.  Flags are applied using <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/AdvancedCache.html#withFlags(java.util.Collection)">AdvancedCache.withFlags()</a> .  This builder method can be used to apply any number of flags to a cache invocation, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">advancedCache.withFlags(Flag.CACHE_MODE_LOCAL, Flag.SKIP_LOCKING)
   .withFlags(Flag.FORCE_SYNCHRONOUS)
   .put("hello", "world");</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cache_asynchronous_api"><a class="anchor" href="#cache_asynchronous_api"></a>Asynchronous API</h5>
<div class="paragraph">
<p>In addition to synchronous API methods like <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java/util/Map.html#put-K-V-">Cache.put()</a> , <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java/util/Map.html#remove-java.lang.Object-">Cache.remove()</a> , etc., Infinispan also has an asynchronous, non-blocking API where you can achieve the same results in a non-blocking fashion.</p>
</div>
<div class="paragraph">
<p>These methods are named in a similar fashion to their blocking counterparts, with "Async" appended.  E.g., <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/commons/api/AsyncCache.html#putAsync(K,V)">Cache.putAsync()</a> , <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/commons/api/AsyncCache.html#removeAsync(java.lang.Object)">Cache.removeAsync()</a> , etc.  These asynchronous counterparts return a <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a> that contains the actual result of the operation.</p>
</div>
<div class="paragraph">
<p>For example, in a cache parameterized as <code>Cache&lt;String, String&gt;</code>, <code>Cache.put(String key, String value)</code> returns <code>String</code> while <code>Cache.putAsync(String key, String value)</code> returns <code>CompletableFuture&lt;String&gt;</code>.</p>
</div>
<div class="sect5">
<h6 id="why_use_such_an_api"><a class="anchor" href="#why_use_such_an_api"></a>Why use such an API?</h6>
<div class="paragraph">
<p>Non-blocking APIs are powerful in that they provide all of the guarantees of synchronous communications - with the ability to handle communication failures and exceptions - with the ease of not having to block until a call completes.  This allows you to better harness parallelism in your system.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Set&lt;CompletableFuture&lt;?&gt;&gt; futures = new HashSet&lt;&gt;();
futures.add(cache.putAsync(key1, value1)); // does not block
futures.add(cache.putAsync(key2, value2)); // does not block
futures.add(cache.putAsync(key3, value3)); // does not block

// the remote calls for the 3 puts will effectively be executed
// in parallel, particularly useful if running in distributed mode
// and the 3 keys would typically be pushed to 3 different nodes
// in the cluster

// check that the puts completed successfully
for (CompletableFuture&lt;?&gt; f: futures) f.get();</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="which_processes_actually_happen_asynchronously"><a class="anchor" href="#which_processes_actually_happen_asynchronously"></a>Which processes actually happen asynchronously?</h6>
<div class="paragraph">
<p>There are 4 things in Infinispan that can be considered to be on the critical path of a typical write operation.
These are, in order of cost:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>network calls</p>
</li>
<li>
<p>marshalling</p>
</li>
<li>
<p>writing to a cache store (optional)</p>
</li>
<li>
<p>locking</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using the async methods will take the network calls and marshalling off the critical path.  For various technical reasons, writing to a cache store and acquiring locks, however, still happens in the caller&#8217;s thread.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="statistics-jmx"><a class="anchor" href="#statistics-jmx"></a>4. Enabling and configuring Infinispan statistics and JMX monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan can provide Cache Manager and cache statistics as well as export JMX MBeans.</p>
</div>
<div class="sect2">
<h3 id="enabling-statistics-embedded_statistics-jmx"><a class="anchor" href="#enabling-statistics-embedded_statistics-jmx"></a>4.1. Enabling statistics in embedded caches</h3>
<div class="paragraph">
<p>Configure Infinispan to export statistics for the Cache Manager and embedded caches.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add the <code>statistics="true"</code> attribute or the <code>.statistics(true)</code> method.</p>
</li>
<li>
<p>Save and close your Infinispan configuration.</p>
</li>
</ol>
</div>
<h4 id="embedded_cache_statistics" class="discrete">Embedded cache statistics</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container statistics="true"&gt;
    &lt;distributed-cache statistics="true"/&gt;
    &lt;replicated-cache statistics="true"/&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">GlobalConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">GlobalConfigurationBuilder global = GlobalConfigurationBuilder.defaultClusteredBuilder().cacheContainer().statistics(true);
DefaultCacheManager cacheManager = new DefaultCacheManager(global.build());

Configuration builder = new ConfigurationBuilder();
builder.statistics().enable();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enabling-statistics-remote_statistics-jmx"><a class="anchor" href="#enabling-statistics-remote_statistics-jmx"></a>4.2. Enabling statistics in remote caches</h3>
<div class="paragraph">
<p>Infinispan Server automatically enables statistics for the default Cache Manager.
However, you must explicitly enable statistics for your caches.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add the <code>statistics</code> attribute or field and specify <code>true</code> as the value.</p>
</li>
<li>
<p>Save and close your Infinispan configuration.</p>
</li>
</ol>
</div>
<h4 id="remote_cache_statistics" class="discrete">Remote cache statistics</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache statistics="true" /&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "statistics": "true"
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  statistics: true</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enabling-hotrod-client-statistics_statistics-jmx"><a class="anchor" href="#enabling-hotrod-client-statistics_statistics-jmx"></a>4.3. Enabling Hot Rod client statistics</h3>
<div class="paragraph">
<p>Hot Rod Java clients can provide statistics that include remote cache and near-cache hits and misses as well as connection pool usage.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Hot Rod Java client configuration for editing.</p>
</li>
<li>
<p>Set <code>true</code> as the value for the <code>statistics</code> property or invoke the <code>statistics().enable()</code> methods.</p>
</li>
<li>
<p>Export JMX MBeans for your Hot Rod client with the <code>jmx</code> and <code>jmx_domain</code> properties or invoke the <code>jmxEnable()</code> and <code>jmxDomain()</code> methods.</p>
</li>
<li>
<p>Save and close your client configuration.</p>
</li>
</ol>
</div>
<h4 id="hot_rod_java_client_statistics" class="discrete">Hot Rod Java client statistics</h4>
<div class="listingblock primary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.statistics().enable()
         .jmxEnable()
         .jmxDomain("my.domain.org")
       .addServer()
         .host("127.0.0.1")
         .port(11222);
RemoteCacheManager remoteCacheManager = new RemoteCacheManager(builder.build());</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">hotrod-client.properties</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">infinispan.client.hotrod.statistics = true
infinispan.client.hotrod.jmx = true
infinispan.client.hotrod.jmx_domain = my.domain.org</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-metrics_statistics-jmx"><a class="anchor" href="#configuring-metrics_statistics-jmx"></a>4.4. Configuring Infinispan metrics</h3>
<div class="paragraph">
<p>Infinispan generates metrics that are compatible with any monitoring system.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gauges provide values such as the average number of nanoseconds for write operations or JVM uptime.</p>
</li>
<li>
<p>Histograms provide details about operation execution times such as read,
write, and remove times.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, Infinispan generates gauges when you enable statistics but you can also configure it to generate histograms.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan metrics are provided at the <code>vendor</code> scope.
Metrics related to the JVM are provided in the <code>base</code> scope.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must add Micrometer Core and Micrometer Registry Prometheus JARs to your classpath to export Infinispan metrics for embedded caches.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add the <code>metrics</code> element or object to the cache container.</p>
</li>
<li>
<p>Enable or disable gauges with the <code>gauges</code> attribute or field.</p>
</li>
<li>
<p>Enable or disable histograms with the <code>histograms</code> attribute or field.</p>
</li>
<li>
<p>Save and close your client configuration.</p>
</li>
</ol>
</div>
<h4 id="metrics_configuration" class="discrete">Metrics configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container statistics="true"&gt;
    &lt;metrics gauges="true"
             histograms="true" /&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "statistics" : "true",
      "metrics" : {
        "gauges" : "true",
        "histograms" : "true"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    statistics: "true"
    metrics:
      gauges: "true"
      histograms: "true"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">GlobalConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">GlobalConfiguration globalConfig = new GlobalConfigurationBuilder()
  //Computes and collects statistics for the Cache Manager.
  .statistics().enable()
  //Exports collected statistics as gauge and histogram metrics.
  .metrics().gauges(true).histograms(true)
  .build();</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Verification</div>
<p>Infinispan Server exposes statistics through the <code>metrics</code> endpoint that you can collect with monitoring tools such as Prometheus.
To verify that statistics are exported to the <code>metrics</code> endpoint, you can do the following:</p>
</div>
<div class="listingblock primary">
<div class="title">Prometheus format</div>
<div class="content">
<pre class="highlight nowrap"><code>curl -v http://localhost:11222/metrics \
--digest -u username:password</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">OpenMetrics format</div>
<div class="content">
<pre class="highlight nowrap"><code>curl -v http://localhost:11222/metrics \
--digest -u username:password \
-H "Accept: application/openmetrics-text"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan no longer provides metrics in MicroProfile JSON format.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://micrometer.io/docs/registry/prometheus">Micrometer Prometheus</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="enabling-jmx_statistics-jmx"><a class="anchor" href="#enabling-jmx_statistics-jmx"></a>4.5. Registering JMX MBeans</h3>
<div class="paragraph">
<p>Infinispan can register JMX MBeans that you can use to collect statistics and
perform administrative operations.
You must also enable statistics otherwise Infinispan provides <code>0</code> values for all statistic attributes in JMX MBeans.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add the <code>jmx</code> element or object to the cache container and specify <code>true</code> as the value for the <code>enabled</code> attribute or field.</p>
</li>
<li>
<p>Add the <code>domain</code> attribute or field and specify the domain where JMX MBeans are exposed, if required.</p>
</li>
<li>
<p>Save and close your client configuration.</p>
</li>
</ol>
</div>
<h4 id="jmx_configuration" class="discrete">JMX configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container statistics="true"&gt;
    &lt;jmx enabled="true"
         domain="example.com"/&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "statistics" : "true",
      "jmx" : {
        "enabled" : "true",
        "domain" : "example.com"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    statistics: "true"
    jmx:
      enabled: "true"
      domain: "example.com"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">GlobalConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">GlobalConfiguration global = GlobalConfigurationBuilder.defaultClusteredBuilder()
   .jmx().enable()
   .domain("org.mydomain");</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="enabling-jmx-port_statistics-jmx"><a class="anchor" href="#enabling-jmx-port_statistics-jmx"></a>4.5.1. Enabling JMX remote ports</h4>
<div class="paragraph">
<p>Provide unique remote JMX ports to expose Infinispan MBeans through connections in JMXServiceURL format.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan Server does not expose JMX remotely via the single port endpoint.
If you want to remotely access Infinispan Server via JMX you must enable a remote port.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can enable remote JMX ports using one of the following approaches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable remote JMX ports that require authentication to one of the Infinispan Server security realms.</p>
</li>
<li>
<p>Enable remote JMX ports manually using the standard Java management configuration options.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>For remote JMX with authentication, define JMX specific user roles using the default security realm.
Users must have <code>controlRole</code> with read/write access or the <code>monitorRole</code> with read-only access to access any JMX resources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Start Infinispan Server with a remote JMX port enabled using one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable remote JMX through port <code>9999</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>bin/server.sh --jmx 9999</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Using remote JMX with SSL disabled is not intended for production environments.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Pass the following system properties to Infinispan Server at startup.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>bin/server.sh -Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Enabling remote JMX with no authentication or SSL is not secure and not recommended in any environment.
Disabling authentication and SSL allows unauthorized users to connect to your server and access the data hosted there.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../server/server.html#creating-security-realms_security-realms">Creating security realms</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="jmx-mbeans_statistics-jmx"><a class="anchor" href="#jmx-mbeans_statistics-jmx"></a>4.5.2. Infinispan MBeans</h4>
<div class="paragraph">
<p>Infinispan exposes JMX MBeans that represent manageable resources.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>org.infinispan:type=Cache</code></dt>
<dd>
<p>Attributes and operations available for cache instances.</p>
</dd>
<dt class="hdlist1"><code>org.infinispan:type=CacheManager</code></dt>
<dd>
<p>Attributes and operations available for Cache Managers, including Infinispan cache and cluster health statistics.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For a complete list of available JMX MBeans along with descriptions and
available operations and attributes, see the <em>Infinispan JMX Components</em>
documentation.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/jmxComponents.html">Infinispan JMX Components</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="registering-jmx-mbean-servers-statistics-jmx"><a class="anchor" href="#registering-jmx-mbean-servers-statistics-jmx"></a>4.5.3. Registering MBeans in custom MBean servers</h4>
<div class="paragraph">
<p>Infinispan includes an <code>MBeanServerLookup</code> interface that you can use to
register MBeans in custom MBeanServer instances.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create an implementation of <code>MBeanServerLookup</code> so that the <code>getMBeanServer()</code> method returns the custom MBeanServer instance.</p>
</li>
<li>
<p>Configure Infinispan to register JMX MBeans.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add the <code>mbean-server-lookup</code> attribute or field to the JMX configuration for the Cache Manager.</p>
</li>
<li>
<p>Specify fully qualified name (FQN) of your <code>MBeanServerLookup</code> implementation.</p>
</li>
<li>
<p>Save and close your client configuration.</p>
</li>
</ol>
</div>
<h5 id="jmx_mbean_server_lookup_configuration" class="discrete">JMX MBean server lookup configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container statistics="true"&gt;
    &lt;jmx enabled="true"
         domain="example.com"
         mbean-server-lookup="com.example.MyMBeanServerLookup"/&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "statistics" : "true",
      "jmx" : {
        "enabled" : "true",
        "domain" : "example.com",
        "mbean-server-lookup" : "com.example.MyMBeanServerLookup"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    statistics: "true"
    jmx:
      enabled: "true"
      domain: "example.com"
      mbeanServerLookup: "com.example.MyMBeanServerLookup"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">GlobalConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">GlobalConfiguration global = GlobalConfigurationBuilder.defaultClusteredBuilder()
   .jmx().enable()
   .domain("org.mydomain")
   .mBeanServerLookup(new com.acme.MyMBeanServerLookup());</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="displaying-metrics-state-transfer_statistics-jmx"><a class="anchor" href="#displaying-metrics-state-transfer_statistics-jmx"></a>4.6. Exporting metrics during a state transfer operation</h3>
<div class="paragraph">
<p>You can export time metrics for clustered caches that Infinispan redistributes across nodes.</p>
</div>
<div class="paragraph">
<p>A state transfer operation occurs when a clustered cache topology changes, such as a node joining or leaving a cluster.
During a state transfer operation, Infinispan exports metrics from each cache, so that you can determine a cache&#8217;s status.
A state transfer exposes attributes as properties, so that Infinispan can export metrics from each cache.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot perform a state transfer operation in invalidation mode.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Infinispan generates time metrics that are compatible with the REST API and the JMX API.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Configure Infinispan metrics.</p>
</li>
<li>
<p>Enable metrics for your cache type, such as embedded cache or remote cache.</p>
</li>
<li>
<p>Initiate a state transfer operation by changing your clustered cache topology.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Choose one of the following methods:</p>
<div class="ulist">
<ul>
<li>
<p>Configure Infinispan to use the REST API to collect metrics.</p>
</li>
<li>
<p>Configure Infinispan to use the JMX API to collect metrics.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../configuring/configuring.html#statistics-jmx">Enabling and configuring Infinispan statistics and JMX monitoring (Infinispan caches)</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocsjmxComponents.html#StateTransferManager"><code>StateTransferManager</code> (Infinispan 14.0 API)</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="monitor-xsite-replication"><a class="anchor" href="#monitor-xsite-replication"></a>4.7. Monitoring the status of cross-site replication</h3>
<div class="paragraph">
<p>Monitor the site status of your backup locations to detect interruptions in the communication between the sites.
When a remote site status changes to <code>offline</code>, Infinispan stops replicating your data to the backup location.
Your data become out of sync and you must fix the inconsistencies before bringing the clusters back online.</p>
</div>
<div class="paragraph">
<p>Monitoring cross-site events is necessary for early problem detection.
Use one of the following monitoring strategies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#monitoring-cross-site-rest">Monitoring cross-site replication with the REST API</a></p>
</li>
<li>
<p><a href="#monitoring-cross-site-prometheus">Monitoring cross-site replication with the Prometheus metrics</a> or any other monitoring system</p>
</li>
</ul>
</div>
<h4 id="monitoring-cross-site-rest" class="discrete">Monitoring cross-site replication with the REST API</h4>
<div class="paragraph">
<p>Monitor the status of cross-site replication for all caches using the REST endpoint.
You can implement a custom script to poll the REST endpoint or use the following example.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Enable cross-site replication.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Implement a script to poll the REST endpoint.</p>
<div class="paragraph">
<p>The following example demonstrates how you can use a Python script to poll the site status every five seconds.</p>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-python" data-lang="python">#!/usr/bin/python3
import time
import requests
from requests.auth import HTTPDigestAuth


class InfinispanConnection:

    def __init__(self, server: str = 'http://localhost:11222', cache_manager: str = 'default',
                 auth: tuple = ('admin', 'change_me')) -&gt; None:
        super().__init__()
        self.__url = f'{server}/rest/v2/cache-managers/{cache_manager}/x-site/backups/'
        self.__auth = auth
        self.__headers = {
            'accept': 'application/json'
        }

    def get_sites_status(self):
        try:
            rsp = requests.get(self.__url, headers=self.__headers, auth=HTTPDigestAuth(self.__auth[0], self.__auth[1]))
            if rsp.status_code != 200:
                return None
            return rsp.json()
        except:
            return None


# Specify credentials for Infinispan user with permission to access the REST endpoint
USERNAME = 'admin'
PASSWORD = 'change_me'
# Set an interval between cross-site status checks
POLL_INTERVAL_SEC = 5
# Provide a list of servers
SERVERS = [
    InfinispanConnection('http://127.0.0.1:11222', auth=(USERNAME, PASSWORD)),
    InfinispanConnection('http://127.0.0.1:12222', auth=(USERNAME, PASSWORD))
]
#Specify the names of remote sites
REMOTE_SITES = [
    'nyc'
]
#Provide a list of caches to monitor
CACHES = [
    'work',
    'sessions'
]


def on_event(site: str, cache: str, old_status: str, new_status: str):
    # TODO implement your handling code here
    print(f'site={site} cache={cache} Status changed {old_status} -&gt; {new_status}')


def __handle_mixed_state(state: dict, site: str, site_status: dict):
    if site not in state:
        state[site] = {c: 'online' if c in site_status['online'] else 'offline' for c in CACHES}
        return

    for cache in CACHES:
        __update_cache_state(state, site, cache, 'online' if cache in site_status['online'] else 'offline')


def __handle_online_or_offline_state(state: dict, site: str, new_status: str):
    if site not in state:
        state[site] = {c: new_status for c in CACHES}
        return

    for cache in CACHES:
        __update_cache_state(state, site, cache, new_status)


def __update_cache_state(state: dict, site: str, cache: str, new_status: str):
    old_status = state[site].get(cache)
    if old_status != new_status:
        on_event(site, cache, old_status, new_status)
        state[site][cache] = new_status


def update_state(state: dict):
    rsp = None
    for conn in SERVERS:
        rsp = conn.get_sites_status()
        if rsp:
            break
    if rsp is None:
        print('Unable to fetch site status from any server')
        return

    for site in REMOTE_SITES:
        site_status = rsp.get(site, {})
        new_status = site_status.get('status')
        if new_status == 'mixed':
            __handle_mixed_state(state, site, site_status)
        else:
            __handle_online_or_offline_state(state, site, new_status)


if __name__ == '__main__':
    _state = {}
    while True:
        update_state(_state)
        time.sleep(POLL_INTERVAL_SEC)</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a site status changes from <code>online</code> to <code>offline</code> or vice-versa, the function <code>on_event</code> is invoked.</p>
</div>
<div class="paragraph">
<p>If you want to use this script, you must specify the following variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>USERNAME</code> and <code>PASSWORD</code>: The username and password of Infinispan user with permission to access the REST endpoint.</p>
</li>
<li>
<p><code>POLL_INTERVAL_SEC</code>: The number of seconds between polls.</p>
</li>
<li>
<p><code>SERVERS</code>: The list of Infinispan Servers at this site.
The script only requires a single valid response but the list is provided to allow fail over.</p>
</li>
<li>
<p><code>REMOTE_SITES</code>: The list of remote sites to monitor on these servers.</p>
</li>
<li>
<p><code>CACHES</code>: The list of cache names to monitor.</p>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../rest/rest.html#rest_v2_cache_manager_site_status_rest">REST API: Getting status of backup locations</a></p>
</li>
</ul>
</div>
<h4 id="monitoring-cross-site-prometheus" class="discrete">Monitoring cross-site replication with the Prometheus metrics</h4>
<div class="paragraph">
<p>Prometheus, and other monitoring systems, let you configure alerts to detect when a site status changes to <code>offline</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Monitoring cross-site latency metrics can help you to discover potential issues.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Enable cross-site replication.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure Infinispan metrics.</p>
</li>
<li>
<p>Configure alerting rules using the Prometheus metrics format.</p>
<div class="ulist">
<ul>
<li>
<p>For the site status, use <code>1</code> for <code>online</code> and <code>0</code> for <code>offline</code>.</p>
</li>
<li>
<p>For the <code>expr</code> filed, use the following format:<br>
<code>vendor_cache_manager_default_cache_&lt;cache name&gt;_x_site_admin_&lt;site name&gt;_status</code>.</p>
<div class="paragraph">
<p>In the following example, Prometheus alerts you when the <strong>NYC</strong> site gets <code>offline</code> for cache named <code>work</code> or <code>sessions</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">groups:
- name: Cross Site Rules
  rules:
  - alert: Cache Work and Site NYC
    expr: vendor_cache_manager_default_cache_work_x_site_admin_nyc_status == 0
  - alert: Cache Sessions and Site NYC
    expr: vendor_cache_manager_default_cache_sessions_x_site_admin_nyc_status == 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following image shows an alert that the <strong>NYC</strong> site is <code>offline</code> for cache <code>work</code>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/prometheus_xsite_alert.png" alt="prometheus xsite alert">
</div>
<div class="title">Figure 6. Prometheus Alert</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../server/server.html#configuring-metrics_statistics-jmx">Configuring Infinispan metrics</a></p>
</li>
<li>
<p><a href="https://prometheus.io/docs/alerting/latest/overview/">Prometheus Alerting Overview</a></p>
</li>
<li>
<p><a href="https://grafana.com/docs/grafana/latest/alerting/">Grafana Alerting Documentation</a></p>
</li>
<li>
<p><a href="https://docs.openshift.com/container-platform/latest/monitoring/managing-alerts.html#creating-alerting-rules-for-user-defined-projects_managing-alerts">Openshift Managing Alerts</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-memory-usage"><a class="anchor" href="#configuring-memory-usage"></a>5. Configuring JVM memory usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Control how Infinispan stores data in JVM memory by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Managing JVM memory usage with eviction that automatically removes data from caches.</p>
</li>
<li>
<p>Adding lifespan and maximum idle times to expire entries and prevent stale data.</p>
</li>
<li>
<p>Configuring Infinispan to store data in off-heap, native memory.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="default-memory_configuring-memory-usage"><a class="anchor" href="#default-memory_configuring-memory-usage"></a>5.1. Default memory configuration</h3>
<div class="paragraph">
<p>By default Infinispan stores cache entries as objects in the JVM heap.
Over time, as applications add entries, the size of caches can exceed the amount of memory that is available to the JVM.
Likewise, if Infinispan is not the primary data store, then entries become out of date which means your caches contain stale data.</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;memory storage="HEAP"/&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "memory" : {
      "storage": "HEAP"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  memory:
    storage: "HEAP"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="eviction-and-expiration_configuring-memory-usage"><a class="anchor" href="#eviction-and-expiration_configuring-memory-usage"></a>5.2. Eviction and expiration</h3>
<div class="paragraph">
<p>Eviction and expiration are two strategies for cleaning the data container by
removing old, unused entries.
Although eviction and expiration are similar, they have some important differences.</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-check-square-o"></i> Eviction lets Infinispan control the size of the data container by removing entries when the container becomes larger than a configured threshold.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Expiration limits the amount of time entries can exist. Infinispan uses
a scheduler to periodically remove expired entries. Entries that are expired
but not yet removed are immediately removed on access; in this case <code>get()</code>
calls for expired entries return "null" values.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Eviction is local to Infinispan nodes.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Expiration takes place across Infinispan clusters.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> You can use eviction and expiration together or independently of each other.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> You can configure eviction and expiration declaratively in <code>infinispan.xml</code> to apply cache-wide defaults for entries.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> You can explicitly define expiration settings for specific entries but you cannot define eviction on a per-entry basis.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> You can manually evict entries and manually trigger expiration.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="eviction_configuring-memory-usage"><a class="anchor" href="#eviction_configuring-memory-usage"></a>5.3. Eviction with Infinispan caches</h3>
<div class="paragraph">
<p>Eviction lets you control the size of the data container by removing entries from memory in one of two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Total number of entries (<code>max-count</code>).</p>
</li>
<li>
<p>Maximum amount of memory (<code>max-size</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Eviction drops one entry from the data container at a time and is local to the node on which it occurs.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Eviction removes entries from memory but not from persistent cache stores.
To ensure that entries remain available after Infinispan evicts them, and to prevent inconsistencies with your data, you should configure persistent storage.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When you configure <code>memory</code>, Infinispan approximates the current memory usage of the data container.
When entries are added or modified, Infinispan compares the current memory usage of the data container to the maximum size.
If the size exceeds the maximum, Infinispan performs eviction.</p>
</div>
<div class="paragraph">
<p>Eviction happens immediately in the thread that adds an entry that exceeds the maximum size.</p>
</div>
<div class="sect3">
<h4 id="eviction-strategies_configuring-memory-usage"><a class="anchor" href="#eviction-strategies_configuring-memory-usage"></a>5.3.1. Eviction strategies</h4>
<div class="paragraph">
<p>When you configure Infinispan eviction you specify:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The maximum size of the data container.</p>
</li>
<li>
<p>A strategy for removing entries when the cache reaches the threshold.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can either perform eviction manually or configure Infinispan to do one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Remove old entries to make space for new ones.</p>
</li>
<li>
<p>Throw <code>ContainerFullException</code> and prevent new entries from being created.</p>
<div class="paragraph">
<p>The exception eviction strategy works only with transactional caches that use 2 phase commits; not with 1 phase commits or synchronization optimizations.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to the schema reference for more details about the eviction strategies.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan includes the Caffeine caching library that implements a variation
of the Least Frequently Used (LFU) cache replacement algorithm known as
TinyLFU. For off-heap storage, Infinispan uses a custom implementation of the
Least Recently Used (LRU) algorithm.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://github.com/ben-manes/caffeine">Caffeine</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/">Infinispan configuration schema reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="configuring-eviction-total-entries_configuring-memory-usage"><a class="anchor" href="#configuring-eviction-total-entries_configuring-memory-usage"></a>5.3.2. Configuring maximum count eviction</h4>
<div class="paragraph">
<p>Limit the size of Infinispan caches to a total number of entries.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Specify the total number of entries that caches can contain before
Infinispan performs eviction with either the <code>max-count</code> attribute or <code>maxCount()</code> method.</p>
</li>
<li>
<p>Set one of the following as the eviction strategy to control how Infinispan removes entries with the <code>when-full</code> attribute or <code>whenFull()</code> method.</p>
<div class="ulist">
<ul>
<li>
<p><code>REMOVE</code> Infinispan performs eviction. This is the default strategy.</p>
</li>
<li>
<p><code>MANUAL</code> You perform eviction manually for embedded caches.</p>
</li>
<li>
<p><code>EXCEPTION</code> Infinispan throws an exception instead of evicting entries.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Save and close your Infinispan configuration.</p>
</li>
</ol>
</div>
<h5 id="maximum_count_eviction" class="discrete">Maximum count eviction</h5>
<div class="paragraph">
<p>In the following example, Infinispan removes an entry when the cache contains a total of 500 entries and a new entry is created:</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;memory max-count="500" when-full="REMOVE"/&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache" : {
    "memory" : {
      "max-count" : "500",
      "when-full" : "REMOVE"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  memory:
    maxCount: "500"
    whenFull: "REMOVE"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.memory().maxCount(500).whenFull(EvictionStrategy.REMOVE);</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/">Infinispan configuration schema reference</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/cache/MemoryConfigurationBuilder.html">org.infinispan.configuration.cache.MemoryConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="configuring-eviction-maximum-size_configuring-memory-usage"><a class="anchor" href="#configuring-eviction-maximum-size_configuring-memory-usage"></a>5.3.3. Configuring maximum size eviction</h4>
<div class="paragraph">
<p>Limit the size of Infinispan caches to a maximum amount of memory.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Specify <code>application/x-protostream</code> as the media type for cache encoding.</p>
<div class="paragraph">
<p>You must specify a binary media type to use maximum size eviction.</p>
</div>
</li>
<li>
<p>Configure the maximum amount of memory, in bytes, that caches can use before
Infinispan performs eviction with the <code>max-size</code> attribute or <code>maxSize()</code> method.</p>
</li>
<li>
<p>Optionally specify a byte unit of measurement.</p>
<div class="paragraph">
<p>The default is B (bytes). Refer to the configuration schema for supported units.</p>
</div>
</li>
<li>
<p>Set one of the following as the eviction strategy to control how Infinispan removes entries with either the <code>when-full</code> attribute or <code>whenFull()</code> method.</p>
<div class="ulist">
<ul>
<li>
<p><code>REMOVE</code> Infinispan performs eviction. This is the default strategy.</p>
</li>
<li>
<p><code>MANUAL</code> You perform eviction manually for embedded caches.</p>
</li>
<li>
<p><code>EXCEPTION</code> Infinispan throws an exception instead of evicting entries.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Save and close your Infinispan configuration.</p>
</li>
</ol>
</div>
<h5 id="maximum_size_eviction" class="discrete">Maximum size eviction</h5>
<div class="paragraph">
<p>In the following example, Infinispan removes an entry when the size of the cache reaches 1.5 GB (gigabytes) and a new entry is created:</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;encoding media-type="application/x-protostream"/&gt;
  &lt;memory max-size="1.5GB" when-full="REMOVE"/&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache" : {
    "encoding" : {
      "media-type" : "application/x-protostream"
    },
    "memory" : {
      "max-size" : "1.5GB",
      "when-full" : "REMOVE"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  encoding:
    mediaType: "application/x-protostream"
  memory:
    maxSize: "1.5GB"
    whenFull: "REMOVE"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.encoding().mediaType("application/x-protostream")
       .memory()
         .maxSize("1.5GB")
         .whenFull(EvictionStrategy.REMOVE);</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/">Infinispan configuration schema reference</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/cache/EncodingConfiguration.html">org.infinispan.configuration.cache.EncodingConfiguration</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/cache/MemoryConfigurationBuilder.html">org.infinispan.configuration.cache.MemoryConfigurationBuilder</a></p>
</li>
<li>
<p><a href="../encoding/encoding.html">Cache Encoding and Marshalling</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="eviction-manual_configuring-memory-usage"><a class="anchor" href="#eviction-manual_configuring-memory-usage"></a>5.3.4. Manual eviction</h4>
<div class="paragraph">
<p>If you choose the manual eviction strategy, Infinispan does not perform eviction.
You must do so manually with the <code>evict()</code> method.</p>
</div>
<div class="paragraph">
<p>You should use manual eviction with embedded caches only.
For remote caches, you should always configure Infinispan with the <code>REMOVE</code> or <code>EXCEPTION</code> eviction strategy.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This configuration prevents a warning message when you enable passivation but do not configure eviction.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;memory max-count="500" when-full="MANUAL"/&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache" : {
    "memory" : {
      "max-count" : "500",
      "when-full" : "MANUAL"
    }
  }
 }</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  memory:
    maxCount: "500"
    whenFull: "MANUAL"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.encoding().mediaType("application/x-protostream")
       .memory()
         .maxSize("1.5GB")
         .whenFull(EvictionStrategy.REMOVE);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="eviction-passivation_configuring-memory-usage"><a class="anchor" href="#eviction-passivation_configuring-memory-usage"></a>5.3.5. Passivation with eviction</h4>
<div class="paragraph">
<p>Passivation persists data to cache stores when Infinispan evicts entries.
You should always enable eviction if you enable passivation, as in the following examples:</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence passivation="true"&gt;
    &lt;!-- Persistent storage configuration. --&gt;
  &lt;/persistence&gt;
  &lt;memory max-count="100"/&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "memory" : {
      "max-count" : "100"
    },
    "persistence" : {
      "passivation" : true
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  memory:
    maxCount: "100"
  persistence:
    passivation: "true"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.memory().maxCount(100);
builder.persistence().passivation(true); //Persistent storage configuration</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="expiration_configuring-memory-usage"><a class="anchor" href="#expiration_configuring-memory-usage"></a>5.4. Expiration with lifespan and maximum idle</h3>
<div class="paragraph">
<p>Expiration configures Infinispan to remove entries from caches when they reach one of the following time limits:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Lifespan</dt>
<dd>
<p>Sets the maximum amount of time that entries can exist.</p>
</dd>
<dt class="hdlist1">Maximum idle</dt>
<dd>
<p>Specifies how long entries can remain idle. If operations do not occur for
entries, they become idle.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Maximum idle expiration does not currently support caches with persistent storage.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you use expiration and eviction with the <code>EXCEPTION</code> eviction strategy, entries that are expired, but not yet removed from the cache, count towards the size of the data container.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="how-expiration-works_configuring-memory-usage"><a class="anchor" href="#how-expiration-works_configuring-memory-usage"></a>5.4.1. How expiration works</h4>
<div class="paragraph">
<p>When you configure expiration, Infinispan stores keys with metadata that
determines when entries expire.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lifespan uses a <code>creation</code> timestamp and the value for the <code>lifespan</code> configuration property.</p>
</li>
<li>
<p>Maximum idle uses a <code>last used</code> timestamp and the value for the <code>max-idle</code> configuration property.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Infinispan checks if lifespan or maximum idle metadata is set and then
compares the values with the current time.</p>
</div>
<div class="paragraph">
<p>If <code>(creation + lifespan &lt; currentTime)</code> or <code>(lastUsed + maxIdle &lt; currentTime)</code> then Infinispan detects that the entry is expired.</p>
</div>
<div class="paragraph">
<p>Expiration occurs whenever entries are accessed or found by the expiration
reaper.</p>
</div>
<div class="paragraph">
<p>For example, <code>k1</code> reaches the maximum idle time and a client makes a
<code>Cache.get(k1)</code> request. In this case, Infinispan detects that the entry is
expired and removes it from the data container. The <code>Cache.get(k1)</code> request returns <code>null</code>.</p>
</div>
<div class="paragraph">
<p>Infinispan also expires entries from cache stores, but only with lifespan
expiration. Maximum idle expiration does not work with cache stores. In the
case of cache loaders, Infinispan cannot expire entries because loaders can
only read from external storage.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan adds expiration metadata as <code>long</code> primitive data types to cache
entries. This can increase the size of keys by as much as 32 bytes.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="expiration-reaper_configuring-memory-usage"><a class="anchor" href="#expiration-reaper_configuring-memory-usage"></a>5.4.2. Expiration reaper</h4>
<div class="paragraph">
<p>Infinispan uses a reaper thread that runs periodically to detect and remove
expired entries. The expiration reaper ensures that expired entries that are no
longer accessed are removed.</p>
</div>
<div class="paragraph">
<p>The Infinispan <code>ExpirationManager</code> interface handles the expiration reaper and
exposes the <code>processExpiration()</code> method.</p>
</div>
<div class="paragraph">
<p>In some cases, you can disable the expiration reaper and manually expire
entries by calling <code>processExpiration()</code>; for instance, if you are using local
cache mode with a custom application where a maintenance thread runs
periodically.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you use clustered cache modes, you should never disable the expiration
reaper.</p>
</div>
<div class="paragraph">
<p>Infinispan always uses the expiration reaper when using cache stores. In this
case you cannot disable it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/cache/ExpirationConfigurationBuilder.html">org.infinispan.configuration.cache.ExpirationConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/expiration/ExpirationManager.html">org.infinispan.expiration.ExpirationManager</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="expiration-maxidle_configuring-memory-usage"><a class="anchor" href="#expiration-maxidle_configuring-memory-usage"></a>5.4.3. Maximum idle and clustered caches</h4>
<div class="paragraph">
<p>Because maximum idle expiration relies on the last access time for cache
entries, it has some limitations with clustered cache modes.</p>
</div>
<div class="paragraph">
<p>With lifespan expiration, the creation time for cache entries provides a value
that is consistent across clustered caches. For example, the creation time for
<code>k1</code> is always the same on all nodes.</p>
</div>
<div class="paragraph">
<p>For maximum idle expiration with clustered caches, last access time for entries
is not always the same on all nodes. To ensure that entries have the same
relative access times across clusters, Infinispan sends touch commands to all
owners when keys are accessed.</p>
</div>
<div class="paragraph">
<p>The touch commands that Infinispan send have the following considerations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Cache.get()</code> requests do not return until all touch commands complete. This synchronous behavior increases latency of client requests.</p>
</li>
<li>
<p>The touch command also updates the "recently accessed" metadata for cache entries on all owners, which Infinispan uses for eviction.</p>
</li>
<li>
<p>With scattered cache mode, Infinispan sends touch commands to all nodes, not just primary and backup owners.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Additional information</div>
<ul>
<li>
<p>Maximum idle expiration does not work with invalidation mode.</p>
</li>
<li>
<p>Iteration across a clustered cache can return expired entries that have
exceeded the maximum idle time limit. This behavior ensures performance because
no remote invocations are performed during the iteration. Also note that
iteration does not refresh any expired entries.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="configuring-expiration-for-caches_configuring-memory-usage"><a class="anchor" href="#configuring-expiration-for-caches_configuring-memory-usage"></a>5.4.4. Configuring lifespan and maximum idle times for caches</h4>
<div class="paragraph">
<p>Set lifespan and maximum idle times for all entries in a cache.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Specify the amount of time, in milliseconds, that entries can stay in the cache with the <code>lifespan</code> attribute or <code>lifespan()</code> method.</p>
</li>
<li>
<p>Specify the amount of time, in milliseconds, that entries can remain idle after last access with the <code>max-idle</code> attribute or <code>maxIdle()</code> method.</p>
</li>
<li>
<p>Save and close your Infinispan configuration.</p>
</li>
</ol>
</div>
<h5 id="expiration_for_infinispan_caches" class="discrete">Expiration for Infinispan caches</h5>
<div class="paragraph">
<p>In the following example, Infinispan expires all cache entries after 5 seconds or 1 second after the last access time, whichever happens first:</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;replicated-cache&gt;
  &lt;expiration lifespan="5000" max-idle="1000" /&gt;
&lt;/replicated-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "replicated-cache" : {
    "expiration" : {
      "lifespan" : "5000",
      "max-idle" : "1000"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">replicatedCache:
  expiration:
    lifespan: "5000"
    maxIdle: "1000"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.expiration().lifespan(5000, TimeUnit.MILLISECONDS)
                    .maxIdle(1000, TimeUnit.MILLISECONDS);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-expiration-per-entry_configuring-memory-usage"><a class="anchor" href="#configuring-expiration-per-entry_configuring-memory-usage"></a>5.4.5. Configuring lifespan and maximum idle times per entry</h4>
<div class="paragraph">
<p>Specify lifespan and maximum idle times for individual entries.
When you add lifespan and maximum idle times to entries, those values take priority over expiration configuration for caches.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you explicitly define lifespan and maximum idle time values for cache entries, Infinispan replicates those values across the cluster along with the cache entries.
Likewise, Infinispan writes expiration values along with the entries to persistent storage.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>For remote caches, you can add lifespan and maximum idle times to entries interactively with the Infinispan Console.</p>
<div class="paragraph">
<p>With the Infinispan Command Line Interface (CLI), use the <code>--max-idle=</code> and <code>--ttl=</code> arguments with the <code class="command">put</code> command.</p>
</div>
</li>
<li>
<p>For both remote and embedded caches, you can add lifespan and maximum idle times with <code>cache.put()</code> invocations.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">//Lifespan of 5 seconds.
//Maximum idle time of 1 second.
cache.put("hello", "world", 5, TimeUnit.SECONDS, 1, TimeUnit.SECONDS);

//Lifespan is disabled with a value of -1.
//Maximum idle time of 1 second.
cache.put("hello", "world", -1, TimeUnit.SECONDS, 1, TimeUnit.SECONDS);</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/cache/ExpirationConfigurationBuilder.html">org.infinispan.configuration.cache.ExpirationConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/expiration/ExpirationManager.html">org.infinispan.expiration.ExpirationManager</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="off-heap-memory_configuring-memory-usage"><a class="anchor" href="#off-heap-memory_configuring-memory-usage"></a>5.5. JVM heap and off-heap memory</h3>
<div class="paragraph">
<p>Infinispan stores cache entries in JVM heap memory by default.
You can configure Infinispan to use off-heap storage, which means that your data occupies native memory outside the managed JVM memory space.</p>
</div>
<div class="paragraph">
<p>The following diagram is a simplified illustration of the memory space for a JVM process where Infinispan is running:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../topics/images/jvm_memory_space.png" alt="This diagram depicts the JVM memory space divided into heap and off-heap memory.">
</div>
<div class="title">Figure 7. JVM memory space</div>
</div>
<h4 id="jvm_heap_memory" class="discrete">JVM heap memory</h4>
<div class="paragraph">
<p>The heap is divided into young and old generations that help keep referenced Java objects and other application data in memory.
The GC process reclaims space from unreachable objects, running more frequently on the young generation memory pool.</p>
</div>
<div class="paragraph">
<p>When Infinispan stores cache entries in JVM heap memory, GC runs can take longer to complete as you start adding data to your caches.
Because GC is an intensive process, longer and more frequent runs can degrade application performance.</p>
</div>
<h4 id="off_heap_memory" class="discrete">Off-heap memory</h4>
<div class="paragraph">
<p>Off-heap memory is native available system memory outside JVM memory management.
The <em>JVM memory space</em> diagram shows the <code>Metaspace</code> memory pool that holds class metadata and is allocated from native memory.
The diagram also represents a section of native memory that holds Infinispan cache entries.</p>
</div>
<div class="paragraph">
<p>Off-heap memory:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Uses less memory per entry.</p>
</li>
<li>
<p>Improves overall JVM performance by avoiding Garbage Collector (GC) runs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One disadvantage, however, is that JVM heap dumps do not show entries stored in off-heap memory.</p>
</div>
<div class="sect3">
<h4 id="off-heap-storage_configuring-memory-usage"><a class="anchor" href="#off-heap-storage_configuring-memory-usage"></a>5.5.1. Off-heap data storage</h4>
<div class="paragraph">
<p>When you add entries to off-heap caches, Infinispan dynamically allocates native memory to your data.</p>
</div>
<div class="paragraph">
<p>Infinispan hashes the serialized <code>byte[]</code> for each key into buckets that are similar to a standard Java <code>HashMap</code>.
Buckets include address pointers that Infinispan uses to locate entries that you store in off-heap memory.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even though Infinispan stores cache entries in native memory, run-time operations require JVM heap representations of those objects.
For instance, <code>cache.get()</code> operations read objects into heap memory before returning.
Likewise, state transfer operations hold subsets of objects in heap memory while they take place.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Object equality</div>
<p>Infinispan determines equality of Java objects in off-heap storage using the serialized byte[] representation of each object instead of the object instance.</p>
</div>
<div class="paragraph">
<div class="title">Data consistency</div>
<p>Infinispan uses an array of locks to protect off-heap address spaces.
The number of locks is twice the number of cores and then rounded to the nearest power of two.
This ensures that there is an even distribution of <code>ReadWriteLock</code> instances to prevent write operations from blocking read operations.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring-memory-off-heap_configuring-memory-usage"><a class="anchor" href="#configuring-memory-off-heap_configuring-memory-usage"></a>5.5.2. Configuring off-heap memory</h4>
<div class="paragraph">
<p>Configure Infinispan to store cache entries in native memory outside the JVM
heap space.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Set <code>OFF_HEAP</code> as the value for the <code>storage</code> attribute or <code>storage()</code> method.</p>
</li>
<li>
<p>Set a boundary for the size of the cache by configuring eviction.</p>
</li>
<li>
<p>Save and close your Infinispan configuration.</p>
</li>
</ol>
</div>
<h5 id="off_heap_storage" class="discrete">Off-heap storage</h5>
<div class="paragraph">
<p>Infinispan stores cache entries as bytes in native memory.
Eviction happens when there are 100 entries in the data container and Infinispan gets a request to create a new entry:</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;replicated-cache&gt;
  &lt;memory storage="OFF_HEAP" max-count="500"/&gt;
&lt;/replicated-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "replicated-cache" : {
    "memory" : {
      "storage" : "OFF_HEAP",
      "max-count" : "500"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">replicatedCache:
  memory:
    storage: "OFF_HEAP"
    maxCount: "500"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.memory().storage(StorageType.OFF_HEAP).maxCount(500);</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/">Infinispan configuration schema reference</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/cache/MemoryConfigurationBuilder.html">org.infinispan.configuration.cache.MemoryConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="persistence"><a class="anchor" href="#persistence"></a>6. Configuring persistent storage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan uses cache stores and loaders to interact with persistent storage.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Durability</dt>
<dd>
<p>Adding cache stores allows you to persist data to non-volatile storage so it
survives restarts.</p>
</dd>
<dt class="hdlist1">Write-through caching</dt>
<dd>
<p>Configuring Infinispan as a caching layer in front of persistent storage
simplifies data access for applications because Infinispan handles all
interactions with the external storage.</p>
</dd>
<dt class="hdlist1">Data overflow</dt>
<dd>
<p>Using eviction and passivation techniques ensures that Infinispan keeps only
frequently used data in-memory and writes older entries to persistent storage.</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="passivation_persistence"><a class="anchor" href="#passivation_persistence"></a>6.1. Passivation</h3>
<div class="paragraph">
<p>Passivation configures Infinispan to write entries to cache stores when it
evicts those entries from memory. In this way, passivation prevents unnecessary
and potentially expensive writes to persistent storage.</p>
</div>
<div class="paragraph">
<p>Activation is the process of restoring entries to memory from the cache store
when there is an attempt to access passivated entries. For this reason, when you
enable passivation, you must configure cache stores that implement both
<code>CacheWriter</code> and <code>CacheLoader</code> interfaces so they can write and load entries
from persistent storage.</p>
</div>
<div class="paragraph">
<p>When Infinispan evicts an entry from the cache, it notifies cache listeners
that the entry is passivated then stores the entry in the cache store. When
Infinispan gets an access request for an evicted entry, it lazily loads the
entry from the cache store into memory and then notifies cache listeners that
the entry is activated while keeping the value still in the store.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Passivation uses the first cache loader in the Infinispan configuration and
ignores all others.</p>
</li>
<li>
<p>Passivation is not supported with:</p>
<div class="ulist">
<ul>
<li>
<p>Transactional stores. Passivation writes and removes entries from the store
outside the scope of the actual Infinispan commit boundaries.</p>
</li>
<li>
<p>Shared stores. Shared cache stores require entries to always exist in the
store for other owners. For this reason, passivation is not supported because
entries cannot be removed.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you enable passivation with transactional stores or shared stores,
Infinispan throws an exception.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="how-passivation-works_persistence"><a class="anchor" href="#how-passivation-works_persistence"></a>6.1.1. How passivation works</h4>
<div class="paragraph">
<div class="title">Passivation disabled</div>
<p>Writes to data in memory result in writes to persistent storage.</p>
</div>
<div class="paragraph">
<p>If Infinispan evicts data from memory, then data in persistent storage
includes entries that are evicted from memory. In this way persistent storage
is a superset of the in-memory cache.
This is recommended when you require highest consistency as the store will be able to be read again after a crash.</p>
</div>
<div class="paragraph">
<p>If you do not configure eviction, then data in persistent storage provides a
copy of data in memory.</p>
</div>
<div class="paragraph">
<div class="title">Passivation enabled</div>
<p>Infinispan adds data to persistent storage only when it evicts data from
memory, an entry is removed or upon shutting down the node.</p>
</div>
<div class="paragraph">
<p>When Infinispan activates entries, it restores data in memory but keeps the data in the store still.
This allows for writes to be just as fast as without a store, and still maintains consistency.
When an entry is created or updated only the in memory will be updated and thus
the store will be outdated for the time being.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Passivation is not supported when a store is also configured as shared.
This is due to entries can become out of sync between nodes depending on when a write is evicted versus read.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To gurantee data consistency any store that is not shared should always have <code>purgeOnStartup</code> enabled.
This is true for both passivation enabled or disabled since a store could hold an outdated entry while down and resurrect it at a later point.</p>
</div>
<div class="paragraph">
<p>The following table shows data in memory and in persistent storage after a
series of operations:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operation</th>
<th class="tableblock halign-left valign-top">Passivation disabled</th>
<th class="tableblock halign-left valign-top">Passivation enabled</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Insert k1.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> k1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> -</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Insert k2.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1, k2<br>
<strong>Disk:</strong> k1, k2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1, k2<br>
<strong>Disk:</strong> -</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eviction thread runs and evicts k1.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k2<br>
<strong>Disk:</strong> k1, k2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k2<br>
<strong>Disk:</strong> k1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read k1.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1, k2<br>
<strong>Disk:</strong> k1, k2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1, k2<br>
<strong>Disk:</strong> k1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eviction thread runs and evicts k2.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> k1, k2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> k1, k2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove k2.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> k1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> k1</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="write-through_persistence"><a class="anchor" href="#write-through_persistence"></a>6.2. Write-through cache stores</h3>
<div class="paragraph">
<p>Write-through is a cache writing mode where writes to memory and writes to
cache stores are synchronous. When a client application updates a cache entry,
in most cases by invoking <code>Cache.put()</code>, Infinispan does not return the call
until it updates the cache store. This cache writing mode results in updates to
the cache store concluding within the boundaries of the client thread.</p>
</div>
<div class="paragraph">
<p>The primary advantage of write-through mode is that the cache and cache store
are updated simultaneously, which ensures that the cache store is always
consistent with the cache.</p>
</div>
<div class="paragraph">
<p>However, write-through mode can potentially decrease performance because the
need to access and update cache stores directly adds latency to cache
operations.</p>
</div>
<h4 id="write_through_configuration" class="discrete">Write-through configuration</h4>
<div class="paragraph">
<p>Infinispan uses write-through mode unless you explicitly add write-behind configuration to your caches.
There is no separate element or method for configuring write-through mode.</p>
</div>
<div class="paragraph">
<p>For example, the following configuration adds a file-based store to the cache that implicitly uses write-through mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence passivation="false"&gt;
    &lt;file-store&gt;
      &lt;index path="path/to/index" /&gt;
      &lt;data path="path/to/data" /&gt;
    &lt;/file-store&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="write-behind_persistence"><a class="anchor" href="#write-behind_persistence"></a>6.3. Write-behind cache stores</h3>
<div class="paragraph">
<p>Write-behind is a cache writing mode where writes to memory are synchronous
and writes to cache stores are asynchronous.</p>
</div>
<div class="paragraph">
<p>When clients send write requests, Infinispan adds those operations to a
modification queue. Infinispan processes operations as they join the queue so
that the calling thread is not blocked and the operation completes immediately.</p>
</div>
<div class="paragraph">
<p>If the number of write operations in the modification queue increases beyond
the size of the queue, Infinispan adds those additional operations to the
queue. However, those operations do not complete until Infinispan processes
operations that are already in the queue.</p>
</div>
<div class="paragraph">
<p>For example, calling <code>Cache.putAsync</code> returns immediately and the Stage also
completes immediately if the modification queue is not full. If the
modification queue is full, or if Infinispan is currently processing a batch
of write operations, then <code>Cache.putAsync</code> returns immediately and the Stage
completes later.</p>
</div>
<div class="paragraph">
<p>Write-behind mode provides a performance advantage over write-through mode
because cache operations do not need to wait for updates to the underlying cache
store to complete. However, data in the cache store remains inconsistent with
data in the cache until the modification queue is processed. For this reason,
write-behind mode is suitable for cache stores with low latency, such as
unshared and local file-based cache stores, where the time between the
write to the cache and the write to the cache store is as small as possible.</p>
</div>
<h4 id="write_behind_configuration" class="discrete">Write-behind configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence&gt;
    &lt;table-jdbc-store xmlns="urn:infinispan:config:store:sql:14.0"
                      dialect="H2"
                      shared="true"
                      table-name="books"&gt;
      &lt;connection-pool connection-url="jdbc:h2:mem:infinispan"
                       username="sa"
                       password="changeme"
                       driver="org.h2.Driver"/&gt;
      &lt;write-behind modification-queue-size="2048"
                    fail-silently="true"/&gt;
    &lt;/table-jdbc-store&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "persistence" : {
      "table-jdbc-store": {
        "dialect": "H2",
        "shared": "true",
        "table-name": "books",
        "connection-pool": {
          "connection-url": "jdbc:h2:mem:infinispan",
          "driver": "org.h2.Driver",
          "username": "sa",
          "password": "changeme"
        },
        "write-behind" : {
          "modification-queue-size" : "2048",
          "fail-silently" : true
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  persistence:
    tableJdbcStore:
      dialect: "H2"
      shared: "true"
      tableName: "books"
      connectionPool:
        connectionUrl: "jdbc:h2:mem:infinispan"
        driver: "org.h2.Driver"
        username: "sa"
        password: "changeme"
      writeBehind:
        modificationQueueSize: "2048"
        failSilently: "true"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.persistence()
       .async()
       .modificationQueueSize(2048)
       .failSilently(true);</code></pre>
</div>
</div>
<h4 id="failing_silently" class="discrete">Failing silently</h4>
<div class="paragraph">
<p>Write-behind configuration includes a <code>fail-silently</code> parameter that controls what happens when either the cache store is unavailable or the modification queue is full.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If <code>fail-silently="true"</code> then Infinispan logs WARN messages and rejects
write operations.</p>
</li>
<li>
<p>If <code>fail-silently="false"</code> then Infinispan throws exceptions if it detects
the cache store is unavailable during a write operation. Likewise if the
modification queue becomes full, Infinispan throws an exception.</p>
<div class="paragraph">
<p>In some cases, data loss can occur if Infinispan restarts and write operations
exist in the modification queue. For example the cache store goes offline but,
during the time it takes to detect that the cache store is unavailable, write
operations are added to the modification queue because it is not full. If
Infinispan restarts or otherwise becomes unavailable before the cache store
comes back online, then the write operations in the modification queue are lost
because they were not persisted.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="segmented-cache-stores_persistence"><a class="anchor" href="#segmented-cache-stores_persistence"></a>6.4. Segmented cache stores</h3>
<div class="paragraph">
<p>Cache stores can organize data into hash space segments to which keys map.</p>
</div>
<div class="paragraph">
<p>Segmented stores increase read performance for bulk operations; for example,
streaming over data (<code>Cache.size</code>, <code>Cache.entrySet.stream</code>), pre-loading the
cache, and doing state transfer operations.</p>
</div>
<div class="paragraph">
<p>However, segmented stores can also result in loss of performance for write
operations. This performance loss applies particularly to batch write
operations that can take place with transactions or write-behind stores. For
this reason, you should evaluate the overhead for write operations before you
enable segmented stores. The performance gain for bulk read operations might
not be acceptable if there is a significant performance loss for write
operations.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The number of segments you configure for cache stores must match the number of
segments you define in the Infinispan configuration with the
<code>clustering.hash.numSegments</code> parameter.</p>
</div>
<div class="paragraph">
<p>If you change the <code>numSegments</code> parameter in the configuration after you add a
segmented cache store, Infinispan cannot read data from that cache store.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="shared-cache-stores_persistence"><a class="anchor" href="#shared-cache-stores_persistence"></a>6.5. Shared cache stores</h3>
<div class="paragraph">
<p>Infinispan cache stores can be local to a given node or shared across all nodes in the cluster.
By default, cache stores are local (<code>shared="false"</code>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Local cache stores are unique to each node; for example, a file-based cache store that persists data to the host filesystem.</p>
<div class="paragraph">
<p>Local cache stores should use "purge on startup" to avoid loading stale entries from persistent storage.</p>
</div>
</li>
<li>
<p>Shared cache stores allow multiple nodes to use the same persistent storage; for example, a JDBC cache store that allows multiple nodes to access the same database.</p>
<div class="paragraph">
<p>Shared cache stores ensure that only the primary owner write to persistent storage, instead of backup nodes performing write operations for every modification.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Purging deletes data, which is not typically the desired behavior for persistent storage.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock primary">
<div class="title">Local cache store</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;persistence&gt;
  &lt;store shared="false"
         purge="true"/&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Shared cache store</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;persistence&gt;
  &lt;store shared="true"
         purge="false"/&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/">Infinispan Configuration Schema</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="cache-loaders-transactional_persistence"><a class="anchor" href="#cache-loaders-transactional_persistence"></a>6.6. Transactions with persistent cache stores</h3>
<div class="paragraph">
<p>Infinispan supports transactional operations with JDBC-based cache stores only.
To configure caches as transactional, you set <code>transactional=true</code> to keep data in persistent storage synchronized with data in memory.</p>
</div>
<div class="paragraph">
<p>For all other cache stores, Infinispan does not enlist cache loaders in transactional operations.
This can result in data inconsistency if transactions succeed in modifying data in memory but do not completely apply changes to data in the cache store.
In these cases manual recovery is not possible with cache stores.</p>
</div>
</div>
<div class="sect2">
<h3 id="global-persistent-location_persistence"><a class="anchor" href="#global-persistent-location_persistence"></a>6.7. Global persistent location</h3>
<div class="paragraph">
<p>Infinispan preserves global state so that it can restore cluster topology and cached data after restart.</p>
</div>
<h4 id="remote_caches" class="discrete">Remote caches</h4>
<div class="paragraph">
<p>Infinispan Server saves cluster state to the <code>$ISPN_HOME/server/data</code> directory.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You should never delete or modify the <code>server/data</code> directory or its content.
Infinispan restores cluster state from this directory when you restart your server instances.</p>
</div>
<div class="paragraph">
<p>Changing the default configuration or directly modifying the <code>server/data</code> directory can cause unexpected behavior and lead to data loss.</p>
</div>
</td>
</tr>
</table>
</div>
<h4 id="embedded_caches" class="discrete">Embedded caches</h4>
<div class="paragraph">
<p>Infinispan defaults to the <code>user.dir</code> system property as the global persistent location.
In most cases this is the directory where your application starts.</p>
</div>
<div class="paragraph">
<p>For clustered embedded caches, such as replicated or distributed, you should always enable and configure a global persistent location to restore cluster topology.</p>
</div>
<div class="paragraph">
<p>You should never configure an absolute path for a file-based cache store that is outside the global persistent location.
If you do, Infinispan writes the following exception to logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ISPN000558: "The store location 'foo' is not a child of the global persistent location 'bar'"</pre>
</div>
</div>
<div class="sect3">
<h4 id="configuring-global-persistent-location_persistence"><a class="anchor" href="#configuring-global-persistent-location_persistence"></a>6.7.1. Configuring the global persistent location</h4>
<div class="paragraph">
<p>Enable and configure the location where Infinispan stores global state for clustered embedded caches.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan Server enables global persistence and configures a default location.
You should not disable global persistence or change the default configuration for remote caches.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Add Infinispan to your project.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enable global state in one of the following ways:</p>
<div class="ulist">
<ul>
<li>
<p>Add the <code>global-state</code> element to your Infinispan configuration.</p>
</li>
<li>
<p>Call the <code>globalState().enable()</code> methods in the <code>GlobalConfigurationBuilder</code> API.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Define whether the global persistent location is unique to each node or shared between the cluster.</p>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Location type</th>
<th class="tableblock halign-left valign-top">Configuration</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique to each node</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>persistent-location</code> element or <code>persistentLocation()</code> method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shared between the cluster</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shared-persistent-location</code> element or <code>sharedPersistentLocation(String)</code> method</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Set the path where Infinispan stores cluster state.</p>
<div class="paragraph">
<p>For example, file-based cache stores the path is a directory on the host filesystem.</p>
</div>
<div class="paragraph">
<p>Values can be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Absolute and contain the full location including the root.</p>
</li>
<li>
<p>Relative to a root location.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If you specify a relative value for the path, you must also specify a system property that resolves to a root location.</p>
<div class="paragraph">
<p>For example, on a Linux host system you set <code>global/state</code> as the path.
You also set the <code>my.data</code> property that resolves to the <code>/opt/data</code> root location.
In this case Infinispan uses <code>/opt/data/global/state</code> as the global persistent location.</p>
</div>
</li>
</ol>
</div>
<h5 id="global_persistent_location_configuration" class="discrete">Global persistent location configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
  &lt;cache-container&gt;
    &lt;global-state&gt;
      &lt;persistent-location path="global/state" relative-to="my.data"/&gt;
    &lt;/global-state&gt;
  &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "global-state": {
        "persistent-location" : {
          "path" : "global/state",
          "relative-to" : "my.data"
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">cacheContainer:
  globalState:
      persistentLocation:
        path: "global/state"
        relativeTo : "my.data"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">GlobalConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">new GlobalConfigurationBuilder().globalState()
                                .enable()
                                .persistentLocation("global/state", "my.data");</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/">Infinispan configuration schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/global/GlobalStateConfiguration.html">org.infinispan.configuration.global.GlobalStateConfiguration</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="file-stores_persistence"><a class="anchor" href="#file-stores_persistence"></a>6.8. File-based cache stores</h3>
<div class="paragraph">
<p>File-based cache stores provide persistent storage on the local host filesystem where Infinispan is running.
For clustered caches, file-based cache stores are unique to each Infinispan node.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Never use filesystem-based cache stores on shared file systems, such as an NFS or Samba share, because they do not provide file locking capabilities and data corruption can occur.</p>
</div>
<div class="paragraph">
<p>Additionally if you attempt to use transactional caches with shared file systems, unrecoverable failures can happen when writing to files during the commit phase.</p>
</div>
</td>
</tr>
</table>
</div>
<h4 id="soft_index_file_stores" class="discrete">Soft-Index File Stores</h4>
<div class="paragraph">
<p><code>SoftIndexFileStore</code> is the default implementation for file-based cache stores and stores data in a set of append-only files.</p>
</div>
<div class="paragraph">
<p>When append-only files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reach their maximum size, Infinispan creates a new file and starts writing to it.</p>
</li>
<li>
<p>Reach the compaction threshold of less than 50% usage, Infinispan overwrites the entries to a new file and then deletes the old file.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Using SoftIndexFileStore in a clustered cache should enable purge on startup to ensure stale entries are not resurrected.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">B+ trees</div>
<p>To improve performance, append-only files in a <code>SoftIndexFileStore</code> are indexed using a <strong>B+ Tree</strong> that can be stored both on disk and in memory.
The in-memory index uses Java soft references to ensure it can be rebuilt if removed by Garbage Collection (GC) then requested again.</p>
</div>
<div class="paragraph">
<p>Because <code>SoftIndexFileStore</code> uses Java soft references to keep indexes in memory, it helps prevent out-of-memory exceptions.
GC removes indexes before they consume too much memory while still falling back to disk.</p>
</div>
<div class="paragraph">
<p><code>SoftIndexFileStore</code> creates a B+ tree per configured cache segment.
This provides an additional "index" as it only has so many elements and provides additional parallelism for index updates.
Currently we allow for a parallel amount based on one sixteenth of the number of cache segments.</p>
</div>
<div class="paragraph">
<p>Each entry in the B+ tree is a node.
By default, the size of each node is limited to 4096 bytes.
<code>SoftIndexFileStore</code> throws an exception if keys are longer after serialization occurs.</p>
</div>
<div class="paragraph">
<div class="title">File limits</div>
<p><code>SoftIndexFileStore</code> will use two plus the configured openFilesLimit amount of files at a given time.
The two additional file pointers are reserved for the log appender for newly updated data and another
for the compactor which writes compacted entries into a new file.</p>
</div>
<div class="paragraph">
<p>The amount of open allocated files allocated for indexing is one tenth of the total number of the configured openFilesLimit.
This number has a minimum of 1 or the number of cache segments.
Any number remaning from configured limit is allocated for open data files themselves.</p>
</div>
<div class="paragraph">
<div class="title">Segmentation</div>
<p>Soft-index file stores are always segmented. The append log(s) are not directly segmented and segmentation is handled directly by the index.</p>
</div>
<div class="paragraph">
<div class="title">Expiration</div>
<p>The SoftIndexFileStore has full support for expired entries and their requirements.</p>
</div>
<h4 id="single_file_cache_stores" class="discrete">Single File Cache Stores</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Single file cache stores are now deprecated and planned for removal.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Single File cache stores, <code>SingleFileStore</code>, persist data to file.
Infinispan also maintains an in-memory index of keys while keys and values are stored in the file.</p>
</div>
<div class="paragraph">
<p>Because <code>SingleFileStore</code> keeps an in-memory index of keys and the location of values, it requires additional memory, depending on the key size and the number of keys.
For this reason, <code>SingleFileStore</code> is not recommended for use cases where the keys are larger or there can be a larger number of them.</p>
</div>
<div class="paragraph">
<p>In some cases, <code>SingleFileStore</code> can also become fragmented.
If the size of values continually increases, available space in the single file is not used but the entry is appended to the end of the file.
Available space in the file is used only if an entry can fit within it.
Likewise, if you remove all entries from memory, the single file store does not decrease in size or become defragmented.</p>
</div>
<div class="paragraph">
<div class="title">Segmentation</div>
<p>Single file cache stores are segmented by default with a separate instance per segment, which results in multiple directories.
Each directory is a number that represents the segment to which the data maps.</p>
</div>
<div class="sect3">
<h4 id="configuring-file-stores_persistence"><a class="anchor" href="#configuring-file-stores_persistence"></a>6.8.1. Configuring file-based cache stores</h4>
<div class="paragraph">
<p>Add file-based cache stores to Infinispan to persist data on the host filesystem.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Enable global state and configure a global persistent location if you are configuring embedded caches.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the <code>persistence</code> element to your cache configuration.</p>
</li>
<li>
<p>Optionally specify <code>true</code> as the value for the <code>passivation</code> attribute to write to the file-based cache store only when data is evicted from memory.</p>
</li>
<li>
<p>Include the <code>file-store</code> element and configure attributes as appropriate.</p>
</li>
<li>
<p>Specify <code>false</code> as the value for the <code>shared</code> attribute.</p>
<div class="paragraph">
<p>File-based cache stores should always be unique to each Infinispan instance.
If you want to use the same persistent across a cluster, configure shared storage such as a JDBC string-based cache store .</p>
</div>
</li>
<li>
<p>Configure the <code>index</code> and <code>data</code> elements to specify the location where Infinispan creates indexes and stores data.</p>
</li>
<li>
<p>Include the <code>write-behind</code> element if you want to configure the cache store with write-behind mode.</p>
</li>
</ol>
</div>
<h5 id="file_based_cache_store_configuration" class="discrete">File-based cache store configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence passivation="true"&gt;
     &lt;file-store shared="false"&gt;
        &lt;data path="data"/&gt;
        &lt;index path="index"/&gt;
        &lt;write-behind modification-queue-size="2048" /&gt;
     &lt;/file-store&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "persistence": {
      "passivation": true,
      "file-store" : {
        "shared": false,
        "data": {
          "path": "data"
        },
        "index": {
          "path": "index"
        },
        "write-behind": {
          "modification-queue-size": "2048"
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  persistence:
    passivation: "true"
    fileStore:
      shared: "false"
      data:
        path: "data"
      index:
        path: "index"
      writeBehind:
        modificationQueueSize: "2048"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.persistence().passivation(true)
       .addSoftIndexFileStore()
          .shared(false)
          .dataLocation("data")
          .indexLocation("index")
          .modificationQueueSize(2048);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-single-file-stores_persistence"><a class="anchor" href="#configuring-single-file-stores_persistence"></a>6.8.2. Configuring single file cache stores</h4>
<div class="paragraph">
<p>If required, you can configure Infinispan to create single file stores.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Single file stores are deprecated.
You should use soft-index file stores for better performance and data consistency in comparison with single file stores.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Enable global state and configure a global persistent location if you are configuring embedded caches.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the <code>persistence</code> element to your cache configuration.</p>
</li>
<li>
<p>Optionally specify <code>true</code> as the value for the <code>passivation</code> attribute to write to the file-based cache store only when data is evicted from memory.</p>
</li>
<li>
<p>Include the <code>single-file-store</code> element.</p>
</li>
<li>
<p>Specify <code>false</code> as the value for the <code>shared</code> attribute.</p>
</li>
<li>
<p>Configure any other attributes as appropriate.</p>
</li>
<li>
<p>Include the <code>write-behind</code> element to configure the cache store as write behind instead of as write through.</p>
</li>
</ol>
</div>
<h5 id="single_file_cache_store_configuration" class="discrete">Single file cache store configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence passivation="true"&gt;
    &lt;single-file-store shared="false"
                       preload="true"/&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "persistence" : {
      "passivation" : true,
      "single-file-store" : {
        "shared" : false,
        "preload" : true
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  persistence:
    passivation: "true"
    singleFileStore:
      shared: "false"
      preload: "true"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.persistence().passivation(true)
       .addStore(SingleFileStoreConfigurationBuilder.class)
          .shared(false)
          .preload(true);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-connection-factories_persistence"><a class="anchor" href="#jdbc-connection-factories_persistence"></a>6.9. JDBC connection factories</h3>
<div class="paragraph">
<p>Infinispan provides different <code>ConnectionFactory</code> implementations that allow you to connect to databases.
You use JDBC connections with SQL cache stores and JDBC string-based caches stores.</p>
</div>
<h4 id="connection_pools" class="discrete">Connection pools</h4>
<div class="paragraph">
<p>Connection pools are suitable for standalone Infinispan deployments and are based on Agroal.</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence&gt;
     &lt;connection-pool connection-url="jdbc:h2:mem:infinispan;DB_CLOSE_DELAY=-1"
                      username="sa"
                      password="changeme"
                      driver="org.h2.Driver"/&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "persistence": {
      "connection-pool": {
        "connection-url": "jdbc:h2:mem:infinispan_string_based",
        "driver": "org.h2.Driver",
        "username": "sa",
        "password": "changeme"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  persistence:
    connectionPool:
      connectionUrl: "jdbc:h2:mem:infinispan_string_based;DB_CLOSE_DELAY=-1"
      driver: org.h2.Driver
      username: sa
      password: changeme</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.persistence()
       .connectionPool()
         .connectionUrl("jdbc:h2:mem:infinispan_string_based;DB_CLOSE_DELAY=-1")
         .username("sa")
         .driverClass("org.h2.Driver");</code></pre>
</div>
</div>
<h4 id="managed_datasources" class="discrete">Managed datasources</h4>
<div class="paragraph">
<p>Datasource connections are suitable for managed environments such as application servers.</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence&gt;
    &lt;data-source jndi-url="java:/StringStoreWithManagedConnectionTest/DS" /&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "persistence": {
      "data-source": {
        "jndi-url": "java:/StringStoreWithManagedConnectionTest/DS"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  persistence:
    dataSource:
      jndiUrl: "java:/StringStoreWithManagedConnectionTest/DS"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.persistence()
       .dataSource()
         .jndiUrl("java:/StringStoreWithManagedConnectionTest/DS");</code></pre>
</div>
</div>
<h4 id="simple_connections" class="discrete">Simple connections</h4>
<div class="paragraph">
<p>Simple connection factories create database connections on a per invocation basis and are intended for use with test or development environments only.</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence&gt;
    &lt;simple-connection connection-url="jdbc:h2://localhost"
                       username="sa"
                       password="changeme"
                       driver="org.h2.Driver"/&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "persistence": {
      "simple-connection": {
        "connection-url": "jdbc:h2://localhost",
        "driver": "org.h2.Driver",
        "username": "sa",
        "password": "changeme"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  persistence:
    simpleConnection:
      connectionUrl: "jdbc:h2://localhost"
      driver: org.h2.Driver
      username: sa
      password: changeme</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.persistence()
       .simpleConnection()
         .connectionUrl("jdbc:h2://localhost")
         .driverClass("org.h2.Driver")
         .username("admin")
         .password("changeme");</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/jdbc/common/configuration/PooledConnectionFactoryConfigurationBuilder.html">PooledConnectionFactoryConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/jdbc/common/configuration/ManagedConnectionFactoryConfigurationBuilder.html">ManagedConnectionFactoryConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/jdbc/common/configuration/SimpleConnectionFactoryConfigurationBuilder.html">SimpleConnectionFactoryConfigurationBuilder</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="configuring-server-datasources_persistence"><a class="anchor" href="#configuring-server-datasources_persistence"></a>6.9.1. Configuring managed datasources</h4>
<div class="paragraph">
<p>Create managed datasources as part of your Infinispan Server configuration to optimize connection pooling and performance for JDBC database connections.
You can then specify the JDNI name of the managed datasources in your caches, which centralizes JDBC connection configuration for your deployment.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Copy database drivers to the <code>server/lib</code> directory in your Infinispan Server installation.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use the <code class="command">install</code> command with the Infinispan Command Line Interface (CLI) to download the required drivers to the <code>server/lib</code> directory, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>install org.postgresql:postgresql:42.4.5</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan Server configuration for editing.</p>
</li>
<li>
<p>Add a new <code>data-source</code> to the <code>data-sources</code> section.</p>
</li>
<li>
<p>Uniquely identify the datasource with the <code>name</code> attribute or field.</p>
</li>
<li>
<p>Specify a JNDI name for the datasource with the <code>jndi-name</code> attribute or field.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You use the JNDI name to specify the datasource in your JDBC cache store
configuration.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Set <code>true</code> as the value of the <code>statistics</code> attribute or field to enable statistics for the datasource through the <code>/metrics</code> endpoint.</p>
</li>
<li>
<p>Provide JDBC driver details that define how to connect to the datasource in the <code>connection-factory</code> section.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify the name of the database driver with the <code>driver</code> attribute or field.</p>
</li>
<li>
<p>Specify the JDBC connection url with the <code>url</code> attribute or field.</p>
</li>
<li>
<p>Specify credentials with the <code>username</code> and <code>password</code> attributes or fields.</p>
</li>
<li>
<p>Provide any other configuration as appropriate.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Define how Infinispan Server nodes pool and reuse connections with connection pool tuning properties in the <code>connection-pool</code> section.</p>
</li>
<li>
<p>Save the changes to your configuration.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Verification</div>
<p>Use the Infinispan Command Line Interface (CLI) to test the datasource connection, as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start a CLI session.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>bin/cli.sh</code></pre>
</div>
</div>
</li>
<li>
<p>List all datasources and confirm the one you created is available.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>server datasource ls</code></pre>
</div>
</div>
</li>
<li>
<p>Test a datasource connection.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>server datasource test my-datasource</code></pre>
</div>
</div>
</li>
</ol>
</div>
<h5 id="managed_datasource_configuration" class="discrete">Managed datasource configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;server xmlns="urn:infinispan:server:14.0"&gt;
  &lt;data-sources&gt;
     &lt;!-- Defines a unique name for the datasource and JNDI name that you
          reference in JDBC cache store configuration.
          Enables statistics for the datasource, if required. --&gt;
     &lt;data-source name="ds"
                  jndi-name="jdbc/postgres"
                  statistics="true"&gt;
        &lt;!-- Specifies the JDBC driver that creates connections. --&gt;
        &lt;connection-factory driver="org.postgresql.Driver"
                            url="jdbc:postgresql://localhost:5432/postgres"
                            username="postgres"
                            password="changeme"&gt;
           &lt;!-- Sets optional JDBC driver-specific connection properties. --&gt;
           &lt;connection-property name="name"&gt;value&lt;/connection-property&gt;
        &lt;/connection-factory&gt;
        &lt;!-- Defines connection pool tuning properties. --&gt;
        &lt;connection-pool initial-size="1"
                         max-size="10"
                         min-size="3"
                         background-validation="1000"
                         idle-removal="1"
                         blocking-timeout="1000"
                         leak-detection="10000"/&gt;
     &lt;/data-source&gt;
  &lt;/data-sources&gt;
&lt;/server&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "server": {
    "data-sources": [{
      "name": "ds",
      "jndi-name": "jdbc/postgres",
      "statistics": true,
      "connection-factory": {
        "driver": "org.postgresql.Driver",
        "url": "jdbc:postgresql://localhost:5432/postgres",
        "username": "postgres",
        "password": "changeme",
        "connection-properties": {
          "name": "value"
        }
      },
      "connection-pool": {
        "initial-size": 1,
        "max-size": 10,
        "min-size": 3,
        "background-validation": 1000,
        "idle-removal": 1,
        "blocking-timeout": 1000,
        "leak-detection": 10000
      }
    }]
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">server:
  dataSources:
    - name: ds
      jndiName: 'jdbc/postgres'
      statistics: true
      connectionFactory:
        driver: "org.postgresql.Driver"
        url: "jdbc:postgresql://localhost:5432/postgres"
        username: "postgres"
        password: "changeme"
        connectionProperties:
          name: value
      connectionPool:
        initialSize: 1
        maxSize: 10
        minSize: 3
        backgroundValidation: 1000
        idleRemoval: 1
        blockingTimeout: 1000
        leakDetection: 10000</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="configuring-caches-with-jndi-names_persistence"><a class="anchor" href="#configuring-caches-with-jndi-names_persistence"></a>Configuring caches with JNDI names</h5>
<div class="paragraph">
<p>When you add a managed datasource to Infinispan Server you can add the JNDI name to a JDBC-based cache store configuration.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Configure Infinispan Server with a managed datasource.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your cache configuration for editing.</p>
</li>
<li>
<p>Add the <code>data-source</code> element or field to the JDBC-based cache store configuration.</p>
</li>
<li>
<p>Specify the JNDI name of the managed datasource as the value of the <code>jndi-url</code> attribute.</p>
</li>
<li>
<p>Configure the JDBC-based cache stores as appropriate.</p>
</li>
<li>
<p>Save the changes to your configuration.</p>
</li>
</ol>
</div>
<h6 id="jndi_name_in_cache_configuration" class="discrete">JNDI name in cache configuration</h6>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence&gt;
    &lt;jdbc:string-keyed-jdbc-store&gt;
      &lt;!-- Specifies the JNDI name of a managed datasource on Infinispan Server. --&gt;
      &lt;jdbc:data-source jndi-url="jdbc/postgres"/&gt;
      &lt;jdbc:string-keyed-table drop-on-exit="true" create-on-start="true" prefix="TBL"&gt;
        &lt;jdbc:id-column name="ID" type="VARCHAR(255)"/&gt;
        &lt;jdbc:data-column name="DATA" type="BYTEA"/&gt;
        &lt;jdbc:timestamp-column name="TS" type="BIGINT"/&gt;
        &lt;jdbc:segment-column name="S" type="INT"/&gt;
      &lt;/jdbc:string-keyed-table&gt;
    &lt;/jdbc:string-keyed-jdbc-store&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "persistence": {
      "string-keyed-jdbc-store": {
        "data-source": {
          "jndi-url": "jdbc/postgres"
          },
        "string-keyed-table": {
          "prefix": "TBL",
          "drop-on-exit": true,
          "create-on-start": true,
          "id-column": {
            "name": "ID",
            "type": "VARCHAR(255)"
          },
          "data-column": {
            "name": "DATA",
            "type": "BYTEA"
          },
          "timestamp-column": {
            "name": "TS",
            "type": "BIGINT"
          },
          "segment-column": {
            "name": "S",
            "type": "INT"
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  persistence:
    stringKeyedJdbcStore:
      dataSource:
        jndi-url: "jdbc/postgres"
      stringKeyedTable:
        prefix: "TBL"
        dropOnExit: true
        createOnStart: true
        idColumn:
          name: "ID"
          type: "VARCHAR(255)"
        dataColumn:
          name: "DATA"
          type: "BYTEA"
        timestampColumn:
          name: "TS"
          type: "BIGINT"
        segmentColumn:
          name: "S"
          type: "INT"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="server-connection-pool-properties_persistence"><a class="anchor" href="#server-connection-pool-properties_persistence"></a>Connection pool tuning properties</h5>
<div class="paragraph">
<p>You can tune JDBC connection pools for managed datasources in your Infinispan Server configuration.</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>initial-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initial number of connections the pool should hold.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>max-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of connections in the pool.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>min-size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Minimum number of connections the pool should hold.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>blocking-timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum time in milliseconds to block while waiting for a connection before throwing an exception.
This will never throw an exception if creating a new connection takes an inordinately long period of time.
Default is <code>0</code> meaning that a call will wait indefinitely.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>background-validation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time in milliseconds between background validation runs. A duration of <code>0</code> means that this feature is disabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>validate-on-acquisition</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connections idle for longer than this time, specified in milliseconds, are validated before being acquired (foreground validation). A duration of <code>0</code> means that this feature is disabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>idle-removal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time in minutes a connection has to be idle before it can be removed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>leak-detection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time in milliseconds a connection has to be held before a leak warning.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="configuring-jdbc-agroal-properties_persistence"><a class="anchor" href="#configuring-jdbc-agroal-properties_persistence"></a>6.9.2. Configuring JDBC connection pools with Agroal properties</h4>
<div class="paragraph">
<p>You can use a properties file to configure pooled connection factories for JDBC string-based cache stores.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify JDBC connection pool configuration with <code>org.infinispan.agroal.*</code> properties, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-properties" data-lang="properties">org.infinispan.agroal.metricsEnabled=false

org.infinispan.agroal.minSize=10
org.infinispan.agroal.maxSize=100
org.infinispan.agroal.initialSize=20
org.infinispan.agroal.acquisitionTimeout_s=1
org.infinispan.agroal.validationTimeout_m=1
org.infinispan.agroal.leakTimeout_s=10
org.infinispan.agroal.reapTimeout_m=10

org.infinispan.agroal.metricsEnabled=false
org.infinispan.agroal.autoCommit=true
org.infinispan.agroal.jdbcTransactionIsolation=READ_COMMITTED
org.infinispan.agroal.jdbcUrl=jdbc:h2:mem:PooledConnectionFactoryTest;DB_CLOSE_DELAY=-1
org.infinispan.agroal.driverClassName=org.h2.Driver.class
org.infinispan.agroal.principal=sa
org.infinispan.agroal.credential=sa</code></pre>
</div>
</div>
</li>
<li>
<p>Configure Infinispan to use your properties file with the <code>properties-file</code> attribute or the <code>PooledConnectionFactoryConfiguration.propertyFile()</code> method.</p>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;connection-pool properties-file="path/to/agroal.properties"/&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">"persistence": {
  "connection-pool": {
    "properties-file": "path/to/agroal.properties"
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">persistence:
  connectionPool:
    propertiesFile: path/to/agroal.properties</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">.connectionPool().propertyFile("path/to/agroal.properties")</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://agroal.github.io/">Agroal</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sql-cache-store_persistence"><a class="anchor" href="#sql-cache-store_persistence"></a>6.10. SQL cache stores</h3>
<div class="paragraph">
<p>SQL cache stores let you load Infinispan caches from existing database tables.
Infinispan offers two types of SQL cache store:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Table</dt>
<dd>
<p>Infinispan loads entries from a single database table.</p>
</dd>
<dt class="hdlist1">Query</dt>
<dd>
<p>Infinispan uses SQL queries to load entries from single or multiple database tables, including from sub-columns within those tables, and perform insert, update, and delete operations.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Visit the code tutorials to try a SQL cache store in action.
See the <a href="https://github.com/infinispan/infinispan-simple-tutorials/tree/main/infinispan-remote/persistence">Persistence code tutorial with remote caches</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Both SQL table and query stores:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow read and write operations to persistent storage.</p>
</li>
<li>
<p>Can be read-only and act as a cache loader.</p>
</li>
<li>
<p>Support keys and values that correspond to a single database column or a composite of multiple database columns.</p>
<div class="paragraph">
<p>For composite keys and values, you must provide Infinispan with Protobuf schema (<code>.proto</code> files) that describe the keys and values.
With Infinispan Server you can add schema through the Infinispan Console or Command Line Interface (CLI) with the <code class="command">schema</code> command.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The SQL cache store is intended for use with an existing database table.
As a result, it does not store any metadata, which includes expiration, segments, and, versioning metadata.
Due to the absence of version storage, SQL store does not support optimistic transactional caching and asynchronous cross-site replication.
This limitation also extends to Hot Rod versioned operations.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use expiration with the SQL cache store when it is configured as read only.
Expiration removes stale values from memory, causing the cache to fetch the values from the database again and cache them anew.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/jdbc/common/DatabaseType.html">DatabaseType Enum lists supported database dialects</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/infinispan-cachestore-sql-config-14.0.html">Infinispan SQL store configuration reference</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="sql-store-data-types_persistence"><a class="anchor" href="#sql-store-data-types_persistence"></a>6.10.1. Data types for keys and values</h4>
<div class="paragraph">
<p>Infinispan loads keys and values from columns in database tables via SQL cache stores, automatically using the appropriate data types.
The following <code>CREATE</code> statement adds a table named "books" that has two columns, <code>isbn</code> and <code>title</code>:</p>
</div>
<div class="listingblock">
<div class="title">Database table with two columns</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-sql" data-lang="sql">CREATE TABLE books (
    isbn NUMBER(13),
    title varchar(120)
    PRIMARY KEY(isbn)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you use this table with a SQL cache store, Infinispan adds an entry to the cache using the <code>isbn</code> column as the key and the <code>title</code> column as the value.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/infinispan-cachestore-sql-config-14.0.html">Infinispan SQL store configuration reference</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="sql-store-composite-keys-values_persistence"><a class="anchor" href="#sql-store-composite-keys-values_persistence"></a>Composite keys and values</h5>
<div class="paragraph">
<p>You can use SQL stores with database tables that contain composite primary keys or composite values.</p>
</div>
<div class="paragraph">
<p>To use composite keys or values, you must provide Infinispan with Protobuf schema that describe the data types.
You must also add <code>schema</code> configuration to your SQL store and specify the message names for keys and values.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan recommends generating Protobuf schema with the ProtoStream processor.
You can then upload your Protobuf schema for remote caches through the Infinispan Console, CLI, or REST API.</p>
</div>
</td>
</tr>
</table>
</div>
<h6 id="composite_values" class="discrete">Composite values</h6>
<div class="paragraph">
<p>The following database table holds a composite value of the <code>title</code> and <code>author</code> columns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-sql" data-lang="sql">CREATE TABLE books (
    isbn NUMBER(13),
    title varchar(120),
    author varchar(80)
    PRIMARY KEY(isbn)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan adds an entry to the cache using the <code>isbn</code> column as the key.
For the value, Infinispan requires a Protobuf schema that maps the <code>title</code> column and the <code>author</code> columns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-protobuf" data-lang="protobuf">package library;

message books_value {
    optional string title = 1;
    optional string author = 2;
}</code></pre>
</div>
</div>
<h6 id="composite_keys_and_values" class="discrete">Composite keys and values</h6>
<div class="paragraph">
<p>The following database table holds a composite primary key and a composite value, with two columns each:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-sql" data-lang="sql">CREATE TABLE books (
    isbn NUMBER(13),
    reprint INT,
    title varchar(120),
    author varchar(80)
    PRIMARY KEY(isbn, reprint)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For both the key and the value, Infinispan requires a Protobuf schema that maps the columns to keys and values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-protobuf" data-lang="protobuf">package library;

message books_key {
    required string isbn = 1;
    required int32 reprint = 2;
}

message books_value {
    optional string title = 1;
    optional string author = 2;
}</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../encoding/encoding.html">Cache encoding and marshalling: Generate Protobuf schema and register them with Infinispan</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/infinispan-cachestore-sql-config-14.0.html">Infinispan SQL store configuration reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="sql-store-embedded-keys_persistence"><a class="anchor" href="#sql-store-embedded-keys_persistence"></a>Embedded keys</h5>
<div class="paragraph">
<p>Protobuf schema can include keys within values, as in the following example:</p>
</div>
<div class="listingblock">
<div class="title">Protobuf schema with an embedded key</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-protobuf" data-lang="protobuf">package library;

message books_key {
    required string isbn = 1;
    required int32 reprint = 2;
}

message books_value {
    required string isbn = 1;
    required string reprint = 2;
    optional string title = 3;
    optional string author = 4;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use embedded keys, you must include the <code>embedded-key="true"</code> attribute or <code>embeddedKey(true)</code> method in your SQL store configuration.</p>
</div>
</div>
<div class="sect4">
<h5 id="sql-store-protobuf-types_persistence"><a class="anchor" href="#sql-store-protobuf-types_persistence"></a>SQL types to Protobuf types</h5>
<div class="paragraph">
<p>The following table contains default mappings of SQL data types to Protobuf data types:</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">SQL type</th>
<th class="tableblock halign-left valign-top">Protobuf type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int32</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int8</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int64</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>float4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>float</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>float8</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>double</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>numeric</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>double</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bool</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bool</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>char</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>string</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varchar</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>string</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>text</code>, <code>tinytext</code>, <code>mediumtext</code>, <code>longtext</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>string</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytea</code>, <code>tinyblob</code>, <code>blob</code>, <code>mediumblob</code>, <code>longblob</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes</code></p></td>
</tr>
</tbody>
</table>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../encoding/encoding.html">Cache encoding and marshalling</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-sql-cache-stores-table_persistence"><a class="anchor" href="#configuring-sql-cache-stores-table_persistence"></a>6.10.2. Loading Infinispan caches from database tables</h4>
<div class="paragraph">
<p>Add a SQL table cache store to your configuration if you want Infinispan to load data from a database table.
When it connects to the database, Infinispan uses metadata from the table to detect column names and data types.
Infinispan also automatically determines which columns in the database are part of the primary key.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Have JDBC connection details.<br>
You can add JDBC connection factories directly to your cache configuration.<br>
For remote caches in production environments, you should add managed datasources to Infinispan Server configuration and specify the JNDI name in the cache configuration.</p>
</li>
<li>
<p>Generate Protobuf schema for any composite keys or composite values and register your schemas with Infinispan.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan recommends generating Protobuf schema with the ProtoStream processor.
For remote caches, you can register your schemas by adding them through the Infinispan Console, CLI, or REST API.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add database drivers to your Infinispan deployment.</p>
<div class="ulist">
<ul>
<li>
<p>Remote caches: Copy database drivers to the <code>server/lib</code> directory in your Infinispan Server installation.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use the <code class="command">install</code> command with the Infinispan Command Line Interface (CLI) to download the required drivers to the <code>server/lib</code> directory, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>install org.postgresql:postgresql:42.4.5</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Embedded caches: Add the <code>infinispan-cachestore-sql</code> dependency to your <code>pom</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
  &lt;artifactId&gt;infinispan-cachestore-sql&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add a SQL table cache store.</p>
<div class="listingblock primary">
<div class="title">Declarative</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">table-jdbc-store xmlns="urn:infinispan:config:store:sql:14.0"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Programmatic</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">persistence().addStore(TableJdbcStoreConfigurationBuilder.class)</code></pre>
</div>
</div>
</li>
<li>
<p>Specify the database dialect with either <code>dialect=""</code> or <code>dialect()</code>, for example <code>dialect="H2"</code> or <code>dialect="postgres"</code>.</p>
</li>
<li>
<p>Configure the SQL cache store with the properties you require, for example:</p>
<div class="ulist">
<ul>
<li>
<p>To use the same cache store across your cluster, set <code>shared="true"</code> or <code>shared(true)</code>.</p>
</li>
<li>
<p>To create a read only cache store, set <code>read-only="true"</code> or <code>.ignoreModifications(true)</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Name the database table that loads the cache with <code>table-name="&lt;database_table_name&gt;"</code> or <code>table.name("&lt;database_table_name&gt;")</code>.</p>
</li>
<li>
<p>Add the <code>schema</code> element or the <code>.schemaJdbcConfigurationBuilder()</code> method and add Protobuf schema configuration for composite keys or values.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify the package name with the <code>package</code> attribute or <code>package()</code> method.</p>
</li>
<li>
<p>Specify composite values with the <code>message-name</code> attribute or <code>messageName()</code> method.</p>
</li>
<li>
<p>Specify composite keys with the <code>key-message-name</code> attribute or <code>keyMessageName()</code> method.</p>
</li>
<li>
<p>Set a value of <code>true</code> for the <code>embedded-key</code> attribute or <code>embeddedKey()</code> method if your schema includes keys within values.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save the changes to your configuration.</p>
</li>
</ol>
</div>
<h5 id="sql_table_store_configuration" class="discrete">SQL table store configuration</h5>
<div class="paragraph">
<p>The following example loads a distributed cache from a database table named "books" using composite values defined in a Protobuf schema:</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence&gt;
    &lt;table-jdbc-store xmlns="urn:infinispan:config:store:sql:14.0"
                      dialect="H2"
                      shared="true"
                      table-name="books"&gt;
      &lt;schema message-name="books_value"
              package="library"/&gt;
    &lt;/table-jdbc-store&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "persistence": {
      "table-jdbc-store": {
        "dialect": "H2",
        "shared": "true",
        "table-name": "books",
        "schema": {
          "message-name": "books_value",
          "package": "library"
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  persistence:
    tableJdbcStore:
      dialect: "H2"
      shared: "true"
      tableName: "books"
      schema:
        messageName: "books_value"
        package: "library"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.persistence().addStore(TableJdbcStoreConfigurationBuilder.class)
      .dialect(DatabaseType.H2)
      .shared("true")
      .tableName("books")
      .schemaJdbcConfigurationBuilder()
        .messageName("books_value")
        .packageName("library");</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../encoding/encoding.html">Cache encoding and marshalling: Generate Protobuf schema and register them with Infinispan</a></p>
</li>
<li>
<p><a href="https://github.com/infinispan/infinispan-simple-tutorials/tree/main/infinispan-remote/persistence">Persistence code tutorial with remote caches</a></p>
</li>
<li>
<p><a href="../configuring/configuring.html#jdbc-connection-factories_persistence">JDBC connection factories</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/jdbc/common/DatabaseType.html">DatabaseType Enum lists supported database dialects</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/infinispan-cachestore-sql-config-14.0.html">Infinispan SQL store configuration reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="configuring-sql-cache-stores-query_persistence"><a class="anchor" href="#configuring-sql-cache-stores-query_persistence"></a>6.10.3. Using SQL queries to load data and perform operations</h4>
<div class="paragraph">
<p>SQL query cache stores let you load caches from multiple database tables, including from sub-columns in database tables, and perform insert, update, and delete operations.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Have JDBC connection details.<br>
You can add JDBC connection factories directly to your cache configuration.<br>
For remote caches in production environments, you should add managed datasources to Infinispan Server configuration and specify the JNDI name in the cache configuration.</p>
</li>
<li>
<p>Generate Protobuf schema for any composite keys or composite values and register your schemas with Infinispan.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan recommends generating Protobuf schema with the ProtoStream processor.
For remote caches, you can register your schemas by adding them through the Infinispan Console, CLI, or REST API.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add database drivers to your Infinispan deployment.</p>
<div class="ulist">
<ul>
<li>
<p>Remote caches: Copy database drivers to the <code>server/lib</code> directory in your Infinispan Server installation.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use the <code class="command">install</code> command with the Infinispan Command Line Interface (CLI) to download the required drivers to the <code>server/lib</code> directory, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>install org.postgresql:postgresql:42.4.5</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Embedded caches: Add the <code>infinispan-cachestore-sql</code> dependency to your <code>pom</code> file and make sure database drivers are on your application classpath.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
  &lt;artifactId&gt;infinispan-cachestore-sql&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add a SQL query cache store.</p>
<div class="listingblock primary">
<div class="title">Declarative</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">query-jdbc-store xmlns="urn:infinispan:config:store:sql:14.0"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Programmatic</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">persistence().addStore(QueriesJdbcStoreConfigurationBuilder.class)</code></pre>
</div>
</div>
</li>
<li>
<p>Specify the database dialect with either <code>dialect=""</code> or <code>dialect()</code>, for example <code>dialect="H2"</code> or <code>dialect="postgres"</code>.</p>
</li>
<li>
<p>Configure the SQL cache store with the properties you require, for example:</p>
<div class="ulist">
<ul>
<li>
<p>To use the same cache store across your cluster, set <code>shared="true"</code> or <code>shared(true)</code>.</p>
</li>
<li>
<p>To create a read only cache store, set <code>read-only="true"</code> or <code>.ignoreModifications(true)</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Define SQL query statements that load caches with data and modify database tables with the <code>queries</code> element or the <code>queries()</code> method.</p>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Query statement</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SELECT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loads a single entry into caches.
You can use wildcards but must specify parameters for keys.
You can use labelled expressions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SELECT ALL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loads multiple entries into caches.
You can use the <code>*</code> wildcard if the number of columns returned match the key and value columns.
You can use labelled expressions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SIZE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counts the number of entries in the cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DELETE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deletes a single entry from the cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DELETE ALL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deletes all entries from the cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UPSERT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modifies entries in the cache.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>DELETE</code>, <code>DELETE ALL</code>, and <code>UPSERT</code> statements do not apply to read only cache stores but are required if cache stores allow modifications.</p>
</div>
<div class="paragraph">
<p>Parameters in <code>DELETE</code> statements must match parameters in <code>SELECT</code> statements exactly.</p>
</div>
<div class="paragraph">
<p>Variables in <code>UPSERT</code> statements must have the same number of uniquely named variables that <code>SELECT</code> and <code>SELECT ALL</code> statements return.
For example, if <code>SELECT</code> returns <code>foo</code> and <code>bar</code> this statement must take only <code>:foo</code> and <code>:bar</code> as variables.
However you can apply the same named variable more than once in a statement.</p>
</div>
<div class="paragraph">
<p>SQL queries can include <code>JOIN</code>, <code>ON</code>, and any other clauses that the database supports.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add the <code>schema</code> element or the <code>.schemaJdbcConfigurationBuilder()</code> method and add Protobuf schema configuration for composite keys or values.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify the package name with the <code>package</code> attribute or <code>package()</code> method.</p>
</li>
<li>
<p>Specify composite values with the <code>message-name</code> attribute or <code>messageName()</code> method.</p>
</li>
<li>
<p>Specify composite keys with the <code>key-message-name</code> attribute or <code>keyMessageName()</code> method.</p>
</li>
<li>
<p>Set a value of <code>true</code> for the <code>embedded-key</code> attribute or <code>embeddedKey()</code> method if your schema includes keys within values.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save the changes to your configuration.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../encoding/encoding.html">Cache encoding and marshalling: Generate Protobuf schema and register them with Infinispan</a></p>
</li>
<li>
<p><a href="https://github.com/infinispan/infinispan-simple-tutorials/tree/main/infinispan-remote/persistence">Persistence code tutorial with remote caches</a></p>
</li>
<li>
<p><a href="../configuring/configuring.html#jdbc-connection-factories_persistence">JDBC connection factories</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/jdbc/common/DatabaseType.html">DatabaseType Enum lists supported database dialects</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/infinispan-cachestore-sql-config-14.0.html">Infinispan SQL store configuration reference</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="sql-store-query-configuration_persistence"><a class="anchor" href="#sql-store-query-configuration_persistence"></a>SQL query store configuration</h5>
<div class="paragraph">
<p>This section provides an example configuration for a SQL query cache store that loads a distributed cache with data from two database tables: "person" and "address".</p>
</div>
<h6 id="sql_statements" class="discrete">SQL statements</h6>
<div class="paragraph">
<p>The following examples show SQL data definition language (DDL) statements for the "person" and "address" tables.
The data types described in the example are only valid for PostgreSQL database.</p>
</div>
<div class="listingblock primary">
<div class="title">SQL statement for the "person" table</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-proto" data-lang="proto">CREATE TABLE Person (
  name VARCHAR(255) NOT NULL,
  picture BYTEA,
  sex VARCHAR(255),
  birthdate TIMESTAMP,
  accepted_tos BOOLEAN,
  notused VARCHAR(255),
  PRIMARY KEY (name)
);</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">SQL statement for the "address" table</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-proto" data-lang="proto">CREATE TABLE Address (
  name VARCHAR(255) NOT NULL,
  street VARCHAR(255),
  city VARCHAR(255),
  zip INT,
  PRIMARY KEY (name)
);</code></pre>
</div>
</div>
<h6 id="protobuf_schemas" class="discrete">Protobuf schemas</h6>
<div class="paragraph">
<p>Protobuf schema for the "person" and "address" tables are as follows:</p>
</div>
<div class="listingblock secondary">
<div class="title">Protobuf schema for the "address" table</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-proto" data-lang="proto">package com.example;

message Address {
   optional string street = 1;
   optional string city = 2 [default = "San Jose"];
   optional int32 zip = 3 [default = 0];
}</code></pre>
</div>
</div>
<div class="listingblock primary">
<div class="title">Protobuf schema for the "person" table</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-proto" data-lang="proto">package com.example;

import "/path/to/address.proto";

enum Sex {
   FEMALE = 1;
   MALE = 2;
}

message Person {
   optional string name = 1;
   optional Address address = 2;
   optional bytes picture = 3;
   optional Sex sex = 4;
   optional fixed64 birthDate = 5 [default = 0];
   optional bool accepted_tos = 6 [default = false];
}</code></pre>
</div>
</div>
<h6 id="cache_configuration" class="discrete">Cache configuration</h6>
<div class="paragraph">
<p>The following example loads a distributed cache from the "person" and "address" tables using a SQL query that includes a <code>JOIN</code> clause:</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence&gt;
    &lt;query-jdbc-store xmlns="urn:infinispan:config:store:sql:14.0"
                      dialect="POSTGRES"
                      shared="true" key-columns="name"&gt;
          &lt;connection-pool driver="org.postgresql.Driver"
                            connection-url="jdbc:postgresql://localhost:5432/postgres"
                            username="postgres"
                            password="changeme"/&gt;
      &lt;queries select-single="SELECT t1.name, t1.picture, t1.sex, t1.birthdate, t1.accepted_tos, t2.street, t2.city, t2.zip FROM Person t1 JOIN Address t2 ON t1.name = :name AND t2.name = :name"
        select-all="SELECT t1.name, t1.picture, t1.sex, t1.birthdate, t1.accepted_tos, t2.street, t2.city, t2.zip FROM Person t1 JOIN Address t2 ON t1.name = t2.name"
        delete-single="DELETE FROM Person t1 WHERE t1.name = :name; DELETE FROM Address t2 where t2.name = :name"
        delete-all="DELETE FROM Person; DELETE FROM Address"
        upsert="INSERT INTO Person (name,  picture, sex, birthdate, accepted_tos) VALUES (:name, :picture, :sex, :birthdate, :accepted_tos); INSERT INTO Address(name, street, city, zip) VALUES (:name, :street, :city, :zip)"
        size="SELECT COUNT(*) FROM Person"
      /&gt;
      &lt;schema message-name="Person"
              package="com.example"
              embedded-key="true"/&gt;
    &lt;/query-jdbc-store&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "persistence": {
      "query-jdbc-store": {
        "dialect": "POSTGRES",
        "shared": "true",
        "key-columns": "name",
        "connection-pool": {
          "username": "postgres",
          "password": "changeme",
          "driver": "org.postgresql.Driver",
          "connection-url": "jdbc:postgresql://localhost:5432/postgres"
        },
        "queries": {
          "select-single": "SELECT t1.name, t1.picture, t1.sex, t1.birthdate, t1.accepted_tos, t2.street, t2.city, t2.zip FROM Person t1 JOIN Address t2 ON t1.name = :name AND t2.name = :name",
          "select-all": "SELECT t1.name, t1.picture, t1.sex, t1.birthdate, t1.accepted_tos, t2.street, t2.city, t2.zip FROM Person t1 JOIN Address t2 ON t1.name = t2.name",
          "delete-single": "DELETE FROM Person t1 WHERE t1.name = :name; DELETE FROM Address t2 where t2.name = :name",
          "delete-all": "DELETE FROM Person; DELETE FROM Address",
          "upsert": "INSERT INTO Person (name,  picture, sex, birthdate, accepted_tos) VALUES (:name, :picture, :sex, :birthdate, :accepted_tos); INSERT INTO Address(name, street, city, zip) VALUES (:name, :street, :city, :zip)",
          "size": "SELECT COUNT(*) FROM Person"
        },
        "schema": {
          "message-name": "Person",
          "package": "com.example",
          "embedded-key": "true"
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  persistence:
    queryJdbcStore:
      dialect: "POSTGRES"
      shared: "true"
      keyColumns: "name"
      connectionPool: 
        username: "postgres"
        password: "changeme"
        driver: "org.postgresql.Driver"
        connectionUrl: "jdbc:postgresql://localhost:5432/postgres"      
      queries:
        selectSingle: "SELECT t1.name, t1.picture, t1.sex, t1.birthdate, t1.accepted_tos, t2.street, t2.city, t2.zip FROM Person t1 JOIN Address t2 ON t1.name = :name AND t2.name = :name"
        selectAll: "SELECT t1.name, t1.picture, t1.sex, t1.birthdate, t1.accepted_tos, t2.street, t2.city, t2.zip FROM Person t1 JOIN Address t2 ON t1.name = t2.name"
        deleteSingle: "DELETE FROM Person t1 WHERE t1.name = :name; DELETE FROM Address t2 where t2.name = :name"
        deleteAll: "DELETE FROM Person; DELETE FROM Address"
        upsert: "INSERT INTO Person (name,  picture, sex, birthdate, accepted_tos) VALUES (:name, :picture, :sex, :birthdate, :accepted_tos); INSERT INTO Address(name, street, city, zip) VALUES (:name, :street, :city, :zip)"
        size: "SELECT COUNT(*) FROM Person"
      schema:
        messageName: "Person"
        package: "com.example"
        embeddedKey: "true"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.persistence().addStore(QueriesJdbcStoreConfigurationBuilder.class)
      .dialect(DatabaseType.POSTGRES)
      .shared("true")
      .keyColumns("name")
      .queriesJdbcConfigurationBuilder()
         .select("SELECT t1.name, t1.picture, t1.sex, t1.birthdate, t1.accepted_tos, t2.street, t2.city, t2.zip FROM Person t1 JOIN Address t2 ON t1.name = :name AND t2.name = :name")
         .selectAll("SELECT t1.name, t1.picture, t1.sex, t1.birthdate, t1.accepted_tos, t2.street, t2.city, t2.zip FROM Person t1 JOIN Address t2 ON t1.name = t2.name")
         .delete("DELETE FROM Person t1 WHERE t1.name = :name; DELETE FROM Address t2 where t2.name = :name")
         .deleteAll("DELETE FROM Person; DELETE FROM Address")
         .upsert("INSERT INTO Person (name,  picture, sex, birthdate, accepted_tos) VALUES (:name, :picture, :sex, :birthdate, :accepted_tos); INSERT INTO Address(name, street, city, zip) VALUES (:name, :street, :city, :zip)")
         .size("SELECT COUNT(*) FROM Person")
      .schemaJdbcConfigurationBuilder()
         .messageName("Person")
         .packageName("com.example")
         .embeddedKey(true);</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/infinispan-cachestore-sql-config-14.0.html">Infinispan SQL store configuration reference</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sql-cache-store-troubleshooting_persistence"><a class="anchor" href="#sql-cache-store-troubleshooting_persistence"></a>6.10.4. SQL cache store troubleshooting</h4>
<div class="paragraph">
<p>Find out about common issues and errors with SQL cache stores and how to troubleshoot them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>ISPN008064: No primary keys found for table &lt;table_name&gt;, check case sensitivity</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan logs this message in the following cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The database table does not exist.</p>
</li>
<li>
<p>The database table name is case sensitive and needs to be either all lower case or all upper case, depending on the database provider.</p>
</li>
<li>
<p>The database table does not have any primary keys defined.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To resolve this issue you should:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check your SQL cache store configuration and ensure that you specify the name of an existing table.</p>
</li>
<li>
<p>Ensure that the database table name conforms to an case sensitivity requirements.</p>
</li>
<li>
<p>Ensure that your database tables have primary keys that uniquely identify the appropriate rows.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-cache-store_persistence"><a class="anchor" href="#jdbc-cache-store_persistence"></a>6.11. JDBC string-based cache stores</h3>
<div class="paragraph">
<p>JDBC String-Based cache stores, <code>JdbcStringBasedStore</code>, use JDBC drivers to load and store values in the underlying database.</p>
</div>
<div class="paragraph">
<p>JDBC String-Based cache stores:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Store each entry in its own row in the table to increase throughput for concurrent loads.</p>
</li>
<li>
<p>Use a simple one-to-one mapping that maps each key to a <code>String</code> object using the <code>key-to-string-mapper</code> interface.<br>
Infinispan provides a default implementation, <code>DefaultTwoWayKey2StringMapper</code>, that handles primitive types.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to the data table used to store cache entries, the store also creates a <code>_META</code> table for storing metadata.
This table is used to ensure that any existing database content is compatible with the current Infinispan version and configuration.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default Infinispan shares are not stored, which means that all nodes in the
cluster write to the underlying store on each update. If you want operations to
write to the underlying database once only, you must configure JDBC store as
shared.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Segmentation</div>
<p><code>JdbcStringBasedStore</code> uses segmentation by default and requires a column in the database table to represent the segments to which entries belong.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/jdbc/common/DatabaseType.html">DatabaseType Enum lists supported database dialects</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="configuring-jdbc-cache-stores_persistence"><a class="anchor" href="#configuring-jdbc-cache-stores_persistence"></a>6.11.1. Configuring JDBC string-based cache stores</h4>
<div class="paragraph">
<p>Configure Infinispan caches with JDBC string-based cache stores that can connect to databases.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Remote caches: Copy database drivers to the <code>server/lib</code> directory in your Infinispan Server installation.</p>
</li>
<li>
<p>Embedded caches: Add the <code>infinispan-cachestore-jdbc</code> dependency to your <code>pom</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
  &lt;artifactId&gt;infinispan-cachestore-jdbc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a JDBC string-based cache store configuration in one of the following ways:</p>
<div class="ulist">
<ul>
<li>
<p>Declaratively, add the <code>persistence</code> element or field then add <code>string-keyed-jdbc-store</code> with the following schema namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">xmlns="urn:infinispan:config:store:jdbc:14.0"</code></pre>
</div>
</div>
</li>
<li>
<p>Programmatically, add the following methods to your <code>ConfigurationBuilder</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">persistence().addStore(JdbcStringBasedStoreConfigurationBuilder.class)</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Specify the dialect of the database with either the <code>dialect</code> attribute or the <code>dialect()</code> method.</p>
</li>
<li>
<p>Configure any properties for the JDBC string-based cache store as appropriate.</p>
<div class="paragraph">
<p>For example, specify if the cache store is shared with multiple cache instances with either the <code>shared</code> attribute or the <code>shared()</code> method.</p>
</div>
</li>
<li>
<p>Add a JDBC connection factory so that Infinispan can connect to the database.</p>
</li>
<li>
<p>Add a database table that stores cache entries.</p>
</li>
</ol>
</div>
<h5 id="jdbc_string_based_cache_store_configuration" class="discrete">JDBC string-based cache store configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence&gt;
    &lt;string-keyed-jdbc-store xmlns="urn:infinispan:config:store:jdbc:14.0"
                             dialect="H2"&gt;
      &lt;connection-pool connection-url="jdbc:h2:mem:infinispan"
                       username="sa"
                       password="changeme"
                       driver="org.h2.Driver"/&gt;
      &lt;string-keyed-table create-on-start="true"
                          prefix="ISPN_STRING_TABLE"&gt;
        &lt;id-column name="ID_COLUMN"
                   type="VARCHAR(255)" /&gt;
        &lt;data-column name="DATA_COLUMN"
                     type="BINARY" /&gt;
        &lt;timestamp-column name="TIMESTAMP_COLUMN"
                          type="BIGINT" /&gt;
        &lt;segment-column name="SEGMENT_COLUMN"
                        type="INT"/&gt;
      &lt;/string-keyed-table&gt;
    &lt;/string-keyed-jdbc-store&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "persistence": {
      "string-keyed-jdbc-store": {
        "dialect": "H2",
        "string-keyed-table": {
          "prefix": "ISPN_STRING_TABLE",
          "create-on-start": true,
          "id-column": {
            "name": "ID_COLUMN",
            "type": "VARCHAR(255)"
          },
          "data-column": {
            "name": "DATA_COLUMN",
            "type": "BINARY"
          },
          "timestamp-column": {
            "name": "TIMESTAMP_COLUMN",
            "type": "BIGINT"
          },
          "segment-column": {
            "name": "SEGMENT_COLUMN",
            "type": "INT"
          }
        },
        "connection-pool": {
          "connection-url": "jdbc:h2:mem:infinispan",
          "driver": "org.h2.Driver",
          "username": "sa",
          "password": "changeme"
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  persistence:
    stringKeyedJdbcStore:
      dialect: "H2"
      stringKeyedTable:
        prefix: "ISPN_STRING_TABLE"
        createOnStart: true
        idColumn:
          name: "ID_COLUMN"
          type: "VARCHAR(255)"
        dataColumn:
          name: "DATA_COLUMN"
          type: "BINARY"
        timestampColumn:
          name: "TIMESTAMP_COLUMN"
          type: "BIGINT"
        segmentColumn:
          name: "SEGMENT_COLUMN"
          type: "INT"
      connectionPool:
        connectionUrl: "jdbc:h2:mem:infinispan"
        driver: "org.h2.Driver"
        username: "sa"
        password: "changeme"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.persistence().addStore(JdbcStringBasedStoreConfigurationBuilder.class)
      .dialect(DatabaseType.H2)
      .table()
         .dropOnExit(true)
         .createOnStart(true)
         .tableNamePrefix("ISPN_STRING_TABLE")
         .idColumnName("ID_COLUMN").idColumnType("VARCHAR(255)")
         .dataColumnName("DATA_COLUMN").dataColumnType("BINARY")
         .timestampColumnName("TIMESTAMP_COLUMN").timestampColumnType("BIGINT")
         .segmentColumnName("SEGMENT_COLUMN").segmentColumnType("INT")
      .connectionPool()
         .connectionUrl("jdbc:h2:mem:infinispan")
         .username("sa")
         .password("changeme")
         .driverClass("org.h2.Driver");</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../configuring/configuring.html#jdbc-connection-factories_persistence">JDBC connection factories</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rocksdb-cache-store_persistence"><a class="anchor" href="#rocksdb-cache-store_persistence"></a>6.12. RocksDB cache stores</h3>
<div class="paragraph">
<p>RocksDB provides key-value filesystem-based storage with high performance and
reliability for highly concurrent environments.</p>
</div>
<div class="paragraph">
<p>RocksDB cache stores, <code>RocksDBStore</code>, use two databases. One database provides
a primary cache store for data in memory; the other database holds entries that
Infinispan expires from memory.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Configuration parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the path to the RocksDB database that provides the primary cache
store. If you do not set the location, it is automatically created. Note that
the path must be relative to the global persistent location.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>expiredLocation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the path to the RocksDB database that provides the cache store for
expired data. If you do not set the location, it is automatically created. Note
that the path must be relative to the global persistent location.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>expiryQueueSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the size of the in-memory queue for expiring entries. When the queue
reaches the size, Infinispan flushes the expired into the RocksDB cache store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clearThreshold</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the maximum number of entries before deleting and re-initializing
(<strong>re-init</strong>) the RocksDB database. For smaller size cache stores, iterating
through all entries and removing each one individually can provide a faster
method.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Tuning parameters</div>
<p>You can also specify the following RocksDB tuning parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>compressionType</code></p>
</li>
<li>
<p><code>blockSize</code></p>
</li>
<li>
<p><code>cacheSize</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Configuration properties</div>
<p>Optionally set properties in the configuration as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Prefix properties with <code>database</code> to adjust and tune RocksDB databases.</p>
</li>
<li>
<p>Prefix properties with <code>data</code> to configure the column families in which RocksDB stores your data.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;property name="database.max_background_compactions"&gt;2&lt;/property&gt;
&lt;property name="data.write_buffer_size"&gt;64MB&lt;/property&gt;
&lt;property name="data.compression_per_level"&gt;kNoCompression:kNoCompression:kNoCompression:kSnappyCompression:kZSTD:kZSTD&lt;/property&gt;</pre>
</div>
</div>
<div class="paragraph">
<div class="title">Segmentation</div>
<p><code>RocksDBStore</code> supports segmentation and creates a separate column family per
segment. Segmented RocksDB cache stores improve lookup performance
and iteration but slightly lower performance of write operations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You should not configure more than a few hundred segments. RocksDB is not
designed to have an unlimited number of column families. Too many segments also
significantly increases cache store start time.</p>
</div>
</td>
</tr>
</table>
</div>
<h4 id="rocksdb_cache_store_configuration" class="discrete">RocksDB cache store configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;local-cache&gt;
   &lt;persistence&gt;
      &lt;rocksdb-store xmlns="urn:infinispan:config:store:rocksdb:14.0"
                     path="rocksdb/data"&gt;
         &lt;expiration path="rocksdb/expired"/&gt;
      &lt;/rocksdb-store&gt;
   &lt;/persistence&gt;
&lt;/local-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "local-cache": {
    "persistence": {
      "rocksdb-store": {
        "path": "rocksdb/data",
        "expiration": {
          "path": "rocksdb/expired"
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">localCache:
  persistence:
    rocksdbStore:
      path: "rocksdb/data"
      expiration:
        path: "rocksdb/expired"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">Configuration cacheConfig = new ConfigurationBuilder().persistence()
				.addStore(RocksDBStoreConfigurationBuilder.class)
				.build();
EmbeddedCacheManager cacheManager = new DefaultCacheManager(cacheConfig);

Cache&lt;String, User&gt; usersCache = cacheManager.getCache("usersCache");
usersCache.put("raytsang", new User(...));</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder with properties</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">Properties props = new Properties();
props.put("database.max_background_compactions", "2");
props.put("data.write_buffer_size", "512MB");

Configuration cacheConfig = new ConfigurationBuilder().persistence()
				.addStore(RocksDBStoreConfigurationBuilder.class)
				.location("rocksdb/data")
				.expiredLocation("rocksdb/expired")
				.properties(props)
				.build();</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/infinispan-cachestore-rocksdb-config-14.0.html">RocksDB cache store configuration schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/rocksdb/RocksDBStore.html">RocksDBStore</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/rocksdb/configuration/RocksDBStoreConfiguration.html">RocksDBStoreConfiguration</a></p>
</li>
<li>
<p><a href="http://rocksdb.org/">rocksdb.org</a></p>
</li>
<li>
<p><a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide">RocksDB Tuning Guide</a></p>
</li>
<li>
<p><a href="https://github.com/infinispan/infinispan/blob/main/persistence/rocksdb/src/test/java/org/infinispan/persistence/rocksdb/config/ConfigurationTest.java">RocksDB Cache Store test</a></p>
</li>
<li>
<p><a href="https://github.com/infinispan/infinispan/tree/main/persistence/rocksdb/src/test/resources/config/">RocksDB Cache Store test configuration</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="remote-cache-store_persistence"><a class="anchor" href="#remote-cache-store_persistence"></a>6.13. Remote cache stores</h3>
<div class="paragraph">
<p>Remote cache stores, <code>RemoteStore</code>, use the Hot Rod protocol to store data on
Infinispan clusters.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you configure remote cache stores as shared you cannot preload data.
In other words if <code>shared="true"</code> in your configuration then you must set <code>preload="false"</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Segmentation</div>
<p><code>RemoteStore</code> supports segmentation and can publish keys and entries by
segment, which makes bulk operations more efficient. However, segmentation is
available only with Infinispan Hot Rod protocol version 2.3 or later.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you enable segmentation for <code>RemoteStore</code>, it uses the number of segments
that you define in your Infinispan server configuration.</p>
</div>
<div class="paragraph">
<p>If the source cache is segmented and uses a different number of segments than
<code>RemoteStore</code>, then incorrect values are returned for bulk operations. In this
case, you should disable segmentation for <code>RemoteStore</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<h4 id="remote_cache_store_configuration" class="discrete">Remote cache store configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence&gt;
    &lt;remote-store xmlns="urn:infinispan:config:store:remote:14.0"
                  cache="mycache"
                  raw-values="true"&gt;
      &lt;remote-server host="one"
                     port="12111" /&gt;
      &lt;remote-server host="two" /&gt;
      &lt;connection-pool max-active="10"
                       exhausted-action="CREATE_NEW" /&gt;
    &lt;/remote-store&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "remote-store": {
      "cache": "mycache",
      "raw-values": "true",
      "remote-server": [
        {
          "host": "one",
          "port": "12111"
        },
        {
          "host": "two"
        }
      ],
      "connection-pool": {
        "max-active": "10",
        "exhausted-action": "CREATE_NEW"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  remoteStore:
    cache: "mycache"
    rawValues: "true"
    remoteServer:
      - host: "one"
        port: "12111"
      - host: "two"
    connectionPool:
      maxActive: "10"
      exhaustedAction: "CREATE_NEW"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder b = new ConfigurationBuilder();
b.persistence().addStore(RemoteStoreConfigurationBuilder.class)
      .ignoreModifications(false)
      .purgeOnStartup(false)
      .remoteCacheName("mycache")
      .rawValues(true)
.addServer()
      .host("one").port(12111)
      .addServer()
      .host("two")
      .connectionPool()
      .maxActive(10)
      .exhaustedAction(ExhaustedAction.CREATE_NEW)
      .async().enable();</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/infinispan-cachestore-remote-config-14.0.html">Remote cache store configuration schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/remote/RemoteStore.html">RemoteStore</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/remote/configuration/RemoteStoreConfigurationBuilder.html">RemoteStoreConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="cluster-cache-loader_persistence"><a class="anchor" href="#cluster-cache-loader_persistence"></a>6.14. Cluster cache loaders</h3>
<div class="paragraph">
<p><code>ClusterCacheLoader</code> retrieves data from other Infinispan cluster members but
does not persist data. In other words, <code>ClusterCacheLoader</code> is not a cache
store.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>ClusterLoader</code> is deprecated and planned for removal in a future version.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>ClusterCacheLoader</code> provides a non-blocking partial alternative to state
transfer. <code>ClusterCacheLoader</code> fetches keys from other nodes on demand if those
keys are not available on the local node, which is similar to lazily loading
cache content.</p>
</div>
<div class="paragraph">
<p>The following points also apply to <code>ClusterCacheLoader</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Preloading does not take effect (<code>preload=true</code>).</p>
</li>
<li>
<p>Segmentation is not supported.</p>
</li>
</ul>
</div>
<h4 id="cluster_cache_loader_configuration" class="discrete">Cluster cache loader configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence&gt;
    &lt;cluster-loader preload="true" remote-timeout="500"/&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "persistence" : {
      "cluster-loader" : {
        "preload" : true,
        "remote-timeout" : "500"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  persistence:
    clusterLoader:
      preload: "true"
      remoteTimeout: "500"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder b = new ConfigurationBuilder();
b.persistence()
    .addClusterLoader()
    .remoteCallTimeout(500);</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/infinispan-config-14.0.html">Infinispan configuration schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/cluster/ClusterLoader.html">ClusterLoader</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/configuration/cache/ClusterLoaderConfiguration.html">ClusterLoaderConfiguration</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="creating-custom-cache-stores"><a class="anchor" href="#creating-custom-cache-stores"></a>6.15. Creating custom cache store implementations</h3>
<div class="paragraph">
<p>You can create custom cache stores through the Infinispan persistent SPI.</p>
</div>
<div class="sect3">
<h4 id="persistent-spi_custom-cache-stores"><a class="anchor" href="#persistent-spi_custom-cache-stores"></a>6.15.1. Infinispan Persistence SPI</h4>
<div class="paragraph">
<p>The Infinispan Service Provider Interface (SPI) enables read and write
operations to external storage through the <code>NonBlockingStore</code> interface and has
the following features:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Portability across JCache-compliant vendors</dt>
<dd>
<p>Infinispan maintains compatibility between the <code>NonBlockingStore</code> interface
and the <code>JSR-107</code> JCache specification by using an adapter that handles
blocking code.</p>
</dd>
<dt class="hdlist1">Simplified transaction integration</dt>
<dd>
<p>Infinispan automatically handles locking so your implementations do not need
to coordinate concurrent access to persistent stores. Depending on the locking
mode you use, concurrent writes to the same key generally do not occur.
However, you should expect operations on the persistent storage to originate
from multiple threads and create implementations to tolerate this behavior.</p>
</dd>
<dt class="hdlist1">Parallel iteration</dt>
<dd>
<p>Infinispan lets you iterate over entries in persistent stores with multiple
threads in parallel.</p>
</dd>
<dt class="hdlist1">Reduced serialization resulting in less CPU usage</dt>
<dd>
<p>Infinispan exposes stored entries in a serialized format that can be
transmitted remotely. For this reason, Infinispan does not need to deserialize
entries that it retrieves from persistent storage and then serialize again when
writing to the wire.</p>
</dd>
</dl>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/spi/package-summary.html">Persistence SPI</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/persistence/spi/NonBlockingStore.html">NonBlockingStore</a></p>
</li>
<li>
<p><a href="http://jcp.org/en/jsr/detail?id=107">JSR-107</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="creating-custom-cache-stores_custom-cache-stores"><a class="anchor" href="#creating-custom-cache-stores_custom-cache-stores"></a>6.15.2. Creating cache stores</h4>
<div class="paragraph">
<p>Create custom cache stores with implementations of the <code>NonBlockingStore</code> API.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Implement the appropriate Infinispan persistent SPIs.</p>
</li>
<li>
<p>Annotate your store class with the <code>@ConfiguredBy</code> annotation if it has a custom configuration.</p>
</li>
<li>
<p>Create a custom cache store configuration and builder if desired.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Extend <code>AbstractStoreConfiguration</code> and <code>AbstractStoreConfigurationBuilder</code>.</p>
</li>
<li>
<p>Optionally add the following annotations to your store Configuration class to ensure that your
custom configuration builder parses your cache store configuration from XML:</p>
<div class="ulist">
<ul>
<li>
<p><code>@ConfigurationFor</code></p>
</li>
<li>
<p><code>@BuiltBy</code></p>
<div class="paragraph">
<p>If you do not add these annotations, then <code>CustomStoreConfigurationBuilder</code> parses the common
store attributes defined in <code>AbstractStoreConfiguration</code> and any additional elements are ignored.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If a configuration does not declare the
<code>@ConfigurationFor</code> annotation, a warning message is logged when Infinispan
initializes the cache.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="custom-cache-store-configuration_custom-cache-stores"><a class="anchor" href="#custom-cache-store-configuration_custom-cache-stores"></a>6.15.3. Examples of custom cache store configuration</h4>
<div class="paragraph">
<p>The following are examples show how to configure Infinispan with custom cache store implementations:</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;persistence&gt;
    &lt;store class="org.infinispan.persistence.example.MyInMemoryStore" /&gt;
  &lt;/persistence&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "persistence" : {
      "store" : {
        "class" : "org.infinispan.persistence.example.MyInMemoryStore"
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  persistence:
    store:
      class: "org.infinispan.persistence.example.MyInMemoryStore"</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">Configuration config = new ConfigurationBuilder()
            .persistence()
            .addStore(CustomStoreConfigurationBuilder.class)
            .build();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deploying-custom-cache-stores_custom-cache-stores"><a class="anchor" href="#deploying-custom-cache-stores_custom-cache-stores"></a>6.15.4. Deploying custom cache stores</h4>
<div class="paragraph">
<p>To use your cache store implementation with Infinispan Server, you must provide it with a JAR file.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Stop Infinispan Server if it is running.</p>
<div class="paragraph">
<p>Infinispan loads JAR files at startup only.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Package your custom cache store implementation in a JAR file.</p>
</li>
<li>
<p>Add your JAR file to the <code>server/lib</code> directory of your Infinispan Server installation.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cache-store-migrator"><a class="anchor" href="#cache-store-migrator"></a>6.16. Migrating data between cache stores</h3>
<div class="paragraph">
<p>Infinispan provides a utility to migrate data from one cache store to another.</p>
</div>
<div class="sect3">
<h4 id="store-migrator_cache-store-migrator"><a class="anchor" href="#store-migrator_cache-store-migrator"></a>6.16.1. Cache store migrator</h4>
<div class="paragraph">
<p>Infinispan provides the <code>StoreMigrator.java</code> utility that recreates data for the latest Infinispan cache store implementations.</p>
</div>
<div class="paragraph">
<p><code>StoreMigrator</code> takes a cache store from a previous version of Infinispan as source and uses a cache store implementation as target.</p>
</div>
<div class="paragraph">
<p>When you run <code>StoreMigrator</code>, it creates the target cache with the cache store type that you define using the <code>EmbeddedCacheManager</code> interface.
<code>StoreMigrator</code> then loads entries from the source store into memory and then puts them into the target cache.</p>
</div>
<div class="paragraph">
<p><code>StoreMigrator</code> also lets you migrate data from one type of cache store to another. For example, you can migrate from a JDBC string-based cache store to a RocksDB cache store.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>StoreMigrator</code> cannot migrate data from segmented cache stores to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Non-segmented cache store.</p>
</li>
<li>
<p>Segmented cache stores that have a different number of segments.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="getting-store-migrator_cache-store-migrator"><a class="anchor" href="#getting-store-migrator_cache-store-migrator"></a>6.16.2. Getting the cache store migrator</h4>
<div class="paragraph">
<p><code>StoreMigrator</code> is available as part of the Infinispan tools library,
<code>infinispan-tools</code>, and is included in the Maven repository.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Configure your <code>pom.xml</code> for <code>StoreMigrator</code> as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;org.infinispan.example&lt;/groupId&gt;
    &lt;artifactId&gt;jdbc-migrator-example&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;

    &lt;dependencies&gt;
      &lt;dependency&gt;
        &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
        &lt;artifactId&gt;infinispan-tools&lt;/artifactId&gt;
      &lt;/dependency&gt;
      &lt;!-- Additional dependencies --&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
      &lt;plugins&gt;
        &lt;plugin&gt;
          &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
          &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt;
          &lt;version&gt;1.2.1&lt;/version&gt;
          &lt;executions&gt;
            &lt;execution&gt;
              &lt;goals&gt;
                &lt;goal&gt;java&lt;/goal&gt;
              &lt;/goals&gt;
            &lt;/execution&gt;
          &lt;/executions&gt;
          &lt;configuration&gt;
            &lt;mainClass&gt;org.infinispan.tools.store.migrator.StoreMigrator&lt;/mainClass&gt;
            &lt;arguments&gt;
              &lt;argument&gt;path/to/migrator.properties&lt;/argument&gt;
            &lt;/arguments&gt;
          &lt;/configuration&gt;
        &lt;/plugin&gt;
      &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="configuring-store-migrator_cache-store-migrator"><a class="anchor" href="#configuring-store-migrator_cache-store-migrator"></a>6.16.3. Configuring the cache store migrator</h4>
<div class="paragraph">
<p>Use the <code>migrator.properties</code> file to configure properties for source and target cache stores.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>migrator.properties</code> file.</p>
</li>
<li>
<p>Configure properties for source and target cache store using the <code>migrator.properties</code> file.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add the <code>source.</code> prefix to all configuration properties for the source cache store.</p>
<div class="listingblock">
<div class="title">Example source cache store</div>
<div class="content">
<pre class="highlight nowrap"><code>source.type=SOFT_INDEX_FILE_STORE
source.cache_name=myCache
source.location=/path/to/source/sifs
source.version=&lt;version&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For migrating data from segmented cache stores, you must also configure the number of segments using the <code>source.segment_count</code> property.
The number of segments must match <code>clustering.hash.numSegments</code> in your Infinispan configuration.
If the number of segments for a cache store does not match the number of segments for the corresponding cache, Infinispan cannot read data from the cache store.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add the <code>target.</code> prefix to all configuration properties for the target cache store.</p>
<div class="listingblock">
<div class="title">Example target cache store</div>
<div class="content">
<pre class="highlight nowrap"><code>target.type=SINGLE_FILE_STORE
target.cache_name=myCache
target.location=/path/to/target/sfs.dat</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="store-migrator-properties_cache-store-migrator"><a class="anchor" href="#store-migrator-properties_cache-store-migrator"></a>Configuration properties for the cache store migrator</h5>
<div class="paragraph">
<p>Configure source and target cache stores in a <code>StoreMigrator</code> properties.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Cache Store Type Property</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the type of cache store for a source or target cache store.</p>
<p class="tableblock"><code>.type=JDBC_STRING</code></p>
<p class="tableblock"><code>.type=JDBC_BINARY</code></p>
<p class="tableblock"><code>.type=JDBC_MIXED</code></p>
<p class="tableblock"><code>.type=LEVELDB</code></p>
<p class="tableblock"><code>.type=ROCKSDB</code></p>
<p class="tableblock"><code>.type=SINGLE_FILE_STORE</code></p>
<p class="tableblock"><code>.type=SOFT_INDEX_FILE_STORE</code></p>
<p class="tableblock"><code>.type=JDBC_MIXED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Common Properties</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example Value</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cache_name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the cache that you want to back up.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.cache_name=myCache</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>segment_count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of segments for target cache stores that can use
segmentation.</p>
<p class="tableblock">The number of segments must match <code>clustering.hash.numSegments</code> in the
Infinispan configuration. If the number of segments for a cache store does not match the number of segments for the corresponding cache, Infinispan cannot read data from the cache store.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.segment_count=256</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. JDBC Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dialect</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the dialect of the underlying database.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the marshaller version for source cache stores.<br>
Set the value that matches the Infinispan major version of the source cluster. For example; set a value of <code>14</code> for Infinispan 14.x.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required for source stores only.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>marshaller.class</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a custom marshaller class.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required if using custom marshallers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>marshaller.externalizers</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a comma-separated list of custom <code>AdvancedExternalizer</code> implementations to load in this format: <code>[id]:&lt;Externalizer class&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connection_pool.connection_url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the JDBC connection URL.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connection_pool.driver_class</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the class of the JDBC driver.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connection_pool.username</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a database username.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connection_pool.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a password for the database username.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>db.disable_upsert</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disables database upsert.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>db.disable_indexing</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies if table indexes are created.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>table.string.table_name_prefix</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies additional prefixes for the table name.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>table.string.&lt;id|data|timestamp&gt;.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the column name.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>table.string.&lt;id|data|timestamp&gt;.type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the column type.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>key_to_string_mapper</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the <code>TwoWayKey2StringMapper</code> class.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To migrate from Binary cache stores in older Infinispan versions, change
<code>table.string.*</code> to <code>table.binary.\*</code> in the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>source.table.binary.table_name_prefix</code></p>
</li>
<li>
<p><code>source.table.binary.&lt;id\|data\|timestamp&gt;.name</code></p>
</li>
<li>
<p><code>source.table.binary.&lt;id\|data\|timestamp&gt;.type</code></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre># Example configuration for migrating to a JDBC String-Based cache store
target.type=STRING
target.cache_name=myCache
target.dialect=POSTGRES
target.marshaller.class=org.example.CustomMarshaller
target.marshaller.externalizers=25:Externalizer1,org.example.Externalizer2
target.connection_pool.connection_url=jdbc:postgresql:postgres
target.connection_pool.driver_class=org.postrgesql.Driver
target.connection_pool.username=postgres
target.connection_pool.password=redhat
target.db.disable_upsert=false
target.db.disable_indexing=false
target.table.string.table_name_prefix=tablePrefix
target.table.string.id.name=id_column
target.table.string.data.name=datum_column
target.table.string.timestamp.name=timestamp_column
target.table.string.id.type=VARCHAR
target.table.string.data.type=bytea
target.table.string.timestamp.type=BIGINT
target.key_to_string_mapper=org.infinispan.persistence.keymappers. DefaultTwoWayKey2StringMapper</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. RocksDB Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the database directory.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>compression</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the compression type to use.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre># Example configuration for migrating from a RocksDB cache store.
source.type=ROCKSDB
source.cache_name=myCache
source.location=/path/to/rocksdb/database
source.compression=SNAPPY</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. SingleFileStore Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the directory that contains the cache store <code>.dat</code> file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre># Example configuration for migrating to a Single File cache store.
target.type=SINGLE_FILE_STORE
target.cache_name=myCache
target.location=/path/to/sfs.dat</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. SoftIndexFileStore Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required/Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the database directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>index_location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the database index directory.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre># Example configuration for migrating to a Soft-Index File cache store.
target.type=SOFT_INDEX_FILE_STORE
target.cache_name=myCache
target.location=path/to/sifs/database
target.location=path/to/sifs/index</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="migrating-cache-stores_cache-store-migrator"><a class="anchor" href="#migrating-cache-stores_cache-store-migrator"></a>6.16.4. Migrating Infinispan cache stores</h4>
<div class="paragraph">
<p>You can use the <code>StoreMigrator</code> to migrate data between cache stores with different Infinispan versions or to migrate data from one type of cache store to another.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Have a  <code>infinispan-tools.jar</code>.</p>
</li>
<li>
<p>Have the source and target cache store configured in the <code>migrator.properties</code> file.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>If you built the <code>infinispan-tools.jar</code> from the source code, do the following:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add <code>infinispan-tools.jar</code> to your classpath.</p>
</li>
<li>
<p>Add dependencies for your source and target databases, such as JDBC drivers to your classpath.</p>
</li>
<li>
<p>Specify <code>migrator.properties</code> file as an argument for <code>StoreMigrator</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you pulled <code>infinispan-tools.jar</code> from the Maven repository, run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">mvn exec:java</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="partition-handling"><a class="anchor" href="#partition-handling"></a>7. Configuring Infinispan to handle network partitions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan clusters can split into network partitions in which subsets of nodes become isolated from each other.
This condition results in loss of availability or consistency for clustered caches.
Infinispan automatically detects crashed nodes and resolves conflicts to merge caches back together.</p>
</div>
<div class="sect2">
<h3 id="partition-handling_partition-handling"><a class="anchor" href="#partition-handling_partition-handling"></a>7.1. Split clusters and network partitions</h3>
<div class="paragraph">
<p>Network partitions are the result of error conditions in the running environment, such as when a network router crashes.
When a cluster splits into partitions, nodes create a JGroups cluster view that includes only the nodes in that partition.
This condition means that nodes in one partition can operate independently of nodes in the other partition.</p>
</div>
<div class="paragraph">
<div class="title">Detecting a split</div>
<p>To automatically detect network partitions, Infinispan uses the <code>FD_ALL</code> protocol in the default JGroups stack to determine when nodes leave the cluster abruptly.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan cannot detect what causes nodes to leave abruptly.
This can happen not only when there is a network failure but also for other reasons, such as when Garbage Collection (GC) pauses the JVM.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Infinispan suspects that nodes have crashed after the following number of milliseconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>FD_ALL[2|3].timeout + FD_ALL[2|3].interval + VERIFY_SUSPECT[2].timeout + GMS.view_ack_collection_timeout</code></pre>
</div>
</div>
<div class="paragraph">
<p>When it detects that the cluster is split into network partitions, Infinispan uses a strategy for handling cache operations.
Depending on your application requirements Infinispan can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allow read and/or write operations for availability</p>
</li>
<li>
<p>Deny read and write operations for consistency</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Merging partitions together</div>
<p>To fix a split cluster, Infinispan merges the partitions back together.
During the merge, Infinispan uses the <code>.equals()</code> method for values of cache entries to determine if any conflicts exist.
To resolve any conflicts between replicas it finds on partitions, Infinispan uses a merge policy that you can configure.</p>
</div>
<div class="sect3">
<h4 id="partition-handling-data-consistency_partition-handling"><a class="anchor" href="#partition-handling-data-consistency_partition-handling"></a>7.1.1. Data consistency in a split cluster</h4>
<div class="paragraph">
<p>Network outages or errors that cause Infinispan clusters to split into partitions can result in data loss or consistency issues regardless of any handling strategy or merge policy.</p>
</div>
<div class="paragraph">
<div class="title">Between the split and detection</div>
<p>If a write operation takes place on a node that is in a minor partition when a split occurs, and before Infinispan detects the split, that value is lost when Infinispan transfers state to that minor partition during the merge.</p>
</div>
<div class="paragraph">
<p>In the event that all partitions are in the <code>DEGRADED</code> mode that value is not lost because no state transfer occurs but the entry can have an inconsistent value.
For transactional caches write operations that are in progress when the split occurs can be committed on some nodes and rolled back on other nodes, which also results in inconsistent values.</p>
</div>
<div class="paragraph">
<p>During the split and the time that Infinispan detects it, it is possible to get stale reads from a cache in a minor partition that has not yet entered <code>DEGRADED</code> mode.</p>
</div>
<div class="paragraph">
<div class="title">During the merge</div>
<p>When Infinispan starts removing partitions nodes reconnect to the cluster with a series of merge events.
Before this merge process completes it is possible that write operations on transactional caches succeed on some nodes but not others, which can potentially result in stale reads until the entries are updated.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="partition-handling-degraded-mode_partition-handling"><a class="anchor" href="#partition-handling-degraded-mode_partition-handling"></a>7.2. Cache availability and degraded mode</h3>
<div class="paragraph">
<p>To preserve data consistency, Infinispan can put caches into <code>DEGRADED</code> mode if you configure them to use either the <code>DENY_READ_WRITES</code> or <code>ALLOW_READS</code> partition handling strategy.</p>
</div>
<div class="paragraph">
<p>Infinispan puts caches in a partition into <code>DEGRADED</code> mode when the following conditions are true:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At least one segment has lost all owners.<br>
This happens when a number of nodes equal to or greater than the number of owners for a distributed cache have left the cluster.</p>
</li>
<li>
<p>There is not a majority of nodes in the partition.<br>
A majority of nodes is any number greater than half the total number of nodes in the cluster from the most recent stable topology, which was the last time a cluster rebalancing operation completed successfully.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When caches are in <code>DEGRADED</code> mode, Infinispan:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allows read and write operations only if all replicas of an entry reside in the same partition.</p>
</li>
<li>
<p>Denies read and write operations and throws an <code>AvailabilityException</code> if the partition does not include all replicas of an entry.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With the <code>ALLOW_READS</code> strategy, Infinispan allows read operations on caches in <code>DEGRADED</code> mode.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>DEGRADED</code> mode guarantees consistency by ensuring that write operations do not take place for the same key in different partitions.
Additionally <code>DEGRADED</code> mode prevents stale read operations that happen when a key is updated in one partition but read in another partition.</p>
</div>
<div class="paragraph">
<p>If all partitions are in <code>DEGRADED</code> mode then the cache becomes available again after merge only if the cluster contains a majority of nodes from the most recent stable topology and there is at least one replica of each entry.
When the cluster has at least one replica of each entry, no keys are lost and Infinispan can create new replicas based on the number of owners during cluster rebalancing.</p>
</div>
<div class="paragraph">
<p>In some cases a cache in one partition can remain available while entering <code>DEGRADED</code> mode in another partition.
When this happens the available partition continues cache operations as normal and Infinispan attempts to rebalance data across those nodes.
To merge the cache together Infinispan always transfers state from the available partition to the partition in <code>DEGRADED</code> mode.</p>
</div>
<div class="sect3">
<h4 id="degraded-mode-example_partition-handling"><a class="anchor" href="#degraded-mode-example_partition-handling"></a>7.2.1. Degraded cache recovery example</h4>
<div class="paragraph">
<p>This topic illustrates how Infinispan recovers from split clusters with caches that use the <code>DENY_READ_WRITES</code> partition handling strategy.</p>
</div>
<div class="paragraph">
<p>As an example, a Infinispan cluster has four nodes and includes a distributed cache with two replicas for each entry (<code>owners=2</code>).
There are four entries in the cache, <code>k1</code>, <code>k2</code>, <code>k3</code> and <code>k4</code>.</p>
</div>
<div class="paragraph">
<p>With the <code>DENY_READ_WRITES</code> strategy, if the cluster splits into partitions, Infinispan allows cache operations only if all replicas of an entry are in the same partition.</p>
</div>
<div class="paragraph">
<p>In the following diagram, while the cache is split into partitions, Infinispan allows read and write operations for <code>k1</code> on partition 1 and <code>k4</code> on partition 2.
Because there is only one replica for <code>k2</code> and <code>k3</code> on either partition 1 or partition 2, Infinispan denies read and write operations for those entries.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../topics/images/partition-handling-partitioning.png" alt="Distributed cache enters network partition">
</div>
</div>
<div class="paragraph">
<p>When network conditions allow the nodes to re-join the same cluster view, Infinispan merges the partitions without state transfer and restores normal cache operations.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../topics/images/partition-handling-merging.png" alt="Distributed cache after partitions are merged">
</div>
</div>
</div>
<div class="sect3">
<h4 id="checking-cache-availability_partition-handling"><a class="anchor" href="#checking-cache-availability_partition-handling"></a>7.2.2. Verifying cache availability during network partitions</h4>
<div class="paragraph">
<p>Determine if caches on Infinispan clusters are in <code>AVAILABLE</code> mode or <code>DEGRADED</code> mode during a network partition.</p>
</div>
<div class="paragraph">
<p>When Infinispan clusters split into partitions, nodes in those partitions can enter <code>DEGRADED</code> mode to guarantee data consistency.
In <code>DEGRADED</code> mode clusters do not allow cache operations resulting in loss of availability.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Verify availability of clustered caches in network partitions in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check Infinispan logs for <code>ISPN100011</code> messages that indicate if the cluster is available or if at least one cache is in <code>DEGRADED</code> mode.</p>
</li>
<li>
<p>Get the availability of remote caches through the Infinispan Console or with the REST API.</p>
<div class="ulist">
<ul>
<li>
<p>Open the Infinispan Console in any browser, select the <strong>Data Container</strong> tab, and then locate the availability status in the <strong>Health</strong> column.</p>
</li>
<li>
<p>Retrieve cache health from the REST API.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>GET /rest/v2/cache-managers/&lt;cacheManagerName&gt;/health</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Programmatically retrieve the availability of embedded caches with the <code>getAvailability()</code> method in the <code>AdvancedCache</code> API.</p>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../rest/rest.html#rest_v2_cache_manager_health">REST API: Getting cluster health</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/AdvancedCache.html#getAvailability()">org.infinispan.AdvancedCache.getAvailability</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/partitionhandling/AvailabilityMode.html">Enum AvailabilityMode</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="making-caches-available_partition-handling"><a class="anchor" href="#making-caches-available_partition-handling"></a>7.2.3. Making caches available</h4>
<div class="paragraph">
<p>Make caches available for read and write operations by forcing them out of <code>DEGRADED</code> mode.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You should force clusters out of <code>DEGRADED</code> mode only if your deployment can tolerate data loss and inconsistency.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Make caches available in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open the Infinispan Console and select the <strong>Make available</strong> option.</p>
</li>
<li>
<p>Change the availability of remote caches with the REST API.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code>POST /rest/v2/caches/&lt;cacheName&gt;?action=set-availability&amp;availability=AVAILABLE</code></pre>
</div>
</div>
</li>
<li>
<p>Programmatically change the availability of embedded caches with the <code>AdvancedCache</code> API.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">AdvancedCache ac = cache.getAdvancedCache();
// Retrieve cache availability
boolean available = ac.getAvailability() == AvailabilityMode.AVAILABLE;
// Make the cache available
if (!available) {
   ac.setAvailability(AvailabilityMode.AVAILABLE);
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="../rest/rest.html#rest_v2_caches_set_availability">REST API: Setting cache availability</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/AdvancedCache.html">org.infinispan.AdvancedCache</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-partition-handling_partition-handling"><a class="anchor" href="#configuring-partition-handling_partition-handling"></a>7.3. Configuring partition handling</h3>
<div class="paragraph">
<p>Configure Infinispan to use a partition handling strategy and merge policy so it can resolve split clusters when network issues occur.
By default Infinispan uses a strategy that provides availability at the cost of lowering consistency guarantees for your data.
When a cluster splits due to a network partition clients can continue to perform read and write operations on caches.</p>
</div>
<div class="paragraph">
<p>If you require consistency over availability, you can configure Infinispan to deny read and write operations while the cluster is split into partitions.
Alternatively you can allow read operations and deny write operations.
You can also specify custom merge policy implementations that configure Infinispan to resolve splits with custom logic tailored to your requirements.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Have a Infinispan cluster where you can create either a replicated or distributed cache.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Partition handling configuration applies only to replicated and distributed caches.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add partition handling configuration to your cache with either the <code>partition-handling</code> element or <code>partitionHandling()</code> method.</p>
</li>
<li>
<p>Specify a strategy for Infinispan to use when the cluster splits into partitions with the <code>when-split</code> attribute or <code>whenSplit()</code> method.</p>
<div class="paragraph">
<p>The default partition handling strategy is <code>ALLOW_READ_WRITES</code> so caches remain availabile.
If your use case requires data consistency over cache availability, specify the <code>DENY_READ_WRITES</code> strategy.</p>
</div>
</li>
<li>
<p>Specify a policy that Infinispan uses to resolve conflicting entries when merging partitions with the <code>merge-policy</code> attribute or <code>mergePolicy()</code> method.</p>
<div class="paragraph">
<p>By default Infinispan does not resolve conflicts on merge.</p>
</div>
</li>
<li>
<p>Save the changes to your Infinispan configuration.</p>
</li>
</ol>
</div>
<h4 id="partition_handling_configuration" class="discrete">Partition handling configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
   &lt;partition-handling when-split="DENY_READ_WRITES"
                       merge-policy="PREFERRED_ALWAYS"/&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "partition-handling" : {
      "when-split": "DENY_READ_WRITES",
      "merge-policy": "PREFERRED_ALWAYS"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  partitionHandling:
    whenSplit: DENY_READ_WRITES
    mergePolicy: PREFERRED_ALWAYS</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.clustering().cacheMode(CacheMode.DIST_SYNC)
       .partitionHandling()
       .whenSplit(PartitionHandling.DENY_READ_WRITES)
       .mergePolicy(MergePolicy.PREFERRED_NON_NULL);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="partition-handling-strategies_partition-handling"><a class="anchor" href="#partition-handling-strategies_partition-handling"></a>7.4. Partition handling strategies</h3>
<div class="paragraph">
<p>Partition handling strategies control if Infinispan allows read and write operations when a cluster is split.
The strategy you configure determines whether you get cache availability or data consistency.</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<caption class="title">Table 8. Partition handling strategies</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strategy</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Availability or consistency</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ALLOW_READ_WRITES</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan allows read and write operations on caches while a cluster is split into network partitions.
Nodes in each partition remain available and function independently of each other.
This is the default partition handling strategy.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Availability</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DENY_READ_WRITES</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan allows read and write operations only if all replicas of an entry are in the partition.
If a partition does not include all replicas of an entry, Infinispan prevents cache operations for that entry.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Consistency</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ALLOW_READS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan allows read operations for entries and prevents write operations unless the partition includes all replicas of an entry.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Consistency with read availability</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="partition-handling-merge-policies_partition-handling"><a class="anchor" href="#partition-handling-merge-policies_partition-handling"></a>7.5. Merge policies</h3>
<div class="paragraph">
<p>Merge policies control how Infinispan resolves conflicts between replicas when bringing cluster partitions together.
You can use one of the merge policies that Infinispan provides or you can create a custom implementation of the <code>EntryMergePolicy</code> API.</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<caption class="title">Table 9. Infinispan merge policies</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Merge policy</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Considerations</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NONE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan does not resolve conflicts when merging split clusters. This is the default merge policy.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nodes drop segments for which they are not the primary owner, which can result in data loss.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PREFERRED_ALWAYS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan finds the value that exists on the majority of nodes in the cluster and uses it to resolve conflicts.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan could use stale values to resolve conflicts. Even if an entry is available the majority of nodes, the last update could happen on the minority partition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PREFERRED_NON_NULL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan uses the first non-null value that it finds on the cluster to resolve conflicts.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan could restore deleted entries.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REMOVE_ALL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan removes any conflicting entries from the cache.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Results in loss of any entries that have different values when merging split clusters.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="configuring-custom-merge-policies_partition-handling"><a class="anchor" href="#configuring-custom-merge-policies_partition-handling"></a>7.6. Configuring custom merge policies</h3>
<div class="paragraph">
<p>Configure Infinispan to use custom implementations of the <code>EntryMergePolicy</code> API when handling network partitions.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Implement the <code>EntryMergePolicy</code> API.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">public class CustomMergePolicy implements EntryMergePolicy&lt;String, String&gt; {

   @Override
   public CacheEntry&lt;String, String&gt; merge(CacheEntry&lt;String, String&gt; preferredEntry, List&lt;CacheEntry&lt;String, String&gt;&gt; otherEntries) {
      // Decide which entry resolves the conflict

      return the_solved_CacheEntry;
   }</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy your merge policy implementation to Infinispan Server if you use remote caches.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Package your classes as a JAR file that includes a <code>META-INF/services/org.infinispan.conflict.EntryMergePolicy</code> file that contains the fully qualified class name of your merge policy.</p>
<div class="listingblock">
<div class="content">
<pre># List implementations of EntryMergePolicy with the full qualified class name
org.example.CustomMergePolicy</pre>
</div>
</div>
</li>
<li>
<p>Add the JAR file to the <code>server/lib</code> directory.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use the <code>install</code> command with the Infinispan Command Line Interface (CLI) to download the JAR to the <code>server/lib</code> directory.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Configure cache encoding with the <code>encoding</code> element or <code>encoding()</code> method as appropriate.</p>
<div class="paragraph">
<p>For remote caches, if you use only object metadata for comparison when merging entries then you can use <code>application/x-protostream</code> as the media type. In this case Infinispan returns entries to the <code>EntryMergePolicy</code> as <code>byte[]</code>.</p>
</div>
<div class="paragraph">
<p>If you require the object itself when merging conflicts then you should configure caches with the <code>application/x-java-object</code> media type. In this case you must deploy the relevant ProtoStream marshallers to Infinispan Server so it can perform <code>byte[]</code> to object transformations if clients use Protobuf encoding.</p>
</div>
</li>
<li>
<p>Specify your custom merge policy with the <code>merge-policy</code> attribute or <code>mergePolicy()</code> method as part of the partition handling configuration.</p>
</li>
<li>
<p>Save your changes.</p>
</li>
</ol>
</div>
<h4 id="custom_merge_policy_configuration" class="discrete">Custom merge policy configuration</h4>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache name="mycache"&gt;
   &lt;partition-handling when-split="DENY_READ_WRITES"
                       merge-policy="org.example.CustomMergePolicy"/&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "partition-handling" : {
      "when-split": "DENY_READ_WRITES",
      "merge-policy": "org.example.CustomMergePolicy"
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  partitionHandling:
    whenSplit: DENY_READ_WRITES
    mergePolicy: org.example.CustomMergePolicy</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">ConfigurationBuilder</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.clustering().cacheMode(CacheMode.DIST_SYNC)
       .partitionHandling()
       .whenSplit(PartitionHandling.DENY_READ_WRITES)
       .mergePolicy(new CustomMergePolicy());</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/conflict/EntryMergePolicy.html">org.infinispan.conflict.EntryMergePolicy</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="merging-partitions-manually_partition-handling"><a class="anchor" href="#merging-partitions-manually_partition-handling"></a>7.7. Manually merging partitions in embedded caches</h3>
<div class="paragraph">
<p>Detect and resolve conflicting entries to manually merge embedded caches after network partitions occur.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Retrieve the <code>ConflictManager</code> from the <code>EmbeddedCacheManager</code> to detect and resolve conflicting entries in a cache, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-java" data-lang="java">EmbeddedCacheManager manager = new DefaultCacheManager("example-config.xml");
Cache&lt;Integer, String&gt; cache = manager.getCache("testCache");
ConflictManager&lt;Integer, String&gt; crm = ConflictManagerFactory.get(cache.getAdvancedCache());

// Get all versions of a key
Map&lt;Address, InternalCacheValue&lt;String&gt;&gt; versions = crm.getAllVersions(1);

// Process conflicts stream and perform some operation on the cache
Stream&lt;Map&lt;Address, CacheEntry&lt;Integer, String&gt;&gt;&gt; conflicts = crm.getConflicts();
conflicts.forEach(map -&gt; {
   CacheEntry&lt;Integer, String&gt; entry = map.values().iterator().next();
   Object conflictKey = entry.getKey();
   cache.remove(conflictKey);
});

// Detect and then resolve conflicts using the configured EntryMergePolicy
crm.resolveConflicts();

// Detect and then resolve conflicts using the passed EntryMergePolicy instance
crm.resolveConflicts((preferredEntry, otherEntries) -&gt; preferredEntry);</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Although the <code>ConflictManager::getConflicts</code> stream is processed per entry, the underlying spliterator lazily loads cache entries on a per segment basis.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="security-authorization"><a class="anchor" href="#security-authorization"></a>8. Security authorization with role-based access control</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Role-based access control (RBAC) capabilities use different permissions levels to restrict user interactions with Infinispan.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For information on creating users and configuring authorization specific to remote or embedded caches, see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="../server/server.html#rbac-remote">Configuring user roles and permissions with Infinispan Server</a></p>
</li>
<li>
<p><a href="../embedding/embedding.html#rbac-embedded">Programmatically configuring user roles and permissions</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="default-user-roles_security-authorization"><a class="anchor" href="#default-user-roles_security-authorization"></a>8.1. Infinispan user roles and permissions</h3>
<div class="paragraph">
<p>Infinispan includes several roles that provide users with permissions to access caches and Infinispan resources.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Role</th>
<th class="tableblock halign-left valign-top">Permissions</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>admin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Superuser with all permissions including control of the Cache Manager lifecycle.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deployer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_READ, ALL_WRITE, LISTEN, EXEC, MONITOR, CREATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Can create and delete Infinispan resources in addition to <code>application</code> permissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>application</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_READ, ALL_WRITE, LISTEN, EXEC, MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Has read and write access to Infinispan resources in addition to <code>observer</code> permissions. Can also listen to events and execute server tasks and scripts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>observer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_READ, MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Has read access to Infinispan resources in addition to <code>monitor</code> permissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>monitor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Can view statistics via JMX and the <code>metrics</code> endpoint.</p></td>
</tr>
</tbody>
</table>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/security/AuthorizationPermission.html">org.infinispan.security.AuthorizationPermission Enum</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/">Infinispan configuration schema reference</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="user-permissions_security-authorization"><a class="anchor" href="#user-permissions_security-authorization"></a>8.1.1. Permissions</h4>
<div class="paragraph">
<p>User roles are sets of permissions with different access levels.</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<caption class="title">Table 10. Cache Manager permissions</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONFIGURATION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>defineConfiguration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines new cache configurations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LISTEN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>addListener</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registers listeners against a Cache Manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LIFECYCLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stop</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stops the Cache Manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CREATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>createCache</code>, <code>removeCache</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create and remove container resources  such as caches, counters, schemas, and scripts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getStats</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows access to JMX statistics and the <code>metrics</code> endpoint.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Includes all Cache Manager permissions.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<caption class="title">Table 11. Cache permissions</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">READ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>get</code>, <code>contains</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieves entries from a cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WRITE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>put</code>, <code>putIfAbsent</code>, <code>replace</code>, <code>remove</code>, <code>evict</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Writes, replaces, removes, evicts data in a cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXEC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>distexec</code>, <code>streams</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows code execution against a cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LISTEN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>addListener</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Registers listeners against a cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BULK_READ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keySet</code>, <code>values</code>, <code>entrySet</code>, <code>query</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executes bulk retrieve operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BULK_WRITE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clear</code>, <code>putAll</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executes bulk write operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LIFECYCLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>start</code>, <code>stop</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Starts and stops a cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ADMIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getVersion</code>, <code>addInterceptor*</code>, <code>removeInterceptor</code>, <code>getInterceptorChain</code>, <code>getEvictionManager</code>, <code>getComponentRegistry</code>, <code>getDistributionManager</code>, <code>getAuthorizationManager</code>, <code>evict</code>, <code>getRpcManager</code>, <code>getCacheConfiguration</code>, <code>getCacheManager</code>, <code>getInvocationContextContainer</code>, <code>setAvailability</code>, <code>getDataContainer</code>, <code>getStats</code>, <code>getXAResource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows access to underlying components and internal structures.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MONITOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getStats</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows access to JMX statistics and the <code>metrics</code> endpoint.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Includes all cache permissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_READ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Combines the READ and BULK_READ permissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL_WRITE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Combines the WRITE and BULK_WRITE permissions.</p></td>
</tr>
</tbody>
</table>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/security/package-summary.html">Infinispan Security API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="role-mappers_security-authorization"><a class="anchor" href="#role-mappers_security-authorization"></a>8.1.2. Role and permission mappers</h4>
<div class="paragraph">
<p>Infinispan implements users as a collection of principals.
Principals represent either an individual user identity, such as a username, or a group to which the users belong. Internally, these are implemented with the <code>javax.security.auth.Subject</code> class.</p>
</div>
<div class="paragraph">
<p>To enable authorization, the principals must be mapped to role names, which are then expanded into a set of permissions.</p>
</div>
<div class="paragraph">
<p>Infinispan includes the <code>PrincipalRoleMapper</code> API for associating security principals to roles, and the <code>RolePermissionMapper</code> API for associating roles with specific permissions.</p>
</div>
<div class="paragraph">
<p>Infinispan provides the following role and permission mapper implementations:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Cluster role mapper</dt>
<dd>
<p>Stores principal to role mappings in the cluster registry.</p>
</dd>
<dt class="hdlist1">Cluster permission mapper</dt>
<dd>
<p>Stores role to permission mappings in the cluster registry. Allows you to dynamically modify user roles and permissions.</p>
</dd>
<dt class="hdlist1">Identity role mapper</dt>
<dd>
<p>Uses the principal name as the role name. The type or format of the principal name depends on the source. For example, in an LDAP directory the principal name could be a Distinguished Name (DN).</p>
</dd>
<dt class="hdlist1">Common name role mapper</dt>
<dd>
<p>Uses the Common Name (CN) as the role name. You can use this role mapper with an LDAP directory or with client certificates that contain Distinguished Names (DN); for example <code>cn=managers,ou=people,dc=example,dc=com</code> maps to the <code>managers</code> role.</p>
</dd>
</dl>
</div>
<div class="sect4">
<h5 id="mapping_users_to_roles_and_permissions_in_infinispan"><a class="anchor" href="#mapping_users_to_roles_and_permissions_in_infinispan"></a>Mapping users to roles and permissions in Infinispan</h5>
<div class="paragraph">
<p>Consider the following user retrieved from an LDAP server, as a collection of DNs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CN=myapplication,OU=applications,DC=mycompany
CN=dataprocessors,OU=groups,DC=mycompany
CN=finance,OU=groups,DC=mycompany</pre>
</div>
</div>
<div class="paragraph">
<p>Using the <strong>Common name role mapper</strong>, the user would be mapped to the following roles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dataprocessors
finance</pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan has the following role definitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dataprocessors: ALL_WRITE ALL_READ
finance: LISTEN</pre>
</div>
</div>
<div class="paragraph">
<p>The user would have the following permissions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ALL_WRITE ALL_READ LISTEN</pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/security/package-summary.html">Infinispan Security API</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/security/PrincipalRoleMapper.html">org.infinispan.security.PrincipalRoleMapper</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/security/RolePermissionMapper.html">org.infinispan.security.RolePermissionMapper</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/security/mappers/IdentityRoleMapper.html">org.infinispan.security.mappers.IdentityRoleMapper</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/security/mappers/CommonNameRoleMapper.html">org.infinispan.security.mappers.CommonNameRoleMapper</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-role-mappers_security-authorization"><a class="anchor" href="#configuring-role-mappers_security-authorization"></a>8.1.3. Configuring role mappers</h4>
<div class="paragraph">
<p>Infinispan enables the cluster role mapper and cluster permission mapper by default.
To use a different implementation for role mapping, you must configure the role mappers.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Declare the role mapper as part of the security authorization in the Cache Manager configuration.</p>
</li>
<li>
<p>Save the changes to your configuration.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>With embedded caches you can programmatically configure role and permission mappers with the <code>principalRoleMapper()</code> and <code>rolePermissionMapper()</code> methods.</p>
</div>
<h5 id="role_mapper_configuration" class="discrete">Role mapper configuration</h5>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;cache-container&gt;
  &lt;security&gt;
    &lt;authorization&gt;
      &lt;common-name-role-mapper /&gt;
    &lt;/authorization&gt;
  &lt;/security&gt;
&lt;/cache-container&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "infinispan" : {
    "cache-container" : {
      "security" : {
        "authorization" : {
          "common-name-role-mapper": {}
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">infinispan:
  cacheContainer:
    security:
      authorization:
        commonNameRoleMapper: ~</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/">Infinispan configuration schema reference</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-cache-authorization_security-authorization"><a class="anchor" href="#configuring-cache-authorization_security-authorization"></a>8.2. Configuring caches with security authorization</h3>
<div class="paragraph">
<p>Add security authorization to caches to enforce role-based access control (RBAC).
This requires Infinispan users to have a role with a sufficient level of permission to perform cache operations.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Create Infinispan users and either grant them with roles or assign them to groups.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your Infinispan configuration for editing.</p>
</li>
<li>
<p>Add a <code>security</code> section to the configuration.</p>
</li>
<li>
<p>Specify roles that users must have to perform cache operations with the <code>authorization</code> element.</p>
<div class="paragraph">
<p>You can implicitly add all roles defined in the Cache Manager or explicitly define a subset of roles.</p>
</div>
</li>
<li>
<p>Save the changes to your configuration.</p>
</li>
</ol>
</div>
<h4 id="implicit_role_configuration" class="discrete">Implicit role configuration</h4>
<div class="paragraph">
<p>The following configuration implicitly adds every role defined in the Cache Manager:</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;security&gt;
    &lt;authorization/&gt;
  &lt;/security&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "security": {
      "authorization": {
        "enabled": true
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  security:
    authorization:
      enabled: true</code></pre>
</div>
</div>
<h4 id="explicit_role_configuration" class="discrete">Explicit role configuration</h4>
<div class="paragraph">
<p>The following configuration explicitly adds a subset of roles defined in the Cache Manager.
In this case Infinispan denies cache operations for any users that do not have one of the configured roles.</p>
</div>
<div class="listingblock primary">
<div class="title">XML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;distributed-cache&gt;
  &lt;security&gt;
    &lt;authorization roles="admin supervisor"/&gt;
  &lt;/security&gt;
&lt;/distributed-cache&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-json" data-lang="json">{
  "distributed-cache": {
    "security": {
      "authorization": {
        "enabled": true,
        "roles": ["admin","supervisor"]
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">YAML</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-yaml" data-lang="yaml">distributedCache:
  security:
    authorization:
      enabled: true
      roles: ["admin","supervisor"]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="transactions"><a class="anchor" href="#transactions"></a>9. Configuring transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Data that resides on a distributed system is vulnerable to errors that can arise from temporary network outages, system failures, or just simple human error.
These external factors are uncontrollable but can have serious consequences for quality of your data.
The effects of data corruption range from lower customer satisfaction to costly system reconciliation that results in service unavailability.</p>
</div>
<div class="paragraph">
<p>Infinispan can carry out ACID (atomicity, consistency, isolation, durability) transactions to ensure the cache state is consistent.</p>
</div>
<div class="sect2">
<h3 id="transaction_manager"><a class="anchor" href="#transaction_manager"></a>9.1. Transactions</h3>
<div class="paragraph">
<p>Infinispan can be configured to use and to participate in JTA compliant transactions.</p>
</div>
<div class="paragraph">
<p>Alternatively, if transaction support is disabled, it is equivalent to using autocommit in JDBC calls, where modifications are potentially replicated after every change (if replication is enabled).</p>
</div>
<div class="paragraph">
<p>On every cache operation Infinispan does the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Retrieves the current <a href="https://jakarta.ee/specifications/platform/9/apidocs/javax/transaction/Transaction.html">Transaction</a> associated with the thread</p>
</li>
<li>
<p>If not already done, registers <a href="https://jakarta.ee/specifications/platform/9/apidocs/javax/transaction/xa/XAResource.html">XAResource</a> with the transaction manager to be notified when a transaction commits or is rolled back.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In order to do this, the cache has to be provided with a reference to the environment&#8217;s <a href="https://jakarta.ee/specifications/platform/9/apidocs/javax/transaction/TransactionManager.html">TransactionManager</a>.
This is usually done by configuring the cache with the class name of an implementation of the <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/transaction/lookup/TransactionManagerLookup.html">TransactionManagerLookup</a> interface.
When the cache starts, it will create an instance of this class and invoke its <code>getTransactionManager()</code> method, which returns a reference to the <code>TransactionManager</code>.</p>
</div>
<div class="paragraph">
<p>Infinispan ships with several transaction manager lookup classes:</p>
</div>
<div class="ulist">
<div class="title">Transaction manager lookup implementations</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/transaction/lookup/EmbeddedTransactionManagerLookup.html">EmbeddedTransactionManagerLookup</a>:
This provides with a basic transaction manager which should only be used for embedded mode when no other implementation is available.
This implementation has some severe limitations to do with concurrent transactions and recovery.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/transaction/lookup/JBossStandaloneJTAManagerLookup.html">JBossStandaloneJTAManagerLookup</a>:
If you&#8217;re running Infinispan in a standalone environment, or in JBoss AS 7 and earlier, and WildFly 8, 9, and 10, this should be your default choice for transaction manager.
It&#8217;s a fully fledged transaction manager based on <a href="http://narayana.io/">JBoss Transactions</a> which overcomes all the deficiencies of the <code>EmbeddedTransactionManager</code>.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/transaction/lookup/WildflyTransactionManagerLookup.html">WildflyTransactionManagerLookup</a>:
If you&#8217;re running Infinispan in WildFly 11 or later, this should be your default choice for transaction manager.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/transaction/lookup/GenericTransactionManagerLookup.html">GenericTransactionManagerLookup</a>:
This is a lookup class that locate transaction managers in the most popular Java EE application servers.
If no transaction manager can be found, it defaults on the <code>EmbeddedTransactionManager</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once initialized, the <code>TransactionManager</code> can also be obtained from the <code>Cache</code> itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">//the cache must have a transactionManagerLookupClass defined
Cache cache = cacheManager.getCache();

//equivalent with calling TransactionManagerLookup.getTransactionManager();
TransactionManager tm = cache.getAdvancedCache().getTransactionManager();</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="tx_configuration"><a class="anchor" href="#tx_configuration"></a>9.1.1. Configuring transactions</h4>
<div class="paragraph">
<p>Transactions are configured at cache level.
Below is the configuration that affects a transaction behaviour and a small description of each configuration attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;locking
   isolation="READ_COMMITTED"/&gt;
&lt;transaction
   locking="OPTIMISTIC"
   auto-commit="true"
   complete-timeout="60000"
   mode="NONE"
   notifications="true"
   reaper-interval="30000"
   recovery-cache="__recoveryInfoCacheName__"
   stop-timeout="30000"
   transaction-manager-lookup="org.infinispan.transaction.lookup.GenericTransactionManagerLookup"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ConfigurationBuilder builder = new ConfigurationBuilder();
builder.locking()
    .isolationLevel(IsolationLevel.READ_COMMITTED);
builder.transaction()
    .lockingMode(LockingMode.OPTIMISTIC)
    .autoCommit(true)
    .completedTxTimeout(60000)
    .transactionMode(TransactionMode.NON_TRANSACTIONAL)
    .useSynchronization(false)
    .notifications(true)
    .reaperWakeUpInterval(30000)
    .cacheStopTimeout(30000)
    .transactionManagerLookup(new GenericTransactionManagerLookup())
    .recovery()
    .enabled(false)
    .recoveryInfoCacheName("__recoveryInfoCacheName__");</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>isolation</code> - configures the isolation level. Check section <a href="#tx_isolation_levels">Isolation Levels</a> for more details.
Default is <code>REPEATABLE_READ</code>.</p>
</li>
<li>
<p><code>locking</code> - configures whether the cache uses optimistic or pessimistic locking. Check section <a href="#tx_locking">Transaction Locking</a> for more details.
Default is <code>OPTIMISTIC</code>.</p>
</li>
<li>
<p><code>auto-commit</code> - if enable, the user does not need to start a transaction manually for a single operation. The transaction is automatically started and committed.
Default is <code>true</code>.</p>
</li>
<li>
<p><code>complete-timeout</code> - the duration in milliseconds to keep information about completed transactions. Default is <code>60000</code>.</p>
</li>
<li>
<p><code>mode</code> - configures whether the cache is transactional or not. Default is <code>NONE</code>. The available options are:</p>
<div class="ulist">
<ul>
<li>
<p><code>NONE</code> - non transactional cache</p>
</li>
<li>
<p><code>FULL_XA</code> - XA transactional cache with recovery enabled. Check section <a href="#tx_recovery">Transaction recovery</a> for more details about recovery.</p>
</li>
<li>
<p><code>NON_DURABLE_XA</code> - XA transactional cache with recovery disabled.</p>
</li>
<li>
<p><code>NON_XA</code> - transactional cache with integration via <a href="https://jakarta.ee/specifications/platform/9/apidocs/javax/transaction/Synchronization.html">Synchronization</a> instead of XA.
Check section <a href="#tx_sync_enlist">Enlisting Synchronizations</a> for details.</p>
</li>
<li>
<p><code>BATCH</code>-  transactional cache using batch to group operations. Check section <a href="#tx_batching">Batching</a> for details.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>notifications</code> - enables/disables triggering transactional events in cache listeners. Default is <code>true</code>.</p>
</li>
<li>
<p><code>reaper-interval</code> - the time interval in millisecond at which the thread that cleans up transaction completion information kicks in.
Defaults is <code>30000</code>.</p>
</li>
<li>
<p><code>recovery-cache</code> - configures the cache name to store the recovery information. Check section <a href="#tx_recovery">Transaction recovery</a> for more details about recovery.
Default is <code><em>recoveryInfoCacheName</em></code>.</p>
</li>
<li>
<p><code>stop-timeout</code> - the time in millisecond to wait for ongoing transaction when the cache is stopping. Default is  <code>30000</code>.</p>
</li>
<li>
<p><code>transaction-manager-lookup</code> - configures the fully qualified class name of a class that looks up a reference to a <code>javax.transaction.TransactionManager</code>.
Default is <code>org.infinispan.transaction.lookup.GenericTransactionManagerLookup</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more details on how Two-Phase-Commit (2PC) is implemented in Infinispan and how locks are being acquired see the section below.
More details about the configuration settings are available in <a href="https://docs.jboss.org/infinispan/14.0/configdocs/">Configuration reference</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="tx_isolation_levels"><a class="anchor" href="#tx_isolation_levels"></a>9.1.2. Isolation levels</h4>
<div class="paragraph">
<p>Infinispan offers two isolation levels - <a href="https://en.wikipedia.org/wiki/Isolation_(database_systems)#Read_committed">READ_COMMITTED</a> and <a href="https://en.wikipedia.org/wiki/Isolation_(database_systems)#Repeatable_reads">REPEATABLE_READ</a>.</p>
</div>
<div class="paragraph">
<p>These isolation levels determine when readers see a concurrent write, and are internally implemented using different subclasses of <code>MVCCEntry</code>, which have different behaviour in how state is committed back to the data container.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a more detailed example that should help understand the difference between <code>READ_COMMITTED</code> and <code>REPEATABLE_READ</code> in the context of Infinispan.
With <code>READ_COMMITTED</code>, if between two consecutive read calls on the same key, the key has been updated by another transaction, the second read may return the new updated value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Thread1: tx1.begin()
Thread1: cache.get(k) // returns v
Thread2:                                       tx2.begin()
Thread2:                                       cache.get(k) // returns v
Thread2:                                       cache.put(k, v2)
Thread2:                                       tx2.commit()
Thread1: cache.get(k) // returns v2!
Thread1: tx1.commit()</code></pre>
</div>
</div>
<div class="paragraph">
<p>With <code>REPEATABLE_READ</code>, the final get will still return <code>v</code>.
So, if you&#8217;re going to retrieve the same key multiple times within a transaction, you should use <code>REPEATABLE_READ</code>.</p>
</div>
<div class="paragraph">
<p>However, as read-locks are not acquired even for <code>REPEATABLE_READ</code>, this phenomena can occur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">cache.get("A") // returns 1
cache.get("B") // returns 1

Thread1: tx1.begin()
Thread1: cache.put("A", 2)
Thread1: cache.put("B", 2)
Thread2:                                       tx2.begin()
Thread2:                                       cache.get("A") // returns 1
Thread1: tx1.commit()
Thread2:                                       cache.get("B") // returns 2
Thread2:                                       tx2.commit()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tx_locking"><a class="anchor" href="#tx_locking"></a>9.1.3. Transaction locking</h4>
<div class="sect4">
<h5 id="pessimistic_transactional_cache"><a class="anchor" href="#pessimistic_transactional_cache"></a>Pessimistic transactional cache</h5>
<div class="paragraph">
<p>From a lock acquisition perspective, pessimistic transactions obtain locks on keys at the time the key is written.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A lock request is sent to the primary owner (can be an explicit lock request or an operation)</p>
</li>
<li>
<p>The primary owner tries to acquire the lock:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If it succeed, it sends back a positive reply;</p>
</li>
<li>
<p>Otherwise, a negative reply is sent and the transaction is rollback.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">transactionManager.begin();
cache.put(k1,v1); //k1 is locked.
cache.remove(k2); //k2 is locked when this returns
transactionManager.commit();</code></pre>
</div>
</div>
<div class="paragraph">
<p>When <code>cache.put(k1,v1)</code> returns, <code>k1</code> is locked and no other transaction running anywhere in the cluster can write to it.
Reading <code>k1</code> is still possible.
The lock on <code>k1</code> is released when the transaction completes (commits or rollbacks).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For conditional operations, the validation is performed in the originator.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="optimistic_transactional_cache"><a class="anchor" href="#optimistic_transactional_cache"></a>Optimistic transactional cache</h5>
<div class="paragraph">
<p>With optimistic transactions locks are being acquired at transaction prepare time and are only being held up to the point the transaction commits (or rollbacks).
This is different from the 5.0 default locking model where local locks are being acquire on writes and cluster locks are being acquired during prepare time.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The prepare is sent to all the owners.</p>
</li>
<li>
<p>The primary owners try to acquire the locks needed:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If locking succeeds, it performs the write skew check.</p>
</li>
<li>
<p>If the write skew check succeeds (or is disabled), send a positive reply.</p>
</li>
<li>
<p>Otherwise, a negative reply is sent and the transaction is rolled back.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">transactionManager.begin();
cache.put(k1,v1);
cache.remove(k2);
transactionManager.commit(); //at prepare time, K1 and K2 is locked until committed/rolled back.</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For conditional commands, the validation still happens on the originator.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="what_do_i_need_pessimistic_or_optimistic_transactions"><a class="anchor" href="#what_do_i_need_pessimistic_or_optimistic_transactions"></a>What do I need - pessimistic or optimistic transactions?</h5>
<div class="paragraph">
<p>From a use case perspective, optimistic transactions should be used when there is <em>not</em> a lot of contention between multiple transactions running at the same time.
That is because the optimistic transactions rollback if data has changed between the time it was read and the time it was committed (with write skew check enabled).</p>
</div>
<div class="paragraph">
<p>On the other hand, pessimistic transactions might be a better fit when there is high contention on the keys and transaction rollbacks are less desirable.
Pessimistic transactions are more costly by their nature: each write operation potentially involves a RPC for lock acquisition.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tx_write_skew"><a class="anchor" href="#tx_write_skew"></a>9.1.4. Write Skews</h4>
<div class="paragraph">
<p>Write skews occur when two transactions independently and simultaneously read and write to the same key. The result of a write skew is that both transactions successfully commit updates to the same key but with different values.</p>
</div>
<div class="paragraph">
<p>Infinispan automatically performs write skew checks to ensure data consistency for <code>REPEATABLE_READ</code> isolation levels in optimistic transactions. This allows Infinispan to detect and roll back one of the transactions.</p>
</div>
<div class="paragraph">
<p>When operating in <code>LOCAL</code> mode, write skew checks rely on Java object
references to compare differences, which provides a reliable technique for
checking for write skews.</p>
</div>
<div class="sect4">
<h5 id="forcing_write_locks_on_keys_in_pessimitic_transactions"><a class="anchor" href="#forcing_write_locks_on_keys_in_pessimitic_transactions"></a>Forcing write locks on keys in pessimitic transactions</h5>
<div class="paragraph">
<p>To avoid write skews with pessimistic transactions, lock keys at read-time with <code>Flag.FORCE_WRITE_LOCK</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>In non-transactional caches, <code>Flag.FORCE_WRITE_LOCK</code> does not work. The <code>get()</code> call reads the key value but does not acquire locks remotely.</p>
</li>
<li>
<p>You should use <code>Flag.FORCE_WRITE_LOCK</code> with transactions in which the entity is updated later in the same transaction.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Compare the following code snippets for an example of <code>Flag.FORCE_WRITE_LOCK</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// begin the transaction
if (!cache.getAdvancedCache().lock(key)) {
   // abort the transaction because the key was not locked
} else {
   cache.get(key);
   cache.put(key, value);
   // commit the transaction
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// begin the transaction
try {
   // throws an exception if the key is not locked.
   cache.getAdvancedCache().withFlags(Flag.FORCE_WRITE_LOCK).get(key);
   cache.put(key, value);
} catch (CacheException e) {
   // mark the transaction rollback-only
}
// commit or rollback the transaction</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dealing_with_exceptions"><a class="anchor" href="#dealing_with_exceptions"></a>9.1.5. Dealing with exceptions</h4>
<div class="paragraph">
<p>If a <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/commons/CacheException.html">CacheException</a> (or a subclass of it) is thrown by a cache method within the scope of a JTA transaction, then the transaction is automatically marked for rollback.</p>
</div>
</div>
<div class="sect3">
<h4 id="tx_sync_enlist"><a class="anchor" href="#tx_sync_enlist"></a>9.1.6. Enlisting Synchronizations</h4>
<div class="paragraph">
<p>By default Infinispan registers itself as a first class participant in distributed transactions through <a href="https://jakarta.ee/specifications/platform/9/apidocs/javax/transaction/xa/XAResource.html">XAResource</a>.
There are situations where Infinispan is not required to be a participant in the transaction, but only to be notified by its lifecycle (prepare, complete): e.g. in the case Infinispan is used as a 2nd level cache in Hibernate.</p>
</div>
<div class="paragraph">
<p>Infinispan allows transaction enlistment through <a href="https://jakarta.ee/specifications/platform/9/apidocs/javax/transaction/Synchronization.html">Synchronization</a>.
To enable it just use <code>NON_XA</code> transaction mode.</p>
</div>
<div class="paragraph">
<p><code>Synchronization</code>s have the advantage that they allow <code>TransactionManager</code> to optimize 2PC with a 1PC where only one other resource is enlisted with that transaction (<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html/development_guide/java_transaction_api_jta#about_the_lrco_optimization_for_single_phase_commit_1pc">last resource commit optimization</a>).
E.g. Hibernate second level cache: if Infinispan registers itself with the <code>TransactionManager</code> as a <code>XAResource</code> than at commit time, the <code>TransactionManager</code> sees two <code>XAResource</code> (cache and database) and does not make this optimization.
Having to coordinate between two resources it needs to write the tx log to disk.
On the other hand, registering Infinispan as a <code>Synchronization</code> makes the <code>TransactionManager</code> skip writing the log to the disk (performance improvement).</p>
</div>
</div>
<div class="sect3">
<h4 id="tx_batching"><a class="anchor" href="#tx_batching"></a>9.1.7. Batching</h4>
<div class="paragraph">
<p>Batching allows atomicity and some characteristics of a transaction, but not full-blown JTA or XA capabilities.
Batching is often a lot lighter and cheaper than a full-blown transaction.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Generally speaking, one should use batching API whenever the only participant in the transaction is an Infinispan cluster.
On the other hand, JTA transactions (involving <code>TransactionManager</code>) should be used whenever the transactions involves multiple systems.
E.g. considering the "Hello world!" of transactions: transferring money from one bank account to the other.
If both accounts are stored within Infinispan, then batching can be used.
If one account is in a database and the other is Infinispan, then distributed transactions are required.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You <em>do not</em> have to have a transaction manager defined to use batching.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="api"><a class="anchor" href="#api"></a>API</h5>
<div class="paragraph">
<p>Once you have configured your cache to use batching, you use it by calling <code>startBatch()</code> and <code>endBatch()</code> on <code>Cache</code>. E.g.,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Cache cache = cacheManager.getCache();
// not using a batch
cache.put("key", "value"); // will replicate immediately

// using a batch
cache.startBatch();
cache.put("k1", "value");
cache.put("k2", "value");
cache.put("k2", "value");
cache.endBatch(true); // This will now replicate the modifications since the batch was started.

// a new batch
cache.startBatch();
cache.put("k1", "value");
cache.put("k2", "value");
cache.put("k3", "value");
cache.endBatch(false); // This will "discard" changes made in the batch</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="batching_and_jta"><a class="anchor" href="#batching_and_jta"></a>Batching and JTA</h5>
<div class="paragraph">
<p>Behind the scenes, the batching functionality starts a JTA transaction, and all the invocations in that scope are associated with it.
For this it uses a very simple (e.g. no recovery) internal <code>TransactionManager</code> implementation.
With batching, you get:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locks you acquire during an invocation are held until the batch completes</p>
</li>
<li>
<p>Changes are all replicated around the cluster in a batch as part of the batch completion process. Reduces replication chatter for each update in the batch.</p>
</li>
<li>
<p>If synchronous replication or invalidation are used, a failure in replication/invalidation will cause the batch to roll back.</p>
</li>
<li>
<p>All the transaction related configurations apply for batching as well.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tx_recovery"><a class="anchor" href="#tx_recovery"></a>9.1.8. Transaction recovery</h4>
<div class="paragraph">
<p>Recovery is a feature of XA transactions, which deal with the eventuality of a resource or possibly even the transaction manager failing, and recovering accordingly from such a situation.</p>
</div>
<div class="sect4">
<h5 id="when_to_use_recovery"><a class="anchor" href="#when_to_use_recovery"></a>When to use recovery</h5>
<div class="paragraph">
<p>Consider a distributed transaction in which money is transferred from an account stored in an external database to an account stored in Infinispan.
When <code>TransactionManager.commit()</code> is invoked, both resources prepare successfully (1st phase). During the commit (2nd) phase, the database successfully applies the changes whilst Infinispan fails before receiving the commit request from the transaction manager.
At this point the system is in an inconsistent state: money is taken from the account in the external database but not visible yet in Infinispan (since locks are only released during 2nd phase of a two-phase commit protocol).
Recovery deals with this situation to make sure data in both the database and Infinispan ends up in a consistent state.</p>
</div>
</div>
<div class="sect4">
<h5 id="how_does_it_work"><a class="anchor" href="#how_does_it_work"></a>How does it work</h5>
<div class="paragraph">
<p>Recovery is coordinated by the transaction manager.
The transaction manager works with Infinispan to determine the list of in-doubt transactions that require manual intervention and informs the system administrator (via email, log alerts, etc).
This process is transaction manager specific, but generally requires some configuration on the transaction manager.  </p>
</div>
<div class="paragraph">
<p>Knowing the in-doubt transaction ids, the system administrator can now connect to the Infinispan cluster and replay the commit of transactions or force the rollback.
Infinispan provides JMX tooling for this - this is explained extensively in the <a href="#tx_recovery_reconciliation">Transaction recovery and reconciliation</a> section.</p>
</div>
</div>
<div class="sect4">
<h5 id="configuring_recovery"><a class="anchor" href="#configuring_recovery"></a>Configuring recovery   </h5>
<div class="paragraph">
<p>Recovery is <em>not</em> enabled by default in Infinispan.
If disabled, the <code>TransactionManager</code> won&#8217;t be able to work with Infinispan to determine the in-doubt transactions.
The <a href="#tx_configuration">Transaction configuration</a> section shows how to enable it.</p>
</div>
<div class="paragraph">
<p>NOTE: <code>recovery-cache</code> attribute is not mandatory and it is configured per-cache.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For recovery to work, <code>mode</code> must be set to <code>FULL_XA</code>, since full-blown XA transactions are needed.
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="enable_jmx_support"><a class="anchor" href="#enable_jmx_support"></a>Enable JMX support</h6>
<div class="paragraph">
<p>In order to be able to use JMX for managing recovery JMX support must be explicitly enabled.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="recovery_cache"><a class="anchor" href="#recovery_cache"></a>Recovery cache</h5>
<div class="paragraph">
<p>In order to track in-doubt transactions and be able to reply them, Infinispan caches all transaction state for future use.
This state is held only for in-doubt transaction, being removed for successfully completed transactions after when the commit/rollback phase completed.</p>
</div>
<div class="paragraph">
<p>This in-doubt transaction data is held within a local cache: this allows one to configure swapping this info to disk through cache loader in the case it gets too big.
This cache can be specified through the <code>recovery-cache</code> configuration attribute.
If not specified Infinispan will configure a local cache for you.</p>
</div>
<div class="paragraph">
<p>It is possible (though not mandated) to share same recovery cache between all the Infinispan caches that have recovery enabled.
If the default recovery cache is overridden, then the specified recovery cache must use a <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/transaction/lookup/TransactionManagerLookup.html">TransactionManagerLookup</a> that returns a different transaction manager than the one used by the cache itself.</p>
</div>
</div>
<div class="sect4">
<h5 id="integration_with_the_transaction_manager"><a class="anchor" href="#integration_with_the_transaction_manager"></a>Integration with the transaction manager</h5>
<div class="paragraph">
<p>Even though this is transaction manager specific, generally a transaction manager would need a reference to a <code>XAResource</code> implementation in order to invoke <code>XAResource.recover()</code> on it.
In order to obtain a reference to an Infinispan <code>XAResource</code> following API can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">XAResource xar = cache.getAdvancedCache().getXAResource();</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is a common practice to run the recovery in a different process from the one running the transaction.</p>
</div>
</div>
<div class="sect4">
<h5 id="tx_recovery_reconciliation"><a class="anchor" href="#tx_recovery_reconciliation"></a>Reconciliation</h5>
<div class="paragraph">
<p>The transaction manager informs the system administrator on in-doubt transaction in a proprietary way.
At this stage it is assumed that the system administrator knows transaction&#8217;s XID (a byte array).</p>
</div>
<div class="paragraph">
<p>A normal recovery flow is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>STEP 1</strong>: The system administrator connects to an Infinispan server through JMX, and lists the in doubt transactions.
The image below demonstrates JConsole connecting to an Infinispan node that has an in doubt transaction.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/showInDoubtTx.png" alt="showInDoubtTx">
</div>
<div class="title">Figure 8. Show in-doubt transactions</div>
</div>
<div class="paragraph">
<p>The status of each in-doubt transaction is displayed(in this example " <em>PREPARED</em> ").
There might be multiple elements in the status field, e.g. "PREPARED" and "COMMITTED" in the case the transaction committed on certain nodes but not on all of them.  </p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>STEP 2</strong>: The system administrator visually maps the XID received from the transaction manager to an Infinispan internal id, represented as a number.
This step is needed because the XID, a byte array, cannot conveniently be passed to the JMX tool (e.g. JConsole) and then re-assembled on Infinispan&#8217;s side.</p>
</li>
<li>
<p><strong>STEP 3</strong>: The system administrator forces the transaction&#8217;s commit/rollback through the corresponding jmx operation, based on the internal id.
The image below is obtained by forcing the commit of the transaction based on its internal id.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/forceCommit.png" alt="forceCommit">
</div>
<div class="title">Figure 9. Force commit</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All JMX operations described above can be executed on any node, regardless of where the transaction originated.
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="force_commitrollback_based_on_xid"><a class="anchor" href="#force_commitrollback_based_on_xid"></a>Force commit/rollback based on XID</h6>
<div class="paragraph">
<p>XID-based JMX operations for forcing in-doubt transactions' commit/rollback are available as well: these methods receive byte[] arrays describing the XID instead of the number associated with the transactions (as previously described at step 2).
These can be useful e.g. if one wants to set up an automatic completion job for certain in-doubt transactions.
This process is plugged into transaction manager&#8217;s recovery and has access to the transaction manager&#8217;s XID objects.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="locking"><a class="anchor" href="#locking"></a>10. Configuring locking and concurrency</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan uses multi-versioned concurrency control (MVCC) to improve access to shared data.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allowing concurrent readers and writers</p>
</li>
<li>
<p>Readers and writers do not block one another</p>
</li>
<li>
<p>Write skews can be detected and handled</p>
</li>
<li>
<p>Internal locks can be striped</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="locking-concurrency_locking"><a class="anchor" href="#locking-concurrency_locking"></a>10.1. Locking and concurrency</h3>
<div class="paragraph">
<p>Multi-versioned concurrency control (MVCC) is a concurrency scheme popular with relational databases and other data stores.
MVCC offers many advantages over coarse-grained Java synchronization and even JDK Locks for access to shared data.</p>
</div>
<div class="paragraph">
<p>Infinispan&#8217;s MVCC implementation makes use of minimal locks and synchronizations, leaning heavily towards lock-free techniques such as <a href="http://en.wikipedia.org/wiki/Compare-and-swap">compare-and-swap</a> and lock-free data structures wherever possible, which helps optimize for multi-CPU and multi-core environments.</p>
</div>
<div class="paragraph">
<p>In particular, Infinispan&#8217;s MVCC implementation is heavily optimized for readers.
Reader threads do not acquire explicit locks for entries, and instead directly read the entry in question.</p>
</div>
<div class="paragraph">
<p>Writers, on the other hand, need to acquire a write lock.
This ensures only one concurrent writer per entry, causing concurrent writers to queue up to change an entry.</p>
</div>
<div class="paragraph">
<p>To allow concurrent reads, writers make a copy of the entry they intend to modify, by wrapping the entry in an <code>MVCCEntry</code>.
This copy isolates concurrent readers from seeing partially modified state.
Once a write has completed, <code>MVCCEntry.commit()</code> will flush changes to the data container and subsequent readers will see the changes written.</p>
</div>
<div class="sect3">
<h4 id="clustered_caches_and_locks"><a class="anchor" href="#clustered_caches_and_locks"></a>10.1.1. Clustered caches and locks</h4>
<div class="paragraph">
<p>In Infinispan clusters, primary owner nodes are responsible for locking keys.</p>
</div>
<div class="paragraph">
<p>For non-transactional caches, Infinispan forwards the write operation to the primary owner of the key so it can attempt to lock it.
Infinispan either then forwards the write operation to the other owners or throws an exception if it cannot lock the key.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the operation is conditional and fails on the primary owner, Infinispan does not forward it to the other owners.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For transactional caches, primary owners can lock keys with optimistic and pessimistic locking modes.
Infinispan also supports different isolation levels to control concurrent reads between transactions.</p>
</div>
</div>
<div class="sect3">
<h4 id="the_lockmanager"><a class="anchor" href="#the_lockmanager"></a>10.1.2. The LockManager</h4>
<div class="paragraph">
<p>The <code>LockManager</code> is a component that is responsible for locking an entry for writing.
The <code>LockManager</code> makes use of a <code>LockContainer</code> to locate/hold/create locks.
<code>LockContainers</code> come in two broad flavours, with support for lock striping and with support for one lock per entry.</p>
</div>
</div>
<div class="sect3">
<h4 id="lock_striping"><a class="anchor" href="#lock_striping"></a>10.1.3. Lock striping</h4>
<div class="paragraph">
<p>Lock striping entails the use of a fixed-size, shared collection of locks for the entire cache, with locks being allocated to entries based on the entry&#8217;s key&#8217;s hash code.
Similar to the way the JDK&#8217;s <code>ConcurrentHashMap</code> allocates locks, this allows for a highly scalable, fixed-overhead locking mechanism in exchange for potentially unrelated entries being blocked by the same lock.</p>
</div>
<div class="paragraph">
<p>The alternative is to disable lock striping - which would mean a <em>new</em> lock is created per entry.
This approach <em>may</em> give you greater concurrent throughput, but it will be at the cost of additional memory usage, garbage collection churn, etc.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Default lock striping settings</div>
lock striping is disabled by default, due to potential deadlocks that can happen if locks for different keys end up in the same lock stripe.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The size of the shared lock collection used by lock striping can be tuned using the <code>concurrencyLevel</code> attribute of the <code>&lt;locking /&gt;</code> configuration element.</p>
</div>
<div class="paragraph">
<p><strong>Configuration example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;locking striping="false|true"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">new ConfigurationBuilder().locking().useLockStriping(false|true);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="concurrency_levels"><a class="anchor" href="#concurrency_levels"></a>10.1.4. Concurrency levels</h4>
<div class="paragraph">
<p>In addition to determining the size of the striped lock container, this concurrency level is also used to tune any JDK <code>ConcurrentHashMap</code> based collections where related, such as internal to <code>DataContainer</code>s.
Please refer to the JDK <code>ConcurrentHashMap</code> Javadocs for a detailed discussion of concurrency levels, as this parameter is used in exactly the same way in Infinispan.</p>
</div>
<div class="paragraph">
<p><strong>Configuration example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;locking concurrency-level="32"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">new ConfigurationBuilder().locking().concurrencyLevel(32);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="lock_timeout"><a class="anchor" href="#lock_timeout"></a>10.1.5. Lock timeout</h4>
<div class="paragraph">
<p>The lock timeout specifies the amount of time, in milliseconds, to wait for a contented lock.</p>
</div>
<div class="paragraph">
<p><strong>Configuration example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;locking acquire-timeout="10000"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">new ConfigurationBuilder().locking().lockAcquisitionTimeout(10000);
//alternatively
new ConfigurationBuilder().locking().lockAcquisitionTimeout(10, TimeUnit.SECONDS);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="consistency"><a class="anchor" href="#consistency"></a>10.1.6. Consistency</h4>
<div class="paragraph">
<p>The fact that a single owner is locked (as opposed to all owners being locked) does not break the following consistency guarantee:
if key <code>K</code> is hashed to nodes <code>{A, B}</code> and transaction <code>TX1</code> acquires a lock for <code>K</code>, let&#8217;s say on <code>A</code>.
If another transaction, <code>TX2</code>, is started on <code>B</code> (or any other node) and <code>TX2</code> tries to lock <code>K</code> then it will fail with a timeout as the lock is already held by <code>TX1</code>.
The reason for this is the that the lock for a key <code>K</code> is always, deterministically, acquired on the same node of the cluster, regardless of where the transaction originates.</p>
</div>
</div>
<div class="sect3">
<h4 id="data_versioning"><a class="anchor" href="#data_versioning"></a>10.1.7. Data Versioning</h4>
<div class="paragraph">
<p>Infinispan supports two forms of data versioning: simple and external.
The simple versioning is used in transactional caches for write skew check.</p>
</div>
<div class="paragraph">
<p>The external versioning is used to encapsulate an external source of data versioning within Infinispan, such as when using Infinispan with Hibernate which in turn gets its data version information directly from a database.</p>
</div>
<div class="paragraph">
<p>In this scheme, a mechanism to pass in the version becomes necessary, and overloaded versions of <code>put()</code> and <code>putForExternalRead()</code> will be provided in <code>AdvancedCache</code> to take in an external data version.
This is then stored on the <code>InvocationContext</code> and applied to the entry at commit time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Write skew checks cannot and will not be performed in the case of external data versioning.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clustered-counters"><a class="anchor" href="#clustered-counters"></a>11. Using clustered counters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan provides counters that record the count of objects and are distributed across all nodes in a cluster.</p>
</div>
<div class="sect2">
<h3 id="clustered-counters_clustered-counters"><a class="anchor" href="#clustered-counters_clustered-counters"></a>11.1. Clustered Counters</h3>
<div class="paragraph">
<p><em>Clustered counters</em> are counters which are distributed and shared among all nodes in the Infinispan cluster.
Counters can have different consistency levels: strong and weak.</p>
</div>
<div class="paragraph">
<p>Although a strong/weak consistent counter has separate interfaces, both support updating its value,
return the current value and they provide events when its value is updated.
Details are provided below in this document to help you choose which one fits best your uses-case.</p>
</div>
<div class="sect3">
<h4 id="installation_and_configuration"><a class="anchor" href="#installation_and_configuration"></a>11.1.1. Installation and Configuration</h4>
<div class="paragraph">
<p>In order to start using the counters, you needs to add the dependency in your Maven <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
  &lt;artifactId&gt;infinispan-clustered-counter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The counters can be configured Infinispan configuration file or on-demand via the <code>CounterManager</code> interface detailed
later in this document.
A counters configured in Infinispan configuration file is created at boot time when the <code>EmbeddedCacheManager</code> is starting.
These counters are started eagerly and they are available in all the cluster&#8217;s nodes.</p>
</div>
<div class="listingblock">
<div class="title">configuration.xml</div>
<div class="content">
<pre class="highlight nowrap"><code class="language-xml" data-lang="xml">&lt;infinispan&gt;
    &lt;cache-container ...&gt;
        &lt;!-- To persist counters, you need to configure the global state. --&gt;
        &lt;global-state&gt;
        &lt;!-- Global state configuration goes here. --&gt;
        &lt;/global-state&gt;
        &lt;!-- Cache configuration goes here. --&gt;
         &lt;counters xmlns="urn:infinispan:config:counters:14.0" num-owners="3" reliability="CONSISTENT"&gt;
             &lt;strong-counter name="c1" initial-value="1" storage="PERSISTENT"/&gt;
             &lt;strong-counter name="c2" initial-value="2" storage="VOLATILE" lower-bound="0"/&gt;
             &lt;strong-counter name="c3" initial-value="3" storage="PERSISTENT" upper-bound="5"/&gt;
             &lt;strong-counter name="c4" initial-value="4" storage="VOLATILE" lower-bound="0" upper-bound="10"/&gt;
             &lt;strong-counter name="c5" initial-value="0" upper-bound="100" lifespan="60000"/&gt;
             &lt;weak-counter name="c6" initial-value="5" storage="PERSISTENT" concurrency-level="1"/&gt;
         &lt;/counters&gt;
    &lt;/cache-container&gt;
&lt;/infinispan&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or programmatically, in the <code>GlobalConfigurationBuilder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">GlobalConfigurationBuilder globalConfigurationBuilder = ...;
CounterManagerConfigurationBuilder builder = globalConfigurationBuilder.addModule(CounterManagerConfigurationBuilder.class);
builder.numOwner(3).reliability(Reliability.CONSISTENT);
builder.addStrongCounter().name("c1").initialValue(1).storage(Storage.PERSISTENT);
builder.addStrongCounter().name("c2").initialValue(2).lowerBound(0).storage(Storage.VOLATILE);
builder.addStrongCounter().name("c3").initialValue(3).upperBound(5).storage(Storage.PERSISTENT);
builder.addStrongCounter().name("c4").initialValue(4).lowerBound(0).upperBound(10).storage(Storage.VOLATILE);
builder.addStrongCounter().name("c5").initialValue(0).upperBound(100).lifespan(60000);
builder.addWeakCounter().name("c6").initialValue(5).concurrencyLevel(1).storage(Storage.PERSISTENT);</code></pre>
</div>
</div>
<div class="paragraph">
<p>On other hand, the counters can be configured on-demand, at any time after the <code>EmbeddedCacheManager</code> is initialized.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">CounterManager manager = ...;
manager.defineCounter("c1", CounterConfiguration.builder(CounterType.UNBOUNDED_STRONG).initialValue(1).storage(Storage.PERSISTENT).build());
manager.defineCounter("c2", CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(2).lowerBound(0).storage(Storage.VOLATILE).build());
manager.defineCounter("c3", CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(3).upperBound(5).storage(Storage.PERSISTENT).build());
manager.defineCounter("c4", CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(4).lowerBound(0).upperBound(10).storage(Storage.VOLATILE).build());
manager.defineCounter("c4", CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(0).upperBound(100).lifespan(60000).build());
manager.defineCounter("c6", CounterConfiguration.builder(CounterType.WEAK).initialValue(5).concurrencyLevel(1).storage(Storage.PERSISTENT).build());</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>CounterConfiguration</code> is immutable and can be reused.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The method <code>defineCounter()</code> will return <code>true</code> if the counter is successful configured or <code>false</code> otherwise.
However, if the configuration is invalid, the method will throw a <code>CounterConfigurationException</code>.
To find out if a counter is already defined, use the method <code>isDefined()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">CounterManager manager = ...
if (!manager.isDefined("someCounter")) {
    manager.define("someCounter", ...);
}</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/14.0/configdocs/infinispan-counters-config-14.0.html">Infinispan configuration schema reference</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="list_counter_names"><a class="anchor" href="#list_counter_names"></a>List counter names</h5>
<div class="paragraph">
<p>To list all the counters defined, the method <code>CounterManager.getCounterNames()</code> returns a collection of all counter
names created cluster-wide.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="countermanager_interface"><a class="anchor" href="#countermanager_interface"></a>11.1.2. <code>CounterManager</code> interface</h4>
<div class="paragraph">
<p>The <code>CounterManager</code> interface is the entry point to define, retrieve and remove counters.</p>
</div>
<div class="paragraph">
<div class="title">Embedded deployments</div>
<p><code>CounterManager</code> automatically listen to the creation of <code>EmbeddedCacheManager</code> and proceeds with the registration  of an
instance of it per <code>EmbeddedCacheManager</code>.
It starts the caches needed to store the counter state and configures the default counters.</p>
</div>
<div class="paragraph">
<p>Retrieving the <code>CounterManager</code> is as simple as invoke the
<code>EmbeddedCounterManagerFactory.asCounterManager(EmbeddedCacheManager)</code>
as shown in the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// create or obtain your EmbeddedCacheManager
EmbeddedCacheManager manager = ...;

// retrieve the CounterManager
CounterManager counterManager = EmbeddedCounterManagerFactory.asCounterManager(manager);</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Server deployments</div>
<p>For Hot Rod clients, the <code>CounterManager</code> is registered in the RemoteCacheManager and can be retrieved as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// create or obtain your RemoteCacheManager
RemoteCacheManager manager = ...;

// retrieve the CounterManager
CounterManager counterManager = RemoteCounterManagerFactory.asCounterManager(manager);</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="remove_a_counter_via_countermanager"><a class="anchor" href="#remove_a_counter_via_countermanager"></a>Remove a counter via CounterManager</h5>
<div class="paragraph">
<p>There is a difference between remove a counter via the <code>Strong/WeakCounter</code> interfaces and the <code>CounterManager</code>.
The <code>CounterManager.remove(String)</code> removes the counter value from the cluster and removes all the listeners registered
in the counter in the local counter instance.
In addition, the counter instance is no longer reusable and it may return an invalid results.</p>
</div>
<div class="paragraph">
<p>On the other side, the <code>Strong/WeakCounter</code> removal only removes the counter value.
The instance can still be reused and the listeners still works.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The counter is re-created if it is accessed after a removal.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="the_counter"><a class="anchor" href="#the_counter"></a>11.1.3. The Counter</h4>
<div class="paragraph">
<p>A counter can be strong (<code>StrongCounter</code>) or weakly consistent (<code>WeakCounter</code>) and both is identified by a name.
They have a specific interface but they share some logic, namely, both of them are asynchronous
( a <code>CompletableFuture</code> is returned by each operation), provide an update event and can be reset to its initial value.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t want to use the async API, it is possible to return a synchronous counter via <code>sync()</code> method.
The API is the same but without the <code>CompletableFuture</code> return value.</p>
</div>
<div class="paragraph">
<p>The following methods are common to both interfaces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String getName();
CompletableFuture&lt;Long&gt; getValue();
CompletableFuture&lt;Void&gt; reset();
&lt;T extends CounterListener&gt; Handle&lt;T&gt; addListener(T listener);
CounterConfiguration getConfiguration();
CompletableFuture&lt;Void&gt; remove();
SyncStrongCounter sync(); //SyncWeakCounter for WeakCounter</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getName()</code> returns the counter name (identifier).</p>
</li>
<li>
<p><code>getValue()</code> returns the current counter&#8217;s value.</p>
</li>
<li>
<p><code>reset()</code> allows to reset the counter&#8217;s value to its initial value.</p>
</li>
<li>
<p><code>addListener()</code> register a listener to receive update events.
More details about it in the <a href="#clustered_counters_notify_events">Notification and Events</a> section.</p>
</li>
<li>
<p><code>getConfiguration()</code> returns the configuration used by the counter.</p>
</li>
<li>
<p><code>remove()</code> removes the counter value from the cluster. The instance can still be used and the listeners are kept.</p>
</li>
<li>
<p><code>sync()</code> creates a synchronous counter.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The counter is re-created if it is accessed after a removal.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="the_strongcounter_interface_when_the_consistency_or_bounds_matters"><a class="anchor" href="#the_strongcounter_interface_when_the_consistency_or_bounds_matters"></a>The <code>StrongCounter</code> interface: when the consistency or bounds matters.</h5>
<div class="paragraph">
<p>The strong counter provides uses a single key stored in Infinispan cache to provide the consistency needed.
All the updates are performed under the key lock to updates its values.
On other hand, the reads don&#8217;t acquire any locks and reads the current value.
Also, with this scheme, it allows to bound the counter value and provide atomic operations like compare-and-set/swap.</p>
</div>
<div class="paragraph">
<p>A <code>StrongCounter</code> can be retrieved from the <code>CounterManager</code> by using the <code>getStrongCounter()</code> method.
As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">CounterManager counterManager = ...
StrongCounter aCounter = counterManager.getStrongCounter("my-counter");</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Since every operation will hit a single key, the <code>StrongCounter</code> has a higher contention rate.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>StrongCounter</code> interface adds the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">default CompletableFuture&lt;Long&gt; incrementAndGet() {
   return addAndGet(1L);
}

default CompletableFuture&lt;Long&gt; decrementAndGet() {
   return addAndGet(-1L);
}

CompletableFuture&lt;Long&gt; addAndGet(long delta);

CompletableFuture&lt;Boolean&gt; compareAndSet(long expect, long update);

CompletableFuture&lt;Long&gt; compareAndSwap(long expect, long update);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>incrementAndGet()</code> increments the counter by one and returns the new value.</p>
</li>
<li>
<p><code>decrementAndGet()</code> decrements the counter by one and returns the new value.</p>
</li>
<li>
<p><code>addAndGet()</code> adds a delta to the counter&#8217;s value and returns the new value.</p>
</li>
<li>
<p><code>compareAndSet()</code> and <code>compareAndSwap()</code> atomically set the counter&#8217;s value if the current value is the expected.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A operation is considered completed when the <code>CompletableFuture</code> is completed.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The difference between compare-and-set and compare-and-swap is that the former returns true if the operation succeeds
while the later returns the previous value.
The compare-and-swap is successful if the return value is the same as the expected.
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="bounded_strongcounter"><a class="anchor" href="#bounded_strongcounter"></a>Bounded <code>StrongCounter</code></h6>
<div class="paragraph">
<p>When bounded, all the update method above will throw a <code>CounterOutOfBoundsException</code> when they reached the
lower or upper bound.
The exception has the following methods to check which side bound has been reached:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public boolean isUpperBoundReached();
public boolean isLowerBoundReached();</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="uses_cases"><a class="anchor" href="#uses_cases"></a>Uses cases</h6>
<div class="paragraph">
<p>The strong counter fits better in the following uses cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When counter&#8217;s value is needed after each update (example, cluster-wise ids generator or sequences)</p>
</li>
<li>
<p>When a bounded counter is needed (example, rate limiter)</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="usage_examples"><a class="anchor" href="#usage_examples"></a>Usage Examples</h6>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">StrongCounter counter = counterManager.getStrongCounter("unbounded_counter");

// incrementing the counter
System.out.println("new value is " + counter.incrementAndGet().get());

// decrement the counter's value by 100 using the functional API
counter.addAndGet(-100).thenApply(v -&gt; {
   System.out.println("new value is " + v);
   return null;
}).get();

// alternative, you can do some work while the counter is updated
CompletableFuture&lt;Long&gt; f = counter.addAndGet(10);
// ... do some work ...
System.out.println("new value is " + f.get());

// and then, check the current value
System.out.println("current value is " + counter.getValue().get());

// finally, reset to initial value
counter.reset().get();
System.out.println("current value is " + counter.getValue().get());

// or set to a new value if zero
System.out.println("compare and set succeeded? " + counter.compareAndSet(0, 1));</code></pre>
</div>
</div>
<div class="paragraph">
<p>And below, there is another example using a bounded counter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">StrongCounter counter = counterManager.getStrongCounter("bounded_counter");

// incrementing the counter
try {
    System.out.println("new value is " + counter.addAndGet(100).get());
} catch (ExecutionException e) {
    Throwable cause = e.getCause();
    if (cause instanceof CounterOutOfBoundsException) {
       if (((CounterOutOfBoundsException) cause).isUpperBoundReached()) {
          System.out.println("ops, upper bound reached.");
       } else if (((CounterOutOfBoundsException) cause).isLowerBoundReached()) {
          System.out.println("ops, lower bound reached.");
       }
    }
}

// now using the functional API
counter.addAndGet(-100).handle((v, throwable) -&gt; {
   if (throwable != null) {
      Throwable cause = throwable.getCause();
      if (cause instanceof CounterOutOfBoundsException) {
         if (((CounterOutOfBoundsException) cause).isUpperBoundReached()) {
            System.out.println("ops, upper bound reached.");
         } else if (((CounterOutOfBoundsException) cause).isLowerBoundReached()) {
            System.out.println("ops, lower bound reached.");
         }
      }
      return null;
   }
   System.out.println("new value is " + v);
   return null;
}).get();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compare-and-set vs Compare-and-swap examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">StrongCounter counter = counterManager.getStrongCounter("my-counter");
long oldValue, newValue;
do {
   oldValue = counter.getValue().get();
   newValue = someLogic(oldValue);
} while (!counter.compareAndSet(oldValue, newValue).get());</code></pre>
</div>
</div>
<div class="paragraph">
<p>With compare-and-swap, it saves one invocation counter invocation (<code>counter.getValue()</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">StrongCounter counter = counterManager.getStrongCounter("my-counter");
long oldValue = counter.getValue().get();
long currentValue, newValue;
do {
   currentValue = oldValue;
   newValue = someLogic(oldValue);
} while ((oldValue = counter.compareAndSwap(oldValue, newValue).get()) != currentValue);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use a strong counter as a rate limiter, configure <code>upper-bound</code> and <code>lifespan</code> parameters as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// 5 request per minute
CounterConfiguration configuration = CounterConfiguration.builder(CounterType.BOUNDED_STRONG)
      .upperBound(5)
      .lifespan(60000)
      .build();
counterManager.defineCounter("rate_limiter", configuration);
StrongCounter counter = counterManager.getStrongCounter("rate_limiter");

// on each operation, invoke
try {
   counter.incrementAndGet().get();
   // continue with operation
} catch (InterruptedException e) {
   Thread.currentThread().interrupt();
} catch (ExecutionException e) {
   if (e.getCause() instanceof CounterOutOfBoundsException) {
      // maximum rate. discard operation
      return;
   } else {
      // unexpected error, handling property
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>lifespan</code> parameter is an experimental capability and may be removed in a future version.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="the_weakcounter_interface_when_speed_is_needed"><a class="anchor" href="#the_weakcounter_interface_when_speed_is_needed"></a>The <code>WeakCounter</code> interface: when speed is needed</h5>
<div class="paragraph">
<p>The <code>WeakCounter</code> stores the counter&#8217;s value in multiple keys in Infinispan cache.
The number of keys created is configured by the <code>concurrency-level</code> attribute.
Each key stores a partial state of the counter&#8217;s value and it can be updated concurrently.
It main advantage over the <code>StrongCounter</code> is the lower contention in the cache.
On other hand, the read of its value is more expensive and bounds are not allowed.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The reset operation should be handled with caution.
It is <strong>not</strong> atomic and it produces intermediates values.
These value may be seen by a read operation and by any listener registered.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <code>WeakCounter</code> can be retrieved from the <code>CounterManager</code> by using the <code>getWeakCounter()</code> method.
As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">CounterManager counterManager = ...
StrongCounter aCounter = counterManager.getWeakCounter("my-counter);</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="weak_counter_interface"><a class="anchor" href="#weak_counter_interface"></a>Weak Counter Interface</h6>
<div class="paragraph">
<p>The <code>WeakCounter</code> adds the following methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">default CompletableFuture&lt;Void&gt; increment() {
   return add(1L);
}

default CompletableFuture&lt;Void&gt; decrement() {
   return add(-1L);
}

CompletableFuture&lt;Void&gt; add(long delta);</code></pre>
</div>
</div>
<div class="paragraph">
<p>They are similar to the `StrongCounter&#8217;s methods but they don&#8217;t return the new value.</p>
</div>
</div>
<div class="sect5">
<h6 id="uses_cases_2"><a class="anchor" href="#uses_cases_2"></a>Uses cases</h6>
<div class="paragraph">
<p>The weak counter fits best in uses cases where the result of the update operation is not needed or the counter&#8217;s value
is not required too often.
Collecting statistics is a good example of such an use case.</p>
</div>
</div>
<div class="sect5">
<h6 id="examples"><a class="anchor" href="#examples"></a>Examples</h6>
<div class="paragraph">
<p>Below, there is an example of the weak counter usage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">WeakCounter counter = counterManager.getWeakCounter("my_counter");

// increment the counter and check its result
counter.increment().get();
System.out.println("current value is " + counter.getValue());

CompletableFuture&lt;Void&gt; f = counter.add(-100);
//do some work
f.get(); //wait until finished
System.out.println("current value is " + counter.getValue().get());

//using the functional API
counter.reset().whenComplete((aVoid, throwable) -&gt; System.out.println("Reset done " + (throwable == null ? "successfully" : "unsuccessfully"))).get();
System.out.println("current value is " + counter.getValue().get());</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="clustered_counters_notify_events"><a class="anchor" href="#clustered_counters_notify_events"></a>11.1.4. Notifications and Events</h4>
<div class="paragraph">
<p>Both strong and weak counter supports a listener to receive its updates events.
The listener must implement <code>CounterListener</code> and it can be registered by the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">&lt;T extends CounterListener&gt; Handle&lt;T&gt; addListener(T listener);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>CounterListener</code> has the following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface CounterListener {
   void onUpdate(CounterEvent entry);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Handle</code> object returned has the main goal to remove the <code>CounterListener</code> when it is not longer needed.
Also, it allows to have access to the <code>CounterListener</code> instance that is it handling.
It has the following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface Handle&lt;T extends CounterListener&gt; {
   T getCounterListener();
   void remove();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, the <code>CounterEvent</code> has the previous and current value and state.
It has the following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface CounterEvent {
   long getOldValue();
   State getOldState();
   long getNewValue();
   State getNewState();
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The state is always <code>State.VALID</code> for unbounded strong counter and weak counter.
<code>State.LOWER_BOUND_REACHED</code> and <code>State.UPPER_BOUND_REACHED</code> are only valid for bounded strong counters.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The weak counter <code>reset()</code> operation will trigger multiple notification with intermediate values.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="listeners-notifications"><a class="anchor" href="#listeners-notifications"></a>12. Listeners and notifications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use listeners with Infinispan to get notifications when events occur for the Cache Manager or for caches.</p>
</div>
<div class="sect2">
<h3 id="listeners-and-notifications_listeners-notifications"><a class="anchor" href="#listeners-and-notifications_listeners-notifications"></a>12.1. Listeners and notifications</h3>
<div class="paragraph">
<p>Infinispan offers a listener API, where clients can register for and get notified when events take place.  This annotation-driven API applies to 2 different levels: cache level events and Cache Manager level events.</p>
</div>
<div class="paragraph">
<p>Events trigger a notification which is dispatched to listeners.   Listeners are simple <a href="http://en.wikipedia.org/wiki/Plain_Old_Java_Object">POJO</a>s annotated with <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/notifications/Listener.html">@Listener</a> and registered using the methods defined in the <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/notifications/Listenable.html">Listenable</a> interface.</p>
</div>
<div class="paragraph">
<p>Both Cache and CacheManager implement Listenable, which means you can attach listeners to either a cache or a Cache Manager, to receive either cache-level or Cache Manager-level notifications.</p>
</div>
<div class="paragraph">
<p>For example, the following class defines a listener to print out some information every time a new entry is added to the cache, in a non blocking fashion:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Listener
public class PrintWhenAdded {
  Queue&lt;CacheEntryCreatedEvent&gt; events = new ConcurrentLinkedQueue&lt;&gt;();

  @CacheEntryCreated
  public CompletionStage&lt;Void&gt; print(CacheEntryCreatedEvent event) {
    events.add(event);
    return null;
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more comprehensive examples, please see the <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/notifications/Listener.html">Javadocs for @Listener</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="cache-notifications_listeners-notifications"><a class="anchor" href="#cache-notifications_listeners-notifications"></a>12.2. Cache-level notifications</h3>
<div class="paragraph">
<p>Cache-level events occur on a per-cache basis, and by default are only raised on nodes where the events occur.  Note in a distributed cache these events are only raised on the owners of data being affected.  Examples of cache-level events are entries being added, removed, modified, etc.  These events trigger notifications to listeners registered to a specific cache.</p>
</div>
<div class="paragraph">
<p>Please see the <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for a comprehensive list of all cache-level notifications, and their respective method-level annotations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please refer to the <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for the list of cache-level notifications available in Infinispan.
</td>
</tr>
</table>
</div>
<h4 id="cluster_listeners" class="discrete">Cluster listeners</h4>
<div class="paragraph">
<p>The cluster listeners should be used when it is desirable to listen to the cache events on a single node.</p>
</div>
<div class="paragraph">
<p>To do so all that is required is set to annotate your listener as being clustered.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Listener (clustered = true)
public class MyClusterListener { .... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are some limitations to cluster listeners from a non clustered listener.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A cluster listener can only listen to <code>@CacheEntryModified</code>, <code>@CacheEntryCreated</code>, <code>@CacheEntryRemoved</code> and <code>@CacheEntryExpired</code> events.  Note this means any other type of event will not be listened to for this listener.</p>
</li>
<li>
<p>Only the post event is sent to a cluster listener, the pre event is ignored.</p>
</li>
</ol>
</div>
<h4 id="event_filtering_and_conversion" class="discrete">Event filtering and conversion</h4>
<div class="paragraph">
<p>All applicable events on the node where the listener is installed will be raised to the listener.  It is possible to dynamically filter what events are raised by using a <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/filter/KeyFilter.html">KeyFilter</a> (only allows filtering on keys) or <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventFilter.html">CacheEventFilter</a> (used to filter for keys, old value, old metadata, new value, new metadata, whether command was retried, if the event is before the event (ie. isPre) and also the command type).</p>
</div>
<div class="paragraph">
<p>The example here shows a simple <code>KeyFilter</code> that will only allow events to be raised when an event modified the entry for the key <code>Only Me</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SpecificKeyFilter implements KeyFilter&lt;String&gt; {
    private final String keyToAccept;

    public SpecificKeyFilter(String keyToAccept) {
      if (keyToAccept == null) {
        throw new NullPointerException();
      }
      this.keyToAccept = keyToAccept;
    }

    public boolean accept(String key) {
      return keyToAccept.equals(key);
    }
}

...
cache.addListener(listener, new SpecificKeyFilter("Only Me"));
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be useful when you want to limit what events you receive in a more efficient manner.</p>
</div>
<div class="paragraph">
<p>There is also a <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventConverter.html">CacheEventConverter</a> that can be supplied that allows for converting a value to another before raising the event.  This can be nice to modularize any code that does value conversions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The mentioned filters and converters are especially beneficial when used in conjunction with a Cluster Listener.  This is because the filtering and conversion is done on the node where the event originated and not on the node where event is listened to.  This can provide benefits of not having to replicate events across the cluster (filter) or even have reduced payloads (converter).
</td>
</tr>
</table>
</div>
<h4 id="initial_state_events" class="discrete">Initial State Events</h4>
<div class="paragraph">
<p>When a listener is installed it will only be notified of events after it is fully installed.</p>
</div>
<div class="paragraph">
<p>It may be desirable to get the current state of the cache contents upon first registration of listener by having an event generated of type <code>@CacheEntryCreated</code> for each element in the cache.  Any additionally generated events during this initial phase will be queued until appropriate events have been raised.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This only works for clustered listeners at this time.  <a href="https://issues.jboss.org/browse/ISPN-4608">ISPN-4608</a> covers adding this for non clustered listeners.
</td>
</tr>
</table>
</div>
<h4 id="duplicate_events" class="discrete">Duplicate Events</h4>
<div class="paragraph">
<p>It is possible in a non transactional cache to receive duplicate events.  This is possible when the primary owner of a key goes down while trying to perform a write operation such as a put.</p>
</div>
<div class="paragraph">
<p>Infinispan internally will rectify the put operation by sending it to the new primary owner for the given key automatically, however there are no guarantees in regards to if the write was first replicated to backups.  Thus more than 1 of the following write events (<code>CacheEntryCreatedEvent</code>, <code>CacheEntryModifiedEvent</code> &amp; <code>CacheEntryRemovedEvent</code>) may be sent on a single operation.</p>
</div>
<div class="paragraph">
<p>If more than one event is generated Infinispan will mark the event that it was generated by a retried command to help the user to know when this occurs without having to pay attention to view changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Listener
public class MyRetryListener {
  @CacheEntryModified
  public void entryModified(CacheEntryModifiedEvent event) {
    if (event.isCommandRetried()) {
      // Do something
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also when using a <code>CacheEventFilter</code> or <code>CacheEventConverter</code> the <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/notifications/cachelistener/filter/EventType.html">EventType</a> contains a method <code>isRetry</code> to tell if the event was generated due to retry.</p>
</div>
</div>
<div class="sect2">
<h3 id="cache-manager-notifications_listeners-notifications"><a class="anchor" href="#cache-manager-notifications_listeners-notifications"></a>12.3. Cache Manager notifications</h3>
<div class="paragraph">
<p>Events that occur on a Cache Manager level are cluster-wide and involve events that affect all caches created by a single Cache Manager. Examples of Cache Manager events are nodes joining or leaving a cluster, or caches starting or stopping.</p>
</div>
<div class="paragraph">
<p>See the <a href="https://docs.jboss.org/infinispan/14.0/apidocs/org/infinispan/notifications/cachemanagerlistener/annotation/package-summary.html">org.infinispan.notifications.cachemanagerlistener.annotation package</a> for a comprehensive list of all Cache Manager notifications,  and their respective method-level annotations.</p>
</div>
</div>
<div class="sect2">
<h3 id="event-synchronicity_listeners-notifications"><a class="anchor" href="#event-synchronicity_listeners-notifications"></a>12.4. Synchronicity of events</h3>
<div class="paragraph">
<p>By default, all async notifications are dispatched in the notification thread pool.
Sync notifications will delay the operation from continuing until the listener method completes or the CompletionStage
completes (the former causing the thread to block). Alternatively, you could annotate your listener as <em>asynchronous</em> in
which case the operation will continue immediately, while the notification is completed asynchronously on the notification thread pool.
To do this, simply annotate your listener such:</p>
</div>
<div class="listingblock">
<div class="title">Asynchronous Listener</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Listener (sync = false)
public class MyAsyncListener {
   @CacheEntryCreated
   void listen(CacheEntryCreatedEvent event) { }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Blocking Synchronous Listener</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Listener
public class MySyncListener {
   @CacheEntryCreated
   void listen(CacheEntryCreatedEvent event) { }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Non-Blocking Listener</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Listener
public class MyNonBlockingListener {
   @CacheEntryCreated
   CompletionStage&lt;Void&gt; listen(CacheEntryCreatedEvent event) { }
}</code></pre>
</div>
</div>
<h4 id="asynchronous_thread_pool" class="discrete">Asynchronous thread pool</h4>
<div class="paragraph">
<p>To tune the thread pool used to dispatch such asynchronous notifications, use the <a href="https://docs.jboss.org/infinispan/14.0/configdocs//infinispan-config-14.0.html"><code>&lt;listener-executor /&gt;</code></a> XML element in your configuration file.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-10-02 22:17:47 +0200
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>