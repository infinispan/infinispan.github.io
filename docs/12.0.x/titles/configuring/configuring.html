<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Configuring Infinispan 12.0</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="canonical" href="http://infinispan.org/docs/stable/user_guide/user_guide.html">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css">
<link rel="stylesheet" href="../../css/css.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script>
<script src="../../js/js.js"></script>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Configuring Infinispan 12.0</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#cache_modes">1. Infinispan Caches</a>
<ul class="sectlevel2">
<li><a href="#caches-configuring">1.1. Cache Interface</a></li>
<li><a href="#cache_managers-configuring">1.2. Cache Managers</a></li>
<li><a href="#cache_containers-configuring">1.3. Cache Containers</a></li>
<li><a href="#cache_modes-configuring">1.4. Cache Modes</a>
<ul class="sectlevel3">
<li><a href="#cache_mode_comparison-configuring">1.4.1. Cache Mode Comparison</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#local-configuring">2. Local Caches</a>
<ul class="sectlevel2">
<li><a href="#simple_cache-configuring">2.1. Simple Caches</a></li>
</ul>
</li>
<li><a href="#clustered_caches">3. Clustered Caches</a>
<ul class="sectlevel2">
<li><a href="#invalidation-configuring">3.1. Invalidation Mode</a></li>
<li><a href="#replicated-configuring">3.2. Replicated Caches</a></li>
<li><a href="#distribution-configuring">3.3. Distributed Caches</a>
<ul class="sectlevel3">
<li><a href="#read_consistency">3.3.1. Read consistency</a></li>
<li><a href="#key_ownership">3.3.2. Key Ownership</a>
<ul class="sectlevel4">
<li><a href="#capacity_factors">Capacity Factors</a></li>
</ul>
</li>
<li><a href="#zero_capacity_node">3.3.3. Zero Capacity Node</a></li>
<li><a href="#hashing_configuration">3.3.4. Hashing Configuration</a></li>
<li><a href="#initial_cluster_size">3.3.5. Initial cluster size</a></li>
<li><a href="#l1_caching">3.3.6. L1 Caching</a></li>
<li><a href="#server_hinting">3.3.7. Server Hinting</a>
<ul class="sectlevel4">
<li><a href="#configuration">Configuration</a></li>
</ul>
</li>
<li><a href="#key_affinity_service">3.3.8. Key affinity service</a>
<ul class="sectlevel4">
<li><a href="#api">API</a></li>
<li><a href="#lifecycle">Lifecycle</a></li>
<li><a href="#topology_changes">Topology changes</a></li>
<li><a href="#grouping_api">The Grouping API</a></li>
<li><a href="#how_does_it_work">How does it work?</a></li>
<li><a href="#how_do_i_use_the_grouping_api">How do I use the grouping API?</a></li>
<li><a href="#advanced_interface">Advanced Interface</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scattered-configuring">3.4. Scattered Caches</a></li>
<li><a href="#async_clusters">3.5. Asynchronous Communication with Clustered Caches</a>
<ul class="sectlevel3">
<li><a href="#async-configuring">3.5.1. Asynchronous Communications</a></li>
<li><a href="#async_api-configuring">3.5.2. Asynchronous API</a></li>
<li><a href="#async_return_values-configuring">3.5.3. Return Values in Asynchronous Communication</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cache_configuration">4. Configuring Infinispan Caches</a>
<ul class="sectlevel2">
<li><a href="#declarative-configuring">4.1. Declarative Configuration</a>
<ul class="sectlevel3">
<li><a href="#templates-configuring">4.1.1. Cache Configuration Templates</a></li>
<li><a href="#cache_wildcards-configuring">4.1.2. Cache Configuration Wildcards</a></li>
<li><a href="#cache_xinclude-configuring">4.1.3. Multiple Configuration Files</a></li>
</ul>
</li>
<li><a href="#programmatic_objects-configuring">4.2. Infinispan Configuration API</a></li>
<li><a href="#programmatic-configuring">4.3. Configuring Caches Programmatically</a></li>
<li><a href="#configuring_cache_encoding-configuring">4.4. Configuring Encoding for Infinispan Caches</a>
<ul class="sectlevel3">
<li><a href="#configuring_protobuf_encoding-configuring">4.4.1. Storing Data in Protobuf Format</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#memory">5. Managing Memory</a>
<ul class="sectlevel2">
<li><a href="#evict_expire">5.1. Configuring Eviction and Expiration</a>
<ul class="sectlevel3">
<li><a href="#eviction-config">5.1.1. Eviction</a>
<ul class="sectlevel4">
<li><a href="#configure_eviction_total-config">Configuring the Total Number of Entries for Infinispan Caches</a></li>
<li><a href="#configure_eviction_size-config">Configuring the Maximum Amount of Memory for Infinispan Caches</a></li>
<li><a href="#eviction_example-config">Eviction Examples</a></li>
<li><a href="#custom_class_eviction-config">Custom Classes with Memory-Based Eviction</a></li>
</ul>
</li>
<li><a href="#expiration-config">5.1.2. Expiration</a>
<ul class="sectlevel4">
<li><a href="#how_expiration_works-config">How Expiration Works</a></li>
<li><a href="#expiration_reaper-config">Expiration Reaper</a></li>
<li><a href="#maxidle_expiration-config">Maximum Idle and Clustered Caches</a></li>
<li><a href="#expiration_example-config">Expiration Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#off_heap_memory">5.2. Off-Heap Memory</a>
<ul class="sectlevel3">
<li><a href="#configure_off_heap-config">5.2.1. Using Off-Heap Memory</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#statistics">6. Configuring Statistics, Metrics, and JMX</a>
<ul class="sectlevel2">
<li><a href="#enable_statistics-configure">6.1. Enabling Infinispan Statistics</a></li>
<li><a href="#configure_metrics-configure">6.2. Enabling Infinispan Metrics</a>
<ul class="sectlevel3">
<li><a href="#metrics-configure">6.2.1. Infinispan Metrics</a></li>
</ul>
</li>
<li><a href="#enable_jmx-configure">6.3. Configuring Infinispan to Register JMX MBeans</a>
<ul class="sectlevel3">
<li><a href="#name_cache_managers-configure">6.3.1. Naming Multiple Cache Managers</a></li>
<li><a href="#register_mbeans-configure">6.3.2. Registering MBeans In Custom MBean Servers</a></li>
<li><a href="#jmx_mbeans-configure">6.3.3. Infinispan MBeans</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#configuring_clustering">7. Configuring Infinispan Clustering</a>
<ul class="sectlevel2">
<li><a href="#cluster_transport">7.1. Setting Up Cluster Transport</a>
<ul class="sectlevel3">
<li><a href="#jgroups_getting_started-configuring">7.1.1. Getting Started with Default Stacks</a>
<ul class="sectlevel4">
<li><a href="#preconfigured_jgroups_stacks-configuring">Default JGroups Stacks</a></li>
</ul>
</li>
<li><a href="#jgroups_inline-configuring">7.1.2. Using Inline JGroups Stacks</a></li>
<li><a href="#jgroups_inheritance-configuring">7.1.3. Adjusting and Tuning JGroups Stacks</a>
<ul class="sectlevel4">
<li><a href="#jgroups_stackcombine-configuring">Stack Combine Attribute</a></li>
</ul>
</li>
<li><a href="#jgroups_external-configuring">7.1.4. Using JGroups Stacks in External Files</a></li>
<li><a href="#jgroups_tune_system_props-configuring">7.1.5. Tuning JGroups Stacks with System Properties</a>
<ul class="sectlevel4">
<li><a href="#jgroups_system_props-configuring">System Properties for Default JGroups Stacks</a></li>
</ul>
</li>
<li><a href="#jgroups_jchannels-configuring">7.1.6. Using Custom JChannels</a></li>
<li><a href="#jgroups_ports-configuring">7.1.7. TCP and UDP Ports for Cluster Traffic</a></li>
</ul>
</li>
<li><a href="#cluster_discovery">7.2. Configuring Cluster Discovery</a>
<ul class="sectlevel3">
<li><a href="#tcpping">7.2.1. TCPPING</a></li>
<li><a href="#gossip_router">7.2.2. Gossip Router</a></li>
<li><a href="#dns_ping">7.2.3. DNS_PING</a></li>
<li><a href="#kube_ping">7.2.4. KUBE_PING</a></li>
<li><a href="#native_s3_ping">7.2.5. NATIVE_S3_PING</a></li>
<li><a href="#jdbc_ping">7.2.6. JDBC_PING</a></li>
<li><a href="#azure_ping">7.2.7. AZURE_PING</a></li>
<li><a href="#google2_ping">7.2.8. GOOGLE2_PING</a></li>
</ul>
</li>
<li><a href="#jgroups_encrypt">7.3. Encrypting Cluster Transport</a>
<ul class="sectlevel3">
<li><a href="#jgroups_encryption-cluster_transport">7.3.1. Infinispan Cluster Security</a></li>
<li><a href="#configuring_jgroups_asym_encrypt-cluster_transport">7.3.2. Configuring Cluster Transport with Asymmetric Encryption</a></li>
<li><a href="#configuring_jgroups_sym_encrypt-cluster_transport">7.3.3. Configuring Cluster Transport with Symmetric Encryption</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#persistence">8. Setting Up Persistent Storage</a>
<ul class="sectlevel2">
<li><a href="#cache_stores">8.1. Infinispan Cache Stores</a>
<ul class="sectlevel3">
<li><a href="#configuring_cache_stores-persistence">8.1.1. Configuring Cache Stores</a></li>
<li><a href="#setting_persistent_location-persistence">8.1.2. Setting a Global Persistent Location for File-Based Cache Stores</a></li>
<li><a href="#passivation">8.1.3. Passivation</a>
<ul class="sectlevel4">
<li><a href="#passivation_behavior">Passivation and Cache Stores</a></li>
</ul>
</li>
<li><a href="#cache_loaders_transactional">8.1.4. Cache Loaders and Transactional Caches</a></li>
<li><a href="#segmented_cache_stores">8.1.5. Segmented Cache Stores</a></li>
<li><a href="#file_stores">8.1.6. Filesystem-Based Cache Stores</a></li>
<li><a href="#write_through">8.1.7. Write-Through</a></li>
<li><a href="#write_behind">8.1.8. Write-Behind</a></li>
</ul>
</li>
<li><a href="#cache_store_implementations">8.2. Cache Store Implementations</a>
<ul class="sectlevel3">
<li><a href="#cluster_cache_loader">8.2.1. Cluster Cache Loaders</a></li>
<li><a href="#sfs_cache_store">8.2.2. Single File Cache Stores</a></li>
<li><a href="#jdbc_cache_store">8.2.3. JDBC String-Based Cache Stores</a>
<ul class="sectlevel4">
<li><a href="#jdbc_connection_pooling">Connection Factories</a></li>
<li><a href="#jdbc_cache_store_config">JDBC String-Based Cache Store Configuration</a></li>
</ul>
</li>
<li><a href="#jpa_cache_store">8.2.4. JPA Cache Stores</a>
<ul class="sectlevel4">
<li><a href="#jpa_cache_store_usage_example">JPA Cache Store Usage Example</a></li>
</ul>
</li>
<li><a href="#remote_cache_store">8.2.5. Remote Cache Stores</a></li>
<li><a href="#rocksdb_cache_store">8.2.6. RocksDB Cache Stores</a></li>
<li><a href="#sifs_cache_store">8.2.7. Soft-Index File Stores</a></li>
<li><a href="#creating_stores">8.2.8. Implementing Custom Cache Stores</a>
<ul class="sectlevel4">
<li><a href="#persistent_spi">Infinispan Persistence SPI</a></li>
<li><a href="#create_custom_store">Creating Cache Stores</a></li>
<li><a href="#configure_custom_cache_store">Configuring Infinispan to Use Custom Stores</a></li>
<li><a href="#deploy_custom_cache_store">Deploying Custom Cache Stores</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cache_store_migration">8.3. Migrating Between Cache Stores</a>
<ul class="sectlevel3">
<li><a href="#store_migrator-configure">8.3.1. Cache Store Migrator</a></li>
<li><a href="#get_store_migrator-configure">8.3.2. Getting the Store Migrator</a></li>
<li><a href="#configure_store_migrator-configure">8.3.3. Configuring the Store Migrator</a>
<ul class="sectlevel4">
<li><a href="#store_migrator_properties-configure">Store Migrator Properties</a></li>
</ul>
</li>
<li><a href="#migrating_stores-configure">8.3.4. Migrating Cache Stores</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#partition_handling">9. Setting Up Partition Handling</a>
<ul class="sectlevel2">
<li><a href="#partition_handling-admin">9.1. Partition handling</a>
<ul class="sectlevel3">
<li><a href="#split_brain">9.1.1. Split brain</a>
<ul class="sectlevel4">
<li><a href="#split_strategies">Split Strategies</a>
<ul class="sectlevel5">
<li><a href="#allow_read_writes">ALLOW_READ_WRITES</a></li>
<li><a href="#deny_read_writes">DENY_READ_WRITES</a></li>
<li><a href="#allow_reads">ALLOW_READS</a></li>
</ul>
</li>
<li><a href="#current_limitations">Current limitations</a></li>
</ul>
</li>
<li><a href="#successive_node_failures">9.1.2. Successive nodes stopped</a></li>
<li><a href="#conflict_manager">9.1.3. Conflict Manager</a>
<ul class="sectlevel4">
<li><a href="#detecting_conflicts">Detecting Conflicts</a></li>
<li><a href="#merge_policies">Merge Policies</a></li>
</ul>
</li>
<li><a href="#conflict_manager_usage">9.1.4. Usage</a></li>
<li><a href="#partition_handling_configuration">9.1.5. Configuring partition handling</a>
<ul class="sectlevel4">
<li><a href="#partition_handling_custom_merge_policy">Implement a custom merge policy</a></li>
<li><a href="#deploy_custom_merge_policies_to_a_infinispan_server_instance">Deploy custom merge policies to a Infinispan server instance</a></li>
</ul>
</li>
<li><a href="#partition_handling_monitoring">9.1.6. Monitoring and administration</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="cache_modes"><a class="anchor" href="#cache_modes"></a>1. Infinispan Caches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan caches provide flexible, in-memory data stores that you can configure to suit use cases such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>boosting application performance with high-speed local caches.</p>
</li>
<li>
<p>optimizing databases by decreasing the volume of write operations.</p>
</li>
<li>
<p>providing resiliency and durability for consistent data across clusters.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="caches-configuring"><a class="anchor" href="#caches-configuring"></a>1.1. Cache Interface</h3>
<div class="paragraph">
<p><code>Cache&lt;K,V&gt;</code> is the central interface for Infinispan and extends
<code>java.util.concurrent.ConcurrentMap</code>.</p>
</div>
<div class="paragraph">
<p>Cache entries are highly concurrent data structures in <code>key:value</code> format that
support a wide and configurable range of data types, from simple strings to
much more complex objects.</p>
</div>
</div>
<div class="sect2">
<h3 id="cache_managers-configuring"><a class="anchor" href="#cache_managers-configuring"></a>1.2. Cache Managers</h3>
<div class="paragraph">
<p>Infinispan provides a <code>CacheManager</code> interface that lets you create, modify,
and manage local or clustered caches. Cache Managers are the starting point for
using Infinispan caches.</p>
</div>
<div class="paragraph">
<p>There are two <code>CacheManager</code> implementations:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>EmbeddedCacheManager</code></dt>
<dd>
<p>Entry point for caches when running Infinispan inside the same Java Virtual
Machine (JVM) as the client application, which is also known as Library Mode.</p>
</dd>
<dt class="hdlist1"><code>RemoteCacheManager</code></dt>
<dd>
<p>Entry point for caches when running Infinispan as a remote server in its own
JVM. When it starts running, <code>RemoteCacheManager</code> establishes a persistent TCP connection to a Hot Rod endpoint on a Infinispan server.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Both embedded and remote <code>CacheManager</code> implementations share some methods and
properties. However, semantic differences do exist between
<code>EmbeddedCacheManager</code> and <code>RemoteCacheManager</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="cache_containers-configuring"><a class="anchor" href="#cache_containers-configuring"></a>1.3. Cache Containers</h3>
<div class="paragraph">
<p>Cache containers declare one or more local or clustered caches that a Cache Manager controls.</p>
</div>
<div class="listingblock">
<div class="title">Cache container declaration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clustered</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cache_modes-configuring"><a class="anchor" href="#cache_modes-configuring"></a>1.4. Cache Modes</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan Cache Managers can create and control multiple caches that use
different modes. For example, you can use the same Cache Manager for local
caches, distributes caches, and caches with invalidation mode.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Local Caches</dt>
<dd>
<p>Infinispan runs as a single node and never replicates read or write operations on cache entries.</p>
</dd>
<dt class="hdlist1">Clustered Caches</dt>
<dd>
<p>Infinispan instances running on the same network can automatically discover
each other and form clusters to handle cache operations.</p>
</dd>
<dt class="hdlist1">Invalidation Mode</dt>
<dd>
<p>Rather than replicating cache entries across the cluster, Infinispan evicts
stale data from all nodes whenever operations modify entries in the cache.
Infinispan performs local read operations only.</p>
</dd>
<dt class="hdlist1">Replicated Caches</dt>
<dd>
<p>Infinispan replicates each cache entry on all nodes and performs local read operations only.</p>
</dd>
<dt class="hdlist1">Distributed Caches</dt>
<dd>
<p>Infinispan stores cache entries across a subset of nodes and assigns
entries to fixed owner nodes. Infinispan requests read operations from owner
nodes to ensure it returns the correct value.</p>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Scattered Caches</dt>
<dd>
<p>Infinispan stores cache entries across a subset of nodes. By default
Infinispan assigns a primary owner and a backup owner to each cache entry in
scattered caches. Infinispan assigns primary owners in the same way as with
distributed caches, while backup owners are always the nodes that initiate the
write operations. Infinispan requests read operations from at least one owner
node to ensure it returns the correct value.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="cache_mode_comparison-configuring"><a class="anchor" href="#cache_mode_comparison-configuring"></a>1.4.1. Cache Mode Comparison</h4>
<div class="paragraph">
<p>The cache mode that you should choose depends on the qualities and guarantees you need for your data.</p>
</div>
<div class="paragraph">
<p>The following table summarizes the primary differences between cache modes:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 13.6363%;">
<col style="width: 13.6363%;">
<col style="width: 13.6363%;">
<col style="width: 13.6363%;">
<col style="width: 13.6363%;">
<col style="width: 13.6367%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-center valign-top">Simple</th>
<th class="tableblock halign-center valign-top">Local</th>
<th class="tableblock halign-center valign-top">Invalidation</th>
<th class="tableblock halign-center valign-top">Replicated</th>
<th class="tableblock halign-center valign-top">Distributed</th>
<th class="tableblock halign-center valign-top">Scattered</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clustered</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">No</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">No</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Yes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Yes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Yes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Yes</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read performance</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Highest</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">High</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">High</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">High</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Medium</strong><br>
(owners)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Medium</strong><br>
(primary)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write performance</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Highest</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">High</strong><br>
(local)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Low</strong><br>
(all nodes, no data)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Lowest</strong><br>
(all nodes)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Medium</strong><br>
(owner nodes)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Higher</strong><br>
(single RPC)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Capacity</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Smallest node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Cluster</strong><br>
\$(sum_(i=1)^"nodes""node_capacity")/"owners"\$</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">Cluster</strong><br>
\$(sum_(i=1)^"nodes""node_capacity")/"2"\$</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Availability</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">Single node</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All nodes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Owner nodes</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">Owner nodes</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Features</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="red">No TX, persistence, indexing</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="green">All</strong></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong class="yellow">No TX</strong></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="local-configuring"><a class="anchor" href="#local-configuring"></a>2. Local Caches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While Infinispan is particularly interesting in clustered mode, it also offers a very
capable local mode.
In this mode, it acts as a simple, in-memory data cache similar to a <code>ConcurrentHashMap</code>.</p>
</div>
<div class="paragraph">
<p>But why would one use a local cache rather than a map?
Caches offer a lot of features over and above a simple map, including write-through and
write-behind to a persistent store, eviction of entries to prevent running out of memory,
and expiration.</p>
</div>
<div class="paragraph">
<p>Infinispan&#8217;s <code>Cache</code> interface extends JDK&#8217;s <code>ConcurrentMap</code>&#8201;&#8212;&#8201;making migration from a
map to Infinispan trivial.</p>
</div>
<div class="paragraph">
<p>Infinispan caches also support transactions, either integrating with an existing
transaction manager or running a separate one.
Local caches transactions have two choices:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When to lock?
<strong>Pessimistic locking</strong> locks keys on a write operation or when the user calls
<code>AdvancedCache.lock(keys)</code> explicitly.
<strong>Optimistic locking</strong> only locks keys during the transaction commit, and instead it throws
a <code>WriteSkewCheckException</code> at commit time, if another transaction modified the same keys
after the current transaction read them.</p>
</li>
<li>
<p>Isolation level.
We support <strong>read-committed</strong> and <strong>repeatable read</strong>.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="simple_cache-configuring"><a class="anchor" href="#simple_cache-configuring"></a>2.1. Simple Caches</h3>
<div class="paragraph">
<p>Traditional local caches use the same architecture as clustered caches, i.e. they use the interceptor stack.
That way a lot of the implementation can be reused. However, if the advanced features
are not needed and performance is more important, the interceptor stack can be stripped
away and simple cache can be used.</p>
</div>
<div class="paragraph">
<p>So, which features are stripped away? From the configuration perspective, simple cache does not support:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>transactions and invocation batching</p>
</li>
<li>
<p>persistence (cache stores and loaders)</p>
</li>
<li>
<p>custom interceptors (there&#8217;s no interceptor stack!)</p>
</li>
<li>
<p>indexing</p>
</li>
<li>
<p>transcoding</p>
</li>
<li>
<p>store as binary (which is hardly useful for local caches)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From the API perspective these features throw an exception:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>adding custom interceptors</p>
</li>
<li>
<p>Distributed Executors Framework</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So, what&#8217;s left?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>basic map-like API</p>
</li>
<li>
<p>cache listeners (local ones)</p>
</li>
<li>
<p>expiration</p>
</li>
<li>
<p>eviction</p>
</li>
<li>
<p>security</p>
</li>
<li>
<p>JMX access</p>
</li>
<li>
<p>statistics (though for max performance it is recommended to switch this off using statistics-available=false)</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Declarative configuration</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mySimpleCache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">simple-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- expiration, eviction, security... --&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">Programmatic configuration</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">DefaultCacheManager cm = getCacheManager();
ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder().simpleCache(<span class="predefined-constant">true</span>);
cm.defineConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">mySimpleCache</span><span class="delimiter">&quot;</span></span>, builder.build());
Cache cache = cm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">mySimpleCache</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</dd>
</dl>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Simple cache checks against features it does not support, if you configure it
to use e.g. transactions, configuration validation will throw an exception.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clustered_caches"><a class="anchor" href="#clustered_caches"></a>3. Clustered Caches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clustered caches store data across multiple Infinispan nodes using JGroups
technology as the transport layer to pass data across the network.</p>
</div>
<div class="sect2">
<h3 id="invalidation-configuring"><a class="anchor" href="#invalidation-configuring"></a>3.1. Invalidation Mode</h3>
<div class="paragraph">
<p>You can use Infinispan in invalidation mode to optimize systems that perform
high volumes of read operations. A good example is to use invalidation to
prevent lots of database writes when state changes occur.</p>
</div>
<div class="paragraph">
<p>This cache mode only makes sense if you have another, permanent store for your data such
as a database and are only using Infinispan as an optimization in a read-heavy system,
to prevent hitting the database for every read.
If a cache is configured for invalidation, every time data is changed in a cache, other
caches in the cluster receive a message informing them that their data is now stale and
should be removed from memory and from any local store.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/clustering-invalidation.svg" alt="clustering invalidation">
</div>
<div class="title">Figure 1. Invalidation mode</div>
</div>
<div class="paragraph">
<p>Sometimes the application reads a value from the external store and wants to write it to
the local cache, without removing it from the other nodes.
To do this, it must call <code>Cache.putForExternalRead(key, value)</code> instead of
<code>Cache.put(key, value)</code>.</p>
</div>
<div class="paragraph">
<p>Invalidation mode can be used with a shared cache store.
A write operation will both update the shared store, and it would remove the stale values
from the other nodes' memory.
The benefit of this is twofold: network traffic is minimized as invalidation messages are
very small compared to replicating the entire value, and also other caches in the cluster
look up modified data in a lazy manner, only when needed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Never use invalidation mode with a <strong>local</strong> store.
The invalidation message will not remove entries in the local store, and some
nodes will keep seeing the stale value.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An invalidation cache can also be configured with a special cache loader, <code>ClusterLoader</code>.
When <code>ClusterLoader</code> is enabled, read operations that do not find the key on the local
node will request it from all the other nodes first, and store it in memory locally.
In certain situation it will store stale values, so only use it if you have a high
tolerance for stale values.</p>
</div>
<div class="paragraph">
<p>Invalidation mode can be synchronous or asynchronous.
When synchronous, a write blocks until all nodes in the cluster have evicted the stale
value. When asynchronous, the originator broadcasts invalidation messages but doesn&#8217;t
wait for responses.
That means other nodes still see the stale value for a while after the write completed on
the originator.</p>
</div>
<div class="paragraph">
<p>Transactions can be used to batch the invalidation messages.
Transactions acquire the key lock on the primary owner.
To find more about how primary owners are assigned, please read the
<a href="#key_ownership">Key Ownership</a> section.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With pessimistic locking, each write triggers a lock message, which is
broadcast to all the nodes.
During transaction commit, the originator broadcasts a one-phase prepare message
(optionally fire-and-forget) which invalidates all affected keys and releases the locks.</p>
</li>
<li>
<p>With optimistic locking, the originator broadcasts a prepare message, a commit message,
and an unlock message (optional).
Either the one-phase prepare or the unlock message is fire-and-forget,
and the last message always releases the locks.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="replicated-configuring"><a class="anchor" href="#replicated-configuring"></a>3.2. Replicated Caches</h3>
<div class="paragraph">
<p>Entries written to a replicated cache on any node will be replicated to all other nodes
in the cluster, and can be retrieved locally from any node.
Replicated mode provides a quick and easy way to share state across a cluster,
however replication practically only performs well in small clusters (under 10 nodes),
due to the number of messages needed for a write scaling linearly with the cluster size.
Infinispan can be configured to use UDP multicast, which mitigates this problem to some
degree.</p>
</div>
<div class="paragraph">
<p>Each key has a primary owner, which serializes data container updates in order to
provide consistency.
To find more about how primary owners are assigned, please read the
<a href="#key_ownership">Key Ownership</a> section.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/clustering-replicated.svg" alt="clustering replicated">
</div>
<div class="title">Figure 2. Replicated mode</div>
</div>
<div class="paragraph">
<p>Replicated mode can be synchronous or asynchronous.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Synchronous replication blocks the caller (e.g. on a <code>cache.put(key, value)</code>) until
the modifications have been replicated successfully to all the nodes in the cluster.</p>
</li>
<li>
<p>Asynchronous replication performs replication in the background, and write operations
return immediately.
Asynchronous replication is not recommended, because communication errors, or errors
that happen on remote nodes are not reported to the caller.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If transactions are enabled, write operations are not replicated through the primary
owner.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With pessimistic locking, each write triggers a lock message, which is
broadcast to all the nodes.
During transaction commit, the originator broadcasts a one-phase prepare message and an
unlock message (optional).
Either the one-phase prepare or the unlock message is fire-and-forget.</p>
</li>
<li>
<p>With optimistic locking, the originator broadcasts a prepare message, a commit message,
and an unlock message (optional).
Again, either the one-phase prepare or the unlock message is fire-and-forget.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="distribution-configuring"><a class="anchor" href="#distribution-configuring"></a>3.3. Distributed Caches</h3>
<div class="paragraph">
<p>Distribution tries to keep a fixed number of copies of any entry in the cache,
configured as <code>numOwners</code>.
This allows the cache to scale linearly, storing more data as nodes are added to the
cluster.</p>
</div>
<div class="paragraph">
<p>As nodes join and leave the cluster, there will be times when a key has more or less than
<code>numOwners</code> copies.
In particular, if <code>numOwners</code> nodes leave in quick succession, some entries will be lost,
so we say that a distributed cache tolerates <code>numOwners - 1</code> node failures.</p>
</div>
<div class="paragraph">
<p>The number of copies represents a trade-off between performance and durability of data.
The more copies you maintain, the lower performance will be, but also the lower the risk
of losing data due to server or network failures.
Regardless of how many copies are maintained, distribution still scales linearly, and
this is key to Infinispan&#8217;s scalability.</p>
</div>
<div class="paragraph">
<p>The owners of a key are split into one <strong>primary owner</strong>, which coordinates writes to the
key, and zero or more <strong>backup owners</strong>.
To find more about how primary and backup owners are assigned, please read the
<a href="#key_ownership">Key Ownership</a> section.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/clustering-distributed.svg" alt="clustering distributed">
</div>
<div class="title">Figure 3. Distributed mode</div>
</div>
<div class="paragraph">
<p>A read operation will request the value from the primary owner, but if it doesn&#8217;t respond
in a reasonable amount of time, we request the value from the backup owners as well.
(The <code>infinispan.stagger.delay</code> system property, in milliseconds, controls the delay
between requests.)
A read operation may require <code>0</code> messages if the key is present in the local cache,
or up to <code>2 * numOwners</code> messages if all the owners are slow.</p>
</div>
<div class="paragraph">
<p>A write operation will also result in at most <code>2 * numOwners</code> messages: one message from
the originator to the primary owner, <code>numOwners - 1</code> messages from the primary to the
backups, and the corresponding ACK messages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cache topology changes may cause retries and additional messages, both for reads
and for writes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Just as replicated mode, distributed mode can also be synchronous or asynchronous.
And as in replicated mode, asynchronous replication is not recommended because it can
lose updates.
In addition to losing updates, asynchronous distributed caches can also see a stale value
when a thread writes to a key and then immediately reads the same key.</p>
</div>
<div class="paragraph">
<p>Transactional distributed caches use the same kinds of messages as transactional
replicated caches, except lock/prepare/commit/unlock messages are sent only to the
<strong>affected nodes</strong> (all the nodes that own at least one key affected by the transaction)
instead of being broadcast to all the nodes in the cluster.
As an optimization, if the transaction writes to a single key and the originator is the
primary owner of the key, lock messages are not replicated.</p>
</div>
<div class="sect3">
<h4 id="read_consistency"><a class="anchor" href="#read_consistency"></a>3.3.1. Read consistency</h4>
<div class="paragraph">
<p>Even with synchronous replication, distributed caches are not linearizable.
(For transactional caches, we say they do not support serialization/snapshot isolation.)
We can have one thread doing a single put:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cache.get(k) -&gt; v1
cache.put(k, v2)
cache.get(k) -&gt; v2</code></pre>
</div>
</div>
<div class="paragraph">
<p>But another thread might see the values in a different order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cache.get(k) -&gt; v2
cache.get(k) -&gt; v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reason is that read can return the value from <strong>any</strong> owner, depending on how fast
the primary owner replies.
The write is not atomic across all the owners&#8201;&#8212;&#8201;in fact, the primary commits the update
only after it receives a confirmation from the backup.
While the primary is waiting for the confirmation message from the backup, reads from the
backup will see the new value, but reads from the primary will see the old one.</p>
</div>
</div>
<div class="sect3">
<h4 id="key_ownership"><a class="anchor" href="#key_ownership"></a>3.3.2. Key Ownership</h4>
<div class="paragraph">
<p>Distributed caches split entries into a fixed number of segments and assign
each segment to a list of owner nodes. Replicated caches do the same, with the
exception that every node is an owner.</p>
</div>
<div class="paragraph">
<p>The first node in the list of owners is the <strong>primary owner</strong>. The other nodes in
the list are <strong>backup owners</strong>. When the cache topology changes, because a node
joins or leaves the cluster, the segment ownership table is broadcast to every
node. This allows nodes to locate keys without making multicast requests or
maintaining metadata for each key.</p>
</div>
<div class="paragraph">
<p>The <code>numSegments</code> property configures the number of segments available.
However, the number of segments cannot change unless the cluster is restarted.</p>
</div>
<div class="paragraph">
<p>Likewise the key-to-segment mapping cannot change. Keys must always map to the
same segments regardless of cluster topology changes. It is important that the
key-to-segment mapping evenly distributes the number of segments allocated to each node while minimizing the number of segments that must move when the cluster topology changes.</p>
</div>
<div class="paragraph">
<p>You can customize the key-to-segment mapping by configuring a
<a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/distribution/ch/KeyPartitioner.html">KeyPartitioner</a> or by using the
<a href="#grouping_api">Grouping API</a>.</p>
</div>
<div class="paragraph">
<p>However, Infinispan provides the following implementations:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">SyncConsistentHashFactory</dt>
<dd>
<p>Uses an algorithm based on
<a href="http://en.wikipedia.org/wiki/Consistent_hashing">consistent hashing</a>. Selected by default when server hinting is disabled.</p>
<div class="paragraph">
<p>This implementation always assigns keys to the same nodes in every cache as
long as the cluster is symmetric. In other words, all caches run on all nodes.
This implementation does have some negative points in that the load distribution is slightly uneven. It also moves more segments than strictly necessary on a join or leave.</p>
</div>
</dd>
<dt class="hdlist1">TopologyAwareSyncConsistentHashFactory</dt>
<dd>
<p>Similar to <code>SyncConsistentHashFactory</code>, but adapted for
<a href="#server_hinting">Server Hinting</a>. Selected by default when server hinting is enabled.</p>
</dd>
<dt class="hdlist1">DefaultConsistentHashFactory</dt>
<dd>
<p>Achieves a more even distribution than <code>SyncConsistentHashFactory</code>, but with one
disadvantage. The order in which nodes join the cluster determines which nodes
own which segments. As a result, keys might be assigned to different nodes in
different caches.</p>
<div class="paragraph">
<p>Was the default from version 5.2 to version 8.1 with server hinting disabled.</p>
</div>
</dd>
<dt class="hdlist1">TopologyAwareConsistentHashFactory</dt>
<dd>
<p>Similar to <em>DefaultConsistentHashFactory</em>, but adapted for
<a href="#server_hinting">Server Hinting</a>.</p>
<div class="paragraph">
<p>Was the default from version 5.2 to version 8.1 with server hinting enabled.</p>
</div>
</dd>
<dt class="hdlist1">ReplicatedConsistentHashFactory</dt>
<dd>
<p>Used internally to implement replicated caches. You should never explicitly
select this algorithm in a distributed cache.</p>
</dd>
</dl>
</div>
<div class="sect4">
<h5 id="capacity_factors"><a class="anchor" href="#capacity_factors"></a>Capacity Factors</h5>
<div class="paragraph">
<p>Capacity factors allocate segment-to-node mappings based on resources available
to nodes.</p>
</div>
<div class="paragraph">
<p>To configure capacity factors, you specify any non-negative number and the
Infinispan hashing algorithm assigns each node a load weighted by its
capacity factor (both as a primary owner and as a backup owner).</p>
</div>
<div class="paragraph">
<p>For example, nodeA has 2x the memory available than nodeB in the same
Infinispan cluster. In this case, setting <code>capacityFactor</code> to a value of <code>2</code>
configures Infinispan to allocate 2x the number of segments to nodeA.</p>
</div>
<div class="paragraph">
<p>Setting a capacity factor of <code>0</code> is possible but is recommended only in cases
where nodes are not joined to the cluster long enough to be useful data owners.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zero_capacity_node"><a class="anchor" href="#zero_capacity_node"></a>3.3.3. Zero Capacity Node</h4>
<div class="paragraph">
<p>You might need to configure a whole node where the capacity factor is <code>0</code> for every cache,
user defined caches and internal caches.
When defining a zero capacity node, the node won&#8217;t hold any data.
This is how you declare a zero capacity node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">zero-capacity-node</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> GlobalConfigurationBuilder().zeroCapacityNode(<span class="predefined-constant">true</span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="hashing_configuration"><a class="anchor" href="#hashing_configuration"></a>3.3.4. Hashing Configuration</h4>
<div class="paragraph">
<p>This is how you configure hashing declaratively, via XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">distributedCache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">segments</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">capacity-factor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And this is how you can configure it programmatically, in Java:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering()
      .cacheMode(CacheMode.DIST_SYNC)
      .hash()
         .numOwners(<span class="integer">2</span>)
         .numSegments(<span class="integer">100</span>)
         .capacityFactor(<span class="integer">2</span>)
   .build();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="initial_cluster_size"><a class="anchor" href="#initial_cluster_size"></a>3.3.5. Initial cluster size</h4>
<div class="paragraph">
<p>Infinispan&#8217;s very dynamic nature in handling topology changes (i.e. nodes being added / removed
at runtime) means that, normally, a node doesn&#8217;t wait for the presence of other nodes before
starting. While this is very flexible, it might not be suitable for applications which require
a specific number of nodes to join the cluster before caches are started. For this reason,
you can specify how many nodes should have joined the cluster before proceeding with cache
initialization. To do this, use the <code>initialClusterSize</code> and <code>initialClusterTimeout</code> transport
properties. The declarative XML configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;transport</span> <span class="attribute-name">initial-cluster-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-cluster-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The programmatic Java configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration global = <span class="keyword">new</span> GlobalConfigurationBuilder()
   .transport()
   .initialClusterSize(<span class="integer">4</span>)
   .initialClusterTimeout(<span class="integer">30000</span>, <span class="predefined-type">TimeUnit</span>.MILLISECONDS)
   .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration will wait for <em>4</em> nodes to join the cluster before initialization. If
the initial nodes do not appear within the specified timeout, the cache manager will fail to
start.</p>
</div>
</div>
<div class="sect3">
<h4 id="l1_caching"><a class="anchor" href="#l1_caching"></a>3.3.6. L1 Caching</h4>
<div class="paragraph">
<p>When L1 is enabled, a node will keep the result of remote reads locally for a short
period of time (configurable, 10 minutes by default), and repeated lookups will return
the local L1 value instead of asking the owners again.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/clustering-l1.svg" alt="clustering l1">
</div>
<div class="title">Figure 4. L1 caching</div>
</div>
<div class="paragraph">
<p>L1 caching is not free though.
Enabling it comes at a cost, and this cost is that every entry update must broadcast an
invalidation message to all the nodes.
L1 entries can be evicted just like any other entry when the the cache is configured
with a maximum size.
Enabling L1 will improve performance for repeated reads of non-local keys, but it will
slow down writes and it will increase memory consumption to some degree.</p>
</div>
<div class="paragraph">
<p>Is L1 caching right for you?
The correct approach is to benchmark your application with and without L1 enabled and see
what works best for your access pattern.</p>
</div>
</div>
<div class="sect3">
<h4 id="server_hinting"><a class="anchor" href="#server_hinting"></a>3.3.7. Server Hinting</h4>
<div class="paragraph">
<p>The following topology hints can be specified:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Machine</dt>
<dd>
<p>This is probably the most useful, when multiple JVM instances run on the
same node, or even when multiple virtual machines run on the same physical machine.</p>
</dd>
<dt class="hdlist1">Rack</dt>
<dd>
<p>In larger clusters, nodes located on the same rack are more likely to experience a
hardware or network failure at the same time.</p>
</dd>
<dt class="hdlist1">Site</dt>
<dd>
<p>Some clusters may have nodes in multiple physical locations for extra resilience.
Note that Cross site replication is another alternative for
clusters that need to span two or more data centres.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>All of the above are optional.
When provided, the distribution algorithm will try to spread the ownership of each
segment across as many sites, racks, and machines (in this order) as possible.</p>
</div>
<div class="sect4">
<h5 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h5>
<div class="paragraph">
<p>The hints are configured at transport level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;transport</span>
    <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MyCluster</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">machine</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LinuxServer01</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">rack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Rack01</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">site</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">US-WestCoast</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="key_affinity_service"><a class="anchor" href="#key_affinity_service"></a>3.3.8. Key affinity service</h4>
<div class="paragraph">
<p>In a distributed cache, a key is allocated to a list of nodes with an opaque algorithm.
There is no easy way to reverse the computation and generate a key that maps to a
particular node.
However, we can generate a sequence of (pseudo-)random keys, see what their primary
owner is, and hand them out to the application when it needs a key mapping to a
particular node.</p>
</div>
<div class="sect4">
<h5 id="api"><a class="anchor" href="#api"></a>API</h5>
<div class="paragraph">
<p>Following code snippet depicts how a reference to this service can be obtained and used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// 1. Obtain a reference to a cache</span>
Cache cache = ...
Address address = cache.getCacheManager().getAddress();

<span class="comment">// 2. Create the affinity service</span>
KeyAffinityService keyAffinityService = KeyAffinityServiceFactory.newLocalKeyAffinityService(
      cache,
      <span class="keyword">new</span> RndKeyGenerator(),
      <span class="predefined-type">Executors</span>.newSingleThreadExecutor(),
      <span class="integer">100</span>);

<span class="comment">// 3. Obtain a key for which the local node is the primary owner</span>
<span class="predefined-type">Object</span> localKey = keyAffinityService.getKeyForAddress(address);

<span class="comment">// 4. Insert the key in the cache</span>
cache.put(localKey, <span class="string"><span class="delimiter">&quot;</span><span class="content">yourValue</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service is started at step 2: after this point it uses the supplied <em>Executor</em> to
generate and queue keys.
At step 3, we obtain a key from the service, and at step 4 we use it.</p>
</div>
</div>
<div class="sect4">
<h5 id="lifecycle"><a class="anchor" href="#lifecycle"></a>Lifecycle</h5>
<div class="paragraph">
<p><code>KeyAffinityService</code> extends <code>Lifecycle</code>, which allows stopping and (re)starting it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Lifecycle</span> {
<span class="error"></span><span class="error"></span> <span class="type">void</span> start();
<span class="error"></span><span class="error"></span> <span class="type">void</span> stop();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service is instantiated through <code>KeyAffinityServiceFactory</code>. All the factory methods
have an <code>Executor</code> parameter, that is used for asynchronous key generation (so that it
won&#8217;t happen in the caller&#8217;s thread).
It is the user&#8217;s responsibility to handle the shutdown of this <code>Executor</code>.</p>
</div>
<div class="paragraph">
<p>The <code>KeyAffinityService</code>, once started, needs to be explicitly stopped. This stops the
background key generation and releases other held resources.</p>
</div>
<div class="paragraph">
<p>The only situation in which <code>KeyAffinityService</code> stops by itself is when the cache manager
with which it was registered is shutdown.</p>
</div>
</div>
<div class="sect4">
<h5 id="topology_changes"><a class="anchor" href="#topology_changes"></a>Topology changes</h5>
<div class="paragraph">
<p>When the cache topology changes (i.e. nodes join or leave the cluster), the ownership of
the keys generated by the <code>KeyAffinityService</code> might change.
The key affinity service keep tracks of these topology changes and doesn&#8217;t return keys
that would currently map to a different node, but it won&#8217;t do anything about keys
generated earlier.</p>
</div>
<div class="paragraph">
<p>As such, applications should treat <code>KeyAffinityService</code> purely as an optimization, and
they should not rely on the location of a generated key for correctness.</p>
</div>
<div class="paragraph">
<p>In particular, applications should not rely on keys generated by <code>KeyAffinityService</code>
for the same address to always be located together.
Collocation of keys is only provided by the <a href="#grouping_api">Grouping API</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="grouping_api"><a class="anchor" href="#grouping_api"></a>The Grouping API</h5>
<div class="paragraph">
<p>Complementary to <a href="#key_affinity_service">Key affinity service</a>,
the grouping API allows you to co-locate a group of entries on the same nodes, but without
being able to select the actual nodes.</p>
</div>
</div>
<div class="sect4">
<h5 id="how_does_it_work"><a class="anchor" href="#how_does_it_work"></a>How does it work?</h5>
<div class="paragraph">
<p>By default, the segment of a key is computed using the key&#8217;s <code>hashCode()</code>.
If you use the grouping API, Infinispan will compute the segment of the group and use
that as the segment of the key.
See the <a href="#key_ownership">Key Ownership</a> section for more details on how segments are
then mapped to nodes.</p>
</div>
<div class="paragraph">
<p>When the group API is in use, it is important that every node can still compute the
owners of every key without contacting other nodes.
For this reason, the group cannot be specified manually.
The group can either be intrinsic to the entry (generated by the key class) or extrinsic
(generated by an external function).</p>
</div>
</div>
<div class="sect4">
<h5 id="how_do_i_use_the_grouping_api"><a class="anchor" href="#how_do_i_use_the_grouping_api"></a>How do I use the grouping API?</h5>
<div class="paragraph">
<p>First, you must enable groups. If you are configuring Infinispan programmatically, then call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering().hash().groups().enabled()
   .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, if you are using XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache&gt;</span>
 <span class="tag">&lt;groups</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have control of the key class (you can alter the class definition, it&#8217;s not part of
an unmodifiable library), then we recommend using an intrinsic group.
The intrinsic group is specified by adding the <code>@Group</code> annotation to a method.
Let&#8217;s take a look at an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">User</span> {
   ...
   String office;
   ...

   public <span class="type">int</span> hashCode() {
      <span class="comment">// Defines the hash for the key, normally used to determine location</span>
      ...
   }

   <span class="comment">// Override the location by specifying a group</span>
   <span class="comment">// All keys in the same group end up with the same owners</span>
   <span class="annotation">@Group</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> getOffice() {
      <span class="keyword">return</span> office;
   }
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The group method must return a <code>String</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you don&#8217;t have control over the key class, or the determination of the group is an
orthogonal concern to the key class, we recommend using an extrinsic group.
An extrinsic group is specified by implementing the <code>Grouper</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Grouper</span>&lt;T&gt; {
    <span class="predefined-type">String</span> computeGroup(T key, <span class="predefined-type">String</span> group);

    <span class="predefined-type">Class</span>&lt;T&gt; getKeyType();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If multiple <code>Grouper</code> classes are configured for the same key type, all of them will be
called, receiving the value computed by the previous one.
If the key class also has a <code>@Group</code> annotation, the first <code>Grouper</code> will receive the
group computed by the annotated method.
This allows you even greater control over the group when using an intrinsic group.
Let&#8217;s take a look at an example <code>Grouper</code> implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">KXGrouper</span> <span class="directive">implements</span> Grouper&lt;<span class="predefined-type">String</span>&gt; {

   <span class="comment">// The pattern requires a String key, of length 2, where the first character is</span>
   <span class="comment">// &quot;k&quot; and the second character is a digit. We take that digit, and perform</span>
   <span class="comment">// modular arithmetic on it to assign it to group &quot;0&quot; or group &quot;1&quot;.</span>
   <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">Pattern</span> kPattern = <span class="predefined-type">Pattern</span>.compile(<span class="string"><span class="delimiter">&quot;</span><span class="content">(^k)(&lt;a&gt;</span><span class="char">\\</span><span class="content">d&lt;/a&gt;)$</span><span class="delimiter">&quot;</span></span>);

   <span class="directive">public</span> <span class="predefined-type">String</span> computeGroup(<span class="predefined-type">String</span> key, <span class="predefined-type">String</span> group) {
      <span class="predefined-type">Matcher</span> matcher = kPattern.matcher(key);
      <span class="keyword">if</span> (matcher.matches()) {
         <span class="predefined-type">String</span> g = <span class="predefined-type">Integer</span>.parseInt(matcher.group(<span class="integer">2</span>)) % <span class="integer">2</span> + <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
         <span class="keyword">return</span> g;
      } <span class="keyword">else</span> {
         <span class="keyword">return</span> <span class="predefined-constant">null</span>;
      }
   }

   <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;<span class="predefined-type">String</span>&gt; getKeyType() {
      <span class="keyword">return</span> <span class="predefined-type">String</span>.class;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Grouper</code> implementations must be registered explicitly in the cache configuration.
If you are configuring Infinispan programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering().hash().groups().enabled().addGrouper(<span class="keyword">new</span> KXGrouper())
   .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, if you are using XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache&gt;</span>
   <span class="tag">&lt;groups</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;grouper</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.KXGrouper</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/groups&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="advanced_interface"><a class="anchor" href="#advanced_interface"></a>Advanced Interface</h5>
<div class="paragraph">
<p><code>AdvancedCache</code> has two group-specific methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/AdvancedCache.html#getGroup-java.lang.String-">getGroup(groupName)</a></dt>
<dd>
<p>Retrieves all keys in the cache that belong to a group.</p>
</dd>
<dt class="hdlist1"><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/AdvancedCache.html#removeGroup-java.lang.String-">removeGroup(groupName)</a></dt>
<dd>
<p>Removes all the keys in the cache that belong to a group.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Both methods iterate over the entire data container and store (if present), so they can
be slow when a cache contains lots of small groups.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scattered-configuring"><a class="anchor" href="#scattered-configuring"></a>3.4. Scattered Caches</h3>
<div class="paragraph">
<p>Scattered mode is very similar to Distribution Mode as it allows linear scaling of the cluster.
It allows single node failure by maintaining two copies of the data (as Distribution Mode with numOwners=2).
Unlike Distributed, the location of data is not fixed; while we use the same Consistent Hash algorithm
to locate the primary owner, the backup copy is stored on the node that wrote the data last time.
When the write originates on the primary owner, backup copy is stored on any other node (the exact location
of this copy is not important).</p>
</div>
<div class="paragraph">
<p>This has the advantage of single Remote Procedure Call (RPC) for any write (Distribution Mode requires one or two RPCs), but reads
have to always target the primary owner. That results in faster writes but possibly slower reads, and therefore this
mode is more suitable for write-intensive applications.</p>
</div>
<div class="paragraph">
<p>Storing multiple backup copies also results in slightly higher memory consumption. In order to remove out-of-date
backup copies, invalidation messages are broadcast in the cluster, which generates some overhead. This makes
scattered mode less performant in very big clusters (this behaviour might be optimized in the future).</p>
</div>
<div class="paragraph">
<p>When a node crashes, the primary copy may be lost. Therefore, the cluster has to reconcile the backups
and find out the last written backup copy. This process results in more network traffic during state transfer.</p>
</div>
<div class="paragraph">
<p>Since the writer of data is also a backup, even if we specify machine/rack/site ids on the transport level the cluster
cannot be resilient to more than one failure on the same machine/rack/site.</p>
</div>
<div class="paragraph">
<p>Currently it is not possible to use scattered mode in transactional cache. Asynchronous replication
is not supported either; use asynchronous Cache API instead. Functional commands are not implemented neither
but these are expected to be added soon.</p>
</div>
<div class="paragraph">
<p>The cache is configured in a similar way as the other cache modes, here is an example of declarative configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;scattered-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">scatteredCache</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And this is how you can configure it programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
   .clustering().cacheMode(CacheMode.SCATTERED_SYNC)
   .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Scattered mode is not exposed in the server configuration as the server is usually accessed through the Hot Rod
protocol. The protocol automatically selects primary owner for the writes and therefore the write (in distributed
mode with two owner) requires single RPC inside the cluster, too. Therefore, scattered cache would not bring
the performance benefit.</p>
</div>
</div>
<div class="sect2">
<h3 id="async_clusters"><a class="anchor" href="#async_clusters"></a>3.5. Asynchronous Communication with Clustered Caches</h3>
<div class="sect3">
<h4 id="async-configuring"><a class="anchor" href="#async-configuring"></a>3.5.1. Asynchronous Communications</h4>
<div class="paragraph">
<p>All clustered cache modes can be configured to use asynchronous communications with the
<a href="https://docs.jboss.org/infinispan/12.0/configdocs/"><code>mode="ASYNC"</code></a>
attribute on the <code>&lt;replicated-cache/&gt;</code>, <code>&lt;distributed-cache&gt;</code>, or <code>&lt;invalidation-cache/&gt;</code>
element.</p>
</div>
<div class="paragraph">
<p>With asynchronous communications, the originator node does not receive any
acknowledgement from the other nodes about the status of the operation, so there is no
way to check if it succeeded on other nodes.</p>
</div>
<div class="paragraph">
<p>We do not recommend asynchronous communications in general, as they can cause
inconsistencies in the data, and the results are hard to reason about.
Nevertheless, sometimes speed is more important than consistency, and the option is
available for those cases.</p>
</div>
</div>
<div class="sect3">
<h4 id="async_api-configuring"><a class="anchor" href="#async_api-configuring"></a>3.5.2. Asynchronous API</h4>
<div class="paragraph">
<p>The Asynchronous API allows you to use synchronous communications,
but without blocking the user thread.</p>
</div>
<div class="paragraph">
<p>There is one caveat:
The asynchronous operations do NOT preserve the program order.
If a thread calls <code>cache.putAsync(k, v1); cache.putAsync(k, v2)</code>, the final value of <code>k</code>
may be either <code>v1</code> or <code>v2</code>.
The advantage over using asynchronous communications is that the final value can&#8217;t be
<code>v1</code> on one node and <code>v2</code> on another.</p>
</div>
</div>
<div class="sect3">
<h4 id="async_return_values-configuring"><a class="anchor" href="#async_return_values-configuring"></a>3.5.3. Return Values in Asynchronous Communication</h4>
<div class="paragraph">
<p>Because the <code>Cache</code> interface extends <code>java.util.Map</code>, write methods like
<code>put(key, value)</code> and <code>remove(key)</code> return the previous value by default.</p>
</div>
<div class="paragraph">
<p>In some cases, the return value may not be correct:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When using <code>AdvancedCache.withFlags()</code> with <code>Flag.IGNORE_RETURN_VALUE</code>,
<code>Flag.SKIP_REMOTE_LOOKUP</code>, or <code>Flag.SKIP_CACHE_LOAD</code>.</p>
</li>
<li>
<p>When the cache is configured with <code>unreliable-return-values="true"</code>.</p>
</li>
<li>
<p>When using asynchronous communications.</p>
</li>
<li>
<p>When there are multiple concurrent writes to the same key, and the cache topology
changes.
The topology change will make Infinispan retry the write operations, and a retried
operation&#8217;s return value is not reliable.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Transactional caches return the correct previous value in cases 3 and 4.
However, transactional caches also have a gotcha: in distributed mode, the
read-committed isolation level is implemented as repeatable-read.
That means this example of "double-checked locking" won&#8217;t work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache cache = ...
TransactionManager tm = ...

tm.begin();
<span class="keyword">try</span> {
   <span class="predefined-type">Integer</span> v1 = cache.get(k);
   <span class="comment">// Increment the value</span>
   <span class="predefined-type">Integer</span> v2 = cache.put(k, v1 + <span class="integer">1</span>);
   <span class="keyword">if</span> (Objects.equals(v1, v2) {
      <span class="comment">// success</span>
   } <span class="keyword">else</span> {
      <span class="comment">// retry</span>
   }
} <span class="keyword">finally</span> {
  tm.commit();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The correct way to implement this is to use
<code>cache.getAdvancedCache().withFlags(Flag.FORCE_WRITE_LOCK).get(k)</code>.</p>
</div>
<div class="paragraph">
<p>In caches with optimistic locking, writes can also return stale previous values. Write skew checks can avoid stale previous values.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cache_configuration"><a class="anchor" href="#cache_configuration"></a>4. Configuring Infinispan Caches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan lets you define properties and options for caches both
declaratively and programmatically.</p>
</div>
<div class="paragraph">
<p>Declarative configuration uses XML files that adhere to a Infinispan schema.
Programmatic configuration, on the other hand, uses Infinispan APIs.</p>
</div>
<div class="paragraph">
<p>In most cases, you use declarative configuration as a starting point for cache
definitions. At runtime you can then programmatically configure your caches to
tune settings or specify additional properties. However, Infinispan provides
flexibility so you can choose either declarative, programmatic, or a
combination of the two.</p>
</div>
<div class="sect2">
<h3 id="declarative-configuring"><a class="anchor" href="#declarative-configuring"></a>4.1. Declarative Configuration</h3>
<div class="paragraph">
<p>You configure Infinispan caches by defining properties in <code>infinispan.xml</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows the basic structure of a Infinispan configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tag">&lt;transport</span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">udp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycluster</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="tag">&lt;invalidation-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invalidation</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="5"></i><b>(5)</b>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replicated</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="6"></i><b>(6)</b>
      <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">distributed</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="7"></i><b>(7)</b>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>adds the root element for the Infinispan configuration. The minimum valid configuration is <code>&lt;infinispan /&gt;</code>; however this provides very basic capabilities with no clustering and no cache instances.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>defines properties for all caches within the container and names the default cache.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>defines transport properties for clustered cache modes. In the preceding example, <code>stack="udp"</code> specifies the default JGroups UDP transport stack and names the Infinispan cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>local cache.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>invalidation cache.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>replicated cache.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>distributed cache.</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/">Infinispan 12.0 Configuration Schema</a></p>
</li>
<li>
<p><a href="http://infinispan.org/schemas/infinispan-config-12.0.xsd">infinispan-config-12.0.xsd</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="templates-configuring"><a class="anchor" href="#templates-configuring"></a>4.1.1. Cache Configuration Templates</h4>
<div class="paragraph">
<p>Infinispan lets you define configuration templates that you can apply to
multiple cache definitions or use as the basis for complex configurations.</p>
</div>
<div class="paragraph">
<p>For example, the following configuration contains a configuration template for
local caches:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="tag">&lt;local-cache-configuration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local-template</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
         <span class="tag">&lt;expiration</span> <span class="attribute-name">interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/local-cache-configuration&gt;</span>
      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local-template</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>specifies the "local" cache as the default.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>defines a configuration template named "local-template" that defines an expiration policy for local caches.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>names a local cache instance that uses the configuration template.</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Inheritance with configuration templates</div>
<p>Configuration templates can also inherit from other templates to extend and
override settings.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Configuration template inheritance is hierarchical. For a child configuration
template to inherit from a parent, you must include it after the parent
template.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following is an example of configuration template inheritance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;local-cache-configuration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">base-template</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
         <span class="tag">&lt;expiration</span> <span class="attribute-name">interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/local-cache-configuration&gt;</span>

      <span class="tag">&lt;local-cache-configuration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">extended-template</span><span class="delimiter">&quot;</span></span>
                                 <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">base-template</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
         <span class="tag">&lt;expiration</span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;memory&gt;</span>
            <span class="tag">&lt;object</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/memory&gt;</span>
      <span class="tag">&lt;/local-cache-configuration&gt;</span>

      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">base-template</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local-bounded</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">configuration</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">extended-template</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>defines a configuration template named "base-template" that defines an expiration policy for local caches. In this example, "base-template" is the parent configuration template.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>defines a configuration template named "extended-template" that inherits settings from "base-template", modifies the <code>lifespan</code> attribute for expiration, and adds a <code>memory</code> element to the configuration. In this example, "extended-template" is a child of "base-template".</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>names a local cache that uses the configuration settings in "base-template".</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>names a local cache that uses the configuration settings in "extended-template".</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Configuration template inheritance is additive for elements that have multiple
values, such as <code>property</code>. Resulting child configurations merge values from
parent configurations.</p>
</div>
<div class="paragraph">
<p>For example, <code>&lt;property value_x="foo" /&gt;</code> in a parent configuration merges with
<code>&lt;property value_y="bar" /&gt;</code> in a child configuration to result in <code>&lt;property
value_x="foo" value_y="bar" /&gt;</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cache_wildcards-configuring"><a class="anchor" href="#cache_wildcards-configuring"></a>4.1.2. Cache Configuration Wildcards</h4>
<div class="paragraph">
<p>You can use wildcards to match cache definitions to configuration templates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
    <span class="tag">&lt;cache-container&gt;</span>
        <span class="tag">&lt;local-cache-configuration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">basecache*</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tag">&lt;expiration</span> <span class="attribute-name">interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10500</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">11</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">11</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache-configuration&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">basecache-1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">basecache-2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>uses the <code>*</code> wildcard to match any cache names that start with "basecache".</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>names a local cache "basecache-1" that uses the "basecache*" configuration template.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>names a local cache "basecache-2" that uses the "basecache*" configuration template.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan throws exceptions if cache names match more than one wildcard.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cache_xinclude-configuring"><a class="anchor" href="#cache_xinclude-configuring"></a>4.1.3. Multiple Configuration Files</h4>
<div class="paragraph">
<p>Infinispan supports XML inclusions (XInclude) that allow you to split configuration across multiple files.</p>
</div>
<div class="paragraph">
<p>For example, the following configuration uses an XInclude:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan</span> <span class="attribute-name">xmlns:xi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XInclude</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cache-1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xi:include</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>includes an <code>local.xml</code> file that contains the following cache definition:
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to use a schema for your included fragments, use the <code>infinispan-config-fragment-12.0.xsd</code> schema:</p>
</div>
<div class="listingblock">
<div class="title">include-with-schema.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:12.0 https://infinispan.org/schemas/infinispan-config-fragment-12.0.xsd</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:12.0</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan configurations provides only minimal support for the XInclude
specification. For example, you cannot use the <code>xpointer</code> attribute, the
<code>xi:fallback</code> element, text processing, or content negotiation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="https://www.w3.org/TR/xinclude/">XInclude specification</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="programmatic_objects-configuring"><a class="anchor" href="#programmatic_objects-configuring"></a>4.2. Infinispan Configuration API</h3>
<div class="paragraph">
<p>Configure Infinispan programmatically.</p>
</div>
<div class="paragraph">
<div class="title">Global configuration</div>
<p>Use the <code>GlobalConfiguration</code> class to apply configuration to all caches
under the Cache Manager.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
  .cacheContainer().statistics(<span class="predefined-constant">true</span>) <i class="conum" data-value="1"></i><b>(1)</b>
  .metrics().gauges(<span class="predefined-constant">true</span>).histograms(<span class="predefined-constant">true</span>) <i class="conum" data-value="2"></i><b>(2)</b>
  .jmx().enable() <i class="conum" data-value="3"></i><b>(3)</b>
  .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enables Cache Manager statistics.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Exports statistics through the <code>metrics</code> endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Exports statistics via JMX MBeans.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>References:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/global/GlobalConfiguration.html">org.infinispan.configuration.global.GlobalConfiguration</a>.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/global/package-summary.html">Global Configuration API</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Cache configuration</div>
<p>Use the <code>ConfigurationBuilder</code> class to configure caches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
     builder.clustering() <i class="conum" data-value="1"></i><b>(1)</b>
            .cacheMode(CacheMode.DIST_SYNC) <i class="conum" data-value="2"></i><b>(2)</b>
            .l1().lifespan(<span class="integer">25000L</span>) <i class="conum" data-value="3"></i><b>(3)</b>
            .hash().numOwners(<span class="integer">3</span>) <i class="conum" data-value="4"></i><b>(4)</b>
            .statistics().enable(); <i class="conum" data-value="5"></i><b>(5)</b>
     <span class="predefined-type">Configuration</span> cfg = builder.build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enables cache clustering.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Uses the distributed, synchronous cache mode.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configures maximum lifespan for entries in the L1 cache.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configures three cluster-wide replicas for each cache entry.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Enables cache statistics.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>References:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/cache/ConfigurationBuilder.html">org.infinispan.configuration.cache.ConfigurationBuilder</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="programmatic-configuring"><a class="anchor" href="#programmatic-configuring"></a>4.3. Configuring Caches Programmatically</h3>
<div class="paragraph">
<p>Define cache configurations with the Cache Manager.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The examples in this section use <code>EmbeddedCacheManager</code>, which is a Cache
Manager that runs in the same JVM as the client.</p>
</div>
<div class="paragraph">
<p>To configure caches remotely with HotRod clients, you use <code>RemoteCacheManager</code>.
Refer to the HotRod documentation for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Configure new cache instances</div>
<p>The following example configures a new cache instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-prod.xml</span><span class="delimiter">&quot;</span></span>);
Cache defaultCache = manager.getCache();
<span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().clustering() <i class="conum" data-value="1"></i><b>(1)</b>
  .cacheMode(CacheMode.REPL_SYNC) <i class="conum" data-value="2"></i><b>(2)</b>
  .build();

<span class="predefined-type">String</span> newCacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span>;
manager.defineConfiguration(newCacheName, c); <i class="conum" data-value="3"></i><b>(3)</b>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(newCacheName);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a new Configuration object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies distributed, synchronous cache mode.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Defines a new cache named "replicatedCache" with the Configuration object.</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Create new caches from existing configurations</div>
<p>The following examples create new cache configurations from existing ones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-prod.xml</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Configuration</span> dcc = manager.getDefaultCacheConfiguration(); <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().read(dcc) <i class="conum" data-value="2"></i><b>(2)</b>
  .clustering()
  .cacheMode(CacheMode.DIST_SYNC) <i class="conum" data-value="3"></i><b>(3)</b>
  .l1()
  .lifespan(<span class="integer">60000L</span>) <i class="conum" data-value="4"></i><b>(4)</b>
  .build();
<span class="error"></span>
<span class="predefined-type">String</span> newCacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">distributedWithL1</span><span class="delimiter">&quot;</span></span>;
manager.defineConfiguration(newCacheName, c); <i class="conum" data-value="5"></i><b>(5)</b>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(newCacheName);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Returns the default cache configuration from the Cache Manager. In this example, <code>infinispan-prod.xml</code> defines a replicated cache as the default.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creates a new Configuration object that uses the default cache configuration as a base.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifies distributed, synchronous cache mode.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Adds an L1 lifespan configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Defines a new cache named "distributedWithL1" with the Configuration object.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-prod.xml</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Configuration</span> rc = manager.getCacheConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder().read(rc)
  .clustering()
  .cacheMode(CacheMode.DIST_SYNC)
  .l1()
  .lifespan(<span class="integer">60000L</span>)
  .build();
<span class="error"></span>
<span class="predefined-type">String</span> newCacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">distributedWithL1</span><span class="delimiter">&quot;</span></span>;
manager.defineConfiguration(newCacheName, c);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(newCacheName);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uses a cache configuration named "replicatedCache" as a base.</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/manager/package-summary.html">CacheManager package summary</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/cache/ConfigurationBuilder.html">org.infinispan.configuration.cache.ConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html">org.infinispan.manager.EmbeddedCacheManager</a></p>
</li>
<li>
<p><a href="../hotrod_java/hotrod_java.html">HotRod Java Client Guide</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/client/hotrod/configuration/ConfigurationBuilder.html">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocsorg/infinispan/client/hotrod/RemoteCacheManager.html">org.infinispan.client.hotrod.RemoteCacheManager</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="configuring_cache_encoding-configuring"><a class="anchor" href="#configuring_cache_encoding-configuring"></a>4.4. Configuring Encoding for Infinispan Caches</h3>
<div class="paragraph">
<p>Define the MediaType that Infinispan uses to encode your data when writing and
reading to and from the cache.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you define a MediaType, you specify the format of your data to Infinispan.</p>
</div>
<div class="paragraph">
<p>If you want to use the Infinispan Console, Hot Rod clients, and REST clients
interchangeably, specify the <code>application/x-protostream</code> MediaType so
Infinispan encodes data in Protobuf format.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Specify a MediaType for key and values in your Infinispan cache configuration.</p>
<div class="ulist">
<ul>
<li>
<p>Declaratively: Set the <code>encoding</code> attribute.</p>
</li>
<li>
<p>Programmatically: Use the <code>encoding()</code> method.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Declarative examples</div>
<ul>
<li>
<p>Use the same encoding for keys and values:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache&gt;</span>
  <span class="tag">&lt;encoding</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Use a different encoding for keys and values:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xml; charset=UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/cache&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Programmatic examples</div>
<ul>
<li>
<p>Use the same encoding for keys and values:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();

cfg
  .encoding()
    .mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span>)
  .build());</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Use a different encoding for keys and values:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();

cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>);
cfg.encoding().value().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="configuring_protobuf_encoding-configuring"><a class="anchor" href="#configuring_protobuf_encoding-configuring"></a>4.4.1. Storing Data in Protobuf Format</h4>
<div class="paragraph">
<p>Storing data in the cache as Protobuf encoded entries provides a platform
independent configuration that enables you to perform cache operations from any
client.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you configure indexing for Infinispan Search, Infinispan automatically
stores keys and values with the <code>application/x-protostream</code> media type.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify <code>application/x-protostream</code> as the MediaType for keys and values as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Configure your clients.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Hot Rod clients must register Protocol Buffers schema definitions that describe
entities and client marshallers.</p>
</div>
<div class="paragraph">
<p>Infinispan converts between <code>application/x-protostream</code> and <code>application/json</code>
so REST clients only need to send the following headers to read and write JSON
formatted data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Accept: application/json</code> for read operations.</p>
</li>
<li>
<p><code>Content-Type: application/json</code> for write operations.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="../developing/developing.html#storage_formats_client_interop-data">Storage Formats and Client Interoperability</a></p>
</li>
<li>
<p><a href="../developing/developing.html#protostream_cm_config">Using the ProtoStream Marshaller</a></p>
</li>
<li>
<p><a href="../developing/developing.html#">Marshalling Custom Java Objects with ProtoStream</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="memory"><a class="anchor" href="#memory"></a>5. Managing Memory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Configure the data container where Infinispan stores entries. Specify the
encoding for cache entries, store data in off-heap memory, and use eviction or
expiration policies to keep only active entries in memory.</p>
</div>
<div class="sect2">
<h3 id="evict_expire"><a class="anchor" href="#evict_expire"></a>5.1. Configuring Eviction and Expiration</h3>
<div class="paragraph">
<p>Eviction and expiration are two strategies for cleaning the data container by
removing old, unused entries. Although eviction and expiration are similar,
they have some important differences.</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-check-square-o"></i> Eviction lets Infinispan control the size of the data container by removing entries when the container becomes larger than a configured threshold.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Expiration limits the amount of time entries can exist. Infinispan uses
a scheduler to periodically remove expired entries. Entries that are expired
but not yet removed are immediately removed on access; in this case <code>get()</code>
calls for expired entries return "null" values.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Eviction is local to Infinispan nodes.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Expiration takes place across Infinispan clusters.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> You can use eviction and expiration together or independently of each other.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> You can configure eviction and expiration declaratively in <code>infinispan.xml</code> to apply cache-wide defaults for entries.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> You can explicitly define expiration settings for specific entries but you cannot define eviction on a per-entry basis.</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> You can manually evict entries and manually trigger expiration.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="eviction-config"><a class="anchor" href="#eviction-config"></a>5.1.1. Eviction</h4>
<div class="paragraph">
<p>Eviction lets you control the size of the data container by removing entries
from memory. Eviction drops one entry from the data container at a time and is
local to the node on which it occurs.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Eviction removes entries from memory but not from persistent cache stores. To
ensure that entries remain available after Infinispan evicts them, and to
prevent inconsistencies with your data, you should configure a persistent cache
store.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Infinispan eviction relies on two configurations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maximum size of the data container.</p>
</li>
<li>
<p>Strategy for removing entries.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Data container size</div>
<p>Infinispan lets you store entries either in the Java heap or in native memory
(off-heap) and set a maximum size for the data container.</p>
</div>
<div class="paragraph">
<p>You configure the maximum size of the data container in one of two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Total number of entries (<code>max-count</code>).</p>
</li>
<li>
<p>Maximum amount of memory (<code>max-size</code>).</p>
<div class="paragraph">
<p>To perform eviction based on the amount of memory, you define a maximum size in
bytes. For this reason, you must encode entries with a binary storage format
such as <code>application/x-protostream</code>.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Evicting cache entries</div>
<p>When you configure <code>memory</code>, Infinispan approximates the current memory usage
of the data container. When entries are added or modified, Infinispan compares
the current memory usage of the data container to the maximum size. If the size
exceeds the maximum, Infinispan performs eviction.</p>
</div>
<div class="paragraph">
<p>Eviction happens immediately in the thread that adds an entry that exceeds the
maximum size.</p>
</div>
<div class="paragraph">
<p>Consider the following configuration as an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;memory max-count="50"/&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the cache can have a total of 50 entries. After the cache reaches
the total number of entries, write operations trigger Infinispan to perform
eviction.</p>
</div>
<div class="paragraph">
<div class="title">Eviction strategies</div>
<p>Strategies control how Infinispan performs eviction. You can either perform
eviction manually or configure Infinispan to do one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Remove old entries to make space for new ones.</p>
</li>
<li>
<p>Throw <code>ContainerFullException</code> and prevent new entries from being created.</p>
<div class="paragraph">
<p>The exception eviction strategy works only with transactional caches that use 2
phase commits; not with 1 phase commits or synchronization optimizations.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan includes the Caffeine caching library that implements a variation
of the Least Frequently Used (LFU) cache replacement algorithm known as
TinyLFU. For off-heap storage, Infinispan uses a custom implementation of the
Least Recently Used (LRU) algorithm.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">References</div>
<ul>
<li>
<p><a href="https://github.com/ben-manes/caffeine">Caffeine</a></p>
</li>
<li>
<p><a href="#persistence">Setting Up Persistent Storage</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="configure_eviction_total-config"><a class="anchor" href="#configure_eviction_total-config"></a>Configuring the Total Number of Entries for Infinispan Caches</h5>
<div class="paragraph">
<p>Limit the size of the data container for cache entries to a total number of
entries.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure your Infinispan cache encoding with an appropriate storage format.</p>
</li>
<li>
<p>Specify the total number of entries that caches can contain before
Infinispan performs eviction.</p>
<div class="ulist">
<ul>
<li>
<p>Declaratively: Set the <code>max-count</code> attribute.</p>
</li>
<li>
<p>Programmatically: Call the <code>maxCount()</code> method.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Configure an eviction strategy to control how Infinispan removes entries.</p>
<div class="ulist">
<ul>
<li>
<p>Declaratively: Set the <code>when-full</code> attribute.</p>
</li>
<li>
<p>Programmatically: Call the <code>whenFull()</code> method.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Declarative example</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">maximum_count</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;encoding</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;memory</span> <span class="attribute-name">max-count</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">when-full</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REMOVE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatic example</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();

cfg
  .encoding()
    .mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span>)
  .memory()
    .maxCount(<span class="integer">500</span>)
    .whenFull(EvictionStrategy.REMOVE)
  .build());</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/">Infinispan Configuration Schema Reference</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/cache/MemoryConfigurationBuilder.html">org.infinispan.configuration.cache.MemoryConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="configure_eviction_size-config"><a class="anchor" href="#configure_eviction_size-config"></a>Configuring the Maximum Amount of Memory for Infinispan Caches</h5>
<div class="paragraph">
<p>Limit the size of the data container for cache entries to a maximum amount of
memory.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure your Infinispan cache to use a storage format that supports binary encoding.</p>
<div class="paragraph">
<p>You must use a binary storage format to perform eviction based on the maximum
amount of memory.</p>
</div>
</li>
<li>
<p>Configure the maximum amount of memory, in bytes, that caches can use before
Infinispan performs eviction.</p>
<div class="ulist">
<ul>
<li>
<p>Declaratively: Set the <code>max-size</code> attribute.</p>
</li>
<li>
<p>Programmatically: Use the <code>maxSize()</code> method.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Optionally specify a byte unit of measurement. The default is B (bytes). Refer to the configuration schema for supported units.</p>
</li>
<li>
<p>Configure an eviction strategy to control how Infinispan removes entries.</p>
<div class="ulist">
<ul>
<li>
<p>Declaratively: Set the <code>when-full</code> attribute.</p>
</li>
<li>
<p>Programmatically: Use the <code>whenFull()</code> method.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Declarative example</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">maximum_size</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;encoding</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;memory</span> <span class="attribute-name">max-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.5GB</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">when-full</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REMOVE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatic example</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();

cfg
  .encoding()
    .mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span>)
  .memory()
    .maxSize(<span class="string"><span class="delimiter">&quot;</span><span class="content">1.5GB</span><span class="delimiter">&quot;</span></span>)
    .whenFull(EvictionStrategy.REMOVE)
  .build());</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/">Infinispan Configuration Schema Reference</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/cache/EncodingConfiguration.html">org.infinispan.configuration.cache.EncodingConfiguration</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/cache/MemoryConfigurationBuilder.html">org.infinispan.configuration.cache.MemoryConfigurationBuilder</a></p>
</li>
<li>
<p><a href="../developing/developing.html#encoding_media_type">MediaType Configuration</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="eviction_example-config"><a class="anchor" href="#eviction_example-config"></a>Eviction Examples</h5>
<div class="paragraph">
<p>You configure eviction as part of your cache definition.</p>
</div>
<div class="paragraph">
<div class="title">Default memory configuration</div>
<p>Eviction is not enabled, which is the default configuration. Infinispan stores
cache entries as objects in the JVM heap.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;memory</span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Eviction based on the total number of entries</div>
<p>Infinispan stores cache entries as objects in the JVM heap. Eviction happens
when there are 100 entries in the data container and Infinispan gets a request
to create a new entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;memory</span> <span class="attribute-name">max-count</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Eviction based maximum size in bytes</div>
<p>Infinispan stores cache entries as <code>byte[]</code> arrays if you encode entries with
binary storage formats, for example: <code>application/x-protostream</code> format.</p>
</div>
<div class="paragraph">
<p>In the following example, Infinispan performs eviction when the size of the
data container reaches 500 MB (megabytes) in size and it gets a request to
create a new entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;encoding</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tag">&lt;memory</span> <span class="attribute-name">max-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500 MB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specifies a binary format for entries in the cache.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Defines the maximum size of the data container as MB (megabytes).</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Off-heap storage</div>
<p>Infinispan stores cache entries as bytes in native memory. Eviction happens
when there are 100 entries in the data container and Infinispan gets a request
to create a new entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;memory</span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OFF_HEAP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-count</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Off-heap storage with the exception strategy</div>
<p>Infinispan stores cache entries as bytes in native memory. When there are 100
entries in the data container, and Infinispan gets a request to create a new
entry, it throws an exception and does not allow the new entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;transaction</span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;memory</span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OFF_HEAP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-count</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">when-full</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EXCEPTION</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Manual eviction</div>
<p>Infinispan stores cache entries as objects in the JVM heap. Eviction is not
enabled but performed manually using the <code>evict()</code> method.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This configuration prevents a warning message when you enable passivation but
do not configure eviction.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;memory</span> <span class="attribute-name">when-full</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MANUAL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Passivation with eviction</div>
<p>Passivation persists data to cache stores when Infinispan evicts entries. You
should always enable eviction if you enable passivation, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
<span class="tag">&lt;/persistence&gt;</span>

<span class="tag">&lt;memory</span> <span class="attribute-name">max-count</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">References</div>
<ul>
<li>
<p><a href="#passivation">Passivation</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="custom_class_eviction-config"><a class="anchor" href="#custom_class_eviction-config"></a>Custom Classes with Memory-Based Eviction</h5>
<div class="paragraph">
<p>You must use binary or off-heap storage memory based eviction,
as in the following examples:</p>
</div>
<div class="listingblock">
<div class="title">Declarative configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="comment">&lt;!-- Enable memory based eviction with 1 GB/&gt; --&gt;</span>
<span class="tag">&lt;memory&gt;</span>
   <span class="tag">&lt;binary</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000000000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">eviction</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MEMORY</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/memory&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatic configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> c = <span class="keyword">new</span> ConfigurationBuilder()
               .memory()
               .storageType(StorageType.BINARY)
               .evictionType(EvictionType.MEMORY)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .size(<span class="integer">1</span>_000_000_000)
               .build();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="expiration-config"><a class="anchor" href="#expiration-config"></a>5.1.2. Expiration</h4>
<div class="paragraph">
<p>Expiration removes entries from caches when they reach one of the following
time limits:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Lifespan</dt>
<dd>
<p>Sets the maximum amount of time that entries can exist.</p>
</dd>
<dt class="hdlist1">Maximum idle</dt>
<dd>
<p>Specifies how long entries can remain idle. If operations do not occur for
entries, they become idle.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Maximum idle expiration does not currently support cache configurations with
persistent cache stores.</p>
</div>
<div class="paragraph">
<p>When using expiration with an exception-based eviction policy, entries that are
expired but not yet removed from the cache count towards the size of the data
container.</p>
</div>
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
<div class="sect4">
<h5 id="how_expiration_works-config"><a class="anchor" href="#how_expiration_works-config"></a>How Expiration Works</h5>
<div class="paragraph">
<p>When you configure expiration, Infinispan stores keys with metadata that
determines when entries expire.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lifespan uses a <code>creation</code> timestamp and the value for the <code>lifespan</code> configuration property.</p>
</li>
<li>
<p>Maximum idle uses a <code>last used</code> timestamp and the value for the <code>max-idle</code> configuration property.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Infinispan checks if lifespan or maximum idle metadata is set and then
compares the values with the current time.</p>
</div>
<div class="paragraph">
<p>If <code>(creation + lifespan &gt; currentTime)</code> or <code>(lastUsed + maxIdle &gt; currentTime)</code> then Infinispan detects that the entry is expired.</p>
</div>
<div class="paragraph">
<p>Expiration occurs whenever entries are accessed or found by the expiration
reaper.</p>
</div>
<div class="paragraph">
<p>For example, <code>k1</code> reaches the maximum idle time and a client makes a
<code>Cache.get(k1)</code> request. In this case, Infinispan detects that the entry is
expired and removes it from the data container. The <code>Cache.get()</code> returns
<code>null</code>.</p>
</div>
<div class="paragraph">
<p>Infinispan also expires entries from cache stores, but only with lifespan
expiration. Maximum idle expiration does not work with cache stores. In the
case of cache loaders, Infinispan cannot expire entries because loaders can
only read from external storage.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan adds expiration metadata as <code>long</code> primitive data types to cache
entries. This can increase the size of keys by as much as 32 bytes.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="expiration_reaper-config"><a class="anchor" href="#expiration_reaper-config"></a>Expiration Reaper</h5>
<div class="paragraph">
<p>Infinispan uses a reaper thread that runs periodically to detect and remove
expired entries. The expiration reaper ensures that expired entries that are no
longer accessed are removed.</p>
</div>
<div class="paragraph">
<p>The Infinispan <code>ExpirationManager</code> interface handles the expiration reaper and
exposes the <code>processExpiration()</code> method.</p>
</div>
<div class="paragraph">
<p>In some cases, you can disable the expiration reaper and manually expire
entries by calling <code>processExpiration()</code>; for instance, if you are using local
cache mode with a custom application where a maintenance thread runs
periodically.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you use clustered cache modes, you should never disable the expiration
reaper.</p>
</div>
<div class="paragraph">
<p>Infinispan always uses the expiration reaper when using cache stores. In this
case you cannot disable it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/cache/ExpirationConfigurationBuilder.html">org.infinispan.configuration.cache.ExpirationConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/expiration/ExpirationManager.html">org.infinispan.expiration.ExpirationManager</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="maxidle_expiration-config"><a class="anchor" href="#maxidle_expiration-config"></a>Maximum Idle and Clustered Caches</h5>
<div class="paragraph">
<p>Because maximum idle expiration relies on the last access time for cache
entries, it has some limitations with clustered cache modes.</p>
</div>
<div class="paragraph">
<p>With lifespan expiration, the creation time for cache entries provides a value
that is consistent across clustered caches. For example, the creation time for
<code>k1</code> is always the same on all nodes.</p>
</div>
<div class="paragraph">
<p>For maximum idle expiration with clustered caches, last access time for entries
is not always the same on all nodes. To ensure that entries have the same
relative access times across clusters, Infinispan sends touch commands to all
owners when keys are accessed.</p>
</div>
<div class="paragraph">
<p>The touch commands that Infinispan send have the following considerations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Cache.get()</code> requests do not return until all touch commands complete. This synchronous behavior increases latency of client requests.</p>
</li>
<li>
<p>The touch command also updates the "recently accessed" metadata for cache entries on all owners, which Infinispan uses for eviction.</p>
</li>
<li>
<p>With scattered cache mode, Infinispan sends touch commands to all nodes, not
just primary and backup owners.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Additional information</div>
<ul>
<li>
<p>Maximum idle expiration does not work with invalidation mode.</p>
</li>
<li>
<p>Iteration across a clustered cache can return expired entries that have
exceeded the maximum idle time limit. This behavior ensures performance because
no remote invocations are performed during the iteration. Also note that
iteration does not refresh any expired entries.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="expiration_example-config"><a class="anchor" href="#expiration_example-config"></a>Expiration Examples</h5>
<div class="paragraph">
<p>When you configure Infinispan to expire entries, you can set lifespan and
maximum idle times for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All entries in a cache (cache-wide). You can configure cache-wide expiration in <code>infinispan.xml</code> or programmatically using the <code>ConfigurationBuilder</code>.</p>
</li>
<li>
<p>Per entry, which takes priority over cache-wide expiration values. You configure expiration for specific entries when you create them.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you explicitly define lifespan and maximum idle time values for cache
entries, Infinispan replicates those values across the cluster along with the
cache entries. Likewise, Infinispan persists expiration values along with the
entries if you configure cache stores.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Configuring expiration for all cache entries</div>
<p>Expire all cache entries after 2 seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;expiration</span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Expire all cache entries 1 second after last access time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;expiration</span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Disable the expiration reaper with the <code>interval</code> attribute and manually expire
entries 1 second after last access time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;expiration</span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Expire all cache entries after 5 seconds or 1 second after the last access
time, whichever happens first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;expiration</span> <span class="attribute-name">lifespan</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Configuring expiration when creating cache entries</div>
<p>The following example shows how to configure lifespan and maximum idle values
when creating cache entries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Use the cache-wide expiration configuration.</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pinot noir</span><span class="delimiter">&quot;</span></span>, pinotNoirPrice); <i class="conum" data-value="1"></i><b>(1)</b>

<span class="comment">// Define a lifespan value of 2.</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">chardonnay</span><span class="delimiter">&quot;</span></span>, chardonnayPrice, <span class="integer">2</span>, <span class="predefined-type">TimeUnit</span>.SECONDS); <i class="conum" data-value="2"></i><b>(2)</b>

<span class="comment">// Define a lifespan value of -1 (disabled) and a max-idle value of 1.</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pinot grigio</span><span class="delimiter">&quot;</span></span>, pinotGrigioPrice,
          -<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS, <span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS); <i class="conum" data-value="3"></i><b>(3)</b>

<span class="comment">// Define a lifespan value of 5 and a max-idle value of 1.</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">riesling</span><span class="delimiter">&quot;</span></span>, rieslingPrice,
          <span class="integer">5</span>, <span class="predefined-type">TimeUnit</span>.SECONDS, <span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the Infinispan configuration defines a lifespan value of <code>1000</code> for all
entries, the preceding <code>Cache.put()</code> requests cause the entries to expire:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>After 1 second.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>After 2 seconds.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>1 second after last access time.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>After 5 seconds or 1 second after the last access time, whichever happens first.</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/">Infinispan Configuration Schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/cache/ExpirationConfigurationBuilder.html">org.infinispan.configuration.cache.ExpirationConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/expiration/ExpirationManager.html">org.infinispan.expiration.ExpirationManager</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="off_heap_memory"><a class="anchor" href="#off_heap_memory"></a>5.2. Off-Heap Memory</h3>
<div class="paragraph">
<p>Infinispan can store cache entries in JVM heap memory or off-heap.
Off-heap storage lets your Java objects occupy native memory outside the managed JVM memory space.</p>
</div>
<div class="paragraph">
<p>Off-heap storage requires less overhead per entry than in JVM heap memory.
In other words, off-heap storage uses less memory than heap storage for the same amount of data.</p>
</div>
<div class="paragraph">
<p>Another benefit of off-heap storage is that it is not affected by Garbage Collector runs, which can improve overall JVM performance.
However, there are some trade-offs with off-heap storage; for example, JVM heap dumps do not show entries stored in off-heap memory.</p>
</div>
<div class="paragraph">
<p>Consider the following simplified illustration of memory space for a JVM process where Infinispan is running:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../topics/images/offheap.svg" alt="offheap">
</div>
</div>
<div class="paragraph">
<div class="title">JVM heap memory</div>
<p>The heap is divided into young and old generations that help keep referenced Java objects and other application data in memory.
The Garbage Collector (GC) process reclaims space from unreachable objects, running more frequently on the young generation memory pool.</p>
</div>
<div class="paragraph">
<p>When Infinispan stores cache entries in JVM heap memory, GC runs can take longer to complete as you start adding data to your caches.
Because GC is a fairly intensive process, longer and more frequent runs can degrade application performance.</p>
</div>
<div class="paragraph">
<div class="title">Off-heap memory</div>
<p>Off-heap memory is native available system memory outside JVM memory management.
The preceding diagram shows the <code>Metaspace</code> memory pool that holds class metadata and is allocated from native memory.
The diagram also represents a section of native memory that holds Infinispan cache entries.</p>
</div>
<div class="paragraph">
<div class="title">Storing data off-heap</div>
<p>When you add entries to off-heap caches, Infinispan dynamically allocates native memory to your data.</p>
</div>
<div class="paragraph">
<p>Infinispan hashes the serialized <code>byte[]</code> for each key into buckets that are similar to a standard Java <code>HashMap</code>.
Buckets include address pointers that Infinispan use to locate entries that you store in off-heap memory.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan determines equality of Java objects in off-heap storage using the serialized byte[] representation of each object instead of the object instance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following diagram shows a set of keys with names, the hash for each key and bucket array of address pointers, as well as the entries with the name and phone number:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../topics/images/offheap_hashmap.svg" alt="offheap hashmap">
</div>
</div>
<div class="paragraph">
<p>In cases where key hashes collide, Infinispan links entries.
As in the preceding diagram, if the William Clay and Luke Cage keys have the same hash, then the first entry added to the cache is the first element in the bucket.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even though Infinispan stores cache entries in native memory, run-time operations require JVM heap representations of those objects.
For instance, <code>cache.get()</code> operations read objects into heap memory before returning.
Likewise, state transfer operations hold subsets of objects in heap memory while they take place.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Memory overhead</div>
<p>Memory overhead is the additional memory that Infinispan uses to store entries.
For off-heap storage, Infinispan uses 25 bytes for each entry in the cache.</p>
</div>
<div class="paragraph">
<p>When you use eviction to create a bounded off-heap data container, memory overhead increases to a total of 61 bytes.
This occurs because Infinispan creates an additional linked list to track entries in the cache and perform eviction.</p>
</div>
<div class="paragraph">
<div class="title">Data consistency</div>
<p>Infinispan uses an array of locks to protect off-heap address spaces.
The number of locks is twice the number of cores and then rounded to the nearest power of two.
This ensures that there is an even distribution of <code>ReadWriteLock</code> instances to prevent write operations from blocking read operations.</p>
</div>
<div class="sect3">
<h4 id="configure_off_heap-config"><a class="anchor" href="#configure_off_heap-config"></a>5.2.1. Using Off-Heap Memory</h4>
<div class="paragraph">
<p>Configure Infinispan to store cache entries in native memory outside the JVM
heap space.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a configuration for any type of cache.</p>
</li>
<li>
<p>Store cache entries in off-heap memory.</p>
<div class="ulist">
<ul>
<li>
<p>Declaratively: Add the <code>storage="OFF_HEAP"</code> attribute to the <code>memory</code> element.</p>
</li>
<li>
<p>Programmatically: Call the <code>storage(OFF_HEAP)</code> method in the <code>MemoryConfigurationBuilder</code> class.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Configure eviction to limit the amount of off-heap memory that the cache can use. You can use eviction based on total number of entries (<code>max-count</code>) or maximum amount of memory (<code>max-size</code>).</p>
</li>
<li>
<p>Configure any binary encoding for cache entries. For optimal results, use the <code>application/x-protostream</code> MediaType to store entries in Protobuf format.</p>
</li>
<li>
<p>Create caches that use the configuration.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Declarative cache configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;cache-container&gt;</span>
    <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">off_heap</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;encoding</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;memory</span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OFF_HEAP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.5GB</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">when-full</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REMOVE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/distributed-cache&gt;</span>
  <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatic cache configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();

cfg
  .encoding()
    .mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span>)
  .memory()
    .storage(StorageType.OFF_HEAP)
    .maxCount(<span class="integer">500</span>)
    .whenFull(EvictionStrategy.REMOVE)
  .build());</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/">Infinispan Configuration Schema Reference</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/cache/MemoryConfigurationBuilder.html">org.infinispan.configuration.cache.MemoryConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="statistics"><a class="anchor" href="#statistics"></a>6. Configuring Statistics, Metrics, and JMX</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Enable statistics that Infinispan exports to a metrics endpoint or via JMX
MBeans. You can also register JMX MBeans to perform management operations.</p>
</div>
<div class="sect2">
<h3 id="enable_statistics-configure"><a class="anchor" href="#enable_statistics-configure"></a>6.1. Enabling Infinispan Statistics</h3>
<div class="paragraph">
<p>Infinispan lets you enable statistics for Cache Managers and caches. However,
enabling statistics for a Cache Manager does not enable statistics for the
caches that it controls. You must explicitly enable statistics for your caches.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan server enables statistics for Cache Managers by default.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Enable statistics declaratively or programmatically.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Declaratively</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enables statistics for the Cache Manager.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enables statistics for the named cache.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Programmatically</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
  .cacheContainer().statistics(<span class="predefined-constant">true</span>) <i class="conum" data-value="1"></i><b>(1)</b>
  .build();

 ...

Configuration config = <span class="keyword">new</span> ConfigurationBuilder()
<span class="error"></span> .statistics().enable() <i class="conum" data-value="2"></i><b>(2)</b>
  .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enables statistics for the Cache Manager.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enables statistics for the named cache.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configure_metrics-configure"><a class="anchor" href="#configure_metrics-configure"></a>6.2. Enabling Infinispan Metrics</h3>
<div class="paragraph">
<p>Configure Infinispan to export gauges and histograms.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Configure metrics declaratively or programmatically.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Declaratively</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tag">&lt;metrics</span> <span class="attribute-name">gauges</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">histograms</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Computes and collects statistics about the Cache Manager.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Exports collected statistics as gauge and histogram metrics.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Programmatically</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
  .statistics().enable() <i class="conum" data-value="1"></i><b>(1)</b>
  .metrics().gauges(<span class="predefined-constant">true</span>).histograms(<span class="predefined-constant">true</span>) <i class="conum" data-value="2"></i><b>(2)</b>
  .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Computes and collects statistics about the Cache Manager.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Exports collected statistics as gauge and histogram metrics.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="metrics-configure"><a class="anchor" href="#metrics-configure"></a>6.2.1. Infinispan Metrics</h4>
<div class="paragraph">
<p>Infinispan is compatible with the Eclipse MicroProfile Metrics API and can
generate gauge and histogram metrics.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Infinispan metrics are provided at the <code>vendor</code> scope. Metrics related to
the JVM are provided in the <code>base</code> scope for Infinispan server.</p>
</li>
<li>
<p>Gauges provide values such as the average number of nanoseconds for write
operations or JVM uptime. Gauges are enabled by default. If you enable
statistics, Infinispan automatically generates gauges.</p>
</li>
<li>
<p>Histograms provide details about operation execution times such as read,
write, and remove times. Infinispan does not enable histograms by default
because they require additional computation.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://github.com/eclipse/microprofile-metrics/blob/master/README.adoc">Eclipse MicroProfile Metrics</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enable_jmx-configure"><a class="anchor" href="#enable_jmx-configure"></a>6.3. Configuring Infinispan to Register JMX MBeans</h3>
<div class="paragraph">
<p>Infinispan can register JMX MBeans that you can use to collect statistics and
perform administrative operations. However, you must enable statistics
separately to JMX otherwise Infinispan provides <code>0</code> values for all statistic
attributes.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Enable JMX declaratively or programmatically.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Declaratively</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container&gt;</span>
  <span class="tag">&lt;jmx</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Registers Infinispan JMX MBeans.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Programmatically</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
  .jmx().enable() <i class="conum" data-value="1"></i><b>(1)</b>
  .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Registers Infinispan JMX MBeans.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="name_cache_managers-configure"><a class="anchor" href="#name_cache_managers-configure"></a>6.3.1. Naming Multiple Cache Managers</h4>
<div class="paragraph">
<p>In cases where multiple Infinispan Cache Managers run on the same JVM, you
should uniquely identify each Cache Manager to prevent conflicts.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Uniquely identify each cache manager in your environment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the following examples specify "Hibernate2LC" as the cache manager
name, which results in a JMX MBean named <code>org.infinispan:type=CacheManager,name="Hibernate2LC"</code>.</p>
</div>
<div class="listingblock">
<div class="title">Declaratively</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate2LC</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;jmx</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
  ...
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatically</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
  .cacheManagerName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hibernate2LC</span><span class="delimiter">&quot;</span></span>)
  .jmx().enable()
  .build();</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/global/GlobalConfigurationBuilder.html">GlobalConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/">Infinispan Configuration Schema</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="register_mbeans-configure"><a class="anchor" href="#register_mbeans-configure"></a>6.3.2. Registering MBeans In Custom MBean Servers</h4>
<div class="paragraph">
<p>Infinispan includes an <code>MBeanServerLookup</code> interface that you can use to
register MBeans in custom MBeanServer instances.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create an implementation of <code>MBeanServerLookup</code> so that the <code>getMBeanServer()</code> method returns the custom MBeanServer instance.</p>
</li>
<li>
<p>Configure Infinispan with the fully qualified name of your class, as in the following example:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Declaratively</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container&gt;</span>
   <span class="tag">&lt;jmx</span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mbean-server-lookup</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.acme.MyMBeanServerLookup</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatically</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder()
  .jmx().enable().mBeanServerLookup(<span class="keyword">new</span> com.acme.MyMBeanServerLookup())
  .build();</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/">Infinispan Configuration Schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/commons/jmx/MBeanServerLookup.html">MBeanServerLookup</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="jmx_mbeans-configure"><a class="anchor" href="#jmx_mbeans-configure"></a>6.3.3. Infinispan MBeans</h4>
<div class="paragraph">
<p>Infinispan exposes JMX MBeans that represent manageable resources.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>org.infinispan:type=Cache</code></dt>
<dd>
<p>Attributes and operations available for cache instances.</p>
</dd>
<dt class="hdlist1"><code>org.infinispan:type=CacheManager</code></dt>
<dd>
<p>Attributes and operations available for cache managers, including Infinispan cache and cluster health statistics.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For a complete list of available JMX MBeans along with descriptions and
available operations and attributes, see the <em>Infinispan JMX Components</em>
documentation.</p>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/jmxComponents.html">Infinispan JMX Components</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring_clustering"><a class="anchor" href="#configuring_clustering"></a>7. Configuring Infinispan Clustering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan uses the JGroups protocol so nodes can discover each other on the
network and form clusters. When Infinispan nodes form clusters, they also use
JGroups for inter-cluster and intra-cluster communication.</p>
</div>
<div class="sect2">
<h3 id="cluster_transport"><a class="anchor" href="#cluster_transport"></a>7.1. Setting Up Cluster Transport</h3>
<div class="paragraph">
<p>Infinispan nodes rely on a transport layer to join and leave clusters as well
as to replicate data across the network.</p>
</div>
<div class="paragraph">
<p>Infinispan uses JGroups technology to handle cluster transport. You configure
cluster transport with JGroups stacks, which define properties for either UDP
or TCP protocols.</p>
</div>
<div class="sect3">
<h4 id="jgroups_getting_started-configuring"><a class="anchor" href="#jgroups_getting_started-configuring"></a>7.1.1. Getting Started with Default Stacks</h4>
<div class="paragraph">
<p>Use default JGroups stacks with recommended settings as a starting point for
your cluster transport layer.</p>
</div>
<div class="ulist">
<div class="title">Declaratively</div>
<ul>
<li>
<p>Specify default JGroups stacks with the <code>stack</code> attribute.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
 <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;transport</span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">udp</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
   ...
 <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>uses the <code>default-jgroups-udp.xml</code> stack for cluster transport.</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Programmatically</div>
<ul>
<li>
<p>Specify default JGroups stacks with the <code>addProperty()</code> method.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder().transport()
        .defaultTransport()
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .clusterName(<span class="string"><span class="delimiter">&quot;</span><span class="content">qa-cluster</span><span class="delimiter">&quot;</span></span>)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">configurationFile</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">default-jgroups-udp.xml</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>uses the <code>default-jgroups-udp.xml</code> stack for cluster transport.</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use the <code>cluster-stack</code> argument with the Infinispan server startup script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>$ bin/server.sh --cluster-stack=tcp</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="preconfigured_jgroups_stacks-configuring"><a class="anchor" href="#preconfigured_jgroups_stacks-configuring"></a>Default JGroups Stacks</h5>
<div class="paragraph">
<p>Default JGroups stacks are included in <code>infinispan-core.jar</code> and on the
classpath. You can locate the default JGroups stacks in the <code>default-configs</code>
directory.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File name</th>
<th class="tableblock halign-left valign-top">Stack name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-udp.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>udp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses UDP for transport and UDP multicast for discovery. Suitable for larger clusters (over 100 nodes) or if you are using replicated caches or invalidation mode. Minimizes the number of open sockets.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-tcp.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tcp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses TCP for transport and the <code>MPING</code> protocol for discovery, which uses
<code>UDP</code> multicast. Suitable for smaller clusters (under 100 nodes) <em>only if</em> you are using distributed caches because TCP is more efficient than UDP as a point-to-point protocol.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-ec2.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ec2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses TCP for transport and <code>S3_PING</code> for discovery. Suitable for Amazon EC2 nodes where UDP multicast is not available.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-kubernetes.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kubernetes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses TCP for transport and <code>DNS_PING</code> for discovery. Suitable for Kubernetes and Red Hat OpenShift nodes where UDP multicast is not always available.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-google.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>google</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses TCP for transport and <code>GOOGLE_PING2</code> for discovery. Suitable for Google Cloud Platform nodes where UDP multicast is not available.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default-jgroups-azure.xml</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>azure</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses TCP for transport and <code>AZURE_PING</code> for discovery. Suitable for Microsoft Azure nodes where UDP multicast is not available.</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual/html/protlist.html">JGroups Protocol</a></p>
</li>
<li>
<p><a href="http://www.jgroups.org/manual/html/protlist.html#DiscoveryProtocols">JGroups Discovery Protocols</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jgroups_inline-configuring"><a class="anchor" href="#jgroups_inline-configuring"></a>7.1.2. Using Inline JGroups Stacks</h4>
<div class="paragraph">
<p>Custom JGroups stacks can help you optimize network performance for Infinispan
clusters compared to using the default stacks.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Embed your custom JGroups stack definitions in <code>infinispan.xml</code> as in the
following example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tag">&lt;jgroups&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">prod</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port_range</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">recv_buf_size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20000000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">send_buf_size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">640000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;MPING</span> <span class="attribute-name">break_on_coord_rsp</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">mcast_addr</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jgroups.mping.mcast_addr:228.2.4.6}</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">mcast_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jgroups.mping.mcast_port:43366}</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">num_discovery_runs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">ip_ttl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jgroups.udp.ip_ttl:2}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;MERGE3</span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;FD_SOCK</span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;FD_ALL</span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">timeout_check_interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;VERIFY_SUSPECT</span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;pbcast.NAKACK2</span> <span class="attribute-name">use_mcast_xmit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmit_interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmit_table_num_rows</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">xmit_table_msgs_per_row</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1024</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmit_table_max_compaction_time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;UNICAST3</span> <span class="attribute-name">xmit_interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmit_table_num_rows</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmit_table_msgs_per_row</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1024</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">xmit_table_max_compaction_time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;pbcast.STABLE</span> <span class="attribute-name">stability_delay</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">desired_avg_gossip</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max_bytes</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1M</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;pbcast.GMS</span> <span class="attribute-name">print_local_addr</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">join_timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jgroups.join_timeout:2000}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;UFC</span> <span class="attribute-name">max_credits</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">min_threshold</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.40</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;MFC</span> <span class="attribute-name">max_credits</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">min_threshold</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.40</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;FRAG3</span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/stack&gt;</span>
  <span class="tag">&lt;/jgroups&gt;</span>
 <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
 <span class="tag">&lt;transport</span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">prod</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="5"></i><b>(5)</b>
    ...
 <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>root element of <code>infinispan.xml</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>contains JGroups stack definitions.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>defines a JGroups stack named "prod".</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>configures a Infinispan Cache Manager and names the "replicatedCache" cache definition as the default.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>uses the "prod" JGroups stack for cluster transport.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use inheritance with inline JGroups stacks to tune and customize specific
transport properties.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="#jgroups_inheritance-configuring">Adjusting and Tuning JGroups Stacks</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/">Infinispan Configuration Schema</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="jgroups_inheritance-configuring"><a class="anchor" href="#jgroups_inheritance-configuring"></a>7.1.3. Adjusting and Tuning JGroups Stacks</h4>
<div class="paragraph">
<p>Use inheritance to combine, extend, remove, and replace specific properties in
the default JGroups stacks or custom configurations.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add a new JGroups stack declaration.</p>
</li>
<li>
<p>Name a parent stack with the <code>extends</code> attribute.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use the default JGroups stacks as parents. For example, <code>extends="tcp"</code> to
tunes the default TCP stack.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Modify transport properties with the <code>stack.combine</code> attribute.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="jgroups_stackcombine-configuring"><a class="anchor" href="#jgroups_stackcombine-configuring"></a>Stack Combine Attribute</h5>
<div class="paragraph">
<p><code>stack.combine</code> modifies inherited JGroups properties.</p>
</div>
<div class="paragraph">
<p><code>stack.position</code> identifies protocols to modify. If you do not specify
<code>stack.position</code>, Infinispan defaults to the same protocol as the inherited
configuration, which resets all non-specified attributes to the default values.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>COMBINE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overrides existing protocol attributes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REPLACE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Replaces existing protocols.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INSERT_AFTER</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inserts protocols into the JGroups stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REMOVE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removes protocols from the inherited configuration.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, evaluate a Gossip router for cluster discovery using a TCP stack
configuration named "prod":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;jgroups&gt;</span>
  ...
  <span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gossip-prod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">extends</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">prod</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tag">&lt;TCPGOSSIP</span> <span class="attribute-name">initial_hosts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jgroups.tunnel.gossip_router_hosts:localhost[12001]}</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">stack.combine</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REPLACE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">stack.position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MPING</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tag">&lt;FD_SOCK</span> <span class="attribute-name">stack.combine</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REMOVE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tag">&lt;VERIFY_SUSPECT</span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tag">&lt;SYM_ENCRYPT</span> <span class="attribute-name">sym_algorithm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AES</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">key_store_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultStore.keystore</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">store_password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">changeit</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myKey</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">stack.combine</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT_AFTER</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">stack.position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.NAKACK2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="5"></i><b>(5)</b>
  <span class="tag">&lt;/stack&gt;</span>
  ...
<span class="tag">&lt;/jgroups&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>creates a new stack named "gossip-prod" that inherits from "prod".</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>uses <code>TCPGOSSIP</code> discovery instead of <code>MPING</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>removes <code>FD_SOCK</code> from the "gossip-prod" stack.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>increases the <code>VERIFY_SUSPECT</code> timeout.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>adds <code>SYM_ENCRYPT</code> for cluster security to the stack after the <code>pbcast.NAKACK2</code> protocol.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jgroups_external-configuring"><a class="anchor" href="#jgroups_external-configuring"></a>7.1.4. Using JGroups Stacks in External Files</h4>
<div class="paragraph">
<p>You can use custom JGroups transport configuration from external files.</p>
</div>
<div class="paragraph">
<p>Infinispan looks for JGroups configuration files on your classpath first and
then for absolute path names.</p>
</div>
<div class="ulist">
<div class="title">Declaratively</div>
<ul>
<li>
<p>Specify your JGroups transport configuration with the <code>stack-file</code> element.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;jgroups&gt;</span>
     <span class="tag">&lt;stack-file</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">prod-tcp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">prod-jgroups-tcp.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tag">&lt;/jgroups&gt;</span>
 <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="tag">&lt;transport</span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">prod-tcp</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replicatedCache</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;/cache-container&gt;</span>
 ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>adds the "prod-jgroups-tcp.xml" stack definition.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>configures Infinispan cluster to use the stack.</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Programmatically</div>
<ul>
<li>
<p>Specify your JGroups transport configuration with the <code>addProperty()</code> method.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfiguration globalConfig = <span class="keyword">new</span> GlobalConfigurationBuilder().transport()
        .defaultTransport()
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .clusterName(<span class="string"><span class="delimiter">&quot;</span><span class="content">prod-cluster</span><span class="delimiter">&quot;</span></span>)
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">configurationFile</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">prod-jgroups-tcp.xml</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> .build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>adds the "prod-jgroups-tcp.xml" stack definition as the default for the
cluster transport.</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/global/GlobalConfigurationBuilder.html#transport()">GlobalConfigurationBuilder.transport()</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/global/TransportConfigurationBuilder.html">TransportConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="jgroups_tune_system_props-configuring"><a class="anchor" href="#jgroups_tune_system_props-configuring"></a>7.1.5. Tuning JGroups Stacks with System Properties</h4>
<div class="paragraph">
<p>Pass system properties to the JVM at startup to tune JGroups stacks.</p>
</div>
<div class="paragraph">
<p>For example, to change the <code>TCP</code> port and IP address do the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>$ java -cp ... -Djgroups.bind.port=1234 -Djgroups.bind.address=192.0.2.0</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="jgroups_system_props-configuring"><a class="anchor" href="#jgroups_system_props-configuring"></a>System Properties for Default JGroups Stacks</h5>
<div class="paragraph">
<p>Use system properties with default JGroups stacks.</p>
</div>
<div class="paragraph">
<div class="title">Common Properties</div>
<p>The following system properties apply to all JGroups stacks, including
<code>default-jgroups-udp.xml</code> and <code>default-jgroups-tcp.xml</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 42.8571%;">
<col style="width: 28.5714%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.bind.address</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bind address for cluster transport.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SITE_LOCAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.bind.port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bind port for the socket.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7800</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.mcast_addr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IP address for multicast, both discovery and inter-cluster communication. The IP address must be a valid "class D" address that is suitable for IP multicast.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>228.6.7.8</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.mcast_port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port for the multicast socket.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>46655</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.ip_ttl</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time-to-live (TTL) for IP multicast packets. The value defines the number of network hops a packet can make before it is dropped.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.thread_pool.min_threads</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Minimum number of threads for the thread pool.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.thread_pool.max_threads</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of threads for the thread pool.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.join_timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of milliseconds to wait for join requests to succeed.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Amazon EC3</div>
<p>The following system properties apply to <code>default-jgroups-ec2.xml</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 42.8571%;">
<col style="width: 28.5714%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.s3.access_key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Amazon S3 access key for an S3 bucket.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.s3.secret_access_key</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Amazon S3 secret key used for an S3 bucket.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.s3.bucket</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Amazon S3 bucket. The name must exist and be unique.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No default value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Kubernetes</div>
<p>The following system properties apply to <code>default-jgroups-kubernetes.xml</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 42.8571%;">
<col style="width: 28.5714%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.dns.query</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the DNS record that returns cluster members.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required if you do not set the <code>dns_query</code> parameter.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Google Cloud Platform</div>
<p>The following system properties apply to <code>default-jgroups-google.xml</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 42.8571%;">
<col style="width: 28.5714%;">
<col style="width: 14.2858%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jgroups.google.bucket_name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Google Compute Engine bucket. The name must exist and be unique.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required if you do not set the <code>dns_query</code> parameter.</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual4/index.html#SystemProperties">JGroups System Properties</a></p>
</li>
<li>
<p><a href="http://jgroups.org/manual/html/protlist.html">JGroups Protocol List</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jgroups_jchannels-configuring"><a class="anchor" href="#jgroups_jchannels-configuring"></a>7.1.6. Using Custom JChannels</h4>
<div class="paragraph">
<p>Construct custom JGroups JChannels as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder global = <span class="keyword">new</span> GlobalConfigurationBuilder();
JChannel jchannel = <span class="keyword">new</span> JChannel();
<span class="comment">// Configure the jchannel to your needs.</span>
JGroupsTransport transport = <span class="keyword">new</span> JGroupsTransport(jchannel);
global.transport().transport(transport);
<span class="keyword">new</span> DefaultCacheManager(global.build());</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Infinispan cannot use custom JChannels that are already connected.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="http://www.jgroups.org/manual4/index.html#JChannel">JGroups JChannel</a></p>
</div>
</div>
<div class="sect3">
<h4 id="jgroups_ports-configuring"><a class="anchor" href="#jgroups_ports-configuring"></a>7.1.7. TCP and UDP Ports for Cluster Traffic</h4>
<div class="paragraph">
<p>Infinispan uses the following ports by default:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Default Port</th>
<th class="tableblock halign-left valign-top">Protocol</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7800</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP/UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JGroups cluster bind port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>46655</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JGroups multicast</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7200</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JGroups RELAY2 for cross-site replication</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="../configuring/configuring.html#cluster_transport">Setting Up Cluster Transport</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cluster_discovery"><a class="anchor" href="#cluster_discovery"></a>7.2. Configuring Cluster Discovery</h3>
<div class="paragraph">
<p>Running Infinispan on hosted services requires using discovery mechanisms that are adapted to network constraints that individual cloud providers impose. For instance, Amazon EC2 does not allow UDP multicast.</p>
</div>
<div class="paragraph">
<p>Infinispan can use the following cloud discovery mechanisms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generic discovery protocols (<code>TCPPING</code> and <code>TCPGOSSIP</code>)</p>
</li>
<li>
<p>JGroups PING protocols (<code>KUBE_PING</code> and <code>DNS_PING</code>)</p>
</li>
<li>
<p>Cloud-specific PING protocols</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Embedded Infinispan requires cloud provider dependencies.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="tcpping"><a class="anchor" href="#tcpping"></a>7.2.1. TCPPING</h4>
<div class="paragraph">
<p><code>TCPPING</code> is a generic JGroups discovery mechanism that uses a static list of IP
addresses for cluster members.</p>
</div>
<div class="paragraph">
<p>To use <code>TCPPING</code>, you must add the list of static IP addresses to the JGroups
configuration file for each Infinispan node. However, the drawback to
<code>TCPPING</code> is that it does not allow nodes to dynamically join Infinispan
clusters.</p>
</div>
<div class="listingblock">
<div class="title">TCPPING configuration example</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
 <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;TCPPING</span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3000</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">initial_hosts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jgroups.tcpping.initial_hosts:localhost[7800],localhost[7801]}</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">port_range</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
<span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span><span class="error"></span> <span class="attribute-name">num_initial_members</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
...
...
<span class="tag">&lt;/config&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="http://community.jboss.org/wiki/JGroupsTCPPING">JGroups TCPPING</a></p>
</div>
</div>
<div class="sect3">
<h4 id="gossip_router"><a class="anchor" href="#gossip_router"></a>7.2.2. Gossip Router</h4>
<div class="paragraph">
<p>Gossip routers provide a centralized location on the network from which your
Infinispan cluster can retrieve addresses of other nodes.</p>
</div>
<div class="paragraph">
<p>You inject the address (<code>IP:PORT</code>) of the Gossip router into Infinispan nodes as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pass the address as a system property to the JVM; for example, <code>-DGossipRouterAddress="10.10.2.4[12001]"</code>.</p>
</li>
<li>
<p>Reference that system property in the JGroups configuration file.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Gossip router configuration example</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
 <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;TCPGOSSIP</span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial_hosts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${GossipRouterAddress}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">num_initial_members</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
...
...
<span class="tag">&lt;/config&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="http://community.jboss.org/docs/DOC-10890">JGroups Gossip Router</a></p>
</div>
</div>
<div class="sect3">
<h4 id="dns_ping"><a class="anchor" href="#dns_ping"></a>7.2.3. DNS_PING</h4>
<div class="paragraph">
<p>JGroups <code>DNS_PING</code> queries DNS servers to discover Infinispan cluster members
in Kubernetes environments such as OKD and Red Hat OpenShift.</p>
</div>
<div class="listingblock">
<div class="title">DNS_PING configuration example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dns-ping</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
...
    <span class="tag">&lt;dns.DNS_PING</span>
      <span class="attribute-name">dns_query</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myservice.myproject.svc.cluster.local</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
...
<span class="tag">&lt;/stack&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual4/index.html#_dns_ping">JGroups DNS_PING</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/">DNS for Services and Pods</a> (Kubernetes documentation for adding DNS entries)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="kube_ping"><a class="anchor" href="#kube_ping"></a>7.2.4. KUBE_PING</h4>
<div class="paragraph">
<p>JGroups <code>Kube_PING</code> uses a Kubernetes API to discover Infinispan cluster
members in environments such as OKD and Red Hat OpenShift.</p>
</div>
<div class="listingblock">
<div class="title">KUBE_PING configuration example</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
 <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_addr</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${match-interface:eth.*}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;kubernetes.KUBE_PING</span> <span class="tag">/&gt;</span>
...
...
<span class="tag">&lt;/config&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">KUBE_PING configuration requirements</div>
<ul>
<li>
<p>Your <code>KUBE_PING</code> configuration must bind the JGroups stack to the <code>eth0</code>
network interface. Docker containers use <code>eth0</code> for communication.</p>
</li>
<li>
<p><code>KUBE_PING</code> uses environment variables inside containers for configuration.
The <code>KUBERNETES_NAMESPACE</code> environment variable must specify a valid namespace.
You can either hardcode it or populate it via the Kubernetes Downward API.</p>
</li>
<li>
<p><code>KUBE_PING</code> requires additional privileges on Red Hat OpenShift. Assuming that <code>oc project -q</code> returns the current namespace and <code>default</code> is the service account name, you can run:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ oc policy add-role-to-user view system:serviceaccount:$(oc project -q):default -n $(oc project -q)</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="http://www.jgroups.org/manual4/index.html#_kube_ping">JGroups Kube_PING</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/tree/release-1.0/docs/user-guide/downward-api">Kubernetes Downward API</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/engine/userguide/networking/dockernetworks/">Docker Networking</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="native_s3_ping"><a class="anchor" href="#native_s3_ping"></a>7.2.5. NATIVE_S3_PING</h4>
<div class="paragraph">
<p>On Amazon Web Service (AWS), use the <code>S3_PING</code> protocol for discovery.</p>
</div>
<div class="paragraph">
<p>You can configure JGroups to use shared storage to exchange the details of
Infinispan nodes. <code>NATIVE_S3_PING</code> allows Amazon S3 as the shared storage but
requires both Amazon S3 and EC2 subscriptions.</p>
</div>
<div class="listingblock">
<div class="title">NATIVE_S3_PING configuration example</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;config&gt;</span>
    <span class="tag">&lt;TCP</span> <span class="attribute-name">bind_port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7800</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;org.jgroups.aws.s3.NATIVE_S3_PING</span>
            <span class="attribute-name">region_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your region (e.g. eu-west-1)</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">bucket_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your bucket name</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">bucket_prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with a prefix to use for entries in the bucket (optional)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/config&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">NATIVE_S3_PING dependencies for embedded Infinispan</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jgroups.aws.s3<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>native-s3-ping<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.jgroups.native_s3_ping}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc_ping"><a class="anchor" href="#jdbc_ping"></a>7.2.6. JDBC_PING</h4>
<div class="paragraph">
<p><code>JDBC_PING</code> uses JDBC connections to shared databases, such as Amazon RDS on
EC2, to store information about Infinispan nodes.</p>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="http://community.jboss.org/wiki/JDBCPING">JDBC_PING Wiki</a></p>
</div>
</div>
<div class="sect3">
<h4 id="azure_ping"><a class="anchor" href="#azure_ping"></a>7.2.7. AZURE_PING</h4>
<div class="paragraph">
<p>On Microsoft Azure, use a generic discovery protocol or <code>AZURE_PING</code>, which
uses shared Azure Blob Storage to store discovery information.</p>
</div>
<div class="listingblock">
<div class="title">AZURE_PING configuration example</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;azure.AZURE_PING</span>
        <span class="attribute-name">storage_account_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your account name</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">storage_access_key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your access key</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">replace this with your container name</span><span class="delimiter">&quot;</span></span>
<span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">AZURE_PING dependencies for embedded Infinispan</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jgroups.azure<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jgroups-azure<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.jgroups.azure}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="google2_ping"><a class="anchor" href="#google2_ping"></a>7.2.8. GOOGLE2_PING</h4>
<div class="paragraph">
<p>On Google Compute Engine (GCE), use a generic discovery protocol or
<code>GOOGLE2_PING</code>, which uses Google Cloud Storage (GCS) to store information
about the cluster members.</p>
</div>
<div class="listingblock">
<div class="title">GOOGLE2_PING configuration example</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;org.jgroups.protocols.google.GOOGLE_PING2</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jgroups.google.bucket_name}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">GOOGLE2_PING dependencies for embedded Infinispan</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jgroups.google<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jgroups-google<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.jgroups.google}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jgroups_encrypt"><a class="anchor" href="#jgroups_encrypt"></a>7.3. Encrypting Cluster Transport</h3>
<div class="paragraph">
<p>Secure cluster transport so that nodes communicate with encrypted messages.
You can also configure Infinispan clusters to perform certificate authentication so that only nodes with valid identities can join.</p>
</div>
<div class="sect3">
<h4 id="jgroups_encryption-cluster_transport"><a class="anchor" href="#jgroups_encryption-cluster_transport"></a>7.3.1. Infinispan Cluster Security</h4>
<div class="paragraph">
<p>To secure cluster traffic, you configure Infinispan nodes to encrypt JGroups message payloads with secret keys.</p>
</div>
<div class="paragraph">
<p>Infinispan nodes can obtain secret keys from either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The coordinator node (asymmetric encryption).</p>
</li>
<li>
<p>A shared keystore (symmetric encryption).</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Retrieving secret keys from coordinator nodes</div>
<p>You configure asymmetric encryption by adding the <code>ASYM_ENCRYPT</code> protocol to a JGroups stack in your Infinispan configuration.
This allows Infinispan clusters to generate and distribute secret keys.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using asymmetric encryption, you should also provide keystores so that nodes can perform certificate authentication and securely exchange secret keys.
This protects your cluster from man-in-the-middle (MitM) attacks.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Asymmetric encryption secures cluster traffic as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The first node in the Infinispan cluster, the coordinator node, generates a secret key.</p>
</li>
<li>
<p>A joining node performs certificate authentication with the coordinator to mutually verify identity.</p>
</li>
<li>
<p>The joining node requests the secret key from the coordinator node. That request includes the public key for the joining node.</p>
</li>
<li>
<p>The coordinator node encrypts the secret key with the public key and returns it to the joining node.</p>
</li>
<li>
<p>The joining node decrypts and installs the secret key.</p>
</li>
<li>
<p>The node joins the cluster, encrypting and decrypting messages with the secret key.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Retrieving secret keys from shared keystores</div>
<p>You configure symmetric encryption by adding the <code>SYM_ENCRYPT</code> protocol to a JGroups stack in your Infinispan configuration.
This allows Infinispan clusters to obtain secret keys from keystores that you provide.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Nodes install the secret key from a keystore on the Infinispan classpath at startup.</p>
</li>
<li>
<p>Node join clusters, encrypting and decrypting messages with the secret key.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Comparison of asymmetric and symmetric encryption</div>
<p><code>ASYM_ENCRYPT</code> with certificate authentication provides an additional layer of encryption in comparison with <code>SYM_ENCRYPT</code>.
You provide keystores that encrypt the requests to coordinator nodes for the secret key.
Infinispan automatically generates that secret key and handles cluster traffic, while letting you specify when to generate secret keys.
For example, you can configure clusters to generate new secret keys when nodes leave.
This ensures that nodes cannot bypass certificate authentication and join with old keys.</p>
</div>
<div class="paragraph">
<p><code>SYM_ENCRYPT</code>, on the other hand, is faster than <code>ASYM_ENCRYPT</code> because nodes do not need to exchange keys with the cluster coordinator.
A potential drawback to <code>SYM_ENCRYPT</code> is that there is no configuration to automatically generate new secret keys when cluster membership changes.
Users are responsible for generating and distributing the secret keys that nodes use to encrypt cluster traffic.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring_jgroups_asym_encrypt-cluster_transport"><a class="anchor" href="#configuring_jgroups_asym_encrypt-cluster_transport"></a>7.3.2. Configuring Cluster Transport with Asymmetric Encryption</h4>
<div class="paragraph">
<p>Configure Infinispan clusters to generate and distribute secret keys that encrypt JGroups messages.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a keystore with certificate chains that enables Infinispan to verify node identity.</p>
</li>
<li>
<p>Place the keystore on the classpath for each node in the cluster.</p>
<div class="paragraph">
<p>For Infinispan Server, you put the keystore in the $ISPN_HOME directory.</p>
</div>
</li>
<li>
<p>Add the <code>SSL_KEY_EXCHANGE</code> and <code>ASYM_ENCRYPT</code> protocols to a JGroups stack in your Infinispan configuration, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
    <span class="tag">&lt;jgroups&gt;</span>
         <span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">encrypt-tcp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">extends</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tcp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
           <span class="tag">&lt;SSL_KEY_EXCHANGE</span> <span class="attribute-name">keystore_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mykeystore.jks</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
                             <span class="attribute-name">keystore_password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">changeit</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
                             <span class="attribute-name">stack.combine</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT_AFTER</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">stack.position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VERIFY_SUSPECT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
           <span class="tag">&lt;ASYM_ENCRYPT</span> <span class="attribute-name">asym_keylength</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2048</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="5"></i><b>(5)</b>
                    <span class="attribute-name">asym_algorithm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RSA</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="6"></i><b>(6)</b>
                    <span class="attribute-name">change_key_on_coord_leave</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="7"></i><b>(7)</b>
                    <span class="attribute-name">change_key_on_leave</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="8"></i><b>(8)</b>
                    <span class="attribute-name">use_external_key_exchange</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="9"></i><b>(9)</b>
                    <span class="attribute-name">stack.combine</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT_BEFORE</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">stack.position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.NAKACK2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="10"></i><b>(10)</b>
         <span class="tag">&lt;/stack&gt;</span>
    <span class="tag">&lt;/jgroups&gt;</span>
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;transport</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${infinispan.cluster.name}</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">encrypt-tcp</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="11"></i><b>(11)</b>
                 <span class="attribute-name">node-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${infinispan.node.name:}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a secure JGroups stack named "encrypt-tcp" that extends the default TCP stack for Infinispan.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Names the keystore that nodes use to perform certificate authentication.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifies the keystore password.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Uses the <code>stack.combine</code> and <code>stack.position</code> attributes to insert <code>SSL_KEY_EXCHANGE</code> into the default TCP stack after the <code>VERIFY_SUSPECT</code> protocol.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Specifies the length of the secret key that the coordinator node generates. The default value is <code>2048</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Specifies the cipher engine the coordinator node uses to generate secret keys. The default value is <code>RSA</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Configures Infinispan to generate and distribute a new secret key when the coordinator node changes.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Configures Infinispan to generate and distribute a new secret key when nodes leave.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Configures Infinispan nodes to use the <code>SSL_KEY_EXCHANGE</code> protocol for certificate authentication.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Uses the <code>stack.combine</code> and <code>stack.position</code> attributes to insert <code>ASYM_ENCRYPT</code> into the default TCP stack before the <code>pbcast.NAKACK2</code> protocol.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Configures the Infinispan cluster to use the secure JGroups stack.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Verification</div>
<p>When you start your Infinispan cluster, the following log message indicates that the cluster is using the secure JGroups stack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash">[org.infinispan.CLUSTER] ISPN000078: Starting JGroups channel cluster with stack &lt;encrypted_stack_name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan nodes can join the cluster only if they use <code>ASYM_ENCRYPT</code> and can obtain the secret key from the coordinator node.
Otherwise the following message is written to Infinispan logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[org.jgroups.protocols.ASYM_ENCRYPT] &lt;hostname&gt;: received message without encrypt header from &lt;hostname&gt;; dropping it</pre>
</div>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p>The example <code>ASYM_ENCRYPT</code> configuration in this procedure shows commonly used parameters.
Refer to JGroups documentation for the full set of available parameters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.jgroups.org/manual4/index.html">JGroups 4 Manual</a></p>
</li>
<li>
<p><a href="http://www.jgroups.org/schema/jgroups-4.2.xsd">JGroups 4.2 Schema</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="configuring_jgroups_sym_encrypt-cluster_transport"><a class="anchor" href="#configuring_jgroups_sym_encrypt-cluster_transport"></a>7.3.3. Configuring Cluster Transport with Symmetric Encryption</h4>
<div class="paragraph">
<p>Configure Infinispan clusters to encrypt JGroups messages with secret keys from keystores that you provide.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a keystore that contains a secret key.</p>
</li>
<li>
<p>Place the keystore on the classpath for each node in the cluster.</p>
<div class="paragraph">
<p>For Infinispan Server, you put the keystore in the $ISPN_HOME directory.</p>
</div>
</li>
<li>
<p>Add the <code>SYM_ENCRYPT</code> protocol to a JGroups stack in your Infinispan configuration, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
    <span class="tag">&lt;jgroups&gt;</span>
         <span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">encrypt-tcp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">extends</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tcp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
           <span class="tag">&lt;SYM_ENCRYPT</span> <span class="attribute-name">keystore_name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myKeystore.p12</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
                        <span class="attribute-name">keystore_type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PKCS12</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
                        <span class="attribute-name">store_password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">changeit</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
                        <span class="attribute-name">key_password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">changeit</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="5"></i><b>(5)</b>
                        <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myKey</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="6"></i><b>(6)</b>
                        <span class="attribute-name">stack.combine</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT_AFTER</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">stack.position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VERIFY_SUSPECT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="7"></i><b>(7)</b>
         <span class="tag">&lt;/stack&gt;</span>
    <span class="tag">&lt;/jgroups&gt;</span>
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">statistics</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;transport</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${infinispan.cluster.name}</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">encrypt-tcp</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="8"></i><b>(8)</b>
                 <span class="attribute-name">node-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${infinispan.node.name:}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a secure JGroups stack named "encrypt-tcp" that extends the default TCP stack for Infinispan.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Names the keystore from which nodes obtain secret keys.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifies the keystore type. JGroups uses JCEKS by default.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specifies the keystore password.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Specifies the secret key password.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Specifies the secret key alias.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Uses the <code>stack.combine</code> and <code>stack.position</code> attributes to insert <code>SYM_ENCRYPT</code> into the default TCP stack after the <code>VERIFY_SUSPECT</code> protocol.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Configures the Infinispan cluster to use the secure JGroups stack.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Verification</div>
<p>When you start your Infinispan cluster, the following log message indicates that the cluster is using the secure JGroups stack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="bash">[org.infinispan.CLUSTER] ISPN000078: Starting JGroups channel cluster with stack &lt;encrypted_stack_name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan nodes can join the cluster only if they use <code>SYM_ENCRYPT</code> and can obtain the secret key from the shared keystore.
Otherwise the following message is written to Infinispan logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[org.jgroups.protocols.SYM_ENCRYPT] &lt;hostname&gt;: received message without encrypt header from &lt;hostname&gt;; dropping it</pre>
</div>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p>The example <code>SYM_ENCRYPT</code> configuration in this procedure shows commonly used parameters.
Refer to JGroups documentation for the full set of available parameters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.jgroups.org/manual4/index.html">JGroups 4 Manual</a></p>
</li>
<li>
<p><a href="http://www.jgroups.org/schema/jgroups-4.2.xsd">JGroups 4.2 Schema</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="persistence"><a class="anchor" href="#persistence"></a>8. Setting Up Persistent Storage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan can persist in-memory data to external storage, giving you
additional capabilities to manage your data such as:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Durability</dt>
<dd>
<p>Adding cache stores allows you to persist data to non-volatile storage so it
survives restarts.</p>
</dd>
<dt class="hdlist1">Write-through caching</dt>
<dd>
<p>Configuring Infinispan as a caching layer in front of persistent storage
simplifies data access for applications because Infinispan handles all
interactions with the external storage.</p>
</dd>
<dt class="hdlist1">Data overflow</dt>
<dd>
<p>Using eviction and passivation techniques ensures that Infinispan keeps only
frequently used data in-memory and writes older entries to persistent storage.</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="cache_stores"><a class="anchor" href="#cache_stores"></a>8.1. Infinispan Cache Stores</h3>
<div class="paragraph">
<p>Cache stores connect Infinispan to persistent data sources and implement the
<code>NonBlockingStore</code> interface.</p>
</div>
<div class="sect3">
<h4 id="configuring_cache_stores-persistence"><a class="anchor" href="#configuring_cache_stores-persistence"></a>8.1.1. Configuring Cache Stores</h4>
<div class="paragraph">
<p>Add cache stores to Infinispan caches in a chain either declaratively or
programmatically. Cache read operations check each cache store in the
configured order until they locate a valid non-null element of data. Write
operations affect all cache stores except for those that you configure as read
only.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Use the <code>persistence</code> parameter to configure the persistence layer for caches.</p>
</li>
<li>
<p>Configure whether cache stores are local to the node or shared across the cluster.</p>
<div class="paragraph">
<p>Use either the <code>shared</code> attribute declaratively or the <code>shared(false)</code> method programmatically.</p>
</div>
</li>
<li>
<p>Configure other cache stores properties as appropriate. Custom cache stores can also include <code>property</code> parameters.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Configuring cache stores as shared or not shared (local only) determines which
parameters you should set. In some cases, using the wrong combination of
parameters in your cache store configuration can lead to data loss or
performance issues.</p>
</div>
<div class="paragraph">
<p>For example, if the cache store is local to a node then it makes sense to fetch
state and purge on startup. However, if the cache store is shared, then you
should not fetch state or purge on startup.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Local (non-shared) file store</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="comment">&lt;!-- note that class is missing and is induced by the fileStore element name --&gt;</span>
<span class="tag">&lt;file-store</span>
           <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;write-behind</span> <span class="attribute-name">modification-queue-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
 <span class="tag">&lt;/file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Shared custom cache store</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCustomStore</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;store</span>
         <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.acme.CustomStore</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preload</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">segmented</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

         <span class="tag">&lt;write-behind</span> <span class="attribute-name">modification-queue-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

         <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${system.property}<span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;/store&gt;</span>
   <span class="tag">&lt;/persistence&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Single file store</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence()
      .passivation(<span class="predefined-constant">false</span>)
      .addSingleFileStore()
         .preload(<span class="predefined-constant">true</span>)
         .shared(<span class="predefined-constant">false</span>)
         .fetchPersistentState(<span class="predefined-constant">true</span>)
         .ignoreModifications(<span class="predefined-constant">false</span>)
         .purgeOnStartup(<span class="predefined-constant">true</span>)
         .location(<span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">java.io.tmpdir</span><span class="delimiter">&quot;</span></span>))
         .async()
            .enabled(<span class="predefined-constant">true</span>)</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/">Infinispan Configuration Schema</a></p>
</li>
<li>
<p><a href="#cache_store_implementations">Infinispan Cache Store Implementations</a></p>
</li>
<li>
<p><a href="#create_custom_cache_store">Creating Custom Cache Stores</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="setting_persistent_location-persistence"><a class="anchor" href="#setting_persistent_location-persistence"></a>8.1.2. Setting a Global Persistent Location for File-Based Cache Stores</h4>
<div class="paragraph">
<p>Infinispan uses a global filesystem location for saving data to persistent
storage.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The global persistent location must be unique to each Infinispan instance. To
share data between multiple instances, use a shared persistent location.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Infinispan servers use the <code>$ISPN_HOME/server/data</code> directory as the global
persistent location.</p>
</div>
<div class="paragraph">
<p>If you are using Infinispan as a library embedded in custom applications and global-state is enabled, the
global persistent location defaults to the <code>user.dir</code> system property. This
system property typically uses the directory where your application starts. You
should configure a global persistent location to use a suitable location.</p>
</div>
<div class="listingblock">
<div class="title">Declarative configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;global-state&gt;</span>
      <span class="tag">&lt;persistent-location</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">example</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">relative-to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my.data</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/global-state&gt;</span>
   ...
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="keyword">new</span> GlobalConfigurationBuilder().globalState().enable().persistentLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">example</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">my.data</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">File-Based Cache Stores and Global Persistent Location</div>
<p>When using file-based cache stores, you can optionally specify filesystem
directories for storage. Unless absolute paths are declared, directories are
always relative to the global persistent location.</p>
</div>
<div class="paragraph">
<p>For example, you configure your global persistent location as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;global-state&gt;</span>
   <span class="tag">&lt;persistent-location</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/example</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">relative-to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my.data</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/global-state&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You then configure a Single File cache store that uses a path named
<code>myDataStore</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;file-store</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myDataStore</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the configuration results in a Single File cache store in <code>/tmp/example/myDataStore/myCache.dat</code></p>
</div>
<div class="paragraph">
<p>If you attempt to set an absolute path that resides outside the global
persistent location and global-state is enabled, Infinispan throws the following exception:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ISPN000558: "The store location 'foo' is not a child of the global persistent location 'bar'"</pre>
</div>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/">Infinispan configuration schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/global/GlobalStateConfiguration.html">org.infinispan.configuration.global.GlobalStateConfiguration</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="passivation"><a class="anchor" href="#passivation"></a>8.1.3. Passivation</h4>
<div class="paragraph">
<p>Passivation configures Infinispan to write entries to cache stores when it
evicts those entries from memory. In this way, passivation ensures that only a
single copy of an entry is maintained, either in-memory or in a cache store,
which prevents unnecessary and potentially expensive writes to persistent
storage.</p>
</div>
<div class="paragraph">
<p>Activation is the process of restoring entries to memory from the cache store
when there is an attempt to access passivated entries. For this reason, when you
enable passivation, you must configure cache stores that implement both
<code>CacheWriter</code> and <code>CacheLoader</code> interfaces so they can write and load entries
from persistent storage.</p>
</div>
<div class="paragraph">
<p>When Infinispan evicts an entry from the cache, it notifies cache listeners
that the entry is passivated then stores the entry in the cache store. When
Infinispan gets an access request for an evicted entry, it lazily loads the
entry from the cache store into memory and then notifies cache listeners that
the entry is activated.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Passivation uses the first cache loader in the Infinispan configuration and
ignores all others.</p>
</li>
<li>
<p>Passivation is not supported with:</p>
<div class="ulist">
<ul>
<li>
<p>Transactional stores. Passivation writes and removes entries from the store
outside the scope of the actual Infinispan commit boundaries.</p>
</li>
<li>
<p>Shared stores. Shared cache stores require entries to always exist in the
store for other owners. For this reason, passivation is not supported because
entries cannot be removed.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you enable passivation with transactional stores or shared stores,
Infinispan throws an exception.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="passivation_behavior"><a class="anchor" href="#passivation_behavior"></a>Passivation and Cache Stores</h5>
<div class="paragraph">
<div class="title">Passivation disabled</div>
<p>Writes to data in memory result in writes to persistent storage.</p>
</div>
<div class="paragraph">
<p>If Infinispan evicts data from memory, then data in persistent storage
includes entries that are evicted from memory. In this way persistent storage
is a superset of the in-memory cache.</p>
</div>
<div class="paragraph">
<p>If you do not configure eviction, then data in persistent storage provides a
copy of data in memory.</p>
</div>
<div class="paragraph">
<div class="title">Passivation enabled</div>
<p>Infinispan adds data to persistent storage only when it evicts data from
memory.</p>
</div>
<div class="paragraph">
<p>When Infinispan activates entries, it restores data in memory and deletes data
from persistent storage. In this way, data in memory and data in persistent
storage form separate subsets of the entire data set, with no intersection
between the two.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Entries in persistent storage can become stale when using shared cache stores. This occurs because Infinispan does not delete passivated entries from shared cache stores when they are activated.</p>
</div>
<div class="paragraph">
<p>Values are updated in memory but previously passivated entries remain in persistent storage with out of date values.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following table shows data in memory and in persistent storage after a
series of operations:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operation</th>
<th class="tableblock halign-left valign-top">Passivation disabled</th>
<th class="tableblock halign-left valign-top">Passivation enabled</th>
<th class="tableblock halign-left valign-top">Passivation enabled with shared cache store</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Insert k1.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> k1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> -</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> -</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Insert k2.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1, k2<br>
<strong>Disk:</strong> k1, k2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1, k2<br>
<strong>Disk:</strong> -</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1, k2<br>
<strong>Disk:</strong> -</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eviction thread runs and evicts k1.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k2<br>
<strong>Disk:</strong> k1, k2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k2<br>
<strong>Disk:</strong> k1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k2<br>
<strong>Disk:</strong> k1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read k1.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1, k2<br>
<strong>Disk:</strong> k1, k2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1, k2<br>
<strong>Disk:</strong> -</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1, k2<br>
<strong>Disk:</strong> k1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eviction thread runs and evicts k2.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> k1, k2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> k2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> k1, k2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove k2.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> k1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> -</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Memory:</strong> k1<br>
<strong>Disk:</strong> k1</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cache_loaders_transactional"><a class="anchor" href="#cache_loaders_transactional"></a>8.1.4. Cache Loaders and Transactional Caches</h4>
<div class="paragraph">
<p>Only JDBC String-Based cache stores support transactional operations. If you
configure caches as transactional, you should set <code>transactional=true</code> to keep
data in persistent storage synchronized with data in memory.</p>
</div>
<div class="paragraph">
<p>For all other cache stores, Infinispan does not enlist cache loaders in
transactional operations. This can result in data inconsistency if transactions
succeed in modifying data in memory but do not completely apply changes to data
in the cache store. In this case manual recovery does not work with cache
stores.</p>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="#jdbc_cache_store">JDBC String-Based Cache Stores</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="segmented_cache_stores"><a class="anchor" href="#segmented_cache_stores"></a>8.1.5. Segmented Cache Stores</h4>
<div class="paragraph">
<p>Cache stores can organize data into hash space segments to which keys map.</p>
</div>
<div class="paragraph">
<p>Segmented stores increase read performance for bulk operations; for example,
streaming over data (<code>Cache.size</code>, <code>Cache.entrySet.stream</code>), pre-loading the
cache, and doing state transfer operations.</p>
</div>
<div class="paragraph">
<p>However, segmented stores can also result in loss of performance for write
operations. This performance loss applies particularly to batch write
operations that can take place with transactions or write-behind stores. For
this reason, you should evaluate the overhead for write operations before you
enable segmented stores. The performance gain for bulk read operations might
not be acceptable if there is a significant performance loss for write
operations.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The number of segments you configure for cache stores must match the number of
segments you define in the Infinispan configuration with the
<code>clustering.hash.numSegments</code> parameter.</p>
</div>
<div class="paragraph">
<p>If you change the <code>numSegments</code> parameter in the configuration after you add a
segmented cache store, Infinispan cannot read data from that cache store.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="#key_ownership">Key Ownership</a></p>
</div>
</div>
<div class="sect3">
<h4 id="file_stores"><a class="anchor" href="#file_stores"></a>8.1.6. Filesystem-Based Cache Stores</h4>
<div class="paragraph">
<p>In most cases, filesystem-based cache stores are appropriate for local cache
stores for data that overflows from memory because it exceeds size and/or time
restrictions.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You should not use filesystem-based cache stores on shared file systems such as
an NFS, Microsoft Windows, or Samba share. Shared file systems do not provide
file locking capabilities, which can lead to data corruption.</p>
</div>
<div class="paragraph">
<p>Likewise, shared file systems are not transactional. If you attempt to use
transactional caches with shared file systems, unrecoverable failures can
happen when writing to files during the commit phase.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="write_through"><a class="anchor" href="#write_through"></a>8.1.7. Write-Through</h4>
<div class="paragraph">
<p>Write-Through is a cache writing mode where writes to memory and writes to
cache stores are synchronous. When a client application updates a cache entry,
in most cases by invoking <code>Cache.put()</code>, Infinispan does not return the call
until it updates the cache store. This cache writing mode results in updates to
the cache store concluding within the boundaries of the client thread.</p>
</div>
<div class="paragraph">
<p>The primary advantage of Write-Through mode is that the cache and cache store
are updated simultaneously, which ensures that the cache store is always
consistent with the cache.</p>
</div>
<div class="paragraph">
<p>However, Write-Through mode can potentially decrease performance because the
need to access and update cache stores directly adds latency to cache
operations.</p>
</div>
<div class="paragraph">
<p>Infinispan defaults to Write-Through mode unless you explicitly configure
Write-Behind mode on cache stores.</p>
</div>
<div class="listingblock">
<div class="title">Write-through configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;file-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="#write_behind">Write-Behind</a></p>
</div>
</div>
<div class="sect3">
<h4 id="write_behind"><a class="anchor" href="#write_behind"></a>8.1.8. Write-Behind</h4>
<div class="paragraph">
<p>Write-Behind is a cache writing mode where writes to memory are synchronous
and writes to cache stores are asynchronous.</p>
</div>
<div class="paragraph">
<p>When clients send write requests, Infinispan adds those operations to a
modification queue. Infinispan processes operations as they join the queue so
that the calling thread is not blocked and the operation completes immediately.</p>
</div>
<div class="paragraph">
<p>If the number of write operations in the modification queue increases beyond
the size of the queue, Infinispan adds those additional operations to the
queue. However, those operations do not complete until Infinispan processes
operations that are already in the queue.</p>
</div>
<div class="paragraph">
<p>For example, calling <code>Cache.putAsync</code> returns immediately and the Stage also
completes immediately if the modification queue is not full. If the
modification queue is full, or if Infinispan is currently processing a batch
of write operations, then <code>Cache.putAsync</code> returns immediately and the Stage
completes later.</p>
</div>
<div class="paragraph">
<p>Write-Behind mode provides a performance advantage over Write-Through mode
because cache operations do not need to wait for updates to the underlying cache
store to complete. However, data in the cache store remains inconsistent with
data in the cache until the modification queue is processed. For this reason,
Write-Behind mode is suitable for cache stores with low latency, such as
unshared and local filesystem-based cache stores, where the time between the
write to the cache and the write to the cache store is as small as possible.</p>
</div>
<div class="listingblock">
<div class="title">Write-behind configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;file-store</span> <span class="attribute-name">fetch-state</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">purge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${java.io.tmpdir}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;write-behind</span> <span class="attribute-name">modification-queue-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">fail-silently</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding configuration example uses the <code>fail-silently</code> parameter to
control what happens when either the cache store is unavailable or the
modification queue is full.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If <code>fail-silently="true"</code> then Infinispan logs WARN messages and rejects
write operations.</p>
</li>
<li>
<p>If <code>fail-silently="false"</code> then Infinispan throws exceptions if it detects
the cache store is unavailable during a write operation. Likewise if the
modification queue becomes full, Infinispan throws an exception.</p>
<div class="paragraph">
<p>In some cases, data loss can occur if Infinispan restarts and write operations
exist in the modification queue. For example the cache store goes offline but,
during the time it takes to detect that the cache store is unavailable, write
operations are added to the modification queue because it is not full. If
Infinispan restarts or otherwise becomes unavailable before the cache store
comes back online, then the write operations in the modification queue are lost
because they were not persisted.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="#write_through">Write-Through</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cache_store_implementations"><a class="anchor" href="#cache_store_implementations"></a>8.2. Cache Store Implementations</h3>
<div class="paragraph">
<p>Infinispan provides several cache store implementations that you can use.
Alternatively you can provide custom cache stores.</p>
</div>
<div class="sect3">
<h4 id="cluster_cache_loader"><a class="anchor" href="#cluster_cache_loader"></a>8.2.1. Cluster Cache Loaders</h4>
<div class="paragraph">
<p><code>ClusterCacheLoader</code> retrieves data from other Infinispan cluster members but
does not persist data. In other words, <code>ClusterCacheLoader</code> is not a cache
store.</p>
</div>
<div class="paragraph">
<p><code>ClusterCacheLoader</code> provides a non-blocking partial alternative to state
transfer. <code>ClusterCacheLoader</code> fetches keys from other nodes on demand if those
keys are not available on the local node, which is similar to lazily loading
cache content.</p>
</div>
<div class="paragraph">
<p>The following points also apply to <code>ClusterCacheLoader</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Preloading does not take effect (<code>preload=true</code>).</p>
</li>
<li>
<p>Fetching persistent state is not supported (<code>fetch-state=true</code>).</p>
</li>
<li>
<p>Segmentation is not supported.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The <code>ClusterLoader</code> has been deprecated and will be removed in a future release.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Declarative configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;cluster-loader</span> <span class="attribute-name">remote-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatic configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addClusterLoader()
    .remoteCallTimeout(<span class="integer">500</span>);</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/infinispan-config-12.0.html">Infinispan configuration schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/cluster/ClusterLoader.html">ClusterLoader</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/configuration/cache/ClusterLoaderConfiguration.html">ClusterLoaderConfiguration</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="sfs_cache_store"><a class="anchor" href="#sfs_cache_store"></a>8.2.2. Single File Cache Stores</h4>
<div class="paragraph">
<p>Single File cache stores, <code>SingleFileStore</code>, persist data to file. Infinispan
also maintains an in-memory index of keys while keys and values are stored in
the file. By default, Single File cache stores are segmented, which means that
Infinispan creates a separate file for each segment.</p>
</div>
<div class="paragraph">
<p>Because <code>SingleFileStore</code> keeps an in-memory index of keys and the location of
values, it requires additional memory, depending on the key size and the number
of keys. For this reason, <code>SingleFileStore</code> is not recommended for use cases
where the keys have a large size.</p>
</div>
<div class="paragraph">
<p>In some cases, <code>SingleFileStore</code> can also become fragmented. If the size of
values continually increases, available space in the single file is not used
but the entry is appended to the end of the file. Available space in the file
is used only if an entry can fit within it. Likewise, if you remove all entries
from memory, the single file store does not decrease in size or become
defragmented.</p>
</div>
<div class="listingblock">
<div class="title">Declarative configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
 <span class="tag">&lt;file-store</span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Programmatic configuration</div>
<ul>
<li>
<p>For embedded deployments, do the following:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addSingleFileStore()
    .maxEntries(<span class="integer">5000</span>);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For server deployments, do the following:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.NearCacheMode</span>;
...

ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder
  .remoteCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span>)
    .configuration(<span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;infinispan&gt;&lt;cache-container&gt;&lt;distributed-cache name=</span><span class="char">\&quot;</span><span class="content">mycache</span><span class="char">\&quot;</span><span class="content">&gt;&lt;persistence&gt;&lt;file-store max-entries=</span><span class="char">\&quot;</span><span class="content">5000</span><span class="char">\&quot;</span><span class="content">/&gt;&lt;/persistence&gt;&lt;/distributed-cache&gt;&lt;/cache-container&gt;&lt;/infinispan&gt;</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Segmentation</div>
<p>Single File cache stores support segmentation and create a separate
instance per segment, which results in multiple directories in the path you
configure. Each directory is a number that represents the segment to which the
data maps.</p>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="#setting_persistent_location-persistence">Setting a Global Persistent Location</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/infinispan-config-12.0.html">Infinispan configuration schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/file/SingleFileStore.html">SingleFileStore</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="jdbc_cache_store"><a class="anchor" href="#jdbc_cache_store"></a>8.2.3. JDBC String-Based Cache Stores</h4>
<div class="paragraph">
<p>JDBC String-Based cache stores, <code>JdbcStringBasedStore</code>, use JDBC drivers to load and store values in the underlying database.</p>
</div>
<div class="paragraph">
<p><code>JdbcStringBasedStore</code> stores each entry in its own row in the table to
increase throughput for concurrent loads. <code>JdbcStringBasedStore</code> also uses a
simple one-to-one mapping that maps each key to a <code>String</code> object using the <code>key-to-string-mapper</code> interface.</p>
</div>
<div class="paragraph">
<p>Infinispan provides a default implementation, <code>DefaultTwoWayKey2StringMapper</code>,
that handles primitive types.</p>
</div>
<div class="paragraph">
<p>In addition to the data table used to store cache entries, the store also creates a <code>_META</code> table for storing metadata.
This table is used to ensure that any existing database content is compatible with the current Infinispan version and configuration.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default Infinispan shares are not stored, which means that all nodes in the
cluster write to the underlying store on each update. If you want operations to
write to the underlying database once only, you must configure JDBC store as
shared.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Segmentation</div>
<p><code>JdbcStringBasedStore</code> uses segmentation by default and requires a column in
the database table to represent the segments to which entries belong.</p>
</div>
<div class="sect4">
<h5 id="jdbc_connection_pooling"><a class="anchor" href="#jdbc_connection_pooling"></a>Connection Factories</h5>
<div class="paragraph">
<p><code>JdbcStringBasedStore</code> relies on a <code>ConnectionFactory</code> implementation to connection to a database.</p>
</div>
<div class="paragraph">
<p>Infinispan provides the following <code>ConnectionFactory</code> implementations:</p>
</div>
<div class="paragraph">
<div class="title"><code>PooledConnectionFactoryConfigurationBuilder</code></div>
<p>A connection factory based on Agroal that you configure via <code>PooledConnectionFactoryConfiguration</code>.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can specify configuration properties prefixed with <code>org.infinispan.agroal.</code> as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="properties">org.infinispan.agroal.metricsEnabled=false

org.infinispan.agroal.minSize=10
org.infinispan.agroal.maxSize=100
org.infinispan.agroal.initialSize=20
org.infinispan.agroal.acquisitionTimeout_s=1
org.infinispan.agroal.validationTimeout_m=1
org.infinispan.agroal.leakTimeout_s=10
org.infinispan.agroal.reapTimeout_m=10

org.infinispan.agroal.metricsEnabled=false
org.infinispan.agroal.autoCommit=true
org.infinispan.agroal.jdbcTransactionIsolation=READ_COMMITTED
org.infinispan.agroal.jdbcUrl=jdbc:h2:mem:PooledConnectionFactoryTest;DB_CLOSE_DELAY=-1
org.infinispan.agroal.driverClassName=org.h2.Driver.class
org.infinispan.agroal.principal=sa
org.infinispan.agroal.credential=sa</code></pre>
</div>
</div>
<div class="paragraph">
<p>You then configure Infinispan to use your properties file via
<code>PooledConnectionFactoryConfiguration.propertyFile</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You should use <code>PooledConnectionFactory</code> with standalone deployments, rather
than deployments in servlet containers.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title"><code>ManagedConnectionFactoryConfigurationBuilder</code></div>
<p>A connection factory that you can can use with managed environments such as
application servers. This connection factory can explore a configurable
location in the JNDI tree and delegate connection management to the
<code>DataSource</code>.</p>
</div>
<div class="paragraph">
<div class="title"><code>SimpleConnectionFactoryConfigurationBuilder</code></div>
<p>A connection factory that creates database connections on a per invocation basis. You should use this connection factory for test or development
environments only.</p>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://agroal.github.io/">Agroal</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/jdbc/configuration/ConnectionFactoryConfigurationBuilder.html">ConnectionFactoryConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/jdbc/configuration/PooledConnectionFactoryConfigurationBuilder.html">PooledConnectionFactoryConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/jdbc/configuration/ManagedConnectionFactoryConfigurationBuilder.html">ManagedConnectionFactoryConfigurationBuilder</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/jdbc/configuration/SimpleConnectionFactoryConfigurationBuilder.html">SimpleConnectionFactoryConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="jdbc_cache_store_config"><a class="anchor" href="#jdbc_cache_store_config"></a>JDBC String-Based Cache Store Configuration</h5>
<div class="paragraph">
<p>You can configure <code>JdbcStringBasedStore</code> programmatically or declaratively.</p>
</div>
<div class="ulist">
<div class="title">Declarative configuration</div>
<ul>
<li>
<p>Using <code>PooledConnectionFactory</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;string-keyed-jdbc-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:jdbc:12.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;connection-pool</span> <span class="attribute-name">connection-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_string_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">driver</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;segment-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SEGMENT_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">INT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;/string-keyed-table&gt;</span>
   <span class="tag">&lt;/string-keyed-jdbc-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Using <code>ManagedConnectionFactory</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
  <span class="tag">&lt;string-keyed-jdbc-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:jdbc:12.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shared</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;data-source</span> <span class="attribute-name">jndi-url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/StringStoreWithManagedConnectionTest/DS</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;string-keyed-table</span> <span class="attribute-name">drop-on-exit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">create-on-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;id-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;data-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;timestamp-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;segment-column</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SEGMENT_COLUMN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">INT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/string-keyed-table&gt;</span>
  <span class="tag">&lt;/string-keyed-jdbc-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Programmatic configuration</div>
<ul>
<li>
<p>Using <code>PooledConnectionFactory</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence().addStore(JdbcStringBasedStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>)
      .ignoreModifications(<span class="predefined-constant">false</span>)
      .purgeOnStartup(<span class="predefined-constant">false</span>)
      .shared(<span class="predefined-constant">true</span>)
      .table()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
         .segmentColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">SEGMENT_COLUMN</span><span class="delimiter">&quot;</span></span>).segmentColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">INT</span><span class="delimiter">&quot;</span></span>)
      .connectionPool()
         .connectionUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:infinispan_string_based;DB_CLOSE_DELAY=-1</span><span class="delimiter">&quot;</span></span>)
         .username(<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>)
         .driverClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.h2.Driver</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Using <code>ManagedConnectionFactory</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.persistence().addStore(JdbcStringBasedStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>)
      .ignoreModifications(<span class="predefined-constant">false</span>)
      .purgeOnStartup(<span class="predefined-constant">false</span>)
      .shared(<span class="predefined-constant">true</span>)
      .table()
         .dropOnExit(<span class="predefined-constant">true</span>)
         .createOnStart(<span class="predefined-constant">true</span>)
         .tableNamePrefix(<span class="string"><span class="delimiter">&quot;</span><span class="content">ISPN_STRING_TABLE</span><span class="delimiter">&quot;</span></span>)
         .idColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID_COLUMN</span><span class="delimiter">&quot;</span></span>).idColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">VARCHAR(255)</span><span class="delimiter">&quot;</span></span>)
         .dataColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">DATA_COLUMN</span><span class="delimiter">&quot;</span></span>).dataColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BINARY</span><span class="delimiter">&quot;</span></span>)
         .timestampColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">TIMESTAMP_COLUMN</span><span class="delimiter">&quot;</span></span>).timestampColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">BIGINT</span><span class="delimiter">&quot;</span></span>)
         .segmentColumnName(<span class="string"><span class="delimiter">&quot;</span><span class="content">SEGMENT_COLUMN</span><span class="delimiter">&quot;</span></span>).segmentColumnType(<span class="string"><span class="delimiter">&quot;</span><span class="content">INT</span><span class="delimiter">&quot;</span></span>)
      .dataSource()
         .jndiUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">java:/StringStoreWithManagedConnectionTest/DS</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/infinispan-cachestore-jdbc-config-12.0.html">JDBC cache store configuration schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.html">JdbcStringBasedStore</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/jdbc/configuration/JdbcStringBasedStoreConfiguration.html">JdbcStringBasedStoreConfiguration</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jpa_cache_store"><a class="anchor" href="#jpa_cache_store"></a>8.2.4. JPA Cache Stores</h4>
<div class="paragraph">
<p>JPA (Java Persistence API) cache stores, <code>JpaStore</code>, use formal schema to
persist data. Other applications can then read from persistent storage to load
data from Infinispan. However, other applications should not use persistent
storage concurrently with Infinispan.</p>
</div>
<div class="paragraph">
<p>When using <code>JpaStore</code>, you should take the following into consideration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keys should be the ID of the entity. Values should be the entity object.</p>
</li>
<li>
<p>Only a single <code>@Id</code> or <code>@EmbeddedId</code> annotation is allowed.</p>
</li>
<li>
<p>Auto-generated IDs with the <code>@GeneratedValue</code> annotation are not supported.</p>
</li>
<li>
<p>All entries are stored as immortal.</p>
</li>
<li>
<p><code>JpaStore</code> does not support segmentation.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Declarative configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vehicleCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;persistence</span> <span class="attribute-name">passivation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;jpa-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:jpa:12.0</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">persistence-unit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.persistence.jpa.configurationTest</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">entity-class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.persistence.jpa.entity.Vehicle</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                /<span class="error">&gt;</span>
   <span class="tag">&lt;/persistence&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>persistence-unit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the JPA persistence unit name in the JPA configuration file, <code>persistence.xml</code>, that contains the JPA entity class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entity-class</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the fully qualified JPA entity class name that is expected to be stored in this cache. Only one class is allowed.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Programmatic configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
             .addStore(JpaStoreConfigurationBuilder.class)
             .persistenceUnitName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.loaders.jpa.configurationTest</span><span class="delimiter">&quot;</span></span>)
             .entityClass(User.class)
             .build();</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>persistenceUnitName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the JPA persistence unit name in the JPA configuration file, <code>persistence.xml</code>, that contains the JPA entity class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entityClass</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the fully qualified JPA entity class name that is expected to be stored in this cache. Only one class is allowed.</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/infinispan-cachestore-jpa-config-12.0.html">JPA cache store configuration schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/jpa/JpaStore.html">JpaStore</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/jpa/configuration/JpaStoreConfiguration.html">JpaStoreConfiguration</a></p>
</li>
<li>
<p><a href="https://github.com/infinispan/infinispan/blob/master/persistence/jpa/src/test/java/org/infinispan/persistence/jpa/configuration/JpaConfigurationTest.java">JPA Cache Store test</a></p>
</li>
<li>
<p><a href="https://github.com/infinispan/infinispan/blob/master/persistence/jpa/src/test/resources/config/jpa-config.xml">JPA Cache Store test configuration</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="jpa_cache_store_usage_example"><a class="anchor" href="#jpa_cache_store_usage_example"></a>JPA Cache Store Usage Example</h5>
<div class="paragraph">
<p>This section provides an example for using JPA cache stores.</p>
</div>
<div class="ulist">
<div class="title">Prerequistes</div>
<ul>
<li>
<p>Configure Infinispan to marshall your JPA entities. By default, Infinispan
uses ProtoStream for marshalling Java objects. To marshall JPA entities, you
must create a <code>SerializationContextInitializer</code> implementation that registers a
<code>.proto</code> schema and marshaller with a <code>SerializationContext</code>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Define a persistence unit "myPersistenceUnit" in <code>persistence.xml</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myPersistenceUnit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
<span class="tag">&lt;/persistence-unit&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Create a user entity class.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
        <span class="annotation">@Id</span>
        <span class="directive">private</span> <span class="predefined-type">String</span> username;
        <span class="directive">private</span> <span class="predefined-type">String</span> firstName;
        <span class="directive">private</span> <span class="predefined-type">String</span> lastName;

        ...
}</code></pre>
</div>
</div>
</li>
<li>
<p>Configure a cache named "usersCache" with a JPA cache store.</p>
<div class="paragraph">
<p>Then you can configure a cache "usersCache" to use JPA Cache Store, so that when you put data into the cache, the data would be persisted into the database based on JPA configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager cacheManager = ...;

<span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
            .addStore(JpaStoreConfigurationBuilder.class)
            .persistenceUnitName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.loaders.jpa.configurationTest</span><span class="delimiter">&quot;</span></span>)
            .entityClass(User.class)
            .build();
cacheManager.defineCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">usersCache</span><span class="delimiter">&quot;</span></span>, cacheConfig);

Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">usersCache</span><span class="delimiter">&quot;</span></span>);
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User(...));</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Caches that use a JPA cache store can store one type of data only, as in the
following example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myJPACache</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// Cache is configured for the User entity class</span>
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User());
<span class="comment">// Cannot configure caches to use another entity class with JPA cache stores</span>
Cache&lt;<span class="predefined-type">Integer</span>, Teacher&gt; teachersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myJPACache</span><span class="delimiter">&quot;</span></span>);
teachersCache.put(<span class="integer">1</span>, <span class="keyword">new</span> Teacher());
<span class="comment">// The put request does not work for the Teacher entity class</span></code></pre>
</div>
</div>
</li>
<li>
<p>The <code>@EmbeddedId</code> annotation allows you to use composite keys, as in the
following example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Vehicle</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
        <span class="annotation">@EmbeddedId</span>
        <span class="directive">private</span> VehicleId id;
        <span class="directive">private</span> <span class="predefined-type">String</span> color;        ...
}

<span class="annotation">@Embeddable</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">VehicleId</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span>
{
        <span class="directive">private</span> <span class="predefined-type">String</span> state;
        <span class="directive">private</span> <span class="predefined-type">String</span> licensePlate;
        ...
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">References</div>
<ul>
<li>
<p><a href="../developing/developing.html#protostream_cm_config">Using the ProtoStream Marshaller</a></p>
</li>
<li>
<p><a href="../developing/developing.html#protostream">Marshalling Custom Java Objects with ProtoStream</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="remote_cache_store"><a class="anchor" href="#remote_cache_store"></a>8.2.5. Remote Cache Stores</h4>
<div class="paragraph">
<p>Remote cache stores, <code>RemoteStore</code>, use the Hot Rod protocol to store data on
Infinispan clusters.</p>
</div>
<div class="paragraph">
<p>The following is an example <code>RemoteStore</code> configuration that stores data in a
cache named "mycache" on two Infinispan Server instances, named "one" and
"two":</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you configure remote cache stores as shared you cannot preload data. In
other words if <code>shared="true"</code> in your configuration then you must set
<code>preload="false"</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Declarative configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
   <span class="tag">&lt;remote-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:remote:12.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">raw-values</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;remote-server</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">12111</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;remote-server</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">two</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;connection-pool</span> <span class="attribute-name">max-active</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exhausted-action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE_NEW</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;write-behind</span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/remote-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatic configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence().addStore(RemoteStoreConfigurationBuilder.class)
      .fetchPersistentState(<span class="predefined-constant">false</span>)
      .ignoreModifications(<span class="predefined-constant">false</span>)
      .purgeOnStartup(<span class="predefined-constant">false</span>)
      .remoteCacheName(<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span>)
      .rawValues(<span class="predefined-constant">true</span>)
.addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>).port(<span class="integer">12111</span>)
      .addServer()
      .host(<span class="string"><span class="delimiter">&quot;</span><span class="content">two</span><span class="delimiter">&quot;</span></span>)
      .connectionPool()
      .maxActive(<span class="integer">10</span>)
      .exhaustedAction(ExhaustedAction.CREATE_NEW)
      .async().enable();</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Segmentation</div>
<p><code>RemoteStore</code> supports segmentation and can publish keys and entries by
segment, which makes bulk operations more efficient. However, segmentation is
available only with Infinispan Hot Rod protocol version 2.3 or later.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you enable segmentation for <code>RemoteStore</code>, it uses the number of segments
that you define in your Infinispan server configuration.</p>
</div>
<div class="paragraph">
<p>If the source cache is segmented and uses a different number of segments than
<code>RemoteStore</code>, then incorrect values are returned for bulk operations. In this
case, you should disable segmentation for <code>RemoteStore</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/infinispan-cachestore-remote-config-12.0.html">Remote cache store configuration schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/remote/RemoteStore.html">RemoteStore</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/remote/configuration/RemoteStoreConfigurationBuilder.html">RemoteStoreConfigurationBuilder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="rocksdb_cache_store"><a class="anchor" href="#rocksdb_cache_store"></a>8.2.6. RocksDB Cache Stores</h4>
<div class="paragraph">
<p>RocksDB provides key-value filesystem-based storage with high performance and
reliability for highly concurrent environments.</p>
</div>
<div class="paragraph">
<p>RocksDB cache stores, <code>RocksDBStore</code>, use two databases. One database provides
a primary cache store for data in memory; the other database holds entries that
Infinispan expires from memory.</p>
</div>
<div class="listingblock">
<div class="title">Declarative configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vehicleCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;persistence&gt;</span>
      <span class="tag">&lt;rocksdb-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:rocksdb:12.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rocksdb/data</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;expiration</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rocksdb/expired</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/rocksdb-store&gt;</span>
   <span class="tag">&lt;/persistence&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatic configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
                                .addStore(RocksDBStoreConfigurationBuilder.class)
                                .build();
EmbeddedCacheManager cacheManager = <span class="keyword">new</span> DefaultCacheManager(cacheConfig);

Cache&lt;<span class="predefined-type">String</span>, User&gt; usersCache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">usersCache</span><span class="delimiter">&quot;</span></span>);
usersCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">raytsang</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User(...));</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Properties</span> props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">database.max_background_compactions</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>);
props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">data.write_buffer_size</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">512MB</span><span class="delimiter">&quot;</span></span>);

<span class="predefined-type">Configuration</span> cacheConfig = <span class="keyword">new</span> ConfigurationBuilder().persistence()
                                .addStore(RocksDBStoreConfigurationBuilder.class)
                                .location(<span class="string"><span class="delimiter">&quot;</span><span class="content">rocksdb/data</span><span class="delimiter">&quot;</span></span>)
                                .expiredLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">rocksdb/expired</span><span class="delimiter">&quot;</span></span>)
        .properties(props)
                                .build();</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. <code>RocksDBStore</code> configuration parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the path to the RocksDB database that provides the primary cache
store. If you do not set the location, it is automatically created. Note that
the path must be relative to the global persistent location.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>expiredLocation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the path to the RocksDB database that provides the cache store for
expired data. If you do not set the location, it is automatically created. Note
that the path must be relative to the global persistent location.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>expiryQueueSize</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the size of the in-memory queue for expiring entries. When the queue
reaches the size, Infinispan flushes the expired into the RocksDB cache store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clearThreshold</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the maximum number of entries before deleting and re-initializing
(<strong>re-init</strong>) the RocksDB database. For smaller size cache stores, iterating
through all entries and removing each one individually can provide a faster
method.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">RocksDB tuning parameters</div>
<p>You can also specify the following RocksDB tuning parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>compressionType</code></p>
</li>
<li>
<p><code>blockSize</code></p>
</li>
<li>
<p><code>cacheSize</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">RocksDB configuration properties</div>
<p>Optionally set properties in the configuration as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Prefix properties with <code>database</code> to adjust and tune RocksDB databases.</p>
</li>
<li>
<p>Prefix properties with <code>data</code> to configure the column families in which RocksDB stores your data.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;property name="database.max_background_compactions"&gt;2&lt;/property&gt;
&lt;property name="data.write_buffer_size"&gt;64MB&lt;/property&gt;
&lt;property name="data.compression_per_level"&gt;kNoCompression:kNoCompression:kNoCompression:kSnappyCompression:kZSTD:kZSTD&lt;/property&gt;</pre>
</div>
</div>
<div class="paragraph">
<div class="title">Segmentation</div>
<p><code>RocksDBStore</code> supports segmentation and creates a separate column family per
segment. Segmented RocksDB cache stores improve lookup performance
and iteration but slightly lower performance of write operations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You should not configure more than a few hundred segments. RocksDB is not
designed to have an unlimited number of column families. Too many segments also
significantly increases cache store start time.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/infinispan-cachestore-rocksdb-config-12.0.html">RocksDB cache store configuration schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/rocksdb/RocksDBStore.html">RocksDBStore</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/rocksdb/configuration/RocksDBStoreConfiguration.html">RocksDBStoreConfiguration</a></p>
</li>
<li>
<p><a href="http://rocksdb.org/">rocksdb.org</a></p>
</li>
<li>
<p><a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide">RocksDB Tuning Guide</a></p>
</li>
<li>
<p><a href="https://github.com/infinispan/infinispan/blob/master/persistence/rocksdb/src/test/java/org/infinispan/persistence/rocksdb/config/ConfigurationTest.java">RocksDB Cache Store test</a></p>
</li>
<li>
<p><a href="https://github.com/infinispan/infinispan/tree/master/persistence/rocksdb/src/test/resources/config/">RocksDB Cache Store test configuration</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="sifs_cache_store"><a class="anchor" href="#sifs_cache_store"></a>8.2.7. Soft-Index File Stores</h4>
<div class="paragraph">
<p>Soft-Index File cache stores, <code>SoftIndexFileStore</code>, provide local file-based
storage.</p>
</div>
<div class="paragraph">
<p><code>SoftIndexFileStore</code> is a Java implementation that uses a variant of <strong>B+
Tree</strong> that is cached in-memory using Java soft references. The <strong>B+ Tree</strong>,
called <code>Index</code> is offloaded on the file system to a single file that is purged
and rebuilt each time the cache store restarts.</p>
</div>
<div class="paragraph">
<p><code>SoftIndexFileStore</code> stores data in a set of files rather than a single file.
When usage of any file drops below 50%, the entries in the file are overwritten
to another file and the file is then deleted.</p>
</div>
<div class="paragraph">
<p><code>SoftIndexFileStore</code> persists data in a set of files that are written in an
append-only method. For this reason, if you use <code>SoftIndexFileStore</code> on
conventional magnetic disk, it does not need to seek when writing a burst of
entries.</p>
</div>
<div class="paragraph">
<p>Most structures in <code>SoftIndexFileStore</code> are bounded, so out-of-memory
exceptions do not pose a risk. You can also configure limits for concurrently
open files.</p>
</div>
<div class="paragraph">
<p>By default the size of a node in the <code>Index</code> is limited to 4096 bytes. This
size also limits the key length; more precisely the length of serialized keys.
For this reason, you cannot use keys longer than the size of the node, 15
bytes. Additionally, key length is stored as "short", which limits key length
to 32767 bytes. <code>SoftIndexFileStore</code> throws an exception if keys are longer
after serialization occurs.</p>
</div>
<div class="paragraph">
<p><code>SoftIndexFileStore</code> cannot detect expired entries, which can lead to excessive
usage of space on the file system .</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>AdvancedStore.purgeExpired()</code> is not implemented in <code>SoftIndexFileStore</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Declarative configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
    <span class="tag">&lt;soft-index-file-store</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:store:soft-index:12.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;index</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">testCache/index</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;data</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">testCache/data</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/soft-index-file-store&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatic configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder b = <span class="keyword">new</span> ConfigurationBuilder();
b.persistence()
    .addStore(SoftIndexFileStoreConfigurationBuilder.class)
        .indexLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">testCache/index</span><span class="delimiter">&quot;</span></span>);
        .dataLocation(<span class="string"><span class="delimiter">&quot;</span><span class="content">testCache/data</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Segmentation</div>
<p>Soft-Index File cache stores support segmentation and create a separate
instance per segment, which results in multiple directories in the path you
configure. Each directory is a number that represents the segment to which the
data maps.</p>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/configdocs/infinispan-persistence-soft-index-config-12.0.html">Soft-Index File cache store configuration schema</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/sifs/SoftIndexFileStore.html">SoftIndexFileStore</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/sifs/configuration/SoftIndexFileStoreConfiguration.html">SoftIndexFileStoreConfiguration</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="creating_stores"><a class="anchor" href="#creating_stores"></a>8.2.8. Implementing Custom Cache Stores</h4>
<div class="paragraph">
<p>You can create custom cache stores through the Infinispan persistent SPI.</p>
</div>
<div class="sect4">
<h5 id="persistent_spi"><a class="anchor" href="#persistent_spi"></a>Infinispan Persistence SPI</h5>
<div class="paragraph">
<p>The Infinispan Service Provider Interface (SPI) enables read and write
operations to external storage through the <code>NonBlockingStore</code> interface and has
the following features:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Portability across JCache-compliant vendors</dt>
<dd>
<p>Infinispan maintains compatibility between the <code>NonBlockingStore</code> interface
and the <code>JSR-107</code> JCache specification by using an adapter that handles
blocking code.</p>
</dd>
<dt class="hdlist1">Simplified transaction integration</dt>
<dd>
<p>Infinispan automatically handles locking so your implementations do not need
to coordinate concurrent access to persistent stores. Depending on the locking
mode you use, concurrent writes to the same key generally do not occur.
However, you should expect operations on the persistent storage to originate
from multiple threads and create implementations to tolerate this behavior.</p>
</dd>
<dt class="hdlist1">Parallel iteration</dt>
<dd>
<p>Infinispan lets you iterate over entries in persistent stores with multiple
threads in parallel.</p>
</dd>
<dt class="hdlist1">Reduced serialization resulting in less CPU usage</dt>
<dd>
<p>Infinispan exposes stored entries in a serialized format that can be
transmitted remotely. For this reason, Infinispan does not need to deserialize
entries that it retrieves from persistent storage and then serialize again when
writing to the wire.</p>
</dd>
</dl>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/spi/package-summary.html">Persistence SPI</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/persistence/spi/NonBlockingStore.html">NonBlockingStore</a></p>
</li>
<li>
<p><a href="http://jcp.org/en/jsr/detail?id=107">JSR-107</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="create_custom_store"><a class="anchor" href="#create_custom_store"></a>Creating Cache Stores</h5>
<div class="paragraph">
<p>Create custom cache stores by implementing the <code>NonBlockingStore</code> interface.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Implement the appropriate Infinispan persistent SPIs.</p>
</li>
<li>
<p>Annotate your store class with the <code>@ConfiguredBy</code> annotation if it has a custom configuration.</p>
</li>
<li>
<p>Create a custom cache store configuration and builder if desired.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Extend <code>AbstractStoreConfiguration</code> and <code>AbstractStoreConfigurationBuilder</code>.</p>
</li>
<li>
<p>Optionally add the following annotations to your store Configuration class to ensure that your
custom configuration builder parses your cache store configuration from XML:</p>
<div class="ulist">
<ul>
<li>
<p><code>@ConfigurationFor</code></p>
</li>
<li>
<p><code>@BuiltBy</code></p>
<div class="paragraph">
<p>If you do not add these annotations, then <code>CustomStoreConfigurationBuilder</code> parses the common
store attributes defined in <code>AbstractStoreConfiguration</code> and any additional elements are ignored.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If a configuration does not declare the
<code>@ConfigurationFor</code> annotation, a warning message is logged when Infinispan
initializes the cache.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="configure_custom_cache_store"><a class="anchor" href="#configure_custom_cache_store"></a>Configuring Infinispan to Use Custom Stores</h5>
<div class="paragraph">
<p>After you create your custom cache store implementation, configure Infinispan
to use it.</p>
</div>
<div class="listingblock">
<div class="title">Declarative configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customStoreExample</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;persistence&gt;</span>
    <span class="tag">&lt;store</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.persistence.dummy.DummyInMemoryStore</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
  <span class="tag">&lt;/persistence&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatic configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Configuration</span> config = <span class="keyword">new</span> ConfigurationBuilder()
            .persistence()
            .addStore(CustomStoreConfigurationBuilder.class)
            .build();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="deploy_custom_cache_store"><a class="anchor" href="#deploy_custom_cache_store"></a>Deploying Custom Cache Stores</h5>
<div class="paragraph">
<p>You can package custom cache stores into JAR files and deploy them to
Infinispan servers as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Package your custom cache store implementation in a JAR file.</p>
</li>
<li>
<p>Add your JAR file to the <code>server/lib</code> directory of your Infinispan server.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cache_store_migration"><a class="anchor" href="#cache_store_migration"></a>8.3. Migrating Between Cache Stores</h3>
<div class="paragraph">
<p>Infinispan provides a utility to migrate data from one cache store to another.</p>
</div>
<div class="sect3">
<h4 id="store_migrator-configure"><a class="anchor" href="#store_migrator-configure"></a>8.3.1. Cache Store Migrator</h4>
<div class="paragraph">
<p>Infinispan provides the <code>StoreMigrator.java</code> utility that recreates data for
the latest Infinispan cache store implementations.</p>
</div>
<div class="paragraph">
<p><code>StoreMigrator</code> takes a cache store from a previous version of Infinispan as
source and uses a cache store implementation as target.</p>
</div>
<div class="paragraph">
<p>When you run <code>StoreMigrator</code>, it creates the target cache with the cache store
type that you define using the <code>EmbeddedCacheManager</code> interface. <code>StoreMigrator</code>
then loads entries from the source store into memory and then puts them into
the target cache.</p>
</div>
<div class="paragraph">
<p><code>StoreMigrator</code> also lets you migrate data from one type of cache store to
another. For example, you can migrate from a JDBC String-Based cache store to a
Single File cache store.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>StoreMigrator</code> cannot migrate data from segmented cache stores to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Non-segmented cache store.</p>
</li>
<li>
<p>Segmented cache stores that have a different number of segments.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="get_store_migrator-configure"><a class="anchor" href="#get_store_migrator-configure"></a>8.3.2. Getting the Store Migrator</h4>
<div class="paragraph">
<p><code>StoreMigrator</code> is available as part of the Infinispan tools library,
<code>infinispan-tools</code>, and is included in the Maven repository.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Configure your <code>pom.xml</code> for <code>StoreMigrator</code> as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;project</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/POM/4.0.0</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;modelVersion&gt;</span>4.0.0<span class="tag">&lt;/modelVersion&gt;</span>

    <span class="tag">&lt;groupId&gt;</span>org.infinispan.example<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jdbc-migrator-example<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span>

    <span class="tag">&lt;dependencies&gt;</span>
      <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>infinispan-tools<span class="tag">&lt;/artifactId&gt;</span>
      <span class="tag">&lt;/dependency&gt;</span>
      <span class="comment">&lt;!-- Additional dependencies --&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>

    <span class="tag">&lt;build&gt;</span>
      <span class="tag">&lt;plugins&gt;</span>
        <span class="tag">&lt;plugin&gt;</span>
          <span class="tag">&lt;groupId&gt;</span>org.codehaus.mojo<span class="tag">&lt;/groupId&gt;</span>
          <span class="tag">&lt;artifactId&gt;</span>exec-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
          <span class="tag">&lt;version&gt;</span>1.2.1<span class="tag">&lt;/version&gt;</span>
          <span class="tag">&lt;executions&gt;</span>
            <span class="tag">&lt;execution&gt;</span>
              <span class="tag">&lt;goals&gt;</span>
                <span class="tag">&lt;goal&gt;</span>java<span class="tag">&lt;/goal&gt;</span>
              <span class="tag">&lt;/goals&gt;</span>
            <span class="tag">&lt;/execution&gt;</span>
          <span class="tag">&lt;/executions&gt;</span>
          <span class="tag">&lt;configuration&gt;</span>
            <span class="tag">&lt;mainClass&gt;</span>org.infinispan.tools.store.migrator.StoreMigrator<span class="tag">&lt;/mainClass&gt;</span>
            <span class="tag">&lt;arguments&gt;</span>
              <span class="tag">&lt;argument&gt;</span>path/to/migrator.properties<span class="tag">&lt;/argument&gt;</span>
            <span class="tag">&lt;/arguments&gt;</span>
          <span class="tag">&lt;/configuration&gt;</span>
        <span class="tag">&lt;/plugin&gt;</span>
      <span class="tag">&lt;/plugins&gt;</span>
    <span class="tag">&lt;/build&gt;</span>
<span class="tag">&lt;/project&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="configure_store_migrator-configure"><a class="anchor" href="#configure_store_migrator-configure"></a>8.3.3. Configuring the Store Migrator</h4>
<div class="paragraph">
<p>Set properties for source and target cache stores in a <code>migrator.properties</code>
file.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>migrator.properties</code> file.</p>
</li>
<li>
<p>Configure the source cache store in <code>migrator.properties</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Prepend all configuration properties with <code>source.</code> as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre>source.type=SOFT_INDEX_FILE_STORE
source.cache_name=myCache
source.location=/path/to/source/sifs</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Configure the target cache store in <code>migrator.properties</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Prepend all configuration properties with <code>target.</code> as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre>target.type=SINGLE_FILE_STORE
target.cache_name=myCache
target.location=/path/to/target/sfs.dat</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="store_migrator_properties-configure"><a class="anchor" href="#store_migrator_properties-configure"></a>Store Migrator Properties</h5>
<div class="paragraph">
<p>Configure source and target cache stores in a <code>StoreMigrator</code> properties.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Cache Store Type Property</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the type of cache store type for a source or target.</p>
<p class="tableblock"><code>.type=JDBC_STRING</code></p>
<p class="tableblock"><code>.type=JDBC_BINARY</code></p>
<p class="tableblock"><code>.type=JDBC_MIXED</code></p>
<p class="tableblock"><code>.type=LEVELDB</code></p>
<p class="tableblock"><code>.type=ROCKSDB</code></p>
<p class="tableblock"><code>.type=SINGLE_FILE_STORE</code></p>
<p class="tableblock"><code>.type=SOFT_INDEX_FILE_STORE</code></p>
<p class="tableblock"><code>.type=JDBC_MIXED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Common Properties</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example Value</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cache_name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Names the cache that the store backs.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.cache_name=myCache</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>segment_count</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the number of segments for target cache stores that can use
segmentation.</p>
<p class="tableblock">The number of segments must match <code>clustering.hash.numSegments</code> in the
Infinispan configuration.</p>
<p class="tableblock">In other words, the number of segments for a cache store must match the number
of segments for the corresponding cache. If the number of segments is not the
same, Infinispan cannot read data from the cache store.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.segment_count=256</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. JDBC Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dialect</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the dialect of the underlying database.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the marshaller version for source cache stores. Set one of the following values:</p>
<p class="tableblock">* <code>8</code> for Infinispan 8.x</p>
<p class="tableblock">* <code>9</code> for Infinispan 9.x</p>
<p class="tableblock">* <code>10</code> Infinispan 10.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required for source stores only.</p>
<p class="tableblock">For example: <code>source.version=9</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>marshaller.class</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a custom marshaller class.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required if using custom marshallers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>marshaller.externalizers</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a comma-separated list of custom <code>AdvancedExternalizer</code> implementations to load in this format: <code>[id]:&lt;Externalizer class&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connection_pool.connection_url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the JDBC connection URL.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connection_pool.driver_class</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the class of the JDBC driver.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connection_pool.username</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a database username.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connection_pool.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies a password for the database username.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>db.major_version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the database major version.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>db.minor_version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the database minor version.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>db.disable_upsert</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disables database upsert.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>db.disable_indexing</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies if table indexes are created.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>table.string.table_name_prefix</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies additional prefixes for the table name.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>table.string.&lt;id|data|timestamp&gt;.name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the column name.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>table.string.&lt;id|data|timestamp&gt;.type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the column type.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>key_to_string_mapper</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the <code>TwoWayKey2StringMapper</code> class.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To migrate from Binary cache stores in older Infinispan versions, change
<code>table.string.*</code> to <code>table.binary.\*</code> in the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>source.table.binary.table_name_prefix</code></p>
</li>
<li>
<p><code>source.table.binary.&lt;id\|data\|timestamp&gt;.name</code></p>
</li>
<li>
<p><code>source.table.binary.&lt;id\|data\|timestamp&gt;.type</code></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre># Example configuration for migrating to a JDBC String-Based cache store
target.type=STRING
target.cache_name=myCache
target.dialect=POSTGRES
target.marshaller.class=org.example.CustomMarshaller
target.marshaller.externalizers=25:Externalizer1,org.example.Externalizer2
target.connection_pool.connection_url=jdbc:postgresql:postgres
target.connection_pool.driver_class=org.postrgesql.Driver
target.connection_pool.username=postgres
target.connection_pool.password=redhat
target.db.major_version=9
target.db.minor_version=5
target.db.disable_upsert=false
target.db.disable_indexing=false
target.table.string.table_name_prefix=tablePrefix
target.table.string.id.name=id_column
target.table.string.data.name=datum_column
target.table.string.timestamp.name=timestamp_column
target.table.string.id.type=VARCHAR
target.table.string.data.type=bytea
target.table.string.timestamp.type=BIGINT
target.key_to_string_mapper=org.infinispan.persistence.keymappers. DefaultTwoWayKey2StringMapper</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. RocksDB Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the database directory.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>compression</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the compression type to use.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre># Example configuration for migrating from a RocksDB cache store.
source.type=ROCKSDB
source.cache_name=myCache
source.location=/path/to/rocksdb/database
source.compression=SNAPPY</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. SingleFileStore Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required/Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the directory that contains the cache store <code>.dat</code> file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre># Example configuration for migrating to a Single File cache store.
target.type=SINGLE_FILE_STORE
target.cache_name=myCache
target.location=/path/to/sfs.dat</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. SoftIndexFileStore Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required/Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the database directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>index_location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the database index directory.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre># Example configuration for migrating to a Soft-Index File cache store.
target.type=SOFT_INDEX_FILE_STORE
target.cache_name=myCache
target.location=path/to/sifs/database
target.location=path/to/sifs/index</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="migrating_stores-configure"><a class="anchor" href="#migrating_stores-configure"></a>8.3.4. Migrating Cache Stores</h4>
<div class="paragraph">
<p>Run <code>StoreMigrator</code> to migrate data from one cache store to another.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Get <code>infinispan-tools.jar</code>.</p>
</li>
<li>
<p>Create a <code>migrator.properties</code> file that configures the source and target
cache stores.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>If you build <code>infinispan-tools.jar</code> from source, do the following:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add <code>infinispan-tools.jar</code> and dependencies for your source and target
databases, such as JDBC drivers, to your classpath.</p>
</li>
<li>
<p>Specify <code>migrator.properties</code> file as an argument for <code>StoreMigrator</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you pull <code>infinispan-tools.jar</code> from the Maven
repository, run the following command:</p>
<div class="paragraph">
<p><code>mvn exec:java</code></p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="partition_handling"><a class="anchor" href="#partition_handling"></a>9. Setting Up Partition Handling</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="partition_handling-admin"><a class="anchor" href="#partition_handling-admin"></a>9.1. Partition handling</h3>
<div class="paragraph">
<p>An Infinispan cluster is built out of a number of nodes where data is stored. In order
not to lose data in the presence of node failures, Infinispan copies the same data&#8201;&#8212;&#8201;cache
entry in Infinispan parlance&#8201;&#8212;&#8201;over multiple nodes. This level of data redundancy is
configured through the <code>numOwners</code> configuration attribute and ensures that as long as
fewer than <code>numOwners</code> nodes crash simultaneously, Infinispan has a copy of the data
available.</p>
</div>
<div class="paragraph">
<p>However, there might be catastrophic situations in which more than <code>numOwners</code> nodes
disappear from the cluster:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Split brain</dt>
<dd>
<p>Caused e.g. by a router crash, this splits the cluster in two or more
partitions, or sub-clusters that operate independently. In these circumstances,
multiple clients reading/writing from different partitions see different versions
of the same cache entry, which for many application is problematic. Note there are
ways to alleviate the possibility for the split brain to happen, such as redundant networks or
 <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/s2-networkscripts-interfaces-chan.html">IP bonding</a>.
 These only reduce the window of time for the problem to occur, though.</p>
</dd>
<dt class="hdlist1"><code>numOwners</code> nodes crash in sequence</dt>
<dd>
<p>When at least <code>numOwners</code> nodes crash in rapid
succession and Infinispan does not have the time to properly rebalance its state between
crashes, the result is partial data loss.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The partition handling functionality discussed in this section allows the user to configure what operations can be
performed on a cache in the event of a split brain occurring. Infinispan provides multiple partition handling strategies,
which in terms of Brewer&#8217;s <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a> determine whether availability or
consistency is sacrificed in the presence of partition(s). Below is a list of the provided strategies:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strategy</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">CAP</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DENY_READ_WRITES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the partition does not have all owners for a given segment, both reads and writes are denied for all keys in that segment.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Consistency</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALLOW_READS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows reads for a given key if it exists in this partition, but only allows writes if this partition contains all owners of a segment.
This is still a consistent approach because some entries are readable if available in this partition, but from a client application perspective it is not deterministic.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Consistency</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALLOW_READ_WRITES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allow entries on each partition to diverge, with conflict resolution attempted upon the partitions merging.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Availability</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The requirements of your application should determine which strategy is appropriate. For example, DENY_READ_WRITES is more
appropriate for applications that have high consistency requirements; i.e. when the data read from the system must be accurate.
Whereas if Infinispan is used as a best-effort cache, partitions maybe perfectly tolerable and the ALLOW_READ_WRITES might
be more appropriate as it favours availability over consistency.</p>
</div>
<div class="paragraph">
<p>The following sections describe how Infinispan handles <a href="#split_brain">split brain</a> and <a href="#successive_node_failures">successive failures</a> for each of the partition handling strategies. This is followed by a section
describing how Infinispan allows for automatic conflict resolution upon partition merges via <a href="#merge_policies">merge policies</a>.
Finally, we provide a section describing <a href="#partition_handling_configuration">how to configure partition handling strategies and merge policies</a>.</p>
</div>
<div class="sect3">
<h4 id="split_brain"><a class="anchor" href="#split_brain"></a>9.1.1. Split brain</h4>
<div class="paragraph">
<p>In a split brain situation, each network partition will install its own
JGroups view, removing the nodes from the other partition(s).
We don&#8217;t have a direct way of determining whether the has been split into
two or more partitions, since the partitions are unaware of each other.
Instead, we assume the cluster has split when one or more nodes
disappear from the JGroups cluster without sending an explicit leave message.</p>
</div>
<div class="sect4">
<h5 id="split_strategies"><a class="anchor" href="#split_strategies"></a>Split Strategies</h5>
<div class="paragraph">
<p>In this section, we detail how each partition handling strategy behaves in the event of split brain occurring.</p>
</div>
<div class="sect5">
<h6 id="allow_read_writes"><a class="anchor" href="#allow_read_writes"></a>ALLOW_READ_WRITES</h6>
<div class="paragraph">
<p>Each partition continues to function as an independent cluster, with all partitions remaining in AVAILABLE mode.
This means that each partition may only see a part of the data, and each partition could write conflicting updates in
the cache. During a partition merge these conflicts are automatically resolved by utilising the <a href="#conflict_manager">ConflictManager</a>
and the configured <a href="#merge_policies">EntryMergePolicy</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="deny_read_writes"><a class="anchor" href="#deny_read_writes"></a>DENY_READ_WRITES</h6>
<div class="paragraph">
<p>When a split is detected each partition does not start a rebalance immediately, but first it checks whether it should
enter <strong>DEGRADED</strong> mode instead:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If at least one segment has lost all its owners (meaning at least
<em>numOwners</em> nodes left since the last rebalance ended), the partition enters
DEGRADED mode.</p>
</li>
<li>
<p>If the partition does not contain a simple majority of the nodes (floor(numNodes/2) + 1)
in the <em>latest stable topology</em>, the partition also enters DEGRADED mode.</p>
</li>
<li>
<p>Otherwise the partition keeps functioning normally, and it starts a rebalance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <em>stable topology</em> is updated every time a rebalance operation ends and the coordinator determines
that another rebalance is not necessary.</p>
</div>
<div class="paragraph">
<p>These rules ensures that at most one partition stays in AVAILABLE mode, and
the other partitions enter DEGRADED mode.</p>
</div>
<div class="paragraph">
<p>When a partition is in DEGRADED mode, it only allows access to the keys that are wholly owned:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Requests (reads and writes) for entries that have all the copies on nodes within
this partition are honoured.</p>
</li>
<li>
<p>Requests for entries that are partially or totally owned by nodes that disappeared
are rejected with an <code>AvailabilityException</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This guarantees that partitions cannot write different values for the same key
(cache is consistent), and also that one partition can not read keys that have been
updated in the other partitions (no stale data).</p>
</div>
<div class="paragraph">
<p>To exemplify, consider the initial cluster <code>M = {A, B, C, D}</code>, configured in distributed
mode with <code>numOwners = 2</code>.
Further on, consider three keys <code>k1</code>, <code>k2</code> and <code>k3</code> (that might exist in the cache or not)
such that <code>owners(k1) = {A,B}</code>, <code>owners(k2) = {B,C}</code> and <code>owners(k3) = {C,D}</code>.
Then the network splits in two partitions, <code>N1 = {A, B}</code> and <code>N2 = {C, D}</code>, they enter
DEGRADED mode and behave like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>on <code>N1</code>, <code>k1</code> is available for read/write, <code>k2</code> (partially owned) and <code>k3</code> (not owned)
are not available and accessing them results in an <code>AvailabilityException</code></p>
</li>
<li>
<p>on <code>N2</code>, <code>k1</code> and <code>k2</code> are not available for read/write, <code>k3</code> is available</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A relevant aspect of the partition handling process is the fact that when a
split brain happens, the resulting partitions rely on the original segment
mapping (the one that existed before the split brain) in order
to calculate key ownership. So it doesn&#8217;t matter if <code>k1</code>, <code>k2</code>, or <code>k3</code> already
existed cache or not, their availability is the same.</p>
</div>
<div class="paragraph">
<p>If at a further point in time the network heals and <code>N1</code> and <code>N2</code> partitions
merge back together into the initial cluster <code>M</code>, then <code>M</code> exits the degraded
mode and becomes fully available again. During this merge operation, because
<code>M</code> has once again become fully available, the <a href="#conflict_manager">ConflictManager</a>
and the configured <a href="#merge_policies">EntryMergePolicy</a> are used to check for
any conflicts that may have occurred in the interim period between the split
brain occurring and being detected.</p>
</div>
<div class="paragraph">
<p>As another example, the cluster could split in two partitions <code>O1 = {A, B, C}</code>
and <code>O2 = {D}</code>, partition <code>O1</code> will stay fully
available (rebalancing cache entries on the remaining members).
Partition <code>O2</code>, however, will detect a split and enter the degraded mode.
Since it doesn&#8217;t have any fully owned keys, it will reject any read or write
operation with an <code>AvailabilityException</code>.</p>
</div>
<div class="paragraph">
<p>If afterwards partitions <code>O1</code> and <code>O2</code> merge back into <code>M</code>, then the <a href="#conflict_manager">ConflictManager</a>
attempts to resolve any conflicts and <code>D</code> once again becomes fully available.</p>
</div>
</div>
<div class="sect5">
<h6 id="allow_reads"><a class="anchor" href="#allow_reads"></a>ALLOW_READS</h6>
<div class="paragraph">
<p>Partitions are handled in the same manner as DENY_READ_WRITES, except that when a partition is in DEGRADED mode read
operations on a partially owned key WILL not throw an AvailabilityException.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="current_limitations"><a class="anchor" href="#current_limitations"></a>Current limitations</h5>
<div class="paragraph">
<p>Two partitions could start up isolated, and as long as they don&#8217;t merge they
can read and write inconsistent data. In the future, we will allow custom
availability strategies (e.g. check that a certain node is part of the cluster,
or check that an external machine is accessible) that could handle that
situation as well.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="successive_node_failures"><a class="anchor" href="#successive_node_failures"></a>9.1.2. Successive nodes stopped</h4>
<div class="paragraph">
<p>As mentioned in the previous section, Infinispan can&#8217;t detect whether a node
left the JGroups view because of a process/machine crash, or because of a
network failure: whenever a node leaves the JGroups cluster abruptly, it is
assumed to be because of a network problem.</p>
</div>
<div class="paragraph">
<p>If the configured number of copies (<code>numOwners</code>) is greater than 1, the
cluster can remain available and will try to make new replicas of the data
on the crashed node. However, other nodes might crash during the rebalance process.
If more than <code>numOwners</code> nodes crash in a short interval of time, there is a
chance that some cache entries have disappeared from the cluster altogether.
In this case, with the DENY_READ_WRITES or ALLOW_READS strategy enabled, Infinispan
assumes (incorrectly) that there is a split brain and enters DEGRADED mode
as described in the split-brain section.</p>
</div>
<div class="paragraph">
<p>The administrator can also shut down more than <code>numOwners</code> nodes in
rapid succession, causing the loss of the data stored only on those nodes.
When the administrator shuts down a node gracefully, Infinispan knows that
the node can&#8217;t come back.
However, the cluster doesn&#8217;t keep track of how each node left, and the cache
still enters DEGRADED mode as if those nodes had crashed.</p>
</div>
<div class="paragraph">
<p>At this stage there is no way for the cluster to recover its state,
except stopping it and repopulating it on restart with the data from an
external source.
Clusters are expected to be configured with an appropriate <code>numOwners</code> in
order to avoid <code>numOwners</code> successive node failures, so this situation
should be pretty rare.
If the application can handle losing some of the data in the cache, the
administrator can force the availability mode back to AVAILABLE via JMX.</p>
</div>
</div>
<div class="sect3">
<h4 id="conflict_manager"><a class="anchor" href="#conflict_manager"></a>9.1.3. Conflict Manager</h4>
<div class="paragraph">
<p>The conflict manager is a tool that allows users to retrieve all stored replica values for a given key. In addition to
allowing users to process a stream of cache entries whose stored replicas have conflicting values. Furthermore, by
utilising implementations of the <a href="#merge_policies">EntryMergePolicy</a> interface it is possible for said conflicts to
be resolved automatically.</p>
</div>
<div class="sect4">
<h5 id="detecting_conflicts"><a class="anchor" href="#detecting_conflicts"></a>Detecting Conflicts</h5>
<div class="paragraph">
<p>Conflicts are detected by retrieving each of the stored values for a given key. The conflict manager retrieves the value stored
from each of the key&#8217;s write owners defined by the current consistent hash. The .equals method of the stored values is
then used to determine whether all values are equal. If all values are equal then no conflicts exist for the key, otherwise
a conflict has occurred. Note that null values are returned if no entry exists on a given node, therefore we deem a conflict
to have occurred if both a null and non-null value exists for a given key.</p>
</div>
</div>
<div class="sect4">
<h5 id="merge_policies"><a class="anchor" href="#merge_policies"></a>Merge Policies</h5>
<div class="paragraph">
<p>In the event of conflicts arising between one or more replicas of a given CacheEntry, it is necessary for a conflict
resolution algorithm to be defined, therefore we provide the
<a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/conflict/EntryMergePolicy.html">EntryMergePolicy</a> interface. This interface consists
of a single method, "merge", whose returned CacheEntry is utilised as the "resolved" entry for a given key. When a non-null
CacheEntry is returned, this entries value is "put" to all replicas in the cache. However when the merge implementation
returns a null value, all replicas associated with the conflicting key are removed from the cache.</p>
</div>
<div class="paragraph">
<p>The merge method takes two parameters: the "preferredEntry" and "otherEntries". In the context of a partition merge,
the preferredEntry is the primary replica of a CacheEntry stored in the partition that contains the most nodes or if
partitions are equal the one with the largest topologyId. In the event of overlapping partitions, i.e. a node A is
present in the topology of both partitions {A}, {A,B,C}, we pick {A} as the preferred partition as it will have the higher
topologId as the other partition&#8217;s topology is behind. When a partition merge is not occurring, the "preferredEntry" is
simply the primary replica of the CacheEntry. The second parameter, "otherEntries" is simply a list of all other entries
associated with the key for which a conflict was detected.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
EntryMergePolicy::merge is only called when a conflict has been detected, it is not called if all CacheEntrys are
the same.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Currently Infinispan provides the following implementations of EntryMergePolicy:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Policy</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.NONE (default)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No attempt is made to resolve conflicts. Entries hosted on the minority partition are removed and the nodes
  in this partition do not hold any data until the rebalance starts. Note, this behaviour is equivalent to prior Infinispan
  versions which did not support conflict resolution.
  Note, in this case all changes made to entries hosted on the minority partition are lost, but once the rebalance has
  finished all entries will be consistent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.PREFERRED_ALWAYS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Always utilise the "preferredEntry". MergePolicy.NONE is almost equivalent to PREFERRED_ALWAYS, albeit without the
  performance impact of performing conflict resolution, therefore MergePolicy.NONE should be chosen unless the following
  scenario is a concern. When utilising the DENY_READ_WRITES or DENY_READ strategy, it is possible for a write operation
  to only partially complete when the partitions enter DEGRADED mode, resulting in replicas containing inconsistent values.
  MergePolicy.PREFERRED_ALWAYS will detect said inconsistency and resolve it, whereas with MergePolicy.NONE the CacheEntry
  replicas will remain inconsistent after the cluster has rebalanced.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.PREFERRED_NON_NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Utilise the "preferredEntry" if it is non-null, otherwise utilise the first entry from "otherEntries".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MergePolicy.REMOVE_ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Always remove a key from the cache when a conflict is detected.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fully qualified class name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The custom implementation for merge will be used <a href="#partition_handling_custom_merge_policy">Custom merge policy</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="conflict_manager_usage"><a class="anchor" href="#conflict_manager_usage"></a>9.1.4. Usage</h4>
<div class="paragraph">
<p>During a partition merge the ConflictManager automatically attempts to resolve conflicts utilising the configured
EntryMergePolicy, however it is also possible to manually search for/resolve conflicts as required by your application.</p>
</div>
<div class="paragraph">
<p>The code below shows how to retrieve an EmbeddedCacheManager&#8217;s ConflictManager, how to retrieve all versions of a given
key and how to check for conflicts across a given cache.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">example-config.xml</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; cache = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">testCache</span><span class="delimiter">&quot;</span></span>);
ConflictManager&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; crm = ConflictManagerFactory.get(cache.getAdvancedCache());

<span class="comment">// Get All Versions of Key</span>
<span class="predefined-type">Map</span>&lt;Address, InternalCacheValue&lt;<span class="predefined-type">String</span>&gt;&gt; versions = crm.getAllVersions(<span class="integer">1</span>);

<span class="comment">// Process conflicts stream and perform some operation on the cache</span>
Stream&lt;<span class="predefined-type">Map</span>&lt;Address, CacheEntry&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt;&gt;&gt; conflicts = crm.getConflicts();
conflicts.forEach(map -&gt; {
   CacheEntry&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; entry = map.values().iterator().next();
   <span class="predefined-type">Object</span> conflictKey = entry.getKey();
   cache.remove(conflictKey);
});

<span class="comment">// Detect and then resolve conflicts using the configured EntryMergePolicy</span>
crm.resolveConflicts();

<span class="comment">// Detect and then resolve conflicts using the passed EntryMergePolicy instance</span>
crm.resolveConflicts((preferredEntry, otherEntries) -&gt; preferredEntry);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Although the <code>ConflictManager::getConflicts</code> stream is processed per entry, the underlying spliterator is in
fact lazily-loading cache entries on a per segment basis.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="partition_handling_configuration"><a class="anchor" href="#partition_handling_configuration"></a>9.1.5. Configuring partition handling</h4>
<div class="paragraph">
<p>Unless the cache is distributed or replicated, partition handling configuration is ignored. The default partition
handling strategy is ALLOW_READ_WRITES and the default EntryMergePolicy is MergePolicies::PREFERRED_ALWAYS.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">the-default-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;partition-handling</span> <span class="attribute-name">when-split</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALLOW_READ_WRITES</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">merge-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PREFERRED_NON_NULL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same can be achieved programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder dcc = <span class="keyword">new</span> ConfigurationBuilder();
dcc.clustering().partitionHandling()
                    .whenSplit(PartitionHandling.ALLOW_READ_WRITES)
                    .mergePolicy(MergePolicy.PREFERRED_ALWAYS);</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="partition_handling_custom_merge_policy"><a class="anchor" href="#partition_handling_custom_merge_policy"></a>Implement a custom merge policy</h5>
<div class="paragraph">
<p>It&#8217;s also possible to provide custom implementations of the EntryMergePolicy</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">the-default-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;partition-handling</span> <span class="attribute-name">when-split</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALLOW_READ_WRITES</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">merge-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.example.CustomMergePolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder dcc = <span class="keyword">new</span> ConfigurationBuilder();
dcc.clustering().partitionHandling()
                    .whenSplit(PartitionHandling.ALLOW_READ_WRITES)
                    .mergePolicy(<span class="keyword">new</span> CustomMergePolicy());</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomMergePolicy</span> <span class="directive">implements</span> EntryMergePolicy&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> CacheEntry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; merge(CacheEntry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; preferredEntry, <span class="predefined-type">List</span>&lt;CacheEntry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt; otherEntries) {
      <span class="comment">// decide which entry should be used</span>

      <span class="keyword">return</span> the_solved_CacheEntry;
   }</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="deploy_custom_merge_policies_to_a_infinispan_server_instance"><a class="anchor" href="#deploy_custom_merge_policies_to_a_infinispan_server_instance"></a>Deploy custom merge policies to a Infinispan server instance</h5>
<div class="paragraph">
<p>To utilise a custom EntryMergePolicy implementation on the server, it&#8217;s necessary for the implementation class(es) to be deployed to the server. This is accomplished by utilising the java service-provider convention and packaging the class files in a jar which has a META-INF/services/org.infinispan.conflict.EntryMergePolicy file containing the fully qualified class name of the EntryMergePolicy implementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre># list all necessary implementations of EntryMergePolicy with the full qualified name
org.example.CustomMergePolicy</pre>
</div>
</div>
<div class="paragraph">
<p>In order for a Custom merge policy to be utilised on the server, you should enable object storage, if your policies semantics require access to the stored Key/Value objects. This is because cache entries in the server may be stored in a marshalled format and the Key/Value objects returned to your policy would be instances of WrappedByteArray.
However, if the custom policy only depends on the metadata associated with a cache entry, then object storage is not required and should be avoided (unless needed for other reasons) due to the additional performance cost of marshalling data per request.
Finally, object storage is never required if one of the provided merge policies is used.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="partition_handling_monitoring"><a class="anchor" href="#partition_handling_monitoring"></a>9.1.6. Monitoring and administration</h4>
<div class="paragraph">
<p>The availability mode of a cache is exposed in JMX as an attribute in the
<a href="https://docs.jboss.org/infinispan/12.0/apidocs/jmxComponents.html#Cache">Cache MBean</a>.
The attribute is writable, allowing an administrator to forcefully migrate
a cache from DEGRADED mode back to AVAILABLE (at the cost of
consistency).</p>
</div>
<div class="paragraph">
<p>The availability mode is also accessible via the
<a href="https://docs.jboss.org/infinispan/12.0/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a>
interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AdvancedCache ac = cache.getAdvancedCache();

<span class="comment">// Read the availability</span>
<span class="type">boolean</span> available = ac.getAvailability() == AvailabilityMode.AVAILABLE;

<span class="comment">// Change the availability</span>
<span class="keyword">if</span> (!available) {
   ac.setAvailability(AvailabilityMode.AVAILABLE);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-11-30 02:47:11 -0500
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains('stemblock')) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>